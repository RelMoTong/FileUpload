# 模块化架构快速参考 v2.3.1

## 启动程序

### 方式 1：使用新的模块化入口（推荐）
```bash
python src/main.py
```

### 方式 2：使用兼容入口
```bash
python pyqt_app.py
```

---

## 模块导入

### 导入主窗口
```python
from src.ui import MainWindow
# 或
from src.ui.main_window import MainWindow
```

### 导入 UI 控件
```python
from src.ui.widgets import Toast, ChipWidget, CollapsibleBox, DiskCleanupDialog
```

### 导入上传 Worker
```python
from src.workers.upload_worker import UploadWorker
```

### 导入 FTP 协议
```python
from src.protocols.ftp import FTPProtocolManager, FTPServerManager, FTPClientUploader
```

### 导入配置管理
```python
from src.config import ConfigManager
```

### 导入核心工具
```python
from src.core import get_app_dir, get_resource_path, get_app_version, get_app_title
from src.core.permissions import PermissionManager
```

---

## 文件结构

```
src/
├── main.py                    # 程序入口
├── config.py                  # 配置管理
├── core/                      # 核心功能
│   ├── utils.py              # 工具函数
│   └── permissions.py        # 权限管理
├── protocols/                 # 协议模块
│   └── ftp.py                # FTP 协议
├── ui/                        # 用户界面
│   ├── widgets.py            # 自定义控件
│   └── main_window.py        # 主窗口
└── workers/                   # 后台工作线程
    └── upload_worker.py      # 上传 Worker
```

---

## 模块说明

### src/main.py
- **功能**：程序主入口
- **职责**：单例检查、创建主窗口、启动应用
- **依赖**：src.ui.main_window

### src/ui/main_window.py
- **功能**：主窗口实现
- **行数**：4017
- **包含**：完整的 UI、事件处理、业务逻辑

### src/ui/widgets.py
- **功能**：自定义 UI 控件
- **行数**：730
- **包含**：Toast, ChipWidget, CollapsibleBox, DiskCleanupDialog

### src/workers/upload_worker.py
- **功能**：文件上传后台线程
- **行数**：1070
- **特性**：网络监控、智能去重、速率限制

### src/protocols/ftp.py
- **功能**：FTP 协议支持
- **行数**：1026
- **包含**：FTPProtocolManager, FTPServerManager, FTPClientUploader

### src/core/utils.py
- **功能**：通用工具函数
- **行数**：70
- **包含**：get_app_dir, get_resource_path, get_app_version, get_app_title

### src/core/permissions.py
- **功能**：权限管理系统
- **行数**：150
- **角色**：guest, user, admin

### src/config.py
- **功能**：配置管理
- **行数**：160
- **管理**：40+ 配置项

---

## 开发指南

### 添加新功能

1. **确定模块位置**
   - UI 相关 → `src/ui/`
   - 协议相关 → `src/protocols/`
   - 后台任务 → `src/workers/`
   - 工具函数 → `src/core/utils.py`

2. **创建新文件**（如果需要）
   ```python
   # src/new_module/feature.py
   """模块说明"""
   
   class NewFeature:
       """功能说明"""
       pass
   ```

3. **更新 __init__.py**
   ```python
   # src/new_module/__init__.py
   from .feature import NewFeature
   
   __all__ = ['NewFeature']
   ```

4. **在主程序中使用**
   ```python
   from src.new_module import NewFeature
   ```

### 修改现有功能

1. **定位相关模块**
   - 查看 `docs/模块化重构最终总结_v2.3.1.md`

2. **修改代码**
   - 保持模块职责单一
   - 更新类型注解

3. **验证修改**
   ```bash
   # 检查类型错误
   # VS Code 会自动运行 Pylance
   
   # 测试导入
   python -c "from src.module import Class; print('OK')"
   ```

### 测试模块

```python
# test_module.py
import sys
from pathlib import Path

# 添加项目根目录到路径
sys.path.insert(0, str(Path(__file__).parent))

# 导入要测试的模块
from src.ui.widgets import Toast

# 测试代码
def test_toast():
    # ... 测试逻辑
    pass
```

---

## 常见问题

### Q: 如何在 pyqt_app.py 和 src/main.py 之间切换？

**A**: 两者功能相同，只是入口不同：
- `pyqt_app.py`：向后兼容，包含内置组件
- `src/main.py`：新的模块化入口（推荐）

### Q: 修改代码后如何验证？

**A**: 
1. 检查 Pylance 错误（VS Code 底部状态栏）
2. 运行程序：`python src/main.py`
3. 查看日志：`logs/upload_YYYY-MM-DD.txt`

### Q: 如何回退到旧版本？

**A**: 
使用 Git：
```bash
git log --oneline  # 查看提交历史
git checkout <commit-hash>  # 回退到指定版本
```

### Q: 模块导入失败怎么办？

**A**: 
1. 确保在项目根目录运行
2. 检查 `sys.path` 是否包含项目根目录
3. 验证模块文件存在：`ls src/ui/main_window.py`

---

## 版本信息

- **版本**：v2.3.1
- **架构**：模块化
- **Python**：≥ 3.8
- **Qt**：PySide6 或 PyQt5
- **状态**：✅ 稳定

---

## 相关文档

- [模块化重构最终总结](./模块化重构最终总结_v2.3.1.md)
- [FTP API 文档](./FTP_API文档.md)
- [使用指南](./使用指南.md)
