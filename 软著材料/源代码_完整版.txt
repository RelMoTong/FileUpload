======================================================================
  å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶ V3.1.0
  æºä»£ç æ–‡æ¡£ï¼ˆå®Œæ•´ç‰ˆï¼‰
======================================================================
  ç”Ÿæˆæ—¥æœŸ: 2025å¹´11æœˆ27æ—¥
  æºæ–‡ä»¶æ•°: 18 ä¸ª
  ä»£ç è¡Œæ•°: 11945 è¡Œ
  æ€»é¡µæ•°: 241 é¡µ
======================================================================

ã€æºæ–‡ä»¶æ¸…å•ã€‘
----------------------------------------------------------------------
  1. pyqt_app.py                                        (1299 è¡Œ)
  2. qt_types.py                                        (164 è¡Œ)
  3. src\__init__.py                                    (24 è¡Œ)
  4. src\config.py                                      (181 è¡Œ)
  5. src\core\__init__.py                               (31 è¡Œ)
  6. src\core\i18n.py                                   (1131 è¡Œ)
  7. src\core\permissions.py                            (169 è¡Œ)
  8. src\core\resume_manager.py                         (555 è¡Œ)
  9. src\core\utils.py                                  (63 è¡Œ)
 10. src\ftp_ui_component.py                            (883 è¡Œ)
 11. src\main.py                                        (109 è¡Œ)
 12. src\protocols\__init__.py                          (11 è¡Œ)
 13. src\protocols\ftp.py                               (1025 è¡Œ)
 14. src\ui\__init__.py                                 (13 è¡Œ)
 15. src\ui\main_window.py                              (4433 è¡Œ)
 16. src\ui\widgets.py                                  (765 è¡Œ)
 17. src\workers\__init__.py                            (11 è¡Œ)
 18. src\workers\upload_worker.py                       (1078 è¡Œ)
----------------------------------------------------------------------

å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                   ç¬¬ 1 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
       # ============================================================
       # æ–‡ä»¶: pyqt_app.py
       # ============================================================
    1  # -*- coding: utf-8 -*-
    2  """
    3  PyQtç‰ˆ å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·ï¼ˆMVPï¼‰
    4  - ä¸‰æ®µå¸ƒå±€ï¼šå·¦ï¼ˆè¾“å…¥è®¾ç½®ï¼‰ã€å³ï¼ˆæ§åˆ¶+çŠ¶æ€ï¼‰ã€åº•éƒ¨ï¼ˆæ—¥å¿—ï¼‰
    5  - æ¸å˜è¿›åº¦æ¡ + ç™¾åˆ†æ¯”/æ–‡ä»¶å/å‰©ä½™æ—¶é—´
    6  - çŠ¶æ€èƒ¶å›Š + å›¾æ ‡
    7  - æ—¥å¿—è‡ªåŠ¨æ»šåŠ¨é”
    8  - è¾…åŠ©æ“ä½œåœ¨â€œæ›´å¤šâ€èœå•
    9  - ç®€æ˜“åå°çº¿ç¨‹æ‰§è¡Œä¸Šä¼ ä¸å½’æ¡£ï¼ˆä¸ä¾èµ– Tk å˜é‡ï¼‰
   10  
   11  åç»­å¯é€æ­¥æ›¿æ¢ Tk ç‰ˆå…¥å£ã€‚
   12  """
   13  import os
   14  import sys
   15  import json
   16  import time
   17  import shutil
   18  import threading
   19  import datetime
   20  import queue
   21  import winreg
   22  import hashlib
   23  from pathlib import Path
   24  from typing import List, Tuple, Optional, Any, TYPE_CHECKING
   25  from concurrent.futures import ThreadPoolExecutor, TimeoutError as FuturesTimeoutError
   26  
   27  # v2.0 æ–°å¢ï¼šå¯¼å…¥ FTP åè®®æ¨¡å—
   28  try:
   29      from src.protocols.ftp import FTPProtocolManager, FTPServerManager, FTPClientUploader
   30      FTP_AVAILABLE = True
   31  except ImportError:
   32      FTP_AVAILABLE = False
   33      print("è­¦å‘Š: FTP æ¨¡å—å¯¼å…¥å¤±è´¥ï¼ŒFTP åŠŸèƒ½ä¸å¯ç”¨")
   34  
   35  # v2.3.1 æ–°å¢ï¼šå¯¼å…¥æ¨¡å—åŒ–ç»„ä»¶ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
   36  try:
   37      from src.ui.widgets import Toast as ModularToast
   38      from src.ui.widgets import ChipWidget as ModularChipWidget
   39      from src.ui.widgets import CollapsibleBox as ModularCollapsibleBox
   40      from src.ui.widgets import DiskCleanupDialog as ModularDiskCleanupDialog
   41      from src.workers.upload_worker import UploadWorker as ModularUploadWorker
   42      MODULAR_COMPONENTS_AVAILABLE = True
   43  except ImportError:
   44      MODULAR_COMPONENTS_AVAILABLE = False
   45      print("æç¤º: æ¨¡å—åŒ–ç»„ä»¶æœªå¯ç”¨ï¼Œä½¿ç”¨å†…ç½®ç»„ä»¶")
   46  
   47  # v2.3.0 æ–°å¢ï¼šå¯¼å…¥ç±»å‹å®‰å…¨çš„ Qt æšä¸¾è®¿é—®å™¨

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                   ç¬¬ 2 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
   48  from qt_types import MessageBoxIcon, MessageBoxButton, TrayIconType, EventType
   49  
   50  # ????????????
   51  from src.ui.main_window import MainWindow
   52  
   53  # è¿è¡Œæ—¶å¯¼å…¥ Qt åº“
   54  try:
   55      from PySide6 import QtCore, QtGui, QtWidgets
   56      from PySide6.QtNetwork import QLocalServer, QLocalSocket
   57      Signal = QtCore.Signal  # PySide6 ä¿¡å·
   58      QT_LIB = 'PySide6'
   59  except ImportError:
   60      try:
   61          from PyQt5 import QtCore, QtGui, QtWidgets  # type: ignore[import-not-found]
   62          from PyQt5.QtNetwork import QLocalServer, QLocalSocket  # type: ignore[import-not-found]
   63          Signal = QtCore.pyqtSignal  # PyQt5 ä¿¡å·
   64          QT_LIB = 'PyQt5'
   65      except ImportError:
   66          raise ImportError("Neither PySide6 nor PyQt5 is installed. Please install one of them.")
   67  
   68  # ç±»å‹æ£€æŸ¥æ—¶çš„é¢å¤–å¯¼å…¥ï¼ˆé¿å… Pylance ç±»ç»§æ‰¿è¯¯æŠ¥ï¼‰
   69  if TYPE_CHECKING:
   70      # ç¡®ä¿ç±»å‹æ£€æŸ¥å™¨èƒ½è¯†åˆ« Qt ç±»ä½œä¸ºæœ‰æ•ˆåŸºç±»
   71      # è¿™ä¸ä¼šå½±å“è¿è¡Œæ—¶ï¼Œåªæ˜¯å¸®åŠ©é™æ€åˆ†æå·¥å…·
   72      pass
   73  
   74  # ç»Ÿä¸€è®¿é—® Qt æšä¸¾ï¼ˆå…¼å®¹ Qt6 çš„å¼ºç±»å‹æšä¸¾å‘½åï¼‰
   75  QtEnum = QtCore.Qt
   76  
   77  # v2.2.0 Qtæšä¸¾å…¼å®¹æ€§è¾…åŠ©å‡½æ•°ï¼ˆæ¶ˆé™¤Pylanceè­¦å‘Šï¼‰
   78  def get_qt_enum(enum_class, attr_name: str, fallback_value: int):
   79      """å®‰å…¨è·å–Qtæšä¸¾å€¼ï¼Œå…¼å®¹PySide6/PyQt5"""
   80      try:
   81          return getattr(enum_class, attr_name, fallback_value)
   82      except AttributeError:
   83          return fallback_value
   84  
   85  APP_TITLE = "å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…· v3.0.1"
   86  APP_VERSION = "3.0.2"
   87  
   88  
   89  def get_app_dir() -> Path:
   90      """è·å–åº”ç”¨ç¨‹åºæ•°æ®ç›®å½•ï¼ˆç”¨äºé…ç½®å’Œæ—¥å¿—ç­‰å¯å†™æ–‡ä»¶ï¼‰
   91      - å¼€å‘ç¯å¢ƒï¼šè¿”å›è„šæœ¬æ‰€åœ¨ç›®å½•
   92      - æ‰“åŒ…åï¼šè¿”å› exe æ‰€åœ¨ç›®å½•ï¼ˆç”¨æˆ·å¯å†™ï¼‰
   93      """
   94      if getattr(sys, 'frozen', False):
   95          # PyInstaller æ‰“åŒ…åï¼Œè¿”å› exe æ‰€åœ¨ç›®å½•
   96          return Path(sys.executable).parent
   97      return Path(__file__).parent

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                   ç¬¬ 3 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
   98  
   99  
  100  def get_resource_path(relative_path: str) -> Path:
  101      """è·å–èµ„æºæ–‡ä»¶çš„ç»å¯¹è·¯å¾„ï¼ˆæ”¯æŒæ‰“åŒ…ï¼‰
  102      
  103      ç”¨äºè¯»å–åªè¯»èµ„æºæ–‡ä»¶ï¼Œå¦‚ Logoã€é»˜è®¤é…ç½®ç­‰
  104      
  105      Args:
  106          relative_path: ç›¸å¯¹äºèµ„æºç›®å½•çš„è·¯å¾„ï¼Œå¦‚ 'assets/logo.png'
  107      
  108      Returns:
  109          èµ„æºæ–‡ä»¶çš„ç»å¯¹è·¯å¾„
  110      """
  111      if getattr(sys, 'frozen', False) and hasattr(sys, '_MEIPASS'):
  112          # æ‰“åŒ…åï¼Œèµ„æºæ–‡ä»¶åœ¨ _internal ç›®å½•ï¼ˆsys._MEIPASSï¼‰
  113          # ä½¿ç”¨ getattr é¿å…ç±»å‹æ£€æŸ¥é”™è¯¯ï¼ˆ_MEIPASS æ˜¯è¿è¡Œæ—¶åŠ¨æ€å±æ€§ï¼‰
  114          base_path = Path(getattr(sys, '_MEIPASS'))
  115      else:
  116          # å¼€å‘ç¯å¢ƒï¼Œèµ„æºæ–‡ä»¶åœ¨è„šæœ¬ç›®å½•
  117          base_path = Path(__file__).parent
  118      return base_path / relative_path
  119  
  120  
  121  class Toast(QtWidgets.QWidget):  # type: ignore[misc]
  122      """Toast é€šçŸ¥ç»„ä»¶
  123      
  124      Note: ä½¿ç”¨ type: ignore[misc] æ˜¯å› ä¸º Qt æ¨¡å—åœ¨ try-except ä¸­åŠ¨æ€å¯¼å…¥ï¼Œ
  125      Pylance æ— æ³•åœ¨é™æ€åˆ†ææ—¶ç¡®å®šåŸºç±»æœ‰æ•ˆæ€§ï¼Œä½†è¿è¡Œæ—¶å®Œå…¨æ­£ç¡®ã€‚
  126      """
  127      def __init__(self, parent: QtWidgets.QWidget, message: str, kind: str = 'info', duration_ms: int = 2500):
  128          super().__init__(parent)
  129          wt = getattr(QtEnum, 'WindowType', QtEnum)
  130          wa = getattr(QtEnum, 'WidgetAttribute', QtEnum)
  131          self.setWindowFlags(
  132              getattr(wt, 'FramelessWindowHint')
  133              | getattr(wt, 'Tool')
  134              | getattr(wt, 'WindowStaysOnTopHint')
  135          )
  136          self.setAttribute(getattr(wa, 'WA_TranslucentBackground'))
  137          colors = {
  138              'info':    ("#E0F2FE", "#039CA1"),
  139              'success': ("#DCFCE7", "#166534"),
  140              'warning': ("#FEF9C3", "#A16207"),
  141              'danger':  ("#FEE2E2", "#B91C1C"),
  142          }
  143          bg, fg = colors.get(kind, colors['info'])
  144          layout = QtWidgets.QHBoxLayout(self)
  145          frame = QtWidgets.QFrame(self)
  146          frame.setStyleSheet(f"QFrame{{background:{bg}; border:1px solid rgba(0,0,0,0.06); border-radius:8px;}}")
  147          inner = QtWidgets.QHBoxLayout(frame)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                   ç¬¬ 4 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
  148          label = QtWidgets.QLabel(message)
  149          label.setStyleSheet(f"color:{fg}; padding:8px 12px; font-size:11pt;")
  150          inner.addWidget(label)
  151          layout.addWidget(frame)
  152          self.adjustSize()
  153          self._timer = QtCore.QTimer(self)
  154          self._timer.setSingleShot(True)
  155          self._timer.timeout.connect(self.close)
  156          self._timer.start(duration_ms)
  157  
  158      def showEvent(self, e: QtGui.QShowEvent) -> None:
  159          if self.parent():
  160              p = self.parent()
  161              geo = p.geometry()
  162              self.adjustSize()
  163              x = geo.x() + geo.width() - self.width() - 16
  164              y = geo.y() + 80
  165              self.move(x, y)
  166          return super().showEvent(e)
  167  
  168  
  169  class UploadWorker(QtCore.QObject):  # type: ignore[misc]
  170      # signals
  171      log = Signal(str)
  172      stats = Signal(int, int, int, str)   # uploaded, failed, skipped, rate
  173      progress = Signal(int, int, str)     # current, total, filename
  174      file_progress = Signal(str, int)     # current_file, progress_percent
  175      network_status = Signal(str)         # 'good'|'unstable'|'disconnected'
  176      finished = Signal()
  177      status = Signal(str)                 # 'running'|'paused'|'stopped'
  178      ask_user_duplicate = Signal(object)  # payload dict: {'file': str, 'duplicate': str, 'event': threading.Event, 'result': dict}
  179      upload_error = Signal(str, str)      # v2.2.0 æ–°å¢ï¼šfilename, error_message
  180      disk_warning = Signal(float, float, int)  # v2.2.0 æ–°å¢ï¼štarget_percent, backup_percent, threshold
  181  
  182      def __init__(self, source: str, target: str, backup: str,
  183                   interval: int, mode: str, disk_threshold_percent: int, retry_count: int,
  184                   filters: List[str], app_dir: Path,
  185                   enable_deduplication: bool = False, hash_algorithm: str = 'md5',
  186                   duplicate_strategy: str = 'ask',
  187                   network_check_interval: int = 10, network_auto_pause: bool = True,
  188                   network_auto_resume: bool = True,
  189                   enable_auto_delete: bool = False, auto_delete_folder: str = '',
  190                   auto_delete_threshold: int = 80, auto_delete_keep_days: int = 10,
  191                   auto_delete_check_interval: int = 300,
  192                   # v2.0 æ–°å¢ï¼šåè®®ç›¸å…³å‚æ•°
  193                   upload_protocol: str = 'smb',
  194                   ftp_client_config: Optional[dict] = None,
  195                   # v2.2.0 æ–°å¢ï¼šå¤‡ä»½å¯ç”¨çŠ¶æ€
  196                   enable_backup: bool = True,
  197                   # v2.3.0 æ–°å¢ï¼šé€Ÿç‡é™åˆ¶å‚æ•°

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                   ç¬¬ 5 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
  198                   limit_upload_rate: bool = False,
  199                   max_upload_rate_mbps: float = 10.0):
  200          super().__init__()
  201          self.source = source
  202          self.target = target
  203          self.backup = backup
  204          # v2.2.0 æ–°å¢ï¼šä¿å­˜å¤‡ä»½å¯ç”¨çŠ¶æ€
  205          self.enable_backup = enable_backup
  206          # v2.3.0 æ–°å¢ï¼šé€Ÿç‡é™åˆ¶é…ç½®
  207          self.limit_upload_rate = limit_upload_rate
  208          self.max_upload_rate_bytes = int(max_upload_rate_mbps * 1024 * 1024) if limit_upload_rate else 0
  209          self.interval = interval
  210          self.mode = mode
  211          self.disk_threshold_percent = max(5, disk_threshold_percent)
  212          self.retry_count = retry_count
  213          self.filters = [ext.lower() for ext in filters]
  214          self.app_dir = app_dir
  215          # å»é‡é…ç½®
  216          self.enable_deduplication = enable_deduplication
  217          self.hash_algorithm = hash_algorithm.lower()
  218          self.duplicate_strategy = duplicate_strategy
  219          # ç½‘ç»œç›‘æ§é…ç½®
  220          self.network_check_interval = network_check_interval
  221          self.network_auto_pause = network_auto_pause
  222          self.network_auto_resume = network_auto_resume
  223          # è‡ªåŠ¨åˆ é™¤é…ç½®
  224          self.enable_auto_delete = enable_auto_delete
  225          self.auto_delete_folder = auto_delete_folder
  226          self.auto_delete_threshold = auto_delete_threshold
  227          self.auto_delete_keep_days = auto_delete_keep_days
  228          self.auto_delete_check_interval = auto_delete_check_interval
  229          # v2.0 æ–°å¢ï¼šåè®®é…ç½®
  230          self.upload_protocol = upload_protocol  # 'smb', 'ftp_client', 'both'
  231          self.ftp_client_config = ftp_client_config or {}
  232          self.ftp_client = None  # FTPå®¢æˆ·ç«¯å®ä¾‹
  233          
  234          self._running = False
  235          self._paused = False
  236          self._thread = None
  237          self._archive_thread = None
  238          # stats
  239          self.uploaded = 0
  240          self.failed = 0
  241          self.skipped = 0
  242          self.rate = "0 MB/s"
  243          self.total_files = 0
  244          self.current = 0
  245          self.start_time = None
  246          # å½“å‰æ–‡ä»¶ä¿¡æ¯
  247          self.current_file_name = ""

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                   ç¬¬ 6 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
  248          self.current_file_size = 0
  249          self.current_file_uploaded = 0
  250          # å¤±è´¥é‡è¯•é˜Ÿåˆ—
  251          self.retry_queue = {}  # {file_path: retry_count}
  252          # å½’æ¡£é˜Ÿåˆ—
  253          self.archive_queue = queue.Queue()
  254          # ç½‘ç»œè¿æ¥çŠ¶æ€
  255          self.network_retry_count = 0
  256          self.network_auto_retry = True
  257          self.last_network_check = 0
  258          self.current_network_status = 'unknown'  # good, unstable, disconnected, unknown
  259          self.network_pause_by_auto = False  # æ˜¯å¦ç”±ç½‘ç»œä¸­æ–­è‡ªåŠ¨æš‚åœ
  260          self._last_space_warn = 0.0
  261          # å¤±è´¥æ—¥å¿—æ–‡ä»¶
  262          self.failed_log_path = self.app_dir / "failed_files.log"
  263          # çº¿ç¨‹æ± ç”¨äºæ‰§è¡Œå¯èƒ½é˜»å¡çš„æ–‡ä»¶æ“ä½œ
  264          self._executor = ThreadPoolExecutor(max_workers=3, thread_name_prefix="FileOp")
  265          # ç‹¬ç«‹çº¿ç¨‹æ± ç”¨äºç½‘ç»œå¯è¾¾æ€§å¿«é€Ÿæ£€æµ‹ï¼Œé¿å…ä¸æ–‡ä»¶æ“ä½œäº’ç›¸é˜»å¡
  266          self._net_executor = ThreadPoolExecutor(max_workers=1, thread_name_prefix="NetChk")
  267          # è¯¢é—®æ¨¡å¼çš„å…¨å±€é€‰æ‹©ï¼ˆå¯ç”±ç”¨æˆ·é€‰æ‹©â€œåº”ç”¨äºåç»­â€ï¼‰
  268          self._duplicate_ask_choice = None  # None| 'skip'|'rename'|'overwrite'
  269  
  270      def start(self):
  271          if self._running:
  272              return
  273          self._running = True
  274          self._paused = False
  275          self._thread = threading.Thread(target=self._run, daemon=True)
  276          self._thread.start()
  277          # å¯åŠ¨ç½‘ç»œç›‘æ§çº¿ç¨‹ï¼ˆç‹¬ç«‹äºä¸Šä¼ ä¸»å¾ªç¯ï¼‰
  278          self._net_running = True
  279          self._net_thread = threading.Thread(target=self._network_monitor_loop, daemon=True)
  280          self._net_thread.start()
  281          self.status.emit('running')
  282  
  283      def pause(self):
  284          if not self._running:
  285              return
  286          self._paused = True
  287          self.status.emit('paused')
  288  
  289      def resume(self):
  290          if not self._running:
  291              return
  292          self._paused = False
  293          self.status.emit('running')
  294  
  295      def stop(self):
  296          self._running = False
  297          self._paused = False

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                   ç¬¬ 7 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
  298          
  299          # v2.0 æ–°å¢ï¼šå…³é—­FTPå®¢æˆ·ç«¯è¿æ¥
  300          if self.ftp_client:
  301              try:
  302                  self.ftp_client.disconnect()
  303                  self.ftp_client = None
  304              except Exception as e:
  305                  pass  # å¿½ç•¥æ–­å¼€è¿æ¥é”™è¯¯
  306          
  307          # å…³é—­çº¿ç¨‹æ± 
  308          try:
  309              self._executor.shutdown(wait=False, cancel_futures=True)
  310          except:
  311              pass
  312          # åœæ­¢ç½‘ç»œç›‘æ§çº¿ç¨‹
  313          self._net_running = False
  314          # å…³é—­ç½‘ç»œæ£€æµ‹çº¿ç¨‹æ± 
  315          try:
  316              self._net_executor.shutdown(wait=False, cancel_futures=True)
  317          except:
  318              pass
  319          self.status.emit('stopped')
  320  
  321      def _network_monitor_loop(self):
  322          """ç‹¬ç«‹ç½‘ç»œç›‘æ§çº¿ç¨‹ï¼Œå‘¨æœŸæ€§æ£€æµ‹å¹¶å‘å°„çŠ¶æ€ä¿¡å·ï¼Œé¿å…ä¸Šä¼ å¾ªç¯é˜»å¡å¯¼è‡´çŠ¶æ€ä¸æ›´æ–°"""
  323          last_status = 'unknown'
  324          while getattr(self, '_net_running', False):
  325              # è½»é‡æ¢æµ‹
  326              try:
  327                  # ç›®æ ‡ä¼˜å…ˆ
  328                  target_ok = self._safe_net_check(self.target, timeout=0.3, default=False)
  329                  if target_ok:
  330                      status = 'good'
  331                  else:
  332                      backup_ok = self._safe_net_check(self.backup, timeout=0.3, default=False)
  333                      status = 'unstable' if backup_ok else 'disconnected'
  334              except Exception:
  335                  status = 'disconnected'
  336  
  337              if status != last_status:
  338                  # æ—¥å¿—ä»…åœ¨çŠ¶æ€å˜åŒ–æ—¶è¾“å‡º
  339                  if status == 'good' and last_status in ('unstable', 'disconnected'):
  340                      self.log.emit('âœ… ç½‘ç»œå·²æ¢å¤æ­£å¸¸')
  341                  elif status == 'unstable':
  342                      self.log.emit('âš ï¸ ç½‘ç»œä¸ç¨³å®šï¼šç›®æ ‡ä¸å¯è¾¾ï¼Œä½†å¤‡ä»½å¯è¾¾')
  343                  elif status == 'disconnected':
  344                      self.log.emit('âŒ ç½‘ç»œè¿æ¥ä¸­æ–­')
  345                  self.network_status.emit(status)
  346                  self.current_network_status = status
  347                  last_status = status

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                   ç¬¬ 8 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
  348  
  349                  # è‡ªåŠ¨æš‚åœ/æ¢å¤
  350                  if status == 'disconnected' and self.network_auto_pause and not self._paused:
  351                      self.network_pause_by_auto = True
  352                      self.pause()
  353                  if status == 'good' and self.network_auto_resume and self.network_pause_by_auto:
  354                      self.network_pause_by_auto = False
  355                      self.resume()
  356  
  357              # æ–­å¼€çŠ¶æ€ä¸‹æ¯3æ¬¡è¾“å‡ºä¸€æ¬¡å¿ƒè·³
  358              if status == 'disconnected':
  359                  self.network_retry_count += 1
  360                  if self.network_retry_count % 3 == 0:
  361                      self.log.emit(f"ğŸ”Œ ç½‘ç»œä»æœªæ¢å¤ (ç¬¬{self.network_retry_count}æ¬¡æ£€æµ‹)")
  362              else:
  363                  self.network_retry_count = 0
  364  
  365              # å®šæ—¶å‘é€ä¸€æ¬¡ç»Ÿè®¡å¿ƒè·³ï¼Œä¿è¯UIåœ¨ç½‘ç»œæ¢å¤/æš‚åœæœŸé—´ä¹Ÿèƒ½æŒç»­åˆ·æ–°
  366              try:
  367                  self.stats.emit(self.uploaded, self.failed, self.skipped, self.rate)
  368              except Exception:
  369                  pass
  370  
  371              # è‡ªé€‚åº”é—´éš”ï¼šå¼‚å¸¸æ—¶æ›´å¿«æ¢æµ‹ï¼Œæ­£å¸¸æ—¶ä½¿ç”¨ç”¨æˆ·è®¾ç½®
  372              interval = 1 if status in ('unstable', 'disconnected') else max(1, int(self.network_check_interval))
  373              time.sleep(interval)
  374  
  375      def _safe_net_check(self, path: str, timeout: float = 1.5, default=False) -> bool:
  376          """åœ¨ç‹¬ç«‹çš„ç½‘ç»œæ£€æµ‹çº¿ç¨‹æ± ä¸­æ£€æŸ¥è·¯å¾„å¯è¾¾æ€§ã€‚
  377          ä¼˜å…ˆå¯¹ç½‘ç»œè·¯å¾„ï¼ˆUNC/æ˜ å°„ç›˜ï¼‰åšå¿«é€Ÿ ping ä¸»æœºï¼Œé¿å… os.path.exists å¡ä½ï¼›
  378          æœ¬åœ°è·¯å¾„åˆ™ä»¥ exists ä¸ºå‡†ï¼ˆçº¿ç¨‹æ± +è¶…æ—¶ï¼‰ã€‚"""
  379          def is_unc(p: str) -> bool:
  380              return isinstance(p, str) and p.startswith('\\\\')
  381  
  382          def get_drive_root(p: str) -> str:
  383              drive, _ = os.path.splitdrive(p)
  384              return drive + '\\' if drive else ''
  385  
  386          def is_mapped_drive(p: str) -> bool:
  387              try:
  388                  root = get_drive_root(p)
  389                  if not root:
  390                      return False
  391                  import ctypes
  392                  DRIVE_REMOTE = 4
  393                  GetDriveTypeW = ctypes.windll.kernel32.GetDriveTypeW
  394                  GetDriveTypeW.argtypes = [ctypes.c_wchar_p]
  395                  GetDriveTypeW.restype = ctypes.c_uint
  396                  dtype = GetDriveTypeW(root)
  397                  return dtype == DRIVE_REMOTE

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                   ç¬¬ 9 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
  398              except Exception:
  399                  return False
  400  
  401          def mapped_to_unc(p: str) -> str:
  402              """å°†æ˜ å°„ç›˜è·¯å¾„è½¬æ¢ä¸º UNCï¼ˆæœ€ä½³åŠªåŠ›ï¼‰ã€‚"""
  403              try:
  404                  import ctypes
  405                  from ctypes import wintypes
  406                  # WNetGetConnectionW è·å–æ˜ å°„ç›˜å¯¹åº”çš„ UNC å‰ç¼€
  407                  WNetGetConnectionW = ctypes.windll.mpr.WNetGetConnectionW
  408                  WNetGetConnectionW.argtypes = [wintypes.LPCWSTR, wintypes.LPWSTR, ctypes.POINTER(wintypes.DWORD)]
  409                  WNetGetConnectionW.restype = wintypes.DWORD
  410                  drive, tail = os.path.splitdrive(p)
  411                  if not drive:
  412                      return ''
  413                  # ç¼“å†²åŒº
  414                  buf_len = wintypes.DWORD(1024)
  415                  buf = ctypes.create_unicode_buffer(1024)
  416                  rc = WNetGetConnectionW(drive + '\\', buf, ctypes.byref(buf_len))
  417                  if rc == 0:
  418                      unc_prefix = buf.value  # ä¾‹å¦‚ \\server\share
  419                      # æ‹¼å‡ºå®Œæ•´ UNC è·¯å¾„
  420                      rel = p[len(drive):].lstrip('\\/')
  421                      return os.path.join(unc_prefix, rel).replace('/', '\\')
  422                  return ''
  423              except Exception:
  424                  return ''
  425  
  426          def extract_host_from_unc(unc: str) -> str:
  427              try:
  428                  # UNC: \\server\share\...
  429                  parts = unc.split('\\')
  430                  # ['', '', 'server', 'share', ...]
  431                  return parts[2] if len(parts) > 2 else ''
  432              except Exception:
  433                  return ''
  434  
  435          def ping_host(host: str, ms: int) -> bool:
  436              try:
  437                  import subprocess
  438                  # -n 1: ä¸€æ¬¡å›æ˜¾ï¼›-w ms: è¶…æ—¶æ¯«ç§’
  439                  completed = subprocess.run(['ping', '-n', '1', '-w', str(ms), host],
  440                                             stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL,
  441                                             timeout=max(0.2, ms/1000.0 + 0.5))
  442                  return completed.returncode == 0
  443              except Exception:
  444                  return False
  445  
  446          try:
  447              if not path:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 10 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
  448                  return bool(default)
  449              # UNC ç›´æ¥ ping ä¸»æœº
  450              if is_unc(path):
  451                  host = extract_host_from_unc(path)
  452                  if host:
  453                      return ping_host(host, int(timeout*1000))
  454                  return bool(default)
  455              # æ˜ å°„ç›˜ï¼šè½¬æ¢ä¸º UNC å† ping
  456              if is_mapped_drive(path):
  457                  unc = mapped_to_unc(path)
  458                  host = extract_host_from_unc(unc) if unc else ''
  459                  if host:
  460                      return ping_host(host, int(timeout*1000))
  461                  # å›é€€ existsï¼ˆçº¿ç¨‹æ± +è¶…æ—¶ï¼‰
  462                  future = self._net_executor.submit(os.path.exists, path)
  463                  return bool(future.result(timeout=timeout))
  464              # æœ¬åœ°è·¯å¾„ï¼šç›´æ¥ existsï¼ˆçº¿ç¨‹æ± +è¶…æ—¶ï¼‰
  465              future = self._net_executor.submit(os.path.exists, path)
  466              return bool(future.result(timeout=timeout))
  467          except Exception:
  468              return bool(default)
  469  
  470      # helpers
  471      def _safe_path_operation(self, func, *args, timeout: float = 3.0, default=None):
  472          """
  473          å®‰å…¨æ‰§è¡Œæ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼Œä½¿ç”¨çº¿ç¨‹æ± å¸¦è¶…æ—¶æœºåˆ¶é˜²æ­¢é˜»å¡
  474          func: è¦æ‰§è¡Œçš„å‡½æ•°
  475          args: å‡½æ•°å‚æ•°
  476          timeout: è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
  477          default: è¶…æ—¶æˆ–å¼‚å¸¸æ—¶çš„é»˜è®¤è¿”å›å€¼
  478          """
  479          try:
  480              # æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± 
  481              future = self._executor.submit(func, *args)
  482              # ç­‰å¾…ç»“æœï¼Œå¸¦è¶…æ—¶
  483              result = future.result(timeout=timeout)
  484              return result
  485          except FuturesTimeoutError:
  486              # è¶…æ—¶ - ç¡®ä¿æ—¥å¿—ä¿¡å·èƒ½å‘é€
  487              try:
  488                  self.log.emit(f"â±ï¸ æ–‡ä»¶æ“ä½œè¶…æ—¶ï¼ˆ{timeout}ç§’ï¼‰ï¼Œå¯èƒ½ç½‘ç»œä¸­æ–­")
  489              except:
  490                  pass
  491              return default
  492          except Exception as e:
  493              # å…¶ä»–å¼‚å¸¸
  494              try:
  495                  self.log.emit(f"âš ï¸ æ–‡ä»¶æ“ä½œå¼‚å¸¸: {str(e)[:50]}")
  496              except:
  497                  pass

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 11 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
  498              return default
  499      
  500      def _check_network_connection(self) -> str:
  501          """
  502          å¢å¼ºçš„ç½‘ç»œè¿æ¥æ£€æŸ¥ï¼ˆæ ¹æ®é…ç½®é—´éš”æ£€æŸ¥ï¼Œä½¿ç”¨è¶…æ—¶æœºåˆ¶é˜²æ­¢é˜»å¡ï¼‰
  503          è¿”å›ï¼š'good' | 'unstable' | 'disconnected'
  504          """
  505          # å½“ç‹¬ç«‹ç½‘ç»œç›‘æ§çº¿ç¨‹å·²è¿è¡Œæ—¶ï¼Œè¿™é‡Œä»…åšâ€œè¢«åŠ¨â€æ›´æ–°ï¼Œé¿å…é‡å¤æ—¥å¿—ä¸ä¿¡å·
  506          if getattr(self, '_net_running', False):
  507              now = time.time()
  508              if now - self.last_network_check < self.network_check_interval:
  509                  return self.current_network_status
  510              # è½»é‡æ¢æµ‹ï¼Œä»…æ›´æ–°ç¼“å­˜ï¼Œä¸å‘å°„ç½‘ç»œä¿¡å·ã€ä¸è¾“å‡ºæ—¥å¿—
  511              try:
  512                  target_ok = self._safe_path_operation(os.path.exists, self.target, timeout=1.5, default=False)
  513              except Exception:
  514                  target_ok = False
  515              if target_ok:
  516                  self.current_network_status = 'good'
  517              else:
  518                  try:
  519                      backup_ok = self._safe_path_operation(os.path.exists, self.backup, timeout=1.0, default=False)
  520                  except Exception:
  521                      backup_ok = False
  522                  self.current_network_status = 'unstable' if backup_ok else 'disconnected'
  523              self.last_network_check = now
  524              return self.current_network_status
  525  
  526          now = time.time()
  527          # æ ¹æ®é…ç½®çš„é—´éš”æ£€æŸ¥
  528          if now - self.last_network_check < self.network_check_interval:
  529              return self.current_network_status
  530          
  531          self.last_network_check = now
  532          
  533          # å¤šå±‚æ¬¡æ£€æµ‹ï¼ˆä½¿ç”¨å®‰å…¨æ“ä½œï¼Œå¸¦è¶…æ—¶ï¼‰
  534          # 1. å°è¯•è®¿é—®ç›®æ ‡æ–‡ä»¶å¤¹ï¼ˆä¸»è¦æ£€æµ‹ï¼Œ2ç§’è¶…æ—¶ï¼‰
  535          try:
  536              target_ok = self._safe_path_operation(os.path.exists, self.target, timeout=2.0, default=False)
  537          except Exception:
  538              target_ok = False
  539          
  540          if target_ok:
  541              # æˆåŠŸè®¿é—®ï¼Œç½‘ç»œè‰¯å¥½
  542              old_status = self.current_network_status
  543              self.current_network_status = 'good'
  544              self.network_retry_count = 0
  545              
  546              # çŠ¶æ€å˜åŒ–æ—¶å‘é€ä¿¡å·å’Œæ—¥å¿—
  547              if old_status == 'disconnected':

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 12 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
  548                  self.log.emit("âœ… ç½‘ç»œå·²æ¢å¤æ­£å¸¸")
  549                  # å¦‚æœæ˜¯è‡ªåŠ¨æš‚åœï¼Œåˆ™è‡ªåŠ¨æ¢å¤
  550                  if self.network_auto_resume and self.network_pause_by_auto:
  551                      self.log.emit("ğŸ”„ ç½‘ç»œæ¢å¤ï¼Œè‡ªåŠ¨ç»§ç»­ä¸Šä¼ ...")
  552                      time.sleep(1)  # ç­‰å¾…1ç§’ç¡®ä¿ç½‘ç»œç¨³å®š
  553                      self.network_pause_by_auto = False
  554                      self.resume()
  555              elif old_status != 'good':
  556                  pass  # çŠ¶æ€æ”¹å–„
  557              
  558              # æ€»æ˜¯å‘é€çŠ¶æ€ä¿¡å·ï¼ˆç¡®ä¿UIæ›´æ–°ï¼‰
  559              self.network_status.emit('good')
  560              return 'good'
  561          
  562          # ç›®æ ‡ä¸å¯è¾¾ï¼Œç»§ç»­æ£€æµ‹
  563          self.network_retry_count += 1
  564          
  565          # 2. å°è¯•è®¿é—®å¤‡ä»½æ–‡ä»¶å¤¹ï¼ˆè¾…åŠ©æ£€æµ‹ï¼Œ2ç§’è¶…æ—¶ï¼‰
  566          try:
  567              backup_ok = self._safe_path_operation(os.path.exists, self.backup, timeout=2.0, default=False)
  568          except Exception:
  569              backup_ok = False
  570          
  571          if backup_ok:
  572              # ç›®æ ‡ä¸å¯è¾¾ï¼Œä½†å¤‡ä»½å¯è¾¾ - ç½‘ç»œä¸ç¨³å®š
  573              old_status = self.current_network_status
  574              self.current_network_status = 'unstable'
  575              
  576              if old_status != 'unstable':
  577                  self.log.emit(f"âš ï¸ ç½‘ç»œä¸ç¨³å®šï¼šç›®æ ‡æ–‡ä»¶å¤¹ä¸å¯è®¿é—®ï¼Œå¤‡ä»½æ–‡ä»¶å¤¹æ­£å¸¸")
  578              
  579              # æ€»æ˜¯å‘é€çŠ¶æ€ä¿¡å·
  580              self.network_status.emit('unstable')
  581              return 'unstable'
  582          
  583          # 3. å®Œå…¨æ–­å¼€
  584          old_status = self.current_network_status
  585          self.current_network_status = 'disconnected'
  586          
  587          if old_status != 'disconnected':
  588              self.log.emit(f"âŒ ç½‘ç»œè¿æ¥ä¸­æ–­ï¼ˆç›®æ ‡å’Œå¤‡ä»½æ–‡ä»¶å¤¹å‡ä¸å¯è®¿é—®ï¼‰")
  589              
  590              # è‡ªåŠ¨æš‚åœ
  591              if self.network_auto_pause and not self._paused:
  592                  self.log.emit("â¸ï¸ æ£€æµ‹åˆ°ç½‘ç»œä¸­æ–­ï¼Œè‡ªåŠ¨æš‚åœä¸Šä¼ ...")
  593                  self.network_pause_by_auto = True
  594                  self.pause()
  595          else:
  596              # å·²ç»æ˜¯æ–­å¼€çŠ¶æ€ï¼Œå®šæœŸæç¤º
  597              if self.network_retry_count % 3 == 0:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 13 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
  598                  self.log.emit(f"ğŸ”Œ ç½‘ç»œä»æœªæ¢å¤ (ç¬¬{self.network_retry_count}æ¬¡æ£€æµ‹)")
  599          
  600          # æ€»æ˜¯å‘é€çŠ¶æ€ä¿¡å·
  601          self.network_status.emit('disconnected')
  602          return 'disconnected'
  603  
  604      def _handle_upload_failure(self, file_path: str):
  605          """å¤„ç†ä¸Šä¼ å¤±è´¥ï¼šéé˜»å¡å¼é‡è¯•è°ƒåº¦ï¼ˆå¸¦æŒ‡æ•°å›é€€ï¼‰
  606          retry_queue ç»“æ„ï¼š{ path: { 'count': int, 'next': float } }
  607          """
  608          item = self.retry_queue.get(file_path)
  609          if item is None:
  610              item = {'count': 1, 'next': 0.0}
  611          else:
  612              item['count'] += 1
  613          
  614          retry_count = item['count']
  615          if retry_count > self.retry_count:
  616              # è¶…è¿‡é‡è¯•æ¬¡æ•°ï¼Œè®°å½•åˆ°å¤±è´¥æ—¥å¿—
  617              self._log_failed_file(file_path, f"é‡è¯•{retry_count-1}æ¬¡åä»ç„¶å¤±è´¥")
  618              if file_path in self.retry_queue:
  619                  del self.retry_queue[file_path]
  620              self.log.emit(f"âŒ æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œå·²è®°å½•åˆ°å¤±è´¥æ—¥å¿—: {os.path.basename(file_path)}")
  621              return
  622          
  623          # è®¡ç®—ä¸‹ä¸€æ¬¡é‡è¯•æ—¶é—´ï¼ˆéé˜»å¡è°ƒåº¦ï¼‰
  624          wait_times = [10, 30, 60]
  625          wait_time = wait_times[min(retry_count - 1, len(wait_times) - 1)]
  626          item['next'] = time.time() + wait_time
  627          self.retry_queue[file_path] = item
  628          self.log.emit(f"âš  æ–‡ä»¶å°†åœ¨ç¨åé‡è¯• ({retry_count}/{self.retry_count})ï¼Œç­‰å¾…{wait_time}ç§’: {os.path.basename(file_path)}")
  629  
  630      def _process_retry_queue(self):
  631          """å¤„ç†é‡è¯•é˜Ÿåˆ—ï¼ˆéé˜»å¡ï¼ŒæŒ‰åˆ°æœŸæ—¶é—´è§¦å‘ï¼‰"""
  632          if not self.retry_queue:
  633              return
  634          now = time.time()
  635          retry_list = list(self.retry_queue.items())  # (path, item)
  636          for file_path, item in retry_list:
  637              if not self._running:
  638                  break
  639              if self._paused:
  640                  continue
  641              # æ–‡ä»¶ä¸å­˜åœ¨åˆ™ç§»é™¤
  642              if not os.path.exists(file_path):
  643                  del self.retry_queue[file_path]
  644                  continue
  645              retry_count = item.get('count', 1)
  646              next_at = item.get('next', 0.0)
  647              if now < next_at:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 14 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
  648                  # è¿˜æ²¡åˆ°æ—¶é—´
  649                  continue
  650              # åˆ°æ—¶é—´å°è¯•é‡è¯•
  651              self.log.emit(f"ğŸ“¤ å¼€å§‹é‡è¯•ä¸Šä¼  ({retry_count}/{self.retry_count}): {os.path.basename(file_path)}")
  652              rel = os.path.relpath(file_path, self.source)
  653              tgt = os.path.join(self.target, rel)
  654              bkp = os.path.join(self.backup, rel)
  655              try:
  656                  tgt_exists = self._safe_path_operation(os.path.exists, tgt, timeout=2.0, default=False)
  657                  if tgt_exists:
  658                      del self.retry_queue[file_path]
  659                      continue
  660                  # åˆ›å»ºç›®å½•
  661                  self._safe_path_operation(lambda: os.makedirs(os.path.dirname(tgt), exist_ok=True), timeout=3.0, default=False)
  662                  # å¤åˆ¶æ–‡ä»¶
  663                  copy_success = self._safe_path_operation(lambda: shutil.copy2(file_path, tgt) or True, timeout=10.0, default=False)
  664                  if not copy_success:
  665                      raise Exception("æ–‡ä»¶å¤åˆ¶è¶…æ—¶")
  666                  # æˆåŠŸ
  667                  self.archive_queue.put((file_path, bkp))
  668                  del self.retry_queue[file_path]
  669                  self.uploaded += 1
  670                  self.stats.emit(self.uploaded, self.failed, self.skipped, self.rate)
  671                  self.log.emit(f"âœ“ é‡è¯•æˆåŠŸ: {os.path.basename(file_path)}")
  672              except Exception as e:
  673                  # å¤±è´¥åˆ™å†æ¬¡è°ƒåº¦
  674                  item['count'] = retry_count + 1
  675                  if item['count'] > self.retry_count:
  676                      self._log_failed_file(file_path, f"é‡è¯•{retry_count}æ¬¡åä»ç„¶å¤±è´¥: {str(e)[:50]}")
  677                      del self.retry_queue[file_path]
  678                      self.failed += 1
  679                      self.stats.emit(self.uploaded, self.failed, self.skipped, self.rate)
  680                      self.log.emit(f"âŒ æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œå·²è®°å½•åˆ°å¤±è´¥æ—¥å¿—: {os.path.basename(file_path)}")
  681                  else:
  682                      wait_times = [10, 30, 60]
  683                      wait_time = wait_times[min(item['count'] - 1, len(wait_times) - 1)]
  684                      item['next'] = time.time() + wait_time
  685                      self.retry_queue[file_path] = item
  686                      self.log.emit(f"âš  é‡è¯•å¤±è´¥ï¼Œå·²é‡æ–°æ’é˜Ÿ ({item['count']}/{self.retry_count})ï¼Œç­‰å¾…{wait_time}ç§’: {os.path.basename(file_path)}")
  687  
  688      def _log_failed_file(self, file_path: str, reason: str):
  689          """è®°å½•å¤±è´¥æ–‡ä»¶åˆ°æ—¥å¿—æ–‡ä»¶"""
  690          try:
  691              timestamp = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
  692              with open(self.failed_log_path, 'a', encoding='utf-8') as f:
  693                  f.write(f"[{timestamp}] {file_path} - {reason}\n")
  694          except Exception as e:
  695              self.log.emit(f"å†™å…¥å¤±è´¥æ—¥å¿—å‡ºé”™: {e}")
  696      
  697      def _copy_with_progress(self, src: str, dst: str, buffer_size: int = 1024 * 1024):

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 15 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
  698          """v2.3.0 å¸¦è¿›åº¦å’Œé€Ÿç‡é™åˆ¶çš„æ–‡ä»¶å¤åˆ¶"""
  699          last_write_time = time.time()
  700          write_timeout = 5.0  # 5ç§’å†…æ²¡æœ‰å†™å…¥è§†ä¸ºè¶…æ—¶
  701          
  702          # v2.3.0 é€Ÿç‡é™åˆ¶ï¼šå¦‚æœå¯ç”¨ï¼Œå‡å°bufferä»¥æé«˜ç²¾ç¡®åº¦
  703          if self.limit_upload_rate and self.max_upload_rate_bytes > 0:
  704              buffer_size = min(buffer_size, 64 * 1024)  # 64KB chunks
  705          
  706          try:
  707              with open(src, 'rb') as fsrc:
  708                  with open(dst, 'wb') as fdst:
  709                      copied = 0
  710                      while True:
  711                          if not self._running or self._paused:
  712                              break
  713                          
  714                          # æ£€æŸ¥å†™å…¥è¶…æ—¶ï¼ˆå¯èƒ½æ˜¯ç½‘ç»œæ–­å¼€ï¼‰
  715                          if time.time() - last_write_time > write_timeout:
  716                              self.log.emit(f"â±ï¸ æ–‡ä»¶å†™å…¥è¶…æ—¶ï¼ˆ{write_timeout}ç§’ï¼‰ï¼Œå¯èƒ½ç½‘ç»œå·²æ–­å¼€")
  717                              raise Exception("æ–‡ä»¶å†™å…¥è¶…æ—¶")
  718                          
  719                          # v2.3.0 é€Ÿç‡é™åˆ¶ï¼šè®°å½•å¼€å§‹æ—¶é—´
  720                          chunk_start = time.time()
  721                          
  722                          buf = fsrc.read(buffer_size)
  723                          if not buf:
  724                              break
  725                          
  726                          # å†™å…¥æ“ä½œ
  727                          try:
  728                              fdst.write(buf)
  729                              last_write_time = time.time()  # é‡ç½®è¶…æ—¶è®¡æ—¶å™¨
  730                          except Exception as e:
  731                              self.log.emit(f"âš ï¸ æ–‡ä»¶å†™å…¥å¤±è´¥: {str(e)[:50]}")
  732                              raise
  733                          
  734                          copied += len(buf)
  735                          
  736                          # v2.3.0 é€Ÿç‡é™åˆ¶ï¼šè®¡ç®—åº”è¯¥èŠ±è´¹çš„æ—¶é—´
  737                          if self.limit_upload_rate and self.max_upload_rate_bytes > 0:
  738                              expected_time = len(buf) / self.max_upload_rate_bytes
  739                              elapsed_time = time.time() - chunk_start
  740                              if elapsed_time < expected_time:
  741                                  time.sleep(expected_time - elapsed_time)
  742                          
  743                          # æ›´æ–°è¿›åº¦ï¼ˆæ¯å¤åˆ¶1MBæ›´æ–°ä¸€æ¬¡ï¼‰
  744                          if self.current_file_size > 0:
  745                              progress = int(100 * copied / self.current_file_size)
  746                              self.file_progress.emit(self.current_file_name, progress)
  747                              # æ¯10%è¾“å‡ºæ—¥å¿—

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 16 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
  748                              if progress % 10 == 0 and progress > 0:
  749                                  # v2.3.0 æ˜¾ç¤ºå®æ—¶é€Ÿç‡
  750                                  actual_speed_mbps = (copied / (1024 * 1024)) / (time.time() - chunk_start + 0.001)
  751                                  if self.limit_upload_rate:
  752                                      self.log.emit(f"ğŸ“Š ä¸Šä¼ è¿›åº¦: {progress}% ({copied/(1024*1024):.1f}MB/{self.current_file_size/(1024*1024):.1f}MB) [é™é€Ÿ: {self.max_upload_rate_bytes/(1024*1024):.1f}MB/s]")
  753                                  else:
  754                                      self.log.emit(f"ğŸ“Š ä¸Šä¼ è¿›åº¦: {progress}% ({copied/(1024*1024):.1f}MB/{self.current_file_size/(1024*1024):.1f}MB)")
  755              
  756              # å¤åˆ¶æ–‡ä»¶å…ƒæ•°æ®
  757              shutil.copystat(src, dst)
  758          except Exception as e:
  759              # å¦‚æœå¤åˆ¶å¤±è´¥ï¼Œåˆ é™¤ä¸å®Œæ•´çš„æ–‡ä»¶
  760              if os.path.exists(dst):
  761                  try:
  762                      os.remove(dst)
  763                  except:
  764                      pass
  765              raise e
  766      
  767      # v2.0 æ–°å¢ï¼šå¤šåè®®ä¸Šä¼ æ”¯æŒ
  768      def _upload_file_by_protocol(self, src: str, dst: str) -> bool:
  769          """
  770          æ ¹æ®é…ç½®çš„åè®®ä¸Šä¼ æ–‡ä»¶
  771          
  772          Args:
  773              src: æºæ–‡ä»¶è·¯å¾„
  774              dst: ç›®æ ‡æ–‡ä»¶è·¯å¾„ï¼ˆSMBè·¯å¾„æˆ–æœ¬åœ°è·¯å¾„ï¼‰
  775          
  776          Returns:
  777              bool: ä¸Šä¼ æ˜¯å¦æˆåŠŸ
  778          """
  779          if self.upload_protocol == 'smb':
  780              # SMBåè®®ï¼šç›´æ¥ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå¤åˆ¶
  781              return self._upload_via_smb(src, dst)
  782          elif self.upload_protocol == 'ftp_client':
  783              # FTPå®¢æˆ·ç«¯æ¨¡å¼ï¼šä¸Šä¼ åˆ°FTPæœåŠ¡å™¨
  784              return self._upload_via_ftp(src, dst)
  785          elif self.upload_protocol == 'both':
  786              # æ··åˆæ¨¡å¼ï¼šåŒæ—¶ä½¿ç”¨SMBå’ŒFTP
  787              smb_ok = self._upload_via_smb(src, dst)
  788              ftp_ok = self._upload_via_ftp(src, dst)
  789              return smb_ok or ftp_ok  # ä»»ä¸€æˆåŠŸå³è§†ä¸ºæˆåŠŸ
  790          else:
  791              self.log.emit(f"âŒ æœªçŸ¥çš„ä¸Šä¼ åè®®: {self.upload_protocol}")
  792              return False
  793      
  794      def _upload_via_smb(self, src: str, dst: str) -> bool:
  795          """é€šè¿‡SMBåè®®ä¸Šä¼ æ–‡ä»¶ï¼ˆä½¿ç”¨shutil.copy2ï¼‰"""
  796          try:
  797              # å¯¹äºå¤§æ–‡ä»¶ï¼Œæ˜¾ç¤ºä¸Šä¼ è¿›åº¦

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 17 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
  798              if self.current_file_size > 10 * 1024 * 1024:  # å¤§äº10MB
  799                  self._copy_with_progress(src, dst)
  800              else:
  801                  # å°æ–‡ä»¶ä¹Ÿä½¿ç”¨è¶…æ—¶ä¿æŠ¤
  802                  def copy_file():
  803                      shutil.copy2(src, dst)
  804                      return True
  805                  
  806                  copy_success = self._safe_path_operation(copy_file, timeout=10.0, default=False)
  807                  if not copy_success:
  808                      raise Exception("æ–‡ä»¶å¤åˆ¶è¶…æ—¶ï¼Œç½‘ç»œå¯èƒ½å·²æ–­å¼€")
  809              
  810              return True
  811          except Exception as e:
  812              self.log.emit(f"âŒ SMBä¸Šä¼ å¤±è´¥: {e}")
  813              return False
  814      
  815      def _upload_via_ftp(self, src: str, dst: str) -> bool:
  816          """é€šè¿‡FTPåè®®ä¸Šä¼ æ–‡ä»¶"""
  817          try:
  818              # åˆå§‹åŒ–FTPå®¢æˆ·ç«¯ï¼ˆå¦‚æœè¿˜æœªåˆå§‹åŒ–ï¼‰
  819              if not self.ftp_client and self.ftp_client_config:
  820                  self.ftp_client = FTPClientUploader(self.ftp_client_config)
  821                  if not self.ftp_client.connect():
  822                      # v2.0 å¢å¼ºï¼šè¯¦ç»†é”™è¯¯æ—¥å¿—
  823                      host = self.ftp_client_config.get('host', 'unknown')
  824                      port = self.ftp_client_config.get('port', 21)
  825                      self.log.emit(f"âŒ [FTP-CONN] æ— æ³•è¿æ¥åˆ° {host}:{port}")
  826                      self.ftp_client = None
  827                      return False
  828              
  829              if not self.ftp_client:
  830                  self.log.emit("âŒ [FTP-INIT] FTPå®¢æˆ·ç«¯æœªåˆå§‹åŒ–")
  831                  return False
  832              
  833              # è®¡ç®—è¿œç¨‹è·¯å¾„ï¼ˆä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼‰
  834              rel_path = os.path.relpath(dst, self.target)
  835              remote_path = self.ftp_client_config.get('remote_path', '/upload')
  836              remote_file = f"{remote_path}/{rel_path}".replace('\\', '/')
  837              
  838              # ä¸Šä¼ æ–‡ä»¶
  839              success = self.ftp_client.upload_file(Path(src), remote_file)
  840              if success:
  841                  self.log.emit(f"âœ“ FTPä¸Šä¼ æˆåŠŸ: {os.path.basename(remote_file)}")
  842                  return True
  843              else:
  844                  # v2.0 å¢å¼ºï¼šè¯¦ç»†é”™è¯¯æ—¥å¿—
  845                  self.log.emit(f"âŒ [FTP-UPLOAD] ä¸Šä¼ å¤±è´¥: {os.path.basename(remote_file)}")
  846                  return False
  847                  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 18 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
  848          except Exception as e:
  849              # v2.0 å¢å¼ºï¼šè¯¦ç»†é”™è¯¯æ—¥å¿—ï¼ŒåŒ…å«å¼‚å¸¸ç±»å‹
  850              error_type = type(e).__name__
  851              self.log.emit(f"âŒ [FTP-ERROR] {error_type}: {e}")
  852              return False
  853      
  854      def _calculate_file_hash(self, file_path: str, buffer_size: int = 8192) -> str:
  855          """è®¡ç®—æ–‡ä»¶å“ˆå¸Œå€¼ï¼ˆMD5æˆ–SHA256ï¼‰"""
  856          try:
  857              if self.hash_algorithm == 'sha256':
  858                  hasher = hashlib.sha256()
  859              else:
  860                  hasher = hashlib.md5()
  861              
  862              file_size = os.path.getsize(file_path)
  863              
  864              with open(file_path, 'rb') as f:
  865                  processed = 0
  866                  while True:
  867                      if not self._running or self._paused:
  868                          return ""
  869                      
  870                      data = f.read(buffer_size)
  871                      if not data:
  872                          break
  873                      hasher.update(data)
  874                      processed += len(data)
  875                      
  876                      # å¤§æ–‡ä»¶æ˜¾ç¤ºå“ˆå¸Œè®¡ç®—è¿›åº¦
  877                      if file_size > 50 * 1024 * 1024:  # å¤§äº50MB
  878                          progress = int(100 * processed / file_size)
  879                          if progress % 10 == 0:  # æ¯10%æ˜¾ç¤ºä¸€æ¬¡
  880                              self.log.emit(f"ğŸ” è®¡ç®—å“ˆå¸Œå€¼... {progress}%")
  881              
  882              return hasher.hexdigest()
  883          except Exception as e:
  884              self.log.emit(f"âš  å“ˆå¸Œè®¡ç®—å¤±è´¥: {e}")
  885              return ""
  886      
  887      def _find_duplicate_by_hash(self, file_hash: str, target_dir: str) -> str:
  888          """åœ¨ç›®æ ‡æ–‡ä»¶å¤¹ä¸­æŸ¥æ‰¾ç›¸åŒå“ˆå¸Œçš„æ–‡ä»¶"""
  889          if not file_hash:
  890              return ""
  891          
  892          try:
  893              for root, _, files in os.walk(target_dir):
  894                  for name in files:
  895                      if not self._running or self._paused:
  896                          return ""
  897                      

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 19 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
  898                      target_file = os.path.join(root, name)
  899                      try:
  900                          target_hash = self._calculate_file_hash(target_file)
  901                          if target_hash == file_hash:
  902                              return target_file
  903                      except Exception:
  904                          continue
  905              return ""
  906          except Exception:
  907              return ""
  908      
  909      def _get_unique_filename(self, base_path: str) -> str:
  910          """ç”Ÿæˆå”¯ä¸€çš„æ–‡ä»¶åï¼ˆæ·»åŠ åºå·ï¼‰"""
  911          if not os.path.exists(base_path):
  912              return base_path
  913          
  914          directory = os.path.dirname(base_path)
  915          filename = os.path.basename(base_path)
  916          name, ext = os.path.splitext(filename)
  917          
  918          counter = 1
  919          while True:
  920              new_name = f"{name} ({counter}){ext}"
  921              new_path = os.path.join(directory, new_name)
  922              if not os.path.exists(new_path):
  923                  return new_path
  924              counter += 1
  925              if counter > 9999:  # é˜²æ­¢æ— é™å¾ªç¯
  926                  return base_path
  927  
  928      def _archive_worker(self):
  929          """ç‹¬ç«‹å½’æ¡£çº¿ç¨‹ï¼ˆé¿å…é˜»å¡ä¸Šä¼ ï¼‰
  930          v2.1.1 ä¿®æ”¹ï¼šæ ¹æ® enable_backup é…ç½®å†³å®šæ˜¯å½’æ¡£è¿˜æ˜¯åˆ é™¤
  931          """
  932          while self._running:
  933              try:
  934                  # 1ç§’è¶…æ—¶ï¼Œé¿å…æ­»ç­‰
  935                  item = self.archive_queue.get(timeout=1)
  936                  src_path, bkp_path = item
  937                  
  938                  if not os.path.exists(src_path):
  939                      continue
  940                  
  941                  # v2.1.1ï¼šæ ¹æ®å¤‡ä»½å¯ç”¨çŠ¶æ€å†³å®šæ“ä½œ
  942                  if self.enable_backup and self.backup and os.path.exists(os.path.dirname(self.backup)):
  943                      # å¯ç”¨å¤‡ä»½ï¼šç§»åŠ¨åˆ°å¤‡ä»½æ–‡ä»¶å¤¹
  944                      os.makedirs(os.path.dirname(bkp_path), exist_ok=True)
  945                      shutil.move(src_path, bkp_path)
  946                      self.log.emit(f"ğŸ“¦ å·²å½’æ¡£: {os.path.basename(bkp_path)}")
  947                  else:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 20 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
  948                      # æœªå¯ç”¨å¤‡ä»½ï¼šç›´æ¥åˆ é™¤æºæ–‡ä»¶
  949                      os.remove(src_path)
  950                      self.log.emit(f"ğŸ—‘ï¸ å·²åˆ é™¤: {os.path.basename(src_path)}")
  951              except queue.Empty:
  952                  continue
  953              except Exception as e:
  954                  self.log.emit(f"å½’æ¡£å¤±è´¥: {e}")
  955  
  956      def _disk_ok(self, path: str) -> Tuple[float, float, float]:
  957          """æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼ˆå¸¦è¶…æ—¶ä¿æŠ¤ï¼‰"""
  958          def check():
  959              try:
  960                  parent = os.path.dirname(path) or path
  961                  usage = shutil.disk_usage(parent)
  962                  total_gb = usage.total / (1024 ** 3)
  963                  free_gb = usage.free / (1024 ** 3)
  964                  free_percent = (usage.free / usage.total) * 100 if usage.total > 0 else 0
  965                  return free_percent, total_gb, free_gb
  966              except Exception:
  967                  return 0.0, 0.0, 0.0
  968          
  969          # ä½¿ç”¨å®‰å…¨æ“ä½œï¼Œ2ç§’è¶…æ—¶
  970          result = self._safe_path_operation(check, timeout=2.0, default=(0.0, 0.0, 0.0))
  971          return result if result is not None else (0.0, 0.0, 0.0)
  972  
  973      def _get_image_files(self) -> List[str]:
  974          """æ‰«æå›¾ç‰‡æ–‡ä»¶ï¼ˆå¸¦è¶…æ—¶ä¿æŠ¤ï¼‰"""
  975          def scan():
  976              if not os.path.exists(self.source):
  977                  return []
  978              files = []
  979              for root, _, names in os.walk(self.source):
  980                  if not self._running:  # æ”¯æŒä¸­æ–­
  981                      break
  982                  for n in names:
  983                      ext = os.path.splitext(n)[1].lower()
  984                      if ext in self.filters:
  985                          files.append(os.path.join(root, n))
  986              return files
  987          
  988          # ä½¿ç”¨å®‰å…¨æ“ä½œï¼Œ5ç§’è¶…æ—¶ï¼ˆæ‰«æå¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´ï¼‰
  989          result = self._safe_path_operation(scan, timeout=5.0, default=[])
  990          return result if result is not None else []
  991  
  992      def _run(self):
  993          self.log.emit("ğŸš€ å¼€å§‹å›¾ç‰‡ä¸Šä¼ æœåŠ¡ï¼ˆä¸Šä¼ ä¸å½’æ¡£å·²åˆ†ç¦»ï¼‰")
  994          self.start_time = time.time()
  995          
  996          # å¯åŠ¨ç‹¬ç«‹å½’æ¡£çº¿ç¨‹
  997          self._archive_thread = threading.Thread(target=self._archive_worker, daemon=True)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 21 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
  998          self._archive_thread.start()
  999          self.log.emit("ğŸ“¦ å½’æ¡£çº¿ç¨‹å·²å¯åŠ¨")
 1000          
 1001          # é‡ç½®çŠ¶æ€
 1002          self.uploaded = 0
 1003          self.failed = 0
 1004          self.skipped = 0
 1005          self.retry_queue.clear()
 1006          
 1007          try:
 1008              while self._running:
 1009                  # æš‚åœ
 1010                  pause_log_counter = 0
 1011                  while self._paused and self._running:
 1012                      time.sleep(0.2)
 1013                      # æ¯10ç§’ï¼ˆ50æ¬¡å¾ªç¯ï¼‰è¾“å‡ºä¸€æ¬¡æš‚åœçŠ¶æ€æ—¥å¿—
 1014                      pause_log_counter += 1
 1015                      if pause_log_counter >= 50:
 1016                          pause_log_counter = 0
 1017                          self.log.emit("â¸ï¸ ä¸Šä¼ å·²æš‚åœï¼Œç­‰å¾…æ¢å¤...")
 1018                  if not self._running:
 1019                      break
 1020  
 1021                  # ç½‘ç»œè¿æ¥æ£€æŸ¥ï¼ˆæ ¹æ®é…ç½®é—´éš”ï¼‰
 1022                  try:
 1023                      network_status = self._check_network_connection()
 1024                  except Exception as e:
 1025                      self.log.emit(f"âš ï¸ ç½‘ç»œæ£€æµ‹å¼‚å¸¸: {str(e)[:50]}")
 1026                      network_status = 'disconnected'
 1027                  
 1028                  # å¦‚æœç½‘ç»œæ–­å¼€ä¸”å·²æš‚åœï¼Œç­‰å¾…ç½‘ç»œæ¢å¤
 1029                  if network_status == 'disconnected' and self._paused:
 1030                      self.log.emit("ğŸ”Œ ç­‰å¾…ç½‘ç»œæ¢å¤ä¸­...")
 1031                      time.sleep(1)
 1032                      continue
 1033  
 1034                  # ç©ºé—´æ£€æŸ¥ï¼ˆå¸¦è­¦å‘Šï¼‰
 1035                  tf_ok, _, _ = self._disk_ok(self.target)
 1036                  bf_ok, _, _ = self._disk_ok(self.backup)
 1037                  if tf_ok < self.disk_threshold_percent or bf_ok < self.disk_threshold_percent:
 1038                      now = time.time()
 1039                      if now - self._last_space_warn > 10:
 1040                          self._last_space_warn = now
 1041                          self.log.emit(f"âš  ç£ç›˜ç©ºé—´ä¸è¶³ï¼ç›®æ ‡:{tf_ok:.0f}%ï¼Œå¤‡ä»½:{bf_ok:.0f}%ï¼ˆé˜ˆå€¼:{self.disk_threshold_percent}%ï¼‰")
 1042                          # v2.2.0 å‘é€ç£ç›˜ç©ºé—´è­¦å‘Šä¿¡å·
 1043                          self.disk_warning.emit(tf_ok, bf_ok, self.disk_threshold_percent)
 1044                      time.sleep(2)
 1045                      continue
 1046  
 1047                  # å¤„ç†é‡è¯•é˜Ÿåˆ—

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 22 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 1048                  self._process_retry_queue()
 1049  
 1050                  # æ‰«æä¸å¤„ç†
 1051                  images = self._get_image_files()
 1052                  self.total_files = len(images)
 1053                  self.current = 0
 1054                  self.progress.emit(self.current, self.total_files, "")
 1055  
 1056                  for path in images:
 1057                      if not self._running:
 1058                          break
 1059                      while self._paused and self._running:
 1060                          time.sleep(0.2)
 1061                      if not self._running:
 1062                          break
 1063                      
 1064                      # åœ¨æ¯ä¸ªæ–‡ä»¶ä¸Šä¼ å‰å¿«é€Ÿæ£€æŸ¥ç½‘ç»œçŠ¶æ€
 1065                      network_status = self._check_network_connection()
 1066                      if network_status == 'disconnected':
 1067                          self.log.emit("âš ï¸ ç½‘ç»œå·²æ–­å¼€ï¼Œåœæ­¢ä¸Šä¼ æ–°æ–‡ä»¶")
 1068                          time.sleep(1)
 1069                          continue
 1070  
 1071                      rel = os.path.relpath(path, self.source)
 1072                      tgt = os.path.join(self.target, rel)
 1073                      bkp = os.path.join(self.backup, rel)
 1074                      
 1075                      # å®‰å…¨åˆ›å»ºç›®å½•ï¼ˆå¸¦è¶…æ—¶ï¼‰
 1076                      try:
 1077                          self._safe_path_operation(
 1078                              lambda: os.makedirs(os.path.dirname(tgt), exist_ok=True),
 1079                              timeout=3.0
 1080                          )
 1081                      except Exception as e:
 1082                          self.log.emit(f"âŒ æ— æ³•åˆ›å»ºç›®æ ‡ç›®å½•: {e}")
 1083                          self.failed += 1
 1084                          self.stats.emit(self.uploaded, self.failed, self.skipped, self.rate)
 1085                          continue
 1086  
 1087                      fname = os.path.basename(path)
 1088                      self.current_file_name = fname
 1089                      
 1090                      self.log.emit(f"ğŸ“¤ å¼€å§‹ä¸Šä¼ : {fname}")
 1091                      self.progress.emit(self.current, self.total_files, fname)
 1092                      start_t = time.time()
 1093                      try:
 1094                          # åŸºæœ¬æ£€æŸ¥ï¼šç›®æ ‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆä¸å¯ç”¨å»é‡æ—¶çš„é»˜è®¤è¡Œä¸ºï¼Œå¸¦è¶…æ—¶ï¼‰
 1095                          tgt_exists = self._safe_path_operation(os.path.exists, tgt, timeout=2.0, default=False)
 1096                          if tgt_exists and not self.enable_deduplication:
 1097                              self.log.emit(f"â­ æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡: {fname}")

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 23 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 1098                              self.skipped += 1
 1099                              self.stats.emit(self.uploaded, self.failed, self.skipped, self.rate)
 1100                              self.file_progress.emit(fname, 100)
 1101                          else:
 1102                              # è·å–æ–‡ä»¶å¤§å°
 1103                              try:
 1104                                  self.current_file_size = os.path.getsize(path)
 1105                              except:
 1106                                  self.current_file_size = 0
 1107                              
 1108                              # å‘é€å¼€å§‹ä¸Šä¼ ä¿¡å·ï¼ˆ0%ï¼‰
 1109                              self.file_progress.emit(fname, 0)
 1110                              
 1111                              # ===== æ™ºèƒ½å»é‡é€»è¾‘ =====
 1112                              should_upload = True
 1113                              final_target = tgt
 1114                              
 1115                              if self.enable_deduplication:
 1116                                  self.log.emit(f"ğŸ” æ£€æŸ¥é‡å¤æ–‡ä»¶ï¼ˆ{self.hash_algorithm.upper()}ï¼‰...")
 1117                                  file_hash = self._calculate_file_hash(path)
 1118                                  
 1119                                  if file_hash:
 1120                                      duplicate = self._find_duplicate_by_hash(file_hash, self.target)
 1121                                      
 1122                                      if duplicate:
 1123                                          self.log.emit(f"âš  å‘ç°é‡å¤æ–‡ä»¶: {os.path.basename(duplicate)}")
 1124                                          
 1125                                          if self.duplicate_strategy == 'skip':
 1126                                              self.log.emit(f"â­ è·³è¿‡é‡å¤æ–‡ä»¶: {fname}")
 1127                                              self.skipped += 1
 1128                                              self.stats.emit(self.uploaded, self.failed, self.skipped, self.rate)
 1129                                              should_upload = False
 1130                                              # ç›´æ¥å½’æ¡£æºæ–‡ä»¶
 1131                                              self.archive_queue.put((path, bkp))
 1132                                          elif self.duplicate_strategy == 'rename':
 1133                                              final_target = self._get_unique_filename(tgt)
 1134                                              self.log.emit(f"ğŸ“ é‡å‘½å: {os.path.basename(final_target)}")
 1135                                          elif self.duplicate_strategy == 'overwrite':
 1136                                              self.log.emit(f"ğŸ”„ è¦†ç›–ç°æœ‰æ–‡ä»¶")
 1137                                              try:
 1138                                                  os.remove(duplicate)
 1139                                              except Exception:
 1140                                                  pass
 1141                                          # 'ask' ç­–ç•¥æš‚æ—¶æŒ‰ skip å¤„ç†ï¼ˆéœ€è¦UIå¼¹çª—ï¼Œåç»­å®ç°ï¼‰
 1142                                          elif self.duplicate_strategy == 'ask':
 1143                                              # å¦‚æœå·²æœ‰ç”¨æˆ·é€‰æ‹©â€œåº”ç”¨äºåç»­â€ï¼Œç›´æ¥ä½¿ç”¨
 1144                                              choice = self._duplicate_ask_choice
 1145                                              if choice is None:
 1146                                                  # é€šè¿‡ä¿¡å·è¯·æ±‚ä¸»çº¿ç¨‹å¼¹çª—
 1147                                                  evt = threading.Event()

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 24 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 1148                                                  payload = {
 1149                                                      'file': path,
 1150                                                      'duplicate': duplicate,
 1151                                                      'event': evt,
 1152                                                      'result': {},
 1153                                                  }
 1154                                                  try:
 1155                                                      self.ask_user_duplicate.emit(payload)
 1156                                                      # æœ€é•¿ç­‰å¾…120ç§’ç”¨æˆ·é€‰æ‹©
 1157                                                      evt.wait(timeout=120)
 1158                                                  except Exception:
 1159                                                      pass
 1160                                                  choice = payload.get('result', {}).get('choice') or 'skip'
 1161                                                  apply_all = bool(payload.get('result', {}).get('apply_all'))
 1162                                                  if apply_all:
 1163                                                      self._duplicate_ask_choice = choice
 1164                                              # æ ¹æ®é€‰æ‹©å¤„ç†
 1165                                              if choice == 'skip':
 1166                                                  self.log.emit(f"â­ è·³è¿‡é‡å¤æ–‡ä»¶: {fname}")
 1167                                                  self.skipped += 1
 1168                                                  self.stats.emit(self.uploaded, self.failed, self.skipped, self.rate)
 1169                                                  should_upload = False
 1170                                                  self.archive_queue.put((path, bkp))
 1171                                              elif choice == 'rename':
 1172                                                  final_target = self._get_unique_filename(tgt)
 1173                                                  self.log.emit(f"ğŸ“ é‡å‘½å: {os.path.basename(final_target)}")
 1174                                              elif choice == 'overwrite':
 1175                                                  self.log.emit(f"ğŸ”„ è¦†ç›–ç°æœ‰æ–‡ä»¶")
 1176                                                  try:
 1177                                                      os.remove(duplicate)
 1178                                                  except Exception:
 1179                                                      pass
 1180                              
 1181                              # ===== æ‰§è¡Œä¸Šä¼  =====
 1182                              if should_upload:
 1183                                  # åˆ›å»ºç›®æ ‡ç›®å½•ï¼ˆå¸¦è¶…æ—¶ä¿æŠ¤ï¼‰
 1184                                  def create_dir():
 1185                                      os.makedirs(os.path.dirname(final_target), exist_ok=True)
 1186                                  
 1187                                  dir_created = self._safe_path_operation(create_dir, timeout=3.0, default=False)
 1188                                  if dir_created is False:
 1189                                      raise Exception("åˆ›å»ºç›®æ ‡ç›®å½•è¶…æ—¶ï¼Œç½‘ç»œå¯èƒ½å·²æ–­å¼€")
 1190                                  
 1191                                  # v2.0 æ–°å¢ï¼šä½¿ç”¨åè®®è·¯ç”±ä¸Šä¼ æ–‡ä»¶
 1192                                  upload_success = self._upload_file_by_protocol(path, final_target)
 1193                                  
 1194                                  if not upload_success:
 1195                                      raise Exception("æ–‡ä»¶ä¸Šä¼ å¤±è´¥")
 1196                                  
 1197                                  self.uploaded += 1

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 25 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 1198                                  # é€Ÿç‡è®¡ç®—
 1199                                  try: 
 1200                                      size_mb = os.path.getsize(final_target) / (1024*1024)
 1201                                      dur = max(time.time()-start_t, 1e-6)
 1202                                      rate = size_mb / dur
 1203                                      self.rate = f"{rate:.2f} MB/s"
 1204                                  except Exception:
 1205                                      pass
 1206                                  self.stats.emit(self.uploaded, self.failed, self.skipped, self.rate)
 1207                                  self.file_progress.emit(fname, 100)
 1208                                  self.log.emit(f"âœ“ ä¸Šä¼ æˆåŠŸ: {os.path.basename(final_target)}")
 1209                                  # æ”¾å…¥å½’æ¡£é˜Ÿåˆ—
 1210                                  self.archive_queue.put((path, bkp))
 1211                              else:
 1212                                  self.file_progress.emit(fname, 100)
 1213                      except Exception as e:
 1214                          self.failed += 1
 1215                          self.stats.emit(self.uploaded, self.failed, self.skipped, self.rate)
 1216                          self.log.emit(f"âœ— ä¸Šä¼ å¤±è´¥ {fname}: {e}")
 1217                          # v2.2.0 å‘é€é”™è¯¯é€šçŸ¥ä¿¡å·
 1218                          self.upload_error.emit(fname, str(e))
 1219                          # æ·»åŠ åˆ°é‡è¯•é˜Ÿåˆ—
 1220                          self._handle_upload_failure(path)
 1221  
 1222                      self.current += 1
 1223                      self.progress.emit(self.current, self.total_files, fname)
 1224  
 1225                  # é—´éš”
 1226                  if self.mode == 'periodic':
 1227                      for _ in range(max(1, self.interval*5)):
 1228                          if not self._running or self._paused:
 1229                              break
 1230                          time.sleep(0.2)
 1231                  else:
 1232                      time.sleep(1)
 1233          finally:
 1234              self.log.emit("ğŸ›‘ ä¸Šä¼ æœåŠ¡å·²åœæ­¢")
 1235              self.finished.emit()
 1236  
 1237  
 1238  # v2.3.1 æ¨¡å—åŒ–ç»„ä»¶åˆ«åï¼ˆä¼˜å…ˆä½¿ç”¨æ¨¡å—åŒ–ç‰ˆæœ¬ï¼Œå›é€€åˆ°å†…ç½®ç‰ˆæœ¬ï¼‰
 1239  # è¿™æ ·å¯ä»¥é€æ­¥è¿ç§»åˆ°æ¨¡å—åŒ–æ¶æ„ï¼ŒåŒæ—¶ä¿æŒå‘åå…¼å®¹
 1240  if MODULAR_COMPONENTS_AVAILABLE:
 1241      # ä½¿ç”¨æ¨¡å—åŒ–ç»„ä»¶ï¼ˆæ¨èï¼‰
 1242      Toast = ModularToast  # type: ignore[misc, assignment]
 1243      ChipWidget = ModularChipWidget  # type: ignore[misc, assignment]
 1244      CollapsibleBox = ModularCollapsibleBox  # type: ignore[misc, assignment]
 1245      DiskCleanupDialog = ModularDiskCleanupDialog  # type: ignore[misc, assignment]
 1246      UploadWorker = ModularUploadWorker  # type: ignore[misc, assignment]
 1247  # else: ä½¿ç”¨å†…ç½®ç»„ä»¶ï¼ˆå·²åœ¨ä¸‹æ–¹å®šä¹‰ï¼‰

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 26 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 1248  
 1249  
 1250  
 1251  def main():
 1252      app = QtWidgets.QApplication(sys.argv)
 1253      
 1254      # v2.3.1 å•ä¾‹æ¨¡å¼å¢å¼ºï¼šä½¿ç”¨ LocalSocket å°è¯•å”¤é†’å·²è¿è¡Œçš„å®ä¾‹
 1255      server_name = "ImageUploadTool_SingleInstance_Server"
 1256      socket = QLocalSocket()
 1257      socket.connectToServer(server_name)
 1258      
 1259      # å°è¯•è¿æ¥åˆ°å·²è¿è¡Œçš„å®ä¾‹
 1260      if socket.waitForConnected(500):  # ç­‰å¾…500ms
 1261          # è¿æ¥æˆåŠŸï¼Œè¯´æ˜ç¨‹åºå·²åœ¨è¿è¡Œ
 1262          # å‘é€å”¤é†’æ¶ˆæ¯
 1263          socket.write(b"WAKEUP")
 1264          socket.flush()
 1265          socket.waitForBytesWritten(1000)
 1266          socket.disconnectFromServer()
 1267          
 1268          # æ˜¾ç¤ºæç¤ºï¼ˆå¯é€‰ï¼Œä¹Ÿå¯ä»¥é™é»˜é€€å‡ºï¼‰
 1269          # è¿™é‡Œé€‰æ‹©é™é»˜é€€å‡ºï¼Œå› ä¸ºå·²ç»å”¤é†’äº†æ—§å®ä¾‹
 1270          return
 1271      
 1272      # è¿æ¥å¤±è´¥ï¼Œè¯´æ˜æ²¡æœ‰å…¶ä»–å®ä¾‹åœ¨è¿è¡Œ
 1273      # ä½¿ç”¨å…±äº«å†…å­˜ä½œä¸ºè¾…åŠ©é”ï¼ˆé˜²æ­¢æç«¯æƒ…å†µä¸‹çš„ç«æ€æ¡ä»¶ï¼‰
 1274      shared_mem = QtCore.QSharedMemory("ImageUploadTool_SingleInstance")
 1275      if not shared_mem.create(1):
 1276          # æå°‘æƒ…å†µï¼šLocalServer æœªå“åº”ä½†å…±äº«å†…å­˜å­˜åœ¨
 1277          # è¿™å¯èƒ½æ˜¯ä¸Šæ¬¡ç¨‹åºå¼‚å¸¸é€€å‡ºå¯¼è‡´çš„ï¼Œæç¤ºç”¨æˆ·
 1278          msg = QtWidgets.QMessageBox()
 1279          msg.setIcon(QtWidgets.QMessageBox.Icon.Warning)
 1280          msg.setWindowTitle("ç¨‹åºå¯åŠ¨å¼‚å¸¸")
 1281          msg.setText("æ£€æµ‹åˆ°ç¨‹åºå¯èƒ½æœªæ­£å¸¸é€€å‡º")
 1282          msg.setInformativeText("å»ºè®®ï¼š\n1. æ£€æŸ¥ä»»åŠ¡ç®¡ç†å™¨æ˜¯å¦æœ‰æ®‹ç•™è¿›ç¨‹\n2. é‡å¯è®¡ç®—æœºåé‡è¯•")
 1283          msg.setStandardButtons(QtWidgets.QMessageBox.StandardButton.Ok)
 1284          msg.exec() if hasattr(msg, 'exec') else msg.exec_()
 1285          return
 1286      
 1287      # åˆ›å»ºä¸»çª—å£
 1288      w = MainWindow()
 1289      w.show()
 1290      
 1291      # å…¼å®¹ PyQt5 å’Œ PySide6
 1292      try:
 1293          sys.exit(app.exec())  # PySide6 / PyQt6
 1294      except AttributeError:
 1295          sys.exit(app.exec_())  # PyQt5
 1296  
 1297  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 27 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 1298  if __name__ == '__main__':
 1299      main()
       
       # ============================================================
       # æ–‡ä»¶: qt_types.py
       # ============================================================
 1300  """
 1301  Qt ç±»å‹æç¤ºå’Œæšä¸¾è®¿é—®è¾…åŠ©
 1302  ä¸º PySide6/PyQt5 æä¾›ç±»å‹å®‰å…¨çš„æšä¸¾è®¿é—®ï¼Œé¿å…ä½¿ç”¨ type: ignore
 1303  """
 1304  from typing import Any, TYPE_CHECKING
 1305  
 1306  if TYPE_CHECKING:
 1307      # ä»…ç”¨äºç±»å‹æ£€æŸ¥æ—¶çš„å¯¼å…¥
 1308      try:
 1309          from PySide6 import QtWidgets, QtCore
 1310      except ImportError:
 1311          from PyQt5 import QtWidgets, QtCore  # type: ignore
 1312  
 1313  
 1314  # ============================================
 1315  # ç±»å‹å®‰å…¨çš„æšä¸¾è®¿é—®å™¨
 1316  # ============================================
 1317  
 1318  class QtEnumAccessor:
 1319      """Qt æšä¸¾çš„ç±»å‹å®‰å…¨è®¿é—®å™¨
 1320      
 1321      è§£å†³ PySide6 å¼ºç±»å‹æšä¸¾åœ¨ Pylance ä¸­çš„ç±»å‹æ£€æŸ¥é—®é¢˜
 1322      é€šè¿‡å»¶è¿Ÿè·å–æšä¸¾å€¼ï¼Œé¿å…ç›´æ¥ä½¿ç”¨ type: ignore
 1323      """
 1324      
 1325      _qt_widgets: Any = None
 1326      _qt_core: Any = None
 1327      
 1328      @classmethod
 1329      def _ensure_qt_imported(cls):
 1330          """ç¡®ä¿ Qt æ¨¡å—å·²å¯¼å…¥"""
 1331          if cls._qt_widgets is None:
 1332              try:
 1333                  from PySide6 import QtWidgets, QtCore
 1334                  cls._qt_widgets = QtWidgets
 1335                  cls._qt_core = QtCore
 1336              except ImportError:
 1337                  from PyQt5 import QtWidgets, QtCore  # type: ignore
 1338                  cls._qt_widgets = QtWidgets
 1339                  cls._qt_core = QtCore
 1340      
 1341      @classmethod
 1342      def get_message_box_icon(cls, icon_name: str) -> Any:
 1343          """è·å–æ¶ˆæ¯æ¡†å›¾æ ‡æšä¸¾

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 28 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 1344          
 1345          Args:
 1346              icon_name: 'NoIcon', 'Information', 'Warning', 'Critical', 'Question'
 1347          
 1348          Returns:
 1349              QMessageBox.Icon æšä¸¾å€¼
 1350          """
 1351          cls._ensure_qt_imported()
 1352          return getattr(cls._qt_widgets.QMessageBox.Icon, icon_name, cls._qt_widgets.QMessageBox.Icon.Information)
 1353      
 1354      @classmethod
 1355      def get_message_box_button(cls, button_name: str) -> Any:
 1356          """è·å–æ¶ˆæ¯æ¡†æŒ‰é’®æšä¸¾
 1357          
 1358          Args:
 1359              button_name: 'Yes', 'No', 'Ok', 'Cancel', ç­‰
 1360          
 1361          Returns:
 1362              QMessageBox.StandardButton æšä¸¾å€¼
 1363          """
 1364          cls._ensure_qt_imported()
 1365          return getattr(cls._qt_widgets.QMessageBox.StandardButton, button_name, cls._qt_widgets.QMessageBox.StandardButton.Ok)
 1366      
 1367      @classmethod
 1368      def get_tray_icon_type(cls, icon_name: str) -> Any:
 1369          """è·å–æ‰˜ç›˜å›¾æ ‡ç±»å‹æšä¸¾
 1370          
 1371          Args:
 1372              icon_name: 'NoIcon', 'Information', 'Warning', 'Critical'
 1373          
 1374          Returns:
 1375              QSystemTrayIcon.MessageIcon æšä¸¾å€¼
 1376          """
 1377          cls._ensure_qt_imported()
 1378          return getattr(cls._qt_widgets.QSystemTrayIcon.MessageIcon, icon_name, cls._qt_widgets.QSystemTrayIcon.MessageIcon.Information)
 1379      
 1380      @classmethod
 1381      def get_event_type(cls, type_name: str) -> Any:
 1382          """è·å–äº‹ä»¶ç±»å‹æšä¸¾
 1383          
 1384          Args:
 1385              type_name: 'WindowStateChange', 'Timer', ç­‰
 1386          
 1387          Returns:
 1388              QEvent.Type æšä¸¾å€¼
 1389          """
 1390          cls._ensure_qt_imported()
 1391          return getattr(cls._qt_core.QEvent.Type, type_name, cls._qt_core.QEvent.Type.None_)
 1392  
 1393  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 29 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 1394  # ============================================
 1395  # ä¾¿æ·è®¿é—®å˜é‡ï¼ˆå¸¸ç”¨æšä¸¾å€¼ï¼‰
 1396  # ============================================
 1397  
 1398  class MessageBoxIcons:
 1399      """æ¶ˆæ¯æ¡†å›¾æ ‡å¸¸é‡"""
 1400      @property
 1401      def Information(self) -> Any:
 1402          return QtEnumAccessor.get_message_box_icon('Information')
 1403      
 1404      @property
 1405      def Warning(self) -> Any:
 1406          return QtEnumAccessor.get_message_box_icon('Warning')
 1407      
 1408      @property
 1409      def Critical(self) -> Any:
 1410          return QtEnumAccessor.get_message_box_icon('Critical')
 1411      
 1412      @property
 1413      def Question(self) -> Any:
 1414          return QtEnumAccessor.get_message_box_icon('Question')
 1415  
 1416  
 1417  class MessageBoxButtons:
 1418      """æ¶ˆæ¯æ¡†æŒ‰é’®å¸¸é‡"""
 1419      @property
 1420      def Yes(self) -> Any:
 1421          return QtEnumAccessor.get_message_box_button('Yes')
 1422      
 1423      @property
 1424      def No(self) -> Any:
 1425          return QtEnumAccessor.get_message_box_button('No')
 1426      
 1427      @property
 1428      def Ok(self) -> Any:
 1429          return QtEnumAccessor.get_message_box_button('Ok')
 1430      
 1431      @property
 1432      def Cancel(self) -> Any:
 1433          return QtEnumAccessor.get_message_box_button('Cancel')
 1434  
 1435  
 1436  class TrayIcons:
 1437      """æ‰˜ç›˜å›¾æ ‡å¸¸é‡"""
 1438      @property
 1439      def Information(self) -> Any:
 1440          return QtEnumAccessor.get_tray_icon_type('Information')
 1441      
 1442      @property
 1443      def Warning(self) -> Any:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 30 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 1444          return QtEnumAccessor.get_tray_icon_type('Warning')
 1445      
 1446      @property
 1447      def Critical(self) -> Any:
 1448          return QtEnumAccessor.get_tray_icon_type('Critical')
 1449  
 1450  
 1451  class EventTypes:
 1452      """äº‹ä»¶ç±»å‹å¸¸é‡"""
 1453      @property
 1454      def WindowStateChange(self) -> Any:
 1455          return QtEnumAccessor.get_event_type('WindowStateChange')
 1456  
 1457  
 1458  # åˆ›å»ºå•ä¾‹å®ä¾‹ä¾›å¯¼å…¥ä½¿ç”¨
 1459  MessageBoxIcon = MessageBoxIcons()
 1460  MessageBoxButton = MessageBoxButtons()
 1461  TrayIconType = TrayIcons()
 1462  EventType = EventTypes()
 1463  
       
       # ============================================================
       # æ–‡ä»¶: src\__init__.py
       # ============================================================
 1464  # -*- coding: utf-8 -*-
 1465  """
 1466  å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…· - æ¨¡å—åŒ–æ¶æ„
 1467  
 1468  v3.0.1 - æ¨¡å—åŒ–æ¶æ„é‡æ„å®Œæˆï¼Œå¸ƒå±€ä¼˜åŒ–
 1469  
 1470  ç›®å½•ç»“æ„:
 1471  - src/
 1472    - main.py: ç¨‹åºä¸»å…¥å£
 1473    - config.py: é…ç½®ç®¡ç†
 1474    - core/: æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
 1475      - utils.py: å·¥å…·å‡½æ•°
 1476      - permissions.py: æƒé™ç®¡ç†
 1477    - ui/: ç”¨æˆ·ç•Œé¢æ¨¡å—
 1478      - widgets.py: è‡ªå®šä¹‰æ§ä»¶
 1479      - main_window.py: ä¸»çª—å£
 1480    - workers/: åå°å·¥ä½œçº¿ç¨‹
 1481      - upload_worker.py: ä¸Šä¼ å·¥ä½œçº¿ç¨‹
 1482    - protocols/: åè®®æ¨¡å—
 1483      - ftp.py: FTP åè®®å®ç°
 1484  """
 1485  
 1486  __version__ = "3.0.2"
 1487  __author__ = "RelMoTong"
       
       # ============================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 31 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
       # æ–‡ä»¶: src\config.py
       # ============================================================
 1488  # -*- coding: utf-8 -*-
 1489  """
 1490  é…ç½®ç®¡ç†æ¨¡å—
 1491  
 1492  è´Ÿè´£é…ç½®æ–‡ä»¶çš„åŠ è½½ã€ä¿å­˜å’Œé»˜è®¤å€¼ç”Ÿæˆ
 1493  """
 1494  import json
 1495  from pathlib import Path
 1496  from typing import Dict, Any, Optional
 1497  
 1498  
 1499  class ConfigManager:
 1500      """é…ç½®ç®¡ç†å™¨"""
 1501      
 1502      DEFAULT_CONFIG = {
 1503          'source_folder': '',
 1504          'target_folder': '',
 1505          'backup_folder': '',
 1506          'enable_backup': True,
 1507          'upload_interval': 30,
 1508          'monitor_mode': 'periodic',
 1509          'disk_threshold_percent': 10,
 1510          'retry_count': 3,
 1511          'disk_check_interval': 5,
 1512          # æ–‡ä»¶è¿‡æ»¤
 1513          'filter_jpg': True,
 1514          'filter_png': True,
 1515          'filter_bmp': True,
 1516          'filter_tiff': True,
 1517          'filter_gif': True,
 1518          'filter_raw': True,
 1519          # è‡ªåŠ¨å¯åŠ¨
 1520          'auto_start_windows': False,
 1521          'auto_run_on_startup': False,
 1522          # æ‰˜ç›˜é€šçŸ¥
 1523          'show_notifications': True,
 1524          # é€Ÿç‡é™åˆ¶
 1525          'limit_upload_rate': False,
 1526          'max_upload_rate_mbps': 10.0,
 1527          # å»é‡
 1528          'enable_deduplication': False,
 1529          'hash_algorithm': 'md5',
 1530          'duplicate_strategy': 'ask',
 1531          # ç½‘ç»œç›‘æ§
 1532          'network_check_interval': 10,
 1533          'network_auto_pause': True,
 1534          'network_auto_resume': True,
 1535          # è‡ªåŠ¨åˆ é™¤

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 32 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 1536          'enable_auto_delete': False,
 1537          'auto_delete_folder': '',
 1538          'auto_delete_threshold': 80,
 1539          'auto_delete_keep_days': 10,
 1540          'auto_delete_check_interval': 300,
 1541          # åè®®é…ç½®
 1542          'upload_protocol': 'smb',
 1543          'current_protocol': 'smb',
 1544          # v3.0.2 æ–°å¢ï¼šè¯­è¨€è®¾ç½®
 1545          'language': 'zh_CN',
 1546          # v3.0.2 æ–°å¢ï¼šæ–­ç‚¹ç»­ä¼ è®¾ç½®
 1547          'enable_resume': True,
 1548          'resume_min_size_mb': 10,
 1549          # FTP æœåŠ¡å™¨é…ç½®
 1550          'ftp_server': {
 1551              'host': '0.0.0.0',
 1552              'port': 2121,
 1553              'username': 'upload_user',
 1554              'password': 'upload_pass',
 1555              'shared_folder': '',
 1556              'enable_passive': True,
 1557              'passive_ports_start': 60000,
 1558              'passive_ports_end': 65535,
 1559              'enable_tls': False,
 1560              'max_connections': 256,
 1561              'max_connections_per_ip': 5,
 1562          },
 1563          # FTP å®¢æˆ·ç«¯é…ç½®
 1564          'ftp_client': {
 1565              'host': '',
 1566              'port': 21,
 1567              'username': '',
 1568              'password': '',
 1569              'remote_path': '/upload',
 1570              'timeout': 30,
 1571              'retry_count': 3,
 1572              'passive_mode': True,
 1573              'enable_tls': False,
 1574          },
 1575          # ç”¨æˆ·è´¦æˆ·
 1576          'users': {},
 1577      }
 1578      
 1579      def __init__(self, config_path: Path):
 1580          """åˆå§‹åŒ–é…ç½®ç®¡ç†å™¨
 1581          
 1582          Args:
 1583              config_path: é…ç½®æ–‡ä»¶è·¯å¾„
 1584          """
 1585          self.config_path = config_path

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 33 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 1586          self._config: Dict[str, Any] = {}
 1587      
 1588      def load(self) -> Dict[str, Any]:
 1589          """åŠ è½½é…ç½®æ–‡ä»¶
 1590          
 1591          Returns:
 1592              é…ç½®å­—å…¸
 1593          """
 1594          if not self.config_path.exists():
 1595              self._config = self.DEFAULT_CONFIG.copy()
 1596              return self._config.copy()
 1597          
 1598          try:
 1599              with open(self.config_path, 'r', encoding='utf-8') as f:
 1600                  loaded_config = json.load(f)
 1601              
 1602              # åˆå¹¶é»˜è®¤é…ç½®å’ŒåŠ è½½çš„é…ç½®
 1603              self._config = self.DEFAULT_CONFIG.copy()
 1604              self._config.update(loaded_config)
 1605              
 1606              return self._config.copy()
 1607          except Exception as e:
 1608              print(f"é…ç½®åŠ è½½å¤±è´¥: {e}")
 1609              self._config = self.DEFAULT_CONFIG.copy()
 1610              return self._config.copy()
 1611      
 1612      def save(self, config: Dict[str, Any]) -> bool:
 1613          """ä¿å­˜é…ç½®æ–‡ä»¶
 1614          
 1615          Args:
 1616              config: è¦ä¿å­˜çš„é…ç½®å­—å…¸
 1617              
 1618          Returns:
 1619              æ˜¯å¦ä¿å­˜æˆåŠŸ
 1620          """
 1621          try:
 1622              # ä¿ç•™ç°æœ‰çš„ç”¨æˆ·å¯†ç 
 1623              if self.config_path.exists():
 1624                  try:
 1625                      with open(self.config_path, 'r', encoding='utf-8') as f:
 1626                          old_cfg = json.load(f)
 1627                          config['users'] = old_cfg.get('users', {})
 1628                  except Exception:
 1629                      pass
 1630              
 1631              with open(self.config_path, 'w', encoding='utf-8') as f:
 1632                  json.dump(config, f, indent=2, ensure_ascii=False)
 1633              
 1634              self._config = config.copy()
 1635              return True

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 34 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 1636          except Exception as e:
 1637              print(f"é…ç½®ä¿å­˜å¤±è´¥: {e}")
 1638              return False
 1639      
 1640      def get(self, key: str, default: Any = None) -> Any:
 1641          """è·å–é…ç½®é¡¹
 1642          
 1643          Args:
 1644              key: é…ç½®é”®
 1645              default: é»˜è®¤å€¼
 1646              
 1647          Returns:
 1648              é…ç½®å€¼
 1649          """
 1650          return self._config.get(key, default)
 1651      
 1652      def set(self, key: str, value: Any) -> None:
 1653          """è®¾ç½®é…ç½®é¡¹
 1654          
 1655          Args:
 1656              key: é…ç½®é”®
 1657              value: é…ç½®å€¼
 1658          """
 1659          self._config[key] = value
 1660      
 1661      @staticmethod
 1662      def get_default_config() -> Dict[str, Any]:
 1663          """è·å–é»˜è®¤é…ç½®
 1664          
 1665          Returns:
 1666              é»˜è®¤é…ç½®å­—å…¸
 1667          """
 1668          return ConfigManager.DEFAULT_CONFIG.copy()
       
       # ============================================================
       # æ–‡ä»¶: src\core\__init__.py
       # ============================================================
 1669  # -*- coding: utf-8 -*-
 1670  """
 1671  __init__.py for src.core package
 1672  
 1673  v3.0.2 æ–°å¢ï¼š
 1674  - ResumeManager: æ–­ç‚¹ç»­ä¼ ç®¡ç†å™¨
 1675  - I18n: å¤šè¯­è¨€å›½é™…åŒ–æ”¯æŒ
 1676  """
 1677  from .utils import get_app_dir, get_resource_path, get_app_version, get_app_title
 1678  from .permissions import PermissionManager
 1679  from .resume_manager import ResumeManager, ResumableFileUploader
 1680  from .i18n import I18n, t, set_language, get_language, add_language_listener, LANG_ZH_CN, LANG_EN_US
 1681  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 35 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 1682  __all__ = [
 1683      'get_app_dir', 
 1684      'get_resource_path', 
 1685      'get_app_version', 
 1686      'get_app_title',
 1687      'PermissionManager',
 1688      # v3.0.2 æ–­ç‚¹ç»­ä¼ 
 1689      'ResumeManager',
 1690      'ResumableFileUploader',
 1691      # v3.0.2 å¤šè¯­è¨€
 1692      'I18n',
 1693      't',
 1694      'set_language',
 1695      'get_language',
 1696      'add_language_listener',
 1697      'LANG_ZH_CN',
 1698      'LANG_EN_US',
 1699  ]
       
       # ============================================================
       # æ–‡ä»¶: src\core\i18n.py
       # ============================================================
 1700  # -*- coding: utf-8 -*-
 1701  """
 1702  å¤šè¯­è¨€å›½é™…åŒ–æ¨¡å—
 1703  
 1704  v3.0.2 æ–°å¢åŠŸèƒ½ï¼š
 1705  - æ”¯æŒä¸­è‹±æ–‡åˆ‡æ¢
 1706  - åŠ¨æ€è¯­è¨€åˆ‡æ¢ï¼Œæ— éœ€é‡å¯
 1707  - æ˜“äºæ‰©å±•æ›´å¤šè¯­è¨€
 1708  """
 1709  
 1710  import json
 1711  import logging
 1712  from pathlib import Path
 1713  from typing import Dict, Any, Optional, Callable, List
 1714  
 1715  logger = logging.getLogger(__name__)
 1716  
 1717  
 1718  # è¯­è¨€ä»£ç 
 1719  LANG_ZH_CN = 'zh_CN'
 1720  LANG_EN_US = 'en_US'
 1721  
 1722  # æ”¯æŒçš„è¯­è¨€åˆ—è¡¨
 1723  SUPPORTED_LANGUAGES = [
 1724      (LANG_ZH_CN, 'ç®€ä½“ä¸­æ–‡'),
 1725      (LANG_EN_US, 'English'),
 1726  ]
 1727  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 36 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 1728  
 1729  # ç¿»è¯‘å­—å…¸
 1730  TRANSLATIONS: Dict[str, Dict[str, str]] = {
 1731      # ========== çª—å£æ ‡é¢˜å’Œèœå• ==========
 1732      'app_title': {
 1733          LANG_ZH_CN: 'å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·',
 1734          LANG_EN_US: 'Image Upload Tool',
 1735      },
 1736      'menu_file': {
 1737          LANG_ZH_CN: 'æ–‡ä»¶',
 1738          LANG_EN_US: 'File',
 1739      },
 1740      'menu_settings': {
 1741          LANG_ZH_CN: 'è®¾ç½®',
 1742          LANG_EN_US: 'Settings',
 1743      },
 1744      'menu_help': {
 1745          LANG_ZH_CN: 'å¸®åŠ©',
 1746          LANG_EN_US: 'Help',
 1747      },
 1748      'menu_language': {
 1749          LANG_ZH_CN: 'è¯­è¨€',
 1750          LANG_EN_US: 'Language',
 1751      },
 1752      
 1753      # ========== æ–‡ä»¶å¤¹è®¾ç½®å¡ç‰‡ ==========
 1754      'card_folder_settings': {
 1755          LANG_ZH_CN: 'ğŸ“ æ–‡ä»¶å¤¹è®¾ç½®',
 1756          LANG_EN_US: 'ğŸ“ Folder Settings',
 1757      },
 1758      'source_folder': {
 1759          LANG_ZH_CN: 'æºæ–‡ä»¶å¤¹',
 1760          LANG_EN_US: 'Source Folder',
 1761      },
 1762      'target_folder': {
 1763          LANG_ZH_CN: 'ç›®æ ‡æ–‡ä»¶å¤¹',
 1764          LANG_EN_US: 'Target Folder',
 1765      },
 1766      'backup_folder': {
 1767          LANG_ZH_CN: 'å¤‡ä»½æ–‡ä»¶å¤¹',
 1768          LANG_EN_US: 'Backup Folder',
 1769      },
 1770      'browse': {
 1771          LANG_ZH_CN: 'æµè§ˆ',
 1772          LANG_EN_US: 'Browse',
 1773      },
 1774      'enable_backup': {
 1775          LANG_ZH_CN: ' å¯ç”¨å¤‡ä»½åŠŸèƒ½',
 1776          LANG_EN_US: ' Enable Backup',
 1777      },

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 37 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 1778      'backup_hint': {
 1779          LANG_ZH_CN: 'ğŸ’¡ å¯ç”¨åï¼Œä¸Šä¼ æˆåŠŸçš„æ–‡ä»¶ä¼šç§»åŠ¨åˆ°å¤‡ä»½æ–‡ä»¶å¤¹ä¿å­˜ï¼›ç¦ç”¨åæ–‡ä»¶ä¸Šä¼ æˆåŠŸä¼šç›´æ¥åˆ é™¤',
 1780          LANG_EN_US: 'ğŸ’¡ When enabled, uploaded files are moved to backup folder; when disabled, files are deleted after upload',
 1781      },
 1782      
 1783      # ========== ä¸Šä¼ è®¾ç½®å¡ç‰‡ ==========
 1784      'card_upload_settings': {
 1785          LANG_ZH_CN: 'âš™ï¸ ä¸Šä¼ è®¾ç½®',
 1786          LANG_EN_US: 'âš™ï¸ Upload Settings',
 1787      },
 1788      'upload_protocol': {
 1789          LANG_ZH_CN: 'ğŸ“¡ ä¸Šä¼ åè®® (v2.0)',
 1790          LANG_EN_US: 'ğŸ“¡ Upload Protocol (v2.0)',
 1791      },
 1792      'protocol_type': {
 1793          LANG_ZH_CN: 'åè®®ç±»å‹:',
 1794          LANG_EN_US: 'Protocol Type:',
 1795      },
 1796      'protocol_smb': {
 1797          LANG_ZH_CN: 'SMB (ç½‘ç»œå…±äº«)',
 1798          LANG_EN_US: 'SMB (Network Share)',
 1799      },
 1800      'protocol_ftp_server': {
 1801          LANG_ZH_CN: 'FTP æœåŠ¡å™¨æ¨¡å¼',
 1802          LANG_EN_US: 'FTP Server Mode',
 1803      },
 1804      'protocol_ftp_client': {
 1805          LANG_ZH_CN: 'FTP å®¢æˆ·ç«¯æ¨¡å¼',
 1806          LANG_EN_US: 'FTP Client Mode',
 1807      },
 1808      'protocol_both': {
 1809          LANG_ZH_CN: 'æ··åˆæ¨¡å¼ (Server + Client)',
 1810          LANG_EN_US: 'Hybrid Mode (Server + Client)',
 1811      },
 1812      'protocol_desc_smb': {
 1813          LANG_ZH_CN: 'ğŸ“ SMB (ç½‘ç»œå…±äº«)ï¼šé€šè¿‡ Windows ç½‘ç»œå…±äº«ä¸Šä¼ æ–‡ä»¶åˆ°å…±äº«æ–‡ä»¶å¤¹',
 1814          LANG_EN_US: 'ğŸ“ SMB (Network Share): Upload files via Windows network share',
 1815      },
 1816      'protocol_desc_ftp_server': {
 1817          LANG_ZH_CN: 'ğŸ–¥ï¸ FTP æœåŠ¡å™¨æ¨¡å¼ï¼šæœ¬æœºä½œä¸º FTP æœåŠ¡å™¨ï¼Œå…¶ä»–è®¾å¤‡å¯è¿æ¥ä¸Šä¼ æ–‡ä»¶',
 1818          LANG_EN_US: 'ğŸ–¥ï¸ FTP Server Mode: This machine acts as FTP server, other devices can connect to upload',
 1819      },
 1820      'protocol_desc_ftp_client': {
 1821          LANG_ZH_CN: 'ğŸ“¤ FTP å®¢æˆ·ç«¯æ¨¡å¼ï¼šæœ¬æœºä½œä¸º FTP å®¢æˆ·ç«¯ï¼Œè¿æ¥åˆ°è¿œç¨‹ FTP æœåŠ¡å™¨ä¸Šä¼ æ–‡ä»¶',
 1822          LANG_EN_US: 'ğŸ“¤ FTP Client Mode: This machine acts as FTP client, connects to remote FTP server',
 1823      },
 1824      'protocol_desc_both': {
 1825          LANG_ZH_CN: 'ğŸ”„ æ··åˆæ¨¡å¼ï¼šåŒæ—¶è¿è¡Œ FTP æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ï¼Œçµæ´»åº”å¯¹ä¸åŒåœºæ™¯',
 1826          LANG_EN_US: 'ğŸ”„ Hybrid Mode: Run both FTP server and client for flexible scenarios',
 1827      },

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 38 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 1828      'interval_seconds': {
 1829          LANG_ZH_CN: 'é—´éš”æ—¶é—´(ç§’)',
 1830          LANG_EN_US: 'Interval (sec)',
 1831      },
 1832      'disk_threshold': {
 1833          LANG_ZH_CN: 'ç£ç›˜é˜ˆå€¼(%)',
 1834          LANG_EN_US: 'Disk Threshold (%)',
 1835      },
 1836      'retry_count': {
 1837          LANG_ZH_CN: 'å¤±è´¥é‡è¯•æ¬¡æ•°',
 1838          LANG_EN_US: 'Retry Count',
 1839      },
 1840      'disk_check_interval': {
 1841          LANG_ZH_CN: 'ç£ç›˜æ£€æŸ¥é—´éš”(ç§’)',
 1842          LANG_EN_US: 'Disk Check Interval (sec)',
 1843      },
 1844      
 1845      # ========== FTP é…ç½® ==========
 1846      'ftp_server_config': {
 1847          LANG_ZH_CN: 'ğŸ–¥ï¸ FTP æœåŠ¡å™¨é…ç½®',
 1848          LANG_EN_US: 'ğŸ–¥ï¸ FTP Server Config',
 1849      },
 1850      'ftp_client_config': {
 1851          LANG_ZH_CN: 'ğŸ’» FTP å®¢æˆ·ç«¯é…ç½®',
 1852          LANG_EN_US: 'ğŸ’» FTP Client Config',
 1853      },
 1854      'host_address': {
 1855          LANG_ZH_CN: 'ç›‘å¬åœ°å€:',
 1856          LANG_EN_US: 'Host Address:',
 1857      },
 1858      'port': {
 1859          LANG_ZH_CN: 'ç«¯å£:',
 1860          LANG_EN_US: 'Port:',
 1861      },
 1862      'username': {
 1863          LANG_ZH_CN: 'ç”¨æˆ·å:',
 1864          LANG_EN_US: 'Username:',
 1865      },
 1866      'password': {
 1867          LANG_ZH_CN: 'å¯†ç :',
 1868          LANG_EN_US: 'Password:',
 1869      },
 1870      'shared_folder': {
 1871          LANG_ZH_CN: 'å…±äº«ç›®å½•:',
 1872          LANG_EN_US: 'Shared Folder:',
 1873      },
 1874      'remote_path': {
 1875          LANG_ZH_CN: 'è¿œç¨‹è·¯å¾„:',
 1876          LANG_EN_US: 'Remote Path:',
 1877      },

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 39 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 1878      'timeout': {
 1879          LANG_ZH_CN: 'è¶…æ—¶æ—¶é—´:',
 1880          LANG_EN_US: 'Timeout:',
 1881      },
 1882      'enable_passive': {
 1883          LANG_ZH_CN: 'å¯ç”¨è¢«åŠ¨æ¨¡å¼',
 1884          LANG_EN_US: 'Enable Passive Mode',
 1885      },
 1886      'enable_tls': {
 1887          LANG_ZH_CN: 'å¯ç”¨ TLS/SSL (FTPS)',
 1888          LANG_EN_US: 'Enable TLS/SSL (FTPS)',
 1889      },
 1890      'test_config': {
 1891          LANG_ZH_CN: 'ğŸ§ª æµ‹è¯•é…ç½®',
 1892          LANG_EN_US: 'ğŸ§ª Test Config',
 1893      },
 1894      'test_connection': {
 1895          LANG_ZH_CN: 'ğŸ”Œ æµ‹è¯•è¿æ¥',
 1896          LANG_EN_US: 'ğŸ”Œ Test Connection',
 1897      },
 1898      
 1899      # ========== æ–‡ä»¶ç±»å‹é™åˆ¶ ==========
 1900      'file_type_filter': {
 1901          LANG_ZH_CN: 'ğŸ“‹ æ–‡ä»¶ç±»å‹é™åˆ¶',
 1902          LANG_EN_US: 'ğŸ“‹ File Type Filter',
 1903      },
 1904      
 1905      # ========== é«˜çº§é€‰é¡¹ ==========
 1906      'advanced_options': {
 1907          LANG_ZH_CN: 'âš¡ é«˜çº§é€‰é¡¹',
 1908          LANG_EN_US: 'âš¡ Advanced Options',
 1909      },
 1910      'auto_start_windows': {
 1911          LANG_ZH_CN: 'ğŸš€ å¼€æœºè‡ªå¯åŠ¨',
 1912          LANG_EN_US: 'ğŸš€ Start with Windows',
 1913      },
 1914      'auto_run_on_startup': {
 1915          LANG_ZH_CN: 'â–¶ å¯åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ',
 1916          LANG_EN_US: 'â–¶ Auto Run on Startup',
 1917      },
 1918      'show_notifications': {
 1919          LANG_ZH_CN: 'ğŸ”” æ˜¾ç¤ºæ‰˜ç›˜é€šçŸ¥',
 1920          LANG_EN_US: 'ğŸ”” Show Tray Notifications',
 1921      },
 1922      'limit_upload_rate': {
 1923          LANG_ZH_CN: 'âš¡ é™åˆ¶ä¸Šä¼ é€Ÿç‡',
 1924          LANG_EN_US: 'âš¡ Limit Upload Rate',
 1925      },
 1926      'enable_dedup': {
 1927          LANG_ZH_CN: 'ğŸ” å¯ç”¨æ–‡ä»¶å»é‡ (v1.8)',

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 40 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 1928          LANG_EN_US: 'ğŸ” Enable Deduplication (v1.8)',
 1929      },
 1930      'hash_algorithm': {
 1931          LANG_ZH_CN: 'å“ˆå¸Œç®—æ³•:',
 1932          LANG_EN_US: 'Hash Algorithm:',
 1933      },
 1934      'duplicate_strategy': {
 1935          LANG_ZH_CN: 'é‡å¤ç­–ç•¥:',
 1936          LANG_EN_US: 'Duplicate Strategy:',
 1937      },
 1938      'strategy_skip': {
 1939          LANG_ZH_CN: 'è·³è¿‡',
 1940          LANG_EN_US: 'Skip',
 1941      },
 1942      'strategy_rename': {
 1943          LANG_ZH_CN: 'é‡å‘½å',
 1944          LANG_EN_US: 'Rename',
 1945      },
 1946      'strategy_overwrite': {
 1947          LANG_ZH_CN: 'è¦†ç›–',
 1948          LANG_EN_US: 'Overwrite',
 1949      },
 1950      'strategy_ask': {
 1951          LANG_ZH_CN: 'è¯¢é—®',
 1952          LANG_EN_US: 'Ask',
 1953      },
 1954      'dedup_hint': {
 1955          LANG_ZH_CN: 'ğŸ’¡ é€šè¿‡æ–‡ä»¶å“ˆå¸Œæ£€æµ‹é‡å¤ï¼Œé¿å…ä¸Šä¼ ç›¸åŒå†…å®¹çš„æ–‡ä»¶',
 1956          LANG_EN_US: 'ğŸ’¡ Detect duplicates by file hash, avoid uploading identical files',
 1957      },
 1958      'network_monitor': {
 1959          LANG_ZH_CN: 'ğŸŒ ç½‘ç»œç›‘æ§',
 1960          LANG_EN_US: 'ğŸŒ Network Monitor',
 1961      },
 1962      'check_interval': {
 1963          LANG_ZH_CN: 'æ£€æµ‹é—´éš”:',
 1964          LANG_EN_US: 'Check Interval:',
 1965      },
 1966      'auto_pause_on_disconnect': {
 1967          LANG_ZH_CN: 'â¸ï¸ æ–­ç½‘æ—¶è‡ªåŠ¨æš‚åœ',
 1968          LANG_EN_US: 'â¸ï¸ Auto Pause on Disconnect',
 1969      },
 1970      'auto_resume_on_reconnect': {
 1971          LANG_ZH_CN: 'â–¶ï¸ æ¢å¤æ—¶è‡ªåŠ¨ç»§ç»­',
 1972          LANG_EN_US: 'â–¶ï¸ Auto Resume on Reconnect',
 1973      },
 1974      'network_hint': {
 1975          LANG_ZH_CN: 'ğŸ’¡ å®æ—¶ç›‘æ§ç½‘ç»œçŠ¶æ€ï¼Œæ–­ç½‘æ—¶è‡ªåŠ¨æš‚åœï¼Œæ¢å¤åè‡ªåŠ¨ç»§ç»­',
 1976          LANG_EN_US: 'ğŸ’¡ Monitor network status, auto pause on disconnect, resume on reconnect',
 1977      },

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 41 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 1978      
 1979      # ========== æ“ä½œæ§åˆ¶å¡ç‰‡ ==========
 1980      'card_control': {
 1981          LANG_ZH_CN: 'ğŸ® æ“ä½œæ§åˆ¶',
 1982          LANG_EN_US: 'ğŸ® Control Panel',
 1983      },
 1984      'start_upload': {
 1985          LANG_ZH_CN: 'â–¶ å¼€å§‹ä¸Šä¼ ',
 1986          LANG_EN_US: 'â–¶ Start Upload',
 1987      },
 1988      'pause_upload': {
 1989          LANG_ZH_CN: 'â¸ æš‚åœä¸Šä¼ ',
 1990          LANG_EN_US: 'â¸ Pause Upload',
 1991      },
 1992      'resume_upload': {
 1993          LANG_ZH_CN: 'â–¶ ç»§ç»­ä¸Šä¼ ',
 1994          LANG_EN_US: 'â–¶ Resume Upload',
 1995      },
 1996      'stop_upload': {
 1997          LANG_ZH_CN: 'â¹ åœæ­¢ä¸Šä¼ ',
 1998          LANG_EN_US: 'â¹ Stop Upload',
 1999      },
 2000      'save_config': {
 2001          LANG_ZH_CN: 'ğŸ’¾ ä¿å­˜é…ç½®',
 2002          LANG_EN_US: 'ğŸ’¾ Save Config',
 2003      },
 2004      'more': {
 2005          LANG_ZH_CN: 'æ›´å¤š â–¾',
 2006          LANG_EN_US: 'More â–¾',
 2007      },
 2008      'clear_logs': {
 2009          LANG_ZH_CN: 'ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—',
 2010          LANG_EN_US: 'ğŸ—‘ï¸ Clear Logs',
 2011      },
 2012      'disk_cleanup': {
 2013          LANG_ZH_CN: 'ğŸ’¿ ç£ç›˜æ¸…ç†',
 2014          LANG_EN_US: 'ğŸ’¿ Disk Cleanup',
 2015      },
 2016      'login': {
 2017          LANG_ZH_CN: 'ğŸ” æƒé™ç™»å½•',
 2018          LANG_EN_US: 'ğŸ” Login',
 2019      },
 2020      'change_password': {
 2021          LANG_ZH_CN: 'ğŸ”‘ ä¿®æ”¹å¯†ç ',
 2022          LANG_EN_US: 'ğŸ”‘ Change Password',
 2023      },
 2024      'logout': {
 2025          LANG_ZH_CN: 'ğŸšª é€€å‡ºç™»å½•',
 2026          LANG_EN_US: 'ğŸšª Logout',
 2027      },

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 42 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 2028      
 2029      # ========== è¿è¡ŒçŠ¶æ€å¡ç‰‡ ==========
 2030      'card_status': {
 2031          LANG_ZH_CN: 'ğŸ“Š è¿è¡ŒçŠ¶æ€',
 2032          LANG_EN_US: 'ğŸ“Š Status',
 2033      },
 2034      'status_stopped': {
 2035          LANG_ZH_CN: 'ğŸ”´ å·²åœæ­¢',
 2036          LANG_EN_US: 'ğŸ”´ Stopped',
 2037      },
 2038      'status_running': {
 2039          LANG_ZH_CN: 'ğŸŸ¢ è¿è¡Œä¸­',
 2040          LANG_EN_US: 'ğŸŸ¢ Running',
 2041      },
 2042      'status_paused': {
 2043          LANG_ZH_CN: 'ğŸŸ¡ å·²æš‚åœ',
 2044          LANG_EN_US: 'ğŸŸ¡ Paused',
 2045      },
 2046      'uploaded': {
 2047          LANG_ZH_CN: 'å·²ä¸Šä¼ ',
 2048          LANG_EN_US: 'Uploaded',
 2049      },
 2050      'failed': {
 2051          LANG_ZH_CN: 'å¤±è´¥',
 2052          LANG_EN_US: 'Failed',
 2053      },
 2054      'skipped': {
 2055          LANG_ZH_CN: 'è·³è¿‡',
 2056          LANG_EN_US: 'Skipped',
 2057      },
 2058      'rate': {
 2059          LANG_ZH_CN: 'é€Ÿç‡',
 2060          LANG_EN_US: 'Rate',
 2061      },
 2062      'archive_queue': {
 2063          LANG_ZH_CN: 'å½’æ¡£é˜Ÿåˆ—',
 2064          LANG_EN_US: 'Archive Queue',
 2065      },
 2066      'runtime': {
 2067          LANG_ZH_CN: 'è¿è¡Œæ—¶é—´',
 2068          LANG_EN_US: 'Runtime',
 2069      },
 2070      'target_disk': {
 2071          LANG_ZH_CN: 'ç›®æ ‡ç£ç›˜',
 2072          LANG_EN_US: 'Target Disk',
 2073      },
 2074      'backup_disk': {
 2075          LANG_ZH_CN: 'å½’æ¡£ç£ç›˜',
 2076          LANG_EN_US: 'Backup Disk',
 2077      },

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 43 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 2078      'network_status': {
 2079          LANG_ZH_CN: 'ç½‘ç»œçŠ¶æ€',
 2080          LANG_EN_US: 'Network',
 2081      },
 2082      'network_good': {
 2083          LANG_ZH_CN: 'æ­£å¸¸',
 2084          LANG_EN_US: 'Good',
 2085      },
 2086      'network_unstable': {
 2087          LANG_ZH_CN: 'ä¸ç¨³å®š',
 2088          LANG_EN_US: 'Unstable',
 2089      },
 2090      'network_disconnected': {
 2091          LANG_ZH_CN: 'å·²æ–­å¼€',
 2092          LANG_EN_US: 'Disconnected',
 2093      },
 2094      'network_unknown': {
 2095          LANG_ZH_CN: 'æœªçŸ¥',
 2096          LANG_EN_US: 'Unknown',
 2097      },
 2098      'current_file': {
 2099          LANG_ZH_CN: 'ğŸ“„ å½“å‰æ–‡ä»¶',
 2100          LANG_EN_US: 'ğŸ“„ Current File',
 2101      },
 2102      'waiting': {
 2103          LANG_ZH_CN: 'ç­‰å¾…å¼€å§‹...',
 2104          LANG_EN_US: 'Waiting...',
 2105      },
 2106      'progress': {
 2107          LANG_ZH_CN: 'æ€»ä½“è¿›åº¦',
 2108          LANG_EN_US: 'Overall Progress',
 2109      },
 2110      
 2111      # ========== æ—¥å¿—å¡ç‰‡ ==========
 2112      'card_log': {
 2113          LANG_ZH_CN: 'ğŸ“œ è¿è¡Œæ—¥å¿—',
 2114          LANG_EN_US: 'ğŸ“œ Log',
 2115      },
 2116      'autoscroll': {
 2117          LANG_ZH_CN: ' è‡ªåŠ¨æ»šåŠ¨',
 2118          LANG_EN_US: ' Auto Scroll',
 2119      },
 2120      
 2121      # ========== è§’è‰²å’Œæƒé™ ==========
 2122      'role_guest': {
 2123          LANG_ZH_CN: 'ğŸ”’ æœªç™»å½•',
 2124          LANG_EN_US: 'ğŸ”’ Guest',
 2125      },
 2126      'role_user': {
 2127          LANG_ZH_CN: 'ğŸ‘¤ ç”¨æˆ·',

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 44 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 2128          LANG_EN_US: 'ğŸ‘¤ User',
 2129      },
 2130      'role_admin': {
 2131          LANG_ZH_CN: 'ğŸ‘‘ ç®¡ç†å‘˜',
 2132          LANG_EN_US: 'ğŸ‘‘ Admin',
 2133      },
 2134      
 2135      # ========== å¯¹è¯æ¡† ==========
 2136      'dialog_login': {
 2137          LANG_ZH_CN: 'ğŸ” æƒé™ç™»å½•',
 2138          LANG_EN_US: 'ğŸ” Login',
 2139      },
 2140      'dialog_change_password': {
 2141          LANG_ZH_CN: 'ğŸ”‘ ä¿®æ”¹å¯†ç ',
 2142          LANG_EN_US: 'ğŸ”‘ Change Password',
 2143      },
 2144      'dialog_disk_cleanup': {
 2145          LANG_ZH_CN: 'ğŸ’¿ ç£ç›˜æ¸…ç†å·¥å…·',
 2146          LANG_EN_US: 'ğŸ’¿ Disk Cleanup Tool',
 2147      },
 2148      'login_role': {
 2149          LANG_ZH_CN: 'ç™»å½•è§’è‰²:',
 2150          LANG_EN_US: 'Role:',
 2151      },
 2152      'enter_password': {
 2153          LANG_ZH_CN: 'è¯·è¾“å…¥å¯†ç ',
 2154          LANG_EN_US: 'Enter password',
 2155      },
 2156      'cancel': {
 2157          LANG_ZH_CN: 'å–æ¶ˆ',
 2158          LANG_EN_US: 'Cancel',
 2159      },
 2160      'confirm': {
 2161          LANG_ZH_CN: 'ç¡®è®¤',
 2162          LANG_EN_US: 'Confirm',
 2163      },
 2164      'ok': {
 2165          LANG_ZH_CN: 'ç¡®å®š',
 2166          LANG_EN_US: 'OK',
 2167      },
 2168      
 2169      # ========== æç¤ºæ¶ˆæ¯ ==========
 2170      'msg_login_success': {
 2171          LANG_ZH_CN: 'ç™»å½•æˆåŠŸï¼',
 2172          LANG_EN_US: 'Login successful!',
 2173      },
 2174      'msg_login_failed': {
 2175          LANG_ZH_CN: 'å¯†ç é”™è¯¯',
 2176          LANG_EN_US: 'Wrong password',
 2177      },

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 45 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 2178      'msg_logout': {
 2179          LANG_ZH_CN: 'å·²é€€å‡ºç™»å½•',
 2180          LANG_EN_US: 'Logged out',
 2181      },
 2182      'msg_config_saved': {
 2183          LANG_ZH_CN: 'é…ç½®å·²ä¿å­˜',
 2184          LANG_EN_US: 'Config saved',
 2185      },
 2186      'msg_logs_cleared': {
 2187          LANG_ZH_CN: 'å·²æ¸…ç©ºæ—¥å¿—',
 2188          LANG_EN_US: 'Logs cleared',
 2189      },
 2190      'msg_upload_started': {
 2191          LANG_ZH_CN: 'ä¸Šä¼ å·²å¼€å§‹',
 2192          LANG_EN_US: 'Upload started',
 2193      },
 2194      'msg_upload_stopped': {
 2195          LANG_ZH_CN: 'ä¸Šä¼ å·²åœæ­¢',
 2196          LANG_EN_US: 'Upload stopped',
 2197      },
 2198      'msg_upload_paused': {
 2199          LANG_ZH_CN: 'ä¸Šä¼ å·²æš‚åœ',
 2200          LANG_EN_US: 'Upload paused',
 2201      },
 2202      'msg_upload_resumed': {
 2203          LANG_ZH_CN: 'ä¸Šä¼ å·²æ¢å¤',
 2204          LANG_EN_US: 'Upload resumed',
 2205      },
 2206      'msg_language_changed': {
 2207          LANG_ZH_CN: 'è¯­è¨€å·²åˆ‡æ¢',
 2208          LANG_EN_US: 'Language changed',
 2209      },
 2210      'msg_need_login': {
 2211          LANG_ZH_CN: 'è¯·å…ˆç™»å½•',
 2212          LANG_EN_US: 'Please login first',
 2213      },
 2214      'msg_no_permission': {
 2215          LANG_ZH_CN: 'æƒé™ä¸è¶³',
 2216          LANG_EN_US: 'Permission denied',
 2217      },
 2218      
 2219      # ========== æ–­ç‚¹ç»­ä¼ ç›¸å…³ ==========
 2220      'resume_upload': {
 2221          LANG_ZH_CN: 'æ–­ç‚¹ç»­ä¼ ',
 2222          LANG_EN_US: 'Resume Upload',
 2223      },
 2224      'resume_found': {
 2225          LANG_ZH_CN: 'å‘ç°æœªå®Œæˆçš„ä¸Šä¼ ä»»åŠ¡',
 2226          LANG_EN_US: 'Found incomplete upload',
 2227      },

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 46 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 2228      'resume_continue': {
 2229          LANG_ZH_CN: 'ç»§ç»­ä¸Šä¼ ',
 2230          LANG_EN_US: 'Continue',
 2231      },
 2232      'resume_restart': {
 2233          LANG_ZH_CN: 'é‡æ–°å¼€å§‹',
 2234          LANG_EN_US: 'Restart',
 2235      },
 2236      'resume_progress': {
 2237          LANG_ZH_CN: 'ç»­ä¼ è¿›åº¦',
 2238          LANG_EN_US: 'Resume Progress',
 2239      },
 2240      
 2241      # ========== ç³»ç»Ÿæ‰˜ç›˜ ==========
 2242      'tray_show': {
 2243          LANG_ZH_CN: 'æ˜¾ç¤ºä¸»çª—å£',
 2244          LANG_EN_US: 'Show Window',
 2245      },
 2246      'tray_hide': {
 2247          LANG_ZH_CN: 'éšè—åˆ°æ‰˜ç›˜',
 2248          LANG_EN_US: 'Hide to Tray',
 2249      },
 2250      'tray_exit': {
 2251          LANG_ZH_CN: 'é€€å‡ºç¨‹åº',
 2252          LANG_EN_US: 'Exit',
 2253      },
 2254      
 2255      # ========== ç§’/åˆ†é’Ÿ/å°æ—¶ ==========
 2256      'seconds': {
 2257          LANG_ZH_CN: 'ç§’',
 2258          LANG_EN_US: 'sec',
 2259      },
 2260      'minutes': {
 2261          LANG_ZH_CN: 'åˆ†é’Ÿ',
 2262          LANG_EN_US: 'min',
 2263      },
 2264      'hours': {
 2265          LANG_ZH_CN: 'å°æ—¶',
 2266          LANG_EN_US: 'hr',
 2267      },
 2268      'days': {
 2269          LANG_ZH_CN: 'å¤©',
 2270          LANG_EN_US: 'days',
 2271      },
 2272      
 2273      # ========== è·¯å¾„è¡Œæ ‡ç­¾ ==========
 2274      'source_folder_label': {
 2275          LANG_ZH_CN: 'æºæ–‡ä»¶å¤¹',
 2276          LANG_EN_US: 'Source Folder',
 2277      },

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 47 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 2278      'target_folder_label': {
 2279          LANG_ZH_CN: 'ç›®æ ‡æ–‡ä»¶å¤¹',
 2280          LANG_EN_US: 'Target Folder',
 2281      },
 2282      'backup_folder_label': {
 2283          LANG_ZH_CN: 'å¤‡ä»½æ–‡ä»¶å¤¹',
 2284          LANG_EN_US: 'Backup Folder',
 2285      },
 2286      
 2287      # ========== åè®®ç›¸å…³ ==========
 2288      'upload_protocol_title': {
 2289          LANG_ZH_CN: 'ğŸ“¡ ä¸Šä¼ åè®® (v2.0)',
 2290          LANG_EN_US: 'ğŸ“¡ Upload Protocol (v2.0)',
 2291      },
 2292      'protocol_type_label': {
 2293          LANG_ZH_CN: 'åè®®ç±»å‹:',
 2294          LANG_EN_US: 'Protocol:',
 2295      },
 2296      'max_connections': {
 2297          LANG_ZH_CN: 'æœ€å¤§è¿æ¥:',
 2298          LANG_EN_US: 'Max Conn:',
 2299      },
 2300      'ip_limit': {
 2301          LANG_ZH_CN: '  å•IPé™åˆ¶:',
 2302          LANG_EN_US: '  IP Limit:',
 2303      },
 2304      'retry_count_label': {
 2305          LANG_ZH_CN: 'é‡è¯•æ¬¡æ•°:',
 2306          LANG_EN_US: 'Retries:',
 2307      },
 2308      
 2309      # ========== è®¾ç½®è¡Œ ==========
 2310      'interval_label': {
 2311          LANG_ZH_CN: 'é—´éš”æ—¶é—´(ç§’)',
 2312          LANG_EN_US: 'Interval (sec)',
 2313      },
 2314      'disk_threshold_label': {
 2315          LANG_ZH_CN: 'ç£ç›˜é˜ˆå€¼(%)',
 2316          LANG_EN_US: 'Disk Threshold (%)',
 2317      },
 2318      'retry_label': {
 2319          LANG_ZH_CN: 'å¤±è´¥é‡è¯•æ¬¡æ•°',
 2320          LANG_EN_US: 'Retry Count',
 2321      },
 2322      'disk_check_label': {
 2323          LANG_ZH_CN: 'ç£ç›˜æ£€æŸ¥é—´éš”(ç§’)',
 2324          LANG_EN_US: 'Disk Check (sec)',
 2325      },
 2326      'disk_check_interval_label': {
 2327          LANG_ZH_CN: 'ç£ç›˜æ£€æŸ¥é—´éš”(ç§’)',

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 48 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 2328          LANG_EN_US: 'Disk Check (sec)',
 2329      },
 2330      'check_interval_label': {
 2331          LANG_ZH_CN: 'æ£€æµ‹é—´éš”:',
 2332          LANG_EN_US: 'Check Interval:',
 2333      },
 2334      
 2335      # ========== æ ‡é¢˜æ  ==========
 2336      'header_title': {
 2337          LANG_ZH_CN: 'å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·',
 2338          LANG_EN_US: 'Image Upload Tool',
 2339      },
 2340      
 2341      # ========== å½“å‰æ–‡ä»¶ ==========
 2342      'current_file_label': {
 2343          LANG_ZH_CN: 'ğŸ“„ å½“å‰æ–‡ä»¶',
 2344          LANG_EN_US: 'ğŸ“„ Current File',
 2345      },
 2346      
 2347      # ========== ä¸Šä¼ åè®®é€‰é¡¹ ==========
 2348      'protocol_option_smb': {
 2349          LANG_ZH_CN: 'SMB (ç½‘ç»œå…±äº«)',
 2350          LANG_EN_US: 'SMB (Network Share)',
 2351      },
 2352      'protocol_option_ftp_server': {
 2353          LANG_ZH_CN: 'FTP æœåŠ¡å™¨æ¨¡å¼',
 2354          LANG_EN_US: 'FTP Server Mode',
 2355      },
 2356      'protocol_option_ftp_client': {
 2357          LANG_ZH_CN: 'FTP å®¢æˆ·ç«¯æ¨¡å¼',
 2358          LANG_EN_US: 'FTP Client Mode',
 2359      },
 2360      'protocol_option_both': {
 2361          LANG_ZH_CN: 'æ··åˆæ¨¡å¼ (Server + Client)',
 2362          LANG_EN_US: 'Hybrid Mode (Server + Client)',
 2363      },
 2364      
 2365      # ========== FTP è¡¨å•æ ‡ç­¾ ==========
 2366      'listen_address': {
 2367          LANG_ZH_CN: 'ç›‘å¬åœ°å€:',
 2368          LANG_EN_US: 'Listen Address:',
 2369      },
 2370      'port_label': {
 2371          LANG_ZH_CN: 'ç«¯å£:',
 2372          LANG_EN_US: 'Port:',
 2373      },
 2374      'username_label': {
 2375          LANG_ZH_CN: 'ç”¨æˆ·å:',
 2376          LANG_EN_US: 'Username:',
 2377      },

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 49 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 2378      'password_label': {
 2379          LANG_ZH_CN: 'å¯†ç :',
 2380          LANG_EN_US: 'Password:',
 2381      },
 2382      'shared_dir': {
 2383          LANG_ZH_CN: 'å…±äº«ç›®å½•:',
 2384          LANG_EN_US: 'Shared Dir:',
 2385      },
 2386      'server_address': {
 2387          LANG_ZH_CN: 'æœåŠ¡å™¨åœ°å€:',
 2388          LANG_EN_US: 'Server Address:',
 2389      },
 2390      'remote_path_label': {
 2391          LANG_ZH_CN: 'è¿œç¨‹è·¯å¾„:',
 2392          LANG_EN_US: 'Remote Path:',
 2393      },
 2394      'timeout_label': {
 2395          LANG_ZH_CN: 'è¶…æ—¶(ç§’):',
 2396          LANG_EN_US: 'Timeout(s):',
 2397      },
 2398      
 2399      # ========== ç™»å½•å¯¹è¯æ¡† ==========
 2400      'login_role_label': {
 2401          LANG_ZH_CN: 'ç™»å½•è§’è‰²:',
 2402          LANG_EN_US: 'Role:',
 2403      },
 2404      'role_user_option': {
 2405          LANG_ZH_CN: 'ğŸ‘¤ ç”¨æˆ·',
 2406          LANG_EN_US: 'ğŸ‘¤ User',
 2407      },
 2408      'role_admin_option': {
 2409          LANG_ZH_CN: 'ğŸ‘‘ ç®¡ç†å‘˜',
 2410          LANG_EN_US: 'ğŸ‘‘ Admin',
 2411      },
 2412      'enter_password': {
 2413          LANG_ZH_CN: 'è¯·è¾“å…¥å¯†ç ',
 2414          LANG_EN_US: 'Enter password',
 2415      },
 2416      'cancel': {
 2417          LANG_ZH_CN: 'å–æ¶ˆ',
 2418          LANG_EN_US: 'Cancel',
 2419      },
 2420      'ok': {
 2421          LANG_ZH_CN: 'ç¡®å®š',
 2422          LANG_EN_US: 'OK',
 2423      },
 2424      'please_enter_password': {
 2425          LANG_ZH_CN: 'è¯·è¾“å…¥å¯†ç ',
 2426          LANG_EN_US: 'Please enter password',
 2427      },

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 50 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 2428      'wrong_password': {
 2429          LANG_ZH_CN: 'å¯†ç é”™è¯¯',
 2430          LANG_EN_US: 'Wrong password',
 2431      },
 2432      'user_login_success': {
 2433          LANG_ZH_CN: 'ğŸ‘¤ ç”¨æˆ·ç™»å½•æˆåŠŸï¼',
 2434          LANG_EN_US: 'ğŸ‘¤ User logged in!',
 2435      },
 2436      'admin_login_success': {
 2437          LANG_ZH_CN: 'ğŸ‘‘ ç®¡ç†å‘˜ç™»å½•æˆåŠŸï¼',
 2438          LANG_EN_US: 'ğŸ‘‘ Admin logged in!',
 2439      },
 2440      'logged_out': {
 2441          LANG_ZH_CN: 'å·²é€€å‡ºç™»å½•',
 2442          LANG_EN_US: 'Logged out',
 2443      },
 2444      
 2445      # ========== ä¿®æ”¹å¯†ç å¯¹è¯æ¡† ==========
 2446      'change_target': {
 2447          LANG_ZH_CN: 'ä¿®æ”¹å¯¹è±¡:',
 2448          LANG_EN_US: 'Target:',
 2449      },
 2450      'old_password': {
 2451          LANG_ZH_CN: 'åŸå¯†ç :',
 2452          LANG_EN_US: 'Old Password:',
 2453      },
 2454      'new_password': {
 2455          LANG_ZH_CN: 'æ–°å¯†ç :',
 2456          LANG_EN_US: 'New Password:',
 2457      },
 2458      'confirm_password': {
 2459          LANG_ZH_CN: 'ç¡®è®¤å¯†ç :',
 2460          LANG_EN_US: 'Confirm:',
 2461      },
 2462      
 2463      # ========== èŠ¯ç‰‡é¢å¤–æ ‡ç­¾ ==========
 2464      'protocol_chip': {
 2465          LANG_ZH_CN: 'ä¸Šä¼ åè®®',
 2466          LANG_EN_US: 'Protocol',
 2467      },
 2468      'ftp_server_chip': {
 2469          LANG_ZH_CN: 'FTPæœåŠ¡å™¨',
 2470          LANG_EN_US: 'FTP Server',
 2471      },
 2472      'ftp_client_chip': {
 2473          LANG_ZH_CN: 'FTPå®¢æˆ·ç«¯',
 2474          LANG_EN_US: 'FTP Client',
 2475      },
 2476      'not_started': {
 2477          LANG_ZH_CN: 'æœªå¯åŠ¨',

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 51 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 2478          LANG_EN_US: 'Not Started',
 2479      },
 2480      'not_connected': {
 2481          LANG_ZH_CN: 'æœªè¿æ¥',
 2482          LANG_EN_US: 'Not Connected',
 2483      },
 2484      
 2485      # ========== å¯æŠ˜å åŒºå—æ ‡é¢˜ ==========
 2486      'file_filter_title': {
 2487          LANG_ZH_CN: 'ğŸ“‹ æ–‡ä»¶ç±»å‹é™åˆ¶',
 2488          LANG_EN_US: 'ğŸ“‹ File Type Filter',
 2489      },
 2490      'advanced_options_title': {
 2491          LANG_ZH_CN: 'âš¡ é«˜çº§é€‰é¡¹',
 2492          LANG_EN_US: 'âš¡ Advanced Options',
 2493      },
 2494      
 2495      # ========== å·¥å…·æç¤º ==========
 2496      'limit_rate_tooltip': {
 2497          LANG_ZH_CN: 'å¯ç”¨åå°†é™åˆ¶æœ€å¤§ä¸Šä¼ é€Ÿåº¦ï¼Œé¿å…å ç”¨è¿‡å¤šå¸¦å®½',
 2498          LANG_EN_US: 'Limit max upload speed to avoid bandwidth hogging',
 2499      },
 2500      'max_rate_tooltip': {
 2501          LANG_ZH_CN: 'è®¾ç½®æœ€å¤§ä¸Šä¼ é€Ÿç‡ï¼ˆå•ä½ï¼šMB/ç§’ï¼‰',
 2502          LANG_EN_US: 'Set max upload rate (MB/s)',
 2503      },
 2504      
 2505      # ========== å»é‡ç›¸å…³ ==========
 2506      'hash_algorithm': {
 2507          LANG_ZH_CN: 'å“ˆå¸Œç®—æ³•',
 2508          LANG_EN_US: 'Hash Algorithm',
 2509      },
 2510      'duplicate_strategy': {
 2511          LANG_ZH_CN: 'é‡å¤ç­–ç•¥',
 2512          LANG_EN_US: 'Duplicate Strategy',
 2513      },
 2514      'strategy_skip': {
 2515          LANG_ZH_CN: 'è·³è¿‡',
 2516          LANG_EN_US: 'Skip',
 2517      },
 2518      'strategy_rename': {
 2519          LANG_ZH_CN: 'é‡å‘½å',
 2520          LANG_EN_US: 'Rename',
 2521      },
 2522      'strategy_overwrite': {
 2523          LANG_ZH_CN: 'è¦†ç›–',
 2524          LANG_EN_US: 'Overwrite',
 2525      },
 2526      'strategy_ask': {
 2527          LANG_ZH_CN: 'è¯¢é—®',

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 52 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 2528          LANG_EN_US: 'Ask',
 2529      },
 2530      'dedup_hint': {
 2531          LANG_ZH_CN: 'ğŸ’¡ é€šè¿‡æ–‡ä»¶å“ˆå¸Œæ£€æµ‹é‡å¤ï¼Œé¿å…ä¸Šä¼ ç›¸åŒå†…å®¹çš„æ–‡ä»¶',
 2532          LANG_EN_US: 'ğŸ’¡ Detect duplicates via file hash to avoid uploading identical files',
 2533      },
 2534      
 2535      # ========== ç½‘ç»œç›‘æ§ ==========
 2536      'network_monitor': {
 2537          LANG_ZH_CN: 'ğŸŒ ç½‘ç»œç›‘æ§',
 2538          LANG_EN_US: 'ğŸŒ Network Monitor',
 2539      },
 2540      'seconds': {
 2541          LANG_ZH_CN: 'ç§’',
 2542          LANG_EN_US: 's',
 2543      },
 2544      'network_hint': {
 2545          LANG_ZH_CN: 'ğŸ’¡ å®æ—¶ç›‘æ§ç½‘ç»œçŠ¶æ€ï¼Œæ–­ç½‘æ—¶è‡ªåŠ¨æš‚åœï¼Œæ¢å¤åè‡ªåŠ¨ç»§ç»­',
 2546          LANG_EN_US: 'ğŸ’¡ Monitor network status and auto-pause/resume on disconnect/reconnect',
 2547      },
 2548      
 2549      # ========== FTP é…ç½®æ ‡ç­¾ ==========
 2550      'listen_address': {
 2551          LANG_ZH_CN: 'ç›‘å¬åœ°å€:',
 2552          LANG_EN_US: 'Listen Addr:',
 2553      },
 2554      'listen_address_tooltip': {
 2555          LANG_ZH_CN: '0.0.0.0 è¡¨ç¤ºç›‘å¬æ‰€æœ‰ç½‘å¡ï¼Œ127.0.0.1 ä»…æœ¬æœºå¯è®¿é—®',
 2556          LANG_EN_US: '0.0.0.0 listens on all interfaces, 127.0.0.1 for localhost only',
 2557      },
 2558      'port_label': {
 2559          LANG_ZH_CN: 'ç«¯å£:',
 2560          LANG_EN_US: 'Port:',
 2561      },
 2562      'port_tooltip': {
 2563          LANG_ZH_CN: 'é»˜è®¤FTPç«¯å£ä¸º21ï¼Œå»ºè®®ä½¿ç”¨2121é¿å…æƒé™é—®é¢˜',
 2564          LANG_EN_US: 'Default FTP port is 21, use 2121 to avoid permission issues',
 2565      },
 2566      'username_label': {
 2567          LANG_ZH_CN: 'ç”¨æˆ·å:',
 2568          LANG_EN_US: 'Username:',
 2569      },
 2570      'username_tooltip': {
 2571          LANG_ZH_CN: 'FTPç™»å½•ç”¨æˆ·å',
 2572          LANG_EN_US: 'FTP login username',
 2573      },
 2574      'password_label': {
 2575          LANG_ZH_CN: 'å¯†ç :',
 2576          LANG_EN_US: 'Password:',
 2577      },

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 53 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 2578      'password_tooltip': {
 2579          LANG_ZH_CN: 'FTPç™»å½•å¯†ç ï¼Œå»ºè®®ä½¿ç”¨å¼ºå¯†ç ',
 2580          LANG_EN_US: 'FTP login password, use a strong password',
 2581      },
 2582      'share_directory': {
 2583          LANG_ZH_CN: 'å…±äº«ç›®å½•:',
 2584          LANG_EN_US: 'Share Dir:',
 2585      },
 2586      'select_ftp_share': {
 2587          LANG_ZH_CN: 'é€‰æ‹©FTPå…±äº«ç›®å½•',
 2588          LANG_EN_US: 'Select FTP share directory',
 2589      },
 2590      'share_dir_tooltip': {
 2591          LANG_ZH_CN: 'FTPæœåŠ¡å™¨çš„æ ¹ç›®å½•ï¼Œå®¢æˆ·ç«¯è¿æ¥åå¯è®¿é—®æ­¤ç›®å½•',
 2592          LANG_EN_US: 'FTP server root directory accessible by clients',
 2593      },
 2594      'passive_mode_tooltip': {
 2595          LANG_ZH_CN: 'è¢«åŠ¨æ¨¡å¼é€‚ç”¨äºNAT/é˜²ç«å¢™ç¯å¢ƒï¼Œå»ºè®®å¯ç”¨',
 2596          LANG_EN_US: 'Passive mode works better with NAT/firewalls, recommended',
 2597      },
 2598      'port_start': {
 2599          LANG_ZH_CN: 'èµ·å§‹:',
 2600          LANG_EN_US: 'Start:',
 2601      },
 2602      'port_end': {
 2603          LANG_ZH_CN: 'ç»“æŸ:',
 2604          LANG_EN_US: 'End:',
 2605      },
 2606      'port_range': {
 2607          LANG_ZH_CN: 'ç«¯å£èŒƒå›´:',
 2608          LANG_EN_US: 'Port Range:',
 2609      },
 2610      'enable_tls_tooltip': {
 2611          LANG_ZH_CN: 'å¯ç”¨åŠ å¯†è¿æ¥ï¼Œéœ€è¦è¯ä¹¦æ–‡ä»¶',
 2612          LANG_EN_US: 'Enable encrypted connection, requires certificate files',
 2613      },
 2614      'max_connections': {
 2615          LANG_ZH_CN: 'æœ€å¤§è¿æ¥:',
 2616          LANG_EN_US: 'Max Conn:',
 2617      },
 2618      'per_ip_limit': {
 2619          LANG_ZH_CN: 'å•IPé™åˆ¶:',
 2620          LANG_EN_US: 'Per IP Limit:',
 2621      },
 2622      'unit_connections': {
 2623          LANG_ZH_CN: 'ä¸ª',
 2624          LANG_EN_US: '',
 2625      },
 2626      'connection_limit': {
 2627          LANG_ZH_CN: 'è¿æ¥é™åˆ¶:',

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 54 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 2628          LANG_EN_US: 'Conn Limit:',
 2629      },
 2630      
 2631      # ========== FTP å®¢æˆ·ç«¯æ ‡ç­¾ ==========
 2632      'remote_path': {
 2633          LANG_ZH_CN: 'è¿œç¨‹è·¯å¾„:',
 2634          LANG_EN_US: 'Remote Path:',
 2635      },
 2636      'remote_path_tooltip': {
 2637          LANG_ZH_CN: 'ä¸Šä¼ åˆ°è¿œç¨‹FTPæœåŠ¡å™¨çš„ç›®æ ‡è·¯å¾„',
 2638          LANG_EN_US: 'Target path on remote FTP server',
 2639      },
 2640      'server_label': {
 2641          LANG_ZH_CN: 'æœåŠ¡å™¨:',
 2642          LANG_EN_US: 'Server:',
 2643      },
 2644      'server_address_tooltip': {
 2645          LANG_ZH_CN: 'FTPæœåŠ¡å™¨åœ°å€ï¼Œå¯ä»¥æ˜¯åŸŸåæˆ–IPåœ°å€',
 2646          LANG_EN_US: 'FTP server address, can be domain or IP',
 2647      },
 2648      'client_port_tooltip': {
 2649          LANG_ZH_CN: 'FTPæœåŠ¡å™¨ç«¯å£ï¼Œæ ‡å‡†ç«¯å£ä¸º21',
 2650          LANG_EN_US: 'FTP server port, standard is 21',
 2651      },
 2652      'username_placeholder': {
 2653          LANG_ZH_CN: 'ç”¨æˆ·å',
 2654          LANG_EN_US: 'Username',
 2655      },
 2656      'password_placeholder': {
 2657          LANG_ZH_CN: 'å¯†ç ',
 2658          LANG_EN_US: 'Password',
 2659      },
 2660      'client_username_tooltip': {
 2661          LANG_ZH_CN: 'FTPæœåŠ¡å™¨ç™»å½•ç”¨æˆ·å',
 2662          LANG_EN_US: 'FTP server login username',
 2663      },
 2664      'client_password_tooltip': {
 2665          LANG_ZH_CN: 'FTPæœåŠ¡å™¨ç™»å½•å¯†ç ',
 2666          LANG_EN_US: 'FTP server login password',
 2667      },
 2668      'timeout_label': {
 2669          LANG_ZH_CN: 'è¶…æ—¶æ—¶é—´:',
 2670          LANG_EN_US: 'Timeout:',
 2671      },
 2672      'timeout_tooltip': {
 2673          LANG_ZH_CN: 'è¿æ¥å’Œä¼ è¾“è¶…æ—¶æ—¶é—´ï¼Œç½‘ç»œæ…¢æ—¶å¯é€‚å½“å¢åŠ ',
 2674          LANG_EN_US: 'Connection and transfer timeout, increase for slow networks',
 2675      },
 2676      'ftp_retry_label': {
 2677          LANG_ZH_CN: 'é‡è¯•æ¬¡æ•°:',

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 55 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 2678          LANG_EN_US: 'Retry Count:',
 2679      },
 2680      'unit_times': {
 2681          LANG_ZH_CN: 'æ¬¡',
 2682          LANG_EN_US: '',
 2683      },
 2684      'retry_tooltip': {
 2685          LANG_ZH_CN: 'è¿æ¥å¤±è´¥æ—¶çš„é‡è¯•æ¬¡æ•°ï¼Œ0è¡¨ç¤ºä¸é‡è¯•',
 2686          LANG_EN_US: 'Retry count on failure, 0 for no retry',
 2687      },
 2688      'use_passive_mode': {
 2689          LANG_ZH_CN: 'ä½¿ç”¨è¢«åŠ¨æ¨¡å¼',
 2690          LANG_EN_US: 'Use Passive Mode',
 2691      },
 2692      'client_tls_tooltip': {
 2693          LANG_ZH_CN: 'è¿æ¥åˆ°FTPSæœåŠ¡å™¨æ—¶å¯ç”¨',
 2694          LANG_EN_US: 'Enable when connecting to FTPS server',
 2695      },
 2696  }
 2697  
 2698  
 2699  class I18n:
 2700      """å›½é™…åŒ–ç®¡ç†å™¨
 2701      
 2702      æ”¯æŒä¸­è‹±æ–‡åˆ‡æ¢ï¼ŒåŠ¨æ€æ›´æ–° UI æ–‡æœ¬
 2703      """
 2704      
 2705      _instance: Optional['I18n'] = None
 2706      _current_lang: str = LANG_ZH_CN
 2707      _listeners: List[Callable[[], None]] = []
 2708      
 2709      def __new__(cls):
 2710          """å•ä¾‹æ¨¡å¼"""
 2711          if cls._instance is None:
 2712              cls._instance = super().__new__(cls)
 2713          return cls._instance
 2714      
 2715      def __init__(self):
 2716          pass
 2717      
 2718      @classmethod
 2719      def get_instance(cls) -> 'I18n':
 2720          """è·å–å•ä¾‹å®ä¾‹"""
 2721          if cls._instance is None:
 2722              cls._instance = cls()
 2723          return cls._instance
 2724      
 2725      @classmethod
 2726      def get_current_language(cls) -> str:
 2727          """è·å–å½“å‰è¯­è¨€"""

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 56 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 2728          return cls._current_lang
 2729      
 2730      @classmethod
 2731      def set_language(cls, lang: str) -> bool:
 2732          """è®¾ç½®å½“å‰è¯­è¨€
 2733          
 2734          Args:
 2735              lang: è¯­è¨€ä»£ç  (zh_CN æˆ– en_US)
 2736              
 2737          Returns:
 2738              æ˜¯å¦è®¾ç½®æˆåŠŸ
 2739          """
 2740          if lang not in [LANG_ZH_CN, LANG_EN_US]:
 2741              logger.warning(f"ä¸æ”¯æŒçš„è¯­è¨€: {lang}")
 2742              return False
 2743          
 2744          if lang == cls._current_lang:
 2745              return True
 2746          
 2747          cls._current_lang = lang
 2748          logger.info(f"è¯­è¨€å·²åˆ‡æ¢: {lang}")
 2749          
 2750          # é€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨
 2751          for listener in cls._listeners:
 2752              try:
 2753                  listener()
 2754              except Exception as e:
 2755                  logger.warning(f"è¯­è¨€åˆ‡æ¢ç›‘å¬å™¨æ‰§è¡Œå¤±è´¥: {e}")
 2756          
 2757          return True
 2758      
 2759      @classmethod
 2760      def add_listener(cls, callback: Callable[[], None]):
 2761          """æ·»åŠ è¯­è¨€åˆ‡æ¢ç›‘å¬å™¨
 2762          
 2763          Args:
 2764              callback: è¯­è¨€åˆ‡æ¢æ—¶çš„å›è°ƒå‡½æ•°
 2765          """
 2766          if callback not in cls._listeners:
 2767              cls._listeners.append(callback)
 2768      
 2769      @classmethod
 2770      def remove_listener(cls, callback: Callable[[], None]):
 2771          """ç§»é™¤è¯­è¨€åˆ‡æ¢ç›‘å¬å™¨"""
 2772          if callback in cls._listeners:
 2773              cls._listeners.remove(callback)
 2774      
 2775      @classmethod
 2776      def t(cls, key: str, default: str = '') -> str:
 2777          """ç¿»è¯‘æ–‡æœ¬

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 57 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 2778          
 2779          Args:
 2780              key: ç¿»è¯‘é”®
 2781              default: é»˜è®¤å€¼ï¼ˆå¦‚æœæ‰¾ä¸åˆ°ç¿»è¯‘ï¼‰
 2782              
 2783          Returns:
 2784              ç¿»è¯‘åçš„æ–‡æœ¬
 2785          """
 2786          translation = TRANSLATIONS.get(key, {})
 2787          if not translation:
 2788              logger.debug(f"æœªæ‰¾åˆ°ç¿»è¯‘: {key}")
 2789              return default or key
 2790          
 2791          return translation.get(cls._current_lang, translation.get(LANG_ZH_CN, default or key))
 2792      
 2793      @classmethod
 2794      def get_language_name(cls, lang: str) -> str:
 2795          """è·å–è¯­è¨€æ˜¾ç¤ºåç§°"""
 2796          for code, name in SUPPORTED_LANGUAGES:
 2797              if code == lang:
 2798                  return name
 2799          return lang
 2800      
 2801      @classmethod
 2802      def get_supported_languages(cls) -> List[tuple]:
 2803          """è·å–æ”¯æŒçš„è¯­è¨€åˆ—è¡¨"""
 2804          return SUPPORTED_LANGUAGES.copy()
 2805  
 2806  
 2807  # ä¾¿æ·å‡½æ•°
 2808  def t(key: str, default: str = '') -> str:
 2809      """ç¿»è¯‘å¿«æ·å‡½æ•°
 2810      
 2811      ä½¿ç”¨æ–¹æ³•:
 2812          from src.core.i18n import t
 2813          label = t('start_upload')  # è¿”å› "â–¶ å¼€å§‹ä¸Šä¼ " æˆ– "â–¶ Start Upload"
 2814      """
 2815      return I18n.t(key, default)
 2816  
 2817  
 2818  def set_language(lang: str) -> bool:
 2819      """è®¾ç½®è¯­è¨€å¿«æ·å‡½æ•°"""
 2820      return I18n.set_language(lang)
 2821  
 2822  
 2823  def get_language() -> str:
 2824      """è·å–å½“å‰è¯­è¨€å¿«æ·å‡½æ•°"""
 2825      return I18n.get_current_language()
 2826  
 2827  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 58 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 2828  def add_language_listener(callback: Callable[[], None]):
 2829      """æ·»åŠ è¯­è¨€åˆ‡æ¢ç›‘å¬å™¨å¿«æ·å‡½æ•°"""
 2830      I18n.add_listener(callback)
       
       # ============================================================
       # æ–‡ä»¶: src\core\permissions.py
       # ============================================================
 2831  # -*- coding: utf-8 -*-
 2832  """
 2833  æƒé™ç®¡ç†æ¨¡å—
 2834  
 2835  è´Ÿè´£ç”¨æˆ·è§’è‰²æƒé™è®¡ç®—å’ŒéªŒè¯
 2836  """
 2837  from typing import Dict, Tuple, Optional
 2838  import hashlib
 2839  
 2840  
 2841  class PermissionManager:
 2842      """æƒé™ç®¡ç†å™¨"""
 2843      
 2844      # è§’è‰²å®šä¹‰
 2845      ROLE_GUEST = 'guest'
 2846      ROLE_USER = 'user'
 2847      ROLE_ADMIN = 'admin'
 2848      
 2849      # é»˜è®¤å¯†ç 
 2850      DEFAULT_USER_PASSWORD = '123'
 2851      DEFAULT_ADMIN_PASSWORD = 'Tops123'
 2852      
 2853      def __init__(self):
 2854          self.current_role = self.ROLE_GUEST
 2855          self.users: Dict[str, Dict[str, str]] = {}
 2856      
 2857      def set_users(self, users: Dict[str, Dict[str, str]]) -> None:
 2858          """è®¾ç½®ç”¨æˆ·åˆ—è¡¨
 2859          
 2860          Args:
 2861              users: ç”¨æˆ·å­—å…¸ï¼Œæ ¼å¼ {'user': {'password': 'xxx'}, 'admin': {'password': 'xxx'}}
 2862          """
 2863          self.users = users
 2864      
 2865      def verify_password(self, role: str, password: str) -> bool:
 2866          """éªŒè¯å¯†ç 
 2867          
 2868          Args:
 2869              role: ç”¨æˆ·è§’è‰²
 2870              password: å¯†ç 
 2871              
 2872          Returns:
 2873              å¯†ç æ˜¯å¦æ­£ç¡®

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 59 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 2874          """
 2875          # æ£€æŸ¥æ˜¯å¦æœ‰å­˜å‚¨çš„å¯†ç 
 2876          if role in self.users and 'password' in self.users[role]:
 2877              stored_password = self.users[role]['password']
 2878              # æ”¯æŒåŠ å¯†å¯†ç ï¼ˆä»¥ hash: å¼€å¤´ï¼‰å’Œæ˜æ–‡å¯†ç 
 2879              if stored_password.startswith('hash:'):
 2880                  return stored_password == f"hash:{PermissionManager._hash_password(password)}"
 2881              else:
 2882                  return stored_password == password
 2883          
 2884          # ä½¿ç”¨é»˜è®¤å¯†ç 
 2885          if role == self.ROLE_USER:
 2886              return password == self.DEFAULT_USER_PASSWORD
 2887          elif role == self.ROLE_ADMIN:
 2888              return password == self.DEFAULT_ADMIN_PASSWORD
 2889          
 2890          return False
 2891      
 2892      @staticmethod
 2893      def _hash_password(password: str) -> str:
 2894          """å¯†ç å“ˆå¸Œ
 2895          
 2896          Args:
 2897              password: æ˜æ–‡å¯†ç 
 2898              
 2899          Returns:
 2900              å“ˆå¸Œåçš„å¯†ç 
 2901          """
 2902          return hashlib.sha256(password.encode()).hexdigest()
 2903      
 2904      def login(self, role: str, password: str) -> Tuple[bool, str]:
 2905          """ç”¨æˆ·ç™»å½•
 2906          
 2907          Args:
 2908              role: ç”¨æˆ·è§’è‰²
 2909              password: å¯†ç 
 2910              
 2911          Returns:
 2912              (æ˜¯å¦æˆåŠŸ, æ¶ˆæ¯)
 2913          """
 2914          if not self.verify_password(role, password):
 2915              return False, "å¯†ç é”™è¯¯"
 2916          
 2917          self.current_role = role
 2918          role_name = self._get_role_name(role)
 2919          return True, f"ç™»å½•æˆåŠŸï¼Œå½“å‰è§’è‰²ï¼š{role_name}"
 2920      
 2921      def logout(self) -> None:
 2922          """é€€å‡ºç™»å½•"""
 2923          self.current_role = self.ROLE_GUEST

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 60 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 2924      
 2925      def get_current_role(self) -> str:
 2926          """è·å–å½“å‰è§’è‰²
 2927          
 2928          Returns:
 2929              å½“å‰è§’è‰²
 2930          """
 2931          return self.current_role
 2932      
 2933      def is_guest(self) -> bool:
 2934          """æ˜¯å¦æ˜¯è®¿å®¢"""
 2935          return self.current_role == self.ROLE_GUEST
 2936      
 2937      def is_user(self) -> bool:
 2938          """æ˜¯å¦æ˜¯æ™®é€šç”¨æˆ·"""
 2939          return self.current_role == self.ROLE_USER
 2940      
 2941      def is_admin(self) -> bool:
 2942          """æ˜¯å¦æ˜¯ç®¡ç†å‘˜"""
 2943          return self.current_role == self.ROLE_ADMIN
 2944      
 2945      def has_permission(self, action: str) -> bool:
 2946          """æ£€æŸ¥æ˜¯å¦æœ‰æƒé™æ‰§è¡ŒæŸä¸ªæ“ä½œ
 2947          
 2948          Args:
 2949              action: æ“ä½œåç§°
 2950              
 2951          Returns:
 2952              æ˜¯å¦æœ‰æƒé™
 2953          """
 2954          # å®šä¹‰æƒé™çŸ©é˜µ
 2955          permissions = {
 2956              'start': [self.ROLE_USER, self.ROLE_ADMIN],
 2957              'stop': [self.ROLE_USER, self.ROLE_ADMIN],
 2958              'pause': [self.ROLE_USER, self.ROLE_ADMIN],
 2959              'resume': [self.ROLE_USER, self.ROLE_ADMIN],
 2960              'save_config': [self.ROLE_USER, self.ROLE_ADMIN],
 2961              'change_protocol': [self.ROLE_ADMIN],
 2962              'manage_users': [self.ROLE_ADMIN],
 2963              'view_stats': [self.ROLE_USER, self.ROLE_ADMIN, self.ROLE_GUEST],
 2964          }
 2965          
 2966          allowed_roles = permissions.get(action, [])
 2967          return self.current_role in allowed_roles
 2968      
 2969      @staticmethod
 2970      def _get_role_name(role: str) -> str:
 2971          """è·å–è§’è‰²æ˜¾ç¤ºåç§°
 2972          
 2973          Args:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 61 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 2974              role: è§’è‰²ä»£ç 
 2975              
 2976          Returns:
 2977              è§’è‰²åç§°
 2978          """
 2979          role_names = {
 2980              'guest': 'è®¿å®¢',
 2981              'user': 'æ™®é€šç”¨æˆ·',
 2982              'admin': 'ç®¡ç†å‘˜'
 2983          }
 2984          return role_names.get(role, 'æœªçŸ¥')
 2985      
 2986      def get_role_display(self) -> Tuple[str, str, str]:
 2987          """è·å–è§’è‰²æ˜¾ç¤ºä¿¡æ¯
 2988          
 2989          Returns:
 2990              (å›¾æ ‡, æ–‡æœ¬, æ ·å¼)
 2991          """
 2992          displays = {
 2993              'guest': ("ğŸ”’ æœªç™»å½•", "#FFF3E0", "#E67E22"),
 2994              'user': ("ğŸ‘¤ æ™®é€šç”¨æˆ·", "#E8F5E9", "#2E7D32"),
 2995              'admin': ("ğŸ‘‘ ç®¡ç†å‘˜", "#F3E5F5", "#7B1FA2"),
 2996          }
 2997          text, bg, fg = displays.get(self.current_role, displays['guest'])
 2998          style = f"background:{bg}; color:{fg}; padding:6px 12px; border-radius:6px; font-weight:700;"
 2999          return text, style, bg
       
       # ============================================================
       # æ–‡ä»¶: src\core\resume_manager.py
       # ============================================================
 3000  # -*- coding: utf-8 -*-
 3001  """
 3002  æ–­ç‚¹ç»­ä¼ ç®¡ç†æ¨¡å—
 3003  
 3004  v3.0.2 æ–°å¢åŠŸèƒ½ï¼š
 3005  - å¤§æ–‡ä»¶ä¸Šä¼ ä¸­æ–­åå¯æ¢å¤
 3006  - è®°å½•ä¸Šä¼ è¿›åº¦åˆ°æœ¬åœ°æ–‡ä»¶
 3007  - æ”¯æŒ SMB å’Œ FTP åè®®
 3008  - è‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„ç»­ä¼ è®°å½•
 3009  """
 3010  
 3011  import os
 3012  import json
 3013  import hashlib
 3014  import time
 3015  import logging
 3016  from pathlib import Path
 3017  from typing import Dict, Any, Optional, Tuple
 3018  from datetime import datetime, timedelta
 3019  import threading

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 62 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 3020  
 3021  logger = logging.getLogger(__name__)
 3022  
 3023  
 3024  class ResumeManager:
 3025      """æ–­ç‚¹ç»­ä¼ ç®¡ç†å™¨
 3026      
 3027      åŠŸèƒ½ï¼š
 3028      - è®°å½•å¤§æ–‡ä»¶ä¸Šä¼ è¿›åº¦
 3029      - æ”¯æŒä¸Šä¼ ä¸­æ–­åæ¢å¤
 3030      - è‡ªåŠ¨æ¸…ç†è¿‡æœŸè®°å½•
 3031      - æ”¯æŒå¤šåè®®ï¼ˆSMB/FTPï¼‰
 3032      """
 3033      
 3034      # æœ€å°ç»­ä¼ æ–‡ä»¶å¤§å°ï¼ˆ10MB ä»¥ä¸Šæ‰å¯ç”¨ç»­ä¼ ï¼‰
 3035      MIN_RESUME_SIZE = 10 * 1024 * 1024
 3036      
 3037      # ç»­ä¼ è®°å½•è¿‡æœŸæ—¶é—´ï¼ˆ7å¤©ï¼‰
 3038      RECORD_EXPIRE_DAYS = 7
 3039      
 3040      def __init__(self, app_dir: Path):
 3041          """åˆå§‹åŒ–ç»­ä¼ ç®¡ç†å™¨
 3042          
 3043          Args:
 3044              app_dir: åº”ç”¨ç¨‹åºç›®å½•
 3045          """
 3046          self.app_dir = app_dir
 3047          self.resume_dir = app_dir / 'resume_data'
 3048          self.resume_dir.mkdir(parents=True, exist_ok=True)
 3049          
 3050          self._lock = threading.Lock()
 3051          self._active_uploads: Dict[str, Dict[str, Any]] = {}
 3052          
 3053          # å¯åŠ¨æ—¶æ¸…ç†è¿‡æœŸè®°å½•
 3054          self._cleanup_expired_records()
 3055          
 3056          logger.info(f"æ–­ç‚¹ç»­ä¼ ç®¡ç†å™¨åˆå§‹åŒ–: {self.resume_dir}")
 3057      
 3058      def _get_file_id(self, file_path: str) -> str:
 3059          """ç”Ÿæˆæ–‡ä»¶å”¯ä¸€æ ‡è¯†
 3060          
 3061          ä½¿ç”¨æ–‡ä»¶è·¯å¾„ + å¤§å° + ä¿®æ”¹æ—¶é—´ç”Ÿæˆå”¯ä¸€ ID
 3062          
 3063          Args:
 3064              file_path: æ–‡ä»¶è·¯å¾„
 3065              
 3066          Returns:
 3067              æ–‡ä»¶å”¯ä¸€æ ‡è¯†ï¼ˆMD5å“ˆå¸Œï¼‰
 3068          """
 3069          try:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 63 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 3070              stat = os.stat(file_path)
 3071              id_str = f"{file_path}|{stat.st_size}|{stat.st_mtime}"
 3072              return hashlib.md5(id_str.encode('utf-8')).hexdigest()[:16]
 3073          except Exception as e:
 3074              logger.warning(f"ç”Ÿæˆæ–‡ä»¶IDå¤±è´¥: {e}")
 3075              return hashlib.md5(file_path.encode('utf-8')).hexdigest()[:16]
 3076      
 3077      def _get_record_path(self, file_id: str) -> Path:
 3078          """è·å–ç»­ä¼ è®°å½•æ–‡ä»¶è·¯å¾„"""
 3079          return self.resume_dir / f"{file_id}.resume"
 3080      
 3081      def should_resume(self, file_path: str) -> bool:
 3082          """åˆ¤æ–­æ–‡ä»¶æ˜¯å¦åº”è¯¥å¯ç”¨æ–­ç‚¹ç»­ä¼ 
 3083          
 3084          Args:
 3085              file_path: æºæ–‡ä»¶è·¯å¾„
 3086              
 3087          Returns:
 3088              æ˜¯å¦å¯ç”¨æ–­ç‚¹ç»­ä¼ 
 3089          """
 3090          try:
 3091              file_size = os.path.getsize(file_path)
 3092              return file_size >= self.MIN_RESUME_SIZE
 3093          except Exception:
 3094              return False
 3095      
 3096      def get_resume_info(self, file_path: str, target_path: str) -> Optional[Dict[str, Any]]:
 3097          """è·å–ç»­ä¼ ä¿¡æ¯
 3098          
 3099          Args:
 3100              file_path: æºæ–‡ä»¶è·¯å¾„
 3101              target_path: ç›®æ ‡æ–‡ä»¶è·¯å¾„
 3102              
 3103          Returns:
 3104              ç»­ä¼ ä¿¡æ¯å­—å…¸ï¼Œå¦‚æœæ²¡æœ‰ç»­ä¼ è®°å½•è¿”å› None
 3105              {
 3106                  'file_id': æ–‡ä»¶ID,
 3107                  'uploaded_bytes': å·²ä¸Šä¼ å­—èŠ‚æ•°,
 3108                  'total_bytes': æ–‡ä»¶æ€»å¤§å°,
 3109                  'temp_file': ä¸´æ—¶æ–‡ä»¶è·¯å¾„,
 3110                  'last_update': æœ€åæ›´æ–°æ—¶é—´,
 3111                  'protocol': ä¸Šä¼ åè®®
 3112              }
 3113          """
 3114          with self._lock:
 3115              file_id = self._get_file_id(file_path)
 3116              record_path = self._get_record_path(file_id)
 3117              
 3118              if not record_path.exists():
 3119                  return None

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 64 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 3120              
 3121              try:
 3122                  with open(record_path, 'r', encoding='utf-8') as f:
 3123                      record = json.load(f)
 3124                  
 3125                  # éªŒè¯è®°å½•æœ‰æ•ˆæ€§
 3126                  if record.get('source_path') != file_path:
 3127                      logger.debug(f"æºæ–‡ä»¶è·¯å¾„ä¸åŒ¹é…: {file_path}")
 3128                      return None
 3129                  
 3130                  if record.get('target_path') != target_path:
 3131                      logger.debug(f"ç›®æ ‡è·¯å¾„ä¸åŒ¹é…: {target_path}")
 3132                      return None
 3133                  
 3134                  # æ£€æŸ¥æºæ–‡ä»¶æ˜¯å¦è¢«ä¿®æ”¹
 3135                  current_size = os.path.getsize(file_path)
 3136                  if record.get('total_bytes') != current_size:
 3137                      logger.info(f"æ–‡ä»¶å¤§å°å·²å˜åŒ–ï¼Œåˆ é™¤æ—§è®°å½•: {file_path}")
 3138                      self._delete_record(file_id)
 3139                      return None
 3140                  
 3141                  # æ£€æŸ¥ä¸´æ—¶æ–‡ä»¶æ˜¯å¦å­˜åœ¨
 3142                  temp_file = record.get('temp_file', '')
 3143                  if temp_file and not os.path.exists(temp_file):
 3144                      logger.info(f"ä¸´æ—¶æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ é™¤è®°å½•: {temp_file}")
 3145                      self._delete_record(file_id)
 3146                      return None
 3147                  
 3148                  # éªŒè¯å·²ä¸Šä¼ çš„å­—èŠ‚æ•°
 3149                  uploaded_bytes = record.get('uploaded_bytes', 0)
 3150                  if temp_file:
 3151                      actual_size = os.path.getsize(temp_file)
 3152                      if actual_size != uploaded_bytes:
 3153                          logger.info(f"ä¸´æ—¶æ–‡ä»¶å¤§å°ä¸åŒ¹é…: è®°å½•={uploaded_bytes}, å®é™…={actual_size}")
 3154                          record['uploaded_bytes'] = actual_size
 3155                  
 3156                  logger.info(f"æ‰¾åˆ°ç»­ä¼ è®°å½•: {file_path}, å·²ä¸Šä¼  {record['uploaded_bytes']}/{record['total_bytes']} å­—èŠ‚")
 3157                  return record
 3158                  
 3159              except Exception as e:
 3160                  logger.warning(f"è¯»å–ç»­ä¼ è®°å½•å¤±è´¥: {e}")
 3161                  self._delete_record(file_id)
 3162                  return None
 3163      
 3164      def create_resume_record(
 3165          self,
 3166          file_path: str,
 3167          target_path: str,
 3168          protocol: str = 'smb'
 3169      ) -> Dict[str, Any]:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 65 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 3170          """åˆ›å»ºç»­ä¼ è®°å½•
 3171          
 3172          Args:
 3173              file_path: æºæ–‡ä»¶è·¯å¾„
 3174              target_path: ç›®æ ‡æ–‡ä»¶è·¯å¾„
 3175              protocol: ä¸Šä¼ åè®® (smb/ftp_client)
 3176              
 3177          Returns:
 3178              ç»­ä¼ è®°å½•å­—å…¸
 3179          """
 3180          with self._lock:
 3181              file_id = self._get_file_id(file_path)
 3182              file_size = os.path.getsize(file_path)
 3183              
 3184              # ç”Ÿæˆä¸´æ—¶æ–‡ä»¶è·¯å¾„
 3185              target_dir = os.path.dirname(target_path)
 3186              target_name = os.path.basename(target_path)
 3187              temp_file = os.path.join(target_dir, f".{target_name}.part")
 3188              
 3189              record = {
 3190                  'file_id': file_id,
 3191                  'source_path': file_path,
 3192                  'target_path': target_path,
 3193                  'temp_file': temp_file,
 3194                  'total_bytes': file_size,
 3195                  'uploaded_bytes': 0,
 3196                  'protocol': protocol,
 3197                  'created_at': datetime.now().isoformat(),
 3198                  'last_update': datetime.now().isoformat(),
 3199                  'checksum_md5': '',  # å¯é€‰ï¼šå®ŒæˆåéªŒè¯
 3200              }
 3201              
 3202              # ä¿å­˜è®°å½•
 3203              record_path = self._get_record_path(file_id)
 3204              with open(record_path, 'w', encoding='utf-8') as f:
 3205                  json.dump(record, f, indent=2, ensure_ascii=False)
 3206              
 3207              # æ·»åŠ åˆ°æ´»è·ƒä¸Šä¼ åˆ—è¡¨
 3208              self._active_uploads[file_id] = record
 3209              
 3210              logger.info(f"åˆ›å»ºç»­ä¼ è®°å½•: {file_path} -> {target_path}")
 3211              return record
 3212      
 3213      def update_progress(self, file_path: str, uploaded_bytes: int) -> bool:
 3214          """æ›´æ–°ä¸Šä¼ è¿›åº¦
 3215          
 3216          Args:
 3217              file_path: æºæ–‡ä»¶è·¯å¾„
 3218              uploaded_bytes: å·²ä¸Šä¼ å­—èŠ‚æ•°
 3219              

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 66 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 3220          Returns:
 3221              æ˜¯å¦æ›´æ–°æˆåŠŸ
 3222          """
 3223          with self._lock:
 3224              file_id = self._get_file_id(file_path)
 3225              record_path = self._get_record_path(file_id)
 3226              
 3227              if not record_path.exists():
 3228                  return False
 3229              
 3230              try:
 3231                  with open(record_path, 'r', encoding='utf-8') as f:
 3232                      record = json.load(f)
 3233                  
 3234                  record['uploaded_bytes'] = uploaded_bytes
 3235                  record['last_update'] = datetime.now().isoformat()
 3236                  
 3237                  with open(record_path, 'w', encoding='utf-8') as f:
 3238                      json.dump(record, f, indent=2, ensure_ascii=False)
 3239                  
 3240                  # æ›´æ–°å†…å­˜ä¸­çš„è®°å½•
 3241                  if file_id in self._active_uploads:
 3242                      self._active_uploads[file_id]['uploaded_bytes'] = uploaded_bytes
 3243                  
 3244                  return True
 3245                  
 3246              except Exception as e:
 3247                  logger.warning(f"æ›´æ–°ç»­ä¼ è¿›åº¦å¤±è´¥: {e}")
 3248                  return False
 3249      
 3250      def complete_upload(self, file_path: str, success: bool = True) -> bool:
 3251          """å®Œæˆä¸Šä¼ ï¼ˆæˆåŠŸæˆ–å¤±è´¥ï¼‰
 3252          
 3253          Args:
 3254              file_path: æºæ–‡ä»¶è·¯å¾„
 3255              success: æ˜¯å¦ä¸Šä¼ æˆåŠŸ
 3256              
 3257          Returns:
 3258              æ˜¯å¦å¤„ç†æˆåŠŸ
 3259          """
 3260          with self._lock:
 3261              file_id = self._get_file_id(file_path)
 3262              
 3263              if success:
 3264                  # åˆ é™¤ç»­ä¼ è®°å½•å’Œä¸´æ—¶æ–‡ä»¶
 3265                  self._delete_record(file_id)
 3266                  logger.info(f"ä¸Šä¼ å®Œæˆï¼Œå·²åˆ é™¤ç»­ä¼ è®°å½•: {file_path}")
 3267              else:
 3268                  # ä¿ç•™è®°å½•ä¾›ä¸‹æ¬¡ç»­ä¼ 
 3269                  logger.info(f"ä¸Šä¼ ä¸­æ–­ï¼Œä¿ç•™ç»­ä¼ è®°å½•: {file_path}")

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 67 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 3270              
 3271              # ä»æ´»è·ƒåˆ—è¡¨ç§»é™¤
 3272              self._active_uploads.pop(file_id, None)
 3273              
 3274              return True
 3275      
 3276      def _delete_record(self, file_id: str):
 3277          """åˆ é™¤ç»­ä¼ è®°å½•"""
 3278          record_path = self._get_record_path(file_id)
 3279          
 3280          try:
 3281              if record_path.exists():
 3282                  # å…ˆè¯»å–è®°å½•è·å–ä¸´æ—¶æ–‡ä»¶è·¯å¾„
 3283                  try:
 3284                      with open(record_path, 'r', encoding='utf-8') as f:
 3285                          record = json.load(f)
 3286                      
 3287                      # åˆ é™¤ä¸´æ—¶æ–‡ä»¶ï¼ˆå¦‚æœä¸Šä¼ æˆåŠŸåˆ™ä¸éœ€è¦ï¼‰
 3288                      temp_file = record.get('temp_file', '')
 3289                      if temp_file and os.path.exists(temp_file):
 3290                          # æ£€æŸ¥æ˜¯å¦å·²ç»å®Œæˆï¼ˆç›®æ ‡æ–‡ä»¶å­˜åœ¨ï¼‰
 3291                          target_file = record.get('target_path', '')
 3292                          if target_file and os.path.exists(target_file):
 3293                              os.remove(temp_file)
 3294                              logger.debug(f"åˆ é™¤ä¸´æ—¶æ–‡ä»¶: {temp_file}")
 3295                  except Exception:
 3296                      pass
 3297                  
 3298                  # åˆ é™¤è®°å½•æ–‡ä»¶
 3299                  os.remove(record_path)
 3300                  logger.debug(f"åˆ é™¤ç»­ä¼ è®°å½•: {file_id}")
 3301          except Exception as e:
 3302              logger.warning(f"åˆ é™¤ç»­ä¼ è®°å½•å¤±è´¥: {e}")
 3303      
 3304      def _cleanup_expired_records(self):
 3305          """æ¸…ç†è¿‡æœŸçš„ç»­ä¼ è®°å½•"""
 3306          try:
 3307              expire_time = datetime.now() - timedelta(days=self.RECORD_EXPIRE_DAYS)
 3308              cleaned = 0
 3309              
 3310              for record_file in self.resume_dir.glob("*.resume"):
 3311                  try:
 3312                      with open(record_file, 'r', encoding='utf-8') as f:
 3313                          record = json.load(f)
 3314                      
 3315                      last_update = datetime.fromisoformat(record.get('last_update', ''))
 3316                      if last_update < expire_time:
 3317                          file_id = record_file.stem
 3318                          self._delete_record(file_id)
 3319                          cleaned += 1

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 68 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 3320                  except Exception:
 3321                      # æ— æ³•è§£æçš„è®°å½•ç›´æ¥åˆ é™¤
 3322                      record_file.unlink(missing_ok=True)
 3323                      cleaned += 1
 3324              
 3325              if cleaned > 0:
 3326                  logger.info(f"æ¸…ç†è¿‡æœŸç»­ä¼ è®°å½•: {cleaned} ä¸ª")
 3327                  
 3328          except Exception as e:
 3329              logger.warning(f"æ¸…ç†è¿‡æœŸè®°å½•å¤±è´¥: {e}")
 3330      
 3331      def get_active_uploads(self) -> Dict[str, Dict[str, Any]]:
 3332          """è·å–æ‰€æœ‰æ´»è·ƒçš„ä¸Šä¼ ä»»åŠ¡
 3333          
 3334          Returns:
 3335              æ´»è·ƒä¸Šä¼ ä»»åŠ¡å­—å…¸
 3336          """
 3337          with self._lock:
 3338              return self._active_uploads.copy()
 3339      
 3340      def get_pending_resumes(self) -> list:
 3341          """è·å–æ‰€æœ‰å¾…ç»­ä¼ çš„è®°å½•
 3342          
 3343          Returns:
 3344              å¾…ç»­ä¼ è®°å½•åˆ—è¡¨
 3345          """
 3346          pending = []
 3347          
 3348          try:
 3349              for record_file in self.resume_dir.glob("*.resume"):
 3350                  try:
 3351                      with open(record_file, 'r', encoding='utf-8') as f:
 3352                          record = json.load(f)
 3353                      
 3354                      # æ£€æŸ¥æºæ–‡ä»¶æ˜¯å¦ä»ç„¶å­˜åœ¨
 3355                      source_path = record.get('source_path', '')
 3356                      if source_path and os.path.exists(source_path):
 3357                          pending.append(record)
 3358                      else:
 3359                          # æºæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ é™¤è®°å½•
 3360                          self._delete_record(record_file.stem)
 3361                          
 3362                  except Exception:
 3363                      continue
 3364          except Exception as e:
 3365              logger.warning(f"è·å–å¾…ç»­ä¼ è®°å½•å¤±è´¥: {e}")
 3366          
 3367          return pending
 3368  
 3369  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 69 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 3370  class ResumableFileUploader:
 3371      """å¯ç»­ä¼ çš„æ–‡ä»¶ä¸Šä¼ å™¨
 3372      
 3373      å°è£…æ–­ç‚¹ç»­ä¼ é€»è¾‘ï¼Œæ”¯æŒ SMB å’Œ FTP åè®®
 3374      """
 3375      
 3376      def __init__(
 3377          self,
 3378          resume_manager: ResumeManager,
 3379          buffer_size: int = 1024 * 1024,  # 1MB ç¼“å†²åŒº
 3380          progress_callback=None
 3381      ):
 3382          """åˆå§‹åŒ–ä¸Šä¼ å™¨
 3383          
 3384          Args:
 3385              resume_manager: ç»­ä¼ ç®¡ç†å™¨
 3386              buffer_size: ç¼“å†²åŒºå¤§å°
 3387              progress_callback: è¿›åº¦å›è°ƒ callback(uploaded, total, filename)
 3388          """
 3389          self.resume_manager = resume_manager
 3390          self.buffer_size = buffer_size
 3391          self.progress_callback = progress_callback
 3392          self._stop_flag = False
 3393      
 3394      def stop(self):
 3395          """åœæ­¢ä¸Šä¼ """
 3396          self._stop_flag = True
 3397      
 3398      def reset(self):
 3399          """é‡ç½®åœæ­¢æ ‡å¿—"""
 3400          self._stop_flag = False
 3401      
 3402      def upload_with_resume(
 3403          self,
 3404          source_path: str,
 3405          target_path: str,
 3406          rate_limit_bytes: int = 0
 3407      ) -> Tuple[bool, str]:
 3408          """å¸¦æ–­ç‚¹ç»­ä¼ çš„æ–‡ä»¶ä¸Šä¼ 
 3409          
 3410          Args:
 3411              source_path: æºæ–‡ä»¶è·¯å¾„
 3412              target_path: ç›®æ ‡æ–‡ä»¶è·¯å¾„
 3413              rate_limit_bytes: é€Ÿç‡é™åˆ¶ï¼ˆå­—èŠ‚/ç§’ï¼‰ï¼Œ0 è¡¨ç¤ºä¸é™é€Ÿ
 3414              
 3415          Returns:
 3416              (æ˜¯å¦æˆåŠŸ, é”™è¯¯ä¿¡æ¯)
 3417          """
 3418          self._stop_flag = False
 3419          

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 70 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 3420          try:
 3421              file_size = os.path.getsize(source_path)
 3422              filename = os.path.basename(source_path)
 3423              
 3424              # æ£€æŸ¥æ˜¯å¦éœ€è¦æ–­ç‚¹ç»­ä¼ 
 3425              if not self.resume_manager.should_resume(source_path):
 3426                  # å°æ–‡ä»¶ç›´æ¥å¤åˆ¶
 3427                  return self._simple_copy(source_path, target_path, rate_limit_bytes)
 3428              
 3429              # è·å–ç»­ä¼ ä¿¡æ¯
 3430              resume_info = self.resume_manager.get_resume_info(source_path, target_path)
 3431              
 3432              if resume_info:
 3433                  # ç»­ä¼ æ¨¡å¼
 3434                  uploaded_bytes = resume_info['uploaded_bytes']
 3435                  temp_file = resume_info['temp_file']
 3436                  logger.info(f"ç»­ä¼ æ¨¡å¼: {filename}, ä» {uploaded_bytes} å­—èŠ‚ç»§ç»­")
 3437              else:
 3438                  # æ–°å»ºä¸Šä¼ 
 3439                  resume_info = self.resume_manager.create_resume_record(
 3440                      source_path, target_path, 'smb'
 3441                  )
 3442                  uploaded_bytes = 0
 3443                  temp_file = resume_info['temp_file']
 3444                  logger.info(f"æ–°å»ºä¸Šä¼ : {filename}, æ€»å¤§å° {file_size} å­—èŠ‚")
 3445              
 3446              # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
 3447              os.makedirs(os.path.dirname(target_path), exist_ok=True)
 3448              
 3449              # æ‰“å¼€æºæ–‡ä»¶å’Œç›®æ ‡ä¸´æ—¶æ–‡ä»¶
 3450              mode = 'ab' if uploaded_bytes > 0 else 'wb'
 3451              
 3452              with open(source_path, 'rb') as src:
 3453                  # è·³åˆ°å·²ä¸Šä¼ çš„ä½ç½®
 3454                  if uploaded_bytes > 0:
 3455                      src.seek(uploaded_bytes)
 3456                  
 3457                  with open(temp_file, mode) as dst:
 3458                      while not self._stop_flag:
 3459                          chunk_start = time.time()
 3460                          
 3461                          # è¯»å–æ•°æ®å—
 3462                          chunk = src.read(self.buffer_size)
 3463                          if not chunk:
 3464                              break
 3465                          
 3466                          # å†™å…¥æ•°æ®
 3467                          dst.write(chunk)
 3468                          uploaded_bytes += len(chunk)
 3469                          

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 71 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 3470                          # æ›´æ–°è¿›åº¦
 3471                          self.resume_manager.update_progress(source_path, uploaded_bytes)
 3472                          
 3473                          if self.progress_callback:
 3474                              self.progress_callback(uploaded_bytes, file_size, filename)
 3475                          
 3476                          # é€Ÿç‡é™åˆ¶
 3477                          if rate_limit_bytes > 0:
 3478                              expected_time = len(chunk) / rate_limit_bytes
 3479                              elapsed_time = time.time() - chunk_start
 3480                              if elapsed_time < expected_time:
 3481                                  time.sleep(expected_time - elapsed_time)
 3482              
 3483              # æ£€æŸ¥æ˜¯å¦è¢«ä¸­æ–­
 3484              if self._stop_flag:
 3485                  logger.info(f"ä¸Šä¼ è¢«ä¸­æ–­: {filename}, å·²ä¿å­˜è¿›åº¦")
 3486                  self.resume_manager.complete_upload(source_path, success=False)
 3487                  return False, "ä¸Šä¼ è¢«ç”¨æˆ·ä¸­æ–­"
 3488              
 3489              # ä¸Šä¼ å®Œæˆï¼Œé‡å‘½åä¸´æ—¶æ–‡ä»¶
 3490              if os.path.exists(target_path):
 3491                  os.remove(target_path)
 3492              os.rename(temp_file, target_path)
 3493              
 3494              # å¤åˆ¶æ–‡ä»¶å±æ€§
 3495              import shutil
 3496              shutil.copystat(source_path, target_path)
 3497              
 3498              # æ ‡è®°å®Œæˆ
 3499              self.resume_manager.complete_upload(source_path, success=True)
 3500              logger.info(f"ä¸Šä¼ å®Œæˆ: {filename}")
 3501              
 3502              return True, ""
 3503              
 3504          except Exception as e:
 3505              logger.error(f"ä¸Šä¼ å¤±è´¥: {e}")
 3506              self.resume_manager.complete_upload(source_path, success=False)
 3507              return False, str(e)
 3508      
 3509      def _simple_copy(
 3510          self,
 3511          source_path: str,
 3512          target_path: str,
 3513          rate_limit_bytes: int = 0
 3514      ) -> Tuple[bool, str]:
 3515          """ç®€å•å¤åˆ¶ï¼ˆä¸å¯ç”¨ç»­ä¼ ï¼‰"""
 3516          try:
 3517              file_size = os.path.getsize(source_path)
 3518              filename = os.path.basename(source_path)
 3519              uploaded_bytes = 0

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 72 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 3520              
 3521              os.makedirs(os.path.dirname(target_path), exist_ok=True)
 3522              
 3523              with open(source_path, 'rb') as src, open(target_path, 'wb') as dst:
 3524                  while not self._stop_flag:
 3525                      chunk_start = time.time()
 3526                      
 3527                      chunk = src.read(self.buffer_size)
 3528                      if not chunk:
 3529                          break
 3530                      
 3531                      dst.write(chunk)
 3532                      uploaded_bytes += len(chunk)
 3533                      
 3534                      if self.progress_callback:
 3535                          self.progress_callback(uploaded_bytes, file_size, filename)
 3536                      
 3537                      if rate_limit_bytes > 0:
 3538                          expected_time = len(chunk) / rate_limit_bytes
 3539                          elapsed_time = time.time() - chunk_start
 3540                          if elapsed_time < expected_time:
 3541                              time.sleep(expected_time - elapsed_time)
 3542              
 3543              if self._stop_flag:
 3544                  if os.path.exists(target_path):
 3545                      os.remove(target_path)
 3546                  return False, "ä¸Šä¼ è¢«ç”¨æˆ·ä¸­æ–­"
 3547              
 3548              import shutil
 3549              shutil.copystat(source_path, target_path)
 3550              
 3551              return True, ""
 3552              
 3553          except Exception as e:
 3554              return False, str(e)
       
       # ============================================================
       # æ–‡ä»¶: src\core\utils.py
       # ============================================================
 3555  # -*- coding: utf-8 -*-
 3556  """
 3557  é€šç”¨å·¥å…·å‡½æ•°æ¨¡å—
 3558  
 3559  æä¾›è·¯å¾„å¤„ç†ã€èµ„æºè®¿é—®ç­‰é€šç”¨åŠŸèƒ½
 3560  """
 3561  import sys
 3562  from pathlib import Path
 3563  
 3564  
 3565  def get_app_dir() -> Path:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 73 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 3566      """è·å–åº”ç”¨ç¨‹åºæ•°æ®ç›®å½•ï¼ˆç”¨äºé…ç½®å’Œæ—¥å¿—ç­‰å¯å†™æ–‡ä»¶ï¼‰
 3567      
 3568      - å¼€å‘ç¯å¢ƒï¼šè¿”å›é¡¹ç›®æ ¹ç›®å½•
 3569      - æ‰“åŒ…åï¼šè¿”å› exe æ‰€åœ¨ç›®å½•ï¼ˆç”¨æˆ·å¯å†™ï¼‰
 3570      
 3571      Returns:
 3572          Path: åº”ç”¨ç¨‹åºæ•°æ®ç›®å½•
 3573      """
 3574      if getattr(sys, 'frozen', False):
 3575          # PyInstaller æ‰“åŒ…åï¼Œè¿”å› exe æ‰€åœ¨ç›®å½•
 3576          return Path(sys.executable).parent
 3577      # å¼€å‘ç¯å¢ƒï¼Œè¿”å›é¡¹ç›®æ ¹ç›®å½•ï¼ˆpyqt_app.py æ‰€åœ¨ç›®å½•ï¼‰
 3578      return Path(__file__).parent.parent.parent
 3579  
 3580  
 3581  def get_resource_path(relative_path: str) -> Path:
 3582      """è·å–èµ„æºæ–‡ä»¶çš„ç»å¯¹è·¯å¾„ï¼ˆæ”¯æŒæ‰“åŒ…ï¼‰
 3583      
 3584      ç”¨äºè¯»å–åªè¯»èµ„æºæ–‡ä»¶ï¼Œå¦‚ Logoã€é»˜è®¤é…ç½®ç­‰
 3585      
 3586      Args:
 3587          relative_path: ç›¸å¯¹äºèµ„æºç›®å½•çš„è·¯å¾„ï¼Œå¦‚ 'assets/logo.png'
 3588      
 3589      Returns:
 3590          Path: èµ„æºæ–‡ä»¶çš„ç»å¯¹è·¯å¾„
 3591      """
 3592      if getattr(sys, 'frozen', False) and hasattr(sys, '_MEIPASS'):
 3593          # æ‰“åŒ…åï¼Œèµ„æºæ–‡ä»¶åœ¨ _internal ç›®å½•ï¼ˆsys._MEIPASSï¼‰
 3594          # ä½¿ç”¨ getattr é¿å…ç±»å‹æ£€æŸ¥é”™è¯¯ï¼ˆ_MEIPASS æ˜¯è¿è¡Œæ—¶åŠ¨æ€å±æ€§ï¼‰
 3595          base_path = Path(getattr(sys, '_MEIPASS'))
 3596      else:
 3597          # å¼€å‘ç¯å¢ƒï¼Œèµ„æºæ–‡ä»¶åœ¨é¡¹ç›®æ ¹ç›®å½•
 3598          base_path = Path(__file__).parent.parent.parent
 3599      return base_path / relative_path
 3600  
 3601  
 3602  def get_app_version() -> str:
 3603      """è·å–åº”ç”¨ç¨‹åºç‰ˆæœ¬å·
 3604      
 3605      Returns:
 3606          str: ç‰ˆæœ¬å·ï¼Œå¦‚ "3.0.2"
 3607      """
 3608      return "3.0.2"
 3609  
 3610  
 3611  def get_app_title() -> str:
 3612      """è·å–åº”ç”¨ç¨‹åºæ ‡é¢˜
 3613      
 3614      Returns:
 3615          str: åº”ç”¨ç¨‹åºæ ‡é¢˜

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 74 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 3616      """
 3617      return f"å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…· v{get_app_version()}"
       
       # ============================================================
       # æ–‡ä»¶: src\ftp_ui_component.py
       # ============================================================
 3618  # -*- coding: utf-8 -*-
 3619  """
 3620  FTP UI ç»„ä»¶æ¨¡å—
 3621  ä¸º v2.0 æä¾› FTP æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯é…ç½®ç•Œé¢
 3622  
 3623  ç‰ˆæœ¬: v2.0
 3624  æ—¥æœŸ: 2025-11-10
 3625  ä½œè€…: å¼€å‘å›¢é˜Ÿ
 3626  
 3627  è®¾è®¡é£æ ¼è¯´æ˜ï¼š
 3628  - ä¸ pyqt_app.py ä¿æŒå®Œå…¨ä¸€è‡´çš„è“è‰²ä¸»é¢˜
 3629  - ä½¿ç”¨ç›¸åŒçš„é¢œè‰²æ–¹æ¡ˆï¼š#1976D2ï¼ˆä¸»è‰²ï¼‰ã€#64B5F6ï¼ˆè¾¹æ¡†ï¼‰ã€#E3F2FDï¼ˆèƒŒæ™¯ï¼‰
 3630  - ä½¿ç”¨ç›¸åŒçš„æŒ‰é’®æ ·å¼ç±»ï¼šPrimaryã€Secondaryã€Warningã€Danger
 3631  - ä½¿ç”¨ç›¸åŒçš„åœ†è§’ã€é—´è·ã€å­—ä½“è®¾ç½®
 3632  """
 3633  
 3634  from PySide6.QtWidgets import (
 3635      QWidget, QVBoxLayout, QHBoxLayout, QGroupBox, QLabel, 
 3636      QLineEdit, QPushButton, QSpinBox, QCheckBox, QFileDialog,
 3637      QListWidget, QListWidgetItem, QMessageBox, QComboBox,
 3638      QFormLayout, QTabWidget, QTextEdit, QFrame
 3639  )
 3640  from PySide6.QtCore import Qt, Signal
 3641  from pathlib import Path
 3642  import logging
 3643  
 3644  logger = logging.getLogger(__name__)
 3645  
 3646  
 3647  class FTPServerConfigWidget(QWidget):
 3648      """
 3649      FTP æœåŠ¡å™¨é…ç½®é¢æ¿
 3650      
 3651      åŠŸèƒ½ï¼š
 3652      - æœåŠ¡å™¨åŸºæœ¬é…ç½®ï¼ˆIPã€ç«¯å£ã€ç”¨æˆ·åã€å¯†ç ï¼‰
 3653      - å…±äº«ç›®å½•é€‰æ‹©
 3654      - é«˜çº§è®¾ç½®ï¼ˆTLSã€è¢«åŠ¨ç«¯å£ã€è¿æ¥é™åˆ¶ï¼‰
 3655      - å¯åŠ¨/åœæ­¢æŒ‰é’®
 3656      - çŠ¶æ€æ˜¾ç¤º
 3657      """
 3658      
 3659      # ä¿¡å·å®šä¹‰
 3660      start_server_signal = Signal(dict)  # å¯åŠ¨æœåŠ¡å™¨ä¿¡å·
 3661      stop_server_signal = Signal()       # åœæ­¢æœåŠ¡å™¨ä¿¡å·

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 75 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 3662      test_server_signal = Signal()       # æµ‹è¯•æœåŠ¡å™¨ä¿¡å·
 3663      
 3664      def __init__(self, parent=None):
 3665          super().__init__(parent)
 3666          self.init_ui()
 3667      
 3668      def init_ui(self):
 3669          """åˆå§‹åŒ–ç•Œé¢"""
 3670          layout = QVBoxLayout(self)
 3671          layout.setContentsMargins(0, 0, 0, 0)
 3672          
 3673          # ä½¿ç”¨ Card é£æ ¼çš„ Frame
 3674          card = QFrame(self)
 3675          card.setObjectName("Card")
 3676          card_layout = QVBoxLayout(card)
 3677          
 3678          # æ ‡é¢˜ï¼ˆä½¿ç”¨ Title æ ·å¼ç±»ï¼‰
 3679          title_label = QLabel("FTP æœåŠ¡å™¨é…ç½®")
 3680          title_label.setProperty("class", "Title")
 3681          card_layout.addWidget(title_label)
 3682          
 3683          # åŸºæœ¬é…ç½®ç»„
 3684          basic_group = QGroupBox("åŸºæœ¬é…ç½®")
 3685          basic_layout = QFormLayout()
 3686          
 3687          # ç›‘å¬åœ°å€
 3688          self.host_edit = QLineEdit("0.0.0.0")
 3689          self.host_edit.setPlaceholderText("ç›‘å¬åœ°å€ï¼ˆ0.0.0.0 è¡¨ç¤ºæ‰€æœ‰ç½‘å¡ï¼‰")
 3690          basic_layout.addRow("ç›‘å¬åœ°å€:", self.host_edit)
 3691          
 3692          # ç«¯å£
 3693          self.port_spin = QSpinBox()
 3694          self.port_spin.setRange(1, 65535)
 3695          self.port_spin.setValue(2121)  # é»˜è®¤éç‰¹æƒç«¯å£
 3696          self.port_spin.setToolTip("ç«¯å£ < 1024 éœ€è¦ç®¡ç†å‘˜æƒé™")
 3697          basic_layout.addRow("ç«¯å£:", self.port_spin)
 3698          
 3699          # ç”¨æˆ·å
 3700          self.username_edit = QLineEdit("upload_user")
 3701          self.username_edit.setPlaceholderText("FTP ç”¨æˆ·å")
 3702          basic_layout.addRow("ç”¨æˆ·å:", self.username_edit)
 3703          
 3704          # å¯†ç 
 3705          self.password_edit = QLineEdit("upload_pass")
 3706          self.password_edit.setEchoMode(QLineEdit.EchoMode.Password)
 3707          self.password_edit.setPlaceholderText("FTP å¯†ç ")
 3708          basic_layout.addRow("å¯†ç :", self.password_edit)
 3709          
 3710          # å…±äº«ç›®å½•
 3711          share_layout = QHBoxLayout()

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 76 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 3712          self.share_folder_edit = QLineEdit("D:/FTP_Share")
 3713          self.share_folder_edit.setPlaceholderText("é€‰æ‹©å…±äº«ç›®å½•")
 3714          share_layout.addWidget(self.share_folder_edit)
 3715          
 3716          browse_btn = QPushButton("æµè§ˆ...")
 3717          browse_btn.clicked.connect(self.browse_share_folder)
 3718          share_layout.addWidget(browse_btn)
 3719          
 3720          basic_layout.addRow("å…±äº«ç›®å½•:", share_layout)
 3721          
 3722          basic_group.setLayout(basic_layout)
 3723          card_layout.addWidget(basic_group)
 3724          
 3725          # é«˜çº§é…ç½®ç»„
 3726          advanced_group = QGroupBox("é«˜çº§é…ç½®")
 3727          advanced_layout = QFormLayout()
 3728          
 3729          # TLS åŠ å¯†
 3730          self.tls_check = QCheckBox("å¯ç”¨ FTPS (TLS/SSL)")
 3731          self.tls_check.setToolTip("éœ€è¦è¯ä¹¦æ–‡ä»¶æ”¯æŒ")
 3732          self.tls_check.toggled.connect(self.on_tls_toggled)
 3733          advanced_layout.addRow("åŠ å¯†:", self.tls_check)
 3734          
 3735          # è¯ä¹¦æ–‡ä»¶
 3736          cert_layout = QHBoxLayout()
 3737          self.cert_file_edit = QLineEdit()
 3738          self.cert_file_edit.setPlaceholderText("cert.pem")
 3739          self.cert_file_edit.setEnabled(False)
 3740          cert_layout.addWidget(self.cert_file_edit)
 3741          
 3742          cert_browse_btn = QPushButton("æµè§ˆ...")
 3743          cert_browse_btn.clicked.connect(self.browse_cert_file)
 3744          cert_browse_btn.setEnabled(False)
 3745          cert_layout.addWidget(cert_browse_btn)
 3746          self.cert_browse_btn = cert_browse_btn
 3747          
 3748          advanced_layout.addRow("è¯ä¹¦æ–‡ä»¶:", cert_layout)
 3749          
 3750          # å¯†é’¥æ–‡ä»¶
 3751          key_layout = QHBoxLayout()
 3752          self.key_file_edit = QLineEdit()
 3753          self.key_file_edit.setPlaceholderText("key.pem")
 3754          self.key_file_edit.setEnabled(False)
 3755          key_layout.addWidget(self.key_file_edit)
 3756          
 3757          key_browse_btn = QPushButton("æµè§ˆ...")
 3758          key_browse_btn.clicked.connect(self.browse_key_file)
 3759          key_browse_btn.setEnabled(False)
 3760          key_layout.addWidget(key_browse_btn)
 3761          self.key_browse_btn = key_browse_btn

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 77 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 3762          
 3763          advanced_layout.addRow("å¯†é’¥æ–‡ä»¶:", key_layout)
 3764          
 3765          # è¢«åŠ¨ç«¯å£èŒƒå›´
 3766          passive_layout = QHBoxLayout()
 3767          self.passive_start_spin = QSpinBox()
 3768          self.passive_start_spin.setRange(1024, 65535)
 3769          self.passive_start_spin.setValue(60000)
 3770          passive_layout.addWidget(self.passive_start_spin)
 3771          
 3772          passive_layout.addWidget(QLabel("-"))
 3773          
 3774          self.passive_end_spin = QSpinBox()
 3775          self.passive_end_spin.setRange(1024, 65535)
 3776          self.passive_end_spin.setValue(65535)
 3777          passive_layout.addWidget(self.passive_end_spin)
 3778          
 3779          advanced_layout.addRow("è¢«åŠ¨ç«¯å£:", passive_layout)
 3780          
 3781          # æœ€å¤§è¿æ¥æ•°
 3782          self.max_cons_spin = QSpinBox()
 3783          self.max_cons_spin.setRange(1, 1000)
 3784          self.max_cons_spin.setValue(256)
 3785          advanced_layout.addRow("æœ€å¤§è¿æ¥æ•°:", self.max_cons_spin)
 3786          
 3787          # å•IPæœ€å¤§è¿æ¥
 3788          self.max_cons_per_ip_spin = QSpinBox()
 3789          self.max_cons_per_ip_spin.setRange(1, 100)
 3790          self.max_cons_per_ip_spin.setValue(5)
 3791          advanced_layout.addRow("å•IPæœ€å¤§è¿æ¥:", self.max_cons_per_ip_spin)
 3792          
 3793          advanced_group.setLayout(advanced_layout)
 3794          card_layout.addWidget(advanced_group)
 3795          
 3796          # æ§åˆ¶æŒ‰é’®ï¼ˆä½¿ç”¨ Primary å’Œ Danger æ ·å¼ç±»ï¼‰
 3797          button_layout = QHBoxLayout()
 3798          
 3799          self.start_btn = QPushButton("å¯åŠ¨æœåŠ¡å™¨")
 3800          self.start_btn.clicked.connect(self.on_start_clicked)
 3801          self.start_btn.setProperty("class", "Primary")  # ä½¿ç”¨ä¸»è‰²è°ƒæŒ‰é’®
 3802          button_layout.addWidget(self.start_btn)
 3803          
 3804          self.stop_btn = QPushButton("åœæ­¢æœåŠ¡å™¨")
 3805          self.stop_btn.clicked.connect(self.on_stop_clicked)
 3806          self.stop_btn.setEnabled(False)
 3807          self.stop_btn.setProperty("class", "Danger")  # ä½¿ç”¨å±é™©è‰²æŒ‰é’®
 3808          button_layout.addWidget(self.stop_btn)
 3809          
 3810          card_layout.addLayout(button_layout)
 3811          

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 78 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 3812          # çŠ¶æ€æ˜¾ç¤º
 3813          status_group = QGroupBox("æœåŠ¡å™¨çŠ¶æ€")
 3814          status_layout = QVBoxLayout()
 3815          
 3816          self.status_label = QLabel("æœªå¯åŠ¨")
 3817          status_layout.addWidget(self.status_label)
 3818          
 3819          self.connections_label = QLabel("è¿æ¥æ•°: 0")
 3820          status_layout.addWidget(self.connections_label)
 3821          
 3822          status_group.setLayout(status_layout)
 3823          card_layout.addWidget(status_group)
 3824          
 3825          card_layout.addStretch()
 3826          layout.addWidget(card)
 3827      
 3828      def browse_share_folder(self):
 3829          """æµè§ˆå…±äº«ç›®å½•"""
 3830          folder = QFileDialog.getExistingDirectory(
 3831              self,
 3832              "é€‰æ‹©å…±äº«ç›®å½•",
 3833              self.share_folder_edit.text()
 3834          )
 3835          if folder:
 3836              self.share_folder_edit.setText(folder)
 3837      
 3838      def browse_cert_file(self):
 3839          """æµè§ˆè¯ä¹¦æ–‡ä»¶"""
 3840          file, _ = QFileDialog.getOpenFileName(
 3841              self,
 3842              "é€‰æ‹©è¯ä¹¦æ–‡ä»¶",
 3843              "",
 3844              "PEM Files (*.pem);;All Files (*)"
 3845          )
 3846          if file:
 3847              self.cert_file_edit.setText(file)
 3848      
 3849      def browse_key_file(self):
 3850          """æµè§ˆå¯†é’¥æ–‡ä»¶"""
 3851          file, _ = QFileDialog.getOpenFileName(
 3852              self,
 3853              "é€‰æ‹©å¯†é’¥æ–‡ä»¶",
 3854              "",
 3855              "PEM Files (*.pem);;All Files (*)"
 3856          )
 3857          if file:
 3858              self.key_file_edit.setText(file)
 3859      
 3860      def on_tls_toggled(self, checked):
 3861          """TLS å¤é€‰æ¡†åˆ‡æ¢"""

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 79 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 3862          self.cert_file_edit.setEnabled(checked)
 3863          self.cert_browse_btn.setEnabled(checked)
 3864          self.key_file_edit.setEnabled(checked)
 3865          self.key_browse_btn.setEnabled(checked)
 3866      
 3867      def on_start_clicked(self):
 3868          """å¯åŠ¨æŒ‰é’®ç‚¹å‡»"""
 3869          # éªŒè¯é…ç½®
 3870          if not self.validate_config():
 3871              return
 3872          
 3873          # è·å–é…ç½®
 3874          config = self.get_config()
 3875          
 3876          # å‘å°„ä¿¡å·
 3877          self.start_server_signal.emit(config)
 3878          
 3879          # æ›´æ–°æŒ‰é’®çŠ¶æ€
 3880          self.start_btn.setEnabled(False)
 3881          self.stop_btn.setEnabled(True)
 3882          
 3883          # ç¦ç”¨é…ç½®ç¼–è¾‘
 3884          self.set_config_editable(False)
 3885      
 3886      def on_stop_clicked(self):
 3887          """åœæ­¢æŒ‰é’®ç‚¹å‡»"""
 3888          # å‘å°„ä¿¡å·
 3889          self.stop_server_signal.emit()
 3890          
 3891          # æ›´æ–°æŒ‰é’®çŠ¶æ€
 3892          self.start_btn.setEnabled(True)
 3893          self.stop_btn.setEnabled(False)
 3894          
 3895          # å¯ç”¨é…ç½®ç¼–è¾‘
 3896          self.set_config_editable(True)
 3897      
 3898      def validate_config(self) -> bool:
 3899          """éªŒè¯é…ç½®"""
 3900          # æ£€æŸ¥ç«¯å£èŒƒå›´
 3901          if self.passive_start_spin.value() >= self.passive_end_spin.value():
 3902              QMessageBox.warning(self, "é…ç½®é”™è¯¯", "è¢«åŠ¨ç«¯å£èµ·å§‹å€¼å¿…é¡»å°äºç»“æŸå€¼")
 3903              return False
 3904          
 3905          # æ£€æŸ¥å…±äº«ç›®å½•
 3906          share_folder = Path(self.share_folder_edit.text())
 3907          if not share_folder.exists():
 3908              reply = QMessageBox.question(
 3909                  self, 
 3910                  "ç›®å½•ä¸å­˜åœ¨", 
 3911                  f"ç›®å½• {share_folder} ä¸å­˜åœ¨ï¼Œæ˜¯å¦åˆ›å»ºï¼Ÿ",

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 80 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 3912                  QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No
 3913              )
 3914              if reply == QMessageBox.StandardButton.Yes:
 3915                  try:
 3916                      share_folder.mkdir(parents=True, exist_ok=True)
 3917                  except Exception as e:
 3918                      QMessageBox.critical(self, "åˆ›å»ºå¤±è´¥", f"æ— æ³•åˆ›å»ºç›®å½•ï¼š{e}")
 3919                      return False
 3920              else:
 3921                  return False
 3922          
 3923          # æ£€æŸ¥ TLS è¯ä¹¦
 3924          if self.tls_check.isChecked():
 3925              cert_file = Path(self.cert_file_edit.text())
 3926              key_file = Path(self.key_file_edit.text())
 3927              
 3928              if not cert_file.exists():
 3929                  QMessageBox.warning(self, "é…ç½®é”™è¯¯", "è¯ä¹¦æ–‡ä»¶ä¸å­˜åœ¨")
 3930                  return False
 3931              
 3932              if not key_file.exists():
 3933                  QMessageBox.warning(self, "é…ç½®é”™è¯¯", "å¯†é’¥æ–‡ä»¶ä¸å­˜åœ¨")
 3934                  return False
 3935          
 3936          return True
 3937      
 3938      def get_config(self) -> dict:
 3939          """è·å–é…ç½®å­—å…¸"""
 3940          return {
 3941              'host': self.host_edit.text(),
 3942              'port': self.port_spin.value(),
 3943              'username': self.username_edit.text(),
 3944              'password': self.password_edit.text(),
 3945              'shared_folder': self.share_folder_edit.text(),
 3946              'enable_tls': self.tls_check.isChecked(),
 3947              'cert_file': self.cert_file_edit.text() if self.tls_check.isChecked() else '',
 3948              'key_file': self.key_file_edit.text() if self.tls_check.isChecked() else '',
 3949              'passive_ports': (self.passive_start_spin.value(), self.passive_end_spin.value()),
 3950              'max_cons': self.max_cons_spin.value(),
 3951              'max_cons_per_ip': self.max_cons_per_ip_spin.value(),
 3952          }
 3953      
 3954      def set_config(self, config: dict):
 3955          """è®¾ç½®é…ç½®"""
 3956          self.host_edit.setText(config.get('host', '0.0.0.0'))
 3957          self.port_spin.setValue(config.get('port', 2121))
 3958          self.username_edit.setText(config.get('username', 'upload_user'))
 3959          self.password_edit.setText(config.get('password', 'upload_pass'))
 3960          self.share_folder_edit.setText(config.get('shared_folder', 'D:/FTP_Share'))
 3961          

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 81 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 3962          self.tls_check.setChecked(config.get('enable_tls', False))
 3963          self.cert_file_edit.setText(config.get('cert_file', ''))
 3964          self.key_file_edit.setText(config.get('key_file', ''))
 3965          
 3966          passive_ports = config.get('passive_ports', (60000, 65535))
 3967          self.passive_start_spin.setValue(passive_ports[0])
 3968          self.passive_end_spin.setValue(passive_ports[1])
 3969          
 3970          self.max_cons_spin.setValue(config.get('max_cons', 256))
 3971          self.max_cons_per_ip_spin.setValue(config.get('max_cons_per_ip', 5))
 3972      
 3973      def set_config_editable(self, editable: bool):
 3974          """è®¾ç½®é…ç½®æ˜¯å¦å¯ç¼–è¾‘"""
 3975          self.host_edit.setEnabled(editable)
 3976          self.port_spin.setEnabled(editable)
 3977          self.username_edit.setEnabled(editable)
 3978          self.password_edit.setEnabled(editable)
 3979          self.share_folder_edit.setEnabled(editable)
 3980          self.tls_check.setEnabled(editable)
 3981          self.cert_file_edit.setEnabled(editable and self.tls_check.isChecked())
 3982          self.key_file_edit.setEnabled(editable and self.tls_check.isChecked())
 3983          self.passive_start_spin.setEnabled(editable)
 3984          self.passive_end_spin.setEnabled(editable)
 3985          self.max_cons_spin.setEnabled(editable)
 3986          self.max_cons_per_ip_spin.setEnabled(editable)
 3987      
 3988      def update_status(self, status: dict):
 3989          """æ›´æ–°çŠ¶æ€æ˜¾ç¤º"""
 3990          if status.get('running', False):
 3991              # ä½¿ç”¨ä¸»é¢˜è‰²æ˜¾ç¤ºè¿è¡ŒçŠ¶æ€
 3992              self.status_label.setText(f"âœ“ è¿è¡Œä¸­ - {status.get('address', 'N/A')}")
 3993              self.status_label.setStyleSheet("color: #166534; font-weight: bold;")  # ç»¿è‰²æˆåŠŸçŠ¶æ€
 3994              
 3995              connections = status.get('connections', 0)
 3996              self.connections_label.setText(f"è¿æ¥æ•°: {connections}")
 3997          else:
 3998              self.status_label.setText("æœªå¯åŠ¨")
 3999              self.status_label.setStyleSheet("color: #6B7280;")  # ç°è‰²
 4000              self.connections_label.setText("è¿æ¥æ•°: 0")
 4001  
 4002  
 4003  class FTPClientConfigWidget(QWidget):
 4004      """
 4005      FTP å®¢æˆ·ç«¯é…ç½®é¢æ¿
 4006      
 4007      åŠŸèƒ½ï¼š
 4008      - å¤šå®¢æˆ·ç«¯ç®¡ç†ï¼ˆåˆ—è¡¨ï¼‰
 4009      - æ·»åŠ /åˆ é™¤/ç¼–è¾‘å®¢æˆ·ç«¯
 4010      - å®¢æˆ·ç«¯é…ç½®ï¼ˆæœåŠ¡å™¨åœ°å€ã€ç«¯å£ã€è®¤è¯ã€è·¯å¾„ï¼‰
 4011      - è¿æ¥æµ‹è¯•

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 82 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 4012      - çŠ¶æ€æ˜¾ç¤º
 4013      """
 4014      
 4015      # ä¿¡å·å®šä¹‰
 4016      add_client_signal = Signal(str, dict)      # æ·»åŠ å®¢æˆ·ç«¯ä¿¡å· (name, config)
 4017      remove_client_signal = Signal(str)         # ç§»é™¤å®¢æˆ·ç«¯ä¿¡å· (name)
 4018      test_client_signal = Signal(str)           # æµ‹è¯•å®¢æˆ·ç«¯ä¿¡å· (name)
 4019      
 4020      def __init__(self, parent=None):
 4021          super().__init__(parent)
 4022          self.current_client_name = None
 4023          self.init_ui()
 4024      
 4025      def init_ui(self):
 4026          """åˆå§‹åŒ–ç•Œé¢"""
 4027          layout = QHBoxLayout(self)
 4028          layout.setContentsMargins(0, 0, 0, 0)
 4029          
 4030          # å·¦ä¾§å¡ç‰‡ï¼šå®¢æˆ·ç«¯åˆ—è¡¨
 4031          left_card = QFrame(self)
 4032          left_card.setObjectName("Card")
 4033          left_panel = QVBoxLayout(left_card)
 4034          
 4035          list_label = QLabel("FTP å®¢æˆ·ç«¯åˆ—è¡¨")
 4036          list_label.setProperty("class", "Title")
 4037          left_panel.addWidget(list_label)
 4038          
 4039          self.client_list = QListWidget()
 4040          self.client_list.itemClicked.connect(self.on_client_selected)
 4041          left_panel.addWidget(self.client_list)
 4042          
 4043          # åˆ—è¡¨æ“ä½œæŒ‰é’®ï¼ˆä½¿ç”¨ Secondary æ ·å¼ï¼‰
 4044          list_btn_layout = QHBoxLayout()
 4045          
 4046          add_btn = QPushButton("æ–°å¢")
 4047          add_btn.clicked.connect(self.on_add_client)
 4048          add_btn.setProperty("class", "Secondary")
 4049          list_btn_layout.addWidget(add_btn)
 4050          
 4051          self.remove_btn = QPushButton("åˆ é™¤")
 4052          self.remove_btn.clicked.connect(self.on_remove_client)
 4053          self.remove_btn.setEnabled(False)
 4054          self.remove_btn.setProperty("class", "Danger")
 4055          list_btn_layout.addWidget(self.remove_btn)
 4056          
 4057          left_panel.addLayout(list_btn_layout)
 4058          
 4059          layout.addWidget(left_card, 1)
 4060          
 4061          # å³ä¾§å¡ç‰‡ï¼šå®¢æˆ·ç«¯é…ç½®

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 83 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 4062          right_card = QFrame(self)
 4063          right_card.setObjectName("Card")
 4064          right_panel = QVBoxLayout(right_card)
 4065          
 4066          config_label = QLabel("å®¢æˆ·ç«¯é…ç½®")
 4067          config_label.setProperty("class", "Title")
 4068          right_panel.addWidget(config_label)
 4069          
 4070          # é…ç½®è¡¨å•
 4071          form_layout = QFormLayout()
 4072          
 4073          # å®¢æˆ·ç«¯åç§°
 4074          self.name_edit = QLineEdit()
 4075          self.name_edit.setPlaceholderText("FTPå®¢æˆ·ç«¯1")
 4076          form_layout.addRow("åç§°:", self.name_edit)
 4077          
 4078          # æœåŠ¡å™¨åœ°å€
 4079          self.host_edit = QLineEdit()
 4080          self.host_edit.setPlaceholderText("ftp.example.com")
 4081          form_layout.addRow("æœåŠ¡å™¨:", self.host_edit)
 4082          
 4083          # ç«¯å£
 4084          self.port_spin = QSpinBox()
 4085          self.port_spin.setRange(1, 65535)
 4086          self.port_spin.setValue(21)
 4087          form_layout.addRow("ç«¯å£:", self.port_spin)
 4088          
 4089          # ç”¨æˆ·å
 4090          self.username_edit = QLineEdit()
 4091          self.username_edit.setPlaceholderText("ç”¨æˆ·å")
 4092          form_layout.addRow("ç”¨æˆ·å:", self.username_edit)
 4093          
 4094          # å¯†ç 
 4095          self.password_edit = QLineEdit()
 4096          self.password_edit.setEchoMode(QLineEdit.EchoMode.Password)
 4097          self.password_edit.setPlaceholderText("å¯†ç ")
 4098          form_layout.addRow("å¯†ç :", self.password_edit)
 4099          
 4100          # è¿œç¨‹è·¯å¾„
 4101          self.remote_path_edit = QLineEdit("/upload")
 4102          self.remote_path_edit.setPlaceholderText("/upload/photos")
 4103          form_layout.addRow("è¿œç¨‹è·¯å¾„:", self.remote_path_edit)
 4104          
 4105          # TLS
 4106          self.tls_check = QCheckBox("ä½¿ç”¨ FTPS (TLS/SSL)")
 4107          form_layout.addRow("åŠ å¯†:", self.tls_check)
 4108          
 4109          # è¢«åŠ¨æ¨¡å¼
 4110          self.passive_check = QCheckBox("ä½¿ç”¨è¢«åŠ¨æ¨¡å¼ï¼ˆæ¨èï¼‰")
 4111          self.passive_check.setChecked(True)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 84 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 4112          form_layout.addRow("è¿æ¥æ¨¡å¼:", self.passive_check)
 4113          
 4114          # è¶…æ—¶æ—¶é—´
 4115          self.timeout_spin = QSpinBox()
 4116          self.timeout_spin.setRange(5, 300)
 4117          self.timeout_spin.setValue(30)
 4118          self.timeout_spin.setSuffix(" ç§’")
 4119          form_layout.addRow("è¶…æ—¶æ—¶é—´:", self.timeout_spin)
 4120          
 4121          # é‡è¯•æ¬¡æ•°
 4122          self.retry_spin = QSpinBox()
 4123          self.retry_spin.setRange(1, 10)
 4124          self.retry_spin.setValue(3)
 4125          self.retry_spin.setSuffix(" æ¬¡")
 4126          form_layout.addRow("é‡è¯•æ¬¡æ•°:", self.retry_spin)
 4127          
 4128          right_panel.addLayout(form_layout)
 4129          
 4130          # æ“ä½œæŒ‰é’®ï¼ˆä½¿ç”¨ä¸»é¢˜æ ·å¼ï¼‰
 4131          btn_layout = QHBoxLayout()
 4132          
 4133          self.save_btn = QPushButton("ä¿å­˜é…ç½®")
 4134          self.save_btn.clicked.connect(self.on_save_config)
 4135          self.save_btn.setEnabled(False)
 4136          self.save_btn.setProperty("class", "Primary")
 4137          btn_layout.addWidget(self.save_btn)
 4138          
 4139          self.test_btn = QPushButton("æµ‹è¯•è¿æ¥")
 4140          self.test_btn.clicked.connect(self.on_test_connection)
 4141          self.test_btn.setEnabled(False)
 4142          self.test_btn.setProperty("class", "Secondary")
 4143          btn_layout.addWidget(self.test_btn)
 4144          
 4145          right_panel.addLayout(btn_layout)
 4146          
 4147          # çŠ¶æ€æ˜¾ç¤º
 4148          self.status_label = QLabel("è¯·é€‰æ‹©æˆ–æ–°å¢å®¢æˆ·ç«¯")
 4149          self.status_label.setStyleSheet("color: #6B7280;")  # ç°è‰²æç¤ºæ–‡å­—
 4150          right_panel.addWidget(self.status_label)
 4151          
 4152          right_panel.addStretch()
 4153          
 4154          layout.addWidget(right_card, 2)
 4155      
 4156      def on_client_selected(self, item):
 4157          """å®¢æˆ·ç«¯åˆ—è¡¨é¡¹è¢«é€‰ä¸­"""
 4158          self.current_client_name = item.text()
 4159          self.remove_btn.setEnabled(True)
 4160          self.save_btn.setEnabled(True)
 4161          self.test_btn.setEnabled(True)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 85 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 4162          
 4163          # åŠ è½½é…ç½®ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…éœ€è¦ä»å¤–éƒ¨è·å–ï¼‰
 4164          self.status_label.setText(f"å·²é€‰æ‹©: {self.current_client_name}")
 4165          self.status_label.setStyleSheet("color: #1976D2; font-weight: bold;")  # ä¸»é¢˜è“è‰²
 4166      
 4167      def on_add_client(self):
 4168          """æ·»åŠ æ–°å®¢æˆ·ç«¯"""
 4169          # éªŒè¯é…ç½®
 4170          if not self.validate_config():
 4171              return
 4172          
 4173          name = self.name_edit.text().strip()
 4174          if not name:
 4175              QMessageBox.warning(self, "è¾“å…¥é”™è¯¯", "è¯·è¾“å…¥å®¢æˆ·ç«¯åç§°")
 4176              return
 4177          
 4178          # æ£€æŸ¥é‡å¤
 4179          for i in range(self.client_list.count()):
 4180              if self.client_list.item(i).text() == name:
 4181                  QMessageBox.warning(self, "é‡å¤åç§°", f"å®¢æˆ·ç«¯ '{name}' å·²å­˜åœ¨")
 4182                  return
 4183          
 4184          # è·å–é…ç½®
 4185          config = self.get_config()
 4186          
 4187          # å‘å°„ä¿¡å·
 4188          self.add_client_signal.emit(name, config)
 4189          
 4190          # æ·»åŠ åˆ°åˆ—è¡¨
 4191          item = QListWidgetItem(name)
 4192          self.client_list.addItem(item)
 4193          
 4194          # æ¸…ç©ºè¡¨å•
 4195          self.clear_form()
 4196          
 4197          QMessageBox.information(self, "æˆåŠŸ", f"å®¢æˆ·ç«¯ '{name}' å·²æ·»åŠ ")
 4198      
 4199      def on_remove_client(self):
 4200          """åˆ é™¤å®¢æˆ·ç«¯"""
 4201          if not self.current_client_name:
 4202              return
 4203          
 4204          reply = QMessageBox.question(
 4205              self,
 4206              "ç¡®è®¤åˆ é™¤",
 4207              f"ç¡®å®šè¦åˆ é™¤å®¢æˆ·ç«¯ '{self.current_client_name}' å—ï¼Ÿ",
 4208              QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No
 4209          )
 4210          
 4211          if reply == QMessageBox.StandardButton.Yes:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 86 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 4212              # å‘å°„ä¿¡å·
 4213              self.remove_client_signal.emit(self.current_client_name)
 4214              
 4215              # ä»åˆ—è¡¨ä¸­ç§»é™¤
 4216              for i in range(self.client_list.count()):
 4217                  if self.client_list.item(i).text() == self.current_client_name:
 4218                      self.client_list.takeItem(i)
 4219                      break
 4220              
 4221              # æ¸…ç©ºè¡¨å•
 4222              self.clear_form()
 4223              self.current_client_name = None
 4224              self.remove_btn.setEnabled(False)
 4225              self.save_btn.setEnabled(False)
 4226              self.test_btn.setEnabled(False)
 4227      
 4228      def on_save_config(self):
 4229          """ä¿å­˜é…ç½®"""
 4230          if not self.current_client_name:
 4231              return
 4232          
 4233          if not self.validate_config():
 4234              return
 4235          
 4236          config = self.get_config()
 4237          
 4238          # è¿™é‡Œåº”è¯¥ä¿å­˜åˆ°é…ç½®æ–‡ä»¶æˆ–é€šçŸ¥ä¸»ç¨‹åº
 4239          # æš‚æ—¶åªæ˜¾ç¤ºæ¶ˆæ¯
 4240          QMessageBox.information(self, "æˆåŠŸ", f"å®¢æˆ·ç«¯ '{self.current_client_name}' é…ç½®å·²ä¿å­˜")
 4241      
 4242      def on_test_connection(self):
 4243          """æµ‹è¯•è¿æ¥"""
 4244          if not self.current_client_name:
 4245              return
 4246          
 4247          # å‘å°„ä¿¡å·
 4248          self.test_client_signal.emit(self.current_client_name)
 4249      
 4250      def validate_config(self) -> bool:
 4251          """éªŒè¯é…ç½®"""
 4252          if not self.host_edit.text().strip():
 4253              QMessageBox.warning(self, "è¾“å…¥é”™è¯¯", "è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€")
 4254              return False
 4255          
 4256          if not self.username_edit.text().strip():
 4257              QMessageBox.warning(self, "è¾“å…¥é”™è¯¯", "è¯·è¾“å…¥ç”¨æˆ·å")
 4258              return False
 4259          
 4260          if not self.password_edit.text().strip():
 4261              QMessageBox.warning(self, "è¾“å…¥é”™è¯¯", "è¯·è¾“å…¥å¯†ç ")

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 87 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 4262              return False
 4263          
 4264          return True
 4265      
 4266      def get_config(self) -> dict:
 4267          """è·å–é…ç½®å­—å…¸"""
 4268          return {
 4269              'name': self.name_edit.text().strip(),
 4270              'host': self.host_edit.text().strip(),
 4271              'port': self.port_spin.value(),
 4272              'username': self.username_edit.text().strip(),
 4273              'password': self.password_edit.text(),
 4274              'remote_path': self.remote_path_edit.text().strip(),
 4275              'enable_tls': self.tls_check.isChecked(),
 4276              'passive_mode': self.passive_check.isChecked(),
 4277              'timeout': self.timeout_spin.value(),
 4278              'retry_count': self.retry_spin.value(),
 4279          }
 4280      
 4281      def set_config(self, config: dict):
 4282          """è®¾ç½®é…ç½®"""
 4283          self.name_edit.setText(config.get('name', ''))
 4284          self.host_edit.setText(config.get('host', ''))
 4285          self.port_spin.setValue(config.get('port', 21))
 4286          self.username_edit.setText(config.get('username', ''))
 4287          self.password_edit.setText(config.get('password', ''))
 4288          self.remote_path_edit.setText(config.get('remote_path', '/upload'))
 4289          self.tls_check.setChecked(config.get('enable_tls', False))
 4290          self.passive_check.setChecked(config.get('passive_mode', True))
 4291          self.timeout_spin.setValue(config.get('timeout', 30))
 4292          self.retry_spin.setValue(config.get('retry_count', 3))
 4293      
 4294      def clear_form(self):
 4295          """æ¸…ç©ºè¡¨å•"""
 4296          self.name_edit.clear()
 4297          self.host_edit.clear()
 4298          self.port_spin.setValue(21)
 4299          self.username_edit.clear()
 4300          self.password_edit.clear()
 4301          self.remote_path_edit.setText("/upload")
 4302          self.tls_check.setChecked(False)
 4303          self.passive_check.setChecked(True)
 4304          self.timeout_spin.setValue(30)
 4305          self.retry_spin.setValue(3)
 4306          self.status_label.setText("è¯·é€‰æ‹©æˆ–æ–°å¢å®¢æˆ·ç«¯")
 4307          self.status_label.setStyleSheet("color: #6B7280;")  # ç°è‰²
 4308      
 4309      def update_client_status(self, name: str, status: dict):
 4310          """æ›´æ–°å®¢æˆ·ç«¯çŠ¶æ€"""
 4311          if name != self.current_client_name:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 88 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 4312              return
 4313          
 4314          if status.get('connected', False):
 4315              self.status_label.setText(f"âœ“ å·²è¿æ¥åˆ° {status.get('host')}")
 4316              self.status_label.setStyleSheet("color: #166534; font-weight: bold;")  # ç»¿è‰²æˆåŠŸçŠ¶æ€
 4317          else:
 4318              self.status_label.setText(f"æœªè¿æ¥")
 4319              self.status_label.setStyleSheet("color: #B91C1C; font-weight: bold;")  # çº¢è‰²é”™è¯¯çŠ¶æ€
 4320  
 4321  
 4322  class ProtocolSelectorWidget(QWidget):
 4323      """
 4324      åè®®é€‰æ‹©å™¨ç»„ä»¶
 4325      
 4326      åŠŸèƒ½ï¼š
 4327      - é€‰æ‹©ä¸Šä¼ åè®®ï¼ˆSMB / FTP Server / FTP Client / æ··åˆæ¨¡å¼ï¼‰
 4328      - æ ¹æ®é€‰æ‹©æ˜¾ç¤ºå¯¹åº”çš„é…ç½®é¢æ¿
 4329      """
 4330      
 4331      # ä¿¡å·å®šä¹‰
 4332      protocol_changed_signal = Signal(str)  # åè®®åˆ‡æ¢ä¿¡å·
 4333      
 4334      def __init__(self, parent=None):
 4335          super().__init__(parent)
 4336          self.init_ui()
 4337      
 4338      def init_ui(self):
 4339          """åˆå§‹åŒ–ç•Œé¢"""
 4340          layout = QVBoxLayout(self)
 4341          layout.setContentsMargins(0, 0, 0, 0)
 4342          
 4343          # ä½¿ç”¨ Card é£æ ¼
 4344          card = QFrame(self)
 4345          card.setObjectName("Card")
 4346          card_layout = QVBoxLayout(card)
 4347          
 4348          # åè®®é€‰æ‹©
 4349          selector_layout = QHBoxLayout()
 4350          
 4351          label = QLabel("ä¸Šä¼ åè®®:")
 4352          label.setProperty("class", "Title")
 4353          selector_layout.addWidget(label)
 4354          
 4355          self.protocol_combo = QComboBox()
 4356          self.protocol_combo.addItems([
 4357              "SMB (ç½‘ç»œå…±äº«)",
 4358              "FTP æœåŠ¡å™¨æ¨¡å¼",
 4359              "FTP å®¢æˆ·ç«¯æ¨¡å¼",
 4360              "æ··åˆæ¨¡å¼ (FTP Server + Client)"
 4361          ])

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 89 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 4362          self.protocol_combo.currentIndexChanged.connect(self.on_protocol_changed)
 4363          selector_layout.addWidget(self.protocol_combo)
 4364          
 4365          selector_layout.addStretch()
 4366          
 4367          card_layout.addLayout(selector_layout)
 4368          
 4369          # è¯´æ˜æ–‡æœ¬ï¼ˆä½¿ç”¨ä¸»é¢˜ç°è‰²ï¼‰
 4370          self.desc_label = QLabel()
 4371          self.desc_label.setWordWrap(True)
 4372          self.desc_label.setStyleSheet("color: #6B7280; padding: 8px; background: #F3F4F6; border-radius: 6px;")
 4373          card_layout.addWidget(self.desc_label)
 4374          
 4375          layout.addWidget(card)
 4376          
 4377          # æ›´æ–°è¯´æ˜
 4378          self.update_description(0)
 4379      
 4380      def on_protocol_changed(self, index):
 4381          """åè®®é€‰æ‹©å˜åŒ–"""
 4382          self.update_description(index)
 4383          
 4384          # å‘å°„ä¿¡å·
 4385          protocols = ['smb', 'ftp_server', 'ftp_client', 'both']
 4386          self.protocol_changed_signal.emit(protocols[index])
 4387      
 4388      def update_description(self, index):
 4389          """æ›´æ–°åè®®è¯´æ˜"""
 4390          descriptions = [
 4391              "ğŸ“ SMB (ç½‘ç»œå…±äº«)ï¼šé€šè¿‡ Windows ç½‘ç»œå…±äº«ä¸Šä¼ æ–‡ä»¶ï¼Œéœ€è¦ç›®æ ‡ä¸ºå…±äº«æ–‡ä»¶å¤¹ã€‚",
 4392              "ğŸ–¥ï¸ FTP æœåŠ¡å™¨æ¨¡å¼ï¼šæœ¬æœºä½œä¸º FTP æœåŠ¡å™¨ï¼Œå…¶ä»–è®¾å¤‡å¯è¿æ¥ä¸Šä¼ æ–‡ä»¶ã€‚",
 4393              "ğŸ“¤ FTP å®¢æˆ·ç«¯æ¨¡å¼ï¼šæœ¬æœºä½œä¸º FTP å®¢æˆ·ç«¯ï¼Œè¿æ¥åˆ°è¿œç¨‹ FTP æœåŠ¡å™¨ä¸Šä¼ æ–‡ä»¶ã€‚",
 4394              "ğŸ”„ æ··åˆæ¨¡å¼ï¼šåŒæ—¶è¿è¡Œ FTP æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ï¼Œçµæ´»åº”å¯¹ä¸åŒåœºæ™¯ã€‚"
 4395          ]
 4396          self.desc_label.setText(descriptions[index])
 4397      
 4398      def get_current_protocol(self) -> str:
 4399          """è·å–å½“å‰é€‰æ‹©çš„åè®®"""
 4400          protocols = ['smb', 'ftp_server', 'ftp_client', 'both']
 4401          return protocols[self.protocol_combo.currentIndex()]
 4402      
 4403      def set_protocol(self, protocol: str):
 4404          """è®¾ç½®åè®®"""
 4405          protocol_map = {
 4406              'smb': 0,
 4407              'ftp_server': 1,
 4408              'ftp_client': 2,
 4409              'both': 3
 4410          }
 4411          index = protocol_map.get(protocol, 0)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 90 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 4412          self.protocol_combo.setCurrentIndex(index)
 4413  
 4414  
 4415  # æµ‹è¯•ä»£ç 
 4416  if __name__ == "__main__":
 4417      import sys
 4418      from PySide6.QtWidgets import QApplication, QMainWindow, QTabWidget
 4419      
 4420      app = QApplication(sys.argv)
 4421      
 4422      # åˆ›å»ºä¸»çª—å£
 4423      window = QMainWindow()
 4424      window.setWindowTitle("FTP UI ç»„ä»¶æµ‹è¯• - v2.0 ä¸»é¢˜é£æ ¼")
 4425      window.setGeometry(100, 100, 1000, 750)
 4426      
 4427      # åº”ç”¨ä¸ pyqt_app.py å®Œå…¨ä¸€è‡´çš„ä¸»é¢˜æ ·å¼
 4428      window.setStyleSheet(
 4429          """
 4430          QWidget{font-family:'Segoe UI', 'Microsoft YaHei UI'; font-size:11pt; color:#1F2937; background:#E3F2FD;}
 4431          QMainWindow{background:#E3F2FD;}
 4432          QFrame#Card{background:#FFFFFF; border:2px solid #64B5F6; border-radius:10px; padding: 12px;}
 4433          QLabel{color:#1F2937;}
 4434          QLabel.Title{color:#1976D2; font-weight:700; font-size:14pt;}
 4435          QPushButton{font-size:11pt;}
 4436          QPushButton:disabled{background:#E5E7EB; color:#9CA3AF; border:1px solid #D1D5DB;}
 4437          QPushButton.Primary{background:#1976D2; color:#FFFFFF; border:none; border-radius:8px; padding:8px 12px;}
 4438          QPushButton.Primary:hover{background:#1E88E5;}
 4439          QPushButton.Primary:disabled{background:#BDBDBD; color:#FFFFFF;}
 4440          QPushButton.Secondary{background:#F1F5F9; color:#0F172A; border:1px solid #64B5F6; border-radius:8px; padding:6px 10px;}
 4441          QPushButton.Secondary:hover{background:#E3F2FD;}
 4442          QPushButton.Secondary:disabled{background:#E5E7EB; color:#9CA3AF;}
 4443          QPushButton.Warning{background:#FEF3C7; color:#A16207; border:1px solid #FCD34D; border-radius:8px; padding:6px 10px;}
 4444          QPushButton.Warning:hover{background:#FDE68A;}
 4445          QPushButton.Warning:disabled{background:#E5E7EB; color:#9CA3AF;}
 4446          QPushButton.Danger{background:#FEE2E2; color:#B91C1C; border:1px solid #FCA5A5; border-radius:8px; padding:6px 10px;}
 4447          QPushButton.Danger:hover{background:#FECACA;}
 4448          QPushButton.Danger:disabled{background:#E5E7EB; color:#9CA3AF;}
 4449          QProgressBar{border:1px solid #64B5F6; border-radius:6px; background:#EEF2F5; text-align:center; color:#1F2937;}
 4450          QProgressBar::chunk{border-radius:6px; background: qlineargradient(x1:0, y1:0, x2:1, y2:0, stop:0 #4FACFE, stop:1 #00F2FE);} 
 4451          QPlainTextEdit{background:#FFFFFF; border:1px solid #64B5F6; color:#1F2937; border-radius:4px;}
 4452          QSpinBox{background:#FFFFFF; color:#1F2937; border:1px solid #64B5F6; border-radius:4px; padding:4px;}
 4453          QSpinBox:disabled{background:#F3F4F6; color:#9CA3AF; border:1px solid #D1D5DB;}
 4454          QLineEdit{background:#FFFFFF; color:#1F2937; border:1px solid #64B5F6; border-radius:4px; padding:4px;}
 4455          QLineEdit:read-only{background:#F3F4F6; color:#6B7280; border:1px solid #D1D5DB;}
 4456          QCheckBox{color:#1F2937; spacing:8px;}
 4457          QCheckBox:disabled{color:#9CA3AF;}
 4458          QCheckBox::indicator{width:22px; height:22px; background:#FFFFFF; border:2px solid #64B5F6; border-radius:4px;}
 4459          QCheckBox::indicator:disabled{background:#F3F4F6; border:2px solid #D1D5DB;}
 4460          QCheckBox::indicator:checked{background:qlineargradient(x1:0, y1:0, x2:1, y2:1, stop:0 #1976D2, stop:1 #2196F3); border:2px solid #1976D2;}
 4461          QCheckBox::indicator:checked:disabled{background:#E0E0E0; border:2px solid #D1D5DB;}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 91 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 4462          QComboBox{background:#FFFFFF; color:#1F2937; border:1px solid #64B5F6; border-radius:4px; padding:4px;}
 4463          QComboBox:disabled{background:#F3F4F6; color:#9CA3AF; border:1px solid #D1D5DB;}
 4464          QComboBox::drop-down{border:none;}
 4465          QComboBox::down-arrow{image:none; border-left:4px solid transparent; border-right:4px solid transparent; border-top:6px solid #1976D2; margin-right:8px;}
 4466          QComboBox::down-arrow:disabled{border-top-color:#9CA3AF;}
 4467          QComboBox QAbstractItemView{background:#FFFFFF; color:#1F2937; border:1px solid #64B5F6; selection-background-color:#E3F2FD;}
 4468          QGroupBox{color:#1976D2; font-weight:600; border:1px solid #64B5F6; border-radius:6px; margin-top:8px; padding-top:8px;}
 4469          QGroupBox::title{subcontrol-origin:margin; left:10px; padding:0 5px;}
 4470          QListWidget{background:#FFFFFF; border:1px solid #64B5F6; border-radius:4px;}
 4471          QListWidget::item{padding:6px; border-radius:3px;}
 4472          QListWidget::item:selected{background:#E3F2FD; color:#1976D2;}
 4473          QListWidget::item:hover{background:#F1F5F9;}
 4474          QTabWidget::pane{border:2px solid #64B5F6; border-radius:8px; background:#FFFFFF;}
 4475          QTabBar::tab{background:#F1F5F9; border:1px solid #64B5F6; padding:8px 16px; border-top-left-radius:6px; border-top-right-radius:6px;}
 4476          QTabBar::tab:selected{background:#FFFFFF; color:#1976D2; font-weight:600;}
 4477          QTabBar::tab:hover{background:#E3F2FD;}
 4478          """
 4479      )
 4480      
 4481      # åˆ›å»ºæ ‡ç­¾é¡µ
 4482      tab_widget = QTabWidget()
 4483      tab_widget.setContentsMargins(8, 8, 8, 8)
 4484      
 4485      # åè®®é€‰æ‹©å™¨
 4486      protocol_selector = ProtocolSelectorWidget()
 4487      tab_widget.addTab(protocol_selector, "åè®®é€‰æ‹©")
 4488      
 4489      # FTP æœåŠ¡å™¨é…ç½®
 4490      server_widget = FTPServerConfigWidget()
 4491      tab_widget.addTab(server_widget, "FTP æœåŠ¡å™¨")
 4492      
 4493      # FTP å®¢æˆ·ç«¯é…ç½®
 4494      client_widget = FTPClientConfigWidget()
 4495      tab_widget.addTab(client_widget, "FTP å®¢æˆ·ç«¯")
 4496      
 4497      window.setCentralWidget(tab_widget)
 4498      window.show()
 4499      
 4500      sys.exit(app.exec())
       
       # ============================================================
       # æ–‡ä»¶: src\main.py
       # ============================================================
 4501  # -*- coding: utf-8 -*-
 4502  """
 4503  å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…· - ä¸»ç¨‹åºå…¥å£ (æ¨¡å—åŒ–ç‰ˆæœ¬)
 4504  
 4505  v3.1.0 - æ–­ç‚¹ç»­ä¼ ã€ä¸­è‹±æ–‡åˆ‡æ¢ã€é…ç½®åŠ è½½ä¿®å¤
 4506  - ä½¿ç”¨æ–°çš„æ¨¡å—åŒ–ç»“æ„
 4507  - ä¿æŒä¸ pyqt_app.py çš„å…¼å®¹æ€§

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 92 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 4508  """
 4509  import sys
 4510  import os
 4511  from pathlib import Path
 4512  
 4513  # æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ° Python è·¯å¾„
 4514  project_root = Path(__file__).parent.parent
 4515  if str(project_root) not in sys.path:
 4516      sys.path.insert(0, str(project_root))
 4517  
 4518  # åˆ‡æ¢å·¥ä½œç›®å½•åˆ°é¡¹ç›®æ ¹ç›®å½•ï¼ˆç¡®ä¿é…ç½®æ–‡ä»¶èƒ½è¢«æ­£ç¡®æ‰¾åˆ°ï¼‰
 4519  os.chdir(project_root)
 4520  
 4521  # å¯¼å…¥æ ¸å¿ƒæ¨¡å—
 4522  from src.core import get_app_dir, get_app_version, get_app_title
 4523  from src.config import ConfigManager
 4524  
 4525  # å¯¼å…¥ Qt åº“
 4526  try:
 4527      from PySide6 import QtCore, QtWidgets
 4528      from PySide6.QtNetwork import QLocalServer, QLocalSocket
 4529      QT_LIB = 'PySide6'
 4530  except ImportError:
 4531      try:
 4532          from PyQt5 import QtCore, QtWidgets  # type: ignore[import-not-found]
 4533          from PyQt5.QtNetwork import QLocalServer, QLocalSocket  # type: ignore[import-not-found]
 4534          QT_LIB = 'PyQt5'
 4535      except ImportError:
 4536          raise ImportError("Neither PySide6 nor PyQt5 is installed.")
 4537  
 4538  # å¯¼å…¥ä¸»çª—å£
 4539  from src.ui import MainWindow
 4540  
 4541  
 4542  def check_single_instance(server_name: str) -> bool:
 4543      """æ£€æŸ¥å¹¶å°è¯•å”¤é†’å·²è¿è¡Œçš„å®ä¾‹
 4544      
 4545      Args:
 4546          server_name: æœåŠ¡å™¨åç§°
 4547          
 4548      Returns:
 4549          True - æ˜¯æ–°å®ä¾‹ï¼Œåº”è¯¥ç»§ç»­å¯åŠ¨
 4550          False - å·²æœ‰å®ä¾‹è¿è¡Œï¼Œå·²å‘é€å”¤é†’æ¶ˆæ¯
 4551      """
 4552      socket = QLocalSocket()
 4553      socket.connectToServer(server_name)
 4554      
 4555      # å°è¯•è¿æ¥åˆ°å·²è¿è¡Œçš„å®ä¾‹
 4556      if socket.waitForConnected(500):  # ç­‰å¾…500ms
 4557          # è¿æ¥æˆåŠŸï¼Œè¯´æ˜ç¨‹åºå·²åœ¨è¿è¡Œ

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 93 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 4558          # å‘é€å”¤é†’æ¶ˆæ¯
 4559          socket.write(b"WAKEUP")
 4560          socket.flush()
 4561          socket.waitForBytesWritten(1000)
 4562          socket.disconnectFromServer()
 4563          return False  # ä¸æ˜¯æ–°å®ä¾‹
 4564      
 4565      # è¿æ¥å¤±è´¥ï¼Œè¯´æ˜æ²¡æœ‰å…¶ä»–å®ä¾‹åœ¨è¿è¡Œ
 4566      return True  # æ˜¯æ–°å®ä¾‹
 4567  
 4568  
 4569  def main():
 4570      """ä¸»ç¨‹åºå…¥å£"""
 4571      app = QtWidgets.QApplication(sys.argv)
 4572      
 4573      # è®¾ç½®åº”ç”¨ç¨‹åºä¿¡æ¯
 4574      app.setApplicationName("å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·")
 4575      app.setApplicationVersion(get_app_version())
 4576      app.setOrganizationName("RelMoTong")
 4577      
 4578      # å•ä¾‹æ£€æŸ¥
 4579      server_name = "ImageUploadTool_SingleInstance_Server"
 4580      if not check_single_instance(server_name):
 4581          # å·²æœ‰å®ä¾‹è¿è¡Œï¼Œå·²å‘é€å”¤é†’æ¶ˆæ¯ï¼Œç›´æ¥é€€å‡º
 4582          return 0
 4583      
 4584      # ä½¿ç”¨å…±äº«å†…å­˜ä½œä¸ºè¾…åŠ©é”ï¼ˆé˜²æ­¢æç«¯æƒ…å†µä¸‹çš„ç«æ€æ¡ä»¶ï¼‰
 4585      shared_mem = QtCore.QSharedMemory("ImageUploadTool_SingleInstance")
 4586      if not shared_mem.create(1):
 4587          # æå°‘æƒ…å†µï¼šLocalServer æœªå“åº”ä½†å…±äº«å†…å­˜å­˜åœ¨
 4588          msg = QtWidgets.QMessageBox()
 4589          msg.setIcon(QtWidgets.QMessageBox.Icon.Warning)
 4590          msg.setWindowTitle("ç¨‹åºå¯åŠ¨å¼‚å¸¸")
 4591          msg.setText("æ£€æµ‹åˆ°ç¨‹åºå¯èƒ½æœªæ­£å¸¸é€€å‡º")
 4592          msg.setInformativeText("å»ºè®®ï¼š\n1. æ£€æŸ¥ä»»åŠ¡ç®¡ç†å™¨æ˜¯å¦æœ‰æ®‹ç•™è¿›ç¨‹\n2. é‡å¯è®¡ç®—æœºåé‡è¯•")
 4593          msg.setStandardButtons(QtWidgets.QMessageBox.StandardButton.Ok)
 4594          msg.exec() if hasattr(msg, 'exec') else msg.exec_()
 4595          return 1
 4596      
 4597      # åˆ›å»ºä¸»çª—å£
 4598      window = MainWindow()
 4599      window.show()
 4600      
 4601      # å¯åŠ¨åº”ç”¨ç¨‹åºäº‹ä»¶å¾ªç¯
 4602      try:
 4603          return app.exec()  # PySide6 / PyQt6
 4604      except AttributeError:
 4605          return app.exec_()  # PyQt5
 4606  
 4607  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 94 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 4608  if __name__ == '__main__':
 4609      sys.exit(main())
       
       # ============================================================
       # æ–‡ä»¶: src\protocols\__init__.py
       # ============================================================
 4610  # -*- coding: utf-8 -*-
 4611  """
 4612  Protocols æ¨¡å— - ç½‘ç»œåè®®å®ç°
 4613  
 4614  åŒ…å«ï¼š
 4615  - ftp.py: FTP/FTPS åè®®ç®¡ç†å™¨ï¼ˆæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ï¼‰
 4616  """
 4617  
 4618  from .ftp import FTPProtocolManager, FTPServerManager, FTPClientUploader
 4619  
 4620  __all__ = ['FTPProtocolManager', 'FTPServerManager', 'FTPClientUploader']
       
       # ============================================================
       # æ–‡ä»¶: src\protocols\ftp.py
       # ============================================================
 4621  # -*- coding: utf-8 -*-
 4622  """
 4623  FTP/FTPS åè®®å¤„ç†æ¨¡å—
 4624  æ”¯æŒ FTP æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯åŠŸèƒ½
 4625  
 4626  ç‰ˆæœ¬: v2.0
 4627  æ—¥æœŸ: 2025-11-10
 4628  ä½œè€…: å¼€å‘å›¢é˜Ÿ
 4629  """
 4630  
 4631  import os
 4632  import threading
 4633  import logging
 4634  import time
 4635  from pathlib import Path
 4636  from ftplib import FTP, FTP_TLS, error_perm
 4637  from pyftpdlib.authorizers import DummyAuthorizer
 4638  from pyftpdlib.handlers import FTPHandler
 4639  try:
 4640      from pyftpdlib.handlers import TLS_FTPHandler
 4641  except ImportError:
 4642      # æ—§ç‰ˆæœ¬çš„ pyftpdlib ä¸­ TLS_FTPHandler å¯èƒ½ä¸å­˜åœ¨
 4643      TLS_FTPHandler = None  # type: ignore
 4644  from pyftpdlib.servers import FTPServer
 4645  from typing import Optional, Callable, Tuple, Dict, List, Union, cast
 4646  from queue import Queue
 4647  
 4648  # é…ç½®æ—¥å¿—
 4649  logger = logging.getLogger(__name__)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 95 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 4650  
 4651  
 4652  class FTPServerManager:
 4653      """
 4654      FTP æœåŠ¡å™¨ç®¡ç†å™¨
 4655      
 4656      åŠŸèƒ½ï¼š
 4657      - å¯åŠ¨/åœæ­¢ FTP æœåŠ¡å™¨
 4658      - ç”¨æˆ·è®¤è¯ç®¡ç†
 4659      - å…±äº«ç›®å½•é…ç½®
 4660      - è¢«åŠ¨æ¨¡å¼æ”¯æŒ
 4661      - FTPS (TLS/SSL) æ”¯æŒ
 4662      - è¿æ¥æ•°é™åˆ¶
 4663      - çŠ¶æ€ç›‘æ§
 4664      """
 4665      
 4666      def __init__(self, config: dict):
 4667          """
 4668          åˆå§‹åŒ– FTP æœåŠ¡å™¨
 4669          
 4670          Args:
 4671              config: é…ç½®å­—å…¸
 4672                  {
 4673                      'host': '0.0.0.0',              # ç›‘å¬åœ°å€
 4674                      'port': 21,                      # ç«¯å£
 4675                      'username': 'upload_user',       # FTP ç”¨æˆ·å
 4676                      'password': 'upload_pass',       # FTP å¯†ç 
 4677                      'shared_folder': 'D:/FTP_Share', # å…±äº«ç›®å½•
 4678                      'enable_tls': False,             # æ˜¯å¦å¯ç”¨ TLS
 4679                      'cert_file': '',                 # TLS è¯ä¹¦æ–‡ä»¶
 4680                      'key_file': '',                  # TLS å¯†é’¥æ–‡ä»¶
 4681                      'passive_ports': (60000, 65535), # è¢«åŠ¨æ¨¡å¼ç«¯å£èŒƒå›´
 4682                      'max_cons': 256,                 # æœ€å¤§è¿æ¥æ•°
 4683                      'max_cons_per_ip': 5,            # æ¯ä¸ªIPæœ€å¤§è¿æ¥æ•°
 4684                  }
 4685          """
 4686          self.config = config
 4687          self.server: Optional[FTPServer] = None
 4688          self.server_thread: Optional[threading.Thread] = None
 4689          self.is_running = False
 4690          self._stop_event = threading.Event()
 4691          
 4692          # ç¡®ä¿å…±äº«ç›®å½•å­˜åœ¨
 4693          shared_folder = Path(config.get('shared_folder', 'D:/FTP_Share'))
 4694          shared_folder.mkdir(parents=True, exist_ok=True)
 4695          
 4696          logger.info(f"FTP æœåŠ¡å™¨ç®¡ç†å™¨åˆå§‹åŒ–: {config.get('host')}:{config.get('port')}")
 4697      
 4698      def start(self) -> bool:
 4699          """

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 96 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 4700          å¯åŠ¨ FTP æœåŠ¡å™¨
 4701          
 4702          Returns:
 4703              bool: å¯åŠ¨æ˜¯å¦æˆåŠŸ
 4704          """
 4705          if self.is_running:
 4706              logger.warning("FTP æœåŠ¡å™¨å·²åœ¨è¿è¡Œ")
 4707              return False
 4708          
 4709          try:
 4710              # åˆ›å»ºæˆæƒå™¨
 4711              authorizer = DummyAuthorizer()
 4712              
 4713              # æ·»åŠ ç”¨æˆ·ï¼ˆå¯è¯»å†™ï¼‰
 4714              username = self.config.get('username', 'upload_user')
 4715              password = self.config.get('password', 'upload_pass')
 4716              shared_folder = str(self.config.get('shared_folder', 'D:/FTP_Share'))
 4717              
 4718              authorizer.add_user(
 4719                  username=username,
 4720                  password=password,
 4721                  homedir=shared_folder,
 4722                  perm='elradfmwMT'  # å®Œæ•´æƒé™
 4723              )
 4724              
 4725              logger.info(f"å·²æ·»åŠ  FTP ç”¨æˆ·: {username}")
 4726              
 4727              # åˆ›å»ºå¤„ç†å™¨
 4728              if self.config.get('enable_tls', False):
 4729                  # FTPS å¤„ç†å™¨
 4730                  if TLS_FTPHandler is None:
 4731                      logger.error("å½“å‰ pyftpdlib ç‰ˆæœ¬ä¸æ”¯æŒ FTPSï¼Œè¯·å‡çº§æˆ–ç¦ç”¨ TLS")
 4732                      return False
 4733                  handler = TLS_FTPHandler
 4734                  handler.certfile = self.config.get('cert_file', 'cert.pem')
 4735                  handler.keyfile = self.config.get('key_file', 'key.pem')
 4736                  handler.tls_control_required = True
 4737                  handler.tls_data_required = True
 4738                  logger.info("ä½¿ç”¨ FTPS (TLS/SSL) åŠ å¯†")
 4739              else:
 4740                  # æ™®é€š FTP å¤„ç†å™¨
 4741                  handler = FTPHandler
 4742                  logger.info("ä½¿ç”¨æ™®é€š FTP åè®®ï¼ˆæ— åŠ å¯†ï¼‰")
 4743              
 4744              handler.authorizer = authorizer
 4745              
 4746              # è®¾ç½®è¢«åŠ¨æ¨¡å¼ç«¯å£èŒƒå›´
 4747              passive_ports = self.config.get('passive_ports', (60000, 65535))
 4748              handler.passive_ports = range(passive_ports[0], passive_ports[1] + 1)  # type: ignore
 4749              

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 97 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 4750              # è®¾ç½® banner
 4751              handler.banner = "å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…· v2.0 FTP æœåŠ¡å™¨"
 4752              
 4753              # è®¾ç½®è¶…æ—¶
 4754              handler.timeout = 300  # 5åˆ†é’Ÿè¶…æ—¶
 4755              
 4756              # åˆ›å»ºæœåŠ¡å™¨
 4757              host = self.config.get('host', '0.0.0.0')
 4758              port = self.config.get('port', 21)
 4759              
 4760              self.server = FTPServer((host, port), handler)
 4761              
 4762              # è®¾ç½®è¿æ¥é™åˆ¶
 4763              self.server.max_cons = self.config.get('max_cons', 256)
 4764              self.server.max_cons_per_ip = self.config.get('max_cons_per_ip', 5)
 4765              
 4766              logger.info(f"FTP æœåŠ¡å™¨é…ç½®å®Œæˆ: {host}:{port}")
 4767              logger.info(f"å…±äº«ç›®å½•: {shared_folder}")
 4768              logger.info(f"è¢«åŠ¨ç«¯å£èŒƒå›´: {passive_ports[0]}-{passive_ports[1]}")
 4769              logger.info(f"æœ€å¤§è¿æ¥æ•°: {self.server.max_cons}")
 4770              logger.info(f"å•IPæœ€å¤§è¿æ¥æ•°: {self.server.max_cons_per_ip}")
 4771              
 4772              # åœ¨æ–°çº¿ç¨‹ä¸­å¯åŠ¨æœåŠ¡å™¨
 4773              self._stop_event.clear()
 4774              self.server_thread = threading.Thread(
 4775                  target=self._run_server,
 4776                  daemon=True,
 4777                  name="FTPServerThread"
 4778              )
 4779              self.server_thread.start()
 4780              
 4781              # ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨
 4782              time.sleep(0.5)
 4783              
 4784              self.is_running = True
 4785              logger.info("âœ“ FTP æœåŠ¡å™¨å·²å¯åŠ¨")
 4786              return True
 4787              
 4788          except PermissionError as e:
 4789              logger.error(f"æƒé™é”™è¯¯ï¼š{e}ã€‚ç«¯å£ < 1024 éœ€è¦ç®¡ç†å‘˜æƒé™")
 4790              return False
 4791          except OSError as e:
 4792              if "Address already in use" in str(e) or "10048" in str(e):
 4793                  logger.error(f"ç«¯å£è¢«å ç”¨ï¼š{self.config.get('port')}ã€‚è¯·æ›´æ¢ç«¯å£æˆ–å…³é—­å ç”¨ç«¯å£çš„ç¨‹åº")
 4794              else:
 4795                  logger.error(f"å¯åŠ¨ FTP æœåŠ¡å™¨å¤±è´¥ï¼š{e}")
 4796              return False
 4797          except Exception as e:
 4798              logger.error(f"å¯åŠ¨ FTP æœåŠ¡å™¨å¤±è´¥ï¼š{e}")
 4799              import traceback

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 98 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 4800              traceback.print_exc()
 4801              return False
 4802      
 4803      def _run_server(self):
 4804          """è¿è¡Œ FTP æœåŠ¡å™¨ï¼ˆåœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­ï¼‰"""
 4805          try:
 4806              logger.info("FTP æœåŠ¡å™¨çº¿ç¨‹å¼€å§‹è¿è¡Œ")
 4807              if self.server:
 4808                  self.server.serve_forever()
 4809          except Exception as e:
 4810              if not self._stop_event.is_set():
 4811                  logger.error(f"FTP æœåŠ¡å™¨è¿è¡Œé”™è¯¯ï¼š{e}")
 4812              self.is_running = False
 4813          finally:
 4814              logger.info("FTP æœåŠ¡å™¨çº¿ç¨‹å·²é€€å‡º")
 4815      
 4816      def stop(self) -> bool:
 4817          """
 4818          åœæ­¢ FTP æœåŠ¡å™¨
 4819          
 4820          Returns:
 4821              bool: åœæ­¢æ˜¯å¦æˆåŠŸ
 4822          """
 4823          if not self.is_running:
 4824              logger.warning("FTP æœåŠ¡å™¨æœªè¿è¡Œ")
 4825              return False
 4826          
 4827          try:
 4828              logger.info("æ­£åœ¨åœæ­¢ FTP æœåŠ¡å™¨...")
 4829              self._stop_event.set()
 4830              
 4831              if self.server:
 4832                  self.server.close_all()
 4833                  
 4834              self.is_running = False
 4835              logger.info("âœ“ FTP æœåŠ¡å™¨å·²åœæ­¢")
 4836              return True
 4837              
 4838          except Exception as e:
 4839              logger.error(f"åœæ­¢ FTP æœåŠ¡å™¨å¤±è´¥ï¼š{e}")
 4840              return False
 4841      
 4842      def get_status(self) -> dict:
 4843          """
 4844          è·å–æœåŠ¡å™¨çŠ¶æ€
 4845          
 4846          Returns:
 4847              dict: æœåŠ¡å™¨çŠ¶æ€ä¿¡æ¯
 4848          """
 4849          if not self.is_running or not self.server:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                  ç¬¬ 99 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 4850              return {
 4851                  'running': False,
 4852                  'connections': 0,
 4853                  'address': None,
 4854                  'shared_folder': None,
 4855                  'tls_enabled': False
 4856              }
 4857          
 4858          # è·å–å½“å‰è¿æ¥æ•°
 4859          connection_count = 0
 4860          try:
 4861              # Note: _map æ˜¯ asyncore.dispatcher çš„å†…éƒ¨å±æ€§
 4862              connection_count = len(self.server._map) if hasattr(self.server, '_map') else 0  # type: ignore[attr-defined]
 4863          except:
 4864              pass
 4865          
 4866          return {
 4867              'running': True,
 4868              'connections': connection_count,
 4869              'address': f"{self.config.get('host')}:{self.config.get('port')}",
 4870              'shared_folder': self.config.get('shared_folder'),
 4871              'tls_enabled': self.config.get('enable_tls', False),
 4872              'max_connections': self.config.get('max_cons', 256),
 4873              'max_connections_per_ip': self.config.get('max_cons_per_ip', 5)
 4874          }
 4875      
 4876      def __del__(self):
 4877          """ææ„å‡½æ•°ï¼Œç¡®ä¿æœåŠ¡å™¨è¢«å…³é—­"""
 4878          if self.is_running:
 4879              self.stop()
 4880  
 4881  
 4882  class FTPClientUploader:
 4883      """
 4884      FTP å®¢æˆ·ç«¯ä¸Šä¼ å™¨
 4885      
 4886      åŠŸèƒ½ï¼š
 4887      - è¿æ¥åˆ° FTP æœåŠ¡å™¨
 4888      - ç”¨æˆ·è®¤è¯
 4889      - ä¸Šä¼ å•ä¸ªæ–‡ä»¶
 4890      - ä¸Šä¼ æ•´ä¸ªæ–‡ä»¶å¤¹ï¼ˆä¿æŒç›®å½•ç»“æ„ï¼‰
 4891      - è¢«åŠ¨/ä¸»åŠ¨æ¨¡å¼åˆ‡æ¢
 4892      - FTPS æ”¯æŒ
 4893      - è¿›åº¦å›è°ƒ
 4894      - è¿æ¥æµ‹è¯•
 4895      - é‡è¯•æœºåˆ¶
 4896      - è¶…æ—¶å¤„ç†
 4897      """
 4898      
 4899      def __init__(self, config: dict):

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 100 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 4900          """
 4901          åˆå§‹åŒ– FTP å®¢æˆ·ç«¯
 4902          
 4903          Args:
 4904              config: é…ç½®å­—å…¸
 4905                  {
 4906                      'name': 'FTPå®¢æˆ·ç«¯1',            # å®¢æˆ·ç«¯åç§°
 4907                      'host': 'ftp.example.com',      # FTP æœåŠ¡å™¨åœ°å€
 4908                      'port': 21,                      # FTP ç«¯å£
 4909                      'username': 'upload_user',       # ç”¨æˆ·å
 4910                      'password': 'upload_pass',       # å¯†ç 
 4911                      'remote_path': '/upload/photos', # è¿œç¨‹ç›®æ ‡è·¯å¾„
 4912                      'enable_tls': False,             # æ˜¯å¦å¯ç”¨ FTPS
 4913                      'passive_mode': True,            # è¢«åŠ¨æ¨¡å¼
 4914                      'timeout': 30,                   # è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
 4915                      'retry_count': 3,                # é‡è¯•æ¬¡æ•°
 4916                  }
 4917          """
 4918          self.config = config
 4919          self.ftp: Optional[Union[FTP, FTP_TLS]] = None
 4920          self.connected = False
 4921          self._lock = threading.Lock()
 4922          
 4923          logger.info(f"FTP å®¢æˆ·ç«¯åˆå§‹åŒ–: {config.get('name', 'Unknown')} -> {config.get('host')}")
 4924      
 4925      def connect(self) -> bool:
 4926          """
 4927          è¿æ¥åˆ° FTP æœåŠ¡å™¨
 4928          
 4929          Returns:
 4930              bool: è¿æ¥æ˜¯å¦æˆåŠŸ
 4931          """
 4932          with self._lock:
 4933              if self.connected:
 4934                  logger.warning("å·²è¿æ¥åˆ° FTP æœåŠ¡å™¨")
 4935                  return True
 4936              
 4937              retry_count = self.config.get('retry_count', 3)
 4938              
 4939              for attempt in range(retry_count):
 4940                  try:
 4941                      logger.info(f"è¿æ¥ FTP æœåŠ¡å™¨ (å°è¯• {attempt + 1}/{retry_count})...")
 4942                      
 4943                      # åˆ›å»º FTP å¯¹è±¡
 4944                      if self.config.get('enable_tls', False):
 4945                          # FTPS è¿æ¥
 4946                          self.ftp = FTP_TLS()
 4947                          logger.info("ä½¿ç”¨ FTPS (TLS/SSL) è¿æ¥")
 4948                      else:
 4949                          # æ™®é€š FTP è¿æ¥

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 101 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 4950                          self.ftp = FTP()
 4951                          logger.info("ä½¿ç”¨æ™®é€š FTP è¿æ¥")
 4952                      
 4953                      # è¿æ¥
 4954                      host = str(self.config.get('host', ''))
 4955                      self.ftp.connect(
 4956                          host=host,
 4957                          port=self.config.get('port', 21),
 4958                          timeout=self.config.get('timeout', 30)
 4959                      )
 4960                      
 4961                      # ç™»å½•
 4962                      username = str(self.config.get('username', ''))
 4963                      password = str(self.config.get('password', ''))
 4964                      self.ftp.login(
 4965                          user=username,
 4966                          passwd=password
 4967                      )
 4968                      
 4969                      # FTPS å¯ç”¨æ•°æ®è¿æ¥åŠ å¯†
 4970                      if self.config.get('enable_tls', False) and isinstance(self.ftp, FTP_TLS):
 4971                          self.ftp.prot_p()
 4972                      
 4973                      # è®¾ç½®è¢«åŠ¨/ä¸»åŠ¨æ¨¡å¼
 4974                      if self.config.get('passive_mode', True):
 4975                          self.ftp.set_pasv(True)
 4976                          logger.info("ä½¿ç”¨è¢«åŠ¨æ¨¡å¼")
 4977                      else:
 4978                          self.ftp.set_pasv(False)
 4979                          logger.info("ä½¿ç”¨ä¸»åŠ¨æ¨¡å¼")
 4980                      
 4981                      # è®¾ç½®ç¼–ç 
 4982                      self.ftp.encoding = 'utf-8'
 4983                      
 4984                      self.connected = True
 4985                      logger.info(f"âœ“ å·²è¿æ¥åˆ° FTP æœåŠ¡å™¨ï¼š{self.config.get('host')}")
 4986                      return True
 4987                      
 4988                  except Exception as e:
 4989                      logger.error(f"è¿æ¥å¤±è´¥ (å°è¯• {attempt + 1}/{retry_count})ï¼š{e}")
 4990                      
 4991                      if self.ftp:
 4992                          try:
 4993                              self.ftp.close()
 4994                          except:
 4995                              pass
 4996                          self.ftp = None
 4997                      
 4998                      if attempt < retry_count - 1:
 4999                          wait_time = (attempt + 1) * 5  # 5ç§’, 10ç§’, 15ç§’

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 102 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 5000                          logger.info(f"ç­‰å¾… {wait_time} ç§’åé‡è¯•...")
 5001                          time.sleep(wait_time)
 5002                      else:
 5003                          logger.error("è¿æ¥ FTP æœåŠ¡å™¨å¤±è´¥ï¼Œå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°")
 5004              
 5005              self.connected = False
 5006              return False
 5007      
 5008      def disconnect(self) -> bool:
 5009          """
 5010          æ–­å¼€ FTP è¿æ¥
 5011          
 5012          Returns:
 5013              bool: æ–­å¼€æ˜¯å¦æˆåŠŸ
 5014          """
 5015          with self._lock:
 5016              if not self.connected:
 5017                  logger.warning("æœªè¿æ¥åˆ° FTP æœåŠ¡å™¨")
 5018                  return False
 5019              
 5020              try:
 5021                  if self.ftp:
 5022                      self.ftp.quit()
 5023                      self.ftp = None
 5024                  
 5025                  self.connected = False
 5026                  logger.info("âœ“ å·²æ–­å¼€ FTP è¿æ¥")
 5027                  return True
 5028                  
 5029              except Exception as e:
 5030                  logger.error(f"æ–­å¼€ FTP è¿æ¥å¤±è´¥ï¼š{e}")
 5031                  
 5032                  # å¼ºåˆ¶å…³é—­
 5033                  try:
 5034                      if self.ftp:
 5035                          self.ftp.close()
 5036                          self.ftp = None
 5037                  except:
 5038                      pass
 5039                  
 5040                  self.connected = False
 5041                  return False
 5042      
 5043      def upload_file(
 5044          self,
 5045          local_path: Path,
 5046          remote_path: Optional[str] = None,
 5047          progress_callback: Optional[Callable[[int, int], None]] = None,
 5048          enable_speed_limit: bool = False,
 5049          speed_limit_mbps: int = 10

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 103 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 5050      ) -> bool:
 5051          """
 5052          ä¸Šä¼ å•ä¸ªæ–‡ä»¶
 5053          
 5054          Args:
 5055              local_path: æœ¬åœ°æ–‡ä»¶è·¯å¾„
 5056              remote_path: è¿œç¨‹æ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨é…ç½®ä¸­çš„è·¯å¾„ï¼‰
 5057              progress_callback: è¿›åº¦å›è°ƒå‡½æ•° callback(uploaded_bytes, total_bytes)
 5058              enable_speed_limit: v2.2.0 æ˜¯å¦å¯ç”¨é€Ÿåº¦é™åˆ¶
 5059              speed_limit_mbps: v2.2.0 é€Ÿåº¦é™åˆ¶ï¼ˆMB/sï¼‰
 5060          
 5061          Returns:
 5062              bool: ä¸Šä¼ æ˜¯å¦æˆåŠŸ
 5063          """
 5064          if not self.connected:
 5065              logger.error("æœªè¿æ¥åˆ° FTP æœåŠ¡å™¨")
 5066              return False
 5067          
 5068          try:
 5069              local_file = Path(local_path)
 5070              if not local_file.exists():
 5071                  logger.error(f"æ–‡ä»¶ä¸å­˜åœ¨ï¼š{local_path}")
 5072                  return False
 5073              
 5074              # ç¡®å®šè¿œç¨‹è·¯å¾„
 5075              if remote_path is None:
 5076                  base_remote = self.config.get('remote_path', '/')
 5077                  remote_path = f"{base_remote}/{local_file.name}"
 5078              
 5079              # ç¡®ä¿è¿œç¨‹ç›®å½•å­˜åœ¨
 5080              remote_dir = os.path.dirname(remote_path).replace('\\', '/')
 5081              self._ensure_remote_dir(remote_dir)
 5082              
 5083              # è·å–æ–‡ä»¶å¤§å°
 5084              file_size = local_file.stat().st_size
 5085              uploaded_bytes = 0
 5086              
 5087              # v2.2.0 é™é€Ÿç›¸å…³å˜é‡
 5088              speed_limit_bytes_per_sec = speed_limit_mbps * 1024 * 1024 if enable_speed_limit else 0
 5089              last_chunk_time = time.time()
 5090              
 5091              # å®šä¹‰è¿›åº¦å›è°ƒï¼ˆå¸¦é™é€Ÿï¼‰
 5092              def callback(block):
 5093                  nonlocal uploaded_bytes, last_chunk_time
 5094                  chunk_start = last_chunk_time
 5095                  uploaded_bytes += len(block)
 5096                  if progress_callback:
 5097                      progress_callback(uploaded_bytes, file_size)
 5098                  
 5099                  # v2.2.0 é™é€Ÿï¼šåœ¨æ¯ä¸ªå—ä¼ è¾“åç­‰å¾…

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 104 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 5100                  if enable_speed_limit and speed_limit_bytes_per_sec > 0:
 5101                      expected_time = len(block) / speed_limit_bytes_per_sec
 5102                      actual_time = time.time() - chunk_start
 5103                      if actual_time < expected_time:
 5104                          time.sleep(expected_time - actual_time)
 5105                  
 5106                  last_chunk_time = time.time()
 5107              
 5108              # ä¸Šä¼ æ–‡ä»¶ï¼ˆäºŒè¿›åˆ¶æ¨¡å¼ï¼‰
 5109              if self.ftp:
 5110                  with open(local_file, 'rb') as f:
 5111                      self.ftp.storbinary(f'STOR {remote_path}', f, callback=callback)
 5112              
 5113              logger.info(f"âœ“ æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼š{local_file.name} â†’ {remote_path} ({file_size} å­—èŠ‚)")
 5114              return True
 5115              
 5116          except error_perm as e:
 5117              logger.error(f"æƒé™é”™è¯¯ï¼Œä¸Šä¼ å¤±è´¥ï¼š{e}")
 5118              return False
 5119          except Exception as e:
 5120              logger.error(f"ä¸Šä¼ æ–‡ä»¶å¤±è´¥ï¼š{e}")
 5121              return False
 5122      
 5123      def upload_folder(
 5124          self,
 5125          local_folder: Path,
 5126          remote_base: Optional[str] = None,
 5127          progress_callback: Optional[Callable[[int, int, str], None]] = None
 5128      ) -> Tuple[int, int]:
 5129          """
 5130          ä¸Šä¼ æ•´ä¸ªæ–‡ä»¶å¤¹
 5131          
 5132          Args:
 5133              local_folder: æœ¬åœ°æ–‡ä»¶å¤¹è·¯å¾„
 5134              remote_base: è¿œç¨‹åŸºç¡€è·¯å¾„ï¼ˆå¯é€‰ï¼‰
 5135              progress_callback: è¿›åº¦å›è°ƒå‡½æ•° callback(current, total, filename)
 5136          
 5137          Returns:
 5138              tuple: (æˆåŠŸæ•°, å¤±è´¥æ•°)
 5139          """
 5140          if not self.connected:
 5141              logger.error("æœªè¿æ¥åˆ° FTP æœåŠ¡å™¨")
 5142              return (0, 0)
 5143          
 5144          local_folder = Path(local_folder)
 5145          if not local_folder.exists():
 5146              logger.error(f"æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼š{local_folder}")
 5147              return (0, 0)
 5148          
 5149          # æ”¶é›†æ‰€æœ‰æ–‡ä»¶

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 105 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 5150          all_files = list(local_folder.rglob('*'))
 5151          all_files = [f for f in all_files if f.is_file()]
 5152          
 5153          total = len(all_files)
 5154          success = 0
 5155          failed = 0
 5156          
 5157          # ç¡®å®šè¿œç¨‹åŸºç¡€è·¯å¾„
 5158          if remote_base is None:
 5159              remote_base = self.config.get('remote_path', '/')
 5160          
 5161          logger.info(f"å¼€å§‹ä¸Šä¼ æ–‡ä»¶å¤¹ï¼š{local_folder} â†’ {remote_base} (å…± {total} ä¸ªæ–‡ä»¶)")
 5162          
 5163          for i, file_path in enumerate(all_files, 1):
 5164              try:
 5165                  # è®¡ç®—ç›¸å¯¹è·¯å¾„
 5166                  rel_path = file_path.relative_to(local_folder)
 5167                  remote_path = f"{remote_base}/{rel_path.as_posix()}"
 5168                  
 5169                  # ä¸Šä¼ æ–‡ä»¶
 5170                  if self.upload_file(file_path, remote_path):
 5171                      success += 1
 5172                  else:
 5173                      failed += 1
 5174                  
 5175                  # è°ƒç”¨å›è°ƒ
 5176                  if progress_callback:
 5177                      progress_callback(i, total, file_path.name)
 5178                      
 5179              except Exception as e:
 5180                  logger.error(f"ä¸Šä¼ æ–‡ä»¶å¤±è´¥ {file_path.name}ï¼š{e}")
 5181                  failed += 1
 5182          
 5183          logger.info(f"âœ“ æ–‡ä»¶å¤¹ä¸Šä¼ å®Œæˆï¼šæˆåŠŸ {success}ï¼Œå¤±è´¥ {failed}")
 5184          return (success, failed)
 5185      
 5186      def _ensure_remote_dir(self, remote_dir: str):
 5187          """
 5188          ç¡®ä¿è¿œç¨‹ç›®å½•å­˜åœ¨
 5189          
 5190          Args:
 5191              remote_dir: è¿œç¨‹ç›®å½•è·¯å¾„
 5192          """
 5193          if not remote_dir or remote_dir == '/' or remote_dir == '.':
 5194              return
 5195          
 5196          # æ ‡å‡†åŒ–è·¯å¾„
 5197          remote_dir = remote_dir.replace('\\', '/').strip('/')
 5198          
 5199          if not remote_dir:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 106 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 5200              return
 5201          
 5202          if not self.ftp:
 5203              return
 5204              
 5205          try:
 5206              # å°è¯•åˆ‡æ¢åˆ°ç›®å½•
 5207              current = self.ftp.pwd()
 5208              try:
 5209                  self.ftp.cwd(remote_dir)
 5210                  self.ftp.cwd(current)  # åˆ‡æ¢å›åŸç›®å½•
 5211                  return  # ç›®å½•å­˜åœ¨
 5212              except:
 5213                  pass  # ç›®å½•ä¸å­˜åœ¨ï¼Œéœ€è¦åˆ›å»º
 5214              
 5215              # é€’å½’åˆ›å»ºç›®å½•
 5216              parts = remote_dir.split('/')
 5217              current_path = ''
 5218              for part in parts:
 5219                  if not part:
 5220                      continue
 5221                  current_path += f'/{part}'
 5222                  try:
 5223                      if self.ftp:
 5224                          self.ftp.mkd(current_path)
 5225                      logger.debug(f"åˆ›å»ºç›®å½•ï¼š{current_path}")
 5226                  except error_perm:
 5227                      pass  # ç›®å½•å¯èƒ½å·²å­˜åœ¨
 5228                  except Exception as e:
 5229                      logger.debug(f"åˆ›å»ºç›®å½•å¤±è´¥ {current_path}ï¼š{e}")
 5230              
 5231          except Exception as e:
 5232              logger.warning(f"ç¡®ä¿è¿œç¨‹ç›®å½•å­˜åœ¨æ—¶å‡ºé”™ï¼š{e}")
 5233      
 5234      def test_connection(self) -> bool:
 5235          """
 5236          æµ‹è¯•è¿æ¥
 5237          
 5238          Returns:
 5239              bool: è¿æ¥æµ‹è¯•æ˜¯å¦æˆåŠŸ
 5240          """
 5241          try:
 5242              if self.connect():
 5243                  # æµ‹è¯•åˆ—å‡ºç›®å½•
 5244                  if self.ftp:
 5245                      self.ftp.nlst()
 5246                  self.disconnect()
 5247                  return True
 5248              return False
 5249          except Exception as e:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 107 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 5250              logger.error(f"è¿æ¥æµ‹è¯•å¤±è´¥ï¼š{e}")
 5251              return False
 5252      
 5253      def get_status(self) -> dict:
 5254          """
 5255          è·å–å®¢æˆ·ç«¯çŠ¶æ€
 5256          
 5257          Returns:
 5258              dict: å®¢æˆ·ç«¯çŠ¶æ€ä¿¡æ¯
 5259          """
 5260          return {
 5261              'name': self.config.get('name', 'Unknown'),
 5262              'connected': self.connected,
 5263              'host': self.config.get('host'),
 5264              'port': self.config.get('port'),
 5265              'remote_path': self.config.get('remote_path'),
 5266              'tls_enabled': self.config.get('enable_tls', False),
 5267              'passive_mode': self.config.get('passive_mode', True),
 5268              'timeout': self.config.get('timeout', 30)
 5269          }
 5270      
 5271      def __del__(self):
 5272          """ææ„å‡½æ•°ï¼Œç¡®ä¿è¿æ¥è¢«å…³é—­"""
 5273          if self.connected:
 5274              try:
 5275                  self.disconnect()
 5276              except:
 5277                  pass
 5278  
 5279  
 5280  class FTPProtocolManager:
 5281      """
 5282      FTP åè®®ç®¡ç†å™¨ï¼ˆç»Ÿä¸€ç®¡ç†æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ï¼‰
 5283      
 5284      åŠŸèƒ½ï¼š
 5285      - ç»Ÿä¸€ç®¡ç† FTP æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯
 5286      - æ”¯æŒåŒæ—¶è¿è¡ŒæœåŠ¡å™¨ + å¤šä¸ªå®¢æˆ·ç«¯
 5287      - æ¨¡å¼åˆ‡æ¢ï¼ˆserver / client / both / noneï¼‰
 5288      - æ·»åŠ /åˆ é™¤å®¢æˆ·ç«¯
 5289      - è·å–æ•´ä½“çŠ¶æ€
 5290      - å…¨å±€é”™è¯¯å¤„ç†
 5291      
 5292      å·¥ä½œæ¨¡å¼ï¼š
 5293      - 'none': ç¦ç”¨ FTPï¼ˆä½¿ç”¨ SMBï¼‰
 5294      - 'server': ä»… FTP æœåŠ¡å™¨
 5295      - 'client': ä»… FTP å®¢æˆ·ç«¯
 5296      - 'both': æœåŠ¡å™¨ + å®¢æˆ·ç«¯ï¼ˆåŒæ—¶ï¼‰
 5297      """
 5298      
 5299      def __init__(self):

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 108 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 5300          """åˆå§‹åŒ–åè®®ç®¡ç†å™¨"""
 5301          self.server: Optional[FTPServerManager] = None
 5302          self.clients: Dict[str, FTPClientUploader] = {}
 5303          self.mode = 'none'  # 'server', 'client', 'both', 'none'
 5304          self._lock = threading.Lock()
 5305          
 5306          logger.info("FTP åè®®ç®¡ç†å™¨åˆå§‹åŒ–")
 5307      
 5308      def start_server(self, config: dict) -> bool:
 5309          """
 5310          å¯åŠ¨ FTP æœåŠ¡å™¨
 5311          
 5312          Args:
 5313              config: æœåŠ¡å™¨é…ç½®
 5314          
 5315          Returns:
 5316              bool: å¯åŠ¨æ˜¯å¦æˆåŠŸ
 5317          """
 5318          with self._lock:
 5319              try:
 5320                  if self.server and self.server.is_running:
 5321                      logger.warning("FTP æœåŠ¡å™¨å·²åœ¨è¿è¡Œ")
 5322                      return False
 5323                  
 5324                  self.server = FTPServerManager(config)
 5325                  
 5326                  if self.server.start():
 5327                      # æ›´æ–°æ¨¡å¼
 5328                      if self.mode == 'client':
 5329                          self.mode = 'both'
 5330                      else:
 5331                          self.mode = 'server'
 5332                      
 5333                      logger.info(f"FTP æœåŠ¡å™¨å·²å¯åŠ¨ï¼Œå½“å‰æ¨¡å¼ï¼š{self.mode}")
 5334                      return True
 5335                  else:
 5336                      self.server = None
 5337                      return False
 5338                      
 5339              except Exception as e:
 5340                  logger.error(f"å¯åŠ¨ FTP æœåŠ¡å™¨å¤±è´¥ï¼š{e}")
 5341                  self.server = None
 5342                  return False
 5343      
 5344      def stop_server(self) -> bool:
 5345          """
 5346          åœæ­¢ FTP æœåŠ¡å™¨
 5347          
 5348          Returns:
 5349              bool: åœæ­¢æ˜¯å¦æˆåŠŸ

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 109 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 5350          """
 5351          with self._lock:
 5352              if not self.server:
 5353                  logger.warning("FTP æœåŠ¡å™¨æœªå¯åŠ¨")
 5354                  return False
 5355              
 5356              result = self.server.stop()
 5357              
 5358              if result:
 5359                  self.server = None
 5360                  
 5361                  # æ›´æ–°æ¨¡å¼
 5362                  if self.mode == 'both':
 5363                      self.mode = 'client'
 5364                  else:
 5365                      self.mode = 'none'
 5366                  
 5367                  logger.info(f"FTP æœåŠ¡å™¨å·²åœæ­¢ï¼Œå½“å‰æ¨¡å¼ï¼š{self.mode}")
 5368              
 5369              return result
 5370      
 5371      def add_client(self, name: str, config: dict) -> bool:
 5372          """
 5373          æ·»åŠ  FTP å®¢æˆ·ç«¯
 5374          
 5375          Args:
 5376              name: å®¢æˆ·ç«¯åç§°
 5377              config: å®¢æˆ·ç«¯é…ç½®
 5378          
 5379          Returns:
 5380              bool: æ·»åŠ æ˜¯å¦æˆåŠŸ
 5381          """
 5382          with self._lock:
 5383              try:
 5384                  if name in self.clients:
 5385                      logger.warning(f"å®¢æˆ·ç«¯å·²å­˜åœ¨ï¼š{name}")
 5386                      return False
 5387                  
 5388                  # ç¡®ä¿é…ç½®ä¸­æœ‰åç§°
 5389                  config['name'] = name
 5390                  
 5391                  client = FTPClientUploader(config)
 5392                  
 5393                  if client.connect():
 5394                      self.clients[name] = client
 5395                      
 5396                      # æ›´æ–°æ¨¡å¼
 5397                      if self.mode == 'server':
 5398                          self.mode = 'both'
 5399                      elif self.mode == 'none':

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 110 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 5400                          self.mode = 'client'
 5401                      
 5402                      logger.info(f"FTP å®¢æˆ·ç«¯å·²æ·»åŠ ï¼š{name}ï¼Œå½“å‰æ¨¡å¼ï¼š{self.mode}")
 5403                      return True
 5404                  else:
 5405                      return False
 5406                      
 5407              except Exception as e:
 5408                  logger.error(f"æ·»åŠ  FTP å®¢æˆ·ç«¯å¤±è´¥ï¼š{e}")
 5409                  return False
 5410      
 5411      def remove_client(self, name: str) -> bool:
 5412          """
 5413          ç§»é™¤ FTP å®¢æˆ·ç«¯
 5414          
 5415          Args:
 5416              name: å®¢æˆ·ç«¯åç§°
 5417          
 5418          Returns:
 5419              bool: ç§»é™¤æ˜¯å¦æˆåŠŸ
 5420          """
 5421          with self._lock:
 5422              if name not in self.clients:
 5423                  logger.warning(f"å®¢æˆ·ç«¯ä¸å­˜åœ¨ï¼š{name}")
 5424                  return False
 5425              
 5426              client = self.clients[name]
 5427              client.disconnect()
 5428              del self.clients[name]
 5429              
 5430              # æ›´æ–°æ¨¡å¼
 5431              if not self.clients:
 5432                  if self.mode == 'both':
 5433                      self.mode = 'server'
 5434                  else:
 5435                      self.mode = 'none'
 5436              
 5437              logger.info(f"FTP å®¢æˆ·ç«¯å·²ç§»é™¤ï¼š{name}ï¼Œå½“å‰æ¨¡å¼ï¼š{self.mode}")
 5438              return True
 5439      
 5440      def get_client(self, name: str) -> Optional[FTPClientUploader]:
 5441          """
 5442          è·å–æŒ‡å®šçš„å®¢æˆ·ç«¯
 5443          
 5444          Args:
 5445              name: å®¢æˆ·ç«¯åç§°
 5446          
 5447          Returns:
 5448              FTPClientUploader: å®¢æˆ·ç«¯å¯¹è±¡ï¼Œå¦‚æœä¸å­˜åœ¨è¿”å› None
 5449          """

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 111 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 5450          return self.clients.get(name)
 5451      
 5452      def upload_file(
 5453          self,
 5454          client_name: str,
 5455          local_path: Path,
 5456          remote_path: Optional[str] = None,
 5457          progress_callback: Optional[Callable[[int, int], None]] = None
 5458      ) -> bool:
 5459          """
 5460          é€šè¿‡æŒ‡å®šå®¢æˆ·ç«¯ä¸Šä¼ æ–‡ä»¶
 5461          
 5462          Args:
 5463              client_name: å®¢æˆ·ç«¯åç§°
 5464              local_path: æœ¬åœ°æ–‡ä»¶è·¯å¾„
 5465              remote_path: è¿œç¨‹æ–‡ä»¶è·¯å¾„
 5466              progress_callback: è¿›åº¦å›è°ƒ
 5467          
 5468          Returns:
 5469              bool: ä¸Šä¼ æ˜¯å¦æˆåŠŸ
 5470          """
 5471          client = self.get_client(client_name)
 5472          if not client:
 5473              logger.error(f"å®¢æˆ·ç«¯ä¸å­˜åœ¨ï¼š{client_name}")
 5474              return False
 5475          
 5476          return client.upload_file(local_path, remote_path, progress_callback)
 5477      
 5478      def upload_folder(
 5479          self,
 5480          client_name: str,
 5481          local_folder: Path,
 5482          remote_base: Optional[str] = None,
 5483          progress_callback: Optional[Callable[[int, int, str], None]] = None
 5484      ) -> Tuple[int, int]:
 5485          """
 5486          é€šè¿‡æŒ‡å®šå®¢æˆ·ç«¯ä¸Šä¼ æ–‡ä»¶å¤¹
 5487          
 5488          Args:
 5489              client_name: å®¢æˆ·ç«¯åç§°
 5490              local_folder: æœ¬åœ°æ–‡ä»¶å¤¹è·¯å¾„
 5491              remote_base: è¿œç¨‹åŸºç¡€è·¯å¾„
 5492              progress_callback: è¿›åº¦å›è°ƒ
 5493          
 5494          Returns:
 5495              tuple: (æˆåŠŸæ•°, å¤±è´¥æ•°)
 5496          """
 5497          client = self.get_client(client_name)
 5498          if not client:
 5499              logger.error(f"å®¢æˆ·ç«¯ä¸å­˜åœ¨ï¼š{client_name}")

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 112 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 5500              return (0, 0)
 5501          
 5502          return client.upload_folder(local_folder, remote_base, progress_callback)
 5503      
 5504      def get_status(self) -> dict:
 5505          """
 5506          è·å–æ•´ä½“çŠ¶æ€
 5507          
 5508          Returns:
 5509              dict: æ•´ä½“çŠ¶æ€ä¿¡æ¯
 5510          """
 5511          return {
 5512              'mode': self.mode,
 5513              'server': self.server.get_status() if self.server else None,
 5514              'clients': {name: client.get_status() for name, client in self.clients.items()},
 5515              'client_count': len(self.clients)
 5516          }
 5517      
 5518      def stop_all(self):
 5519          """åœæ­¢æ‰€æœ‰æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯"""
 5520          with self._lock:
 5521              logger.info("æ­£åœ¨åœæ­¢æ‰€æœ‰ FTP æœåŠ¡...")
 5522              
 5523              # åœæ­¢æ‰€æœ‰å®¢æˆ·ç«¯
 5524              for name in list(self.clients.keys()):
 5525                  self.remove_client(name)
 5526              
 5527              # åœæ­¢æœåŠ¡å™¨
 5528              if self.server:
 5529                  self.stop_server()
 5530              
 5531              self.mode = 'none'
 5532              logger.info("âœ“ æ‰€æœ‰ FTP æœåŠ¡å·²åœæ­¢")
 5533      
 5534      def __del__(self):
 5535          """ææ„å‡½æ•°ï¼Œç¡®ä¿æ‰€æœ‰æœåŠ¡è¢«å…³é—­"""
 5536          try:
 5537              self.stop_all()
 5538          except:
 5539              pass
 5540  
 5541  
 5542  # æ¨¡å—çº§åˆ«çš„ä¾¿æ·å‡½æ•°
 5543  
 5544  def create_ftp_server(config: dict) -> FTPServerManager:
 5545      """
 5546      ä¾¿æ·å‡½æ•°ï¼šåˆ›å»º FTP æœåŠ¡å™¨
 5547      
 5548      Args:
 5549          config: æœåŠ¡å™¨é…ç½®

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 113 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 5550      
 5551      Returns:
 5552          FTPServerManager: æœåŠ¡å™¨ç®¡ç†å™¨å®ä¾‹
 5553      """
 5554      return FTPServerManager(config)
 5555  
 5556  
 5557  def create_ftp_client(config: dict) -> FTPClientUploader:
 5558      """
 5559      ä¾¿æ·å‡½æ•°ï¼šåˆ›å»º FTP å®¢æˆ·ç«¯
 5560      
 5561      Args:
 5562          config: å®¢æˆ·ç«¯é…ç½®
 5563      
 5564      Returns:
 5565          FTPClientUploader: å®¢æˆ·ç«¯ä¸Šä¼ å™¨å®ä¾‹
 5566      """
 5567      return FTPClientUploader(config)
 5568  
 5569  
 5570  # ç¤ºä¾‹ç”¨æ³•ï¼ˆç”¨äºæµ‹è¯•ï¼‰
 5571  if __name__ == "__main__":
 5572      # é…ç½®æ—¥å¿—
 5573      logging.basicConfig(
 5574          level=logging.INFO,
 5575          format='[%(levelname)s] %(message)s'
 5576      )
 5577      
 5578      print("=" * 60)
 5579      print("FTP åè®®æ¨¡å—æµ‹è¯•")
 5580      print("=" * 60)
 5581      print()
 5582      
 5583      # æµ‹è¯• 1: FTP æœåŠ¡å™¨
 5584      print("æµ‹è¯• 1: FTP æœåŠ¡å™¨")
 5585      print("-" * 60)
 5586      
 5587      server_config = {
 5588          'host': '0.0.0.0',
 5589          'port': 2121,
 5590          'username': 'test_user',
 5591          'password': 'test_pass',
 5592          'shared_folder': 'test_ftp_share',
 5593          'enable_tls': False,
 5594          'passive_ports': (60000, 65535),
 5595          'max_cons': 256,
 5596          'max_cons_per_ip': 5,
 5597      }
 5598      
 5599      server = FTPServerManager(server_config)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 114 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 5600      if server.start():
 5601          print("âœ“ FTP æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ")
 5602          print(f"çŠ¶æ€ï¼š{server.get_status()}")
 5603          
 5604          # æµ‹è¯• 2: FTP å®¢æˆ·ç«¯
 5605          print()
 5606          print("æµ‹è¯• 2: FTP å®¢æˆ·ç«¯")
 5607          print("-" * 60)
 5608          
 5609          client_config = {
 5610              'name': 'æµ‹è¯•å®¢æˆ·ç«¯',
 5611              'host': '127.0.0.1',
 5612              'port': 2121,
 5613              'username': 'test_user',
 5614              'password': 'test_pass',
 5615              'remote_path': '/upload',
 5616              'enable_tls': False,
 5617              'passive_mode': True,
 5618              'timeout': 30,
 5619              'retry_count': 3,
 5620          }
 5621          
 5622          client = FTPClientUploader(client_config)
 5623          if client.connect():
 5624              print("âœ“ FTP å®¢æˆ·ç«¯è¿æ¥æˆåŠŸ")
 5625              print(f"çŠ¶æ€ï¼š{client.get_status()}")
 5626              
 5627              # åˆ›å»ºæµ‹è¯•æ–‡ä»¶
 5628              test_file = Path("test_upload.txt")
 5629              test_file.write_text("è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶", encoding='utf-8')
 5630              
 5631              # ä¸Šä¼ æ–‡ä»¶
 5632              if client.upload_file(test_file):
 5633                  print("âœ“ æ–‡ä»¶ä¸Šä¼ æˆåŠŸ")
 5634              
 5635              # æ¸…ç†
 5636              test_file.unlink()
 5637              client.disconnect()
 5638          
 5639          # åœæ­¢æœåŠ¡å™¨
 5640          server.stop()
 5641      
 5642      print()
 5643      print("=" * 60)
 5644      print("æµ‹è¯•å®Œæˆ")
 5645      print("=" * 60)
       
       # ============================================================
       # æ–‡ä»¶: src\ui\__init__.py
       # ============================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 115 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 5646  # -*- coding: utf-8 -*-
 5647  """
 5648  UI æ¨¡å— - ç”¨æˆ·ç•Œé¢ç»„ä»¶
 5649  
 5650  åŒ…å«ï¼š
 5651  - widgets.py: è‡ªå®šä¹‰æ§ä»¶ï¼ˆToast, ChipWidget, CollapsibleBox, DiskCleanupDialogï¼‰
 5652  - main_window.py: ä¸»çª—å£ï¼ˆå¾…è¿ç§»ï¼‰
 5653  """
 5654  
 5655  from .widgets import Toast, ChipWidget, CollapsibleBox, DiskCleanupDialog
 5656  from .main_window import MainWindow
 5657  
 5658  __all__ = ['Toast', 'ChipWidget', 'CollapsibleBox', 'DiskCleanupDialog', 'MainWindow']
       
       # ============================================================
       # æ–‡ä»¶: src\ui\main_window.py
       # ============================================================
 5659  # -*- coding: utf-8 -*-
 5660  """
 5661  Main window UI module extracted from pyqt_app.py.
 5662  """
 5663  import os
 5664  import sys
 5665  import json
 5666  import time
 5667  import shutil
 5668  import threading
 5669  import datetime
 5670  import queue
 5671  import winreg
 5672  import hashlib
 5673  from pathlib import Path
 5674  from typing import List, Tuple, Optional, Any
 5675  from concurrent.futures import ThreadPoolExecutor, TimeoutError as FuturesTimeoutError
 5676  
 5677  try:
 5678      from src.protocols.ftp import FTPProtocolManager, FTPServerManager, FTPClientUploader
 5679      FTP_AVAILABLE = True
 5680  except ImportError:
 5681      FTP_AVAILABLE = False
 5682      FTPProtocolManager = FTPServerManager = FTPClientUploader = None  # type: ignore[misc, assignment]
 5683  
 5684  # ç±»å‹å®ˆå«ï¼ˆä»…ç”¨äºç±»å‹æ£€æŸ¥ï¼‰
 5685  if not FTP_AVAILABLE:
 5686      from typing import TYPE_CHECKING
 5687      if TYPE_CHECKING:
 5688          # ä¸ºç±»å‹æ£€æŸ¥å™¨æä¾›ç±»å‹æç¤º
 5689          FTPProtocolManager = FTPServerManager = FTPClientUploader = Any  # type: ignore[misc, assignment]
 5690  
 5691  from qt_types import MessageBoxIcon, MessageBoxButton, TrayIconType, EventType

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 116 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 5692  
 5693  try:
 5694      from PySide6 import QtCore, QtGui, QtWidgets
 5695      from PySide6.QtNetwork import QLocalServer, QLocalSocket
 5696      Signal = QtCore.Signal  # PySide6 signal
 5697  except ImportError:
 5698      from PyQt5 import QtCore, QtGui, QtWidgets  # type: ignore[import-not-found]
 5699      from PyQt5.QtNetwork import QLocalServer, QLocalSocket  # type: ignore[import-not-found]
 5700      Signal = QtCore.pyqtSignal  # type: ignore[attr-defined]
 5701  
 5702  from src.core import get_app_dir, get_resource_path, get_app_version, get_app_title
 5703  from src.core.i18n import t, set_language, get_language, add_language_listener, SUPPORTED_LANGUAGES  # v3.0.2: å¤šè¯­è¨€æ”¯æŒ
 5704  from src.ui.widgets import Toast, ChipWidget, CollapsibleBox, DiskCleanupDialog
 5705  from src.workers.upload_worker import UploadWorker
 5706  
 5707  APP_VERSION = get_app_version()
 5708  APP_TITLE = get_app_title()
 5709  
 5710  
 5711  def get_qt_enum(enum_class, attr_name: str, fallback_value: int):
 5712      """Safe Qt enum getter compatible with PySide6/PyQt5."""
 5713      try:
 5714          return getattr(enum_class, attr_name, fallback_value)
 5715      except AttributeError:
 5716          return fallback_value
 5717  
 5718  __all__ = ['MainWindow']
 5719  
 5720  
 5721  class MainWindow(QtWidgets.QMainWindow):  # type: ignore[misc]
 5722      # å†…éƒ¨ä¿¡å·ç”¨äºçº¿ç¨‹å®‰å…¨çš„UIæ›´æ–°
 5723      _disk_update_signal = Signal(str, float)  # disk_type, free_percent
 5724      
 5725      def __init__(self):
 5726          super().__init__()
 5727          self.setWindowTitle(APP_TITLE)
 5728          # ä½¿ç”¨å¯æŠ˜å ç»„ä»¶åï¼Œä¼˜åŒ–çª—å£å¤§å°
 5729          self.resize(1350, 880)  # ç¨å¾®å‡å°é«˜åº¦
 5730          self.setMinimumSize(1200, 750)  # å‡å°æœ€å°å°ºå¯¸
 5731          self.app_dir = get_app_dir()
 5732          
 5733          # è¿æ¥å†…éƒ¨ä¿¡å·
 5734          self._disk_update_signal.connect(self._on_disk_update)
 5735          # æƒé™ç³»ç»Ÿ
 5736          self.current_role = 'guest'  # guest, user, admin
 5737          # é»˜è®¤å¯†ç ï¼ˆSHA256å“ˆå¸Œï¼‰
 5738          self.user_password = hashlib.sha256('123'.encode('utf-8')).hexdigest()
 5739          self.admin_password = hashlib.sha256('Tops123'.encode('utf-8')).hexdigest()
 5740          # state
 5741          self.source = ''

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 117 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 5742          self.target = ''
 5743          self.backup = ''
 5744          self.enable_backup = True  # v2.1.1 æ–°å¢ï¼šæ˜¯å¦å¯ç”¨å¤‡ä»½
 5745          self.interval = 30
 5746          self.mode = 'periodic'
 5747          self.disk_threshold_percent = 10
 5748          self.retry_count = 3
 5749          self.filters = ['.jpg', '.jpeg', '.png', '.bmp', '.tiff', '.tif', '.gif', '.raw']
 5750          self.autoscroll = True
 5751          self.auto_start_windows = False  # å¼€æœºè‡ªå¯åŠ¨
 5752          self.auto_run_on_startup = False  # è½¯ä»¶è‡ªåŠ¨è¿è¡Œ
 5753          self.is_running = False
 5754          self.is_paused = False
 5755          self.start_time = None
 5756          self.worker = None
 5757          # v2.2.0 æ–°å¢ï¼šä¿å­˜ç»Ÿè®¡æ•°æ®ï¼ˆç”¨äºé€šçŸ¥å’Œæ˜¾ç¤ºï¼‰
 5758          self.uploaded = 0
 5759          self.failed = 0
 5760          self.skipped = 0
 5761          self.config_modified = False  # é…ç½®æ˜¯å¦è¢«ä¿®æ”¹
 5762          self.saved_config = {}  # ä¿å­˜çš„é…ç½®ï¼ˆç”¨äºå›é€€ï¼‰
 5763          self.disk_check_interval = 5  # ç£ç›˜ç©ºé—´æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰
 5764          self.disk_check_counter = 0  # ç£ç›˜ç©ºé—´æ£€æŸ¥è®¡æ•°å™¨
 5765          
 5766          # v1.9 æ–°å¢ï¼šæ–‡ä»¶å»é‡é…ç½®
 5767          self.enable_deduplication = False  # æ˜¯å¦å¯ç”¨æ™ºèƒ½å»é‡
 5768          self.hash_algorithm = 'md5'  # å“ˆå¸Œç®—æ³•ï¼šmd5 æˆ– sha256
 5769          self.duplicate_strategy = 'ask'  # å»é‡ç­–ç•¥ï¼šskip, rename, overwrite, ask
 5770          
 5771          # v1.9 æ–°å¢ï¼šç½‘ç»œç›‘æ§é…ç½®
 5772          self.network_check_interval = 10  # ç½‘ç»œæ£€æµ‹é—´éš”ï¼ˆç§’ï¼‰
 5773          self.network_auto_pause = True  # ç½‘ç»œæ–­å¼€è‡ªåŠ¨æš‚åœ
 5774          self.network_auto_resume = True  # ç½‘ç»œæ¢å¤è‡ªåŠ¨ç»§ç»­
 5775          self.network_status = 'unknown'  # ç½‘ç»œçŠ¶æ€ï¼šgood, unstable, disconnected, unknown
 5776          
 5777          # v1.9 æ–°å¢ï¼šè‡ªåŠ¨åˆ é™¤é…ç½®
 5778          self.enable_auto_delete = False
 5779          self.auto_delete_folder = ''
 5780          self.auto_delete_threshold = 80  # ç£ç›˜ä½¿ç”¨ç‡è¾¾åˆ°80%æ—¶è§¦å‘
 5781          self.auto_delete_keep_days = 10  # ä¿ç•™æœ€è¿‘10å¤©çš„æ–‡ä»¶
 5782          self.auto_delete_check_interval = 300  # æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
 5783          
 5784          # v2.0 æ–°å¢ï¼šFTP åè®®é…ç½®
 5785          self.current_protocol = 'smb'  # ä¸Šä¼ åè®®ï¼šsmb, ftp_server, ftp_client, both
 5786          self.ftp_server_config = {
 5787              'host': '0.0.0.0',
 5788              'port': 2121,
 5789              'username': 'upload_user',
 5790              'password': 'upload_pass',
 5791              'shared_folder': '',

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 118 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 5792          }
 5793          self.ftp_client_config = {
 5794              'host': '',
 5795              'port': 21,
 5796              'username': '',
 5797              'password': '',
 5798              'remote_path': '/upload',
 5799              'timeout': 30,
 5800              'retry_count': 3,
 5801          }
 5802          
 5803          # æ—¥å¿—æ–‡ä»¶è·¯å¾„ï¼ˆæ¯å¤©ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼‰
 5804          self.log_file_path = None
 5805          self._init_log_file()
 5806          
 5807          # ç¡®ä¿å¿…è¦çš„ç›®å½•å­˜åœ¨
 5808          self._ensure_directories()
 5809          
 5810          # æ—¥å¿—å†™å…¥çº¿ç¨‹æ± ï¼ˆé¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼‰
 5811          self._log_executor = ThreadPoolExecutor(max_workers=1, thread_name_prefix="LogWriter")
 5812          
 5813          # v2.2.0 æ–°å¢ï¼šç³»ç»Ÿæ‰˜ç›˜é…ç½®
 5814          self.minimize_to_tray = True  # æœ€å°åŒ–åˆ°æ‰˜ç›˜
 5815          self.show_notifications = True  # æ˜¾ç¤ºé€šçŸ¥
 5816          self.tray_icon = None  # æ‰˜ç›˜å›¾æ ‡å¯¹è±¡
 5817          
 5818          # v2.3.0 æ–°å¢ï¼šé€Ÿç‡é™åˆ¶é…ç½®
 5819          self.limit_upload_rate = False
 5820          self.max_upload_rate_mbps = 10.0
 5821          
 5822          # v2.0 æ–°å¢ï¼šFTP åè®®ç®¡ç†å™¨ï¼ˆå»¶è¿Ÿåˆå§‹åŒ–ï¼Œé¿å…åœ¨UIåˆ›å»ºå‰è°ƒç”¨æ—¥å¿—ï¼‰
 5823          self.ftp_manager = None
 5824          
 5825          # UI
 5826          self._build_ui()
 5827          self._load_config()
 5828          self._apply_theme()
 5829          self._update_ui_permissions()
 5830          
 5831          # v2.2.0 æ–°å¢ï¼šåˆå§‹åŒ–ç³»ç»Ÿæ‰˜ç›˜
 5832          self._init_tray_icon()
 5833          
 5834          # v2.0 æ–°å¢ï¼šåˆå§‹åŒ– FTP åè®®ç®¡ç†å™¨ï¼ˆåœ¨UIåˆ›å»ºåï¼‰
 5835          if FTP_AVAILABLE:
 5836              try:
 5837                  self.ftp_manager = FTPProtocolManager()  # type: ignore[misc]
 5838                  self._append_log("âœ“ FTP åè®®ç®¡ç†å™¨å·²åˆå§‹åŒ–")
 5839              except Exception as e:
 5840                  self._append_log(f"âš  FTP åè®®ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥: {e}")
 5841                  self.ftp_manager = None

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 119 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 5842          
 5843          # è‡ªåŠ¨è¿è¡Œæ£€æŸ¥
 5844          if self.auto_run_on_startup:
 5845              QtCore.QTimer.singleShot(1000, self._auto_start_upload)
 5846          self._timer = QtCore.QTimer(self)
 5847          self._timer.setInterval(500)
 5848          self._timer.timeout.connect(self._tick)
 5849          self._timer.start()
 5850  
 5851      def _init_log_file(self):
 5852          """åˆå§‹åŒ–æ—¥å¿—æ–‡ä»¶ï¼ˆæ¯å¤©ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼‰"""
 5853          try:
 5854              logs_dir = self.app_dir / 'logs'
 5855              logs_dir.mkdir(parents=True, exist_ok=True)
 5856              
 5857              # ä½¿ç”¨å½“å‰æ—¥æœŸä½œä¸ºæ–‡ä»¶å
 5858              today = datetime.datetime.now().strftime('%Y-%m-%d')
 5859              self.log_file_path = logs_dir / f'upload_{today}.txt'
 5860              
 5861              # å¦‚æœæ˜¯æ–°æ–‡ä»¶ï¼Œå†™å…¥æ–‡ä»¶å¤´
 5862              if not self.log_file_path.exists():
 5863                  with open(self.log_file_path, 'w', encoding='utf-8') as f:
 5864                      f.write(f"{'='*60}\n")
 5865                      f.write(f"  å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…· - è¿è¡Œæ—¥å¿—\n")
 5866                      f.write(f"  æ—¥æœŸ: {today}\n")
 5867                      f.write(f"{'='*60}\n\n")
 5868          except Exception as e:
 5869              print(f"åˆå§‹åŒ–æ—¥å¿—æ–‡ä»¶å¤±è´¥: {e}")
 5870              self.log_file_path = None
 5871  
 5872      def _ensure_directories(self):
 5873          """ç¡®ä¿å¿…è¦çš„ç›®å½•å­˜åœ¨ï¼ˆlogs ç­‰ï¼‰
 5874          
 5875          åœ¨æ‰“åŒ…åçš„ç¨‹åºä¸­ï¼Œéœ€è¦åœ¨ exe æ‰€åœ¨ç›®å½•åˆ›å»ºå¯å†™ç›®å½•
 5876          """
 5877          try:
 5878              # åˆ›å»º logs ç›®å½•
 5879              logs_dir = self.app_dir / 'logs'
 5880              logs_dir.mkdir(parents=True, exist_ok=True)
 5881              
 5882              # å¦‚æœä¸å­˜åœ¨ config.jsonï¼Œä»èµ„æºç›®å½•å¤åˆ¶é»˜è®¤é…ç½®
 5883              config_path = self.app_dir / 'config.json'
 5884              if not config_path.exists():
 5885                  # å°è¯•ä»èµ„æºç›®å½•å¤åˆ¶
 5886                  resource_config = get_resource_path('config.json')
 5887                  if resource_config.exists():
 5888                      import shutil
 5889                      shutil.copy2(resource_config, config_path)
 5890          except Exception as e:
 5891              print(f"åˆ›å»ºç›®å½•å¤±è´¥: {e}")

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 120 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 5892  
 5893      def _apply_theme(self):
 5894          self.setStyleSheet(
 5895              """
 5896              QWidget{font-family:'Segoe UI', 'Microsoft YaHei UI'; font-size:11pt; color:#1F2937; background:#E3F2FD;}
 5897              QMainWindow{background:#E3F2FD;}
 5898              QFrame#Card{background:#FFFFFF; border:2px solid #64B5F6; border-radius:10px;}
 5899              QLabel{color:#1F2937;}
 5900              QLabel.Title{color:#1976D2; font-weight:700; font-size:14pt;}
 5901              QPushButton{font-size:11pt;}
 5902              QPushButton:disabled{background:#E5E7EB; color:#9CA3AF; border:1px solid #D1D5DB;}
 5903              QPushButton.Primary{background:#1976D2; color:#FFFFFF; border:none; border-radius:8px; padding:8px 12px;}
 5904              QPushButton.Primary:hover{background:#1E88E5;}
 5905              QPushButton.Primary:disabled{background:#BDBDBD; color:#FFFFFF;}
 5906              QPushButton.Secondary{background:#F1F5F9; color:#0F172A; border:1px solid #64B5F6; border-radius:8px; padding:6px 10px;}
 5907              QPushButton.Secondary:hover{background:#E3F2FD;}
 5908              QPushButton.Secondary:disabled{background:#E5E7EB; color:#9CA3AF;}
 5909              QPushButton.Warning{background:#FEF3C7; color:#A16207; border:1px solid #FCD34D; border-radius:8px; padding:6px 10px;}
 5910              QPushButton.Warning:hover{background:#FDE68A;}
 5911              QPushButton.Warning:disabled{background:#E5E7EB; color:#9CA3AF;}
 5912              QPushButton.Danger{background:#FEE2E2; color:#B91C1C; border:1px solid #FCA5A5; border-radius:8px; padding:6px 10px;}
 5913              QPushButton.Danger:hover{background:#FECACA;}
 5914              QPushButton.Danger:disabled{background:#E5E7EB; color:#9CA3AF;}
 5915              QProgressBar{border:1px solid #64B5F6; border-radius:6px; background:#EEF2F5; text-align:center; color:#1F2937;}
 5916              QProgressBar::chunk{border-radius:6px; background: qlineargradient(x1:0, y1:0, x2:1, y2:0, stop:0 #4FACFE, stop:1 #00F2FE);} 
 5917              QPlainTextEdit{background:#FFFFFF; border:1px solid #64B5F6; color:#1F2937; border-radius:4px;}
 5918              QSpinBox{background:#FFFFFF; color:#1F2937; border:1px solid #64B5F6; border-radius:4px; padding:4px; padding-right:2px;}
 5919              QSpinBox:disabled{background:#F3F4F6; color:#9CA3AF; border:1px solid #D1D5DB;}
 5920              QSpinBox::up-button{background:#FFFFFF; border:1px solid #64B5F6; border-top-right-radius:3px; width:24px; height:14px;}
 5921              QSpinBox::up-button:hover{background:#E3F2FD;}
 5922              QSpinBox::up-button:pressed{background:#BBDEFB;}
 5923              QSpinBox::up-button:disabled{background:#F3F4F6; border:1px solid #D1D5DB;}
 5924              QSpinBox::down-button{background:#FFFFFF; border:1px solid #64B5F6; border-bottom-right-radius:3px; width:24px; height:14px;}
 5925              QSpinBox::down-button:hover{background:#E3F2FD;}
 5926              QSpinBox::down-button:pressed{background:#BBDEFB;}
 5927              QSpinBox::down-button:disabled{background:#F3F4F6; border:1px solid #D1D5DB;}
 5928              QSpinBox::up-arrow{width:18px; height:18px; image:url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHZpZXdCb3g9IjAgMCAxOCAxOCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48dGV4dCB4PSI1MCUiIHk9IjU1JSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiMxOTc2RDIiPuKshjwvdGV4dD48L3N2Zz4=);}
 5929              QSpinBox::up-arrow:disabled{image:url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHZpZXdCb3g9IjAgMCAxOCAxOCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48dGV4dCB4PSI1MCUiIHk9IjU1JSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiNDQkQ1RTEiPuKshjwvdGV4dD48L3N2Zz4=);}
 5930              QSpinBox::down-arrow{width:18px; height:18px; image:url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHZpZXdCb3g9IjAgMCAxOCAxOCIgeG1zbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48dGV4dCB4PSI1MCUiIHk9IjU1JSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRzZSIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiMxOTc2RDIiPuKshzwvdGV4dD48L3N2Zz4=);}
 5931              QSpinBox::down-arrow:disabled{image:url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHZpZXdCb3g9IjAgMCAxOCAxOCIgeG1zbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48dGV4dCB4PSI1MCUiIHk9IjU1JSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRzZSIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiNDQkQ1RTEiPuKshzwvdGV4dD48L3N2Zz4=);}
 5932              QLineEdit{background:#FFFFFF; color:#1F2937; border:1px solid #64B5F6; border-radius:4px; padding:4px;}
 5933              QLineEdit:read-only{background:#F3F4F6; color:#6B7280; border:1px solid #D1D5DB;}
 5934              QCheckBox{color:#1F2937; spacing:8px;}
 5935              QCheckBox:disabled{color:#9CA3AF;}
 5936              QCheckBox::indicator{width:22px; height:22px; background:#FFFFFF; border:2px solid #64B5F6; border-radius:4px;}
 5937              QCheckBox::indicator:disabled{background:#F3F4F6; border:2px solid #D1D5DB;}
 5938              QCheckBox::indicator:checked{background:qlineargradient(x1:0, y1:0, x2:1, y2:1, stop:0 #1976D2, stop:1 #2196F3); border:2px solid #1976D2;}
 5939              QCheckBox::indicator:checked:disabled{background:#E0E0E0; border:2px solid #D1D5DB;}
 5940              QToolButton{color:#1F2937; background:#FFFFFF; border:1px solid #64B5F6; border-radius:4px; padding:4px;}
 5941              QToolButton:hover{background:#E3F2FD;}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 121 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 5942              QToolButton::menu-indicator{image:none;}
 5943              QMenu{background:#FFFFFF; color:#1F2937; border:1px solid #64B5F6; border-radius:4px; padding:4px;}
 5944              QMenu::item{padding:6px 20px; border-radius:3px;}
 5945              QMenu::item:selected{background:#E3F2FD; color:#1976D2;}
 5946              QMenu::separator{height:1px; background:#E5EAF0; margin:4px 0px;}
 5947              QDialog{background:#E3F2FD;}
 5948              QComboBox{background:#FFFFFF; color:#1F2937; border:1px solid #64B5F6; border-radius:4px; padding:4px;}
 5949              QComboBox:disabled{background:#F3F4F6; color:#9CA3AF; border:1px solid #D1D5DB;}
 5950              QComboBox::drop-down{border:none;}
 5951              QComboBox::down-arrow{image:none; border-left:4px solid transparent; border-right:4px solid transparent; border-top:6px solid #1976D2; margin-right:8px;}
 5952              QComboBox::down-arrow:disabled{border-top-color:#9CA3AF;}
 5953              QComboBox QAbstractItemView{background:#FFFFFF; color:#1F2937; border:1px solid #64B5F6; selection-background-color:#E3F2FD;}
 5954              
 5955              /* æ»šåŠ¨æ¡æ ·å¼ */
 5956              QScrollBar:vertical{background:#E3F2FD; width:12px; border-radius:6px; margin:0px;}
 5957              QScrollBar::handle:vertical{background:#90CAF9; border-radius:6px; min-height:30px;}
 5958              QScrollBar::handle:vertical:hover{background:#64B5F6;}
 5959              QScrollBar::handle:vertical:pressed{background:#42A5F5;}
 5960              QScrollBar::add-line:vertical, QScrollBar::sub-line:vertical{height:0px;}
 5961              QScrollBar::add-page:vertical, QScrollBar::sub-page:vertical{background:transparent;}
 5962              
 5963              QScrollBar:horizontal{background:#E3F2FD; height:12px; border-radius:6px; margin:0px;}
 5964              QScrollBar::handle:horizontal{background:#90CAF9; border-radius:6px; min-width:30px;}
 5965              QScrollBar::handle:horizontal:hover{background:#64B5F6;}
 5966              QScrollBar::handle:horizontal:pressed{background:#42A5F5;}
 5967              QScrollBar::add-line:horizontal, QScrollBar::sub-line:horizontal{width:0px;}
 5968              QScrollBar::add-page:horizontal, QScrollBar::sub-page:horizontal{background:transparent;}
 5969              """
 5970          )
 5971  
 5972      def _set_checkbox_mark(self, cb: QtWidgets.QCheckBox, checked: bool):
 5973          """Fallback visual marker for checkboxes: prefix label with âœ“ when checked.
 5974          This ensures users see a clear marker even if stylesheet indicator image fails to render.
 5975          """
 5976          try:
 5977              orig = cb.property('orig_text') or cb.text()
 5978              if checked:
 5979                  # use fullwidth mark for clear appearance
 5980                  cb.setText(f"âœ“ {orig}")
 5981              else:
 5982                  cb.setText(str(orig))
 5983          except Exception:
 5984              pass
 5985  
 5986      def _build_ui(self):
 5987          # åˆ›å»ºæ»šåŠ¨åŒºåŸŸä½œä¸ºä¸­å¤®çª—å£
 5988          scroll_area = QtWidgets.QScrollArea(self)
 5989          scroll_area.setWidgetResizable(True)
 5990          scroll_area.setHorizontalScrollBarPolicy(QtCore.Qt.ScrollBarPolicy.ScrollBarAsNeeded)
 5991          scroll_area.setVerticalScrollBarPolicy(QtCore.Qt.ScrollBarPolicy.ScrollBarAsNeeded)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 122 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 5992          scroll_area.setFrameShape(QtWidgets.QFrame.Shape.NoFrame)
 5993          self.setCentralWidget(scroll_area)
 5994          
 5995          # åˆ›å»ºå†…å®¹å®¹å™¨ - ä¼˜åŒ–å®½åº¦é€‚é…é«˜åˆ†è¾¨ç‡
 5996          central = QtWidgets.QWidget()
 5997          central.setMinimumWidth(1250)  # å‡å°æœ€å°å®½åº¦
 5998          scroll_area.setWidget(central)
 5999          
 6000          root = QtWidgets.QVBoxLayout(central)
 6001          root.setSpacing(12)  # å‡å°é—´è·ï¼ŒèŠ‚çœç©ºé—´
 6002          root.setContentsMargins(12, 12, 12, 12)  # å‡å°è¾¹è·
 6003  
 6004          # header
 6005          header = QtWidgets.QHBoxLayout()
 6006          
 6007          # Logo - ä½¿ç”¨èµ„æºè·¯å¾„å‡½æ•°ç¡®ä¿æ‰“åŒ…åä¹Ÿèƒ½è®¿é—®
 6008          logo_path = get_resource_path("assets/logo.png")
 6009          if logo_path.exists():
 6010              logo_label = QtWidgets.QLabel()
 6011              pixmap = QtGui.QPixmap(str(logo_path))
 6012              if not pixmap.isNull():
 6013                  # è®¾ç½® Logo å¤§å°ï¼ˆé«˜åº¦40pxï¼Œå®½åº¦æŒ‰æ¯”ä¾‹ï¼‰
 6014                  scaled_pixmap = pixmap.scaledToHeight(40)
 6015                  logo_label.setPixmap(scaled_pixmap)
 6016                  logo_label.setStyleSheet("background: transparent;")
 6017                  header.addWidget(logo_label)
 6018                  header.addSpacing(12)  # Logo å’Œæ ‡é¢˜ä¹‹é—´çš„é—´è·
 6019              else:
 6020                  self._append_log("âš ï¸ Logo æ–‡ä»¶åŠ è½½å¤±è´¥")
 6021          else:
 6022              self._append_log(f"âš ï¸ Logo æ–‡ä»¶ä¸å­˜åœ¨: {logo_path}")
 6023          
 6024          self.header_title = QtWidgets.QLabel(t('header_title'))
 6025          self.header_title.setObjectName("Title")
 6026          ver = QtWidgets.QLabel(f"v{APP_VERSION} (PyQt)")
 6027          header.addWidget(self.header_title)
 6028          header.addWidget(ver)
 6029          header.addStretch(1)
 6030          self.role_label = QtWidgets.QLabel(t('role_guest'))
 6031          self.role_label.setStyleSheet("background:#FFF3E0; color:#E67E22; padding:6px 12px; border-radius:6px; font-weight:700;")
 6032          header.addWidget(self.role_label)
 6033          root.addLayout(header)
 6034  
 6035          # center three columns - ä¼˜åŒ–åˆ—é—´è·
 6036          center = QtWidgets.QHBoxLayout()
 6037          center.setSpacing(15)  # å‡å°åˆ—é—´è·ï¼ŒèŠ‚çœç©ºé—´
 6038          root.addLayout(center, 1)
 6039  
 6040          left = QtWidgets.QVBoxLayout()
 6041          middle = QtWidgets.QVBoxLayout()

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 123 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 6042          right = QtWidgets.QVBoxLayout()
 6043          left.setSpacing(12)  # å‡å°å¡ç‰‡é—´è·
 6044          middle.setSpacing(12)
 6045          right.setSpacing(12)
 6046          center.addLayout(left, 1)
 6047          center.addLayout(middle, 1)
 6048          center.addLayout(right, 1)
 6049  
 6050          # left cards - ä½¿ç”¨ QSplitter é˜²æ­¢å¡ç‰‡äº’ç›¸å½±å“å¤§å°
 6051          left_splitter = QtWidgets.QSplitter(QtCore.Qt.Orientation.Vertical)
 6052          left_splitter.setChildrenCollapsible(False)  # é˜²æ­¢å­éƒ¨ä»¶è¢«å®Œå…¨æŠ˜å 
 6053          left_splitter.setHandleWidth(8)  # åˆ†éš”æ¡å®½åº¦
 6054          left_splitter.setStyleSheet("""
 6055              QSplitter::handle {
 6056                  background: #E5EAF0;
 6057                  margin: 2px 0;
 6058              }
 6059              QSplitter::handle:hover {
 6060                  background: #1976D2;
 6061              }
 6062          """)
 6063          
 6064          folder_card = self._folder_card()
 6065          settings_card = self._settings_card()
 6066          
 6067          left_splitter.addWidget(folder_card)
 6068          left_splitter.addWidget(settings_card)
 6069          
 6070          # è®¾ç½®åˆå§‹æ¯”ä¾‹ï¼šæ–‡ä»¶å¤¹å¡ç‰‡è¾ƒå°ï¼Œè®¾ç½®å¡ç‰‡è¾ƒå¤§
 6071          left_splitter.setSizes([200, 500])
 6072          
 6073          left.addWidget(left_splitter)
 6074  
 6075          # middle cards - åŒæ ·ä½¿ç”¨ QSplitter
 6076          middle_splitter = QtWidgets.QSplitter(QtCore.Qt.Orientation.Vertical)
 6077          middle_splitter.setChildrenCollapsible(False)
 6078          middle_splitter.setHandleWidth(8)
 6079          middle_splitter.setStyleSheet("""
 6080              QSplitter::handle {
 6081                  background: #E5EAF0;
 6082                  margin: 2px 0;
 6083              }
 6084              QSplitter::handle:hover {
 6085                  background: #1976D2;
 6086              }
 6087          """)
 6088          
 6089          middle_splitter.addWidget(self._control_card())
 6090          middle_splitter.addWidget(self._status_card())
 6091          middle_splitter.setSizes([250, 450])

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 124 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 6092          
 6093          middle.addWidget(middle_splitter)
 6094  
 6095          # right - log card
 6096          right.addWidget(self._log_card(), 1)
 6097  
 6098      def _card(self, title_text: str, title_key: str = '') -> Tuple[QtWidgets.QFrame, QtWidgets.QVBoxLayout, Optional[QtWidgets.QLabel]]:
 6099          """åˆ›å»ºå¡ç‰‡å®¹å™¨
 6100          
 6101          Args:
 6102              title_text: æ ‡é¢˜æ–‡æœ¬
 6103              title_key: i18n ç¿»è¯‘é”®ï¼ˆç”¨äºåŠ¨æ€åˆ‡æ¢è¯­è¨€ï¼‰
 6104              
 6105          Returns:
 6106              (card, layout, title_label) - title_label ç”¨äºåç»­æ›´æ–°æ–‡æœ¬
 6107          """
 6108          card = QtWidgets.QFrame()
 6109          card.setObjectName("Card")
 6110          v = QtWidgets.QVBoxLayout(card)
 6111          v.setContentsMargins(14, 14, 14, 14)  # å‡å°å†…è¾¹è·ï¼ŒèŠ‚çœç©ºé—´
 6112          v.setSpacing(10)  # å‡å°å…ƒç´ é—´è·
 6113          title_label = None
 6114          if title_text:
 6115              title_label = QtWidgets.QLabel(title_text)
 6116              title_label.setProperty("class", "Title")
 6117              if title_key:
 6118                  title_label.setProperty("i18n_key", title_key)
 6119              v.addWidget(title_label)
 6120              line = QtWidgets.QFrame()
 6121              shape_enum = getattr(QtWidgets.QFrame, 'Shape', QtWidgets.QFrame)
 6122              line.setFrameShape(getattr(shape_enum, 'HLine'))
 6123              line.setStyleSheet("color:#E5EAF0")
 6124              v.addWidget(line)
 6125          return card, v, title_label
 6126  
 6127      def _folder_card(self) -> QtWidgets.QFrame:
 6128          card, v, self.title_folder = self._card("ğŸ“ æ–‡ä»¶å¤¹è®¾ç½®", "card_folder_settings")
 6129          
 6130          # source
 6131          self.src_edit, self.btn_choose_src, self.lbl_src = self._path_row(v, "æºæ–‡ä»¶å¤¹", self._choose_source)
 6132          # target
 6133          self.tgt_edit, self.btn_choose_tgt, self.lbl_tgt = self._path_row(v, "ç›®æ ‡æ–‡ä»¶å¤¹", self._choose_target)
 6134          # backup
 6135          self.bak_edit, self.btn_choose_bak, self.lbl_bak = self._path_row(v, "å¤‡ä»½æ–‡ä»¶å¤¹", self._choose_backup)
 6136          
 6137          # v2.1.1 æ–°å¢ï¼šå¯ç”¨å¤‡ä»½å¤é€‰æ¡†
 6138          self.cb_enable_backup = QtWidgets.QCheckBox(" å¯ç”¨å¤‡ä»½åŠŸèƒ½")
 6139          self.cb_enable_backup.setProperty('orig_text', " å¯ç”¨å¤‡ä»½åŠŸèƒ½")
 6140          self.cb_enable_backup.setChecked(True)
 6141          self.cb_enable_backup.toggled.connect(lambda checked: self._set_checkbox_mark(self.cb_enable_backup, checked))

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 125 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 6142          self.cb_enable_backup.toggled.connect(self._on_backup_toggled)
 6143          self._set_checkbox_mark(self.cb_enable_backup, self.cb_enable_backup.isChecked())
 6144          v.addWidget(self.cb_enable_backup)
 6145          
 6146          # æ·»åŠ è¯´æ˜æ–‡æœ¬
 6147          self.backup_hint = QtWidgets.QLabel(t('backup_hint'))
 6148          self.backup_hint.setWordWrap(True)
 6149          self.backup_hint.setStyleSheet("color: #666; font-size: 11px; padding: 5px 0;")
 6150          v.addWidget(self.backup_hint)
 6151          
 6152          # v3.0.0 ä¿®å¤ï¼šè®¾ç½®å›ºå®šé«˜åº¦ï¼Œé˜²æ­¢è¢«å…¶ä»–å¡ç‰‡æŒ¤å‹
 6153          card.setFixedHeight(280)
 6154          
 6155          return card
 6156  
 6157      def _path_row(self, layout: QtWidgets.QVBoxLayout, label: str, chooser):
 6158          row = QtWidgets.QHBoxLayout()
 6159          row.setSpacing(10)  # å¢åŠ å…ƒç´ é—´è·
 6160          lab = QtWidgets.QLabel(label + ":")
 6161          lab.setMinimumWidth(90)  # è®¾ç½®æ ‡ç­¾æœ€å°å®½åº¦ï¼Œå¯¹é½æ›´æ•´é½
 6162          edit = QtWidgets.QLineEdit()
 6163          edit.setMinimumHeight(32)  # å¢åŠ è¾“å…¥æ¡†é«˜åº¦
 6164          # v2.2.0 ä¿®å¤ï¼šè®¾ç½®è·¯å¾„è¾“å…¥æ¡†çš„æ–‡æœ¬å¯¹é½æ–¹å¼ï¼Œé¿å…é•¿è·¯å¾„è¢«æˆªæ–­æ˜¾ç¤º
 6165          edit.setCursorPosition(0)  # é»˜è®¤æ˜¾ç¤ºè·¯å¾„å¼€å¤´
 6166          btn = QtWidgets.QPushButton("æµè§ˆ")
 6167          btn.setProperty("class", "Secondary")
 6168          btn.setMinimumWidth(80)  # è®¾ç½®æŒ‰é’®æœ€å°å®½åº¦
 6169          btn.setMinimumHeight(32)
 6170          btn.clicked.connect(chooser)
 6171          row.addWidget(lab)
 6172          row.addWidget(edit, 1)
 6173          row.addWidget(btn)
 6174          layout.addLayout(row)
 6175          # v2.2.0 ä¿®å¤ï¼šä¸ºè¾“å…¥æ¡†è®¾ç½®å·¥å…·æç¤ºï¼Œæ˜¾ç¤ºå®Œæ•´è·¯å¾„
 6176          edit.textChanged.connect(lambda text: edit.setToolTip(text) if text else None)
 6177          return edit, btn, lab  # v3.0.2: è¿”å›æ ‡ç­¾å¼•ç”¨ç”¨äºå¤šè¯­è¨€
 6178  
 6179      def _settings_card(self) -> QtWidgets.QFrame:
 6180          card, v, self.title_settings = self._card("âš™ï¸ ä¸Šä¼ è®¾ç½®", "card_upload_settings")
 6181          
 6182          # v3.0.0 ä¿®å¤ï¼šå°†è®¾ç½®å†…å®¹æ”¾å…¥æ»šåŠ¨åŒºåŸŸï¼Œé˜²æ­¢å¯æŠ˜å ç»„ä»¶å±•å¼€æ—¶å½±å“å…¶ä»–å¡ç‰‡å¤§å°
 6183          scroll_area = QtWidgets.QScrollArea()
 6184          scroll_area.setWidgetResizable(True)
 6185          scroll_area.setFrameShape(QtWidgets.QFrame.Shape.NoFrame)
 6186          scroll_area.setHorizontalScrollBarPolicy(QtCore.Qt.ScrollBarPolicy.ScrollBarAlwaysOff)
 6187          scroll_area.setVerticalScrollBarPolicy(QtCore.Qt.ScrollBarPolicy.ScrollBarAsNeeded)
 6188          # å…³é”®ï¼šè®¾ç½®å°ºå¯¸ç­–ç•¥ï¼Œé˜²æ­¢æ»šåŠ¨åŒºåŸŸéšå†…å®¹æ‰©å±•
 6189          scroll_area.setSizePolicy(
 6190              QtWidgets.QSizePolicy.Policy.Expanding,
 6191              QtWidgets.QSizePolicy.Policy.Expanding

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 126 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 6192          )
 6193          # è®¾ç½®æ»šåŠ¨åŒºåŸŸçš„æœ€å°é«˜åº¦ï¼Œé˜²æ­¢è¢«å‹ç¼©å¾—å¤ªå°
 6194          scroll_area.setMinimumHeight(200)
 6195          
 6196          # åˆ›å»ºæ»šåŠ¨å†…å®¹å®¹å™¨
 6197          scroll_content = QtWidgets.QWidget()
 6198          scroll_layout = QtWidgets.QVBoxLayout(scroll_content)
 6199          scroll_layout.setContentsMargins(0, 0, 8, 0)  # å³è¾¹ç•™å‡ºæ»šåŠ¨æ¡ç©ºé—´
 6200          scroll_layout.setSpacing(10)
 6201          
 6202          # å°†åç»­æ‰€æœ‰å†…å®¹æ·»åŠ åˆ° scroll_layout è€Œä¸æ˜¯ v
 6203          # ========== v2.0 æ–°å¢ï¼šåè®®é€‰æ‹© ==========
 6204          self.protocol_title_label = QtWidgets.QLabel(t('upload_protocol_title'))
 6205          self.protocol_title_label.setStyleSheet("color:#1976D2; font-size:11px; font-weight:700;")
 6206          scroll_layout.addWidget(self.protocol_title_label)
 6207          
 6208          # åè®®é€‰æ‹©ä¸‹æ‹‰æ¡†
 6209          protocol_row = QtWidgets.QHBoxLayout()
 6210          self.protocol_type_label = QtWidgets.QLabel(t('protocol_type_label'))
 6211          self.combo_protocol = QtWidgets.QComboBox()
 6212          self.combo_protocol.addItems([
 6213              t('protocol_option_smb'),
 6214              t('protocol_option_ftp_server'),
 6215              t('protocol_option_ftp_client'),
 6216              t('protocol_option_both')
 6217          ])
 6218          self.combo_protocol.currentIndexChanged.connect(self._on_protocol_changed)
 6219          protocol_row.addWidget(self.protocol_type_label)
 6220          protocol_row.addWidget(self.combo_protocol, 1)
 6221          scroll_layout.addLayout(protocol_row)
 6222          
 6223          # åè®®è¯´æ˜
 6224          self.protocol_desc = QtWidgets.QLabel()
 6225          self.protocol_desc.setWordWrap(True)
 6226          self.protocol_desc.setStyleSheet("color: #6B7280; padding: 8px; background: #F3F4F6; border-radius: 6px; font-size: 10px;")
 6227          scroll_layout.addWidget(self.protocol_desc)
 6228          self._update_protocol_description(0)
 6229          
 6230          # FTP é…ç½®å®¹å™¨ï¼ˆå¯æŠ˜å ï¼‰
 6231          self.ftp_config_widget = QtWidgets.QWidget()
 6232          self.ftp_config_widget.setVisible(False)
 6233          ftp_layout = QtWidgets.QVBoxLayout(self.ftp_config_widget)
 6234          ftp_layout.setContentsMargins(0, 8, 0, 0)
 6235          ftp_layout.setSpacing(10)
 6236          
 6237          # ========== FTP æœåŠ¡å™¨é…ç½® - å¯æŠ˜å  ==========
 6238          self.ftp_server_collapsible = MainWindow.CollapsibleBox(t('ftp_server_config'), self)
 6239          server_layout = QtWidgets.QFormLayout()
 6240          server_layout.setSpacing(8)
 6241          server_layout.setContentsMargins(0, 0, 0, 0)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 127 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 6242          
 6243          self.ftp_server_host = QtWidgets.QLineEdit("0.0.0.0")
 6244          self.ftp_server_host.setToolTip(t('listen_address_tooltip'))
 6245          server_layout.addRow(t('listen_address'), self.ftp_server_host)
 6246          
 6247          self.ftp_server_port = QtWidgets.QSpinBox()
 6248          self.ftp_server_port.setRange(1, 65535)
 6249          self.ftp_server_port.setValue(2121)
 6250          self.ftp_server_port.setToolTip(t('port_tooltip'))
 6251          server_layout.addRow(t('port_label'), self.ftp_server_port)
 6252          
 6253          self.ftp_server_user = QtWidgets.QLineEdit("upload_user")
 6254          self.ftp_server_user.setToolTip(t('username_tooltip'))
 6255          server_layout.addRow(t('username_label'), self.ftp_server_user)
 6256          
 6257          self.ftp_server_pass = QtWidgets.QLineEdit("upload_pass")
 6258          self.ftp_server_pass.setEchoMode(QtWidgets.QLineEdit.EchoMode.Password)
 6259          self.ftp_server_pass.setToolTip(t('password_tooltip'))
 6260          server_layout.addRow(t('password_label'), self.ftp_server_pass)
 6261          
 6262          # å…±äº«ç›®å½•é€‰æ‹©
 6263          share_row = QtWidgets.QHBoxLayout()
 6264          self.ftp_server_share = QtWidgets.QLineEdit()
 6265          self.ftp_server_share.setPlaceholderText(t('select_ftp_share'))
 6266          self.ftp_server_share.setToolTip(t('share_dir_tooltip'))
 6267          btn_choose_share = QtWidgets.QPushButton(t('browse'))
 6268          btn_choose_share.setProperty("class", "Secondary")
 6269          btn_choose_share.clicked.connect(self._choose_ftp_share)
 6270          share_row.addWidget(self.ftp_server_share, 1)
 6271          share_row.addWidget(btn_choose_share)
 6272          server_layout.addRow(t('share_directory'), share_row)
 6273          
 6274          # v2.0 æ–°å¢ï¼šé«˜çº§é€‰é¡¹ - è¢«åŠ¨æ¨¡å¼
 6275          self.cb_server_passive = QtWidgets.QCheckBox(t('enable_passive'))
 6276          self.cb_server_passive.setChecked(True)
 6277          self.cb_server_passive.setToolTip(t('passive_mode_tooltip'))
 6278          server_layout.addRow("", self.cb_server_passive)
 6279          
 6280          # è¢«åŠ¨ç«¯å£èŒƒå›´
 6281          passive_row = QtWidgets.QHBoxLayout()
 6282          self.ftp_server_passive_start = QtWidgets.QSpinBox()
 6283          self.ftp_server_passive_start.setRange(1024, 65535)
 6284          self.ftp_server_passive_start.setValue(60000)
 6285          self.ftp_server_passive_start.setPrefix(t('port_start') + " ")
 6286          passive_row.addWidget(self.ftp_server_passive_start)
 6287          
 6288          self.ftp_server_passive_end = QtWidgets.QSpinBox()
 6289          self.ftp_server_passive_end.setRange(1024, 65535)
 6290          self.ftp_server_passive_end.setValue(65535)
 6291          self.ftp_server_passive_end.setPrefix(t('port_end') + " ")

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 128 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 6292          passive_row.addWidget(self.ftp_server_passive_end)
 6293          passive_row.addStretch()
 6294          server_layout.addRow("  " + t('port_range'), passive_row)
 6295          
 6296          # v2.0 æ–°å¢ï¼šTLS/SSLé€‰é¡¹
 6297          self.cb_server_tls = QtWidgets.QCheckBox(t('enable_tls'))
 6298          self.cb_server_tls.setChecked(False)
 6299          self.cb_server_tls.setToolTip(t('enable_tls_tooltip'))
 6300          server_layout.addRow("", self.cb_server_tls)
 6301          
 6302          # v2.0 æ–°å¢ï¼šè¿æ¥æ•°é™åˆ¶
 6303          conn_row = QtWidgets.QHBoxLayout()
 6304          self.conn_label = QtWidgets.QLabel(t('max_connections'))
 6305          self.ftp_server_max_conn = QtWidgets.QSpinBox()
 6306          self.ftp_server_max_conn.setRange(1, 1000)
 6307          self.ftp_server_max_conn.setValue(256)
 6308          self.ftp_server_max_conn.setSuffix(" " + t('unit_connections'))
 6309          conn_row.addWidget(self.conn_label)
 6310          conn_row.addWidget(self.ftp_server_max_conn)
 6311          
 6312          self.ip_label = QtWidgets.QLabel("  " + t('per_ip_limit'))
 6313          self.ftp_server_max_conn_per_ip = QtWidgets.QSpinBox()
 6314          self.ftp_server_max_conn_per_ip.setRange(1, 100)
 6315          self.ftp_server_max_conn_per_ip.setValue(5)
 6316          self.ftp_server_max_conn_per_ip.setSuffix(" " + t('unit_connections'))
 6317          conn_row.addWidget(self.ip_label)
 6318          conn_row.addWidget(self.ftp_server_max_conn_per_ip)
 6319          conn_row.addStretch()
 6320          server_layout.addRow(t('connection_limit'), conn_row)
 6321          
 6322          # v2.0 æ–°å¢ï¼šFTPæœåŠ¡å™¨æµ‹è¯•æŒ‰é’®
 6323          self.btn_test_ftp_server = QtWidgets.QPushButton(t('test_config'))
 6324          self.btn_test_ftp_server.setProperty("class", "Secondary")
 6325          self.btn_test_ftp_server.clicked.connect(self._test_ftp_server_config)
 6326          server_layout.addRow("", self.btn_test_ftp_server)
 6327          
 6328          self.ftp_server_collapsible.setContentLayout(server_layout)
 6329          ftp_layout.addWidget(self.ftp_server_collapsible)
 6330          
 6331          # ========== FTP å®¢æˆ·ç«¯é…ç½® - å¯æŠ˜å  ==========
 6332          self.ftp_client_collapsible = MainWindow.CollapsibleBox(t('ftp_client_config'), self)
 6333          client_layout = QtWidgets.QFormLayout()
 6334          client_layout.setSpacing(8)
 6335          client_layout.setContentsMargins(0, 0, 0, 0)
 6336          
 6337          self.ftp_client_host = QtWidgets.QLineEdit()
 6338          self.ftp_client_host.setPlaceholderText("ftp.example.com")
 6339          self.ftp_client_host.setToolTip(t('server_address_tooltip'))
 6340          client_layout.addRow(t('server_label'), self.ftp_client_host)
 6341          

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 129 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 6342          self.ftp_client_port = QtWidgets.QSpinBox()
 6343          self.ftp_client_port.setRange(1, 65535)
 6344          self.ftp_client_port.setValue(21)
 6345          self.ftp_client_port.setToolTip(t('client_port_tooltip'))
 6346          client_layout.addRow(t('port_label'), self.ftp_client_port)
 6347          
 6348          self.ftp_client_user = QtWidgets.QLineEdit()
 6349          self.ftp_client_user.setPlaceholderText(t('username_placeholder'))
 6350          self.ftp_client_user.setToolTip(t('client_username_tooltip'))
 6351          client_layout.addRow(t('username_label'), self.ftp_client_user)
 6352          
 6353          self.ftp_client_pass = QtWidgets.QLineEdit()
 6354          self.ftp_client_pass.setEchoMode(QtWidgets.QLineEdit.EchoMode.Password)
 6355          self.ftp_client_pass.setPlaceholderText(t('password_placeholder'))
 6356          self.ftp_client_pass.setToolTip(t('client_password_tooltip'))
 6357          client_layout.addRow(t('password_label'), self.ftp_client_pass)
 6358          
 6359          self.ftp_client_remote = QtWidgets.QLineEdit("/upload")
 6360          self.ftp_client_remote.setToolTip(t('remote_path_tooltip'))
 6361          client_layout.addRow(t('remote_path'), self.ftp_client_remote)
 6362          
 6363          # v2.0 æ–°å¢ï¼šè¶…æ—¶å’Œé‡è¯•é…ç½®
 6364          timeout_row = QtWidgets.QHBoxLayout()
 6365          self.ftp_client_timeout = QtWidgets.QSpinBox()
 6366          self.ftp_client_timeout.setRange(10, 300)
 6367          self.ftp_client_timeout.setValue(30)
 6368          self.ftp_client_timeout.setSuffix(" " + t('seconds'))
 6369          self.ftp_client_timeout.setToolTip(t('timeout_tooltip'))
 6370          timeout_row.addWidget(self.ftp_client_timeout)
 6371          timeout_row.addStretch()
 6372          client_layout.addRow(t('timeout_label'), timeout_row)
 6373          
 6374          retry_row = QtWidgets.QHBoxLayout()
 6375          self.ftp_client_retry = QtWidgets.QSpinBox()
 6376          self.ftp_client_retry.setRange(0, 10)
 6377          self.ftp_client_retry.setValue(3)
 6378          self.ftp_client_retry.setSuffix(" " + t('unit_times'))
 6379          self.ftp_client_retry.setToolTip(t('retry_tooltip'))
 6380          retry_row.addWidget(self.ftp_client_retry)
 6381          retry_row.addStretch()
 6382          client_layout.addRow(t('ftp_retry_label'), retry_row)
 6383          
 6384          # v2.0 æ–°å¢ï¼šé«˜çº§é€‰é¡¹ - è¢«åŠ¨æ¨¡å¼
 6385          self.cb_client_passive = QtWidgets.QCheckBox(t('use_passive_mode'))
 6386          self.cb_client_passive.setChecked(True)
 6387          self.cb_client_passive.setToolTip(t('passive_mode_tooltip'))
 6388          client_layout.addRow("", self.cb_client_passive)
 6389          
 6390          # v2.0 æ–°å¢ï¼šTLS/SSLé€‰é¡¹
 6391          self.cb_client_tls = QtWidgets.QCheckBox(t('enable_tls'))

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 130 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 6392          self.cb_client_tls.setChecked(False)
 6393          self.cb_client_tls.setToolTip(t('client_tls_tooltip'))
 6394          client_layout.addRow("", self.cb_client_tls)
 6395          
 6396          # v2.0 æ–°å¢ï¼šFTPå®¢æˆ·ç«¯æµ‹è¯•æŒ‰é’®
 6397          self.btn_test_ftp_client = QtWidgets.QPushButton(t('test_connection'))
 6398          self.btn_test_ftp_client.setProperty("class", "Secondary")
 6399          self.btn_test_ftp_client.clicked.connect(self._test_ftp_client_connection)
 6400          client_layout.addRow("", self.btn_test_ftp_client)
 6401          
 6402          self.ftp_client_collapsible.setContentLayout(client_layout)
 6403          ftp_layout.addWidget(self.ftp_client_collapsible)
 6404          
 6405          scroll_layout.addWidget(self.ftp_config_widget)
 6406          
 6407          scroll_layout.addWidget(self._hline())
 6408          # ========== v2.0 åè®®é€‰æ‹©ç»“æŸ ==========
 6409          
 6410          # interval - v3.0.2: è§£åŒ…è¿”å›å€¼ä¿å­˜æ ‡ç­¾å¼•ç”¨ç”¨äºå¤šè¯­è¨€
 6411          self.spin_interval, self.lbl_interval = self._spin_row(scroll_layout, t("interval_label"), 10, 3600, 30)
 6412          self.spin_disk, self.lbl_disk = self._spin_row(scroll_layout, t("disk_threshold_label"), 5, 50, 10)
 6413          self.spin_retry, self.lbl_retry = self._spin_row(scroll_layout, t("retry_label"), 0, 10, 3)
 6414          self.spin_disk_check, self.lbl_disk_check = self._spin_row(scroll_layout, t("disk_check_label"), 1, 60, 5)
 6415          # ç»‘å®šç£ç›˜æ£€æŸ¥é—´éš”å˜åŒ–äº‹ä»¶
 6416          self.spin_disk_check.valueChanged.connect(lambda val: setattr(self, 'disk_check_interval', val))
 6417          
 6418          # ========== æ–‡ä»¶ç±»å‹é™åˆ¶ - å¯æŠ˜å  ==========
 6419          self.filter_collapsible = MainWindow.CollapsibleBox(t('file_filter_title'), self)
 6420          grid = QtWidgets.QGridLayout()
 6421          grid.setSpacing(10)
 6422          self.cb_ext = {}
 6423          exts = [
 6424              ("JPG", ".jpg"), ("PNG", ".png"), ("BMP", ".bmp"), ("TIFF", ".tiff"), ("GIF", ".gif"), ("RAW", ".raw")
 6425          ]
 6426          for i, (name, ext) in enumerate(exts):
 6427              cb = QtWidgets.QCheckBox(name)
 6428              # store original text so we can add a visible âœ“ fallback if styling fails
 6429              cb.setProperty('orig_text', name)
 6430              cb.setChecked(True)
 6431              # connect toggled to update visible text marker (robust fallback)
 6432              cb.toggled.connect(lambda checked, cb=cb: self._set_checkbox_mark(cb, checked))
 6433              # initialize text with marker if checked
 6434              self._set_checkbox_mark(cb, cb.isChecked())
 6435              self.cb_ext[ext] = cb
 6436              grid.addWidget(cb, i//3, i%3)
 6437          self.filter_collapsible.addLayout(grid)
 6438          scroll_layout.addWidget(self.filter_collapsible)
 6439          
 6440          # ========== é«˜çº§é€‰é¡¹ - å¯æŠ˜å  ==========
 6441          self.adv_collapsible = MainWindow.CollapsibleBox(t('advanced_options_title'), self)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 131 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 6442          
 6443          self.cb_auto_start_windows = QtWidgets.QCheckBox(t('auto_start_windows'))
 6444          self.cb_auto_start_windows.setProperty('orig_text', t('auto_start_windows'))
 6445          self.cb_auto_start_windows.setChecked(False)
 6446          self.cb_auto_start_windows.toggled.connect(self._toggle_autostart)
 6447          self.cb_auto_start_windows.toggled.connect(lambda checked: self._set_checkbox_mark(self.cb_auto_start_windows, checked))
 6448          self._set_checkbox_mark(self.cb_auto_start_windows, self.cb_auto_start_windows.isChecked())
 6449          self.adv_collapsible.addWidget(self.cb_auto_start_windows)
 6450          
 6451          self.cb_auto_run_on_startup = QtWidgets.QCheckBox(t('auto_run_on_startup'))
 6452          self.cb_auto_run_on_startup.setProperty('orig_text', t('auto_run_on_startup'))
 6453          self.cb_auto_run_on_startup.setChecked(False)
 6454          self.cb_auto_run_on_startup.toggled.connect(lambda checked: self._set_checkbox_mark(self.cb_auto_run_on_startup, checked))
 6455          self._set_checkbox_mark(self.cb_auto_run_on_startup, self.cb_auto_run_on_startup.isChecked())
 6456          self.adv_collapsible.addWidget(self.cb_auto_run_on_startup)
 6457          
 6458          # v2.2.0 æ–°å¢ï¼šæ‰˜ç›˜é€šçŸ¥å¼€å…³
 6459          self.cb_show_notifications = QtWidgets.QCheckBox(t('show_notifications'))
 6460          self.cb_show_notifications.setProperty('orig_text', t('show_notifications'))
 6461          self.cb_show_notifications.setChecked(True)
 6462          self.cb_show_notifications.toggled.connect(lambda checked: setattr(self, 'show_notifications', checked))
 6463          self.cb_show_notifications.toggled.connect(lambda checked: self._set_checkbox_mark(self.cb_show_notifications, checked))
 6464          self._set_checkbox_mark(self.cb_show_notifications, self.cb_show_notifications.isChecked())
 6465          self.adv_collapsible.addWidget(self.cb_show_notifications)
 6466          
 6467          # v2.3.0 æ–°å¢ï¼šé€Ÿç‡é™åˆ¶
 6468          rate_row = QtWidgets.QHBoxLayout()
 6469          self.cb_limit_rate = QtWidgets.QCheckBox(t('limit_upload_rate'))
 6470          self.cb_limit_rate.setProperty('orig_text', t('limit_upload_rate'))
 6471          self.cb_limit_rate.setToolTip(t('limit_rate_tooltip'))
 6472          self.cb_limit_rate.setChecked(False)
 6473          self.cb_limit_rate.toggled.connect(self._on_rate_limit_toggled)
 6474          self.cb_limit_rate.toggled.connect(lambda checked: self._set_checkbox_mark(self.cb_limit_rate, checked))
 6475          self._set_checkbox_mark(self.cb_limit_rate, self.cb_limit_rate.isChecked())
 6476          
 6477          self.spin_max_rate = QtWidgets.QDoubleSpinBox()
 6478          self.spin_max_rate.setRange(0.1, 1000.0)
 6479          self.spin_max_rate.setValue(10.0)
 6480          self.spin_max_rate.setSuffix(" MB/s")
 6481          self.spin_max_rate.setSingleStep(0.5)
 6482          self.spin_max_rate.setEnabled(False)
 6483          self.spin_max_rate.setToolTip(t('max_rate_tooltip'))
 6484          self.spin_max_rate.valueChanged.connect(lambda: setattr(self, 'config_modified', True))
 6485          
 6486          rate_row.addWidget(self.cb_limit_rate)
 6487          rate_row.addWidget(self.spin_max_rate)
 6488          rate_row.addStretch()
 6489          self.adv_collapsible.addLayout(rate_row)
 6490          
 6491          # æ·»åŠ åˆ†éš”çº¿

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 132 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 6492          self.adv_collapsible.addWidget(self._hline())
 6493          
 6494          # å»é‡åŠŸèƒ½
 6495          self.cb_dedup_enable = QtWidgets.QCheckBox(t('enable_dedup'))
 6496          self.cb_dedup_enable.setProperty('orig_text', t('enable_dedup'))
 6497          self.cb_dedup_enable.setChecked(False)
 6498          self.cb_dedup_enable.toggled.connect(self._on_dedup_toggled)
 6499          self.cb_dedup_enable.toggled.connect(lambda checked: self._set_checkbox_mark(self.cb_dedup_enable, checked))
 6500          self._set_checkbox_mark(self.cb_dedup_enable, self.cb_dedup_enable.isChecked())
 6501          self.adv_collapsible.addWidget(self.cb_dedup_enable)
 6502          
 6503          # å“ˆå¸Œç®—æ³•é€‰æ‹©
 6504          hash_row = QtWidgets.QHBoxLayout()
 6505          self.hash_lab = QtWidgets.QLabel(t('hash_algorithm') + ":")
 6506          self.combo_hash = QtWidgets.QComboBox()
 6507          self.combo_hash.addItems(["MD5", "SHA256"])
 6508          self.combo_hash.setEnabled(False)
 6509          hash_row.addWidget(self.hash_lab)
 6510          hash_row.addWidget(self.combo_hash)
 6511          self.adv_collapsible.addLayout(hash_row)
 6512          
 6513          # å»é‡ç­–ç•¥é€‰æ‹©
 6514          strategy_row = QtWidgets.QHBoxLayout()
 6515          self.strategy_lab = QtWidgets.QLabel(t('duplicate_strategy') + ":")
 6516          self.combo_strategy = QtWidgets.QComboBox()
 6517          self.combo_strategy.addItems([t('strategy_skip'), t('strategy_rename'), t('strategy_overwrite'), t('strategy_ask')])
 6518          self.combo_strategy.setEnabled(False)
 6519          strategy_row.addWidget(self.strategy_lab)
 6520          strategy_row.addWidget(self.combo_strategy)
 6521          self.adv_collapsible.addLayout(strategy_row)
 6522          
 6523          # è¯´æ˜æ–‡æœ¬
 6524          self.dedup_hint = QtWidgets.QLabel(t('dedup_hint'))
 6525          self.dedup_hint.setStyleSheet("color:#757575; font-size:9px; padding:4px;")
 6526          self.dedup_hint.setWordWrap(True)
 6527          self.adv_collapsible.addWidget(self.dedup_hint)
 6528          
 6529          # æ·»åŠ åˆ†éš”çº¿
 6530          self.adv_collapsible.addWidget(self._hline())
 6531          
 6532          # ç½‘ç»œç›‘æ§é€‰é¡¹
 6533          self.network_sub_lab = QtWidgets.QLabel(t('network_monitor'))
 6534          self.network_sub_lab.setStyleSheet("color:#666; font-size:10px; font-weight:700;")
 6535          self.adv_collapsible.addWidget(self.network_sub_lab)
 6536          
 6537          # ç½‘ç»œæ£€æµ‹é—´éš” - å‹ç¼©å¸ƒå±€
 6538          network_check_row = QtWidgets.QHBoxLayout()
 6539          self.network_check_lab = QtWidgets.QLabel(t('check_interval_label'))
 6540          self.spin_network_check = QtWidgets.QSpinBox()
 6541          self.spin_network_check.setRange(5, 60)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 133 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 6542          self.spin_network_check.setValue(10)
 6543          self.spin_network_check.setSuffix(" " + t('seconds'))
 6544          network_check_row.addWidget(self.network_check_lab)
 6545          network_check_row.addWidget(self.spin_network_check)
 6546          network_check_row.addStretch()
 6547          self.adv_collapsible.addLayout(network_check_row)
 6548          
 6549          self.cb_network_auto_pause = QtWidgets.QCheckBox(t('auto_pause_on_disconnect'))
 6550          self.cb_network_auto_pause.setProperty('orig_text', t('auto_pause_on_disconnect'))
 6551          self.cb_network_auto_pause.setChecked(True)
 6552          self.cb_network_auto_pause.toggled.connect(lambda checked: self._set_checkbox_mark(self.cb_network_auto_pause, checked))
 6553          self._set_checkbox_mark(self.cb_network_auto_pause, self.cb_network_auto_pause.isChecked())
 6554          self.adv_collapsible.addWidget(self.cb_network_auto_pause)
 6555          
 6556          self.cb_network_auto_resume = QtWidgets.QCheckBox(t('auto_resume_on_reconnect'))
 6557          self.cb_network_auto_resume.setProperty('orig_text', t('auto_resume_on_reconnect'))
 6558          self.cb_network_auto_resume.setChecked(True)
 6559          self.cb_network_auto_resume.toggled.connect(lambda checked: self._set_checkbox_mark(self.cb_network_auto_resume, checked))
 6560          self._set_checkbox_mark(self.cb_network_auto_resume, self.cb_network_auto_resume.isChecked())
 6561          self.adv_collapsible.addWidget(self.cb_network_auto_resume)
 6562          
 6563          # è¯´æ˜æ–‡æœ¬
 6564          self.network_hint = QtWidgets.QLabel(t('network_hint'))
 6565          self.network_hint.setStyleSheet("color:#757575; font-size:9px; padding:4px;")
 6566          self.network_hint.setWordWrap(True)
 6567          self.adv_collapsible.addWidget(self.network_hint)
 6568          
 6569          scroll_layout.addWidget(self.adv_collapsible)
 6570          
 6571          # æ·»åŠ å¼¹æ€§ç©ºé—´ï¼Œä½¿å†…å®¹ç´§å‡‘æ’åˆ—
 6572          scroll_layout.addStretch()
 6573          
 6574          # è®¾ç½®æ»šåŠ¨åŒºåŸŸ
 6575          scroll_area.setWidget(scroll_content)
 6576          v.addWidget(scroll_area, 1)  # stretch=1 è®©æ»šåŠ¨åŒºåŸŸå¡«æ»¡å‰©ä½™ç©ºé—´
 6577          
 6578          return card
 6579  
 6580      def _spin_row(self, layout: QtWidgets.QVBoxLayout, label: str, low: int, high: int, val: int):
 6581          """åˆ›å»ºå¸¦æ ‡ç­¾çš„æ•°å€¼è¾“å…¥è¡Œï¼Œè¿”å› (QSpinBox, QLabel) ç”¨äºå¤šè¯­è¨€æ”¯æŒ"""
 6582          row = QtWidgets.QHBoxLayout()
 6583          lab = QtWidgets.QLabel(label + ":")
 6584          sp = QtWidgets.QSpinBox()
 6585          sp.setRange(low, high)
 6586          sp.setValue(val)
 6587          row.addWidget(lab)
 6588          row.addWidget(sp)
 6589          layout.addLayout(row)
 6590          return sp, lab  # v3.0.2: è¿”å›æ ‡ç­¾ç”¨äºå¤šè¯­è¨€
 6591  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 134 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 6592      def _control_card(self) -> QtWidgets.QFrame:
 6593          card, v, self.title_control = self._card("ğŸ® æ“ä½œæ§åˆ¶", "card_control")
 6594          
 6595          # primary start - ä¼˜åŒ–æŒ‰é’®å°ºå¯¸
 6596          self.btn_start = QtWidgets.QPushButton("â–¶ å¼€å§‹ä¸Šä¼ ")
 6597          self.btn_start.setProperty("class", "Primary")
 6598          self.btn_start.setMinimumHeight(45)  # å¢åŠ æŒ‰é’®é«˜åº¦ï¼Œæ›´å®¹æ˜“ç‚¹å‡»
 6599          self.btn_start.clicked.connect(self._on_start)
 6600          v.addWidget(self.btn_start)
 6601          # secondary pause/stop
 6602          row = QtWidgets.QHBoxLayout()
 6603          row.setSpacing(12)  # å¢åŠ æŒ‰é’®é—´è·
 6604          self.btn_pause = QtWidgets.QPushButton("â¸ æš‚åœä¸Šä¼ ")
 6605          self.btn_pause.setProperty("class", "Warning")
 6606          self.btn_pause.setMinimumHeight(40)
 6607          self.btn_pause.setEnabled(False)
 6608          self.btn_pause.clicked.connect(self._on_pause_resume)
 6609          self.btn_stop = QtWidgets.QPushButton("â¹ åœæ­¢ä¸Šä¼ ")
 6610          self.btn_stop.setProperty("class", "Danger")
 6611          self.btn_stop.setMinimumHeight(40)
 6612          self.btn_stop.setEnabled(False)
 6613          self.btn_stop.clicked.connect(self._on_stop)
 6614          row.addWidget(self.btn_pause)
 6615          row.addWidget(self.btn_stop)
 6616          v.addLayout(row)
 6617          # separator
 6618          v.addWidget(self._hline())
 6619          # save + more
 6620          row2 = QtWidgets.QHBoxLayout()
 6621          row2.setSpacing(12)  # å¢åŠ æŒ‰é’®é—´è·
 6622          self.btn_save = QtWidgets.QPushButton("ğŸ’¾ ä¿å­˜é…ç½®")
 6623          self.btn_save.setProperty("class", "Secondary")
 6624          self.btn_save.setMinimumHeight(38)
 6625          self.btn_save.clicked.connect(self._save_config)
 6626          self.btn_more = QtWidgets.QToolButton()
 6627          self.btn_more.setText("æ›´å¤š â–¾")
 6628          self.btn_more.setMinimumHeight(38)
 6629          popup_enum = getattr(QtWidgets.QToolButton, 'ToolButtonPopupMode', QtWidgets.QToolButton)
 6630          self.btn_more.setPopupMode(getattr(popup_enum, 'InstantPopup'))
 6631          menu = QtWidgets.QMenu(self)
 6632          act_clear = menu.addAction("ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—")
 6633          act_clear.triggered.connect(self._clear_logs)
 6634          menu.addSeparator()
 6635          act_disk_cleanup = menu.addAction("ğŸ’¿ ç£ç›˜æ¸…ç†")
 6636          act_disk_cleanup.triggered.connect(self._show_disk_cleanup)
 6637          menu.addSeparator()
 6638          
 6639          # v3.0.2 æ–°å¢ï¼šè¯­è¨€åˆ‡æ¢å­èœå•
 6640          lang_menu = menu.addMenu("ğŸŒ è¯­è¨€ / Language")
 6641          self.act_lang_zh = lang_menu.addAction("ç®€ä½“ä¸­æ–‡")

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 135 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 6642          self.act_lang_zh.setCheckable(True)
 6643          self.act_lang_zh.triggered.connect(lambda: self._switch_language('zh_CN'))
 6644          self.act_lang_en = lang_menu.addAction("English")
 6645          self.act_lang_en.setCheckable(True)
 6646          self.act_lang_en.triggered.connect(lambda: self._switch_language('en_US'))
 6647          # é»˜è®¤é€‰ä¸­ä¸­æ–‡
 6648          self.act_lang_zh.setChecked(True)
 6649          
 6650          menu.addSeparator()
 6651          act_login = menu.addAction("ğŸ” æƒé™ç™»å½•")
 6652          act_login.triggered.connect(self._show_login)
 6653          act_change_pwd = menu.addAction("ğŸ”‘ ä¿®æ”¹å¯†ç ")
 6654          act_change_pwd.triggered.connect(self._show_change_password)
 6655          menu.addSeparator()
 6656          act_logout = menu.addAction("ğŸšª é€€å‡ºç™»å½•")
 6657          act_logout.triggered.connect(self._logout)
 6658          self.btn_more.setMenu(menu)
 6659          
 6660          # ä¿å­˜èœå•é¡¹å¼•ç”¨ç”¨äºå¤šè¯­è¨€æ›´æ–°
 6661          self.menu_items = {
 6662              'clear_logs': act_clear,
 6663              'disk_cleanup': act_disk_cleanup,
 6664              'login': act_login,
 6665              'change_password': act_change_pwd,
 6666              'logout': act_logout,
 6667              'lang_menu': lang_menu,
 6668          }
 6669          
 6670          row2.addWidget(self.btn_save)
 6671          row2.addWidget(self.btn_more)
 6672          v.addLayout(row2)
 6673          
 6674          # v3.0.0 ä¿®å¤ï¼šè®¾ç½®å›ºå®šé«˜åº¦ï¼Œé˜²æ­¢è¢«å…¶ä»–å¡ç‰‡æŒ¤å‹
 6675          card.setFixedHeight(260)
 6676          
 6677          return card
 6678  
 6679      def _switch_language(self, lang: str):
 6680          """åˆ‡æ¢è¯­è¨€å¹¶åˆ·æ–° UI"""
 6681          try:
 6682              from src.core.i18n import set_language, get_language, LANG_ZH_CN, LANG_EN_US
 6683              
 6684              if lang == get_language():
 6685                  return
 6686              
 6687              set_language(lang)
 6688              
 6689              # æ›´æ–°èœå•é€‰ä¸­çŠ¶æ€
 6690              self.act_lang_zh.setChecked(lang == LANG_ZH_CN)
 6691              self.act_lang_en.setChecked(lang == LANG_EN_US)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 136 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 6692              
 6693              # åˆ·æ–°æ‰€æœ‰ UI æ–‡æœ¬
 6694              self._refresh_ui_texts()
 6695              
 6696              # æ˜¾ç¤ºæç¤º
 6697              if lang == LANG_ZH_CN:
 6698                  self._toast('è¯­è¨€å·²åˆ‡æ¢ä¸ºç®€ä½“ä¸­æ–‡', 'success')
 6699                  self._append_log('ğŸŒ è¯­è¨€å·²åˆ‡æ¢ä¸ºç®€ä½“ä¸­æ–‡')
 6700              else:
 6701                  self._toast('Language changed to English', 'success')
 6702                  self._append_log('ğŸŒ Language changed to English')
 6703              
 6704              # ä¿å­˜è¯­è¨€è®¾ç½®åˆ°é…ç½®
 6705              self.config_modified = True
 6706              
 6707          except Exception as e:
 6708              self._append_log(f'âš  è¯­è¨€åˆ‡æ¢å¤±è´¥: {e}')
 6709  
 6710      def _refresh_ui_texts(self):
 6711          """åˆ·æ–°æ‰€æœ‰ UI æ–‡æœ¬ï¼ˆç”¨äºè¯­è¨€åˆ‡æ¢ï¼‰"""
 6712          try:
 6713              from src.core.i18n import t
 6714              
 6715              # === å¡ç‰‡æ ‡é¢˜ ===
 6716              if hasattr(self, 'title_folder') and self.title_folder:
 6717                  self.title_folder.setText(t('card_folder_settings'))
 6718              if hasattr(self, 'title_settings') and self.title_settings:
 6719                  self.title_settings.setText(t('card_upload_settings'))
 6720              if hasattr(self, 'title_control') and self.title_control:
 6721                  self.title_control.setText(t('card_control'))
 6722              if hasattr(self, 'title_status') and self.title_status:
 6723                  self.title_status.setText(t('card_status'))
 6724              if hasattr(self, 'title_log') and self.title_log:
 6725                  self.title_log.setText(t('card_log'))
 6726              
 6727              # === æŒ‰é’® ===
 6728              if not self.is_running:
 6729                  self.btn_start.setText(t('start_upload'))
 6730              if self.is_paused:
 6731                  self.btn_pause.setText(t('resume_upload'))
 6732              else:
 6733                  self.btn_pause.setText(t('pause_upload'))
 6734              self.btn_stop.setText(t('stop_upload'))
 6735              self.btn_save.setText(t('save_config'))
 6736              self.btn_more.setText(t('more'))
 6737              
 6738              # === æµè§ˆæŒ‰é’® ===
 6739              self.btn_choose_src.setText(t('browse'))
 6740              self.btn_choose_tgt.setText(t('browse'))
 6741              self.btn_choose_bak.setText(t('browse'))

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 137 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 6742              
 6743              # === å¤é€‰æ¡† ===
 6744              # å¤‡ä»½
 6745              checked = self.cb_enable_backup.isChecked()
 6746              self.cb_enable_backup.setProperty('orig_text', t('enable_backup'))
 6747              self._set_checkbox_mark(self.cb_enable_backup, checked)
 6748              
 6749              # é«˜çº§é€‰é¡¹
 6750              if hasattr(self, 'cb_auto_start_windows'):
 6751                  checked = self.cb_auto_start_windows.isChecked()
 6752                  self.cb_auto_start_windows.setProperty('orig_text', t('auto_start_windows'))
 6753                  self._set_checkbox_mark(self.cb_auto_start_windows, checked)
 6754              if hasattr(self, 'cb_auto_run_on_startup'):
 6755                  checked = self.cb_auto_run_on_startup.isChecked()
 6756                  self.cb_auto_run_on_startup.setProperty('orig_text', t('auto_run_on_startup'))
 6757                  self._set_checkbox_mark(self.cb_auto_run_on_startup, checked)
 6758              if hasattr(self, 'cb_show_notifications'):
 6759                  checked = self.cb_show_notifications.isChecked()
 6760                  self.cb_show_notifications.setProperty('orig_text', t('show_notifications'))
 6761                  self._set_checkbox_mark(self.cb_show_notifications, checked)
 6762              if hasattr(self, 'cb_limit_rate'):
 6763                  checked = self.cb_limit_rate.isChecked()
 6764                  self.cb_limit_rate.setProperty('orig_text', t('limit_upload_rate'))
 6765                  self._set_checkbox_mark(self.cb_limit_rate, checked)
 6766              if hasattr(self, 'cb_dedup_enable'):
 6767                  checked = self.cb_dedup_enable.isChecked()
 6768                  self.cb_dedup_enable.setProperty('orig_text', t('enable_dedup'))
 6769                  self._set_checkbox_mark(self.cb_dedup_enable, checked)
 6770              if hasattr(self, 'cb_network_auto_pause'):
 6771                  checked = self.cb_network_auto_pause.isChecked()
 6772                  self.cb_network_auto_pause.setProperty('orig_text', t('auto_pause_on_disconnect'))
 6773                  self._set_checkbox_mark(self.cb_network_auto_pause, checked)
 6774              if hasattr(self, 'cb_network_auto_resume'):
 6775                  checked = self.cb_network_auto_resume.isChecked()
 6776                  self.cb_network_auto_resume.setProperty('orig_text', t('auto_resume_on_reconnect'))
 6777                  self._set_checkbox_mark(self.cb_network_auto_resume, checked)
 6778              if hasattr(self, 'cb_autoscroll'):
 6779                  checked = self.cb_autoscroll.isChecked()
 6780                  self.cb_autoscroll.setText("ğŸ“œ " + t('autoscroll').strip())
 6781              
 6782              # === çŠ¶æ€æ ‡ç­¾ ===
 6783              if not self.is_running:
 6784                  self.lbl_status.setText(t('status_stopped'))
 6785              elif self.is_paused:
 6786                  self.lbl_status.setText(t('status_paused'))
 6787              else:
 6788                  self.lbl_status.setText(t('status_running'))
 6789              
 6790              # === çŠ¶æ€èŠ¯ç‰‡ ===
 6791              self._update_chip_label(self.lbl_uploaded, t('uploaded'))

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 138 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 6792              self._update_chip_label(self.lbl_failed, t('failed'))
 6793              self._update_chip_label(self.lbl_skipped, t('skipped'))
 6794              self._update_chip_label(self.lbl_rate, t('rate'))
 6795              self._update_chip_label(self.lbl_queue, t('archive_queue'))
 6796              self._update_chip_label(self.lbl_time, t('runtime'))
 6797              self._update_chip_label(self.lbl_target_disk, t('target_disk'))
 6798              self._update_chip_label(self.lbl_backup_disk, t('backup_disk'))
 6799              self._update_chip_label(self.lbl_network, t('network_status'))
 6800              
 6801              # === èœå•é¡¹ ===
 6802              if hasattr(self, 'menu_items'):
 6803                  self.menu_items['clear_logs'].setText(t('clear_logs'))
 6804                  self.menu_items['disk_cleanup'].setText(t('disk_cleanup'))
 6805                  self.menu_items['login'].setText(t('login'))
 6806                  self.menu_items['change_password'].setText(t('change_password'))
 6807                  self.menu_items['logout'].setText(t('logout'))
 6808                  self.menu_items['lang_menu'].setTitle("ğŸŒ " + t('menu_language'))
 6809              
 6810              # === è§’è‰²æ ‡ç­¾ ===
 6811              if hasattr(self, 'role_label'):
 6812                  if self.current_role == 'guest':
 6813                      self.role_label.setText(t('role_guest'))
 6814                  elif self.current_role == 'user':
 6815                      self.role_label.setText(t('role_user'))
 6816                  else:
 6817                      self.role_label.setText(t('role_admin'))
 6818              
 6819              # === ç­‰å¾…æç¤ºæ–‡æœ¬ ===
 6820              if hasattr(self, 'lbl_current_file') and not self.is_running:
 6821                  self.lbl_current_file.setText(t('waiting'))
 6822              if hasattr(self, 'pbar_file') and not self.is_running:
 6823                  self.pbar_file.setFormat(t('waiting'))
 6824              if hasattr(self, 'lbl_progress') and not self.is_running:
 6825                  self.lbl_progress.setText(t('waiting'))
 6826              
 6827              # === FTP æµ‹è¯•æŒ‰é’® ===
 6828              if hasattr(self, 'btn_test_ftp_server'):
 6829                  self.btn_test_ftp_server.setText(t('test_config'))
 6830              if hasattr(self, 'btn_test_ftp_client'):
 6831                  self.btn_test_ftp_client.setText(t('test_connection'))
 6832              
 6833              # === å¯æŠ˜å åŒºå—æ ‡é¢˜ ===
 6834              if hasattr(self, 'ftp_server_collapsible'):
 6835                  self.ftp_server_collapsible.setTitle(t('ftp_server_config'))
 6836              if hasattr(self, 'ftp_client_collapsible'):
 6837                  self.ftp_client_collapsible.setTitle(t('ftp_client_config'))
 6838              
 6839              # === è·¯å¾„æ ‡ç­¾ ===
 6840              if hasattr(self, 'lbl_src'):
 6841                  self.lbl_src.setText(t('source_folder_label') + ":")

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 139 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 6842              if hasattr(self, 'lbl_tgt'):
 6843                  self.lbl_tgt.setText(t('target_folder_label') + ":")
 6844              if hasattr(self, 'lbl_bak'):
 6845                  self.lbl_bak.setText(t('backup_folder_label') + ":")
 6846              
 6847              # === å¤‡ä»½æç¤º ===
 6848              if hasattr(self, 'backup_hint'):
 6849                  self.backup_hint.setText(t('backup_hint'))
 6850              
 6851              # === æ ‡é¢˜æ  ===
 6852              if hasattr(self, 'header_title'):
 6853                  self.header_title.setText(t('header_title'))
 6854              
 6855              # === åè®®èŠ¯ç‰‡ ===
 6856              if hasattr(self, 'lbl_protocol'):
 6857                  self._update_chip_label(self.lbl_protocol, t('protocol_chip'))
 6858              if hasattr(self, 'lbl_ftp_server'):
 6859                  self._update_chip_label(self.lbl_ftp_server, t('ftp_server_chip'))
 6860                  # å¦‚æœæœªå¯åŠ¨ï¼Œæ›´æ–°å€¼æ ‡ç­¾
 6861                  if hasattr(self.lbl_ftp_server, 'value_label'):
 6862                      current_val = self.lbl_ftp_server.value_label.text()
 6863                      if current_val in ['æœªå¯åŠ¨', 'Not Started']:
 6864                          self.lbl_ftp_server.setValue(t('not_started'))
 6865              if hasattr(self, 'lbl_ftp_client'):
 6866                  self._update_chip_label(self.lbl_ftp_client, t('ftp_client_chip'))
 6867                  # å¦‚æœæœªè¿æ¥ï¼Œæ›´æ–°å€¼æ ‡ç­¾
 6868                  if hasattr(self.lbl_ftp_client, 'value_label'):
 6869                      current_val = self.lbl_ftp_client.value_label.text()
 6870                      if current_val in ['æœªè¿æ¥', 'Not Connected']:
 6871                          self.lbl_ftp_client.setValue(t('not_connected'))
 6872              
 6873              # === ç½‘ç»œçŠ¶æ€èŠ¯ç‰‡å€¼ ===
 6874              if hasattr(self, 'lbl_network') and hasattr(self.lbl_network, 'value_label'):
 6875                  current_val = self.lbl_network.value_label.text()
 6876                  if current_val in ['æœªçŸ¥', 'Unknown']:
 6877                      self.lbl_network.setValue(t('network_unknown'))
 6878                  elif current_val in ['å·²è¿æ¥', 'Connected']:
 6879                      self.lbl_network.setValue(t('network_connected'))
 6880                  elif current_val in ['å·²æ–­å¼€', 'Disconnected']:
 6881                      self.lbl_network.setValue(t('network_disconnected'))
 6882              
 6883              # === å½“å‰æ–‡ä»¶æ ‡ç­¾ ===
 6884              if hasattr(self, 'current_file_label_widget'):
 6885                  self.current_file_label_widget.setText(t('current_file_label'))
 6886              
 6887              # === åè®®ç›¸å…³æ ‡ç­¾ ===
 6888              if hasattr(self, 'protocol_title_label'):
 6889                  self.protocol_title_label.setText(t('upload_protocol_title'))
 6890              if hasattr(self, 'protocol_type_label'):
 6891                  self.protocol_type_label.setText(t('protocol_type_label'))

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 140 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 6892              
 6893              # === åè®®ä¸‹æ‹‰æ¡†é€‰é¡¹ ===
 6894              if hasattr(self, 'combo_protocol'):
 6895                  current_idx = self.combo_protocol.currentIndex()
 6896                  self.combo_protocol.setItemText(0, t('protocol_option_smb'))
 6897                  if self.combo_protocol.count() > 1:
 6898                      self.combo_protocol.setItemText(1, t('protocol_option_ftp_server'))
 6899                  if self.combo_protocol.count() > 2:
 6900                      self.combo_protocol.setItemText(2, t('protocol_option_ftp_client'))
 6901                  if self.combo_protocol.count() > 3:
 6902                      self.combo_protocol.setItemText(3, t('protocol_option_both'))
 6903              
 6904              # === FTP å¤é€‰æ¡† ===
 6905              if hasattr(self, 'cb_server_passive'):
 6906                  self.cb_server_passive.setText(t('enable_passive'))
 6907              if hasattr(self, 'cb_server_tls'):
 6908                  self.cb_server_tls.setText(t('enable_tls'))
 6909              if hasattr(self, 'cb_client_passive'):
 6910                  self.cb_client_passive.setText(t('enable_passive'))
 6911              if hasattr(self, 'cb_client_tls'):
 6912                  self.cb_client_tls.setText(t('enable_tls'))
 6913              
 6914              # === æ•°å€¼è®¾ç½®è¡Œæ ‡ç­¾ ===
 6915              if hasattr(self, 'lbl_interval'):
 6916                  self.lbl_interval.setText(t('interval_label') + ":")
 6917              if hasattr(self, 'lbl_disk'):
 6918                  self.lbl_disk.setText(t('disk_threshold_label') + ":")
 6919              if hasattr(self, 'lbl_retry'):
 6920                  self.lbl_retry.setText(t('retry_label') + ":")
 6921              if hasattr(self, 'lbl_disk_check'):
 6922                  self.lbl_disk_check.setText(t('disk_check_label') + ":")
 6923              
 6924              # === å¯æŠ˜å åŒºå—æ ‡é¢˜ ===
 6925              if hasattr(self, 'filter_collapsible'):
 6926                  self.filter_collapsible.setTitle(t('file_filter_title'))
 6927              if hasattr(self, 'adv_collapsible'):
 6928                  self.adv_collapsible.setTitle(t('advanced_options_title'))
 6929              
 6930              # === é«˜çº§é€‰é¡¹åŒºåŸŸæ ‡ç­¾ ===
 6931              if hasattr(self, 'hash_lab'):
 6932                  self.hash_lab.setText(t('hash_algorithm') + ":")
 6933              if hasattr(self, 'strategy_lab'):
 6934                  self.strategy_lab.setText(t('duplicate_strategy') + ":")
 6935              if hasattr(self, 'network_sub_lab'):
 6936                  self.network_sub_lab.setText(t('network_monitor'))
 6937              if hasattr(self, 'network_check_lab'):
 6938                  self.network_check_lab.setText(t('check_interval_label'))
 6939              if hasattr(self, 'dedup_hint'):
 6940                  self.dedup_hint.setText(t('dedup_hint'))
 6941              if hasattr(self, 'network_hint'):

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 141 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 6942                  self.network_hint.setText(t('network_hint'))
 6943              
 6944              # === ç­–ç•¥ä¸‹æ‹‰æ¡†é€‰é¡¹ ===
 6945              if hasattr(self, 'combo_strategy'):
 6946                  self.combo_strategy.setItemText(0, t('strategy_skip'))
 6947                  self.combo_strategy.setItemText(1, t('strategy_rename'))
 6948                  self.combo_strategy.setItemText(2, t('strategy_overwrite'))
 6949                  self.combo_strategy.setItemText(3, t('strategy_ask'))
 6950              
 6951              # === ç½‘ç»œæ£€æŸ¥é—´éš”åç¼€ ===
 6952              if hasattr(self, 'spin_network_check'):
 6953                  self.spin_network_check.setSuffix(" " + t('seconds'))
 6954              
 6955          except Exception as e:
 6956              self._append_log(f'âš  UIåˆ·æ–°å¤±è´¥: {e}')
 6957  
 6958      def _update_chip_label(self, chip: QtWidgets.QWidget, new_label: str):
 6959          """æ›´æ–°èŠ¯ç‰‡æ§ä»¶çš„æ ‡ç­¾æ–‡æœ¬ï¼ˆä¿æŒå€¼ä¸å˜ï¼‰"""
 6960          try:
 6961              # ChipWidget æœ‰ title_label å’Œ value_label ä¸¤éƒ¨åˆ†
 6962              if hasattr(chip, 'title_label'):
 6963                  chip.title_label.setText(new_label)  # type: ignore[attr-defined]
 6964          except Exception:
 6965              pass
 6966  
 6967      def _logout(self):
 6968          """é€€å‡ºç™»å½•"""
 6969          self.current_role = 'guest'
 6970          self.role_label.setText(t('role_guest'))
 6971          self.role_label.setStyleSheet("background:#FFF3E0; color:#E67E22; padding:6px 12px; border-radius:6px; font-weight:700;")
 6972          self._update_ui_permissions()
 6973          self._toast(t('logged_out'), 'info')
 6974  
 6975      def _compute_control_states(self, role: str, is_running: bool, enable_backup: bool) -> dict:
 6976          """
 6977          ç»Ÿä¸€è®¡ç®—æ‰€æœ‰æ§ä»¶çš„å¯ç”¨/ç¦ç”¨çŠ¶æ€
 6978          
 6979          è§„åˆ™ï¼š
 6980          - guest: ä»»ä½•æ—¶å€™ä¸èƒ½æ”¹é…ç½®ï¼Œåªèƒ½æ§åˆ¶å¼€å§‹/æš‚åœ/åœæ­¢
 6981          - user/admin: æœªè¿è¡Œæ—¶å¯æ”¹é…ç½®ï¼›è¿è¡Œä¸­å®Œå…¨ä¸å¯æ”¹
 6982          - å¤‡ä»½è·¯å¾„: ä»…å½“"å·²å¯ç”¨å¤‡ä»½"æ—¶å¯ç¼–è¾‘
 6983          - è¿è¡Œä¸­: æ‰€æœ‰é…ç½®ç±»æ§ä»¶ç¦ç”¨ï¼Œæ— è®ºè§’è‰²
 6984          
 6985          Returns:
 6986              dict: æ§ä»¶åç§° -> æ˜¯å¦å¯ç”¨çš„æ˜ å°„
 6987          """
 6988          is_user_or_admin = role in ['user', 'admin']
 6989          can_edit_config = is_user_or_admin and not is_running
 6990          
 6991          # v2.2.0 è¶…è¯¦ç»†è°ƒè¯•

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 142 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 6992          self._append_log(f"      [è®¡ç®—ç»†èŠ‚] role={role}, is_running={is_running}, enable_backup={enable_backup}")
 6993          self._append_log(f"      [è®¡ç®—ç»†èŠ‚] is_user_or_admin={is_user_or_admin}, can_edit_config={can_edit_config}")
 6994          
 6995          return {
 6996              # è·¯å¾„æµè§ˆæŒ‰é’®
 6997              'btn_choose_src': can_edit_config,
 6998              'btn_choose_tgt': can_edit_config,
 6999              'btn_choose_bak': can_edit_config and enable_backup,
 7000              # è·¯å¾„è¾“å…¥æ¡† (ReadOnlyç›¸åé€»è¾‘)
 7001              'src_edit_readonly': not can_edit_config,
 7002              'tgt_edit_readonly': not can_edit_config,
 7003              'bak_edit_readonly': not (can_edit_config and enable_backup),
 7004              # åè®®ä¸å¤‡ä»½å¼€å…³
 7005              'combo_protocol': can_edit_config,
 7006              'cb_enable_backup': can_edit_config,
 7007              # ä¿å­˜æŒ‰é’®
 7008              'btn_save': can_edit_config,
 7009              # ä¸Šä¼ è®¾ç½®ï¼ˆé—´éš”ã€ç£ç›˜ã€é‡è¯•ï¼‰
 7010              'upload_settings': is_user_or_admin,  # è¿è¡Œä¸­ä¹Ÿå¯æŸ¥çœ‹ä½†ä¸å¯æ”¹
 7011              # æ–‡ä»¶ç±»å‹å¤é€‰æ¡†
 7012              'file_filters': is_user_or_admin,
 7013              # è‡ªå¯åŠ¨è®¾ç½®
 7014              'startup_settings': is_user_or_admin,
 7015              # v2.3.0 é€Ÿç‡é™åˆ¶æ§ä»¶
 7016              'cb_limit_rate': can_edit_config,
 7017              'spin_max_rate': can_edit_config,
 7018              # ä¸Šä¼ æ§åˆ¶æŒ‰é’®
 7019              'btn_start': not is_running,
 7020              'btn_pause': is_running,
 7021              'btn_stop': is_running,
 7022          }
 7023  
 7024      def _update_ui_permissions(self):
 7025          """æ ¹æ®å½“å‰è§’è‰²æ›´æ–°UIæ§ä»¶çš„å¯ç”¨çŠ¶æ€"""
 7026          self._append_log(f"ğŸ” æ›´æ–°æƒé™: å½“å‰è§’è‰²={self.current_role}, è¿è¡ŒçŠ¶æ€={'è¿è¡Œä¸­' if self.is_running else 'å·²åœæ­¢'}")
 7027          
 7028          # v2.2.0 è®¡ç®—ç»Ÿä¸€æ§ä»¶çŠ¶æ€
 7029          states = self._compute_control_states(self.current_role, self.is_running, self.enable_backup)
 7030          
 7031          # v2.2.0 è¯¦ç»†è°ƒè¯•ï¼šæ‰“å°æ‰€æœ‰æŒ‰é’®çš„è®¡ç®—çŠ¶æ€
 7032          self._append_log(f"   [è®¡ç®—çŠ¶æ€] æºæŒ‰é’®={states['btn_choose_src']}, ç›®æ ‡æŒ‰é’®={states['btn_choose_tgt']}, å¤‡ä»½æŒ‰é’®={states['btn_choose_bak']}")
 7033          self._append_log(f"   [è®¡ç®—çŠ¶æ€] æºåªè¯»={states['src_edit_readonly']}, ç›®æ ‡åªè¯»={states['tgt_edit_readonly']}, å¤‡ä»½åªè¯»={states['bak_edit_readonly']}")
 7034          
 7035          # è·¯å¾„æµè§ˆæŒ‰é’®
 7036          if hasattr(self, 'btn_choose_src'):
 7037              self.btn_choose_src.setEnabled(states['btn_choose_src'])
 7038          if hasattr(self, 'btn_choose_tgt'):
 7039              self.btn_choose_tgt.setEnabled(states['btn_choose_tgt'])
 7040          if hasattr(self, 'btn_choose_bak'):
 7041              self.btn_choose_bak.setEnabled(states['btn_choose_bak'])

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 143 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 7042          
 7043          # è·¯å¾„è¾“å…¥æ¡†
 7044          self.src_edit.setReadOnly(states['src_edit_readonly'])
 7045          self.tgt_edit.setReadOnly(states['tgt_edit_readonly'])
 7046          self.bak_edit.setReadOnly(states['bak_edit_readonly'])
 7047  
 7048          # å¤‡ä»½å¯ç”¨å¤é€‰æ¡†
 7049          if hasattr(self, 'cb_enable_backup'):
 7050              self.cb_enable_backup.setEnabled(states['cb_enable_backup'])
 7051  
 7052          # è®¾ç½®é¡¹ï¼ˆè¿è¡Œä¸­ä¹Ÿå…è®¸æŸ¥çœ‹ä½†å®é™…ç”±Workerè¯»å–å¯åŠ¨æ—¶çš„å€¼ï¼‰
 7053          self.spin_interval.setEnabled(states['upload_settings'])
 7054          self.spin_disk.setEnabled(states['upload_settings'])
 7055          self.spin_retry.setEnabled(states['upload_settings'])
 7056          self.spin_disk_check.setEnabled(states['upload_settings'])
 7057          
 7058          # æ–‡ä»¶ç±»å‹å¤é€‰æ¡†
 7059          for cb in self.cb_ext.values():
 7060              cb.setEnabled(states['file_filters'])
 7061          
 7062          # å¼€æœºè‡ªå¯å’Œè‡ªåŠ¨è¿è¡Œå¤é€‰æ¡†
 7063          self.cb_auto_start_windows.setEnabled(states['startup_settings'])
 7064          self.cb_auto_run_on_startup.setEnabled(states['startup_settings'])
 7065          # v2.2.0 æ–°å¢ï¼šé€šçŸ¥å¼€å…³ï¼ˆæ‰€æœ‰äººå¯è®¾ç½®ï¼‰
 7066          if hasattr(self, 'cb_show_notifications'):
 7067              self.cb_show_notifications.setEnabled(True)
 7068          # v2.3.0 æ–°å¢ï¼šé€Ÿç‡é™åˆ¶æ§ä»¶æƒé™
 7069          if hasattr(self, 'cb_limit_rate'):
 7070              self.cb_limit_rate.setEnabled(states['cb_limit_rate'])
 7071              # spin_max_rate éœ€è¦åŒæ—¶æ»¡è¶³ï¼šæœ‰æƒé™ && checkboxå·²å‹¾é€‰
 7072              if states['spin_max_rate'] and self.cb_limit_rate.isChecked():
 7073                  self.spin_max_rate.setEnabled(True)
 7074              else:
 7075                  self.spin_max_rate.setEnabled(False)
 7076          
 7077          # ä¿å­˜é…ç½®æŒ‰é’®
 7078          self.btn_save.setEnabled(states['btn_save'])
 7079          
 7080          # åè®®é€‰æ‹©æ¡†
 7081          if hasattr(self, 'combo_protocol'):
 7082              self.combo_protocol.setEnabled(states['combo_protocol'])
 7083          
 7084          # ä¸Šä¼ æ§åˆ¶æŒ‰é’®
 7085          self.btn_start.setEnabled(states['btn_start'])
 7086          self.btn_pause.setEnabled(states['btn_pause'])
 7087          self.btn_stop.setEnabled(states['btn_stop'])
 7088          
 7089          # v2.2.0 è¯¦ç»†è°ƒè¯•ï¼šéªŒè¯å®é™…åº”ç”¨åçš„æŒ‰é’®çŠ¶æ€
 7090          actual_src = self.btn_choose_src.isEnabled() if hasattr(self, 'btn_choose_src') else None
 7091          actual_tgt = self.btn_choose_tgt.isEnabled() if hasattr(self, 'btn_choose_tgt') else None

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 144 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 7092          actual_bak = self.btn_choose_bak.isEnabled() if hasattr(self, 'btn_choose_bak') else None
 7093          self._append_log(f"   [åº”ç”¨åå®é™…] æºæŒ‰é’®={actual_src}, ç›®æ ‡æŒ‰é’®={actual_tgt}, å¤‡ä»½æŒ‰é’®={actual_bak}")
 7094          self._append_log(f"   [åº”ç”¨åå®é™…] æºåªè¯»={self.src_edit.isReadOnly()}, ç›®æ ‡åªè¯»={self.tgt_edit.isReadOnly()}, å¤‡ä»½åªè¯»={self.bak_edit.isReadOnly()}")
 7095          
 7096          # æ£€æµ‹å¼‚å¸¸ï¼šå¦‚æœè®¡ç®—çŠ¶æ€ä¸å®é™…çŠ¶æ€ä¸ä¸€è‡´
 7097          if actual_tgt is not None and actual_tgt != states['btn_choose_tgt']:
 7098              self._append_log(f"   âš ï¸ è­¦å‘Šï¼šç›®æ ‡æŒ‰é’®çŠ¶æ€ä¸ä¸€è‡´ï¼è®¡ç®—={states['btn_choose_tgt']}, å®é™…={actual_tgt}")
 7099          if actual_src is not None and actual_src != states['btn_choose_src']:
 7100              self._append_log(f"   âš ï¸ è­¦å‘Šï¼šæºæŒ‰é’®çŠ¶æ€ä¸ä¸€è‡´ï¼è®¡ç®—={states['btn_choose_src']}, å®é™…={actual_src}")
 7101  
 7102      def _clear_logs(self):
 7103          try:
 7104              self.log.clear()
 7105              self._toast('å·²æ¸…ç©ºæ—¥å¿—', 'info')
 7106          except Exception:
 7107              pass
 7108      
 7109      def _show_disk_cleanup(self):
 7110          """æ˜¾ç¤ºç£ç›˜æ¸…ç†å¯¹è¯æ¡†"""
 7111          try:
 7112              dialog = MainWindow.DiskCleanupDialog(self)
 7113              dialog.exec()
 7114          except Exception as e:
 7115              self._append_log(f"âŒ æ‰“å¼€ç£ç›˜æ¸…ç†å¯¹è¯æ¡†å¤±è´¥: {e}")
 7116              self._toast('æ‰“å¼€ç£ç›˜æ¸…ç†å¤±è´¥', 'danger')
 7117  
 7118      def _show_login(self):
 7119          """æ˜¾ç¤ºæƒé™ç™»å½•å¯¹è¯æ¡†"""
 7120          dialog = QtWidgets.QDialog(self)
 7121          dialog.setWindowTitle("ğŸ” æƒé™ç™»å½•")
 7122          dialog.setModal(True)
 7123          dialog.resize(400, 200)
 7124          
 7125          layout = QtWidgets.QVBoxLayout(dialog)
 7126          layout.setSpacing(15)
 7127          
 7128          # è§’è‰²é€‰æ‹©
 7129          role_layout = QtWidgets.QHBoxLayout()
 7130          role_label = QtWidgets.QLabel(t('login_role_label'))
 7131          role_label.setMinimumWidth(80)
 7132          role_combo = QtWidgets.QComboBox()
 7133          role_combo.addItems([t('role_user_option'), t('role_admin_option')])
 7134          role_layout.addWidget(role_label)
 7135          role_layout.addWidget(role_combo)
 7136          layout.addLayout(role_layout)
 7137          
 7138          # å¯†ç 
 7139          pwd_layout = QtWidgets.QHBoxLayout()
 7140          pwd_label = QtWidgets.QLabel(t('password_label'))
 7141          pwd_label.setMinimumWidth(80)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 145 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 7142          pwd_input = QtWidgets.QLineEdit()
 7143          echo_enum = getattr(QtWidgets.QLineEdit, 'EchoMode', QtWidgets.QLineEdit)
 7144          pwd_input.setEchoMode(getattr(echo_enum, 'Password'))
 7145          pwd_input.setPlaceholderText(t('enter_password'))
 7146          pwd_layout.addWidget(pwd_label)
 7147          pwd_layout.addWidget(pwd_input)
 7148          layout.addLayout(pwd_layout)
 7149          
 7150          # æŒ‰é’®
 7151          btn_layout = QtWidgets.QHBoxLayout()
 7152          btn_layout.addStretch(1)
 7153          btn_cancel = QtWidgets.QPushButton(t('cancel'))
 7154          btn_cancel.setProperty("class", "Secondary")
 7155          btn_cancel.clicked.connect(dialog.reject)
 7156          btn_ok = QtWidgets.QPushButton(t('login'))
 7157          btn_ok.setProperty("class", "Primary")
 7158          btn_ok.setDefault(True)  # è®¾ç½®ä¸ºé»˜è®¤æŒ‰é’®ï¼Œæ”¯æŒå›è½¦è§¦å‘
 7159          
 7160          def do_login():
 7161              role_text = role_combo.currentText()
 7162              password = pwd_input.text().strip()
 7163              
 7164              if not password:
 7165                  self._toast(t('please_enter_password'), 'warning')
 7166                  return
 7167              
 7168              # å“ˆå¸Œå¯†ç 
 7169              pwd_hash = hashlib.sha256(password.encode('utf-8')).hexdigest()
 7170              
 7171              # éªŒè¯å¯†ç 
 7172              if t('role_user_option') in role_text or "ç”¨æˆ·" in role_text:
 7173                  if pwd_hash == self.user_password:
 7174                      self.current_role = 'user'
 7175                      self.role_label.setText(t('role_user'))
 7176                      self.role_label.setStyleSheet("background:#E3F2FD; color:#1976D2; padding:6px 12px; border-radius:6px; font-weight:700;")
 7177                      self._append_log("=" * 50)
 7178                      self._append_log(t('user_login_success'))
 7179                      self._toast(t('user_login_success'), 'success')
 7180                      self._update_ui_permissions()
 7181                      dialog.accept()
 7182                  else:
 7183                      self._toast(t('wrong_password'), 'danger')
 7184              elif t('role_admin_option') in role_text or "ç®¡ç†å‘˜" in role_text:
 7185                  if pwd_hash == self.admin_password:
 7186                      self.current_role = 'admin'
 7187                      self.role_label.setText(t('role_admin'))
 7188                      self.role_label.setStyleSheet("background:#DCFCE7; color:#166534; padding:6px 12px; border-radius:6px; font-weight:700;")
 7189                      self._append_log("=" * 50)
 7190                      self._append_log(t('admin_login_success'))
 7191                      self._toast(t('admin_login_success'), 'success')

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 146 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 7192                      self._update_ui_permissions()
 7193                      dialog.accept()
 7194                  else:
 7195                      self._toast(t('wrong_password'), 'danger')
 7196          
 7197          btn_ok.clicked.connect(do_login)
 7198          btn_layout.addWidget(btn_cancel)
 7199          btn_layout.addWidget(btn_ok)
 7200          layout.addLayout(btn_layout)
 7201          
 7202          dialog.exec() if hasattr(dialog, 'exec') else dialog.exec_()
 7203  
 7204      def _show_change_password(self):
 7205          """æ˜¾ç¤ºä¿®æ”¹å¯†ç å¯¹è¯æ¡†"""
 7206          # æ£€æŸ¥æƒé™ - ç”¨æˆ·æ— æ³•ä¿®æ”¹å¯†ç 
 7207          if self.current_role == 'guest':
 7208              self._toast('è¯·å…ˆç™»å½•', 'warning')
 7209              return
 7210          if self.current_role == 'user':
 7211              self._toast('ç”¨æˆ·æ— æƒé™ä¿®æ”¹å¯†ç ï¼Œä»…ç®¡ç†å‘˜å¯ä¿®æ”¹', 'warning')
 7212              return
 7213          
 7214          dialog = QtWidgets.QDialog(self)
 7215          dialog.setWindowTitle("ğŸ”‘ ä¿®æ”¹å¯†ç ")
 7216          dialog.setModal(True)
 7217          dialog.resize(400, 300)
 7218          
 7219          layout = QtWidgets.QVBoxLayout(dialog)
 7220          layout.setSpacing(15)
 7221          
 7222          # ç®¡ç†å‘˜å¯ä»¥é€‰æ‹©ä¿®æ”¹å“ªä¸ªå¯†ç 
 7223          target_combo = None
 7224          if self.current_role == 'admin':
 7225              target_layout = QtWidgets.QHBoxLayout()
 7226              target_label = QtWidgets.QLabel("ä¿®æ”¹å¯¹è±¡:")
 7227              target_label.setMinimumWidth(80)
 7228              target_combo = QtWidgets.QComboBox()
 7229              target_combo.addItems(["ğŸ‘¤ ç”¨æˆ·å¯†ç ", "ğŸ‘‘ ç®¡ç†å‘˜å¯†ç "])
 7230              target_layout.addWidget(target_label)
 7231              target_layout.addWidget(target_combo)
 7232              layout.addLayout(target_layout)
 7233          
 7234          # åŸå¯†ç 
 7235          old_layout = QtWidgets.QHBoxLayout()
 7236          old_label = QtWidgets.QLabel("åŸå¯†ç :")
 7237          old_label.setMinimumWidth(80)
 7238          old_input = QtWidgets.QLineEdit()
 7239          echo_enum = getattr(QtWidgets.QLineEdit, 'EchoMode', QtWidgets.QLineEdit)
 7240          old_input.setEchoMode(getattr(echo_enum, 'Password'))
 7241          old_input.setPlaceholderText("è¯·è¾“å…¥åŸå¯†ç ")

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 147 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 7242          old_layout.addWidget(old_label)
 7243          old_layout.addWidget(old_input)
 7244          layout.addLayout(old_layout)
 7245          
 7246          # æ–°å¯†ç 
 7247          new_layout = QtWidgets.QHBoxLayout()
 7248          new_label = QtWidgets.QLabel("æ–°å¯†ç :")
 7249          new_label.setMinimumWidth(80)
 7250          new_input = QtWidgets.QLineEdit()
 7251          echo_enum = getattr(QtWidgets.QLineEdit, 'EchoMode', QtWidgets.QLineEdit)
 7252          new_input.setEchoMode(getattr(echo_enum, 'Password'))
 7253          new_input.setPlaceholderText("è¯·è¾“å…¥æ–°å¯†ç ")
 7254          new_layout.addWidget(new_label)
 7255          new_layout.addWidget(new_input)
 7256          layout.addLayout(new_layout)
 7257          
 7258          # ç¡®è®¤å¯†ç 
 7259          confirm_layout = QtWidgets.QHBoxLayout()
 7260          confirm_label = QtWidgets.QLabel("ç¡®è®¤å¯†ç :")
 7261          confirm_label.setMinimumWidth(80)
 7262          confirm_input = QtWidgets.QLineEdit()
 7263          echo_enum = getattr(QtWidgets.QLineEdit, 'EchoMode', QtWidgets.QLineEdit)
 7264          confirm_input.setEchoMode(getattr(echo_enum, 'Password'))
 7265          confirm_input.setPlaceholderText("è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ")
 7266          confirm_layout.addWidget(confirm_label)
 7267          confirm_layout.addWidget(confirm_input)
 7268          layout.addLayout(confirm_layout)
 7269          
 7270          # æŒ‰é’®
 7271          btn_layout = QtWidgets.QHBoxLayout()
 7272          btn_layout.addStretch(1)
 7273          btn_cancel = QtWidgets.QPushButton("å–æ¶ˆ")
 7274          btn_cancel.setProperty("class", "Secondary")
 7275          btn_cancel.clicked.connect(dialog.reject)
 7276          btn_ok = QtWidgets.QPushButton("ç¡®è®¤ä¿®æ”¹")
 7277          btn_ok.setProperty("class", "Primary")
 7278          
 7279          def do_change():
 7280              old_pwd = old_input.text().strip()
 7281              new_pwd = new_input.text().strip()
 7282              confirm_pwd = confirm_input.text().strip()
 7283              
 7284              if not old_pwd or not new_pwd or not confirm_pwd:
 7285                  self._toast('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ', 'warning')
 7286                  return
 7287              if new_pwd != confirm_pwd:
 7288                  self._toast('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´', 'warning')
 7289                  return
 7290              
 7291              # å“ˆå¸Œå¯†ç 

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 148 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 7292              old_hash = hashlib.sha256(old_pwd.encode('utf-8')).hexdigest()
 7293              new_hash = hashlib.sha256(new_pwd.encode('utf-8')).hexdigest()
 7294              
 7295              # ç®¡ç†å‘˜ä¿®æ”¹å¯†ç 
 7296              if self.current_role == 'admin' and target_combo:
 7297                  target_text = target_combo.currentText()
 7298                  if "ç”¨æˆ·å¯†ç " in target_text:
 7299                      # éªŒè¯ç®¡ç†å‘˜å¯†ç 
 7300                      if old_hash != self.admin_password:
 7301                          self._toast('ç®¡ç†å‘˜å¯†ç é”™è¯¯', 'danger')
 7302                          return
 7303                      self.user_password = new_hash
 7304                      target_role = 'user'
 7305                      self._toast('ç”¨æˆ·å¯†ç ä¿®æ”¹æˆåŠŸï¼', 'success')
 7306                  else:
 7307                      # ä¿®æ”¹ç®¡ç†å‘˜å¯†ç 
 7308                      if old_hash != self.admin_password:
 7309                          self._toast('åŸå¯†ç é”™è¯¯', 'danger')
 7310                          return
 7311                      self.admin_password = new_hash
 7312                      target_role = 'admin'
 7313                      self._toast('ç®¡ç†å‘˜å¯†ç ä¿®æ”¹æˆåŠŸï¼', 'success')
 7314                  
 7315                  # ä¿å­˜åˆ°é…ç½®æ–‡ä»¶
 7316                  try:
 7317                      path = self.app_dir / 'config.json'
 7318                      users = {}
 7319                      if path.exists():
 7320                          with open(path, 'r', encoding='utf-8') as f:
 7321                              cfg = json.load(f)
 7322                              users = cfg.get('users', {})
 7323                      
 7324                      users[target_role] = new_hash
 7325                      
 7326                      if path.exists():
 7327                          with open(path, 'r', encoding='utf-8') as f:
 7328                              cfg = json.load(f)
 7329                      else:
 7330                          cfg = {}
 7331                      
 7332                      cfg['users'] = users
 7333                      
 7334                      with open(path, 'w', encoding='utf-8') as f:
 7335                          json.dump(cfg, f, indent=2, ensure_ascii=False)
 7336                      
 7337                      self._append_log(f"âœ“ å¯†ç å·²ä¿å­˜: {target_role}")
 7338                  except Exception as e:
 7339                      self._toast(f'ä¿å­˜å¯†ç å¤±è´¥: {e}', 'danger')
 7340                      return
 7341              

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 149 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 7342              dialog.accept()
 7343          
 7344          btn_ok.clicked.connect(do_change)
 7345          btn_layout.addWidget(btn_cancel)
 7346          btn_layout.addWidget(btn_ok)
 7347          layout.addLayout(btn_layout)
 7348          
 7349          dialog.exec() if hasattr(dialog, 'exec') else dialog.exec_()
 7350  
 7351      # ========== å¼€æœºè‡ªå¯åŠ¨åŠŸèƒ½ ==========
 7352      
 7353      def _on_dedup_toggled(self, checked: bool):
 7354          """åˆ‡æ¢æ™ºèƒ½å»é‡å¼€å…³"""
 7355          self.enable_deduplication = checked
 7356          # å¯ç”¨/ç¦ç”¨å­é€‰é¡¹
 7357          self.combo_hash.setEnabled(checked)
 7358          self.combo_strategy.setEnabled(checked)
 7359          
 7360          if checked:
 7361              self._append_log("ğŸ” å·²å¯ç”¨æ™ºèƒ½å»é‡")
 7362          else:
 7363              self._append_log("âšª å·²ç¦ç”¨æ™ºèƒ½å»é‡")
 7364      
 7365      def _on_rate_limit_toggled(self, checked: bool):
 7366          """v2.3.0 åˆ‡æ¢é€Ÿç‡é™åˆ¶å¼€å…³"""
 7367          self.limit_upload_rate = checked
 7368          self.spin_max_rate.setEnabled(checked)
 7369          self.config_modified = True
 7370          
 7371          if checked:
 7372              rate = self.spin_max_rate.value()
 7373              self._append_log(f"âš¡ å·²å¯ç”¨é€Ÿç‡é™åˆ¶: {rate} MB/s")
 7374          else:
 7375              self._append_log("âšª å·²ç¦ç”¨é€Ÿç‡é™åˆ¶")
 7376  
 7377      def _choose_ftp_share(self):
 7378          """é€‰æ‹© FTP å…±äº«ç›®å½•"""
 7379          folder = QtWidgets.QFileDialog.getExistingDirectory(
 7380              self, "é€‰æ‹© FTP å…±äº«ç›®å½•", self.ftp_server_share.text()
 7381          )
 7382          if folder:
 7383              self.ftp_server_share.setText(folder)
 7384              self.config_modified = True
 7385      
 7386      def _test_ftp_server_config(self):
 7387          """æµ‹è¯•FTPæœåŠ¡å™¨é…ç½®"""
 7388          self._append_log("ğŸ§ª å¼€å§‹æµ‹è¯•FTPæœåŠ¡å™¨é…ç½®...")
 7389          
 7390          # æ”¶é›†å½“å‰é…ç½®
 7391          config = {

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 150 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 7392              'host': self.ftp_server_host.text().strip(),
 7393              'port': self.ftp_server_port.value(),
 7394              'username': self.ftp_server_user.text().strip(),
 7395              'password': self.ftp_server_pass.text().strip(),
 7396              'shared_folder': self.ftp_server_share.text().strip()
 7397          }
 7398          
 7399          # éªŒè¯é…ç½®
 7400          errors = []
 7401          if not config['host']:
 7402              errors.append("ä¸»æœºåœ°å€ä¸ºç©º")
 7403          if not config['username']:
 7404              errors.append("ç”¨æˆ·åä¸ºç©º")
 7405          if not config['password']:
 7406              errors.append("å¯†ç ä¸ºç©º")
 7407          if not config['shared_folder']:
 7408              errors.append("å…±äº«ç›®å½•ä¸ºç©º")
 7409          elif not os.path.exists(config['shared_folder']):
 7410              errors.append(f"å…±äº«ç›®å½•ä¸å­˜åœ¨: {config['shared_folder']}")
 7411          
 7412          if errors:
 7413              error_msg = "\n".join(errors)
 7414              self._append_log(f"âŒ é…ç½®éªŒè¯å¤±è´¥:\n{error_msg}")
 7415              QtWidgets.QMessageBox.critical(self, "é…ç½®é”™è¯¯", f"FTPæœåŠ¡å™¨é…ç½®æœ‰è¯¯ï¼š\n\n{error_msg}")
 7416              return
 7417          
 7418          # å°è¯•å¯åŠ¨æµ‹è¯•æœåŠ¡å™¨
 7419          try:
 7420              from src.protocols.ftp import FTPServerManager
 7421              
 7422              self._append_log(f"ğŸ”§ æ­£åœ¨æµ‹è¯•FTPæœåŠ¡å™¨ {config['host']}:{config['port']}...")
 7423              test_server = FTPServerManager(config)
 7424              
 7425              if test_server.start():
 7426                  self._append_log("âœ“ FTPæœåŠ¡å™¨æµ‹è¯•æˆåŠŸï¼")
 7427                  self._append_log(f"  åœ°å€: {config['host']}:{config['port']}")
 7428                  self._append_log(f"  ç”¨æˆ·: {config['username']}")
 7429                  self._append_log(f"  å…±äº«: {config['shared_folder']}")
 7430                  
 7431                  # ç«‹å³åœæ­¢æµ‹è¯•æœåŠ¡å™¨
 7432                  test_server.stop()
 7433                  self._append_log("âœ“ æµ‹è¯•æœåŠ¡å™¨å·²åœæ­¢")
 7434                  
 7435                  QtWidgets.QMessageBox.information(
 7436                      self, "æµ‹è¯•æˆåŠŸ", 
 7437                      f"FTPæœåŠ¡å™¨é…ç½®æœ‰æ•ˆï¼\n\n"
 7438                      f"åœ°å€: {config['host']}:{config['port']}\n"
 7439                      f"ç”¨æˆ·: {config['username']}\n"
 7440                      f"å…±äº«: {config['shared_folder']}"
 7441                  )

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 151 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 7442              else:
 7443                  self._append_log("âŒ FTPæœåŠ¡å™¨å¯åŠ¨å¤±è´¥")
 7444                  QtWidgets.QMessageBox.critical(
 7445                      self, "æµ‹è¯•å¤±è´¥", 
 7446                      f"FTPæœåŠ¡å™¨æ— æ³•å¯åŠ¨ï¼\n\nå¯èƒ½åŸå› ï¼š\n"
 7447                      f"1. ç«¯å£ {config['port']} å·²è¢«å ç”¨\n"
 7448                      f"2. æ²¡æœ‰ç®¡ç†å‘˜æƒé™ï¼ˆç«¯å£<1024éœ€è¦ï¼‰\n"
 7449                      f"3. é˜²ç«å¢™é˜»æ­¢"
 7450                  )
 7451          except Exception as e:
 7452              self._append_log(f"âŒ æµ‹è¯•å¼‚å¸¸: {e}")
 7453              QtWidgets.QMessageBox.critical(self, "æµ‹è¯•é”™è¯¯", f"æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼š\n\n{str(e)}")
 7454      
 7455      def _test_ftp_client_connection(self):
 7456          """æµ‹è¯•FTPå®¢æˆ·ç«¯è¿æ¥"""
 7457          self._append_log("ğŸ”Œ å¼€å§‹æµ‹è¯•FTPå®¢æˆ·ç«¯è¿æ¥...")
 7458          
 7459          # æ”¶é›†å½“å‰é…ç½®
 7460          config = {
 7461              'name': 'test_client',
 7462              'host': self.ftp_client_host.text().strip(),
 7463              'port': self.ftp_client_port.value(),
 7464              'username': self.ftp_client_user.text().strip(),
 7465              'password': self.ftp_client_pass.text().strip(),
 7466              'remote_path': self.ftp_client_remote.text().strip(),
 7467              'timeout': self.ftp_client_timeout.value(),
 7468              'retry_count': self.ftp_client_retry.value(),
 7469          }
 7470          
 7471          # éªŒè¯é…ç½®
 7472          errors = []
 7473          if not config['host']:
 7474              errors.append("æœåŠ¡å™¨åœ°å€ä¸ºç©º")
 7475          if not config['username']:
 7476              errors.append("ç”¨æˆ·åä¸ºç©º")
 7477          if not config['password']:
 7478              errors.append("å¯†ç ä¸ºç©º")
 7479          if not config['remote_path']:
 7480              errors.append("è¿œç¨‹è·¯å¾„ä¸ºç©º")
 7481          
 7482          if errors:
 7483              error_msg = "\n".join(errors)
 7484              self._append_log(f"âŒ é…ç½®éªŒè¯å¤±è´¥:\n{error_msg}")
 7485              QtWidgets.QMessageBox.critical(self, "é…ç½®é”™è¯¯", f"FTPå®¢æˆ·ç«¯é…ç½®æœ‰è¯¯ï¼š\n\n{error_msg}")
 7486              return
 7487          
 7488          # å°è¯•è¿æ¥
 7489          try:
 7490              from src.protocols.ftp import FTPClientUploader
 7491              

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 152 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 7492              self._append_log(f"ğŸ”— æ­£åœ¨è¿æ¥FTPæœåŠ¡å™¨ {config['host']}:{config['port']}...")
 7493              test_client = FTPClientUploader(config)
 7494              
 7495              if test_client.test_connection():
 7496                  self._append_log("âœ“ FTPå®¢æˆ·ç«¯è¿æ¥æµ‹è¯•æˆåŠŸï¼")
 7497                  self._append_log(f"  æœåŠ¡å™¨: {config['host']}:{config['port']}")
 7498                  self._append_log(f"  ç”¨æˆ·: {config['username']}")
 7499                  self._append_log(f"  è¿œç¨‹è·¯å¾„: {config['remote_path']}")
 7500                  
 7501                  # æ–­å¼€è¿æ¥
 7502                  test_client.disconnect()
 7503                  self._append_log("âœ“ å·²æ–­å¼€è¿æ¥")
 7504                  
 7505                  QtWidgets.QMessageBox.information(
 7506                      self, "æµ‹è¯•æˆåŠŸ", 
 7507                      f"FTPå®¢æˆ·ç«¯è¿æ¥æˆåŠŸï¼\n\n"
 7508                      f"æœåŠ¡å™¨: {config['host']}:{config['port']}\n"
 7509                      f"ç”¨æˆ·: {config['username']}\n"
 7510                      f"è¿œç¨‹è·¯å¾„: {config['remote_path']}"
 7511                  )
 7512              else:
 7513                  self._append_log("âŒ FTPå®¢æˆ·ç«¯è¿æ¥å¤±è´¥")
 7514                  QtWidgets.QMessageBox.critical(
 7515                      self, "æµ‹è¯•å¤±è´¥", 
 7516                      f"æ— æ³•è¿æ¥åˆ°FTPæœåŠ¡å™¨ï¼\n\nå¯èƒ½åŸå› ï¼š\n"
 7517                      f"1. æœåŠ¡å™¨åœ°å€æˆ–ç«¯å£é”™è¯¯\n"
 7518                      f"2. ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯\n"
 7519                      f"3. ç½‘ç»œä¸é€šæˆ–é˜²ç«å¢™é˜»æ­¢\n"
 7520                      f"4. æœåŠ¡å™¨æœªè¿è¡Œ"
 7521                  )
 7522          except Exception as e:
 7523              self._append_log(f"âŒ æµ‹è¯•å¼‚å¸¸: {e}")
 7524              QtWidgets.QMessageBox.critical(self, "æµ‹è¯•é”™è¯¯", f"æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼š\n\n{str(e)}")
 7525      
 7526      def _on_protocol_changed(self, index: int):
 7527          """åè®®é€‰æ‹©å˜åŒ–"""
 7528          protocols = ['smb', 'ftp_server', 'ftp_client', 'both']
 7529          self.current_protocol = protocols[index]
 7530          
 7531          # æ›´æ–°è¯´æ˜æ–‡å­—
 7532          self._update_protocol_description(index)
 7533          
 7534          # æ˜¾ç¤º/éšè— FTP é…ç½®
 7535          show_ftp = index > 0  # é SMB æ—¶æ˜¾ç¤º
 7536          self.ftp_config_widget.setVisible(show_ftp)
 7537          
 7538          # æ§åˆ¶å„ç»„ä»¶å¯è§æ€§
 7539          if index == 0:  # SMB
 7540              self.ftp_server_collapsible.setVisible(False)
 7541              self.ftp_client_collapsible.setVisible(False)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 153 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 7542          elif index == 1:  # FTP Server
 7543              self.ftp_server_collapsible.setVisible(True)
 7544              self.ftp_client_collapsible.setVisible(False)
 7545          elif index == 2:  # FTP Client
 7546              self.ftp_server_collapsible.setVisible(False)
 7547              self.ftp_client_collapsible.setVisible(True)
 7548          elif index == 3:  # Both
 7549              self.ftp_server_collapsible.setVisible(True)
 7550              self.ftp_client_collapsible.setVisible(True)
 7551          
 7552          self.config_modified = True
 7553          self._append_log(f"ğŸ“¡ åˆ‡æ¢ä¸Šä¼ åè®®ï¼š{['SMB', 'FTPæœåŠ¡å™¨', 'FTPå®¢æˆ·ç«¯', 'æ··åˆæ¨¡å¼'][index]}")
 7554          
 7555          # v2.0 æ–°å¢ï¼šæ›´æ–°åè®®çŠ¶æ€æ˜¾ç¤º
 7556          self._update_protocol_status()
 7557      
 7558      def _update_protocol_description(self, index: int):
 7559          """æ›´æ–°åè®®è¯´æ˜"""
 7560          descriptions = [
 7561              "ğŸ“ SMB (ç½‘ç»œå…±äº«)ï¼šé€šè¿‡ Windows ç½‘ç»œå…±äº«ä¸Šä¼ æ–‡ä»¶åˆ°å…±äº«æ–‡ä»¶å¤¹",
 7562              "ğŸ–¥ï¸ FTP æœåŠ¡å™¨æ¨¡å¼ï¼šæœ¬æœºä½œä¸º FTP æœåŠ¡å™¨ï¼Œå…¶ä»–è®¾å¤‡å¯è¿æ¥ä¸Šä¼ æ–‡ä»¶",
 7563              "ğŸ“¤ FTP å®¢æˆ·ç«¯æ¨¡å¼ï¼šæœ¬æœºä½œä¸º FTP å®¢æˆ·ç«¯ï¼Œè¿æ¥åˆ°è¿œç¨‹ FTP æœåŠ¡å™¨ä¸Šä¼ æ–‡ä»¶",
 7564              "ğŸ”„ æ··åˆæ¨¡å¼ï¼šåŒæ—¶è¿è¡Œ FTP æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ï¼Œçµæ´»åº”å¯¹ä¸åŒåœºæ™¯"
 7565          ]
 7566          self.protocol_desc.setText(descriptions[index])
 7567      
 7568      def _toggle_autostart(self, checked: bool):
 7569          """åˆ‡æ¢å¼€æœºè‡ªå¯åŠ¨çŠ¶æ€"""
 7570          if self.current_role not in ['user', 'admin']:
 7571              self._toast('éœ€è¦ç™»å½•åæ‰èƒ½è®¾ç½®å¼€æœºè‡ªå¯åŠ¨', 'warning')
 7572              # é˜»æ­¢å‹¾é€‰
 7573              self.cb_auto_start_windows.blockSignals(True)
 7574              self.cb_auto_start_windows.setChecked(not checked)
 7575              self.cb_auto_start_windows.blockSignals(False)
 7576              return
 7577          
 7578          try:
 7579              if checked:
 7580                  self._add_to_startup()
 7581              else:
 7582                  self._remove_from_startup()
 7583              self.auto_start_windows = checked
 7584          except Exception as e:
 7585              self._toast(f'è®¾ç½®å¼€æœºè‡ªå¯åŠ¨å¤±è´¥: {e}', 'danger')
 7586              # æ¢å¤çŠ¶æ€
 7587              self.cb_auto_start_windows.blockSignals(True)
 7588              self.cb_auto_start_windows.setChecked(not checked)
 7589              self.cb_auto_start_windows.blockSignals(False)
 7590  
 7591      def _add_to_startup(self):

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 154 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 7592          """æ·»åŠ åˆ°Windowså¯åŠ¨é¡¹"""
 7593          try:
 7594              # è·å–ç¨‹åºè·¯å¾„
 7595              if getattr(sys, 'frozen', False):
 7596                  exe_path = sys.executable
 7597              else:
 7598                  exe_path = os.path.abspath(__file__)
 7599              
 7600              # æ‰“å¼€æ³¨å†Œè¡¨
 7601              key = winreg.OpenKey(
 7602                  winreg.HKEY_CURRENT_USER,
 7603                  r"Software\Microsoft\Windows\CurrentVersion\Run",
 7604                  0,
 7605                  winreg.KEY_SET_VALUE
 7606              )
 7607              
 7608              # è®¾ç½®å€¼
 7609              winreg.SetValueEx(key, "ImageUploader", 0, winreg.REG_SZ, exe_path)
 7610              winreg.CloseKey(key)
 7611              
 7612              self._append_log("âœ“ å·²æ·»åŠ åˆ°å¼€æœºè‡ªå¯åŠ¨")
 7613              self._toast('å·²è®¾ç½®å¼€æœºè‡ªå¯åŠ¨', 'success')
 7614          except Exception as e:
 7615              raise Exception(f"æ·»åŠ å¯åŠ¨é¡¹å¤±è´¥: {str(e)}")
 7616  
 7617      def _remove_from_startup(self):
 7618          """ä»Windowså¯åŠ¨é¡¹ç§»é™¤"""
 7619          try:
 7620              key = winreg.OpenKey(
 7621                  winreg.HKEY_CURRENT_USER,
 7622                  r"Software\Microsoft\Windows\CurrentVersion\Run",
 7623                  0,
 7624                  winreg.KEY_SET_VALUE
 7625              )
 7626              
 7627              try:
 7628                  winreg.DeleteValue(key, "ImageUploader")
 7629                  self._append_log("âœ“ å·²ä»å¼€æœºè‡ªå¯åŠ¨ç§»é™¤")
 7630                  self._toast('å·²å–æ¶ˆå¼€æœºè‡ªå¯åŠ¨', 'success')
 7631              except FileNotFoundError:
 7632                  pass  # é”®ä¸å­˜åœ¨ï¼Œå¿½ç•¥
 7633              
 7634              winreg.CloseKey(key)
 7635          except Exception as e:
 7636              raise Exception(f"ç§»é™¤å¯åŠ¨é¡¹å¤±è´¥: {str(e)}")
 7637  
 7638      def _check_startup_status(self) -> bool:
 7639          """æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨å¯åŠ¨é¡¹ä¸­"""
 7640          try:
 7641              key = winreg.OpenKey(

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 155 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 7642                  winreg.HKEY_CURRENT_USER,
 7643                  r"Software\Microsoft\Windows\CurrentVersion\Run",
 7644                  0,
 7645                  winreg.KEY_READ
 7646              )
 7647              try:
 7648                  winreg.QueryValueEx(key, "ImageUploader")
 7649                  winreg.CloseKey(key)
 7650                  return True
 7651              except FileNotFoundError:
 7652                  winreg.CloseKey(key)
 7653                  return False
 7654          except Exception:
 7655              return False
 7656  
 7657      def _auto_start_upload(self):
 7658          """è‡ªåŠ¨å¼€å§‹ä¸Šä¼ ï¼ˆå¯åŠ¨æ—¶è°ƒç”¨ï¼‰"""
 7659          if not self.auto_run_on_startup:
 7660              return
 7661          
 7662          # éªŒè¯è®¾ç½®
 7663          if not self.src_edit.text() or not self.tgt_edit.text() or not self.bak_edit.text():
 7664              self._append_log("âš  è‡ªåŠ¨è¿è¡Œå¤±è´¥ï¼šæ–‡ä»¶å¤¹è·¯å¾„æœªè®¾ç½®")
 7665              return
 7666          
 7667          self._append_log("ğŸš€ è‡ªåŠ¨è¿è¡Œå·²è§¦å‘ï¼Œ1ç§’åå¼€å§‹ä¸Šä¼ ...")
 7668          self._on_start()
 7669  
 7670      def _status_card(self) -> QtWidgets.QFrame:
 7671          card, v, self.title_status = self._card("ğŸ“Š è¿è¡ŒçŠ¶æ€", "card_status")
 7672          # status pill
 7673          self.lbl_status = QtWidgets.QLabel(t('status_stopped'))
 7674          self.lbl_status.setStyleSheet("background:#FEE2E2; color:#B91C1C; padding:6px 12px; font-weight:700; border-radius:12px; font-size:10pt;")
 7675          v.addWidget(self.lbl_status)
 7676          # chips - ä¼˜åŒ–ç½‘æ ¼å¸ƒå±€ï¼Œ4åˆ—æ˜¾ç¤ºæ›´ç´§å‡‘
 7677          grid = QtWidgets.QGridLayout()
 7678          grid.setSpacing(12)  # å¢åŠ é—´è·
 7679          self.lbl_uploaded = self._chip(t('uploaded'), "0", "#E3F2FD", "#1976D2")
 7680          self.lbl_failed = self._chip(t('failed'), "0", "#FFEBEE", "#C62828")
 7681          self.lbl_skipped = self._chip(t('skipped'), "0", "#FFF9C3", "#F57F17")
 7682          self.lbl_rate = self._chip(t('rate'), "0 MB/s", "#E8F5E9", "#2E7D32")
 7683          self.lbl_queue = self._chip(t('archive_queue'), "0", "#F3E5F5", "#6A1B9A")
 7684          self.lbl_time = self._chip(t('runtime'), "00:00:00", "#FFF3E0", "#E65100")
 7685          # æ–°å¢ï¼šç£ç›˜ç©ºé—´èŠ¯ç‰‡
 7686          self.lbl_target_disk = self._chip(t('target_disk'), "--", "#E1F5FE", "#01579B")
 7687          self.lbl_backup_disk = self._chip(t('backup_disk'), "--", "#F1F8E9", "#33691E")
 7688          # v1.9 æ–°å¢ï¼šç½‘ç»œçŠ¶æ€èŠ¯ç‰‡
 7689          self.lbl_network = self._chip(t('network_status'), t('network_unknown'), "#ECEFF1", "#546E7A")
 7690          # v2.0 æ–°å¢ï¼šåè®®å’ŒFTPçŠ¶æ€èŠ¯ç‰‡
 7691          self.lbl_protocol = self._chip(t('protocol_chip'), "SMB", "#E8EAF6", "#3F51B5")

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 156 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 7692          self.lbl_ftp_server = self._chip(t('ftp_server_chip'), t('not_started'), "#FCE4EC", "#C2185B")
 7693          self.lbl_ftp_client = self._chip(t('ftp_client_chip'), t('not_connected'), "#FFF8E1", "#F57C00")
 7694          
 7695          # 4åˆ—å¸ƒå±€ï¼Œåœ¨é«˜åˆ†è¾¨ç‡ä¸‹æ˜¾ç¤ºæ›´å¥½
 7696          for i, w in enumerate([self.lbl_uploaded, self.lbl_failed, self.lbl_skipped, 
 7697                                 self.lbl_rate, self.lbl_queue, self.lbl_time,
 7698                                 self.lbl_target_disk, self.lbl_backup_disk, self.lbl_network,
 7699                                 self.lbl_protocol, self.lbl_ftp_server, self.lbl_ftp_client]):
 7700              grid.addWidget(w, i//4, i%4)
 7701          v.addLayout(grid)
 7702          
 7703          # åˆ†éš”çº¿
 7704          v.addWidget(self._hline())
 7705          
 7706          # æ–°å¢ï¼šå½“å‰æ–‡ä»¶ä¿¡æ¯
 7707          self.current_file_label_widget = QtWidgets.QLabel(t('current_file_label'))
 7708          self.current_file_label_widget.setStyleSheet("font-weight:700; font-size:10pt; color:#424242; margin-top:4px;")
 7709          v.addWidget(self.current_file_label_widget)
 7710          
 7711          self.lbl_current_file = QtWidgets.QLabel(t('waiting'))
 7712          self.lbl_current_file.setStyleSheet("color:#616161; font-size:9pt; padding:4px 8px;")
 7713          self.lbl_current_file.setWordWrap(True)
 7714          v.addWidget(self.lbl_current_file)
 7715          
 7716          # å½“å‰æ–‡ä»¶è¿›åº¦æ¡
 7717          self.pbar_file = QtWidgets.QProgressBar()
 7718          self.pbar_file.setRange(0, 100)
 7719          self.pbar_file.setValue(0)
 7720          self.pbar_file.setTextVisible(True)
 7721          self.pbar_file.setFormat(t('waiting'))
 7722          self.pbar_file.setStyleSheet("""
 7723              QProgressBar {
 7724                  border: 2px solid #BDBDBD;
 7725                  border-radius: 6px;
 7726                  text-align: center;
 7727                  height: 20px;
 7728                  background-color: #F5F5F5;
 7729              }
 7730              QProgressBar::chunk {
 7731                  background: qlineargradient(x1:0, y1:0, x2:1, y2:0, 
 7732                                              stop:0 #4CAF50, stop:1 #81C784);
 7733                  border-radius: 4px;
 7734              }
 7735          """)
 7736          v.addWidget(self.pbar_file)
 7737          
 7738          # åˆ†éš”çº¿
 7739          v.addWidget(self._hline())
 7740          
 7741          # progress

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 157 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 7742          self.lbl_progress = QtWidgets.QLabel(t('waiting'))
 7743          v.addWidget(self.lbl_progress)
 7744          self.pbar = QtWidgets.QProgressBar()
 7745          self.pbar.setRange(0, 100)
 7746          self.pbar.setValue(0)
 7747          v.addWidget(self.pbar)
 7748          return card
 7749  
 7750      # v2.1 ç£ç›˜æ¸…ç†å¯¹è¯æ¡†
 7751      class DiskCleanupDialog(QtWidgets.QDialog):  # type: ignore[misc]
 7752          """ç£ç›˜æ¸…ç†å¯¹è¯æ¡† - æ”¯æŒé€‰æ‹©æ–‡ä»¶å¤¹è·¯å¾„å’Œæ–‡ä»¶æ ¼å¼
 7753          
 7754          Note: type: ignore[misc] - Qt åŠ¨æ€å¯¼å…¥å¯¼è‡´çš„ Pylance è¯¯æŠ¥
 7755          """
 7756          
 7757          def __init__(self, parent=None):
 7758              super().__init__(parent)
 7759              self.setWindowTitle("ğŸ’¿ ç£ç›˜æ¸…ç†å·¥å…·")
 7760              self.setModal(True)
 7761              self.resize(500, 500)  # å¢åŠ é«˜åº¦ä»¥å®¹çº³è‡ªåŠ¨æ¸…ç†é…ç½®
 7762              
 7763              self.parent_window = parent  # ä¿å­˜çˆ¶çª—å£å¼•ç”¨ï¼Œç”¨äºè¯»å–é…ç½®
 7764              self.files_to_delete = []  # å¾…åˆ é™¤çš„æ–‡ä»¶åˆ—è¡¨
 7765              
 7766              self._build_ui()
 7767          
 7768          def _build_ui(self):
 7769              layout = QtWidgets.QVBoxLayout(self)
 7770              layout.setSpacing(15)
 7771              layout.setContentsMargins(20, 20, 20, 20)
 7772              
 7773              # æ ‡é¢˜è¯´æ˜
 7774              title_label = QtWidgets.QLabel("é€‰æ‹©è¦æ¸…ç†çš„æ–‡ä»¶å¤¹å’Œæ–‡ä»¶ç±»å‹")
 7775              title_label.setStyleSheet("font-size: 13pt; font-weight: 700; color: #1976D2;")
 7776              layout.addWidget(title_label)
 7777              
 7778              desc_label = QtWidgets.QLabel(
 7779                  "âš ï¸ è­¦å‘Šï¼šåˆ é™¤çš„æ–‡ä»¶å°†æ— æ³•æ¢å¤ï¼è¯·ç¡®è®¤åå†æ‰§è¡Œæ¸…ç†æ“ä½œã€‚"
 7780              )
 7781              desc_label.setStyleSheet("color: #D32F2F; padding: 8px; background: #FFEBEE; border-radius: 6px;")
 7782              desc_label.setWordWrap(True)
 7783              layout.addWidget(desc_label)
 7784              
 7785              # æ–‡ä»¶å¤¹é€‰æ‹©åŒºåŸŸ
 7786              folder_group = QtWidgets.QGroupBox("ğŸ“ é€‰æ‹©æ¸…ç†ç›®æ ‡")
 7787              folder_group.setStyleSheet(
 7788                  "QGroupBox { font-weight: 700; border: 2px solid #64B5F6; "
 7789                  "border-radius: 8px; margin-top: 10px; padding-top: 15px; }"
 7790                  "QGroupBox::title { subcontrol-origin: margin; left: 10px; padding: 0 5px; }"
 7791              )

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 158 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 7792              folder_layout = QtWidgets.QVBoxLayout(folder_group)
 7793              folder_layout.setSpacing(12)
 7794              
 7795              # ä»çˆ¶çª—å£çš„è¾“å…¥æ¡†è¯»å–è·¯å¾„é…ç½®ï¼ˆå®æ—¶è¯»å–æœ€æ–°å€¼ï¼‰
 7796              backup_path = self.parent_window.bak_edit.text() if self.parent_window and hasattr(self.parent_window, 'bak_edit') else ""
 7797              target_path = self.parent_window.tgt_edit.text() if self.parent_window and hasattr(self.parent_window, 'tgt_edit') else ""
 7798              monitor_path = self.parent_window.auto_delete_folder if self.parent_window and hasattr(self.parent_window, 'auto_delete_folder') else ""
 7799              
 7800              # å¤‡ä»½æ–‡ä»¶å¤¹
 7801              self.cb_backup = QtWidgets.QCheckBox(f"ğŸ—‚ï¸ å¤‡ä»½æ–‡ä»¶å¤¹")
 7802              self.cb_backup.setChecked(True)
 7803              if backup_path:
 7804                  self.cb_backup.setText(f"ğŸ—‚ï¸ å¤‡ä»½æ–‡ä»¶å¤¹: {backup_path}")
 7805                  self.cb_backup.setToolTip(backup_path)
 7806              else:
 7807                  self.cb_backup.setEnabled(False)
 7808                  self.cb_backup.setText("ğŸ—‚ï¸ å¤‡ä»½æ–‡ä»¶å¤¹ (æœªé…ç½®)")
 7809              folder_layout.addWidget(self.cb_backup)
 7810              
 7811              # ç›®æ ‡æ–‡ä»¶å¤¹
 7812              self.cb_target = QtWidgets.QCheckBox(f"ğŸ“¤ ç›®æ ‡æ–‡ä»¶å¤¹ (æœåŠ¡å™¨)")
 7813              if target_path:
 7814                  self.cb_target.setText(f"ğŸ“¤ ç›®æ ‡æ–‡ä»¶å¤¹: {target_path}")
 7815                  self.cb_target.setToolTip(target_path)
 7816              else:
 7817                  self.cb_target.setEnabled(False)
 7818                  self.cb_target.setText("ğŸ“¤ ç›®æ ‡æ–‡ä»¶å¤¹ (æœªé…ç½®)")
 7819              folder_layout.addWidget(self.cb_target)
 7820              
 7821              # ç›‘æ§æ–‡ä»¶å¤¹ï¼ˆå¸¦è¾“å…¥åŠŸèƒ½ï¼‰
 7822              self.cb_monitor = QtWidgets.QCheckBox("ğŸ” ç›‘æ§æ–‡ä»¶å¤¹")
 7823              folder_layout.addWidget(self.cb_monitor)
 7824              
 7825              monitor_row = QtWidgets.QHBoxLayout()
 7826              monitor_row.setContentsMargins(30, 0, 0, 0)
 7827              self.edit_monitor = QtWidgets.QLineEdit(monitor_path)
 7828              self.edit_monitor.setPlaceholderText("é€‰æ‹©ç›‘æ§æ–‡ä»¶å¤¹è·¯å¾„...")
 7829              btn_monitor = QtWidgets.QPushButton("æµè§ˆ")
 7830              btn_monitor.setProperty("class", "Secondary")
 7831              btn_monitor.clicked.connect(self._choose_monitor)
 7832              monitor_row.addWidget(self.edit_monitor, 1)
 7833              monitor_row.addWidget(btn_monitor)
 7834              folder_layout.addLayout(monitor_row)
 7835              
 7836              # è‡ªå®šä¹‰æ–‡ä»¶å¤¹ï¼ˆä¿ç•™è¾“å…¥åŠŸèƒ½ï¼‰
 7837              self.cb_custom = QtWidgets.QCheckBox("ğŸ“‚ è‡ªå®šä¹‰æ–‡ä»¶å¤¹")
 7838              folder_layout.addWidget(self.cb_custom)
 7839              
 7840              custom_row = QtWidgets.QHBoxLayout()
 7841              custom_row.setContentsMargins(30, 0, 0, 0)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 159 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 7842              self.edit_custom = QtWidgets.QLineEdit()
 7843              self.edit_custom.setPlaceholderText("é€‰æ‹©è‡ªå®šä¹‰æ–‡ä»¶å¤¹è·¯å¾„...")
 7844              btn_custom = QtWidgets.QPushButton("æµè§ˆ")
 7845              btn_custom.setProperty("class", "Secondary")
 7846              btn_custom.clicked.connect(self._choose_custom)
 7847              custom_row.addWidget(self.edit_custom, 1)
 7848              custom_row.addWidget(btn_custom)
 7849              folder_layout.addLayout(custom_row)
 7850              
 7851              layout.addWidget(folder_group)
 7852              
 7853              # æ–‡ä»¶æ ¼å¼é€‰æ‹©åŒºåŸŸ
 7854              format_group = QtWidgets.QGroupBox("ğŸ“‹ é€‰æ‹©æ–‡ä»¶æ ¼å¼")
 7855              format_group.setStyleSheet(
 7856                  "QGroupBox { font-weight: 700; border: 2px solid #64B5F6; "
 7857                  "border-radius: 8px; margin-top: 10px; padding-top: 15px; }"
 7858                  "QGroupBox::title { subcontrol-origin: margin; left: 10px; padding: 0 5px; }"
 7859              )
 7860              format_layout = QtWidgets.QVBoxLayout(format_group)
 7861              format_layout.setSpacing(10)
 7862              
 7863              # å¿«é€Ÿé€‰æ‹©æŒ‰é’®
 7864              quick_row = QtWidgets.QHBoxLayout()
 7865              btn_all = QtWidgets.QPushButton("å…¨é€‰")
 7866              btn_all.setProperty("class", "Secondary")
 7867              btn_all.clicked.connect(self._select_all_formats)
 7868              btn_none = QtWidgets.QPushButton("å–æ¶ˆå…¨é€‰")
 7869              btn_none.setProperty("class", "Secondary")
 7870              btn_none.clicked.connect(self._select_no_formats)
 7871              btn_image = QtWidgets.QPushButton("ä»…å›¾ç‰‡")
 7872              btn_image.setProperty("class", "Secondary")
 7873              btn_image.clicked.connect(self._select_image_formats)
 7874              quick_row.addWidget(btn_all)
 7875              quick_row.addWidget(btn_none)
 7876              quick_row.addWidget(btn_image)
 7877              quick_row.addStretch()
 7878              format_layout.addLayout(quick_row)
 7879              
 7880              # æ–‡ä»¶æ ¼å¼å¤é€‰æ¡† - ç½‘æ ¼å¸ƒå±€
 7881              formats_grid = QtWidgets.QGridLayout()
 7882              formats_grid.setSpacing(8)
 7883              
 7884              self.format_checkboxes = {}
 7885              formats = [
 7886                  ('.jpg', 'å›¾ç‰‡'),
 7887                  ('.jpeg', 'å›¾ç‰‡'),
 7888                  ('.png', 'å›¾ç‰‡'),
 7889                  ('.bmp', 'å›¾ç‰‡'),
 7890                  ('.gif', 'å›¾ç‰‡'),
 7891                  ('.tiff', 'å›¾ç‰‡'),

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 160 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 7892                  ('.tif', 'å›¾ç‰‡'),
 7893                  ('.raw', 'å›¾ç‰‡'),
 7894                  ('.pdf', 'æ–‡æ¡£'),
 7895                  ('.doc', 'æ–‡æ¡£'),
 7896                  ('.docx', 'æ–‡æ¡£'),
 7897                  ('.txt', 'æ–‡æœ¬'),
 7898                  ('.log', 'æ—¥å¿—'),
 7899                  ('.zip', 'å‹ç¼©'),
 7900                  ('.rar', 'å‹ç¼©'),
 7901                  ('.tmp', 'ä¸´æ—¶'),
 7902              ]
 7903              
 7904              for idx, (ext, category) in enumerate(formats):
 7905                  cb = QtWidgets.QCheckBox(f"{ext} ({category})")
 7906                  cb.setChecked(ext in ['.jpg', '.jpeg', '.png', '.bmp', '.gif', '.tiff', '.tif', '.raw'])  # é»˜è®¤é€‰ä¸­å›¾ç‰‡
 7907                  self.format_checkboxes[ext] = cb
 7908                  row = idx // 4
 7909                  col = idx % 4
 7910                  formats_grid.addWidget(cb, row, col)
 7911              
 7912              format_layout.addLayout(formats_grid)
 7913              
 7914              # è‡ªå®šä¹‰æ ¼å¼
 7915              custom_format_row = QtWidgets.QHBoxLayout()
 7916              custom_format_label = QtWidgets.QLabel("è‡ªå®šä¹‰æ ¼å¼:")
 7917              self.edit_custom_format = QtWidgets.QLineEdit()
 7918              self.edit_custom_format.setPlaceholderText("ä¾‹å¦‚: .bak æˆ– .old (ä»¥ç‚¹å¼€å¤´)")
 7919              custom_format_row.addWidget(custom_format_label)
 7920              custom_format_row.addWidget(self.edit_custom_format, 1)
 7921              format_layout.addLayout(custom_format_row)
 7922              
 7923              layout.addWidget(format_group)
 7924              
 7925              # è‡ªåŠ¨æ¸…ç†é…ç½®åŒºåŸŸï¼ˆæ•´åˆè‡ªåŠ¨åˆ é™¤åŠŸèƒ½ï¼‰
 7926              auto_group = QtWidgets.QGroupBox("âš™ï¸ è‡ªåŠ¨æ¸…ç†é…ç½®")
 7927              auto_group.setStyleSheet(
 7928                  "QGroupBox { font-weight: 700; border: 2px solid #FFA726; "
 7929                  "border-radius: 8px; margin-top: 10px; padding-top: 15px; }"
 7930                  "QGroupBox::title { subcontrol-origin: margin; left: 10px; padding: 0 5px; }"
 7931              )
 7932              auto_layout = QtWidgets.QVBoxLayout(auto_group)
 7933              auto_layout.setSpacing(10)
 7934              
 7935              # å¯ç”¨è‡ªåŠ¨æ¸…ç†
 7936              self.cb_enable_auto = QtWidgets.QCheckBox("â° å¯ç”¨è‡ªåŠ¨æ¸…ç†")
 7937              auto_enabled = self.parent_window.enable_auto_delete if self.parent_window and hasattr(self.parent_window, 'enable_auto_delete') else False
 7938              self.cb_enable_auto.setChecked(auto_enabled)
 7939              self.cb_enable_auto.toggled.connect(self._on_auto_clean_toggled)
 7940              auto_layout.addWidget(self.cb_enable_auto)
 7941              

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 161 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 7942              # é…ç½®å‚æ•°
 7943              config_grid = QtWidgets.QGridLayout()
 7944              config_grid.setSpacing(10)
 7945              
 7946              # ç£ç›˜é˜ˆå€¼
 7947              threshold_label = QtWidgets.QLabel("ç£ç›˜é˜ˆå€¼:")
 7948              self.spin_threshold = QtWidgets.QSpinBox()
 7949              self.spin_threshold.setRange(50, 95)
 7950              auto_threshold = self.parent_window.auto_delete_threshold if self.parent_window and hasattr(self.parent_window, 'auto_delete_threshold') else 80
 7951              self.spin_threshold.setValue(auto_threshold)
 7952              self.spin_threshold.setSuffix(" %")
 7953              self.spin_threshold.setToolTip("ç£ç›˜ä½¿ç”¨ç‡è¾¾åˆ°æ­¤å€¼æ—¶è‡ªåŠ¨æ¸…ç†")
 7954              self.spin_threshold.setEnabled(auto_enabled)
 7955              config_grid.addWidget(threshold_label, 0, 0)
 7956              config_grid.addWidget(self.spin_threshold, 0, 1)
 7957              
 7958              # ä¿ç•™å¤©æ•°
 7959              days_label = QtWidgets.QLabel("ä¿ç•™å¤©æ•°:")
 7960              self.spin_keep_days = QtWidgets.QSpinBox()
 7961              self.spin_keep_days.setRange(1, 365)
 7962              auto_days = self.parent_window.auto_delete_keep_days if self.parent_window and hasattr(self.parent_window, 'auto_delete_keep_days') else 10
 7963              self.spin_keep_days.setValue(auto_days)
 7964              self.spin_keep_days.setSuffix(" å¤©")
 7965              self.spin_keep_days.setToolTip("åªåˆ é™¤è¶…è¿‡æ­¤å¤©æ•°çš„æ–‡ä»¶")
 7966              self.spin_keep_days.setEnabled(auto_enabled)
 7967              config_grid.addWidget(days_label, 0, 2)
 7968              config_grid.addWidget(self.spin_keep_days, 0, 3)
 7969              
 7970              # æ£€æŸ¥é—´éš”
 7971              interval_label = QtWidgets.QLabel("æ£€æŸ¥é—´éš”:")
 7972              self.spin_check_interval = QtWidgets.QSpinBox()
 7973              self.spin_check_interval.setRange(60, 3600)
 7974              auto_interval = self.parent_window.auto_delete_check_interval if self.parent_window and hasattr(self.parent_window, 'auto_delete_check_interval') else 300
 7975              self.spin_check_interval.setValue(auto_interval)
 7976              self.spin_check_interval.setSuffix(" ç§’")
 7977              self.spin_check_interval.setToolTip("è‡ªåŠ¨æ£€æŸ¥çš„æ—¶é—´é—´éš”")
 7978              self.spin_check_interval.setEnabled(auto_enabled)
 7979              config_grid.addWidget(interval_label, 1, 0)
 7980              config_grid.addWidget(self.spin_check_interval, 1, 1)
 7981              
 7982              auto_layout.addLayout(config_grid)
 7983              
 7984              # è¯´æ˜æ–‡æœ¬
 7985              auto_hint = QtWidgets.QLabel(
 7986                  "ğŸ’¡ å¯ç”¨åï¼Œç¨‹åºä¼šå®šæœŸæ£€æŸ¥ç£ç›˜ç©ºé—´ï¼Œå½“è¾¾åˆ°é˜ˆå€¼æ—¶è‡ªåŠ¨åˆ é™¤è¶…è¿‡ä¿ç•™æœŸé™çš„æ–‡ä»¶"
 7987              )
 7988              auto_hint.setStyleSheet("color: #757575; font-size: 9px; padding: 8px;")
 7989              auto_hint.setWordWrap(True)
 7990              auto_layout.addWidget(auto_hint)
 7991              

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 162 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 7992              # ä¿å­˜é…ç½®æŒ‰é’®
 7993              btn_save_auto = QtWidgets.QPushButton("ğŸ’¾ ä¿å­˜è‡ªåŠ¨æ¸…ç†é…ç½®")
 7994              btn_save_auto.setProperty("class", "Secondary")
 7995              btn_save_auto.clicked.connect(self._save_auto_config)
 7996              auto_layout.addWidget(btn_save_auto)
 7997              
 7998              layout.addWidget(auto_group)
 7999              
 8000              # æ‰«æç»“æœåŒºåŸŸ
 8001              result_group = QtWidgets.QGroupBox("ğŸ“Š æ‰«æç»“æœ")
 8002              result_group.setStyleSheet(
 8003                  "QGroupBox { font-weight: 700; border: 2px solid #64B5F6; "
 8004                  "border-radius: 8px; margin-top: 10px; padding-top: 15px; }"
 8005                  "QGroupBox::title { subcontrol-origin: margin; left: 10px; padding: 0 5px; }"
 8006              )
 8007              result_layout = QtWidgets.QVBoxLayout(result_group)
 8008              
 8009              self.result_text = QtWidgets.QPlainTextEdit()
 8010              self.result_text.setReadOnly(True)
 8011              self.result_text.setMaximumHeight(120)
 8012              self.result_text.setPlainText("ç‚¹å‡» 'æ‰«ææ–‡ä»¶' å¼€å§‹æŸ¥æ‰¾å¯æ¸…ç†çš„æ–‡ä»¶...")
 8013              result_layout.addWidget(self.result_text)
 8014              
 8015              layout.addWidget(result_group)
 8016              
 8017              # æŒ‰é’®åŒºåŸŸ
 8018              button_layout = QtWidgets.QHBoxLayout()
 8019              button_layout.setSpacing(12)
 8020              
 8021              self.btn_scan = QtWidgets.QPushButton("ğŸ” æ‰«ææ–‡ä»¶")
 8022              self.btn_scan.setProperty("class", "Primary")
 8023              self.btn_scan.setMinimumHeight(40)
 8024              self.btn_scan.clicked.connect(self._scan_files)
 8025              
 8026              self.btn_delete = QtWidgets.QPushButton("ğŸ—‘ï¸ æ‰§è¡Œæ¸…ç†")
 8027              self.btn_delete.setProperty("class", "Danger")
 8028              self.btn_delete.setMinimumHeight(40)
 8029              self.btn_delete.setEnabled(False)
 8030              self.btn_delete.clicked.connect(self._delete_files)
 8031              
 8032              btn_close = QtWidgets.QPushButton("âŒ å…³é—­")
 8033              btn_close.setProperty("class", "Secondary")
 8034              btn_close.setMinimumHeight(40)
 8035              btn_close.clicked.connect(self.reject)
 8036              
 8037              button_layout.addWidget(self.btn_scan)
 8038              button_layout.addWidget(self.btn_delete)
 8039              button_layout.addStretch()
 8040              button_layout.addWidget(btn_close)
 8041              

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 163 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 8042              layout.addLayout(button_layout)
 8043          
 8044          def _choose_custom(self):
 8045              path = QtWidgets.QFileDialog.getExistingDirectory(self, "é€‰æ‹©è‡ªå®šä¹‰æ–‡ä»¶å¤¹")
 8046              if path:
 8047                  self.edit_custom.setText(path)
 8048          
 8049          def _choose_monitor(self):
 8050              path = QtWidgets.QFileDialog.getExistingDirectory(self, "é€‰æ‹©ç›‘æ§æ–‡ä»¶å¤¹")
 8051              if path:
 8052                  self.edit_monitor.setText(path)
 8053          
 8054          def _select_all_formats(self):
 8055              for cb in self.format_checkboxes.values():
 8056                  cb.setChecked(True)
 8057          
 8058          def _select_no_formats(self):
 8059              for cb in self.format_checkboxes.values():
 8060                  cb.setChecked(False)
 8061          
 8062          def _select_image_formats(self):
 8063              image_formats = ['.jpg', '.jpeg', '.png', '.bmp', '.gif', '.tiff', '.tif', '.raw']
 8064              for ext, cb in self.format_checkboxes.items():
 8065                  cb.setChecked(ext in image_formats)
 8066          
 8067          def _on_auto_clean_toggled(self, checked: bool):
 8068              """è‡ªåŠ¨æ¸…ç†å¼€å…³åˆ‡æ¢"""
 8069              self.spin_threshold.setEnabled(checked)
 8070              self.spin_keep_days.setEnabled(checked)
 8071              self.spin_check_interval.setEnabled(checked)
 8072          
 8073          def _save_auto_config(self):
 8074              """ä¿å­˜è‡ªåŠ¨æ¸…ç†é…ç½®åˆ°çˆ¶çª—å£"""
 8075              if not self.parent_window:
 8076                  return
 8077              
 8078              try:
 8079                  # æ›´æ–°çˆ¶çª—å£çš„è‡ªåŠ¨åˆ é™¤é…ç½®
 8080                  self.parent_window.enable_auto_delete = self.cb_enable_auto.isChecked()
 8081                  self.parent_window.auto_delete_folder = self.edit_monitor.text().strip()  # ä¿å­˜ç›‘æ§æ–‡ä»¶å¤¹è·¯å¾„
 8082                  self.parent_window.auto_delete_threshold = self.spin_threshold.value()
 8083                  self.parent_window.auto_delete_keep_days = self.spin_keep_days.value()
 8084                  self.parent_window.auto_delete_check_interval = self.spin_check_interval.value()
 8085                  
 8086                  # ä¿å­˜é…ç½®åˆ°æ–‡ä»¶
 8087                  self.parent_window._save_config()
 8088                  
 8089                  # æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
 8090                  QtWidgets.QMessageBox.information(
 8091                      self,

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 164 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 8092                      "âœ… é…ç½®å·²ä¿å­˜",
 8093                      f"è‡ªåŠ¨æ¸…ç†é…ç½®å·²æˆåŠŸä¿å­˜ï¼\n\n"
 8094                      f"å¯ç”¨çŠ¶æ€: {'æ˜¯' if self.cb_enable_auto.isChecked() else 'å¦'}\n"
 8095                      f"ç›‘æ§æ–‡ä»¶å¤¹: {self.edit_monitor.text().strip() or 'æœªè®¾ç½®'}\n"
 8096                      f"ç£ç›˜é˜ˆå€¼: {self.spin_threshold.value()}%\n"
 8097                      f"ä¿ç•™å¤©æ•°: {self.spin_keep_days.value()}å¤©\n"
 8098                      f"æ£€æŸ¥é—´éš”: {self.spin_check_interval.value()}ç§’"
 8099                  )
 8100              except Exception as e:
 8101                  QtWidgets.QMessageBox.warning(
 8102                      self,
 8103                      "âŒ ä¿å­˜å¤±è´¥",
 8104                      f"ä¿å­˜é…ç½®æ—¶å‡ºé”™ï¼š{e}"
 8105                  )
 8106          
 8107          def _scan_files(self):
 8108              """æ‰«æç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶"""
 8109              self.files_to_delete = []
 8110              self.result_text.clear()
 8111              
 8112              # è·å–è¦æ‰«æçš„æ–‡ä»¶å¤¹ï¼ˆä»çˆ¶çª—å£è¾“å…¥æ¡†è¯»å–æœ€æ–°è·¯å¾„ï¼‰
 8113              folders_to_scan = []
 8114              if self.cb_backup.isChecked() and self.parent_window and hasattr(self.parent_window, 'bak_edit'):
 8115                  backup_path = self.parent_window.bak_edit.text().strip()
 8116                  if backup_path:
 8117                      folders_to_scan.append(backup_path)
 8118              if self.cb_target.isChecked() and self.parent_window and hasattr(self.parent_window, 'tgt_edit'):
 8119                  target_path = self.parent_window.tgt_edit.text().strip()
 8120                  if target_path:
 8121                      folders_to_scan.append(target_path)
 8122              if self.cb_monitor.isChecked() and self.edit_monitor.text().strip():
 8123                  monitor_path = self.edit_monitor.text().strip()
 8124                  if monitor_path:
 8125                      folders_to_scan.append(monitor_path)
 8126              if self.cb_custom.isChecked() and self.edit_custom.text().strip():
 8127                  folders_to_scan.append(self.edit_custom.text().strip())
 8128              
 8129              if not folders_to_scan:
 8130                  self.result_text.setPlainText("âŒ é”™è¯¯ï¼šè¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼")
 8131                  return
 8132              
 8133              # è·å–è¦æ‰«æçš„æ–‡ä»¶æ ¼å¼
 8134              formats_to_scan = []
 8135              for ext, cb in self.format_checkboxes.items():
 8136                  if cb.isChecked():
 8137                      formats_to_scan.append(ext.lower())
 8138              
 8139              # æ·»åŠ è‡ªå®šä¹‰æ ¼å¼
 8140              custom_format = self.edit_custom_format.text().strip()
 8141              if custom_format:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 165 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 8142                  if not custom_format.startswith('.'):
 8143                      custom_format = '.' + custom_format
 8144                  formats_to_scan.append(custom_format.lower())
 8145              
 8146              if not formats_to_scan:
 8147                  self.result_text.setPlainText("âŒ é”™è¯¯ï¼šè¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶æ ¼å¼ï¼")
 8148                  return
 8149              
 8150              # å¼€å§‹æ‰«æ
 8151              self.result_text.appendPlainText("ğŸ” å¼€å§‹æ‰«æ...\n")
 8152              self.result_text.appendPlainText(f"æ‰«æç›®å½•: {len(folders_to_scan)} ä¸ª")
 8153              self.result_text.appendPlainText(f"æ–‡ä»¶æ ¼å¼: {', '.join(formats_to_scan)}\n")
 8154              
 8155              total_size = 0
 8156              for folder in folders_to_scan:
 8157                  if not os.path.exists(folder):
 8158                      self.result_text.appendPlainText(f"âš ï¸ è·³è¿‡ä¸å­˜åœ¨çš„è·¯å¾„: {folder}")
 8159                      continue
 8160                  
 8161                  self.result_text.appendPlainText(f"\nğŸ“ æ‰«æ: {folder}")
 8162                  folder_count = 0
 8163                  folder_size = 0
 8164                  
 8165                  try:
 8166                      for root, dirs, files in os.walk(folder):
 8167                          for file in files:
 8168                              file_lower = file.lower()
 8169                              if any(file_lower.endswith(ext) for ext in formats_to_scan):
 8170                                  file_path = os.path.join(root, file)
 8171                                  try:
 8172                                      file_size = os.path.getsize(file_path)
 8173                                      self.files_to_delete.append((file_path, file_size))
 8174                                      folder_count += 1
 8175                                      folder_size += file_size
 8176                                  except Exception as e:
 8177                                      self.result_text.appendPlainText(f"  âš ï¸ æ— æ³•è®¿é—®: {file} ({e})")
 8178                      
 8179                      self.result_text.appendPlainText(
 8180                          f"  æ‰¾åˆ° {folder_count} ä¸ªæ–‡ä»¶ï¼Œ"
 8181                          f"å…± {folder_size / (1024*1024):.2f} MB"
 8182                      )
 8183                      total_size += folder_size
 8184                  except Exception as e:
 8185                      self.result_text.appendPlainText(f"  âŒ æ‰«æå¤±è´¥: {e}")
 8186              
 8187              # æ˜¾ç¤ºæ±‡æ€»
 8188              self.result_text.appendPlainText("\n" + "="*50)
 8189              self.result_text.appendPlainText(
 8190                  f"ğŸ“Š æ‰«æå®Œæˆï¼å…±æ‰¾åˆ° {len(self.files_to_delete)} ä¸ªæ–‡ä»¶"
 8191              )

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 166 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 8192              self.result_text.appendPlainText(
 8193                  f"ğŸ’¾ æ€»å¤§å°: {total_size / (1024*1024):.2f} MB "
 8194                  f"({total_size / (1024*1024*1024):.3f} GB)"
 8195              )
 8196              
 8197              # å¯ç”¨åˆ é™¤æŒ‰é’®
 8198              self.btn_delete.setEnabled(len(self.files_to_delete) > 0)
 8199          
 8200          def _delete_files(self):
 8201              """åˆ é™¤æ‰«æåˆ°çš„æ–‡ä»¶"""
 8202              if not self.files_to_delete:
 8203                  return
 8204              
 8205              # ç¡®è®¤å¯¹è¯æ¡†
 8206              total_size = sum(size for _, size in self.files_to_delete)
 8207              reply = QtWidgets.QMessageBox.warning(
 8208                  self,
 8209                  "âš ï¸ ç¡®è®¤åˆ é™¤",
 8210                  f"ç¡®å®šè¦åˆ é™¤ {len(self.files_to_delete)} ä¸ªæ–‡ä»¶å—ï¼Ÿ\n\n"
 8211                  f"æ€»å¤§å°: {total_size / (1024*1024):.2f} MB\n\n"
 8212                  f"âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œä¸å¯æ¢å¤ï¼",
 8213                  QtWidgets.QMessageBox.StandardButton.Yes | QtWidgets.QMessageBox.StandardButton.No,
 8214                  QtWidgets.QMessageBox.StandardButton.No
 8215              )
 8216              
 8217              if reply != QtWidgets.QMessageBox.StandardButton.Yes:
 8218                  return
 8219              
 8220              # æ‰§è¡Œåˆ é™¤
 8221              self.result_text.appendPlainText("\n" + "="*50)
 8222              self.result_text.appendPlainText("ğŸ—‘ï¸ å¼€å§‹åˆ é™¤æ–‡ä»¶...\n")
 8223              
 8224              deleted_count = 0
 8225              deleted_size = 0
 8226              failed_count = 0
 8227              
 8228              for file_path, file_size in self.files_to_delete:
 8229                  try:
 8230                      os.remove(file_path)
 8231                      deleted_count += 1
 8232                      deleted_size += file_size
 8233                  except Exception as e:
 8234                      failed_count += 1
 8235                      self.result_text.appendPlainText(f"âŒ åˆ é™¤å¤±è´¥: {file_path}\n   é”™è¯¯: {e}")
 8236              
 8237              # æ˜¾ç¤ºç»“æœ
 8238              self.result_text.appendPlainText("\n" + "="*50)
 8239              self.result_text.appendPlainText("âœ… æ¸…ç†å®Œæˆï¼\n")
 8240              self.result_text.appendPlainText(f"æˆåŠŸåˆ é™¤: {deleted_count} ä¸ªæ–‡ä»¶")
 8241              self.result_text.appendPlainText(

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 167 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 8242                  f"é‡Šæ”¾ç©ºé—´: {deleted_size / (1024*1024):.2f} MB "
 8243                  f"({deleted_size / (1024*1024*1024):.3f} GB)"
 8244              )
 8245              if failed_count > 0:
 8246                  self.result_text.appendPlainText(f"åˆ é™¤å¤±è´¥: {failed_count} ä¸ªæ–‡ä»¶")
 8247              
 8248              # æ¸…ç©ºå¾…åˆ é™¤åˆ—è¡¨å¹¶ç¦ç”¨åˆ é™¤æŒ‰é’®
 8249              self.files_to_delete = []
 8250              self.btn_delete.setEnabled(False)
 8251              
 8252              # æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
 8253              QtWidgets.QMessageBox.information(
 8254                  self,
 8255                  "âœ… æ¸…ç†å®Œæˆ",
 8256                  f"æˆåŠŸåˆ é™¤ {deleted_count} ä¸ªæ–‡ä»¶\n"
 8257                  f"é‡Šæ”¾ç©ºé—´ {deleted_size / (1024*1024):.2f} MB"
 8258              )
 8259  
 8260      class CollapsibleBox(QtWidgets.QWidget):  # type: ignore[misc]
 8261          """å¯æŠ˜å çš„ç»„ä»¶
 8262          
 8263          Note: type: ignore[misc] - Qt åŠ¨æ€å¯¼å…¥å¯¼è‡´çš„ Pylance è¯¯æŠ¥
 8264          """
 8265          def __init__(self, title: str = "", parent: QtWidgets.QWidget = None):
 8266              super().__init__(parent)
 8267              self.toggle_button = QtWidgets.QToolButton()
 8268              self.toggle_button.setStyleSheet("QToolButton { border: none; font-weight: 700; }")
 8269              self.toggle_button.setToolButtonStyle(QtCore.Qt.ToolButtonStyle.ToolButtonTextBesideIcon)
 8270              self.toggle_button.setArrowType(QtCore.Qt.ArrowType.RightArrow)
 8271              self.toggle_button.setText(title)
 8272              self.toggle_button.setCheckable(True)
 8273              self.toggle_button.setChecked(False)
 8274              
 8275              self.content_area = QtWidgets.QWidget()
 8276              self.content_area.setVisible(False)
 8277              self.content_layout = QtWidgets.QVBoxLayout(self.content_area)
 8278              self.content_layout.setContentsMargins(20, 8, 8, 8)
 8279              
 8280              self.toggle_button.toggled.connect(self._on_toggle)
 8281              
 8282              main_layout = QtWidgets.QVBoxLayout(self)
 8283              main_layout.setSpacing(0)
 8284              main_layout.setContentsMargins(0, 0, 0, 0)
 8285              main_layout.addWidget(self.toggle_button)
 8286              main_layout.addWidget(self.content_area)
 8287          
 8288          def _on_toggle(self, checked: bool):
 8289              self.toggle_button.setArrowType(
 8290                  QtCore.Qt.ArrowType.DownArrow if checked else QtCore.Qt.ArrowType.RightArrow
 8291              )

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 168 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 8292              self.content_area.setVisible(checked)
 8293          
 8294          def setContentLayout(self, layout: QtWidgets.QLayout):
 8295              """è®¾ç½®å†…å®¹å¸ƒå±€"""
 8296              # æ¸…é™¤æ—§å¸ƒå±€
 8297              old_layout = self.content_area.layout()
 8298              if old_layout is not None:
 8299                  QtWidgets.QWidget().setLayout(old_layout)
 8300              self.content_area.setLayout(layout)
 8301              layout.setContentsMargins(20, 8, 8, 8)
 8302          
 8303          def addWidget(self, widget: QtWidgets.QWidget):
 8304              """æ·»åŠ widgetåˆ°å†…å®¹åŒºåŸŸ"""
 8305              self.content_layout.addWidget(widget)
 8306          
 8307          def addLayout(self, layout: QtWidgets.QLayout):
 8308              """æ·»åŠ layoutåˆ°å†…å®¹åŒºåŸŸ"""
 8309              self.content_layout.addLayout(layout)
 8310          
 8311          def setTitle(self, title: str):
 8312              """è®¾ç½®æ ‡é¢˜æ–‡æœ¬ï¼ˆç”¨äºå¤šè¯­è¨€åˆ‡æ¢ï¼‰"""
 8313              self.toggle_button.setText(title)
 8314  
 8315      class ChipWidget(QtWidgets.QFrame):  # type: ignore[misc]
 8316          value_label: QtWidgets.QLabel
 8317          title_label: QtWidgets.QLabel  # v3.0.2: æ·»åŠ æ ‡é¢˜æ ‡ç­¾å¼•ç”¨ç”¨äºå¤šè¯­è¨€
 8318          def __init__(self, title: str, val: str, bg: str, fg: str, parent: QtWidgets.QWidget = None):
 8319              super().__init__(parent)
 8320              self.setStyleSheet(f"QFrame{{background:{bg}; border-radius:8px; padding:2px;}} QLabel{{color:{fg};}}")
 8321              vv = QtWidgets.QVBoxLayout(self)
 8322              vv.setSpacing(4)  # å¢åŠ æ ‡é¢˜å’Œå€¼ä¹‹é—´çš„é—´è·
 8323              vv.setContentsMargins(10, 8, 10, 8)  # å¢åŠ å†…è¾¹è·
 8324              self.title_label = QtWidgets.QLabel(title)  # v3.0.2: ä¿å­˜å¼•ç”¨
 8325              self.title_label.setStyleSheet("font-size:9.5pt; padding-top:2px;")
 8326              self.value_label = QtWidgets.QLabel(val)
 8327              self.value_label.setStyleSheet("font-weight:700; font-size:11.5pt; padding-bottom:2px;")
 8328              vv.addWidget(self.title_label)
 8329              vv.addWidget(self.value_label)
 8330          def setValue(self, text: str):
 8331              self.value_label.setText(text)
 8332  
 8333      def _chip(self, title: str, val: str, bg: str, fg: str) -> "MainWindow.ChipWidget":
 8334          return MainWindow.ChipWidget(title, val, bg, fg, self)
 8335  
 8336      def _hline(self):
 8337          line = QtWidgets.QFrame()
 8338          shape_enum = getattr(QtWidgets.QFrame, 'Shape', QtWidgets.QFrame)
 8339          line.setFrameShape(getattr(shape_enum, 'HLine'))
 8340          line.setStyleSheet("color:#E5EAF0")
 8341          return line

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 169 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 8342  
 8343      def _log_card(self) -> QtWidgets.QFrame:
 8344          card, v, self.title_log = self._card("ğŸ“œ è¿è¡Œæ—¥å¿—", "card_log")
 8345          # toolbar
 8346          toolbar = QtWidgets.QHBoxLayout()
 8347          toolbar.addStretch(1)
 8348          
 8349          # å³ä¾§ï¼šè‡ªåŠ¨æ»šåŠ¨
 8350          self.cb_autoscroll = QtWidgets.QCheckBox("ğŸ“œ è‡ªåŠ¨æ»šåŠ¨")
 8351          self.cb_autoscroll.setChecked(True)
 8352          toolbar.addWidget(self.cb_autoscroll)
 8353          v.addLayout(toolbar)
 8354          # log area - å‹ç¼©é«˜åº¦ä»¥èŠ‚çœç©ºé—´
 8355          self.log = QtWidgets.QPlainTextEdit()
 8356          self.log.setReadOnly(True)
 8357          self.log.setMinimumHeight(300)  # å‡å°æœ€å°é«˜åº¦ï¼Œä½¿ç”¨å¯æŠ˜å ç»„ä»¶åå¯å‡å°‘æ»šåŠ¨éœ€æ±‚
 8358          v.addWidget(self.log)
 8359          return card
 8360  
 8361      # actions
 8362      def _choose_source(self):
 8363          """é€‰æ‹©æºæ–‡ä»¶å¤¹"""
 8364          # è·å–å½“å‰è·¯å¾„ä½œä¸ºé»˜è®¤æ‰“å¼€ä½ç½®
 8365          current = self.src_edit.text()
 8366          start_dir = current if current and os.path.exists(current) else ""
 8367          
 8368          self._append_log("ğŸ“‚ æ­£åœ¨é€‰æ‹©æºæ–‡ä»¶å¤¹...")
 8369          d = QtWidgets.QFileDialog.getExistingDirectory(self, "é€‰æ‹©æºæ–‡ä»¶å¤¹", start_dir)
 8370          if d:
 8371              self._append_log(f"âœ“ å·²é€‰æ‹©æºæ–‡ä»¶å¤¹: {d}")
 8372              self.src_edit.setText(d)
 8373              self._mark_config_modified()
 8374          else:
 8375              self._append_log("âœ— å–æ¶ˆé€‰æ‹©æºæ–‡ä»¶å¤¹")
 8376  
 8377      def _choose_target(self):
 8378          """é€‰æ‹©ç›®æ ‡æ–‡ä»¶å¤¹"""
 8379          # è·å–å½“å‰è·¯å¾„ä½œä¸ºé»˜è®¤æ‰“å¼€ä½ç½®
 8380          current = self.tgt_edit.text()
 8381          start_dir = current if current and os.path.exists(current) else ""
 8382          
 8383          self._append_log("ğŸ“‚ æ­£åœ¨é€‰æ‹©ç›®æ ‡æ–‡ä»¶å¤¹...")
 8384          d = QtWidgets.QFileDialog.getExistingDirectory(self, "é€‰æ‹©ç›®æ ‡æ–‡ä»¶å¤¹", start_dir)
 8385          if d:
 8386              self._append_log(f"âœ“ å·²é€‰æ‹©ç›®æ ‡æ–‡ä»¶å¤¹: {d}")
 8387              self.tgt_edit.setText(d)
 8388              self._mark_config_modified()
 8389          else:
 8390              self._append_log("âœ— å–æ¶ˆé€‰æ‹©ç›®æ ‡æ–‡ä»¶å¤¹")
 8391  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 170 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 8392      def _choose_backup(self):
 8393          """é€‰æ‹©å¤‡ä»½æ–‡ä»¶å¤¹"""
 8394          # è·å–å½“å‰è·¯å¾„ä½œä¸ºé»˜è®¤æ‰“å¼€ä½ç½®
 8395          current = self.bak_edit.text()
 8396          start_dir = current if current and os.path.exists(current) else ""
 8397          
 8398          self._append_log("ğŸ“‚ æ­£åœ¨é€‰æ‹©å¤‡ä»½æ–‡ä»¶å¤¹...")
 8399          d = QtWidgets.QFileDialog.getExistingDirectory(self, "é€‰æ‹©å¤‡ä»½æ–‡ä»¶å¤¹", start_dir)
 8400          if d:
 8401              self._append_log(f"âœ“ å·²é€‰æ‹©å¤‡ä»½æ–‡ä»¶å¤¹: {d}")
 8402              self.bak_edit.setText(d)
 8403              self._mark_config_modified()
 8404          else:
 8405              self._append_log("âœ— å–æ¶ˆé€‰æ‹©å¤‡ä»½æ–‡ä»¶å¤¹")
 8406  
 8407      def _on_backup_toggled(self, checked: bool):
 8408          """åˆ‡æ¢å¤‡ä»½å¼€å…³"""
 8409          self.enable_backup = checked
 8410          # åˆ·æ–°UIæƒé™ï¼ˆä¼šè‡ªåŠ¨æ›´æ–°å¤‡ä»½è·¯å¾„è¾“å…¥æ¡†å’Œæµè§ˆæŒ‰é’®çš„çŠ¶æ€ï¼‰
 8411          self._update_ui_permissions()
 8412          self._mark_config_modified()
 8413  
 8414      def _mark_config_modified(self):
 8415          """æ ‡è®°é…ç½®å·²ä¿®æ”¹"""
 8416          self.config_modified = True
 8417          self._append_log('âš  é…ç½®å·²ä¿®æ”¹ï¼Œè¯·ç‚¹å‡»"ä¿å­˜é…ç½®"æŒ‰é’®ç¡®è®¤')
 8418  
 8419      def _validate_paths(self) -> tuple:
 8420          """éªŒè¯æ–‡ä»¶å¤¹è·¯å¾„æ˜¯å¦å­˜åœ¨
 8421          è¿”å›: (æ˜¯å¦å…¨éƒ¨æœ‰æ•ˆ, é”™è¯¯æ¶ˆæ¯åˆ—è¡¨)
 8422          """
 8423          errors = []
 8424          src = self.src_edit.text().strip()
 8425          tgt = self.tgt_edit.text().strip()
 8426          bak = self.bak_edit.text().strip()
 8427          
 8428          self._append_log("ğŸ” æ­£åœ¨éªŒè¯æ–‡ä»¶å¤¹è·¯å¾„...")
 8429          
 8430          if not src:
 8431              errors.append("æºæ–‡ä»¶å¤¹è·¯å¾„ä¸ºç©º")
 8432          elif not os.path.exists(src):
 8433              errors.append(f"æºæ–‡ä»¶å¤¹ä¸å­˜åœ¨: {src}")
 8434          else:
 8435              self._append_log(f"âœ“ æºæ–‡ä»¶å¤¹è·¯å¾„æœ‰æ•ˆ: {src}")
 8436          
 8437          if not tgt:
 8438              errors.append("ç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„ä¸ºç©º")
 8439          elif not os.path.exists(tgt):
 8440              errors.append(f"ç›®æ ‡æ–‡ä»¶å¤¹ä¸å­˜åœ¨: {tgt}")
 8441          else:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 171 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 8442              self._append_log(f"âœ“ ç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„æœ‰æ•ˆ: {tgt}")
 8443          
 8444          # v2.1.1 ä¿®æ”¹ï¼šåªæœ‰å¯ç”¨å¤‡ä»½æ—¶æ‰éªŒè¯å¤‡ä»½è·¯å¾„
 8445          if self.enable_backup:
 8446              if not bak:
 8447                  errors.append("å¤‡ä»½æ–‡ä»¶å¤¹è·¯å¾„ä¸ºç©º")
 8448              elif not os.path.exists(bak):
 8449                  errors.append(f"å¤‡ä»½æ–‡ä»¶å¤¹ä¸å­˜åœ¨: {bak}")
 8450              else:
 8451                  self._append_log(f"âœ“ å¤‡ä»½æ–‡ä»¶å¤¹è·¯å¾„æœ‰æ•ˆ: {bak}")
 8452          
 8453          # é¢å¤–æ ¡éªŒï¼šä¸‰ä¸ªè·¯å¾„å¿…é¡»äº’ä¸ç›¸åŒï¼Œé¿å…ç”¨æˆ·è¯¯å¡«ç›¸åŒè·¯å¾„å¯¼è‡´å¾ªç¯æˆ–æ•°æ®è¦†ç›–
 8454          try:
 8455              def _norm(p: str) -> str:
 8456                  return os.path.normcase(os.path.abspath(p)) if p else ''
 8457  
 8458              n_src = _norm(src)
 8459              n_tgt = _norm(tgt)
 8460              n_bak = _norm(bak)
 8461  
 8462              if n_src and n_tgt and n_src == n_tgt:
 8463                  errors.append("æºæ–‡ä»¶å¤¹ä¸ç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„ç›¸åŒï¼Œè¯·é€‰æ‹©ä¸åŒçš„è·¯å¾„")
 8464              # v2.1.1 ä¿®æ”¹ï¼šåªæœ‰å¯ç”¨å¤‡ä»½æ—¶æ‰æ£€æŸ¥å¤‡ä»½è·¯å¾„ç›¸åŒæ€§
 8465              if self.enable_backup:
 8466                  if n_src and n_bak and n_src == n_bak:
 8467                      errors.append("æºæ–‡ä»¶å¤¹ä¸å¤‡ä»½æ–‡ä»¶å¤¹è·¯å¾„ç›¸åŒï¼Œè¯·é€‰æ‹©ä¸åŒçš„è·¯å¾„")
 8468                  if n_tgt and n_bak and n_tgt == n_bak:
 8469                      errors.append("ç›®æ ‡æ–‡ä»¶å¤¹ä¸å¤‡ä»½æ–‡ä»¶å¤¹è·¯å¾„ç›¸åŒï¼Œè¯·é€‰æ‹©ä¸åŒçš„è·¯å¾„")
 8470          except Exception:
 8471              # å¦‚æœè·¯å¾„è§„èŒƒåŒ–å‡ºé”™ï¼Œä¸å½±å“å·²æœ‰çš„å­˜åœ¨æ€§æ£€æŸ¥ï¼Œç»§ç»­è¿”å›å…¶ä»–é”™è¯¯ä¿¡æ¯
 8472              pass
 8473          
 8474          if errors:
 8475              self._append_log(f"âŒ è·¯å¾„éªŒè¯å¤±è´¥ï¼Œå‘ç° {len(errors)} ä¸ªé”™è¯¯")
 8476          else:
 8477              self._append_log("âœ“ æ‰€æœ‰è·¯å¾„éªŒè¯é€šè¿‡")
 8478          
 8479          return len(errors) == 0, errors
 8480      
 8481      def _validate_ftp_config(self) -> tuple:
 8482          """
 8483          éªŒè¯FTPé…ç½®çš„æœ‰æ•ˆæ€§
 8484          
 8485          Returns:
 8486              tuple: (æ˜¯å¦æœ‰æ•ˆ, é”™è¯¯æ¶ˆæ¯åˆ—è¡¨)
 8487          """
 8488          errors = []
 8489          
 8490          # å¦‚æœä¸ä½¿ç”¨FTPï¼Œè·³è¿‡éªŒè¯
 8491          if self.current_protocol == 'smb':

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 172 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 8492              return True, []
 8493          
 8494          self._append_log("ğŸ” æ­£åœ¨éªŒè¯FTPé…ç½®...")
 8495          
 8496          # éªŒè¯FTPæœåŠ¡å™¨é…ç½®
 8497          if self.current_protocol in ['ftp_server', 'both']:
 8498              # ä¸»æœºåœ°å€éªŒè¯
 8499              host = self.ftp_server_config.get('host', '').strip()
 8500              if not host:
 8501                  errors.append("FTPæœåŠ¡å™¨ä¸»æœºåœ°å€ä¸ºç©º")
 8502              elif host not in ['0.0.0.0', 'localhost', '127.0.0.1']:
 8503                  # ç®€å•çš„IPæ ¼å¼éªŒè¯
 8504                  import re
 8505                  if not re.match(r'^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$', host):
 8506                      errors.append(f"FTPæœåŠ¡å™¨ä¸»æœºåœ°å€æ ¼å¼æ— æ•ˆ: {host}")
 8507              
 8508              # ç«¯å£éªŒè¯
 8509              port = self.ftp_server_config.get('port', 0)
 8510              if not isinstance(port, int) or port < 1 or port > 65535:
 8511                  errors.append(f"FTPæœåŠ¡å™¨ç«¯å£æ— æ•ˆ: {port}ï¼ˆèŒƒå›´ï¼š1-65535ï¼‰")
 8512              elif port < 1024 and port != 21:
 8513                  self._append_log(f"âš ï¸  FTPæœåŠ¡å™¨ä½¿ç”¨ç‰¹æƒç«¯å£ {port}ï¼Œå¯èƒ½éœ€è¦ç®¡ç†å‘˜æƒé™")
 8514              
 8515              # ç”¨æˆ·åéªŒè¯
 8516              username = self.ftp_server_config.get('username', '').strip()
 8517              if not username:
 8518                  errors.append("FTPæœåŠ¡å™¨ç”¨æˆ·åä¸ºç©º")
 8519              elif len(username) < 3:
 8520                  errors.append("FTPæœåŠ¡å™¨ç”¨æˆ·åè‡³å°‘éœ€è¦3ä¸ªå­—ç¬¦")
 8521              
 8522              # å¯†ç éªŒè¯
 8523              password = self.ftp_server_config.get('password', '').strip()
 8524              if not password:
 8525                  errors.append("FTPæœåŠ¡å™¨å¯†ç ä¸ºç©º")
 8526              elif len(password) < 6:
 8527                  errors.append("FTPæœåŠ¡å™¨å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦")
 8528              
 8529              # å…±äº«ç›®å½•éªŒè¯
 8530              share_folder = self.ftp_server_config.get('shared_folder', '').strip()
 8531              if not share_folder:
 8532                  errors.append("FTPæœåŠ¡å™¨å…±äº«ç›®å½•ä¸ºç©º")
 8533              elif not os.path.exists(share_folder):
 8534                  errors.append(f"FTPæœåŠ¡å™¨å…±äº«ç›®å½•ä¸å­˜åœ¨: {share_folder}")
 8535              elif not os.path.isdir(share_folder):
 8536                  errors.append(f"FTPæœåŠ¡å™¨å…±äº«è·¯å¾„ä¸æ˜¯ç›®å½•: {share_folder}")
 8537              else:
 8538                  self._append_log(f"âœ“ FTPæœåŠ¡å™¨å…±äº«ç›®å½•æœ‰æ•ˆ: {share_folder}")
 8539          
 8540          # éªŒè¯FTPå®¢æˆ·ç«¯é…ç½®
 8541          if self.current_protocol in ['ftp_client', 'both']:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 173 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 8542              # ä¸»æœºåœ°å€éªŒè¯
 8543              host = self.ftp_client_config.get('host', '').strip()
 8544              if not host:
 8545                  errors.append("FTPå®¢æˆ·ç«¯ä¸»æœºåœ°å€ä¸ºç©º")
 8546              else:
 8547                  # ç®€å•çš„åŸŸåæˆ–IPæ ¼å¼éªŒè¯
 8548                  import re
 8549                  is_ip = re.match(r'^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$', host)
 8550                  is_domain = re.match(r'^[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?)*$', host)
 8551                  if not is_ip and not is_domain:
 8552                      errors.append(f"FTPå®¢æˆ·ç«¯ä¸»æœºåœ°å€æ ¼å¼æ— æ•ˆ: {host}")
 8553              
 8554              # ç«¯å£éªŒè¯
 8555              port = self.ftp_client_config.get('port', 0)
 8556              if not isinstance(port, int) or port < 1 or port > 65535:
 8557                  errors.append(f"FTPå®¢æˆ·ç«¯ç«¯å£æ— æ•ˆ: {port}ï¼ˆèŒƒå›´ï¼š1-65535ï¼‰")
 8558              
 8559              # ç”¨æˆ·åéªŒè¯
 8560              username = self.ftp_client_config.get('username', '').strip()
 8561              if not username:
 8562                  errors.append("FTPå®¢æˆ·ç«¯ç”¨æˆ·åä¸ºç©º")
 8563              
 8564              # å¯†ç éªŒè¯
 8565              password = self.ftp_client_config.get('password', '').strip()
 8566              if not password:
 8567                  errors.append("FTPå®¢æˆ·ç«¯å¯†ç ä¸ºç©º")
 8568              
 8569              # è¿œç¨‹è·¯å¾„éªŒè¯
 8570              remote_path = self.ftp_client_config.get('remote_path', '').strip()
 8571              if not remote_path:
 8572                  errors.append("FTPå®¢æˆ·ç«¯è¿œç¨‹è·¯å¾„ä¸ºç©º")
 8573              elif not remote_path.startswith('/'):
 8574                  errors.append(f"FTPå®¢æˆ·ç«¯è¿œç¨‹è·¯å¾„åº”ä»¥ / å¼€å¤´: {remote_path}")
 8575          
 8576          if errors:
 8577              self._append_log(f"âŒ FTPé…ç½®éªŒè¯å¤±è´¥ï¼Œå‘ç° {len(errors)} ä¸ªé”™è¯¯")
 8578          else:
 8579              self._append_log("âœ“ FTPé…ç½®éªŒè¯é€šè¿‡")
 8580          
 8581          return len(errors) == 0, errors
 8582  
 8583      def _save_config(self):
 8584          """ä¿å­˜é…ç½®åˆ°æ–‡ä»¶"""
 8585          # v2.2.0 æƒé™æ£€æŸ¥ï¼šä»…ç™»å½•ç”¨æˆ·å¯ä¿å­˜é…ç½®
 8586          if self.current_role == 'guest':
 8587              self._append_log("âŒ æœªç™»å½•ç”¨æˆ·æ— æƒä¿å­˜é…ç½®")
 8588              self._toast('è¯·å…ˆç™»å½•åå†ä¿å­˜é…ç½®', 'warning')
 8589              return
 8590          
 8591          self._append_log("ğŸ’¾ æ­£åœ¨ä¿å­˜é…ç½®...")

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 174 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 8592          
 8593          # v2.2.0 æ–°å¢ï¼šä¿å­˜å‰éªŒè¯è·¯å¾„
 8594          is_valid, errors = self._validate_paths()
 8595          if not is_valid:
 8596              error_msg = "\n".join(errors)
 8597              self._append_log(f"âŒ è·¯å¾„éªŒè¯å¤±è´¥ï¼Œæ— æ³•ä¿å­˜é…ç½®:\n{error_msg}")
 8598              self._toast('è·¯å¾„éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®', 'danger')
 8599              return
 8600          
 8601          # v2.2.0 æ–°å¢ï¼šéªŒè¯FTPé…ç½®ï¼ˆå¦‚æœä½¿ç”¨FTPåè®®ï¼‰
 8602          if self.current_protocol != 'smb':
 8603              is_valid, errors = self._validate_ftp_config()
 8604              if not is_valid:
 8605                  error_msg = "\n".join(errors)
 8606                  self._append_log(f"âŒ FTPé…ç½®éªŒè¯å¤±è´¥ï¼Œæ— æ³•ä¿å­˜é…ç½®:\n{error_msg}")
 8607                  self._toast('FTPé…ç½®éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®', 'danger')
 8608                  return
 8609          
 8610          # ä¿ç•™ç°æœ‰ç”¨æˆ·å¯†ç 
 8611          path = self.app_dir / 'config.json'
 8612          users = {}
 8613          if path.exists():
 8614              try:
 8615                  with open(path, 'r', encoding='utf-8') as f:
 8616                      old_cfg = json.load(f)
 8617                      users = old_cfg.get('users', {})
 8618              except Exception:
 8619                  pass
 8620          
 8621          # ç­–ç•¥æ˜ å°„
 8622          strategy_map = {'è·³è¿‡': 'skip', 'é‡å‘½å': 'rename', 'è¦†ç›–': 'overwrite', 'è¯¢é—®': 'ask'}
 8623          
 8624          cfg = {
 8625              'source_folder': self.src_edit.text(),
 8626              'target_folder': self.tgt_edit.text(),
 8627              'backup_folder': self.bak_edit.text(),
 8628              'enable_backup': self.cb_enable_backup.isChecked(),  # v2.1.1 æ–°å¢
 8629              'upload_interval': self.spin_interval.value(),
 8630              'monitor_mode': 'periodic',
 8631              'disk_threshold_percent': self.spin_disk.value(),
 8632              'retry_count': self.spin_retry.value(),
 8633              'disk_check_interval': self.spin_disk_check.value(),
 8634              'filter_jpg': self.cb_ext['.jpg'].isChecked(),
 8635              'filter_png': self.cb_ext['.png'].isChecked(),
 8636              'filter_bmp': self.cb_ext['.bmp'].isChecked(),
 8637              'filter_tiff': self.cb_ext['.tiff'].isChecked(),
 8638              'filter_gif': self.cb_ext['.gif'].isChecked(),
 8639              'filter_raw': self.cb_ext['.raw'].isChecked(),
 8640              'auto_start_windows': self.cb_auto_start_windows.isChecked(),
 8641              'auto_run_on_startup': self.cb_auto_run_on_startup.isChecked(),

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 175 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 8642              # v2.2.0 æ–°å¢ï¼šæ‰˜ç›˜é€šçŸ¥å¼€å…³
 8643              'show_notifications': self.cb_show_notifications.isChecked() if hasattr(self, 'cb_show_notifications') else True,
 8644              # v2.3.0 æ–°å¢ï¼šé€Ÿç‡é™åˆ¶
 8645              'limit_upload_rate': self.cb_limit_rate.isChecked() if hasattr(self, 'cb_limit_rate') else False,
 8646              'max_upload_rate_mbps': self.spin_max_rate.value() if hasattr(self, 'spin_max_rate') else 10.0,
 8647              # v1.9 æ–°å¢ï¼šå»é‡
 8648              'enable_deduplication': self.cb_dedup_enable.isChecked(),
 8649              'hash_algorithm': self.combo_hash.currentText().lower(),
 8650              'duplicate_strategy': strategy_map.get(self.combo_strategy.currentText(), 'ask'),
 8651              # v1.9 æ–°å¢ï¼šç½‘ç»œç›‘æ§
 8652              'network_check_interval': self.spin_network_check.value(),
 8653              'network_auto_pause': self.cb_network_auto_pause.isChecked(),
 8654              'network_auto_resume': self.cb_network_auto_resume.isChecked(),
 8655              # v1.9 æ–°å¢ï¼šè‡ªåŠ¨åˆ é™¤
 8656              'enable_auto_delete': self.enable_auto_delete,
 8657              'auto_delete_folder': self.auto_delete_folder,
 8658              'auto_delete_threshold': self.auto_delete_threshold,
 8659              'auto_delete_keep_days': self.auto_delete_keep_days,
 8660              'auto_delete_check_interval': self.auto_delete_check_interval,
 8661              # v2.0 æ–°å¢ï¼šFTP åè®®é…ç½®
 8662              'upload_protocol': self.current_protocol,
 8663              # v2.2.0 æ–°å¢ï¼šä¿å­˜å½“å‰ä½¿ç”¨çš„åè®®æ¨¡å¼
 8664              'current_protocol': self.current_protocol,
 8665              'ftp_server': {
 8666                  'host': self.ftp_server_host.text(),
 8667                  'port': self.ftp_server_port.value(),
 8668                  'username': self.ftp_server_user.text(),
 8669                  'password': self.ftp_server_pass.text(),
 8670                  'shared_folder': self.ftp_server_share.text(),
 8671                  'enable_passive': self.cb_server_passive.isChecked(),
 8672                  'passive_ports_start': self.ftp_server_passive_start.value(),
 8673                  'passive_ports_end': self.ftp_server_passive_end.value(),
 8674                  'enable_tls': self.cb_server_tls.isChecked(),
 8675                  'max_connections': self.ftp_server_max_conn.value(),
 8676                  'max_connections_per_ip': self.ftp_server_max_conn_per_ip.value(),
 8677              },
 8678              'ftp_client': {
 8679                  'host': self.ftp_client_host.text(),
 8680                  'port': self.ftp_client_port.value(),
 8681                  'username': self.ftp_client_user.text(),
 8682                  'password': self.ftp_client_pass.text(),
 8683                  'remote_path': self.ftp_client_remote.text(),
 8684                  'timeout': self.ftp_client_timeout.value(),
 8685                  'retry_count': self.ftp_client_retry.value(),
 8686                  'passive_mode': self.cb_client_passive.isChecked(),
 8687                  'enable_tls': self.cb_client_tls.isChecked(),
 8688              },
 8689              'users': users,
 8690          }
 8691          try:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 176 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 8692              with open(path, 'w', encoding='utf-8') as f:
 8693                  json.dump(cfg, f, indent=2, ensure_ascii=False)
 8694              
 8695              # ä¿å­˜æˆåŠŸåæ¸…é™¤ä¿®æ”¹æ ‡è®°å¹¶æ›´æ–°ä¿å­˜çš„é…ç½®
 8696              self.config_modified = False
 8697              self.saved_config = cfg.copy()
 8698              
 8699              self._append_log("âœ“ é…ç½®å·²æˆåŠŸä¿å­˜åˆ°æ–‡ä»¶")
 8700              self._toast('é…ç½®å·²ä¿å­˜', 'success')
 8701          except Exception as e:
 8702              self._append_log(f"âŒ é…ç½®ä¿å­˜å¤±è´¥: {e}")
 8703              self._toast(f'ä¿å­˜å¤±è´¥: {e}', 'danger')
 8704  
 8705      def _load_config(self):
 8706          """ä»é…ç½®æ–‡ä»¶åŠ è½½è®¾ç½®"""
 8707          self._append_log("ğŸ“– æ­£åœ¨åŠ è½½é…ç½®æ–‡ä»¶...")
 8708          
 8709          path = self.app_dir / 'config.json'
 8710          if not path.exists():
 8711              self._append_log("âš  é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®")
 8712              return
 8713          try:
 8714              with open(path, 'r', encoding='utf-8') as f:
 8715                  cfg = json.load(f)
 8716              
 8717              self._append_log(f"âœ“ é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸ")
 8718              
 8719              self.src_edit.setText(cfg.get('source_folder', ''))
 8720              self.tgt_edit.setText(cfg.get('target_folder', ''))
 8721              self.bak_edit.setText(cfg.get('backup_folder', ''))
 8722              
 8723              # v2.1.1 æ–°å¢ï¼šåŠ è½½å¤‡ä»½å¯ç”¨çŠ¶æ€
 8724              self.enable_backup = cfg.get('enable_backup', True)
 8725              self.cb_enable_backup.blockSignals(True)
 8726              self.cb_enable_backup.setChecked(self.enable_backup)
 8727              self.cb_enable_backup.blockSignals(False)
 8728              
 8729              self.spin_interval.setValue(int(cfg.get('upload_interval', 30)))
 8730              self.spin_disk.setValue(int(cfg.get('disk_threshold_percent', 10)))
 8731              self.spin_retry.setValue(int(cfg.get('retry_count', 3)))
 8732              self.spin_disk_check.setValue(int(cfg.get('disk_check_interval', 5)))
 8733              self.disk_check_interval = int(cfg.get('disk_check_interval', 5))
 8734              self.cb_ext['.jpg'].setChecked(cfg.get('filter_jpg', True))
 8735              self.cb_ext['.png'].setChecked(cfg.get('filter_png', True))
 8736              self.cb_ext['.bmp'].setChecked(cfg.get('filter_bmp', True))
 8737              self.cb_ext['.tiff'].setChecked(cfg.get('filter_tiff', True))
 8738              self.cb_ext['.gif'].setChecked(cfg.get('filter_gif', True))
 8739              self.cb_ext['.raw'].setChecked(cfg.get('filter_raw', True))
 8740              
 8741              # åŠ è½½é«˜çº§é€‰é¡¹

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 177 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 8742              self.auto_start_windows = cfg.get('auto_start_windows', False)
 8743              self.auto_run_on_startup = cfg.get('auto_run_on_startup', False)
 8744              # ä»æ³¨å†Œè¡¨æ£€æŸ¥å®é™…çš„å¼€æœºè‡ªå¯çŠ¶æ€
 8745              actual_startup = self._check_startup_status()
 8746              self.cb_auto_start_windows.blockSignals(True)
 8747              self.cb_auto_start_windows.setChecked(actual_startup)
 8748              self.cb_auto_start_windows.blockSignals(False)
 8749              self.cb_auto_run_on_startup.setChecked(self.auto_run_on_startup)
 8750              
 8751              # v2.2.0 æ–°å¢ï¼šåŠ è½½æ‰˜ç›˜é€šçŸ¥å¼€å…³
 8752              self.show_notifications = cfg.get('show_notifications', True)
 8753              if hasattr(self, 'cb_show_notifications'):
 8754                  self.cb_show_notifications.blockSignals(True)
 8755                  self.cb_show_notifications.setChecked(self.show_notifications)
 8756                  self.cb_show_notifications.blockSignals(False)
 8757                  self._set_checkbox_mark(self.cb_show_notifications, self.show_notifications)
 8758              
 8759              # v2.3.0 æ–°å¢ï¼šåŠ è½½é€Ÿç‡é™åˆ¶é…ç½®
 8760              self.limit_upload_rate = cfg.get('limit_upload_rate', False)
 8761              self.max_upload_rate_mbps = cfg.get('max_upload_rate_mbps', 10.0)
 8762              if hasattr(self, 'cb_limit_rate'):
 8763                  self.cb_limit_rate.blockSignals(True)
 8764                  self.cb_limit_rate.setChecked(self.limit_upload_rate)
 8765                  self.cb_limit_rate.blockSignals(False)
 8766                  self._set_checkbox_mark(self.cb_limit_rate, self.limit_upload_rate)
 8767                  self.spin_max_rate.setValue(self.max_upload_rate_mbps)
 8768                  self.spin_max_rate.setEnabled(self.limit_upload_rate)
 8769              
 8770              # v1.9 æ–°å¢ï¼šåŠ è½½å»é‡é…ç½®
 8771              self.enable_deduplication = cfg.get('enable_deduplication', False)
 8772              self.hash_algorithm = cfg.get('hash_algorithm', 'md5')
 8773              self.duplicate_strategy = cfg.get('duplicate_strategy', 'ask')
 8774              
 8775              self.cb_dedup_enable.blockSignals(True)
 8776              self.cb_dedup_enable.setChecked(self.enable_deduplication)
 8777              self.cb_dedup_enable.blockSignals(False)
 8778              
 8779              # æ˜ å°„ç­–ç•¥æ–‡æœ¬
 8780              strategy_text_map = {'skip': 'è·³è¿‡', 'rename': 'é‡å‘½å', 'overwrite': 'è¦†ç›–', 'ask': 'è¯¢é—®'}
 8781              hash_text = self.hash_algorithm.upper()
 8782              strategy_text = strategy_text_map.get(self.duplicate_strategy, 'è¯¢é—®')
 8783              
 8784              self.combo_hash.setCurrentText(hash_text)
 8785              self.combo_strategy.setCurrentText(strategy_text)
 8786              
 8787              # æ ¹æ®å»é‡å¼€å…³çŠ¶æ€å¯ç”¨/ç¦ç”¨å­é€‰é¡¹
 8788              self.combo_hash.setEnabled(self.enable_deduplication)
 8789              self.combo_strategy.setEnabled(self.enable_deduplication)
 8790              
 8791              # v1.9 æ–°å¢ï¼šåŠ è½½ç½‘ç»œç›‘æ§é…ç½®

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 178 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 8792              self.network_check_interval = cfg.get('network_check_interval', 10)
 8793              self.network_auto_pause = cfg.get('network_auto_pause', True)
 8794              self.network_auto_resume = cfg.get('network_auto_resume', True)
 8795              
 8796              self.spin_network_check.setValue(self.network_check_interval)
 8797              self.cb_network_auto_pause.setChecked(self.network_auto_pause)
 8798              self.cb_network_auto_resume.setChecked(self.network_auto_resume)
 8799              
 8800              # v1.9 æ–°å¢ï¼šåŠ è½½è‡ªåŠ¨åˆ é™¤é…ç½®
 8801              self.enable_auto_delete = cfg.get('enable_auto_delete', False)
 8802              self.auto_delete_folder = cfg.get('auto_delete_folder', '')
 8803              self.auto_delete_threshold = cfg.get('auto_delete_threshold', 80)
 8804              self.auto_delete_keep_days = cfg.get('auto_delete_keep_days', 10)
 8805              self.auto_delete_check_interval = cfg.get('auto_delete_check_interval', 300)
 8806              
 8807              # è¿™äº›æ§ä»¶åœ¨ç£ç›˜æ¸…ç†å¯¹è¯æ¡†ä¸­ï¼Œä¸»çª—å£å¯èƒ½æ²¡æœ‰
 8808              if hasattr(self, 'cb_enable_auto_delete'):
 8809                  self.cb_enable_auto_delete.blockSignals(True)
 8810                  self.cb_enable_auto_delete.setChecked(self.enable_auto_delete)
 8811                  self.cb_enable_auto_delete.blockSignals(False)
 8812              
 8813              if hasattr(self, 'auto_del_folder_edit'):
 8814                  self.auto_del_folder_edit.setText(self.auto_delete_folder)
 8815                  self.auto_del_folder_edit.setEnabled(self.enable_auto_delete)
 8816              if hasattr(self, 'btn_choose_auto_del'):
 8817                  self.btn_choose_auto_del.setEnabled(self.enable_auto_delete)
 8818              if hasattr(self, 'spin_auto_del_threshold'):
 8819                  self.spin_auto_del_threshold.setValue(self.auto_delete_threshold)
 8820                  self.spin_auto_del_threshold.setEnabled(self.enable_auto_delete)
 8821              if hasattr(self, 'spin_auto_del_keep_days'):
 8822                  self.spin_auto_del_keep_days.setValue(self.auto_delete_keep_days)
 8823                  self.spin_auto_del_keep_days.setEnabled(self.enable_auto_delete)
 8824              if hasattr(self, 'spin_auto_del_interval'):
 8825                  self.spin_auto_del_interval.setValue(self.auto_delete_check_interval)
 8826                  self.spin_auto_del_interval.setEnabled(self.enable_auto_delete)
 8827              
 8828              # v2.0 æ–°å¢ï¼šåŠ è½½åè®®é…ç½®
 8829              protocol = cfg.get('upload_protocol', 'smb')
 8830              protocol_map = {
 8831                  'smb': 0,
 8832                  'ftp_server': 1,
 8833                  'ftp_client': 2,
 8834                  'both': 3
 8835              }
 8836              self.combo_protocol.setCurrentIndex(protocol_map.get(protocol, 0))
 8837              
 8838              # v2.2.0 æ–°å¢ï¼šåŠ è½½ä¸Šæ¬¡ä½¿ç”¨çš„åè®®æ¨¡å¼
 8839              saved_protocol = cfg.get('current_protocol', protocol)
 8840              self.current_protocol = saved_protocol
 8841              self._append_log(f"âœ“ å·²åŠ è½½ä¸Šæ¬¡åè®®æ¨¡å¼: {saved_protocol}")

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 179 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 8842              # æ›´æ–°åè®®çŠ¶æ€æ˜¾ç¤º
 8843              self._update_protocol_status()
 8844              
 8845              # åŠ è½½ FTP æœåŠ¡å™¨é…ç½®
 8846              ftp_server = cfg.get('ftp_server', {})
 8847              self.ftp_server_host.setText(ftp_server.get('host', '0.0.0.0'))
 8848              self.ftp_server_port.setValue(ftp_server.get('port', 2121))
 8849              self.ftp_server_user.setText(ftp_server.get('username', 'upload_user'))
 8850              self.ftp_server_pass.setText(ftp_server.get('password', 'upload_pass'))
 8851              self.ftp_server_share.setText(ftp_server.get('shared_folder', ''))
 8852              # v2.0 æ–°å¢ï¼šåŠ è½½é«˜çº§é€‰é¡¹
 8853              self.cb_server_passive.setChecked(ftp_server.get('enable_passive', True))
 8854              self.ftp_server_passive_start.setValue(ftp_server.get('passive_ports_start', 60000))
 8855              self.ftp_server_passive_end.setValue(ftp_server.get('passive_ports_end', 65535))
 8856              self.cb_server_tls.setChecked(ftp_server.get('enable_tls', False))
 8857              self.ftp_server_max_conn.setValue(ftp_server.get('max_connections', 256))
 8858              self.ftp_server_max_conn_per_ip.setValue(ftp_server.get('max_connections_per_ip', 5))
 8859              
 8860              # åŠ è½½ FTP å®¢æˆ·ç«¯é…ç½®
 8861              ftp_client = cfg.get('ftp_client', {})
 8862              self.ftp_client_host.setText(ftp_client.get('host', ''))
 8863              self.ftp_client_port.setValue(ftp_client.get('port', 21))
 8864              self.ftp_client_user.setText(ftp_client.get('username', ''))
 8865              self.ftp_client_pass.setText(ftp_client.get('password', ''))
 8866              self.ftp_client_remote.setText(ftp_client.get('remote_path', '/upload'))
 8867              self.ftp_client_timeout.setValue(ftp_client.get('timeout', 30))
 8868              self.ftp_client_retry.setValue(ftp_client.get('retry_count', 3))
 8869              # v2.0 æ–°å¢ï¼šåŠ è½½é«˜çº§é€‰é¡¹
 8870              self.cb_client_passive.setChecked(ftp_client.get('passive_mode', True))
 8871              self.cb_client_tls.setChecked(ftp_client.get('enable_tls', False))
 8872              
 8873              # ä¿å­˜å·²åŠ è½½çš„é…ç½®ï¼ˆç”¨äºå›é€€ï¼‰
 8874              self.saved_config = cfg.copy()
 8875              self.config_modified = False
 8876              
 8877              self._append_log(f"âœ“ å·²åŠ è½½é…ç½®: æº={cfg.get('source_folder', 'æœªè®¾ç½®')}")
 8878              self._append_log(f"âœ“ å·²åŠ è½½é…ç½®: ç›®æ ‡={cfg.get('target_folder', 'æœªè®¾ç½®')}")
 8879              self._append_log(f"âœ“ å·²åŠ è½½é…ç½®: å¤‡ä»½={cfg.get('backup_folder', 'æœªè®¾ç½®')}")
 8880          except Exception as e:
 8881              self._append_log(f"âŒ åŠ è½½é…ç½®å¤±è´¥: {e}")
 8882  
 8883      def _on_start(self):
 8884          """å¼€å§‹ä¸Šä¼ """
 8885          self._append_log("=" * 50)
 8886          self._append_log("ğŸš€ å‡†å¤‡å¼€å§‹ä¸Šä¼ ä»»åŠ¡...")
 8887          
 8888          # 1. éªŒè¯è·¯å¾„æ˜¯å¦å­˜åœ¨
 8889          is_valid, errors = self._validate_paths()
 8890          if not is_valid:
 8891              error_msg = "\n".join(errors)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 180 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 8892              self._append_log(f"âŒ è·¯å¾„éªŒè¯å¤±è´¥:\n{error_msg}")
 8893              
 8894              # å¼¹çª—æ˜¾ç¤ºé”™è¯¯
 8895              msg_box = QtWidgets.QMessageBox(self)
 8896              msg_box.setIcon(QtWidgets.QMessageBox.Icon.Critical)
 8897              msg_box.setWindowTitle("è·¯å¾„éªŒè¯å¤±è´¥")
 8898              msg_box.setText("æ–‡ä»¶å¤¹è·¯å¾„é…ç½®æœ‰è¯¯ï¼Œæ— æ³•å¼€å§‹ä¸Šä¼ ï¼")
 8899              msg_box.setDetailedText(error_msg)
 8900              msg_box.setStandardButtons(QtWidgets.QMessageBox.StandardButton.Ok)
 8901              msg_box.exec() if hasattr(msg_box, 'exec') else msg_box.exec_()
 8902              
 8903              self._toast('è·¯å¾„éªŒè¯å¤±è´¥ï¼Œæ— æ³•å¼€å§‹ä¸Šä¼ ', 'danger')
 8904              return
 8905          
 8906          # v2.0 æ–°å¢ï¼šéªŒè¯FTPé…ç½®ï¼ˆå¦‚æœä½¿ç”¨FTPåè®®ï¼‰
 8907          if self.current_protocol != 'smb':
 8908              is_valid, errors = self._validate_ftp_config()
 8909              if not is_valid:
 8910                  error_msg = "\n".join(errors)
 8911                  self._append_log(f"âŒ FTPé…ç½®éªŒè¯å¤±è´¥:\n{error_msg}")
 8912                  
 8913                  # å¼¹çª—æ˜¾ç¤ºé”™è¯¯
 8914                  msg_box = QtWidgets.QMessageBox(self)
 8915                  msg_box.setIcon(QtWidgets.QMessageBox.Icon.Critical)
 8916                  msg_box.setWindowTitle("FTPé…ç½®éªŒè¯å¤±è´¥")
 8917                  msg_box.setText("FTPé…ç½®æœ‰è¯¯ï¼Œæ— æ³•å¼€å§‹ä¸Šä¼ ï¼")
 8918                  msg_box.setDetailedText(error_msg)
 8919                  msg_box.setStandardButtons(QtWidgets.QMessageBox.StandardButton.Ok)
 8920                  msg_box.exec() if hasattr(msg_box, 'exec') else msg_box.exec_()
 8921                  
 8922                  self._toast('FTPé…ç½®éªŒè¯å¤±è´¥', 'danger')
 8923                  return
 8924          
 8925          # 2. æ£€æŸ¥é…ç½®æ˜¯å¦è¢«ä¿®æ”¹ä½†æœªä¿å­˜
 8926          if self.config_modified:
 8927              self._append_log("âš  æ£€æµ‹åˆ°é…ç½®å·²ä¿®æ”¹ä½†æœªä¿å­˜")
 8928              
 8929              # v2.2.0 æƒé™æ£€æŸ¥ï¼šæœªç™»å½•ç”¨æˆ·æ— æƒä¿å­˜é…ç½®ï¼Œç›´æ¥æ¢å¤å·²ä¿å­˜é…ç½®
 8930              if self.current_role == 'guest':
 8931                  self._append_log("âš  æœªç™»å½•ç”¨æˆ·æ— æƒä¿å­˜é…ç½®ï¼Œè‡ªåŠ¨æ¢å¤å·²ä¿å­˜çš„é…ç½®")
 8932                  if self.saved_config:
 8933                      self.src_edit.setText(self.saved_config.get('source_folder', ''))
 8934                      self.tgt_edit.setText(self.saved_config.get('target_folder', ''))
 8935                      self.bak_edit.setText(self.saved_config.get('backup_folder', ''))
 8936                      self.config_modified = False
 8937                      self._append_log("âœ“ é…ç½®å·²æ¢å¤åˆ°å·²ä¿å­˜çŠ¶æ€")
 8938                      
 8939                      # é‡æ–°éªŒè¯è·¯å¾„
 8940                      is_valid, errors = self._validate_paths()
 8941                      if not is_valid:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 181 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 8942                          error_msg = "\n".join(errors)
 8943                          self._append_log(f"âŒ å·²ä¿å­˜çš„é…ç½®è·¯å¾„éªŒè¯å¤±è´¥:\n{error_msg}")
 8944                          self._toast('é…ç½®è·¯å¾„æ— æ•ˆï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'danger')
 8945                          return
 8946                  else:
 8947                      self._append_log("âŒ æœªæ‰¾åˆ°å·²ä¿å­˜çš„é…ç½®")
 8948                      self._toast('æ— å¯ç”¨é…ç½®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'danger')
 8949                      return
 8950              else:
 8951                  # ç™»å½•ç”¨æˆ·ï¼šè¯¢é—®æ˜¯å¦ä¿å­˜é…ç½®
 8952                  msg_box = QtWidgets.QMessageBox(self)
 8953                  msg_box.setIcon(QtWidgets.QMessageBox.Icon.Question)
 8954                  msg_box.setWindowTitle("é…ç½®æœªä¿å­˜")
 8955                  msg_box.setText("æ£€æµ‹åˆ°è·¯å¾„é…ç½®å·²ä¿®æ”¹ä½†æœªä¿å­˜ï¼")
 8956                  msg_box.setInformativeText('æ˜¯å¦ä¿å­˜å½“å‰é…ç½®å¹¶ä½¿ç”¨æ–°è·¯å¾„ä¸Šä¼ ï¼Ÿ\n\né€‰æ‹©"æ˜¯"ï¼šä¿å­˜é…ç½®å¹¶ä½¿ç”¨æ–°è·¯å¾„\né€‰æ‹©"å¦"ï¼šæ”¾å¼ƒä¿®æ”¹ï¼Œä½¿ç”¨å·²ä¿å­˜çš„è·¯å¾„')
 8957                  msg_box.setStandardButtons(
 8958                      QtWidgets.QMessageBox.StandardButton.Yes | 
 8959                      QtWidgets.QMessageBox.StandardButton.No |
 8960                      QtWidgets.QMessageBox.StandardButton.Cancel
 8961                  )
 8962                  msg_box.setDefaultButton(QtWidgets.QMessageBox.StandardButton.Yes)
 8963                  
 8964                  result = msg_box.exec() if hasattr(msg_box, 'exec') else msg_box.exec_()
 8965                  
 8966                  if result == QtWidgets.QMessageBox.StandardButton.Yes:
 8967                      # ä¿å­˜é…ç½®
 8968                      self._append_log("âœ“ ç”¨æˆ·é€‰æ‹©ä¿å­˜é…ç½®")
 8969                      self._save_config()
 8970                  elif result == QtWidgets.QMessageBox.StandardButton.No:
 8971                      # å›é€€åˆ°ä¿å­˜çš„é…ç½®
 8972                      self._append_log("âš  ç”¨æˆ·é€‰æ‹©æ”¾å¼ƒä¿®æ”¹ï¼Œæ¢å¤å·²ä¿å­˜çš„é…ç½®")
 8973                      if self.saved_config:
 8974                          self.src_edit.setText(self.saved_config.get('source_folder', ''))
 8975                          self.tgt_edit.setText(self.saved_config.get('target_folder', ''))
 8976                          self.bak_edit.setText(self.saved_config.get('backup_folder', ''))
 8977                          self.config_modified = False
 8978                          self._append_log("âœ“ é…ç½®å·²æ¢å¤")
 8979                          
 8980                          # é‡æ–°éªŒè¯è·¯å¾„
 8981                          is_valid, errors = self._validate_paths()
 8982                          if not is_valid:
 8983                              error_msg = "\n".join(errors)
 8984                              self._append_log(f"âŒ æ¢å¤çš„é…ç½®è·¯å¾„éªŒè¯å¤±è´¥:\n{error_msg}")
 8985                              self._toast('å·²ä¿å­˜çš„é…ç½®è·¯å¾„æ— æ•ˆ', 'danger')
 8986                              return
 8987                  else:
 8988                      # å–æ¶ˆ
 8989                      self._append_log("âœ— ç”¨æˆ·å–æ¶ˆå¼€å§‹ä¸Šä¼ ")
 8990                      return
 8991          

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 182 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 8992          self._append_log("âœ“ é…ç½®éªŒè¯é€šè¿‡ï¼Œå¼€å§‹å¯åŠ¨ä¸Šä¼ ä»»åŠ¡...")
 8993          
 8994          self.is_running = True
 8995          self.is_paused = False
 8996          self.start_time = time.time()
 8997          self._update_status_pill()
 8998          
 8999          # v2.2.0 é‡æ„ï¼šä½¿ç”¨ç»Ÿä¸€æƒé™ç³»ç»Ÿæ›´æ–°æ‰€æœ‰æ§ä»¶çŠ¶æ€
 9000          self._update_ui_permissions()
 9001          
 9002          self._append_log(f"ğŸ“‹ ä¸Šä¼ é…ç½®:")
 9003          self._append_log(f"  æºæ–‡ä»¶å¤¹: {self.src_edit.text()}")
 9004          self._append_log(f"  ç›®æ ‡æ–‡ä»¶å¤¹: {self.tgt_edit.text()}")
 9005          # v2.1.1 ä¿®æ”¹ï¼šæ ¹æ®å¤‡ä»½å¯ç”¨çŠ¶æ€æ˜¾ç¤ºä¸åŒä¿¡æ¯
 9006          if self.enable_backup:
 9007              self._append_log(f"  å¤‡ä»½æ–‡ä»¶å¤¹: {self.bak_edit.text()}")
 9008          else:
 9009              self._append_log(f"  å¤‡ä»½åŠŸèƒ½: å·²ç¦ç”¨ï¼ˆä¸Šä¼ æˆåŠŸåå°†åˆ é™¤æºæ–‡ä»¶ï¼‰")
 9010              self._append_log(f"  é—´éš”æ—¶é—´: {self.spin_interval.value()}ç§’")
 9011              self._append_log(f"  é‡è¯•æ¬¡æ•°: {self.spin_retry.value()}æ¬¡")
 9012          
 9013              filters = [ext for ext, cb in self.cb_ext.items() if cb.isChecked()]
 9014              self._append_log(f"  æ–‡ä»¶ç±»å‹: {', '.join(filters)}")
 9015              self._append_log(f"  ä¸Šä¼ åè®®: {self.current_protocol}")
 9016          
 9017          # v2.0 æ–°å¢ï¼šå¯åŠ¨FTPæœåŠ¡å™¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
 9018          if self.current_protocol in ['ftp_server', 'both']:
 9019              try:
 9020                  if not self.ftp_manager:
 9021                      self.ftp_manager = FTPProtocolManager()  # type: ignore[misc]
 9022                  
 9023                  self._append_log("ğŸ”§ æ­£åœ¨å¯åŠ¨FTPæœåŠ¡å™¨...")
 9024                  share_folder = self.ftp_server_config.get('shared_folder', '')
 9025                  if not share_folder or not os.path.exists(share_folder):
 9026                      raise ValueError(f"FTPå…±äº«æ–‡ä»¶å¤¹æ— æ•ˆ: {share_folder}")
 9027                  
 9028                  server_config = {
 9029                      'host': self.ftp_server_config.get('host', '0.0.0.0'),
 9030                      'port': self.ftp_server_config.get('port', 2121),
 9031                      'username': self.ftp_server_config.get('username', 'upload_user'),
 9032                      'password': self.ftp_server_config.get('password', 'upload_pass'),
 9033                      'shared_folder': share_folder
 9034                  }
 9035                  
 9036                  success = self.ftp_manager.start_server(server_config)
 9037                  if not success:
 9038                      raise RuntimeError("FTPæœåŠ¡å™¨å¯åŠ¨å¤±è´¥")
 9039                  
 9040                  server_status = self.ftp_manager.get_status()
 9041                  if server_status.get('server'):

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 183 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 9042                      srv = server_status['server']
 9043                      self._append_log(f"âœ“ FTPæœåŠ¡å™¨å·²å¯åŠ¨:")
 9044                      self._append_log(f"  åœ°å€: {srv['host']}:{srv['port']}")
 9045                      self._append_log(f"  å…±äº«: {srv['shared_folder']}")
 9046                  else:
 9047                      self._append_log(f"âœ“ FTPæœåŠ¡å™¨å·²å¯åŠ¨")
 9048                  
 9049                  # v2.0 æ–°å¢ï¼šæ›´æ–°FTPçŠ¶æ€æ˜¾ç¤º
 9050                  self._update_protocol_status()
 9051              except ValueError as e:
 9052                  # v2.0 å¢å¼ºï¼šé…ç½®é”™è¯¯è¯¦ç»†æ—¥å¿—
 9053                  self._append_log(f"âŒ [FTP-CONFIG] é…ç½®é”™è¯¯: {e}")
 9054                  self._toast(f'FTPé…ç½®é”™è¯¯: {e}', 'danger')
 9055                  # v2.2.0 ä¿®å¤ï¼šä½¿ç”¨ç»Ÿä¸€æƒé™ç³»ç»Ÿæ¢å¤UI
 9056                  self.is_running = False
 9057                  self._update_status_pill()
 9058                  self._update_ui_permissions()
 9059                  return
 9060              except OSError as e:
 9061                  # v2.0 å¢å¼ºï¼šç«¯å£å†²çªç­‰ç³»ç»Ÿé”™è¯¯è¯¦ç»†æ—¥å¿—
 9062                  error_msg = str(e)
 9063                  if 'already in use' in error_msg.lower() or 'address already in use' in error_msg.lower():
 9064                      port = self.ftp_server_config.get('port', 2121)
 9065                      self._append_log(f"âŒ [FTP-PORT] ç«¯å£ {port} å·²è¢«å ç”¨ï¼Œè¯·æ›´æ¢ç«¯å£")
 9066                  else:
 9067                      self._append_log(f"âŒ [FTP-OS] ç³»ç»Ÿé”™è¯¯: {e}")
 9068                  self._toast(f'FTPæœåŠ¡å™¨å¯åŠ¨å¤±è´¥: {e}', 'danger')
 9069                  # v2.2.0 ä¿®å¤ï¼šä½¿ç”¨ç»Ÿä¸€æƒé™ç³»ç»Ÿæ¢å¤UI
 9070                  self.is_running = False
 9071                  self._update_status_pill()
 9072                  self._update_ui_permissions()
 9073                  return
 9074              except Exception as e:
 9075                  # v2.0 å¢å¼ºï¼šå…¶ä»–é”™è¯¯è¯¦ç»†æ—¥å¿—
 9076                  error_type = type(e).__name__
 9077                  self._append_log(f"âŒ [FTP-{error_type}] FTPæœåŠ¡å™¨å¯åŠ¨å¤±è´¥: {e}")
 9078                  self._toast(f'FTPæœåŠ¡å™¨å¯åŠ¨å¤±è´¥: {e}', 'danger')
 9079                  # v2.2.0 ä¿®å¤ï¼šä½¿ç”¨ç»Ÿä¸€æƒé™ç³»ç»Ÿæ¢å¤UI
 9080                  self.is_running = False
 9081                  self._update_status_pill()
 9082                  self._update_ui_permissions()
 9083                  return
 9084          
 9085          # è·å–å»é‡ç­–ç•¥æ˜ å°„
 9086          strategy_map = {'è·³è¿‡': 'skip', 'é‡å‘½å': 'rename', 'è¦†ç›–': 'overwrite', 'è¯¢é—®': 'ask'}
 9087          duplicate_strategy = strategy_map.get(self.combo_strategy.currentText(), 'ask')
 9088          
 9089          # v2.0 æ–°å¢ï¼šæ›´æ–°FTPå®¢æˆ·ç«¯é…ç½®
 9090          if self.current_protocol in ['ftp_client', 'both']:
 9091              self.ftp_client_config = {

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 184 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 9092                  'host': self.ftp_client_host.text(),
 9093                  'port': self.ftp_client_port.value(),
 9094                  'username': self.ftp_client_user.text(),
 9095                  'password': self.ftp_client_pass.text(),
 9096                  'remote_path': self.ftp_client_remote.text(),
 9097                  'timeout': self.ftp_client_timeout.value(),
 9098                  'retry_count': self.ftp_client_retry.value(),
 9099              }
 9100              self._append_log(f"ğŸ“¡ FTPå®¢æˆ·ç«¯é…ç½®: {self.ftp_client_config['host']}:{self.ftp_client_config['port']}")
 9101              self._append_log(f"  è¶…æ—¶æ—¶é—´: {self.ftp_client_config['timeout']}ç§’, é‡è¯•æ¬¡æ•°: {self.ftp_client_config['retry_count']}æ¬¡")
 9102          
 9103          self.worker = UploadWorker(
 9104              self.src_edit.text(), self.tgt_edit.text(), self.bak_edit.text(),
 9105              self.spin_interval.value(), 'periodic', self.spin_disk.value(), self.spin_retry.value(), 
 9106              filters, self.app_dir,
 9107              self.cb_dedup_enable.isChecked(),
 9108              self.combo_hash.currentText().lower(),
 9109              duplicate_strategy,
 9110              self.spin_network_check.value(),
 9111              self.cb_network_auto_pause.isChecked(),
 9112              self.cb_network_auto_resume.isChecked(),
 9113              # v1.9 æ–°å¢ï¼šè‡ªåŠ¨åˆ é™¤å‚æ•°
 9114              self.enable_auto_delete,
 9115              self.auto_delete_folder,
 9116              self.auto_delete_threshold,
 9117              self.auto_delete_keep_days,
 9118              self.auto_delete_check_interval,
 9119              # v2.0 æ–°å¢ï¼šåè®®å‚æ•°
 9120              self.current_protocol,
 9121              self.ftp_client_config if self.current_protocol in ['ftp_client', 'both'] else None,
 9122              # v2.2.0 æ–°å¢ï¼šå¤‡ä»½å¯ç”¨çŠ¶æ€
 9123              self.enable_backup,
 9124              # v2.3.0 æ–°å¢ï¼šé€Ÿç‡é™åˆ¶å‚æ•°
 9125              self.cb_limit_rate.isChecked(),
 9126              self.spin_max_rate.value()
 9127          )
 9128          self.worker_thread = QtCore.QThread(self)
 9129          self.worker.moveToThread(self.worker_thread)
 9130          self.worker_thread.started.connect(self.worker.start)
 9131          # ä½¿ç”¨ Qt.QueuedConnection ç¡®ä¿ä¿¡å·å¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡ Worker çº¿ç¨‹
 9132          self.worker.log.connect(self._append_log, QtCore.Qt.ConnectionType.QueuedConnection)
 9133          self.worker.stats.connect(self._on_stats, QtCore.Qt.ConnectionType.QueuedConnection)
 9134          self.worker.progress.connect(self._on_progress, QtCore.Qt.ConnectionType.QueuedConnection)
 9135          self.worker.file_progress.connect(self._on_file_progress, QtCore.Qt.ConnectionType.QueuedConnection)
 9136          self.worker.network_status.connect(self._on_network_status, QtCore.Qt.ConnectionType.QueuedConnection)
 9137          self.worker.finished.connect(self._on_worker_finished, QtCore.Qt.ConnectionType.QueuedConnection)
 9138          self.worker.status.connect(self._on_worker_status, QtCore.Qt.ConnectionType.QueuedConnection)
 9139          self.worker.ask_user_duplicate.connect(self._on_ask_duplicate, QtCore.Qt.ConnectionType.QueuedConnection)
 9140          # v2.2.0 æ–°å¢ï¼šè¿æ¥é”™è¯¯é€šçŸ¥ä¿¡å·
 9141          self.worker.upload_error.connect(self._on_upload_error, QtCore.Qt.ConnectionType.QueuedConnection)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 185 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 9142          # v2.2.0 æ–°å¢ï¼šè¿æ¥ç£ç›˜ç©ºé—´è­¦å‘Šä¿¡å·
 9143          self.worker.disk_warning.connect(self._on_disk_warning, QtCore.Qt.ConnectionType.QueuedConnection)
 9144          self.worker_thread.start()
 9145          self._toast('å¼€å§‹ä¸Šä¼ ', 'success')
 9146          self._append_log("âœ“ ä¸Šä¼ ä»»åŠ¡å·²å¯åŠ¨")
 9147          
 9148          # v2.2.0 æ–°å¢ï¼šæ˜¾ç¤ºé€šçŸ¥
 9149          self._show_notification(
 9150              "ä¸Šä¼ å·²å¼€å§‹",
 9151              f"æ­£åœ¨ä¸Šä¼ æ–‡ä»¶åˆ°: {self.tgt_edit.text()}"
 9152          )
 9153          
 9154          # v2.2.0 è°ƒè¯•ï¼šæ‰“å°å¼€å§‹ä¸Šä¼ åçš„æŒ‰é’®çŠ¶æ€
 9155          self._append_log(f"   [å¼€å§‹ä¸Šä¼ åå¿«ç…§] æºæŒ‰é’®={self.btn_choose_src.isEnabled()}, ç›®æ ‡æŒ‰é’®={self.btn_choose_tgt.isEnabled()}, å¤‡ä»½æŒ‰é’®={self.btn_choose_bak.isEnabled()}")
 9156          self._append_log(f"   [å¼€å§‹ä¸Šä¼ åå¿«ç…§] å¼€å§‹æŒ‰é’®={self.btn_start.isEnabled()}, æš‚åœæŒ‰é’®={self.btn_pause.isEnabled()}, åœæ­¢æŒ‰é’®={self.btn_stop.isEnabled()}")
 9157  
 9158      def _on_pause_resume(self):
 9159          if not self.worker:
 9160              return
 9161          if self.is_paused:
 9162              # æ¢å¤ä¸Šä¼ 
 9163              self.is_paused = False
 9164              self.worker.resume()
 9165              self.btn_pause.setText("â¸ æš‚åœä¸Šä¼ ")
 9166              self._toast('å·²æ¢å¤', 'info')
 9167              # v2.2.0 ç³»ç»Ÿæ‰˜ç›˜é€šçŸ¥
 9168              self._show_notification(
 9169                  "ä¸Šä¼ å·²æ¢å¤",
 9170                  "ç»§ç»­ä¸Šä¼ ä»»åŠ¡..."
 9171              )
 9172          else:
 9173              # æš‚åœä¸Šä¼ 
 9174              self.is_paused = True
 9175              self.worker.pause()
 9176              self.btn_pause.setText("â–¶ æ¢å¤ä¸Šä¼ ")
 9177              self._toast('å·²æš‚åœ', 'warning')
 9178              # v2.2.0 ç³»ç»Ÿæ‰˜ç›˜é€šçŸ¥
 9179              self._show_notification(
 9180                  "ä¸Šä¼ å·²æš‚åœ",
 9181                  f"å·²ä¸Šä¼ : {self.uploaded}ä¸ªæ–‡ä»¶"
 9182              )
 9183          self._update_status_pill()
 9184  
 9185      def _on_stop(self):
 9186          """åœæ­¢ä¸Šä¼ """
 9187          self._append_log("ğŸ›‘ æ­£åœ¨åœæ­¢ä¸Šä¼ ä»»åŠ¡...")
 9188          
 9189          # v2.2.0 å…³é”®ä¿®å¤ï¼šç«‹å³è®¾ç½®è¿è¡ŒçŠ¶æ€ä¸ºFalse
 9190          self.is_running = False
 9191          self.is_paused = False

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 186 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 9192          
 9193          # v2.0 æ–°å¢ï¼šåœæ­¢FTPæœåŠ¡å™¨ï¼ˆå¦‚æœå¯åŠ¨äº†ï¼‰
 9194          if self.ftp_manager:
 9195              try:
 9196                  self._append_log("ğŸ”§ æ­£åœ¨åœæ­¢FTPæœåŠ¡...")
 9197                  self.ftp_manager.stop_all()
 9198                  self.ftp_manager = None
 9199                  self._append_log("âœ“ FTPæœåŠ¡å·²åœæ­¢")
 9200                  
 9201                  # v2.0 æ–°å¢ï¼šæ›´æ–°FTPçŠ¶æ€æ˜¾ç¤º
 9202                  self._update_protocol_status()
 9203              except Exception as e:
 9204                  self._append_log(f"âš ï¸ åœæ­¢FTPæœåŠ¡æ—¶å‡ºé”™: {e}")
 9205          
 9206          if not self.worker:
 9207              # æ²¡æœ‰Workerï¼Œç›´æ¥æ¢å¤UI
 9208              self._restore_ui_after_stop()
 9209              return
 9210          
 9211          self.worker.stop()
 9212          # ç«‹å³æ¢å¤UIï¼ˆä¸ç­‰å¾…çº¿ç¨‹å®Œå…¨é€€å‡ºï¼Œæå‡å“åº”é€Ÿåº¦ï¼‰
 9213          self._restore_ui_after_stop()
 9214  
 9215          # å¼‚æ­¥æ¸…ç†åå°çº¿ç¨‹ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
 9216          def _cleanup_worker_async():
 9217              try:
 9218                  if self.worker_thread:
 9219                      self.worker_thread.quit()
 9220                      if not self.worker_thread.wait(3000):
 9221                          self._append_log("âš ï¸ Workerçº¿ç¨‹æœªåœ¨é¢„æœŸæ—¶é—´å†…é€€å‡ºï¼Œå°è¯•å¼ºåˆ¶ç»ˆæ­¢")
 9222                          try:
 9223                              self.worker_thread.terminate()
 9224                              self.worker_thread.wait(1000)
 9225                          except Exception:
 9226                              pass
 9227              finally:
 9228                  self.worker = None
 9229                  self.worker_thread = None
 9230          
 9231          try:
 9232              QtCore.QTimer.singleShot(0, _cleanup_worker_async)
 9233          except Exception:
 9234              # å¦‚æœè®¡æ—¶å™¨ä¸å¯ç”¨ï¼Œç›´æ¥åœ¨å½“å‰çº¿ç¨‹åšä¸€æ¬¡å°½åŠ›æ¸…ç†ï¼ˆå¯èƒ½ä¼šé˜»å¡ç‰‡åˆ»ï¼‰
 9235              _cleanup_worker_async()
 9236      
 9237      def _restore_ui_after_stop(self):
 9238          """æ¢å¤åœæ­¢åçš„UIçŠ¶æ€"""
 9239          # v2.2.0 è°ƒè¯•ï¼šæ‰“å°è°ƒç”¨æ—¶çš„å‚æ•°çŠ¶æ€
 9240          self._append_log(f"   [åœæ­¢åæƒé™] å½“å‰è§’è‰²={self.current_role}, è¿è¡ŒçŠ¶æ€={self.is_running}, å¤‡ä»½å¯ç”¨={self.enable_backup}")
 9241          

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 187 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 9242          # v2.2.0 é‡æ„ï¼šç»Ÿä¸€ä½¿ç”¨æƒé™è®¡ç®—å‡½æ•°
 9243          states = self._compute_control_states(self.current_role, self.is_running, self.enable_backup)
 9244          
 9245          # v2.2.0 è°ƒè¯•ï¼šæ‰“å°åœæ­¢åçš„è®¡ç®—çŠ¶æ€
 9246          self._append_log(f"   [åœæ­¢åè®¡ç®—] æºæŒ‰é’®={states['btn_choose_src']}, ç›®æ ‡æŒ‰é’®={states['btn_choose_tgt']}, å¤‡ä»½æŒ‰é’®={states['btn_choose_bak']}")
 9247          self._append_log(f"   [åœæ­¢åè®¡ç®—] æºåªè¯»={states['src_edit_readonly']}, ç›®æ ‡åªè¯»={states['tgt_edit_readonly']}")
 9248          
 9249          # åº”ç”¨çŠ¶æ€
 9250          self.src_edit.setReadOnly(states['src_edit_readonly'])
 9251          self.tgt_edit.setReadOnly(states['tgt_edit_readonly'])
 9252          self.bak_edit.setReadOnly(states['bak_edit_readonly'])
 9253  
 9254          if hasattr(self, 'btn_choose_src'):
 9255              self.btn_choose_src.setEnabled(states['btn_choose_src'])
 9256          if hasattr(self, 'btn_choose_tgt'):
 9257              self.btn_choose_tgt.setEnabled(states['btn_choose_tgt'])
 9258          if hasattr(self, 'btn_choose_bak'):
 9259              self.btn_choose_bak.setEnabled(states['btn_choose_bak'])
 9260  
 9261          # å…³é”®ï¼šåœæ­¢åâ€œå¼€å§‹â€ç«‹åˆ»å¯ç‚¹ï¼ˆä¸å—è§’è‰²é™åˆ¶ï¼‰
 9262          self.btn_start.setEnabled(states['btn_start'])
 9263          self.btn_pause.setEnabled(states['btn_pause'])
 9264          self.btn_pause.setText("â¸ æš‚åœä¸Šä¼ ")
 9265          self.btn_stop.setEnabled(states['btn_stop'])
 9266          
 9267          # é‡ç½®è¿›åº¦æ˜¾ç¤º
 9268          self.pbar.setValue(0)
 9269          self.pbar_file.setValue(0)
 9270          self.pbar_file.setFormat("ç­‰å¾…...")
 9271          self.lbl_current_file.setText("ç­‰å¾…å¼€å§‹...")
 9272          self.lbl_progress.setText("å·²åœæ­¢")
 9273          self._update_status_pill()
 9274          
 9275          # ç»Ÿä¸€å†èµ°ä¸€éæƒé™æ›´æ–°é€»è¾‘ï¼Œç¡®ä¿ä¸€è‡´ï¼ˆä¼šé‡å¤åº”ç”¨ä½†ä¿è¯åŒæ­¥ï¼‰
 9276          try:
 9277              self._update_ui_permissions()
 9278          except Exception:
 9279              pass
 9280          
 9281          # v2.2.0 è°ƒè¯•ï¼šéªŒè¯åœæ­¢åçš„å®é™…çŠ¶æ€
 9282          actual_tgt = self.btn_choose_tgt.isEnabled() if hasattr(self, 'btn_choose_tgt') else None
 9283          actual_src = self.btn_choose_src.isEnabled() if hasattr(self, 'btn_choose_src') else None
 9284          self._append_log(f"   [åœæ­¢åå®é™…] æºæŒ‰é’®={actual_src}, ç›®æ ‡æŒ‰é’®={actual_tgt}")
 9285          
 9286          if actual_tgt is not None and actual_tgt != states['btn_choose_tgt']:
 9287              self._append_log(f"   âš ï¸ è­¦å‘Šï¼šåœæ­¢åç›®æ ‡æŒ‰é’®çŠ¶æ€ä¸ä¸€è‡´ï¼è®¡ç®—={states['btn_choose_tgt']}, å®é™…={actual_tgt}")
 9288          
 9289          self._toast('å·²åœæ­¢', 'danger')
 9290          self._append_log("âœ“ ä¸Šä¼ ä»»åŠ¡å·²åœæ­¢")
 9291          self._append_log("=" * 50)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 188 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 9292          
 9293          # v2.2.0 ç³»ç»Ÿæ‰˜ç›˜é€šçŸ¥
 9294          self._show_notification(
 9295              "ä¸Šä¼ å·²åœæ­¢",
 9296              f"å·²ä¸Šä¼ : {self.uploaded}ä¸ª | å¤±è´¥: {self.failed}ä¸ª | è·³è¿‡: {self.skipped}ä¸ª"
 9297          )
 9298  
 9299      def _on_stats(self, uploaded: int, failed: int, skipped: int, rate: str):
 9300          # v2.2.0 ä¿å­˜ç»Ÿè®¡æ•°æ®
 9301          self.uploaded = uploaded
 9302          self.failed = failed
 9303          self.skipped = skipped
 9304          
 9305          self.lbl_uploaded.setValue(str(uploaded))
 9306          self.lbl_failed.setValue(str(failed))
 9307          self.lbl_skipped.setValue(str(skipped))
 9308          
 9309          # v2.0 å¢å¼ºï¼šé€Ÿç‡æ˜¾ç¤ºæ·»åŠ åè®®å›¾æ ‡
 9310          protocol_icons = {
 9311              'smb': 'ğŸ“',
 9312              'ftp_server': 'ğŸ–¥ï¸',
 9313              'ftp_client': 'ğŸ“¤',
 9314              'both': 'ğŸ”„'
 9315          }
 9316          icon = protocol_icons.get(self.current_protocol, 'ğŸ“')
 9317          self.lbl_rate.setValue(f"{icon} {rate}")
 9318  
 9319      def _on_progress(self, current: int, total: int, filename: str):
 9320          self.pbar.setValue(0 if total <= 0 else int(100*current/max(1,total)))
 9321          eta = "--:--"
 9322          remaining_count = total - current
 9323          if self.start_time and current>0 and total>0:
 9324              elapsed = max(time.time()-self.start_time, 0.001)
 9325              remain = int(elapsed * (total-current)/current)
 9326              h, remainder = divmod(remain, 3600)
 9327              m, s = divmod(remainder, 60)
 9328              if h > 0:
 9329                  eta = f"{h:02d}:{m:02d}:{s:02d}"
 9330              else:
 9331                  eta = f"{m:02d}:{s:02d}"
 9332          prefix = f"æ€»è¿›åº¦ {self.pbar.value()}%"
 9333          suffix = f"  å‰©ä½™ {remaining_count} ä¸ªæ–‡ä»¶  é¢„è®¡ {eta}" if total>0 else ""
 9334          self.lbl_progress.setText(prefix + suffix)
 9335      
 9336      def _on_file_progress(self, filename: str, progress: int):
 9337          """æ›´æ–°å½“å‰æ–‡ä»¶çš„è¿›åº¦"""
 9338          # æˆªæ–­è¿‡é•¿çš„æ–‡ä»¶å
 9339          display_name = filename
 9340          if len(filename) > 50:
 9341              display_name = filename[:25] + "..." + filename[-22:]

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 189 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 9342          
 9343          self.lbl_current_file.setText(f"{display_name}")
 9344          self.pbar_file.setValue(progress)
 9345          
 9346          # å°å¹…åº¦åˆ·æ–°é€Ÿç‡æ˜¾ç¤ºï¼šå½“æœ‰è¿›åº¦æ—¶ç»™å‡ºâ€œä¸Šä¼ ä¸­...â€æç¤ºï¼Œé¿å…é•¿æ—¶é—´ä¿æŒæ—§é€Ÿç‡
 9347          try:
 9348              if 0 < progress < 100:
 9349                  self.lbl_rate.setValue("ä¸Šä¼ ä¸­...")
 9350          except Exception:
 9351              pass
 9352          
 9353          if progress == 0:
 9354              self.pbar_file.setFormat("å‡†å¤‡ä¸Šä¼ ...")
 9355          elif progress == 100:
 9356              self.pbar_file.setFormat("âœ“ å®Œæˆ")
 9357          else:
 9358              self.pbar_file.setFormat(f"{progress}%")
 9359  
 9360      def _on_ask_duplicate(self, payload: dict):
 9361          """åœ¨ä¸»çº¿ç¨‹å¼¹çª—è¯¢é—®é‡å¤æ–‡ä»¶å¤„ç†ç­–ç•¥ã€‚payload ç»“æ„:
 9362          {'file': str, 'duplicate': str, 'event': threading.Event, 'result': dict}
 9363          """
 9364          try:
 9365              src = payload.get('file', '')
 9366              dup = payload.get('duplicate', '')
 9367              evt = payload.get('event')
 9368              result = payload.get('result')
 9369  
 9370              dialog = QtWidgets.QDialog(self)
 9371              dialog.setWindowTitle("å‘ç°é‡å¤æ–‡ä»¶")
 9372              dialog.setModal(True)
 9373              dialog.resize(560, 300)
 9374  
 9375              # æå‡é€‰ä¸­å¯è§æ€§ï¼šä¸ºå•é€‰é¡¹æ·»åŠ æ˜¾è‘—çš„é€‰ä¸­èƒŒæ™¯/è¾¹æ¡†å’Œæ›´å¤§çš„æŒ‡ç¤ºå™¨ï¼Œå¹¶ç»Ÿä¸€ä¸»æŒ‰é’®æ ·å¼
 9376              dialog.setStyleSheet(
 9377                  """
 9378                  QDialog{background:#FAFAFA;}
 9379                  QLabel{font-size:13px;}
 9380                  QRadioButton{
 9381                      padding:8px 12px;
 9382                      border-radius:8px;
 9383                      margin:2px 0;
 9384                  }
 9385                  QRadioButton:hover{background:#F5F5F5;}
 9386                  QRadioButton:checked{
 9387                      background:#E3F2FD;
 9388                      border:2px solid #1976D2;
 9389                      font-weight:600;
 9390                  }
 9391                  QRadioButton::indicator{

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 190 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 9392                      width:18px; height:18px; margin-right:8px;
 9393                  }
 9394                  QRadioButton::indicator:unchecked{
 9395                      border:2px solid #90A4AE; border-radius:9px; background:transparent;
 9396                  }
 9397                  QRadioButton::indicator:checked{
 9398                      border:6px solid #1976D2; border-radius:9px; background:#1976D2;
 9399                  }
 9400                  QCheckBox{margin-top:8px;}
 9401                  QPushButton[class="Primary"]{
 9402                      background:#1976D2; color:white; padding:6px 14px; border:none; border-radius:6px;
 9403                  }
 9404                  QPushButton[class="Primary"]:hover{background:#1565C0;}
 9405                  QPushButton[class="Primary"]:pressed{background:#0D47A1;}
 9406                  """
 9407              )
 9408  
 9409              v = QtWidgets.QVBoxLayout(dialog)
 9410              lab = QtWidgets.QLabel("æ£€æµ‹åˆ°é‡å¤æ–‡ä»¶ï¼Œè¯·é€‰æ‹©å¤„ç†æ–¹å¼ï¼š")
 9411              lab.setWordWrap(True)
 9412              v.addWidget(lab)
 9413  
 9414              def short(p: str) -> str:
 9415                  return p if len(p) <= 90 else (p[:42] + "..." + p[-42:])
 9416              v.addWidget(QtWidgets.QLabel(f"æºæ–‡ä»¶ï¼š{short(src)}"))
 9417              v.addWidget(QtWidgets.QLabel(f"ç›®æ ‡å·²æœ‰ï¼š{short(dup)}"))
 9418  
 9419              group = QtWidgets.QButtonGroup(dialog)
 9420              rb_skip = QtWidgets.QRadioButton("â­ è·³è¿‡ï¼ˆä¸ä¸Šä¼ ï¼Œç›´æ¥å½’æ¡£æºæ–‡ä»¶ï¼‰")
 9421              rb_rename = QtWidgets.QRadioButton("ğŸ“ é‡å‘½ååä¸Šä¼ ï¼ˆä¿ç•™ä¸¤ä»½ï¼‰")
 9422              rb_overwrite = QtWidgets.QRadioButton("âš  è¦†ç›–å·²æœ‰æ–‡ä»¶ï¼ˆè°¨æ…ï¼‰")
 9423              rb_skip.setChecked(True)
 9424              rb_skip.setFocus()
 9425              for rb in (rb_skip, rb_rename, rb_overwrite):
 9426                  group.addButton(rb)
 9427                  v.addWidget(rb)
 9428  
 9429              cb_apply = QtWidgets.QCheckBox("å¯¹åç»­é‡å¤æ–‡ä»¶ä½¿ç”¨åŒä¸€é€‰æ‹©")
 9430              v.addWidget(cb_apply)
 9431  
 9432              row = QtWidgets.QHBoxLayout()
 9433              row.addStretch(1)
 9434              btn_cancel = QtWidgets.QPushButton("å–æ¶ˆ")
 9435              btn_cancel.setProperty("class", "Secondary")
 9436              btn_cancel.clicked.connect(dialog.reject)
 9437              btn_ok = QtWidgets.QPushButton("ç¡®å®š")
 9438              btn_ok.setProperty("class", "Primary")
 9439              btn_ok.setDefault(True)
 9440              row.addWidget(btn_cancel)
 9441              row.addWidget(btn_ok)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 191 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 9442              v.addLayout(row)
 9443  
 9444              # é”®ç›˜å¯¼èˆªé¡ºåºï¼šå•é€‰é¡¹ -> ç¡®å®š -> å–æ¶ˆ
 9445              try:
 9446                  QtWidgets.QDialog.setTabOrder(rb_skip, rb_rename)
 9447                  QtWidgets.QDialog.setTabOrder(rb_rename, rb_overwrite)
 9448                  QtWidgets.QDialog.setTabOrder(rb_overwrite, btn_ok)
 9449                  QtWidgets.QDialog.setTabOrder(btn_ok, btn_cancel)
 9450              except Exception:
 9451                  pass
 9452  
 9453              def done(ok: bool):
 9454                  try:
 9455                      choice = 'skip'
 9456                      if rb_rename.isChecked():
 9457                          choice = 'rename'
 9458                      elif rb_overwrite.isChecked():
 9459                          choice = 'overwrite'
 9460                      if isinstance(result, dict):
 9461                          result['choice'] = choice
 9462                          result['apply_all'] = cb_apply.isChecked()
 9463                  finally:
 9464                      dialog.accept() if ok else dialog.reject()
 9465                      try:
 9466                          if evt:
 9467                              evt.set()
 9468                      except Exception:
 9469                          pass
 9470  
 9471              btn_cancel.clicked.connect(lambda: done(False))
 9472              btn_ok.clicked.connect(lambda: done(True))
 9473  
 9474              dialog.exec() if hasattr(dialog, 'exec') else dialog.exec_()
 9475          except Exception:
 9476              try:
 9477                  if isinstance(payload.get('result'), dict):
 9478                      payload['result']['choice'] = 'skip'
 9479                      payload['result']['apply_all'] = False
 9480              finally:
 9481                  if payload.get('event'):
 9482                      try:
 9483                          payload['event'].set()
 9484                      except Exception:
 9485                          pass
 9486      
 9487      def _on_network_status(self, status: str):
 9488          """æ›´æ–°ç½‘ç»œçŠ¶æ€æ˜¾ç¤º"""
 9489          if status == 'good':
 9490              self.lbl_network.setValue("ğŸŸ¢ æ­£å¸¸")
 9491              # æ›´æ–°èŠ¯ç‰‡æ ·å¼ä¸ºç»¿è‰²

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 192 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 9492              self.lbl_network.setStyleSheet("QFrame{background:#E8F5E9; border-radius:8px;} QLabel{color:#2E7D32;}")
 9493              self.network_status = 'good'
 9494          elif status == 'unstable':
 9495              self.lbl_network.setValue("ğŸŸ¡ ä¸ç¨³å®š")
 9496              # æ›´æ–°èŠ¯ç‰‡æ ·å¼ä¸ºé»„è‰²
 9497              self.lbl_network.setStyleSheet("QFrame{background:#FFF9C4; border-radius:8px;} QLabel{color:#F57F17;}")
 9498              self.network_status = 'unstable'
 9499          elif status == 'disconnected':
 9500              self.lbl_network.setValue("ğŸ”´ å·²æ–­å¼€")
 9501              # æ›´æ–°èŠ¯ç‰‡æ ·å¼ä¸ºçº¢è‰²
 9502              self.lbl_network.setStyleSheet("QFrame{background:#FFEBEE; border-radius:8px;} QLabel{color:#C62828;}")
 9503              self.network_status = 'disconnected'
 9504  
 9505      def _on_worker_status(self, s: str):
 9506          if s == 'running':
 9507              self.is_running = True
 9508              self.is_paused = False
 9509          elif s == 'paused':
 9510              self.is_paused = True
 9511          elif s == 'stopped':
 9512              self.is_running = False
 9513              self.is_paused = False
 9514          self._update_status_pill()
 9515  
 9516      def _on_worker_finished(self):
 9517          # v2.2.0 ç³»ç»Ÿæ‰˜ç›˜é€šçŸ¥ï¼šä¸Šä¼ ä»»åŠ¡å®Œæˆ
 9518          if self.uploaded > 0 or self.failed > 0:
 9519              self._show_notification(
 9520                  "ä¸Šä¼ ä»»åŠ¡å®Œæˆ",
 9521                  f"æˆåŠŸ: {self.uploaded}ä¸ª | å¤±è´¥: {self.failed}ä¸ª | è·³è¿‡: {self.skipped}ä¸ª"
 9522              )
 9523          # keep thread objects for GC safety
 9524          pass
 9525      
 9526      def _on_upload_error(self, filename: str, error_message: str):
 9527          """v2.2.0 å¤„ç†ä¸Šä¼ é”™è¯¯é€šçŸ¥"""
 9528          # é™åˆ¶é”™è¯¯é€šçŸ¥é¢‘ç‡ï¼ˆæ¯ä¸ªæ–‡ä»¶åªé€šçŸ¥ä¸€æ¬¡æœ€æ–°é”™è¯¯ï¼‰
 9529          if not hasattr(self, '_error_notified_files'):
 9530              self._error_notified_files = set()
 9531          
 9532          if filename not in self._error_notified_files:
 9533              self._error_notified_files.add(filename)
 9534              # æˆªæ–­è¿‡é•¿çš„é”™è¯¯ä¿¡æ¯
 9535              short_error = error_message[:50] + '...' if len(error_message) > 50 else error_message
 9536              self._show_notification(
 9537                  "ä¸Šä¼ é”™è¯¯",
 9538                  f"{filename}: {short_error}",
 9539                  icon_type=get_qt_enum(QtWidgets.QSystemTrayIcon, 'Warning', 2)
 9540              )
 9541          

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 193 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 9542          # å®šæœŸæ¸…ç†å·²é€šçŸ¥æ–‡ä»¶é›†åˆï¼ˆé¿å…å†…å­˜æ³„æ¼ï¼‰
 9543          if len(self._error_notified_files) > 100:
 9544              self._error_notified_files.clear()
 9545      
 9546      def _on_disk_warning(self, target_percent: float, backup_percent: float, threshold: int):
 9547          """v2.2.0 å¤„ç†ç£ç›˜ç©ºé—´è­¦å‘Šé€šçŸ¥"""
 9548          self._show_notification(
 9549              "ç£ç›˜ç©ºé—´ä¸è¶³",
 9550              f"ç›®æ ‡: {target_percent:.0f}% | å¤‡ä»½: {backup_percent:.0f}% | é˜ˆå€¼: {threshold}%",
 9551              icon_type=get_qt_enum(QtWidgets.QSystemTrayIcon, 'Warning', 2)
 9552          )
 9553  
 9554      def _append_log(self, line: str): 
 9555          # If autoscroll is disabled, preserve the current scrollbar position.
 9556          try:
 9557              vsb = self.log.verticalScrollBar()
 9558              prev = vsb.value()
 9559          except Exception:
 9560              vsb = None
 9561              prev = None
 9562  
 9563          # æ·»åŠ æ—¶é—´æˆ³
 9564          timestamp = datetime.datetime.now().strftime('%H:%M:%S')
 9565          log_line = f"[{timestamp}] {line}"
 9566          
 9567          # Append the new line to UI
 9568          self.log.appendPlainText(log_line)
 9569          
 9570          # Write to log file
 9571          self._write_log_to_file(line)
 9572  
 9573          # Decide scrolling behaviour
 9574          if self.cb_autoscroll.isChecked():
 9575              move_enum = getattr(QtGui.QTextCursor, 'MoveOperation', QtGui.QTextCursor)
 9576              self.log.moveCursor(getattr(move_enum, 'End'))
 9577              if vsb is not None:
 9578                  vsb.setValue(vsb.maximum())
 9579          else:
 9580              # restore previous scrollbar position if possible
 9581              if vsb is not None and prev is not None:
 9582                  # keep the view where it was before appending
 9583                  vsb.setValue(prev)
 9584      
 9585      def _write_log_to_file(self, line: str):
 9586          """å°†æ—¥å¿—å†™å…¥æ–‡ä»¶ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹ï¼‰"""
 9587          if self.log_file_path is None:
 9588              return
 9589          
 9590          # ä¿å­˜å½“å‰æ—¥å¿—æ–‡ä»¶è·¯å¾„ï¼ˆé¿å…åœ¨çº¿ç¨‹ä¸­è®¿é—® selfï¼‰
 9591          current_log_path = self.log_file_path

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 194 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 9592          app_dir = self.app_dir
 9593          
 9594          def write_log():
 9595              try:
 9596                  # æ£€æŸ¥æ—¥æœŸæ˜¯å¦å˜æ›´
 9597                  today = datetime.datetime.now().strftime('%Y-%m-%d')
 9598                  expected_filename = f'upload_{today}.txt'
 9599                  
 9600                  log_path = current_log_path
 9601                  if log_path.name != expected_filename:
 9602                      # åˆ›å»ºæ–°çš„æ—¥å¿—æ–‡ä»¶
 9603                      log_dir = app_dir / "logs"
 9604                      log_dir.mkdir(parents=True, exist_ok=True)
 9605                      log_path = log_dir / expected_filename
 9606                  
 9607                  # å†™å…¥æ—¥å¿—ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰
 9608                  timestamp = datetime.datetime.now().strftime('%H:%M:%S')
 9609                  with open(log_path, 'a', encoding='utf-8') as f:
 9610                      f.write(f"[{timestamp}] {line}\n")
 9611              except Exception as e:
 9612                  # é™é»˜å¤±è´¥ï¼Œä¸å½±å“ç¨‹åºè¿è¡Œ
 9613                  print(f"å†™å…¥æ—¥å¿—æ–‡ä»¶å¤±è´¥: {e}")
 9614          
 9615          # æäº¤åˆ°çº¿ç¨‹æ± å¼‚æ­¥æ‰§è¡Œ
 9616          try:
 9617              self._log_executor.submit(write_log)
 9618          except Exception:
 9619              # çº¿ç¨‹æ± å…³é—­æˆ–å…¶ä»–é—®é¢˜ï¼Œé™é»˜å¤±è´¥
 9620              pass
 9621  
 9622      def _update_status_pill(self):
 9623          if self.is_paused:
 9624              self.lbl_status.setText("ğŸŸ¡ å·²æš‚åœ")
 9625              self.lbl_status.setStyleSheet("background:#FEF9C3; color:#A16207; padding:4px 10px; font-weight:700; border-radius:12px;")
 9626          elif self.is_running:
 9627              self.lbl_status.setText("ğŸŸ¢ è¿è¡Œä¸­")
 9628              self.lbl_status.setStyleSheet("background:#DCFCE7; color:#166534; padding:4px 10px; font-weight:700; border-radius:12px;")
 9629          else:
 9630              self.lbl_status.setText("ğŸ”´ å·²åœæ­¢")
 9631              self.lbl_status.setStyleSheet("background:#FEE2E2; color:#B91C1C; padding:4px 10px; font-weight:700; border-radius:12px;")
 9632      
 9633      def _update_protocol_status(self):
 9634          """æ›´æ–°åè®®å’ŒFTPçŠ¶æ€æ˜¾ç¤º"""
 9635          # æ›´æ–°åè®®æ¨¡å¼
 9636          protocol_names = {
 9637              'smb': 'SMB',
 9638              'ftp_server': 'FTPæœåŠ¡å™¨',
 9639              'ftp_client': 'FTPå®¢æˆ·ç«¯',
 9640              'both': 'æ··åˆæ¨¡å¼'
 9641          }

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 195 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 9642          protocol_text = protocol_names.get(self.current_protocol, 'SMB')
 9643          self.lbl_protocol.setValue(protocol_text)
 9644          
 9645          # æ›´æ–°FTPæœåŠ¡å™¨çŠ¶æ€ï¼ˆå«å›¾æ ‡æŒ‡ç¤ºå™¨ï¼‰
 9646          if self.current_protocol in ['ftp_server', 'both']:
 9647              if self.ftp_manager and self.ftp_manager.server:
 9648                  try:
 9649                      # ç›´æ¥ä»FTPServerManagerè·å–çŠ¶æ€
 9650                      server_info = self.ftp_manager.server.get_status()
 9651                      if server_info.get('running'):
 9652                          connections = server_info.get('connections', 0)
 9653                          # æ˜¾ç¤ºè¿æ¥æ•°ï¼Œå¦‚æœæœ‰è¿æ¥åˆ™ç”¨ç»¿è‰²é«˜äº®
 9654                          if connections > 0:
 9655                              self.lbl_ftp_server.setValue(f"ğŸŸ¢ è¿è¡Œä¸­ ({connections}ä¸ªè¿æ¥)")
 9656                          else:
 9657                              self.lbl_ftp_server.setValue("ğŸŸ¢ è¿è¡Œä¸­ (0)")
 9658                          self.lbl_ftp_server.setStyleSheet(
 9659                              "background:#DCFCE7; color:#166534; padding:4px 8px; border-radius:4px; font-size:9pt; font-weight:500;"
 9660                          )
 9661                      else:
 9662                          self.lbl_ftp_server.setValue("ğŸ”´ å·²åœæ­¢")
 9663                          self.lbl_ftp_server.setStyleSheet(
 9664                              "background:#FEE2E2; color:#B91C1C; padding:4px 8px; border-radius:4px; font-size:9pt;"
 9665                          )
 9666                  except:
 9667                      self.lbl_ftp_server.setValue("âšª æœªå¯åŠ¨")
 9668                      self.lbl_ftp_server.setStyleSheet(
 9669                          "background:#F5F5F5; color:#757575; padding:4px 8px; border-radius:4px; font-size:9pt;"
 9670                      )
 9671              else:
 9672                  self.lbl_ftp_server.setValue("âšª æœªå¯åŠ¨")
 9673                  self.lbl_ftp_server.setStyleSheet(
 9674                      "background:#F5F5F5; color:#757575; padding:4px 8px; border-radius:4px; font-size:9pt;"
 9675                  )
 9676          else:
 9677              self.lbl_ftp_server.setValue("âš« --")
 9678              self.lbl_ftp_server.setStyleSheet(
 9679                  "background:#F5F5F5; color:#9E9E9E; padding:4px 8px; border-radius:4px; font-size:9pt;"
 9680              )
 9681          
 9682          # æ›´æ–°FTPå®¢æˆ·ç«¯çŠ¶æ€ï¼ˆå«å›¾æ ‡æŒ‡ç¤ºå™¨ï¼‰
 9683          if self.current_protocol in ['ftp_client', 'both']:
 9684              if self.worker and hasattr(self.worker, 'ftp_client') and self.worker.ftp_client:
 9685                  try:
 9686                      client_status = self.worker.ftp_client.get_status()
 9687                      if client_status.get('connected'):
 9688                          host = client_status.get('host', '')
 9689                          self.lbl_ftp_client.setValue(f"ğŸŸ¢ å·²è¿æ¥ ({host})")
 9690                          self.lbl_ftp_client.setStyleSheet(
 9691                              "background:#DCFCE7; color:#166534; padding:4px 8px; border-radius:4px; font-size:9pt; font-weight:500;"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 196 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 9692                          )
 9693                      else:
 9694                          self.lbl_ftp_client.setValue("ğŸŸ¡ æœªè¿æ¥")
 9695                          self.lbl_ftp_client.setStyleSheet(
 9696                              "background:#FEF9C3; color:#A16207; padding:4px 8px; border-radius:4px; font-size:9pt;"
 9697                          )
 9698                  except:
 9699                      self.lbl_ftp_client.setValue("âšª æœªè¿æ¥")
 9700                      self.lbl_ftp_client.setStyleSheet(
 9701                          "background:#F5F5F5; color:#757575; padding:4px 8px; border-radius:4px; font-size:9pt;"
 9702                      )
 9703              else:
 9704                  self.lbl_ftp_client.setValue("âšª æœªè¿æ¥")
 9705                  self.lbl_ftp_client.setStyleSheet(
 9706                      "background:#F5F5F5; color:#757575; padding:4px 8px; border-radius:4px; font-size:9pt;"
 9707                  )
 9708          else:
 9709              self.lbl_ftp_client.setValue("âš« --")
 9710              self.lbl_ftp_client.setStyleSheet(
 9711                  "background:#F5F5F5; color:#9E9E9E; padding:4px 8px; border-radius:4px; font-size:9pt;"
 9712              )
 9713  
 9714      def _toast(self, msg: str, kind: str = 'info'):
 9715          t = Toast(self.window(), msg, kind)
 9716          t.show()
 9717  
 9718      def _tick(self):
 9719          # è¿è¡Œæ—¶é—´æ›´æ–°
 9720          if self.is_running and self.start_time:
 9721              elapsed = int(time.time() - self.start_time)
 9722              h, rem = divmod(elapsed, 3600)
 9723              m, s = divmod(rem, 60)
 9724              t = f"{h:02d}:{m:02d}:{s:02d}"
 9725              self.lbl_time.setValue(t)
 9726          
 9727          # å½’æ¡£é˜Ÿåˆ—å¤§å°åˆ·æ–°ï¼ˆè¿‘ä¼¼å€¼å³å¯ï¼‰
 9728          try:
 9729              if self.worker is not None and hasattr(self.worker, 'archive_queue'):
 9730                  qsize = self.worker.archive_queue.qsize()
 9731                  self.lbl_queue.setValue(str(qsize))
 9732          except Exception:
 9733              pass
 9734          
 9735          # ç£ç›˜ç©ºé—´æ›´æ–°ï¼ˆæ ¹æ®é…ç½®çš„é—´éš”ï¼‰
 9736          self.disk_check_counter += 1
 9737          # æ¯0.5ç§’tickä¸€æ¬¡ï¼Œæ‰€ä»¥éœ€è¦ interval * 2 æ¬¡tick
 9738          if self.disk_check_counter >= self.disk_check_interval * 2:
 9739              self.disk_check_counter = 0
 9740              self._update_disk_space()
 9741          

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 197 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 9742          # v2.0 æ–°å¢ï¼šæ›´æ–°åè®®å’ŒFTPçŠ¶æ€
 9743          self._update_protocol_status()
 9744  
 9745      def _update_disk_space(self):
 9746          """æ›´æ–°ç£ç›˜å‰©ä½™ç©ºé—´æ˜¾ç¤ºï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹ï¼‰"""
 9747          target_path = self.tgt_edit.text()
 9748          backup_path = self.bak_edit.text()
 9749          
 9750          def _is_network_path(p: str) -> bool:
 9751              try:
 9752                  if not p:
 9753                      return False
 9754                  # UNC è·¯å¾„ï¼ˆä¾‹å¦‚ \\server\share\folder ï¼‰ç›´æ¥è§†ä¸ºç½‘ç»œè·¯å¾„
 9755                  if p.startswith('\\\\'):
 9756                      return True
 9757                  # é©±åŠ¨å™¨ç›˜ç¬¦åˆ¤æ–­ç½‘ç»œæ˜ å°„ç›˜ï¼ˆä½¿ç”¨ Win32 API GetDriveTypeï¼‰
 9758                  drive, _ = os.path.splitdrive(p)
 9759                  if not drive:
 9760                      return False
 9761                  root = drive + '\\'
 9762                  try:
 9763                      import ctypes
 9764                      DRIVE_REMOTE = 4
 9765                      GetDriveTypeW = ctypes.windll.kernel32.GetDriveTypeW
 9766                      GetDriveTypeW.argtypes = [ctypes.c_wchar_p]
 9767                      GetDriveTypeW.restype = ctypes.c_uint
 9768                      dtype = GetDriveTypeW(root)
 9769                      return dtype == DRIVE_REMOTE
 9770                  except Exception:
 9771                      return False
 9772              except Exception:
 9773                  return False
 9774          
 9775          def update_disk_async():
 9776              try:
 9777                  # æ›´æ–°ç›®æ ‡ç£ç›˜
 9778                  if target_path:
 9779                      # ç½‘ç»œè·¯å¾„ä»…åœ¨ç½‘ç»œæ­£å¸¸æ—¶å°è¯•è¯»å–ç©ºé—´ï¼Œå¦åˆ™æ˜¾ç¤º"--"
 9780                      if _is_network_path(target_path) and getattr(self, 'network_status', 'unknown') != 'good':
 9781                          self._disk_update_signal.emit("target", -1.0)
 9782                      else:
 9783                          try:
 9784                              if os.path.exists(target_path):
 9785                                  usage = shutil.disk_usage(target_path)
 9786                                  free_percent = (usage.free / usage.total) * 100 if usage.total > 0 else 0
 9787                                  self._disk_update_signal.emit("target", free_percent)
 9788                              else:
 9789                                  self._disk_update_signal.emit("target", -1.0)
 9790                          except Exception:
 9791                              self._disk_update_signal.emit("target", -1.0)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 198 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 9792                  
 9793                  # æ›´æ–°å½’æ¡£ç£ç›˜
 9794                  if backup_path:
 9795                      if _is_network_path(backup_path) and getattr(self, 'network_status', 'unknown') != 'good':
 9796                          self._disk_update_signal.emit("backup", -1.0)
 9797                      else:
 9798                          try:
 9799                              if os.path.exists(backup_path):
 9800                                  usage = shutil.disk_usage(backup_path)
 9801                                  free_percent = (usage.free / usage.total) * 100 if usage.total > 0 else 0
 9802                                  self._disk_update_signal.emit("backup", free_percent)
 9803                              else:
 9804                                  self._disk_update_signal.emit("backup", -1.0)
 9805                          except Exception:
 9806                              self._disk_update_signal.emit("backup", -1.0)
 9807              except Exception as e:
 9808                  print(f"ç£ç›˜ç©ºé—´æ£€æŸ¥å¤±è´¥: {e}")
 9809          
 9810          # æäº¤åˆ°çº¿ç¨‹æ± å¼‚æ­¥æ‰§è¡Œ
 9811          try:
 9812              self._log_executor.submit(update_disk_async)
 9813          except Exception:
 9814              pass
 9815      
 9816      def _on_disk_update(self, disk_type: str, free_percent: float):
 9817          """å¤„ç†ç£ç›˜æ›´æ–°ä¿¡å·ï¼ˆåœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œï¼‰"""
 9818          if disk_type == "target":
 9819              if free_percent < 0:
 9820                  # ç½‘ç»œè·¯å¾„æˆ–ä¸å¯è¾¾
 9821                  self.lbl_target_disk.setValue("--")
 9822              else:
 9823                  self.lbl_target_disk.setValue(f"{free_percent:.1f}%")
 9824                  if free_percent < 10:
 9825                      self.lbl_target_disk.setStyleSheet("QFrame{background:#FFEBEE; border-radius:8px;} QLabel{color:#C62828;}")
 9826                  elif free_percent < 20:
 9827                      self.lbl_target_disk.setStyleSheet("QFrame{background:#FFF9C3; border-radius:8px;} QLabel{color:#F57F17;}")
 9828                  else:
 9829                      self.lbl_target_disk.setStyleSheet("QFrame{background:#E1F5FE; border-radius:8px;} QLabel{color:#01579B;}")
 9830          elif disk_type == "backup":
 9831              if free_percent < 0:
 9832                  self.lbl_backup_disk.setValue("--")
 9833              else:
 9834                  self.lbl_backup_disk.setValue(f"{free_percent:.1f}%")
 9835                  if free_percent < 10:
 9836                      self.lbl_backup_disk.setStyleSheet("QFrame{background:#FFEBEE; border-radius:8px;} QLabel{color:#C62828;}")
 9837                  elif free_percent < 20:
 9838                      self.lbl_backup_disk.setStyleSheet("QFrame{background:#FFF9C3; border-radius:8px;} QLabel{color:#F57F17;}")
 9839                  else:
 9840                      self.lbl_backup_disk.setStyleSheet("QFrame{background:#F1F8E9; border-radius:8px;} QLabel{color:#33691E;}")
 9841      

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 199 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 9842      # ========== v2.2.0 æ–°å¢ï¼šç³»ç»Ÿæ‰˜ç›˜åŠŸèƒ½ ==========
 9843      
 9844      def _init_tray_icon(self):
 9845          """åˆå§‹åŒ–ç³»ç»Ÿæ‰˜ç›˜å›¾æ ‡å’Œèœå•"""
 9846          # åˆ›å»ºæ‰˜ç›˜å›¾æ ‡
 9847          self.tray_icon = QtWidgets.QSystemTrayIcon(self)
 9848          
 9849          # è®¾ç½®æ‰˜ç›˜å›¾æ ‡ï¼ˆä½¿ç”¨åº”ç”¨å›¾æ ‡æˆ–é»˜è®¤å›¾æ ‡ï¼‰
 9850          icon = self.windowIcon()
 9851          if icon.isNull():
 9852              # å¦‚æœæ²¡æœ‰çª—å£å›¾æ ‡ï¼Œåˆ›å»ºä¸€ä¸ªç®€å•çš„å›¾æ ‡
 9853              pixmap = QtGui.QPixmap(64, 64)
 9854              pixmap.fill(QtGui.QColor("#4CAF50"))
 9855              painter = QtGui.QPainter(pixmap)
 9856              painter.setPen(QtGui.QColor("white"))
 9857              font = QtGui.QFont("Arial", 24)
 9858              font.setBold(True)
 9859              painter.setFont(font)
 9860              painter.drawText(pixmap.rect(), get_qt_enum(QtCore.Qt, 'AlignCenter', 0x0084), "å›¾")
 9861              painter.end()
 9862              icon = QtGui.QIcon(pixmap)
 9863          
 9864          self.tray_icon.setIcon(icon)
 9865          self.tray_icon.setToolTip(APP_TITLE)
 9866          
 9867          # åˆ›å»ºæ‰˜ç›˜èœå•
 9868          tray_menu = QtWidgets.QMenu()
 9869          
 9870          # æ˜¾ç¤º/éšè—ä¸»çª—å£
 9871          show_action = tray_menu.addAction("ğŸ“± æ˜¾ç¤ºä¸»çª—å£")
 9872          show_action.triggered.connect(self._show_window)
 9873          
 9874          tray_menu.addSeparator()
 9875          
 9876          # ä¸Šä¼ æ§åˆ¶
 9877          self.tray_start_action = tray_menu.addAction("â–¶ï¸ å¼€å§‹ä¸Šä¼ ")
 9878          self.tray_start_action.triggered.connect(self._on_start)
 9879          
 9880          self.tray_pause_action = tray_menu.addAction("â¸ï¸ æš‚åœä¸Šä¼ ")
 9881          self.tray_pause_action.triggered.connect(self._on_pause_resume)
 9882          self.tray_pause_action.setEnabled(False)
 9883          
 9884          self.tray_stop_action = tray_menu.addAction("â¹ï¸ åœæ­¢ä¸Šä¼ ")
 9885          self.tray_stop_action.triggered.connect(self._on_stop)
 9886          self.tray_stop_action.setEnabled(False)
 9887          
 9888          tray_menu.addSeparator()
 9889          
 9890          # ç»Ÿè®¡ä¿¡æ¯
 9891          stats_action = tray_menu.addAction("ğŸ“Š æŸ¥çœ‹ç»Ÿè®¡")

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 200 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 9892          stats_action.triggered.connect(self._show_stats)
 9893          
 9894          tray_menu.addSeparator()
 9895          
 9896          # é€€å‡ºç¨‹åº
 9897          quit_action = tray_menu.addAction("âŒ é€€å‡ºç¨‹åº")
 9898          quit_action.triggered.connect(self._quit_application)
 9899          
 9900          self.tray_icon.setContextMenu(tray_menu)
 9901          
 9902          # åŒå‡»æ‰˜ç›˜å›¾æ ‡æ˜¾ç¤ºä¸»çª—å£
 9903          self.tray_icon.activated.connect(self._on_tray_activated)
 9904          
 9905          # æ˜¾ç¤ºæ‰˜ç›˜å›¾æ ‡
 9906          self.tray_icon.show()
 9907          
 9908          self._append_log("âœ“ ç³»ç»Ÿæ‰˜ç›˜å·²åˆå§‹åŒ–")
 9909      
 9910      def _on_tray_activated(self, reason):
 9911          """æ‰˜ç›˜å›¾æ ‡æ¿€æ´»äº‹ä»¶"""
 9912          if reason == get_qt_enum(QtWidgets.QSystemTrayIcon, 'DoubleClick', 2):
 9913              self._show_window()
 9914      
 9915      def _show_window(self):
 9916          """æ˜¾ç¤ºä¸»çª—å£"""
 9917          self.show()
 9918          # WindowMinimized=0x00000001, WindowActive=0x00000004
 9919          window_minimized = get_qt_enum(QtCore.Qt, 'WindowMinimized', 0x00000001)
 9920          window_active = get_qt_enum(QtCore.Qt, 'WindowActive', 0x00000004)
 9921          self.setWindowState(self.windowState() & ~window_minimized | window_active)
 9922          self.activateWindow()
 9923          self.raise_()
 9924      
 9925      def _show_stats(self):
 9926          """æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯å¯¹è¯æ¡†"""
 9927          stats_text = f"""
 9928  ğŸ“Š ä¸Šä¼ ç»Ÿè®¡ä¿¡æ¯
 9929  
 9930  è¿è¡ŒçŠ¶æ€: {'ğŸŸ¢ è¿è¡Œä¸­' if self.is_running else 'âšª å·²åœæ­¢'}
 9931  å·²ä¸Šä¼ : {self.uploaded} ä¸ªæ–‡ä»¶
 9932  å¤±è´¥: {self.failed} ä¸ªæ–‡ä»¶
 9933  è·³è¿‡: {self.skipped} ä¸ªæ–‡ä»¶
 9934  
 9935  ç½‘ç»œçŠ¶æ€: {self._get_network_status_text()}
 9936  åè®®æ¨¡å¼: {self.current_protocol.upper()}
 9937  """
 9938          if self.is_running and self.start_time:
 9939              elapsed = time.time() - self.start_time
 9940              hours = int(elapsed // 3600)
 9941              minutes = int((elapsed % 3600) // 60)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 201 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 9942              seconds = int(elapsed % 60)
 9943              stats_text += f"è¿è¡Œæ—¶é—´: {hours:02d}:{minutes:02d}:{seconds:02d}\n"
 9944          
 9945          msg_box = QtWidgets.QMessageBox(self)
 9946          msg_box.setWindowTitle("ç»Ÿè®¡ä¿¡æ¯")
 9947          msg_box.setText(stats_text)
 9948          msg_box.setIcon(MessageBoxIcon.Information)
 9949          msg_box.exec()
 9950      
 9951      def _get_network_status_text(self):
 9952          """è·å–ç½‘ç»œçŠ¶æ€æ–‡æœ¬"""
 9953          status_map = {
 9954              'good': 'ğŸŸ¢ æ­£å¸¸',
 9955              'unstable': 'ğŸŸ¡ ä¸ç¨³å®š',
 9956              'disconnected': 'ğŸ”´ å·²æ–­å¼€',
 9957              'unknown': 'âšª æœªçŸ¥'
 9958          }
 9959          return status_map.get(self.network_status, 'âšª æœªçŸ¥')
 9960      
 9961      def _quit_application(self):
 9962          """é€€å‡ºåº”ç”¨ç¨‹åº"""
 9963          reply = QtWidgets.QMessageBox.question(
 9964              self,
 9965              'ç¡®è®¤é€€å‡º',
 9966              'ç¡®å®šè¦é€€å‡ºç¨‹åºå—ï¼Ÿ\n\nå¦‚æœæœ‰ä¸Šä¼ ä»»åŠ¡æ­£åœ¨è¿è¡Œï¼Œå°†ä¼šè¢«ä¸­æ­¢ã€‚',
 9967              MessageBoxButton.Yes | MessageBoxButton.No,
 9968              MessageBoxButton.No
 9969          )
 9970          
 9971          if reply == MessageBoxButton.Yes:
 9972              if self.tray_icon:
 9973                  self.tray_icon.hide()
 9974              QtWidgets.QApplication.quit()
 9975      
 9976      def _show_notification(self, title: str, message: str, icon_type: Optional[Any] = None):
 9977          """æ˜¾ç¤ºç³»ç»Ÿé€šçŸ¥
 9978          
 9979          Note: PySide6 6.x çš„ showMessage API æœ‰ä¸¤ç§ç­¾åï¼Œæˆ‘ä»¬ä½¿ç”¨ type: ignore[call-overload] æ¥å¿½ç•¥ç±»å‹æ£€æŸ¥
 9980          """
 9981          if self.show_notifications and self.tray_icon and self.tray_icon.isVisible():
 9982              if icon_type is None:
 9983                  icon_type = TrayIconType.Information
 9984              self.tray_icon.showMessage(title, message, icon_type, 3000)  # type: ignore[call-overload]
 9985      
 9986      def changeEvent(self, event):
 9987          """çª—å£çŠ¶æ€æ”¹å˜äº‹ä»¶"""
 9988          if event.type() == EventType.WindowStateChange:
 9989              if self.minimize_to_tray and self.isMinimized():
 9990                  # æœ€å°åŒ–æ—¶éšè—åˆ°æ‰˜ç›˜
 9991                  event.ignore()

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 202 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
 9992                  self.hide()
 9993                  if self.show_notifications:
 9994                      self._show_notification(
 9995                          "å·²æœ€å°åŒ–åˆ°æ‰˜ç›˜",
 9996                          "ç¨‹åºä»åœ¨åå°è¿è¡Œ\nåŒå‡»æ‰˜ç›˜å›¾æ ‡å¯æ¢å¤çª—å£"
 9997                      )
 9998                  return
 9999          super().changeEvent(event)
10000      
10001      def closeEvent(self, event):
10002          """çª—å£å…³é—­äº‹ä»¶ï¼Œæ¸…ç†èµ„æº"""
10003          # å¦‚æœå¯ç”¨æ‰˜ç›˜ä¸”ä¸æ˜¯çœŸæ­£é€€å‡ºï¼Œåˆ™éšè—åˆ°æ‰˜ç›˜
10004          if self.minimize_to_tray and self.tray_icon and self.tray_icon.isVisible():
10005              event.ignore()
10006              self.hide()
10007              if self.show_notifications:
10008                  self._show_notification(
10009                      "ç¨‹åºå·²éšè—",
10010                      "ç¨‹åºä»åœ¨åå°è¿è¡Œ\nå³é”®æ‰˜ç›˜å›¾æ ‡å¯é€‰æ‹©é€€å‡º"
10011                  )
10012              return
10013          
10014          # çœŸæ­£é€€å‡ºæ—¶æ¸…ç†èµ„æº
10015          # åœæ­¢ä¸Šä¼ ä»»åŠ¡
10016          if self.worker:
10017              self.worker.stop()
10018          
10019          # å…³é—­æ—¥å¿—çº¿ç¨‹æ± 
10020          try:
10021              self._log_executor.shutdown(wait=False)
10022          except Exception:
10023              pass
10024          
10025          # æ¥å—å…³é—­äº‹ä»¶
10026          event.accept()
10027      
10028      def _setup_single_instance_server(self):
10029          """è®¾ç½®å•ä¾‹å”¤é†’æœåŠ¡å™¨
10030          
10031          ç›‘å¬æ¥è‡ªæ–°å®ä¾‹çš„å”¤é†’è¯·æ±‚ï¼Œæ”¶åˆ°åå°†çª—å£ç½®é¡¶æ¿€æ´»
10032          """
10033          self.local_server = QLocalServer(self)
10034          server_name = "ImageUploadTool_SingleInstance_Server"
10035          
10036          # å…ˆç§»é™¤å¯èƒ½æ®‹ç•™çš„æœåŠ¡å™¨ï¼ˆç¨‹åºå¼‚å¸¸é€€å‡ºæ—¶å¯èƒ½é—ç•™ï¼‰
10037          QLocalServer.removeServer(server_name)
10038          
10039          # å¯åŠ¨æœåŠ¡å™¨
10040          if not self.local_server.listen(server_name):
10041              # æœåŠ¡å™¨å¯åŠ¨å¤±è´¥ï¼Œè®°å½•æ—¥å¿—ä½†ä¸å½±å“ç¨‹åºè¿è¡Œ

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 203 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
10042              self._log_message(f"è­¦å‘Š: å•ä¾‹æœåŠ¡å™¨å¯åŠ¨å¤±è´¥ - {self.local_server.errorString()}")
10043              return
10044          
10045          # è¿æ¥æ–°è¿æ¥ä¿¡å·
10046          self.local_server.newConnection.connect(self._handle_wakeup_request)
10047          self._log_message("å•ä¾‹æœåŠ¡å™¨å·²å¯åŠ¨ï¼Œå¯æ¥æ”¶å”¤é†’è¯·æ±‚")
10048      
10049      def _handle_wakeup_request(self):
10050          """å¤„ç†æ¥è‡ªæ–°å®ä¾‹çš„å”¤é†’è¯·æ±‚"""
10051          # è·å–æ–°è¿æ¥
10052          client_socket = self.local_server.nextPendingConnection()
10053          if not client_socket:
10054              return
10055          
10056          # ç­‰å¾…æ•°æ®åˆ°è¾¾
10057          if client_socket.waitForReadyRead(1000):  # ç­‰å¾…æœ€å¤š1ç§’
10058              data = client_socket.readAll()
10059              # ä½¿ç”¨ Qt çš„æ–¹æ³•è½¬æ¢ä¸º Python å­—ç¬¦ä¸²
10060              message = bytes(data).decode('utf-8', errors='ignore')  # type: ignore[arg-type]
10061              
10062              if message == "WAKEUP":
10063                  # æ”¶åˆ°å”¤é†’è¯·æ±‚ï¼Œæ¿€æ´»çª—å£
10064                  self._activate_window()
10065                  self._log_message("æ”¶åˆ°å”¤é†’è¯·æ±‚ï¼Œå·²æ¿€æ´»çª—å£")
10066          
10067          # å…³é—­è¿æ¥
10068          client_socket.disconnectFromServer()
10069      
10070      def _activate_window(self):
10071          """æ¿€æ´»å¹¶ç½®é¡¶çª—å£"""
10072          # å¦‚æœçª—å£è¢«éšè—ï¼Œå…ˆæ˜¾ç¤º
10073          if self.isHidden():
10074              self.show()
10075          
10076          # å¦‚æœçª—å£è¢«æœ€å°åŒ–ï¼Œæ¢å¤æ­£å¸¸çŠ¶æ€
10077          if self.isMinimized():
10078              self.showNormal()
10079          
10080          # æ¿€æ´»çª—å£ï¼ˆç½®é¡¶å¹¶è·å¾—ç„¦ç‚¹ï¼‰
10081          self.activateWindow()
10082          self.raise_()  # ç¡®ä¿çª—å£åœ¨æœ€å‰é¢
10083          
10084          # åœ¨ Windows ä¸Šï¼Œå¯èƒ½éœ€è¦é¢å¤–çš„æ“ä½œæ¥ç¡®ä¿çª—å£çœŸæ­£ç½®é¡¶
10085          # è®¾ç½®çª—å£æ ‡å¿—å¼ºåˆ¶ç½®é¡¶ï¼Œç„¶åç«‹å³æ¢å¤
10086          self.setWindowFlags(self.windowFlags() | QtCore.Qt.WindowType.WindowStaysOnTopHint)
10087          self.show()
10088          self.setWindowFlags(self.windowFlags() & ~QtCore.Qt.WindowType.WindowStaysOnTopHint)
10089          self.show()
10090  
10091  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 204 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
       
       # ============================================================
       # æ–‡ä»¶: src\ui\widgets.py
       # ============================================================
10092  """è‡ªå®šä¹‰ UI æ§ä»¶æ¨¡å—
10093  
10094  åŒ…å«ï¼š
10095  - Toast: é€šçŸ¥æç¤ºç»„ä»¶
10096  - ChipWidget: æ•°æ®å¡ç‰‡ç»„ä»¶
10097  - CollapsibleBox: å¯æŠ˜å å®¹å™¨ç»„ä»¶
10098  - DiskCleanupDialog: ç£ç›˜æ¸…ç†å¯¹è¯æ¡†
10099  """
10100  
10101  import os
10102  from typing import Optional, List, Tuple, Dict, Any, TYPE_CHECKING, Protocol
10103  
10104  try:
10105      from PySide6 import QtWidgets, QtCore, QtGui
10106      from PySide6.QtCore import Qt
10107      QtEnum = Qt
10108  except ImportError:
10109      from PyQt5 import QtWidgets, QtCore, QtGui  # type: ignore[import-not-found]
10110      from PyQt5.QtCore import Qt  # type: ignore[import-not-found]
10111      QtEnum = QtCore.Qt
10112  
10113  # ç±»å‹æ£€æŸ¥æ—¶çš„åè®®å®šä¹‰
10114  if TYPE_CHECKING:
10115      class MainWindowProtocol(Protocol):
10116          """MainWindow çš„ç±»å‹åè®®ï¼ˆç”¨äºç±»å‹æ£€æŸ¥ï¼‰"""
10117          bak_edit: QtWidgets.QLineEdit
10118          tgt_edit: QtWidgets.QLineEdit
10119          auto_delete_folder: str
10120          enable_auto_delete: bool
10121          auto_delete_threshold: int
10122          auto_delete_keep_days: int
10123          auto_delete_check_interval: int
10124          
10125          def _save_config(self) -> None: ...
10126  
10127  
10128  class Toast(QtWidgets.QWidget):  # type: ignore[misc]
10129      """Toast é€šçŸ¥ç»„ä»¶
10130      
10131      ç”¨äºæ˜¾ç¤ºä¸´æ—¶é€šçŸ¥æ¶ˆæ¯ï¼Œæ”¯æŒä¸åŒç±»å‹çš„æç¤ºæ ·å¼ã€‚
10132      
10133      Args:
10134          parent: çˆ¶çª—å£
10135          message: æç¤ºæ¶ˆæ¯
10136          kind: æç¤ºç±»å‹ ('info', 'success', 'warning', 'danger')
10137          duration_ms: æ˜¾ç¤ºæ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 205 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
10138      
10139      Note: ä½¿ç”¨ type: ignore[misc] æ˜¯å› ä¸º Qt æ¨¡å—åœ¨ try-except ä¸­åŠ¨æ€å¯¼å…¥ï¼Œ
10140      Pylance æ— æ³•åœ¨é™æ€åˆ†ææ—¶ç¡®å®šåŸºç±»æœ‰æ•ˆæ€§ï¼Œä½†è¿è¡Œæ—¶å®Œå…¨æ­£ç¡®ã€‚
10141      """
10142      def __init__(
10143          self,
10144          parent: QtWidgets.QWidget,
10145          message: str,
10146          kind: str = 'info',
10147          duration_ms: int = 2500
10148      ):
10149          super().__init__(parent)
10150          wt = getattr(QtEnum, 'WindowType', QtEnum)
10151          wa = getattr(QtEnum, 'WidgetAttribute', QtEnum)
10152          self.setWindowFlags(
10153              getattr(wt, 'FramelessWindowHint')
10154              | getattr(wt, 'Tool')
10155              | getattr(wt, 'WindowStaysOnTopHint')
10156          )
10157          self.setAttribute(getattr(wa, 'WA_TranslucentBackground'))
10158          colors = {
10159              'info':    ("#E0F2FE", "#039CA1"),
10160              'success': ("#DCFCE7", "#166534"),
10161              'warning': ("#FEF9C3", "#A16207"),
10162              'danger':  ("#FEE2E2", "#B91C1C"),
10163          }
10164          bg, fg = colors.get(kind, colors['info'])
10165          layout = QtWidgets.QHBoxLayout(self)
10166          frame = QtWidgets.QFrame(self)
10167          frame.setStyleSheet(f"QFrame{{background:{bg}; border:1px solid rgba(0,0,0,0.06); border-radius:8px;}}")
10168          inner = QtWidgets.QHBoxLayout(frame)
10169          label = QtWidgets.QLabel(message)
10170          label.setStyleSheet(f"color:{fg}; padding:8px 12px; font-size:11pt;")
10171          inner.addWidget(label)
10172          layout.addWidget(frame)
10173          self.adjustSize()
10174          self._timer = QtCore.QTimer(self)
10175          self._timer.setSingleShot(True)
10176          self._timer.timeout.connect(self.close)
10177          self._timer.start(duration_ms)
10178  
10179      def showEvent(self, e: QtGui.QShowEvent) -> None:
10180          """æ˜¾ç¤ºäº‹ä»¶ï¼Œè‡ªåŠ¨å®šä½åˆ°çˆ¶çª—å£å³ä¸Šè§’"""
10181          if self.parent():
10182              p = self.parent()
10183              geo = p.geometry()
10184              self.adjustSize()
10185              x = geo.x() + geo.width() - self.width() - 16
10186              y = geo.y() + 80
10187              self.move(x, y)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 206 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
10188          return super().showEvent(e)
10189  
10190  
10191  class ChipWidget(QtWidgets.QFrame):  # type: ignore[misc]
10192      """æ•°æ®å¡ç‰‡ç»„ä»¶
10193      
10194      ç”¨äºå±•ç¤ºé”®å€¼å¯¹ä¿¡æ¯ï¼Œå¸¦æœ‰å½©è‰²èƒŒæ™¯å’Œæ ‡é¢˜ã€‚
10195      
10196      Args:
10197          title: æ ‡é¢˜æ–‡æœ¬
10198          val: å€¼æ–‡æœ¬
10199          bg: èƒŒæ™¯é¢œè‰²
10200          fg: å‰æ™¯é¢œè‰²ï¼ˆæ–‡å­—é¢œè‰²ï¼‰
10201          parent: çˆ¶çª—å£
10202      """
10203      value_label: QtWidgets.QLabel
10204      title_label: QtWidgets.QLabel
10205      
10206      def __init__(
10207          self,
10208          title: str,
10209          val: str,
10210          bg: str,
10211          fg: str,
10212          parent: Optional[QtWidgets.QWidget] = None
10213      ):
10214          super().__init__(parent)
10215          self.setStyleSheet(
10216              f"QFrame{{background:{bg}; border-radius:8px; padding:2px;}} "
10217              f"QLabel{{color:{fg};}}"
10218          )
10219          vv = QtWidgets.QVBoxLayout(self)
10220          vv.setSpacing(4)  # å¢åŠ æ ‡é¢˜å’Œå€¼ä¹‹é—´çš„é—´è·
10221          vv.setContentsMargins(10, 8, 10, 8)  # å¢åŠ å†…è¾¹è·
10222          self.title_label = QtWidgets.QLabel(title)
10223          self.title_label.setStyleSheet("font-size:9.5pt; padding-top:2px;")
10224          self.value_label = QtWidgets.QLabel(val)
10225          self.value_label.setStyleSheet("font-weight:700; font-size:11.5pt; padding-bottom:2px;")
10226          vv.addWidget(self.title_label)
10227          vv.addWidget(self.value_label)
10228      
10229      def setValue(self, text: str) -> None:
10230          """æ›´æ–°å¡ç‰‡çš„å€¼æ–‡æœ¬
10231          
10232          Args:
10233              text: æ–°çš„å€¼æ–‡æœ¬
10234          """
10235          self.value_label.setText(text)
10236  
10237  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 207 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
10238  class CollapsibleBox(QtWidgets.QWidget):  # type: ignore[misc]
10239      """å¯æŠ˜å å®¹å™¨ç»„ä»¶
10240      
10241      æä¾›å¯å±•å¼€/æŠ˜å çš„å†…å®¹åŒºåŸŸï¼Œç”¨äºèŠ‚çœç•Œé¢ç©ºé—´ã€‚
10242      
10243      Args:
10244          title: æ ‡é¢˜æ–‡æœ¬
10245          parent: çˆ¶çª—å£
10246      
10247      Note: type: ignore[misc] - Qt åŠ¨æ€å¯¼å…¥å¯¼è‡´çš„ Pylance è¯¯æŠ¥
10248      """
10249      def __init__(self, title: str = "", parent: Optional[QtWidgets.QWidget] = None):
10250          super().__init__(parent)
10251          self.toggle_button = QtWidgets.QToolButton()
10252          self.toggle_button.setStyleSheet("QToolButton { border: none; font-weight: 700; }")
10253          self.toggle_button.setToolButtonStyle(QtCore.Qt.ToolButtonStyle.ToolButtonTextBesideIcon)
10254          self.toggle_button.setArrowType(QtCore.Qt.ArrowType.RightArrow)
10255          self.toggle_button.setText(title)
10256          self.toggle_button.setCheckable(True)
10257          self.toggle_button.setChecked(False)
10258          
10259          self.content_area = QtWidgets.QWidget()
10260          self.content_area.setVisible(False)
10261          self.content_layout = QtWidgets.QVBoxLayout(self.content_area)
10262          self.content_layout.setContentsMargins(20, 8, 8, 8)
10263          
10264          self.toggle_button.toggled.connect(self._on_toggle)
10265          
10266          main_layout = QtWidgets.QVBoxLayout(self)
10267          main_layout.setSpacing(0)
10268          main_layout.setContentsMargins(0, 0, 0, 0)
10269          main_layout.addWidget(self.toggle_button)
10270          main_layout.addWidget(self.content_area)
10271      
10272      def _on_toggle(self, checked: bool) -> None:
10273          """å¤„ç†å±•å¼€/æŠ˜å åˆ‡æ¢"""
10274          self.toggle_button.setArrowType(
10275              QtCore.Qt.ArrowType.DownArrow if checked else QtCore.Qt.ArrowType.RightArrow
10276          )
10277          self.content_area.setVisible(checked)
10278      
10279      def setContentLayout(self, layout: QtWidgets.QLayout) -> None:
10280          """è®¾ç½®å†…å®¹å¸ƒå±€
10281          
10282          Args:
10283              layout: è¦è®¾ç½®çš„å¸ƒå±€
10284          """
10285          # æ¸…é™¤æ—§å¸ƒå±€
10286          old_layout = self.content_area.layout()
10287          if old_layout is not None:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 208 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
10288              QtWidgets.QWidget().setLayout(old_layout)
10289          self.content_area.setLayout(layout)
10290          layout.setContentsMargins(20, 8, 8, 8)
10291      
10292      def addWidget(self, widget: QtWidgets.QWidget) -> None:
10293          """æ·»åŠ  widget åˆ°å†…å®¹åŒºåŸŸ
10294          
10295          Args:
10296              widget: è¦æ·»åŠ çš„ widget
10297          """
10298          self.content_layout.addWidget(widget)
10299      
10300      def addLayout(self, layout: QtWidgets.QLayout) -> None:
10301          """æ·»åŠ  layout åˆ°å†…å®¹åŒºåŸŸ
10302          
10303          Args:
10304              layout: è¦æ·»åŠ çš„ layout
10305          """
10306          self.content_layout.addLayout(layout)
10307  
10308  
10309  class DiskCleanupDialog(QtWidgets.QDialog):  # type: ignore[misc]
10310      """ç£ç›˜æ¸…ç†å¯¹è¯æ¡†
10311      
10312      æ”¯æŒé€‰æ‹©æ–‡ä»¶å¤¹è·¯å¾„å’Œæ–‡ä»¶æ ¼å¼è¿›è¡Œç£ç›˜æ¸…ç†ã€‚
10313      æ•´åˆè‡ªåŠ¨æ¸…ç†é…ç½®åŠŸèƒ½ã€‚
10314      
10315      Args:
10316          parent: çˆ¶çª—å£ï¼ˆMainWindow å®ä¾‹ï¼‰
10317      
10318      Note: type: ignore[misc] - Qt åŠ¨æ€å¯¼å…¥å¯¼è‡´çš„ Pylance è¯¯æŠ¥
10319      """
10320      
10321      def __init__(self, parent: Optional[QtWidgets.QWidget] = None):
10322          super().__init__(parent)
10323          self.setWindowTitle("ğŸ’¿ ç£ç›˜æ¸…ç†å·¥å…·")
10324          self.setModal(True)
10325          self.resize(500, 500)  # å¢åŠ é«˜åº¦ä»¥å®¹çº³è‡ªåŠ¨æ¸…ç†é…ç½®
10326          
10327          # ä¿å­˜çˆ¶çª—å£å¼•ç”¨ï¼Œä½¿ç”¨ Any ç±»å‹é¿å… Pylance è¯¯æŠ¥
10328          self.parent_window: Any = parent  # type: ignore[assignment]
10329          self.files_to_delete: List[Tuple[str, int]] = []  # å¾…åˆ é™¤çš„æ–‡ä»¶åˆ—è¡¨
10330          
10331          self._build_ui()
10332      
10333      def _build_ui(self) -> None:
10334          """æ„å»º UI"""
10335          layout = QtWidgets.QVBoxLayout(self)
10336          layout.setSpacing(15)
10337          layout.setContentsMargins(20, 20, 20, 20)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 209 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
10338          
10339          # æ ‡é¢˜è¯´æ˜
10340          title_label = QtWidgets.QLabel("é€‰æ‹©è¦æ¸…ç†çš„æ–‡ä»¶å¤¹å’Œæ–‡ä»¶ç±»å‹")
10341          title_label.setStyleSheet("font-size: 13pt; font-weight: 700; color: #1976D2;")
10342          layout.addWidget(title_label)
10343          
10344          desc_label = QtWidgets.QLabel(
10345              "âš ï¸ è­¦å‘Šï¼šåˆ é™¤çš„æ–‡ä»¶å°†æ— æ³•æ¢å¤ï¼è¯·ç¡®è®¤åå†æ‰§è¡Œæ¸…ç†æ“ä½œã€‚"
10346          )
10347          desc_label.setStyleSheet("color: #D32F2F; padding: 8px; background: #FFEBEE; border-radius: 6px;")
10348          desc_label.setWordWrap(True)
10349          layout.addWidget(desc_label)
10350          
10351          # æ–‡ä»¶å¤¹é€‰æ‹©åŒºåŸŸ
10352          folder_group = self._create_folder_selection_group()
10353          layout.addWidget(folder_group)
10354          
10355          # æ–‡ä»¶æ ¼å¼é€‰æ‹©åŒºåŸŸ
10356          format_group = self._create_format_selection_group()
10357          layout.addWidget(format_group)
10358          
10359          # è‡ªåŠ¨æ¸…ç†é…ç½®åŒºåŸŸ
10360          auto_group = self._create_auto_cleanup_group()
10361          layout.addWidget(auto_group)
10362          
10363          # æ‰«æç»“æœåŒºåŸŸ
10364          result_group = self._create_result_group()
10365          layout.addWidget(result_group)
10366          
10367          # æŒ‰é’®åŒºåŸŸ
10368          button_layout = self._create_button_layout()
10369          layout.addLayout(button_layout)
10370      
10371      def _create_folder_selection_group(self) -> QtWidgets.QGroupBox:
10372          """åˆ›å»ºæ–‡ä»¶å¤¹é€‰æ‹©åŒºåŸŸ"""
10373          folder_group = QtWidgets.QGroupBox("ğŸ“ é€‰æ‹©æ¸…ç†ç›®æ ‡")
10374          folder_group.setStyleSheet(
10375              "QGroupBox { font-weight: 700; border: 2px solid #64B5F6; "
10376              "border-radius: 8px; margin-top: 10px; padding-top: 15px; }"
10377              "QGroupBox::title { subcontrol-origin: margin; left: 10px; padding: 0 5px; }"
10378          )
10379          folder_layout = QtWidgets.QVBoxLayout(folder_group)
10380          folder_layout.setSpacing(12)
10381          
10382          # ä»çˆ¶çª—å£çš„è¾“å…¥æ¡†è¯»å–è·¯å¾„é…ç½®ï¼ˆå®æ—¶è¯»å–æœ€æ–°å€¼ï¼‰
10383          backup_path = self.parent_window.bak_edit.text() if self.parent_window and hasattr(self.parent_window, 'bak_edit') else ""
10384          target_path = self.parent_window.tgt_edit.text() if self.parent_window and hasattr(self.parent_window, 'tgt_edit') else ""
10385          monitor_path = self.parent_window.auto_delete_folder if self.parent_window and hasattr(self.parent_window, 'auto_delete_folder') else ""
10386          
10387          # å¤‡ä»½æ–‡ä»¶å¤¹

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 210 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
10388          self.cb_backup = QtWidgets.QCheckBox(f"ğŸ—‚ï¸ å¤‡ä»½æ–‡ä»¶å¤¹")
10389          self.cb_backup.setChecked(True)
10390          if backup_path:
10391              self.cb_backup.setText(f"ğŸ—‚ï¸ å¤‡ä»½æ–‡ä»¶å¤¹: {backup_path}")
10392              self.cb_backup.setToolTip(backup_path)
10393          else:
10394              self.cb_backup.setEnabled(False)
10395              self.cb_backup.setText("ğŸ—‚ï¸ å¤‡ä»½æ–‡ä»¶å¤¹ (æœªé…ç½®)")
10396          folder_layout.addWidget(self.cb_backup)
10397          
10398          # ç›®æ ‡æ–‡ä»¶å¤¹
10399          self.cb_target = QtWidgets.QCheckBox(f"ğŸ“¤ ç›®æ ‡æ–‡ä»¶å¤¹ (æœåŠ¡å™¨)")
10400          if target_path:
10401              self.cb_target.setText(f"ğŸ“¤ ç›®æ ‡æ–‡ä»¶å¤¹: {target_path}")
10402              self.cb_target.setToolTip(target_path)
10403          else:
10404              self.cb_target.setEnabled(False)
10405              self.cb_target.setText("ğŸ“¤ ç›®æ ‡æ–‡ä»¶å¤¹ (æœªé…ç½®)")
10406          folder_layout.addWidget(self.cb_target)
10407          
10408          # ç›‘æ§æ–‡ä»¶å¤¹ï¼ˆå¸¦è¾“å…¥åŠŸèƒ½ï¼‰
10409          self.cb_monitor = QtWidgets.QCheckBox("ğŸ” ç›‘æ§æ–‡ä»¶å¤¹")
10410          folder_layout.addWidget(self.cb_monitor)
10411          
10412          monitor_row = QtWidgets.QHBoxLayout()
10413          monitor_row.setContentsMargins(30, 0, 0, 0)
10414          self.edit_monitor = QtWidgets.QLineEdit(monitor_path)
10415          self.edit_monitor.setPlaceholderText("é€‰æ‹©ç›‘æ§æ–‡ä»¶å¤¹è·¯å¾„...")
10416          btn_monitor = QtWidgets.QPushButton("æµè§ˆ")
10417          btn_monitor.setProperty("class", "Secondary")
10418          btn_monitor.clicked.connect(self._choose_monitor)
10419          monitor_row.addWidget(self.edit_monitor, 1)
10420          monitor_row.addWidget(btn_monitor)
10421          folder_layout.addLayout(monitor_row)
10422          
10423          # è‡ªå®šä¹‰æ–‡ä»¶å¤¹ï¼ˆä¿ç•™è¾“å…¥åŠŸèƒ½ï¼‰
10424          self.cb_custom = QtWidgets.QCheckBox("ğŸ“‚ è‡ªå®šä¹‰æ–‡ä»¶å¤¹")
10425          folder_layout.addWidget(self.cb_custom)
10426          
10427          custom_row = QtWidgets.QHBoxLayout()
10428          custom_row.setContentsMargins(30, 0, 0, 0)
10429          self.edit_custom = QtWidgets.QLineEdit()
10430          self.edit_custom.setPlaceholderText("é€‰æ‹©è‡ªå®šä¹‰æ–‡ä»¶å¤¹è·¯å¾„...")
10431          btn_custom = QtWidgets.QPushButton("æµè§ˆ")
10432          btn_custom.setProperty("class", "Secondary")
10433          btn_custom.clicked.connect(self._choose_custom)
10434          custom_row.addWidget(self.edit_custom, 1)
10435          custom_row.addWidget(btn_custom)
10436          folder_layout.addLayout(custom_row)
10437          

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 211 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
10438          return folder_group
10439      
10440      def _create_format_selection_group(self) -> QtWidgets.QGroupBox:
10441          """åˆ›å»ºæ–‡ä»¶æ ¼å¼é€‰æ‹©åŒºåŸŸ"""
10442          format_group = QtWidgets.QGroupBox("ğŸ“‹ é€‰æ‹©æ–‡ä»¶æ ¼å¼")
10443          format_group.setStyleSheet(
10444              "QGroupBox { font-weight: 700; border: 2px solid #64B5F6; "
10445              "border-radius: 8px; margin-top: 10px; padding-top: 15px; }"
10446              "QGroupBox::title { subcontrol-origin: margin; left: 10px; padding: 0 5px; }"
10447          )
10448          format_layout = QtWidgets.QVBoxLayout(format_group)
10449          format_layout.setSpacing(10)
10450          
10451          # å¿«é€Ÿé€‰æ‹©æŒ‰é’®
10452          quick_row = QtWidgets.QHBoxLayout()
10453          btn_all = QtWidgets.QPushButton("å…¨é€‰")
10454          btn_all.setProperty("class", "Secondary")
10455          btn_all.clicked.connect(self._select_all_formats)
10456          btn_none = QtWidgets.QPushButton("å–æ¶ˆå…¨é€‰")
10457          btn_none.setProperty("class", "Secondary")
10458          btn_none.clicked.connect(self._select_no_formats)
10459          btn_image = QtWidgets.QPushButton("ä»…å›¾ç‰‡")
10460          btn_image.setProperty("class", "Secondary")
10461          btn_image.clicked.connect(self._select_image_formats)
10462          quick_row.addWidget(btn_all)
10463          quick_row.addWidget(btn_none)
10464          quick_row.addWidget(btn_image)
10465          quick_row.addStretch()
10466          format_layout.addLayout(quick_row)
10467          
10468          # æ–‡ä»¶æ ¼å¼å¤é€‰æ¡† - ç½‘æ ¼å¸ƒå±€
10469          formats_grid = QtWidgets.QGridLayout()
10470          formats_grid.setSpacing(8)
10471          
10472          self.format_checkboxes: Dict[str, QtWidgets.QCheckBox] = {}
10473          formats = [
10474              ('.jpg', 'å›¾ç‰‡'),
10475              ('.jpeg', 'å›¾ç‰‡'),
10476              ('.png', 'å›¾ç‰‡'),
10477              ('.bmp', 'å›¾ç‰‡'),
10478              ('.gif', 'å›¾ç‰‡'),
10479              ('.tiff', 'å›¾ç‰‡'),
10480              ('.tif', 'å›¾ç‰‡'),
10481              ('.raw', 'å›¾ç‰‡'),
10482              ('.pdf', 'æ–‡æ¡£'),
10483              ('.doc', 'æ–‡æ¡£'),
10484              ('.docx', 'æ–‡æ¡£'),
10485              ('.txt', 'æ–‡æœ¬'),
10486              ('.log', 'æ—¥å¿—'),
10487              ('.zip', 'å‹ç¼©'),

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 212 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
10488              ('.rar', 'å‹ç¼©'),
10489              ('.tmp', 'ä¸´æ—¶'),
10490          ]
10491          
10492          for idx, (ext, category) in enumerate(formats):
10493              cb = QtWidgets.QCheckBox(f"{ext} ({category})")
10494              cb.setChecked(ext in ['.jpg', '.jpeg', '.png', '.bmp', '.gif', '.tiff', '.tif', '.raw'])  # é»˜è®¤é€‰ä¸­å›¾ç‰‡
10495              self.format_checkboxes[ext] = cb
10496              row = idx // 4
10497              col = idx % 4
10498              formats_grid.addWidget(cb, row, col)
10499          
10500          format_layout.addLayout(formats_grid)
10501          
10502          # è‡ªå®šä¹‰æ ¼å¼
10503          custom_format_row = QtWidgets.QHBoxLayout()
10504          custom_format_label = QtWidgets.QLabel("è‡ªå®šä¹‰æ ¼å¼:")
10505          self.edit_custom_format = QtWidgets.QLineEdit()
10506          self.edit_custom_format.setPlaceholderText("ä¾‹å¦‚: .bak æˆ– .old (ä»¥ç‚¹å¼€å¤´)")
10507          custom_format_row.addWidget(custom_format_label)
10508          custom_format_row.addWidget(self.edit_custom_format, 1)
10509          format_layout.addLayout(custom_format_row)
10510          
10511          return format_group
10512      
10513      def _create_auto_cleanup_group(self) -> QtWidgets.QGroupBox:
10514          """åˆ›å»ºè‡ªåŠ¨æ¸…ç†é…ç½®åŒºåŸŸ"""
10515          auto_group = QtWidgets.QGroupBox("âš™ï¸ è‡ªåŠ¨æ¸…ç†é…ç½®")
10516          auto_group.setStyleSheet(
10517              "QGroupBox { font-weight: 700; border: 2px solid #FFA726; "
10518              "border-radius: 8px; margin-top: 10px; padding-top: 15px; }"
10519              "QGroupBox::title { subcontrol-origin: margin; left: 10px; padding: 0 5px; }"
10520          )
10521          auto_layout = QtWidgets.QVBoxLayout(auto_group)
10522          auto_layout.setSpacing(10)
10523          
10524          # å¯ç”¨è‡ªåŠ¨æ¸…ç†
10525          self.cb_enable_auto = QtWidgets.QCheckBox("â° å¯ç”¨è‡ªåŠ¨æ¸…ç†")
10526          auto_enabled = self.parent_window.enable_auto_delete if self.parent_window and hasattr(self.parent_window, 'enable_auto_delete') else False
10527          self.cb_enable_auto.setChecked(auto_enabled)
10528          self.cb_enable_auto.toggled.connect(self._on_auto_clean_toggled)
10529          auto_layout.addWidget(self.cb_enable_auto)
10530          
10531          # é…ç½®å‚æ•°
10532          config_grid = QtWidgets.QGridLayout()
10533          config_grid.setSpacing(10)
10534          
10535          # ç£ç›˜é˜ˆå€¼
10536          threshold_label = QtWidgets.QLabel("ç£ç›˜é˜ˆå€¼:")
10537          self.spin_threshold = QtWidgets.QSpinBox()

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 213 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
10538          self.spin_threshold.setRange(50, 95)
10539          auto_threshold = self.parent_window.auto_delete_threshold if self.parent_window and hasattr(self.parent_window, 'auto_delete_threshold') else 80
10540          self.spin_threshold.setValue(auto_threshold)
10541          self.spin_threshold.setSuffix(" %")
10542          self.spin_threshold.setToolTip("ç£ç›˜ä½¿ç”¨ç‡è¾¾åˆ°æ­¤å€¼æ—¶è‡ªåŠ¨æ¸…ç†")
10543          self.spin_threshold.setEnabled(auto_enabled)
10544          config_grid.addWidget(threshold_label, 0, 0)
10545          config_grid.addWidget(self.spin_threshold, 0, 1)
10546          
10547          # ä¿ç•™å¤©æ•°
10548          days_label = QtWidgets.QLabel("ä¿ç•™å¤©æ•°:")
10549          self.spin_keep_days = QtWidgets.QSpinBox()
10550          self.spin_keep_days.setRange(1, 365)
10551          auto_days = self.parent_window.auto_delete_keep_days if self.parent_window and hasattr(self.parent_window, 'auto_delete_keep_days') else 10
10552          self.spin_keep_days.setValue(auto_days)
10553          self.spin_keep_days.setSuffix(" å¤©")
10554          self.spin_keep_days.setToolTip("åªåˆ é™¤è¶…è¿‡æ­¤å¤©æ•°çš„æ–‡ä»¶")
10555          self.spin_keep_days.setEnabled(auto_enabled)
10556          config_grid.addWidget(days_label, 0, 2)
10557          config_grid.addWidget(self.spin_keep_days, 0, 3)
10558          
10559          # æ£€æŸ¥é—´éš”
10560          interval_label = QtWidgets.QLabel("æ£€æŸ¥é—´éš”:")
10561          self.spin_check_interval = QtWidgets.QSpinBox()
10562          self.spin_check_interval.setRange(60, 3600)
10563          auto_interval = self.parent_window.auto_delete_check_interval if self.parent_window and hasattr(self.parent_window, 'auto_delete_check_interval') else 300
10564          self.spin_check_interval.setValue(auto_interval)
10565          self.spin_check_interval.setSuffix(" ç§’")
10566          self.spin_check_interval.setToolTip("è‡ªåŠ¨æ£€æŸ¥çš„æ—¶é—´é—´éš”")
10567          self.spin_check_interval.setEnabled(auto_enabled)
10568          config_grid.addWidget(interval_label, 1, 0)
10569          config_grid.addWidget(self.spin_check_interval, 1, 1)
10570          
10571          auto_layout.addLayout(config_grid)
10572          
10573          # è¯´æ˜æ–‡æœ¬
10574          auto_hint = QtWidgets.QLabel(
10575              "ğŸ’¡ å¯ç”¨åï¼Œç¨‹åºä¼šå®šæœŸæ£€æŸ¥ç£ç›˜ç©ºé—´ï¼Œå½“è¾¾åˆ°é˜ˆå€¼æ—¶è‡ªåŠ¨åˆ é™¤è¶…è¿‡ä¿ç•™æœŸé™çš„æ–‡ä»¶"
10576          )
10577          auto_hint.setStyleSheet("color: #757575; font-size: 9px; padding: 8px;")
10578          auto_hint.setWordWrap(True)
10579          auto_layout.addWidget(auto_hint)
10580          
10581          # ä¿å­˜é…ç½®æŒ‰é’®
10582          btn_save_auto = QtWidgets.QPushButton("ğŸ’¾ ä¿å­˜è‡ªåŠ¨æ¸…ç†é…ç½®")
10583          btn_save_auto.setProperty("class", "Secondary")
10584          btn_save_auto.clicked.connect(self._save_auto_config)
10585          auto_layout.addWidget(btn_save_auto)
10586          
10587          return auto_group

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 214 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
10588      
10589      def _create_result_group(self) -> QtWidgets.QGroupBox:
10590          """åˆ›å»ºæ‰«æç»“æœåŒºåŸŸ"""
10591          result_group = QtWidgets.QGroupBox("ğŸ“Š æ‰«æç»“æœ")
10592          result_group.setStyleSheet(
10593              "QGroupBox { font-weight: 700; border: 2px solid #64B5F6; "
10594              "border-radius: 8px; margin-top: 10px; padding-top: 15px; }"
10595              "QGroupBox::title { subcontrol-origin: margin; left: 10px; padding: 0 5px; }"
10596          )
10597          result_layout = QtWidgets.QVBoxLayout(result_group)
10598          
10599          self.result_text = QtWidgets.QPlainTextEdit()
10600          self.result_text.setReadOnly(True)
10601          self.result_text.setMaximumHeight(120)
10602          self.result_text.setPlainText("ç‚¹å‡» 'æ‰«ææ–‡ä»¶' å¼€å§‹æŸ¥æ‰¾å¯æ¸…ç†çš„æ–‡ä»¶...")
10603          result_layout.addWidget(self.result_text)
10604          
10605          return result_group
10606      
10607      def _create_button_layout(self) -> QtWidgets.QHBoxLayout:
10608          """åˆ›å»ºæŒ‰é’®å¸ƒå±€"""
10609          button_layout = QtWidgets.QHBoxLayout()
10610          button_layout.setSpacing(12)
10611          
10612          self.btn_scan = QtWidgets.QPushButton("ğŸ” æ‰«ææ–‡ä»¶")
10613          self.btn_scan.setProperty("class", "Primary")
10614          self.btn_scan.setMinimumHeight(40)
10615          self.btn_scan.clicked.connect(self._scan_files)
10616          
10617          self.btn_delete = QtWidgets.QPushButton("ğŸ—‘ï¸ æ‰§è¡Œæ¸…ç†")
10618          self.btn_delete.setProperty("class", "Danger")
10619          self.btn_delete.setMinimumHeight(40)
10620          self.btn_delete.setEnabled(False)
10621          self.btn_delete.clicked.connect(self._delete_files)
10622          
10623          btn_close = QtWidgets.QPushButton("âŒ å…³é—­")
10624          btn_close.setProperty("class", "Secondary")
10625          btn_close.setMinimumHeight(40)
10626          btn_close.clicked.connect(self.reject)
10627          
10628          button_layout.addWidget(self.btn_scan)
10629          button_layout.addWidget(self.btn_delete)
10630          button_layout.addStretch()
10631          button_layout.addWidget(btn_close)
10632          
10633          return button_layout
10634      
10635      # äº‹ä»¶å¤„ç†æ–¹æ³•
10636      
10637      def _choose_custom(self) -> None:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 215 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
10638          """é€‰æ‹©è‡ªå®šä¹‰æ–‡ä»¶å¤¹"""
10639          path = QtWidgets.QFileDialog.getExistingDirectory(self, "é€‰æ‹©è‡ªå®šä¹‰æ–‡ä»¶å¤¹")
10640          if path:
10641              self.edit_custom.setText(path)
10642      
10643      def _choose_monitor(self) -> None:
10644          """é€‰æ‹©ç›‘æ§æ–‡ä»¶å¤¹"""
10645          path = QtWidgets.QFileDialog.getExistingDirectory(self, "é€‰æ‹©ç›‘æ§æ–‡ä»¶å¤¹")
10646          if path:
10647              self.edit_monitor.setText(path)
10648      
10649      def _select_all_formats(self) -> None:
10650          """å…¨é€‰æ‰€æœ‰æ–‡ä»¶æ ¼å¼"""
10651          for cb in self.format_checkboxes.values():
10652              cb.setChecked(True)
10653      
10654      def _select_no_formats(self) -> None:
10655          """å–æ¶ˆé€‰æ‹©æ‰€æœ‰æ–‡ä»¶æ ¼å¼"""
10656          for cb in self.format_checkboxes.values():
10657              cb.setChecked(False)
10658      
10659      def _select_image_formats(self) -> None:
10660          """ä»…é€‰æ‹©å›¾ç‰‡æ ¼å¼"""
10661          image_formats = ['.jpg', '.jpeg', '.png', '.bmp', '.gif', '.tiff', '.tif', '.raw']
10662          for ext, cb in self.format_checkboxes.items():
10663              cb.setChecked(ext in image_formats)
10664      
10665      def _on_auto_clean_toggled(self, checked: bool) -> None:
10666          """è‡ªåŠ¨æ¸…ç†å¼€å…³åˆ‡æ¢"""
10667          self.spin_threshold.setEnabled(checked)
10668          self.spin_keep_days.setEnabled(checked)
10669          self.spin_check_interval.setEnabled(checked)
10670      
10671      def _save_auto_config(self) -> None:
10672          """ä¿å­˜è‡ªåŠ¨æ¸…ç†é…ç½®åˆ°çˆ¶çª—å£"""
10673          if not self.parent_window:
10674              return
10675          
10676          try:
10677              # æ›´æ–°çˆ¶çª—å£çš„è‡ªåŠ¨åˆ é™¤é…ç½®
10678              self.parent_window.enable_auto_delete = self.cb_enable_auto.isChecked()
10679              self.parent_window.auto_delete_folder = self.edit_monitor.text().strip()  # ä¿å­˜ç›‘æ§æ–‡ä»¶å¤¹è·¯å¾„
10680              self.parent_window.auto_delete_threshold = self.spin_threshold.value()
10681              self.parent_window.auto_delete_keep_days = self.spin_keep_days.value()
10682              self.parent_window.auto_delete_check_interval = self.spin_check_interval.value()
10683              
10684              # ä¿å­˜é…ç½®åˆ°æ–‡ä»¶
10685              self.parent_window._save_config()
10686              
10687              # æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 216 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
10688              QtWidgets.QMessageBox.information(
10689                  self,
10690                  "âœ… é…ç½®å·²ä¿å­˜",
10691                  f"è‡ªåŠ¨æ¸…ç†é…ç½®å·²æˆåŠŸä¿å­˜ï¼\n\n"
10692                  f"å¯ç”¨çŠ¶æ€: {'æ˜¯' if self.cb_enable_auto.isChecked() else 'å¦'}\n"
10693                  f"ç›‘æ§æ–‡ä»¶å¤¹: {self.edit_monitor.text().strip() or 'æœªè®¾ç½®'}\n"
10694                  f"ç£ç›˜é˜ˆå€¼: {self.spin_threshold.value()}%\n"
10695                  f"ä¿ç•™å¤©æ•°: {self.spin_keep_days.value()}å¤©\n"
10696                  f"æ£€æŸ¥é—´éš”: {self.spin_check_interval.value()}ç§’"
10697              )
10698          except Exception as e:
10699              QtWidgets.QMessageBox.warning(
10700                  self,
10701                  "âŒ ä¿å­˜å¤±è´¥",
10702                  f"ä¿å­˜é…ç½®æ—¶å‡ºé”™ï¼š{e}"
10703              )
10704      
10705      def _scan_files(self) -> None:
10706          """æ‰«æç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶"""
10707          self.files_to_delete = []
10708          self.result_text.clear()
10709          
10710          # è·å–è¦æ‰«æçš„æ–‡ä»¶å¤¹ï¼ˆä»çˆ¶çª—å£è¾“å…¥æ¡†è¯»å–æœ€æ–°è·¯å¾„ï¼‰
10711          folders_to_scan = []
10712          if self.cb_backup.isChecked() and self.parent_window and hasattr(self.parent_window, 'bak_edit'):
10713              backup_path = self.parent_window.bak_edit.text().strip()
10714              if backup_path:
10715                  folders_to_scan.append(backup_path)
10716          if self.cb_target.isChecked() and self.parent_window and hasattr(self.parent_window, 'tgt_edit'):
10717              target_path = self.parent_window.tgt_edit.text().strip()
10718              if target_path:
10719                  folders_to_scan.append(target_path)
10720          if self.cb_monitor.isChecked() and self.edit_monitor.text().strip():
10721              monitor_path = self.edit_monitor.text().strip()
10722              if monitor_path:
10723                  folders_to_scan.append(monitor_path)
10724          if self.cb_custom.isChecked() and self.edit_custom.text().strip():
10725              folders_to_scan.append(self.edit_custom.text().strip())
10726          
10727          if not folders_to_scan:
10728              self.result_text.setPlainText("âŒ é”™è¯¯ï¼šè¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼")
10729              return
10730          
10731          # è·å–è¦æ‰«æçš„æ–‡ä»¶æ ¼å¼
10732          formats_to_scan = []
10733          for ext, cb in self.format_checkboxes.items():
10734              if cb.isChecked():
10735                  formats_to_scan.append(ext.lower())
10736          
10737          # æ·»åŠ è‡ªå®šä¹‰æ ¼å¼

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 217 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
10738          custom_format = self.edit_custom_format.text().strip()
10739          if custom_format:
10740              if not custom_format.startswith('.'):
10741                  custom_format = '.' + custom_format
10742              formats_to_scan.append(custom_format.lower())
10743          
10744          if not formats_to_scan:
10745              self.result_text.setPlainText("âŒ é”™è¯¯ï¼šè¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶æ ¼å¼ï¼")
10746              return
10747          
10748          # å¼€å§‹æ‰«æ
10749          self.result_text.appendPlainText("ğŸ” å¼€å§‹æ‰«æ...\n")
10750          self.result_text.appendPlainText(f"æ‰«æç›®å½•: {len(folders_to_scan)} ä¸ª")
10751          self.result_text.appendPlainText(f"æ–‡ä»¶æ ¼å¼: {', '.join(formats_to_scan)}\n")
10752          
10753          total_size = 0
10754          for folder in folders_to_scan:
10755              if not os.path.exists(folder):
10756                  self.result_text.appendPlainText(f"âš ï¸ è·³è¿‡ä¸å­˜åœ¨çš„è·¯å¾„: {folder}")
10757                  continue
10758              
10759              self.result_text.appendPlainText(f"\nğŸ“ æ‰«æ: {folder}")
10760              folder_count = 0
10761              folder_size = 0
10762              
10763              try:
10764                  for root, dirs, files in os.walk(folder):
10765                      for file in files:
10766                          file_lower = file.lower()
10767                          if any(file_lower.endswith(ext) for ext in formats_to_scan):
10768                              file_path = os.path.join(root, file)
10769                              try:
10770                                  file_size = os.path.getsize(file_path)
10771                                  self.files_to_delete.append((file_path, file_size))
10772                                  folder_count += 1
10773                                  folder_size += file_size
10774                              except Exception as e:
10775                                  self.result_text.appendPlainText(f"  âš ï¸ æ— æ³•è®¿é—®: {file} ({e})")
10776                  
10777                  self.result_text.appendPlainText(
10778                      f"  æ‰¾åˆ° {folder_count} ä¸ªæ–‡ä»¶ï¼Œ"
10779                      f"å…± {folder_size / (1024*1024):.2f} MB"
10780                  )
10781                  total_size += folder_size
10782              except Exception as e:
10783                  self.result_text.appendPlainText(f"  âŒ æ‰«æå¤±è´¥: {e}")
10784          
10785          # æ˜¾ç¤ºæ±‡æ€»
10786          self.result_text.appendPlainText("\n" + "="*50)
10787          self.result_text.appendPlainText(

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 218 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
10788              f"ğŸ“Š æ‰«æå®Œæˆï¼å…±æ‰¾åˆ° {len(self.files_to_delete)} ä¸ªæ–‡ä»¶"
10789          )
10790          self.result_text.appendPlainText(
10791              f"ğŸ’¾ æ€»å¤§å°: {total_size / (1024*1024):.2f} MB "
10792              f"({total_size / (1024*1024*1024):.3f} GB)"
10793          )
10794          
10795          # å¯ç”¨åˆ é™¤æŒ‰é’®
10796          self.btn_delete.setEnabled(len(self.files_to_delete) > 0)
10797      
10798      def _delete_files(self) -> None:
10799          """åˆ é™¤æ‰«æåˆ°çš„æ–‡ä»¶"""
10800          if not self.files_to_delete:
10801              return
10802          
10803          # ç¡®è®¤å¯¹è¯æ¡†
10804          total_size = sum(size for _, size in self.files_to_delete)
10805          reply = QtWidgets.QMessageBox.warning(
10806              self,
10807              "âš ï¸ ç¡®è®¤åˆ é™¤",
10808              f"ç¡®å®šè¦åˆ é™¤ {len(self.files_to_delete)} ä¸ªæ–‡ä»¶å—ï¼Ÿ\n\n"
10809              f"æ€»å¤§å°: {total_size / (1024*1024):.2f} MB\n\n"
10810              f"âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œä¸å¯æ¢å¤ï¼",
10811              QtWidgets.QMessageBox.StandardButton.Yes | QtWidgets.QMessageBox.StandardButton.No,
10812              QtWidgets.QMessageBox.StandardButton.No
10813          )
10814          
10815          if reply != QtWidgets.QMessageBox.StandardButton.Yes:
10816              return
10817          
10818          # æ‰§è¡Œåˆ é™¤
10819          self.result_text.appendPlainText("\n" + "="*50)
10820          self.result_text.appendPlainText("ğŸ—‘ï¸ å¼€å§‹åˆ é™¤æ–‡ä»¶...\n")
10821          
10822          deleted_count = 0
10823          deleted_size = 0
10824          failed_count = 0
10825          
10826          for file_path, file_size in self.files_to_delete:
10827              try:
10828                  os.remove(file_path)
10829                  deleted_count += 1
10830                  deleted_size += file_size
10831              except Exception as e:
10832                  failed_count += 1
10833                  self.result_text.appendPlainText(f"âŒ åˆ é™¤å¤±è´¥: {file_path}\n   é”™è¯¯: {e}")
10834          
10835          # æ˜¾ç¤ºç»“æœ
10836          self.result_text.appendPlainText("\n" + "="*50)
10837          self.result_text.appendPlainText("âœ… æ¸…ç†å®Œæˆï¼\n")

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 219 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
10838          self.result_text.appendPlainText(f"æˆåŠŸåˆ é™¤: {deleted_count} ä¸ªæ–‡ä»¶")
10839          self.result_text.appendPlainText(
10840              f"é‡Šæ”¾ç©ºé—´: {deleted_size / (1024*1024):.2f} MB "
10841              f"({deleted_size / (1024*1024*1024):.3f} GB)"
10842          )
10843          if failed_count > 0:
10844              self.result_text.appendPlainText(f"åˆ é™¤å¤±è´¥: {failed_count} ä¸ªæ–‡ä»¶")
10845          
10846          # æ¸…ç©ºå¾…åˆ é™¤åˆ—è¡¨å¹¶ç¦ç”¨åˆ é™¤æŒ‰é’®
10847          self.files_to_delete = []
10848          self.btn_delete.setEnabled(False)
10849          
10850          # æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
10851          QtWidgets.QMessageBox.information(
10852              self,
10853              "âœ… æ¸…ç†å®Œæˆ",
10854              f"æˆåŠŸåˆ é™¤ {deleted_count} ä¸ªæ–‡ä»¶\n"
10855              f"é‡Šæ”¾ç©ºé—´ {deleted_size / (1024*1024):.2f} MB"
10856          )
       
       # ============================================================
       # æ–‡ä»¶: src\workers\__init__.py
       # ============================================================
10857  # -*- coding: utf-8 -*-
10858  """
10859  Workers æ¨¡å— - åå°å·¥ä½œçº¿ç¨‹
10860  
10861  åŒ…å«ï¼š
10862  - upload_worker.py: ä¸Šä¼ å·¥ä½œçº¿ç¨‹ï¼ˆUploadWorkerï¼‰
10863  """
10864  
10865  from .upload_worker import UploadWorker
10866  
10867  __all__ = ['UploadWorker']
       
       # ============================================================
       # æ–‡ä»¶: src\workers\upload_worker.py
       # ============================================================
10868  """ä¸Šä¼ ä»»åŠ¡ Worker æ¨¡å—
10869  
10870  åŒ…å«æ–‡ä»¶ä¸Šä¼ çš„æ ¸å¿ƒé€»è¾‘ï¼Œæ”¯æŒï¼š
10871  - å¤šåè®®ä¸Šä¼ ï¼ˆSMBã€FTPå®¢æˆ·ç«¯ï¼‰
10872  - ç½‘ç»œç›‘æ§å’Œè‡ªåŠ¨æš‚åœ/æ¢å¤
10873  - æ™ºèƒ½å»é‡ï¼ˆMD5/SHA256ï¼‰
10874  - é€Ÿç‡é™åˆ¶
10875  - å¤±è´¥é‡è¯•æœºåˆ¶
10876  - å¼‚æ­¥å½’æ¡£
10877  """
10878  
10879  import os

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 220 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
10880  import sys
10881  import time
10882  import shutil
10883  import threading
10884  import datetime
10885  import queue
10886  import hashlib
10887  from pathlib import Path
10888  from typing import List, Tuple, Optional, Dict, Any
10889  from concurrent.futures import ThreadPoolExecutor, TimeoutError as FuturesTimeoutError
10890  
10891  # å¯¼å…¥ Qt åº“
10892  try:
10893      from PySide6 import QtCore
10894      Signal = QtCore.Signal
10895  except ImportError:
10896      from PyQt5 import QtCore  # type: ignore[import-not-found]
10897      Signal = QtCore.pyqtSignal
10898  
10899  # å¯¼å…¥ FTP å®¢æˆ·ç«¯
10900  try:
10901      from src.protocols.ftp import FTPClientUploader
10902      FTP_AVAILABLE = True
10903  except ImportError:
10904      FTP_AVAILABLE = False
10905      FTPClientUploader = None  # type: ignore[assignment, misc]
10906  
10907  
10908  class UploadWorker(QtCore.QObject):  # type: ignore[misc]
10909      """æ–‡ä»¶ä¸Šä¼  Worker
10910      
10911      åå°çº¿ç¨‹æ‰§è¡Œæ–‡ä»¶ä¸Šä¼ ä»»åŠ¡ï¼Œæ”¯æŒå¤šç§åè®®å’Œé«˜çº§åŠŸèƒ½ã€‚
10912      
10913      Signals:
10914          log: æ—¥å¿—æ¶ˆæ¯
10915          stats: ç»Ÿè®¡ä¿¡æ¯ (uploaded, failed, skipped, rate)
10916          progress: è¿›åº¦ä¿¡æ¯ (current, total, filename)
10917          file_progress: å•æ–‡ä»¶è¿›åº¦ (filename, percent)
10918          network_status: ç½‘ç»œçŠ¶æ€ ('good'|'unstable'|'disconnected')
10919          finished: ä»»åŠ¡å®Œæˆ
10920          status: è¿è¡ŒçŠ¶æ€ ('running'|'paused'|'stopped')
10921          ask_user_duplicate: è¯·æ±‚ç”¨æˆ·å¤„ç†é‡å¤æ–‡ä»¶
10922          upload_error: ä¸Šä¼ é”™è¯¯ (filename, error_message)
10923          disk_warning: ç£ç›˜ç©ºé—´è­¦å‘Š (target_percent, backup_percent, threshold)
10924      
10925      Note: type: ignore[misc] - Qt åŠ¨æ€å¯¼å…¥å¯¼è‡´çš„ Pylance è¯¯æŠ¥
10926      """
10927      
10928      # Signals
10929      log = Signal(str)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 221 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
10930      stats = Signal(int, int, int, str)   # uploaded, failed, skipped, rate
10931      progress = Signal(int, int, str)     # current, total, filename
10932      file_progress = Signal(str, int)     # current_file, progress_percent
10933      network_status = Signal(str)         # 'good'|'unstable'|'disconnected'
10934      finished = Signal()
10935      status = Signal(str)                 # 'running'|'paused'|'stopped'
10936      ask_user_duplicate = Signal(object)  # payload dict
10937      upload_error = Signal(str, str)      # filename, error_message
10938      disk_warning = Signal(float, float, int)  # target_percent, backup_percent, threshold
10939  
10940      def __init__(
10941          self,
10942          source: str,
10943          target: str,
10944          backup: str,
10945          interval: int,
10946          mode: str,
10947          disk_threshold_percent: int,
10948          retry_count: int,
10949          filters: List[str],
10950          app_dir: Path,
10951          enable_deduplication: bool = False,
10952          hash_algorithm: str = 'md5',
10953          duplicate_strategy: str = 'ask',
10954          network_check_interval: int = 10,
10955          network_auto_pause: bool = True,
10956          network_auto_resume: bool = True,
10957          enable_auto_delete: bool = False,
10958          auto_delete_folder: str = '',
10959          auto_delete_threshold: int = 80,
10960          auto_delete_keep_days: int = 10,
10961          auto_delete_check_interval: int = 300,
10962          upload_protocol: str = 'smb',
10963          ftp_client_config: Optional[Dict[str, Any]] = None,
10964          enable_backup: bool = True,
10965          limit_upload_rate: bool = False,
10966          max_upload_rate_mbps: float = 10.0
10967      ):
10968          """åˆå§‹åŒ–ä¸Šä¼  Worker
10969          
10970          Args:
10971              source: æºæ–‡ä»¶å¤¹è·¯å¾„
10972              target: ç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„
10973              backup: å¤‡ä»½æ–‡ä»¶å¤¹è·¯å¾„
10974              interval: ä¸Šä¼ é—´éš”ï¼ˆç§’ï¼‰
10975              mode: è¿è¡Œæ¨¡å¼ ('periodic' | 'once')
10976              disk_threshold_percent: ç£ç›˜ç©ºé—´é˜ˆå€¼ï¼ˆç™¾åˆ†æ¯”ï¼‰
10977              retry_count: å¤±è´¥é‡è¯•æ¬¡æ•°
10978              filters: æ–‡ä»¶æ‰©å±•åè¿‡æ»¤å™¨åˆ—è¡¨
10979              app_dir: åº”ç”¨ç¨‹åºç›®å½•

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 222 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
10980              enable_deduplication: æ˜¯å¦å¯ç”¨å»é‡
10981              hash_algorithm: å“ˆå¸Œç®—æ³• ('md5' | 'sha256')
10982              duplicate_strategy: é‡å¤å¤„ç†ç­–ç•¥ ('skip'|'rename'|'overwrite'|'ask')
10983              network_check_interval: ç½‘ç»œæ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰
10984              network_auto_pause: ç½‘ç»œä¸­æ–­æ—¶è‡ªåŠ¨æš‚åœ
10985              network_auto_resume: ç½‘ç»œæ¢å¤æ—¶è‡ªåŠ¨æ¢å¤
10986              enable_auto_delete: å¯ç”¨è‡ªåŠ¨åˆ é™¤
10987              auto_delete_folder: è‡ªåŠ¨åˆ é™¤ç›‘æ§æ–‡ä»¶å¤¹
10988              auto_delete_threshold: è‡ªåŠ¨åˆ é™¤ç£ç›˜é˜ˆå€¼
10989              auto_delete_keep_days: è‡ªåŠ¨åˆ é™¤ä¿ç•™å¤©æ•°
10990              auto_delete_check_interval: è‡ªåŠ¨åˆ é™¤æ£€æŸ¥é—´éš”
10991              upload_protocol: ä¸Šä¼ åè®® ('smb'|'ftp_client'|'both')
10992              ftp_client_config: FTPå®¢æˆ·ç«¯é…ç½®
10993              enable_backup: æ˜¯å¦å¯ç”¨å¤‡ä»½
10994              limit_upload_rate: æ˜¯å¦é™åˆ¶ä¸Šä¼ é€Ÿç‡
10995              max_upload_rate_mbps: æœ€å¤§ä¸Šä¼ é€Ÿç‡ï¼ˆMB/sï¼‰
10996          """
10997          super().__init__()
10998          self.source = source
10999          self.target = target
11000          self.backup = backup
11001          self.enable_backup = enable_backup
11002          self.limit_upload_rate = limit_upload_rate
11003          self.max_upload_rate_bytes = int(max_upload_rate_mbps * 1024 * 1024) if limit_upload_rate else 0
11004          self.interval = interval
11005          self.mode = mode
11006          self.disk_threshold_percent = max(5, disk_threshold_percent)
11007          self.retry_count = retry_count
11008          self.filters = [ext.lower() for ext in filters]
11009          self.app_dir = app_dir
11010          
11011          # å»é‡é…ç½®
11012          self.enable_deduplication = enable_deduplication
11013          self.hash_algorithm = hash_algorithm.lower()
11014          self.duplicate_strategy = duplicate_strategy
11015          
11016          # ç½‘ç»œç›‘æ§é…ç½®
11017          self.network_check_interval = network_check_interval
11018          self.network_auto_pause = network_auto_pause
11019          self.network_auto_resume = network_auto_resume
11020          
11021          # è‡ªåŠ¨åˆ é™¤é…ç½®
11022          self.enable_auto_delete = enable_auto_delete
11023          self.auto_delete_folder = auto_delete_folder
11024          self.auto_delete_threshold = auto_delete_threshold
11025          self.auto_delete_keep_days = auto_delete_keep_days
11026          self.auto_delete_check_interval = auto_delete_check_interval
11027          
11028          # åè®®é…ç½®
11029          self.upload_protocol = upload_protocol

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 223 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
11030          self.ftp_client_config = ftp_client_config or {}
11031          self.ftp_client = None
11032          
11033          # è¿è¡ŒçŠ¶æ€
11034          self._running = False
11035          self._paused = False
11036          self._thread = None
11037          self._archive_thread = None
11038          self._net_running = False
11039          self._net_thread = None
11040          
11041          # ç»Ÿè®¡æ•°æ®
11042          self.uploaded = 0
11043          self.failed = 0
11044          self.skipped = 0
11045          self.rate = "0 MB/s"
11046          self.total_files = 0
11047          self.current = 0
11048          self.start_time = None
11049          
11050          # å½“å‰æ–‡ä»¶ä¿¡æ¯
11051          self.current_file_name = ""
11052          self.current_file_size = 0
11053          self.current_file_uploaded = 0
11054          
11055          # é˜Ÿåˆ—
11056          self.retry_queue: Dict[str, Dict[str, Any]] = {}
11057          self.archive_queue: queue.Queue = queue.Queue()
11058          
11059          # ç½‘ç»œçŠ¶æ€
11060          self.network_retry_count = 0
11061          self.network_auto_retry = True
11062          self.last_network_check = 0.0
11063          self.current_network_status = 'unknown'
11064          self.network_pause_by_auto = False
11065          self._last_space_warn = 0.0
11066          
11067          # å¤±è´¥æ—¥å¿—
11068          self.failed_log_path = self.app_dir / "failed_files.log"
11069          
11070          # çº¿ç¨‹æ± 
11071          self._executor = ThreadPoolExecutor(max_workers=3, thread_name_prefix="FileOp")
11072          self._net_executor = ThreadPoolExecutor(max_workers=1, thread_name_prefix="NetChk")
11073          
11074          # å»é‡è¯¢é—®æ¨¡å¼çš„å…¨å±€é€‰æ‹©
11075          self._duplicate_ask_choice: Optional[str] = None
11076  
11077      def start(self) -> None:
11078          """å¯åŠ¨ä¸Šä¼ ä»»åŠ¡"""
11079          if self._running:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 224 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
11080              return
11081          self._running = True
11082          self._paused = False
11083          self._thread = threading.Thread(target=self._run, daemon=True)
11084          self._thread.start()
11085          
11086          # å¯åŠ¨ç½‘ç»œç›‘æ§çº¿ç¨‹
11087          self._net_running = True
11088          self._net_thread = threading.Thread(target=self._network_monitor_loop, daemon=True)
11089          self._net_thread.start()
11090          
11091          self.status.emit('running')
11092  
11093      def pause(self) -> None:
11094          """æš‚åœä¸Šä¼ ä»»åŠ¡"""
11095          if not self._running:
11096              return
11097          self._paused = True
11098          self.status.emit('paused')
11099  
11100      def resume(self) -> None:
11101          """æ¢å¤ä¸Šä¼ ä»»åŠ¡"""
11102          if not self._running:
11103              return
11104          self._paused = False
11105          self.status.emit('running')
11106  
11107      def stop(self) -> None:
11108          """åœæ­¢ä¸Šä¼ ä»»åŠ¡"""
11109          self._running = False
11110          self._paused = False
11111          
11112          # å…³é—­FTPå®¢æˆ·ç«¯
11113          if self.ftp_client:
11114              try:
11115                  self.ftp_client.disconnect()
11116                  self.ftp_client = None
11117              except Exception:
11118                  pass
11119          
11120          # å…³é—­çº¿ç¨‹æ± 
11121          try:
11122              self._executor.shutdown(wait=False, cancel_futures=True)
11123          except Exception:
11124              pass
11125          
11126          # åœæ­¢ç½‘ç»œç›‘æ§
11127          self._net_running = False
11128          try:
11129              self._net_executor.shutdown(wait=False, cancel_futures=True)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 225 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
11130          except Exception:
11131              pass
11132          
11133          self.status.emit('stopped')
11134  
11135      def _network_monitor_loop(self) -> None:
11136          """ç½‘ç»œç›‘æ§å¾ªç¯ï¼ˆç‹¬ç«‹çº¿ç¨‹ï¼‰"""
11137          last_status = 'unknown'
11138          
11139          while getattr(self, '_net_running', False):
11140              try:
11141                  # æ£€æµ‹ç½‘ç»œçŠ¶æ€
11142                  target_ok = self._safe_net_check(self.target, timeout=0.3, default=False)
11143                  if target_ok:
11144                      status = 'good'
11145                  else:
11146                      backup_ok = self._safe_net_check(self.backup, timeout=0.3, default=False)
11147                      status = 'unstable' if backup_ok else 'disconnected'
11148              except Exception:
11149                  status = 'disconnected'
11150  
11151              # çŠ¶æ€å˜åŒ–æ—¶å‘é€æ—¥å¿—å’Œä¿¡å·
11152              if status != last_status:
11153                  if status == 'good' and last_status in ('unstable', 'disconnected'):
11154                      self.log.emit('âœ… ç½‘ç»œå·²æ¢å¤æ­£å¸¸')
11155                  elif status == 'unstable':
11156                      self.log.emit('âš ï¸ ç½‘ç»œä¸ç¨³å®šï¼šç›®æ ‡ä¸å¯è¾¾ï¼Œä½†å¤‡ä»½å¯è¾¾')
11157                  elif status == 'disconnected':
11158                      self.log.emit('âŒ ç½‘ç»œè¿æ¥ä¸­æ–­')
11159                  
11160                  self.network_status.emit(status)
11161                  self.current_network_status = status
11162                  last_status = status
11163  
11164                  # è‡ªåŠ¨æš‚åœ/æ¢å¤
11165                  if status == 'disconnected' and self.network_auto_pause and not self._paused:
11166                      self.network_pause_by_auto = True
11167                      self.pause()
11168                  if status == 'good' and self.network_auto_resume and self.network_pause_by_auto:
11169                      self.network_pause_by_auto = False
11170                      self.resume()
11171  
11172              # æ–­å¼€çŠ¶æ€å¿ƒè·³
11173              if status == 'disconnected':
11174                  self.network_retry_count += 1
11175                  if self.network_retry_count % 3 == 0:
11176                      self.log.emit(f"ğŸ”Œ ç½‘ç»œä»æœªæ¢å¤ (ç¬¬{self.network_retry_count}æ¬¡æ£€æµ‹)")
11177              else:
11178                  self.network_retry_count = 0
11179  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 226 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
11180              # å‘é€ç»Ÿè®¡å¿ƒè·³
11181              try:
11182                  self.stats.emit(self.uploaded, self.failed, self.skipped, self.rate)
11183              except Exception:
11184                  pass
11185  
11186              # è‡ªé€‚åº”é—´éš”
11187              interval = 1 if status in ('unstable', 'disconnected') else max(1, int(self.network_check_interval))
11188              time.sleep(interval)
11189  
11190      def _safe_net_check(self, path: str, timeout: float = 1.5, default: bool = False) -> bool:
11191          """å®‰å…¨æ£€æŸ¥ç½‘ç»œè·¯å¾„å¯è¾¾æ€§
11192          
11193          ä¼˜å…ˆä½¿ç”¨ ping æ£€æµ‹ç½‘ç»œè·¯å¾„ï¼ˆUNC/æ˜ å°„ç›˜ï¼‰ï¼Œé¿å… os.path.exists é˜»å¡ã€‚
11194          """
11195          def is_unc(p: str) -> bool:
11196              return isinstance(p, str) and p.startswith('\\\\')
11197  
11198          def get_drive_root(p: str) -> str:
11199              drive, _ = os.path.splitdrive(p)
11200              return drive + '\\' if drive else ''
11201  
11202          def is_mapped_drive(p: str) -> bool:
11203              try:
11204                  root = get_drive_root(p)
11205                  if not root:
11206                      return False
11207                  import ctypes
11208                  DRIVE_REMOTE = 4
11209                  GetDriveTypeW = ctypes.windll.kernel32.GetDriveTypeW
11210                  GetDriveTypeW.argtypes = [ctypes.c_wchar_p]
11211                  GetDriveTypeW.restype = ctypes.c_uint
11212                  dtype = GetDriveTypeW(root)
11213                  return dtype == DRIVE_REMOTE
11214              except Exception:
11215                  return False
11216  
11217          def mapped_to_unc(p: str) -> str:
11218              try:
11219                  import ctypes
11220                  from ctypes import wintypes
11221                  WNetGetConnectionW = ctypes.windll.mpr.WNetGetConnectionW
11222                  WNetGetConnectionW.argtypes = [wintypes.LPCWSTR, wintypes.LPWSTR, ctypes.POINTER(wintypes.DWORD)]
11223                  WNetGetConnectionW.restype = wintypes.DWORD
11224                  drive, _ = os.path.splitdrive(p)
11225                  if not drive:
11226                      return ''
11227                  buf_len = wintypes.DWORD(1024)
11228                  buf = ctypes.create_unicode_buffer(1024)
11229                  rc = WNetGetConnectionW(drive + '\\', buf, ctypes.byref(buf_len))

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 227 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
11230                  if rc == 0:
11231                      unc_prefix = buf.value
11232                      rel = p[len(drive):].lstrip('\\/')
11233                      return os.path.join(unc_prefix, rel).replace('/', '\\')
11234                  return ''
11235              except Exception:
11236                  return ''
11237  
11238          def extract_host_from_unc(unc: str) -> str:
11239              try:
11240                  parts = unc.split('\\')
11241                  return parts[2] if len(parts) > 2 else ''
11242              except Exception:
11243                  return ''
11244  
11245          def ping_host(host: str, ms: int) -> bool:
11246              try:
11247                  import subprocess
11248                  completed = subprocess.run(
11249                      ['ping', '-n', '1', '-w', str(ms), host],
11250                      stdout=subprocess.DEVNULL,
11251                      stderr=subprocess.DEVNULL,
11252                      timeout=max(0.2, ms/1000.0 + 0.5)
11253                  )
11254                  return completed.returncode == 0
11255              except Exception:
11256                  return False
11257  
11258          try:
11259              if not path:
11260                  return bool(default)
11261              
11262              # UNC è·¯å¾„ï¼šç›´æ¥ ping
11263              if is_unc(path):
11264                  host = extract_host_from_unc(path)
11265                  if host:
11266                      return ping_host(host, int(timeout*1000))
11267                  return bool(default)
11268              
11269              # æ˜ å°„ç›˜ï¼šè½¬æ¢ä¸º UNC å† ping
11270              if is_mapped_drive(path):
11271                  unc = mapped_to_unc(path)
11272                  host = extract_host_from_unc(unc) if unc else ''
11273                  if host:
11274                      return ping_host(host, int(timeout*1000))
11275                  future = self._net_executor.submit(os.path.exists, path)
11276                  return bool(future.result(timeout=timeout))
11277              
11278              # æœ¬åœ°è·¯å¾„ï¼šç›´æ¥æ£€æŸ¥
11279              future = self._net_executor.submit(os.path.exists, path)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 228 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
11280              return bool(future.result(timeout=timeout))
11281          except Exception:
11282              return bool(default)
11283  
11284      def _safe_path_operation(self, func, *args, timeout: float = 3.0, default=None):
11285          """å®‰å…¨æ‰§è¡Œæ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼ˆå¸¦è¶…æ—¶ï¼‰"""
11286          try:
11287              future = self._executor.submit(func, *args)
11288              result = future.result(timeout=timeout)
11289              return result
11290          except FuturesTimeoutError:
11291              try:
11292                  self.log.emit(f"â±ï¸ æ–‡ä»¶æ“ä½œè¶…æ—¶ï¼ˆ{timeout}ç§’ï¼‰ï¼Œå¯èƒ½ç½‘ç»œä¸­æ–­")
11293              except Exception:
11294                  pass
11295              return default
11296          except Exception as e:
11297              try:
11298                  self.log.emit(f"âš ï¸ æ–‡ä»¶æ“ä½œå¼‚å¸¸: {str(e)[:50]}")
11299              except Exception:
11300                  pass
11301              return default
11302  
11303      def _check_network_connection(self) -> str:
11304          """æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€"""
11305          if getattr(self, '_net_running', False):
11306              now = time.time()
11307              if now - self.last_network_check < self.network_check_interval:
11308                  return self.current_network_status
11309              
11310              try:
11311                  target_ok = self._safe_path_operation(os.path.exists, self.target, timeout=1.5, default=False)
11312              except Exception:
11313                  target_ok = False
11314              
11315              if target_ok:
11316                  self.current_network_status = 'good'
11317              else:
11318                  try:
11319                      backup_ok = self._safe_path_operation(os.path.exists, self.backup, timeout=1.0, default=False)
11320                  except Exception:
11321                      backup_ok = False
11322                  self.current_network_status = 'unstable' if backup_ok else 'disconnected'
11323              
11324              self.last_network_check = now
11325              return self.current_network_status
11326  
11327          now = time.time()
11328          if now - self.last_network_check < self.network_check_interval:
11329              return self.current_network_status

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 229 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
11330          
11331          self.last_network_check = now
11332          
11333          try:
11334              target_ok = self._safe_path_operation(os.path.exists, self.target, timeout=2.0, default=False)
11335          except Exception:
11336              target_ok = False
11337          
11338          if target_ok:
11339              old_status = self.current_network_status
11340              self.current_network_status = 'good'
11341              self.network_retry_count = 0
11342              
11343              if old_status == 'disconnected':
11344                  self.log.emit("âœ… ç½‘ç»œå·²æ¢å¤æ­£å¸¸")
11345                  if self.network_auto_resume and self.network_pause_by_auto:
11346                      self.log.emit("ğŸ”„ ç½‘ç»œæ¢å¤ï¼Œè‡ªåŠ¨ç»§ç»­ä¸Šä¼ ...")
11347                      time.sleep(1)
11348                      self.network_pause_by_auto = False
11349                      self.resume()
11350              
11351              self.network_status.emit('good')
11352              return 'good'
11353          
11354          self.network_retry_count += 1
11355          
11356          try:
11357              backup_ok = self._safe_path_operation(os.path.exists, self.backup, timeout=2.0, default=False)
11358          except Exception:
11359              backup_ok = False
11360          
11361          if backup_ok:
11362              old_status = self.current_network_status
11363              self.current_network_status = 'unstable'
11364              
11365              if old_status != 'unstable':
11366                  self.log.emit(f"âš ï¸ ç½‘ç»œä¸ç¨³å®šï¼šç›®æ ‡æ–‡ä»¶å¤¹ä¸å¯è®¿é—®ï¼Œå¤‡ä»½æ–‡ä»¶å¤¹æ­£å¸¸")
11367              
11368              self.network_status.emit('unstable')
11369              return 'unstable'
11370          
11371          old_status = self.current_network_status
11372          self.current_network_status = 'disconnected'
11373          
11374          if old_status != 'disconnected':
11375              self.log.emit(f"âŒ ç½‘ç»œè¿æ¥ä¸­æ–­ï¼ˆç›®æ ‡å’Œå¤‡ä»½æ–‡ä»¶å¤¹å‡ä¸å¯è®¿é—®ï¼‰")
11376              
11377              if self.network_auto_pause and not self._paused:
11378                  self.log.emit("â¸ï¸ æ£€æµ‹åˆ°ç½‘ç»œä¸­æ–­ï¼Œè‡ªåŠ¨æš‚åœä¸Šä¼ ...")
11379                  self.network_pause_by_auto = True

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 230 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
11380                  self.pause()
11381          else:
11382              if self.network_retry_count % 3 == 0:
11383                  self.log.emit(f"ğŸ”Œ ç½‘ç»œä»æœªæ¢å¤ (ç¬¬{self.network_retry_count}æ¬¡æ£€æµ‹)")
11384          
11385          self.network_status.emit('disconnected')
11386          return 'disconnected'
11387  
11388      def _handle_upload_failure(self, file_path: str) -> None:
11389          """å¤„ç†ä¸Šä¼ å¤±è´¥ï¼ˆå¸¦é‡è¯•è°ƒåº¦ï¼‰"""
11390          item = self.retry_queue.get(file_path)
11391          if item is None:
11392              item = {'count': 1, 'next': 0.0}
11393          else:
11394              item['count'] += 1
11395          
11396          retry_count = item['count']
11397          if retry_count > self.retry_count:
11398              self._log_failed_file(file_path, f"é‡è¯•{retry_count-1}æ¬¡åä»ç„¶å¤±è´¥")
11399              if file_path in self.retry_queue:
11400                  del self.retry_queue[file_path]
11401              self.log.emit(f"âŒ æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œå·²è®°å½•åˆ°å¤±è´¥æ—¥å¿—: {os.path.basename(file_path)}")
11402              return
11403          
11404          wait_times = [10, 30, 60]
11405          wait_time = wait_times[min(retry_count - 1, len(wait_times) - 1)]
11406          item['next'] = time.time() + wait_time
11407          self.retry_queue[file_path] = item
11408          self.log.emit(f"âš  æ–‡ä»¶å°†åœ¨ç¨åé‡è¯• ({retry_count}/{self.retry_count})ï¼Œç­‰å¾…{wait_time}ç§’: {os.path.basename(file_path)}")
11409  
11410      def _process_retry_queue(self) -> None:
11411          """å¤„ç†é‡è¯•é˜Ÿåˆ—"""
11412          if not self.retry_queue:
11413              return
11414          
11415          now = time.time()
11416          retry_list = list(self.retry_queue.items())
11417          
11418          for file_path, item in retry_list:
11419              if not self._running or self._paused:
11420                  break
11421              
11422              if not os.path.exists(file_path):
11423                  del self.retry_queue[file_path]
11424                  continue
11425              
11426              retry_count = item.get('count', 1)
11427              next_at = item.get('next', 0.0)
11428              
11429              if now < next_at:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 231 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
11430                  continue
11431              
11432              self.log.emit(f"ğŸ“¤ å¼€å§‹é‡è¯•ä¸Šä¼  ({retry_count}/{self.retry_count}): {os.path.basename(file_path)}")
11433              rel = os.path.relpath(file_path, self.source)
11434              tgt = os.path.join(self.target, rel)
11435              bkp = os.path.join(self.backup, rel)
11436              
11437              try:
11438                  tgt_exists = self._safe_path_operation(os.path.exists, tgt, timeout=2.0, default=False)
11439                  if tgt_exists:
11440                      del self.retry_queue[file_path]
11441                      continue
11442                  
11443                  self._safe_path_operation(
11444                      lambda: os.makedirs(os.path.dirname(tgt), exist_ok=True),
11445                      timeout=3.0,
11446                      default=False
11447                  )
11448                  
11449                  copy_success = self._safe_path_operation(
11450                      lambda: shutil.copy2(file_path, tgt) or True,
11451                      timeout=10.0,
11452                      default=False
11453                  )
11454                  
11455                  if not copy_success:
11456                      raise Exception("æ–‡ä»¶å¤åˆ¶è¶…æ—¶")
11457                  
11458                  self.archive_queue.put((file_path, bkp))
11459                  del self.retry_queue[file_path]
11460                  self.uploaded += 1
11461                  self.stats.emit(self.uploaded, self.failed, self.skipped, self.rate)
11462                  self.log.emit(f"âœ“ é‡è¯•æˆåŠŸ: {os.path.basename(file_path)}")
11463                  
11464              except Exception as e:
11465                  item['count'] = retry_count + 1
11466                  if item['count'] > self.retry_count:
11467                      self._log_failed_file(file_path, f"é‡è¯•{retry_count}æ¬¡åä»ç„¶å¤±è´¥: {str(e)[:50]}")
11468                      del self.retry_queue[file_path]
11469                      self.failed += 1
11470                      self.stats.emit(self.uploaded, self.failed, self.skipped, self.rate)
11471                      self.log.emit(f"âŒ æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œå·²è®°å½•åˆ°å¤±è´¥æ—¥å¿—: {os.path.basename(file_path)}")
11472                  else:
11473                      wait_times = [10, 30, 60]
11474                      wait_time = wait_times[min(item['count'] - 1, len(wait_times) - 1)]
11475                      item['next'] = time.time() + wait_time
11476                      self.retry_queue[file_path] = item
11477                      self.log.emit(f"âš  é‡è¯•å¤±è´¥ï¼Œå·²é‡æ–°æ’é˜Ÿ ({item['count']}/{self.retry_count})ï¼Œç­‰å¾…{wait_time}ç§’: {os.path.basename(file_path)}")
11478  
11479      def _log_failed_file(self, file_path: str, reason: str) -> None:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 232 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
11480          """è®°å½•å¤±è´¥æ–‡ä»¶åˆ°æ—¥å¿—"""
11481          try:
11482              timestamp = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
11483              with open(self.failed_log_path, 'a', encoding='utf-8') as f:
11484                  f.write(f"[{timestamp}] {file_path} - {reason}\n")
11485          except Exception as e:
11486              self.log.emit(f"å†™å…¥å¤±è´¥æ—¥å¿—å‡ºé”™: {e}")
11487  
11488      def _copy_with_progress(self, src: str, dst: str, buffer_size: int = 1024 * 1024) -> None:
11489          """å¸¦è¿›åº¦å’Œé€Ÿç‡é™åˆ¶çš„æ–‡ä»¶å¤åˆ¶"""
11490          last_write_time = time.time()
11491          write_timeout = 5.0
11492          
11493          if self.limit_upload_rate and self.max_upload_rate_bytes > 0:
11494              buffer_size = min(buffer_size, 64 * 1024)
11495          
11496          try:
11497              with open(src, 'rb') as fsrc, open(dst, 'wb') as fdst:
11498                  copied = 0
11499                  
11500                  while True:
11501                      if not self._running or self._paused:
11502                          break
11503                      
11504                      if time.time() - last_write_time > write_timeout:
11505                          self.log.emit(f"â±ï¸ æ–‡ä»¶å†™å…¥è¶…æ—¶ï¼ˆ{write_timeout}ç§’ï¼‰ï¼Œå¯èƒ½ç½‘ç»œå·²æ–­å¼€")
11506                          raise Exception("æ–‡ä»¶å†™å…¥è¶…æ—¶")
11507                      
11508                      chunk_start = time.time()
11509                      buf = fsrc.read(buffer_size)
11510                      if not buf:
11511                          break
11512                      
11513                      try:
11514                          fdst.write(buf)
11515                          last_write_time = time.time()
11516                      except Exception as e:
11517                          self.log.emit(f"âš ï¸ æ–‡ä»¶å†™å…¥å¤±è´¥: {str(e)[:50]}")
11518                          raise
11519                      
11520                      copied += len(buf)
11521                      
11522                      # é€Ÿç‡é™åˆ¶
11523                      if self.limit_upload_rate and self.max_upload_rate_bytes > 0:
11524                          expected_time = len(buf) / self.max_upload_rate_bytes
11525                          elapsed_time = time.time() - chunk_start
11526                          if elapsed_time < expected_time:
11527                              time.sleep(expected_time - elapsed_time)
11528                      
11529                      # æ›´æ–°è¿›åº¦

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 233 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
11530                      if self.current_file_size > 0:
11531                          progress = int(100 * copied / self.current_file_size)
11532                          self.file_progress.emit(self.current_file_name, progress)
11533                          
11534                          if progress % 10 == 0 and progress > 0:
11535                              if self.limit_upload_rate:
11536                                  self.log.emit(
11537                                      f"ğŸ“Š ä¸Šä¼ è¿›åº¦: {progress}% "
11538                                      f"({copied/(1024*1024):.1f}MB/{self.current_file_size/(1024*1024):.1f}MB) "
11539                                      f"[é™é€Ÿ: {self.max_upload_rate_bytes/(1024*1024):.1f}MB/s]"
11540                                  )
11541                              else:
11542                                  self.log.emit(
11543                                      f"ğŸ“Š ä¸Šä¼ è¿›åº¦: {progress}% "
11544                                      f"({copied/(1024*1024):.1f}MB/{self.current_file_size/(1024*1024):.1f}MB)"
11545                                  )
11546              
11547              shutil.copystat(src, dst)
11548              
11549          except Exception as e:
11550              if os.path.exists(dst):
11551                  try:
11552                      os.remove(dst)
11553                  except Exception:
11554                      pass
11555              raise e
11556  
11557      def _upload_file_by_protocol(self, src: str, dst: str) -> bool:
11558          """æ ¹æ®åè®®ä¸Šä¼ æ–‡ä»¶"""
11559          if self.upload_protocol == 'smb':
11560              return self._upload_via_smb(src, dst)
11561          elif self.upload_protocol == 'ftp_client':
11562              return self._upload_via_ftp(src, dst)
11563          elif self.upload_protocol == 'both':
11564              smb_ok = self._upload_via_smb(src, dst)
11565              ftp_ok = self._upload_via_ftp(src, dst)
11566              return smb_ok or ftp_ok
11567          else:
11568              self.log.emit(f"âŒ æœªçŸ¥çš„ä¸Šä¼ åè®®: {self.upload_protocol}")
11569              return False
11570  
11571      def _upload_via_smb(self, src: str, dst: str) -> bool:
11572          """é€šè¿‡ SMB ä¸Šä¼ æ–‡ä»¶"""
11573          try:
11574              if self.current_file_size > 10 * 1024 * 1024:
11575                  self._copy_with_progress(src, dst)
11576              else:
11577                  def copy_file():
11578                      shutil.copy2(src, dst)
11579                      return True

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 234 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
11580                  
11581                  copy_success = self._safe_path_operation(copy_file, timeout=10.0, default=False)
11582                  if not copy_success:
11583                      raise Exception("æ–‡ä»¶å¤åˆ¶è¶…æ—¶ï¼Œç½‘ç»œå¯èƒ½å·²æ–­å¼€")
11584              
11585              return True
11586          except Exception as e:
11587              self.log.emit(f"âŒ SMBä¸Šä¼ å¤±è´¥: {e}")
11588              return False
11589  
11590      def _upload_via_ftp(self, src: str, dst: str) -> bool:
11591          """é€šè¿‡ FTP ä¸Šä¼ æ–‡ä»¶"""
11592          try:
11593              if not FTP_AVAILABLE or FTPClientUploader is None:
11594                  self.log.emit("âŒ FTP åŠŸèƒ½ä¸å¯ç”¨")
11595                  return False
11596              
11597              if not self.ftp_client and self.ftp_client_config:
11598                  self.ftp_client = FTPClientUploader(self.ftp_client_config)
11599                  if not self.ftp_client.connect():
11600                      host = self.ftp_client_config.get('host', 'unknown')
11601                      port = self.ftp_client_config.get('port', 21)
11602                      self.log.emit(f"âŒ [FTP-CONN] æ— æ³•è¿æ¥åˆ° {host}:{port}")
11603                      self.ftp_client = None
11604                      return False
11605              
11606              if not self.ftp_client:
11607                  self.log.emit("âŒ [FTP-INIT] FTPå®¢æˆ·ç«¯æœªåˆå§‹åŒ–")
11608                  return False
11609              
11610              rel_path = os.path.relpath(dst, self.target)
11611              remote_path = self.ftp_client_config.get('remote_path', '/upload')
11612              remote_file = f"{remote_path}/{rel_path}".replace('\\', '/')
11613              
11614              success = self.ftp_client.upload_file(Path(src), remote_file)
11615              if success:
11616                  self.log.emit(f"âœ“ FTPä¸Šä¼ æˆåŠŸ: {os.path.basename(remote_file)}")
11617                  return True
11618              else:
11619                  self.log.emit(f"âŒ [FTP-UPLOAD] ä¸Šä¼ å¤±è´¥: {os.path.basename(remote_file)}")
11620                  return False
11621                  
11622          except Exception as e:
11623              error_type = type(e).__name__
11624              self.log.emit(f"âŒ [FTP-ERROR] {error_type}: {e}")
11625              return False
11626  
11627      def _calculate_file_hash(self, file_path: str, buffer_size: int = 8192) -> str:
11628          """è®¡ç®—æ–‡ä»¶å“ˆå¸Œå€¼"""
11629          try:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 235 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
11630              if self.hash_algorithm == 'sha256':
11631                  hasher = hashlib.sha256()
11632              else:
11633                  hasher = hashlib.md5()
11634              
11635              file_size = os.path.getsize(file_path)
11636              
11637              with open(file_path, 'rb') as f:
11638                  processed = 0
11639                  while True:
11640                      if not self._running or self._paused:
11641                          return ""
11642                      
11643                      data = f.read(buffer_size)
11644                      if not data:
11645                          break
11646                      hasher.update(data)
11647                      processed += len(data)
11648                      
11649                      if file_size > 50 * 1024 * 1024:
11650                          progress = int(100 * processed / file_size)
11651                          if progress % 10 == 0:
11652                              self.log.emit(f"ğŸ” è®¡ç®—å“ˆå¸Œå€¼... {progress}%")
11653              
11654              return hasher.hexdigest()
11655          except Exception as e:
11656              self.log.emit(f"âš  å“ˆå¸Œè®¡ç®—å¤±è´¥: {e}")
11657              return ""
11658  
11659      def _find_duplicate_by_hash(self, file_hash: str, target_dir: str) -> str:
11660          """åœ¨ç›®æ ‡æ–‡ä»¶å¤¹ä¸­æŸ¥æ‰¾é‡å¤æ–‡ä»¶"""
11661          if not file_hash:
11662              return ""
11663          
11664          try:
11665              for root, _, files in os.walk(target_dir):
11666                  for name in files:
11667                      if not self._running or self._paused:
11668                          return ""
11669                      
11670                      target_file = os.path.join(root, name)
11671                      try:
11672                          target_hash = self._calculate_file_hash(target_file)
11673                          if target_hash == file_hash:
11674                              return target_file
11675                      except Exception:
11676                          continue
11677              return ""
11678          except Exception:
11679              return ""

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 236 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
11680  
11681      def _get_unique_filename(self, base_path: str) -> str:
11682          """ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å"""
11683          if not os.path.exists(base_path):
11684              return base_path
11685          
11686          directory = os.path.dirname(base_path)
11687          filename = os.path.basename(base_path)
11688          name, ext = os.path.splitext(filename)
11689          
11690          counter = 1
11691          while True:
11692              new_name = f"{name} ({counter}){ext}"
11693              new_path = os.path.join(directory, new_name)
11694              if not os.path.exists(new_path):
11695                  return new_path
11696              counter += 1
11697              if counter > 9999:
11698                  return base_path
11699  
11700      def _archive_worker(self) -> None:
11701          """å½’æ¡£ Workerï¼ˆç‹¬ç«‹çº¿ç¨‹ï¼‰"""
11702          while self._running:
11703              try:
11704                  item = self.archive_queue.get(timeout=1)
11705                  src_path, bkp_path = item
11706                  
11707                  if not os.path.exists(src_path):
11708                      continue
11709                  
11710                  if self.enable_backup and self.backup and os.path.exists(os.path.dirname(self.backup)):
11711                      os.makedirs(os.path.dirname(bkp_path), exist_ok=True)
11712                      shutil.move(src_path, bkp_path)
11713                      self.log.emit(f"ğŸ“¦ å·²å½’æ¡£: {os.path.basename(bkp_path)}")
11714                  else:
11715                      os.remove(src_path)
11716                      self.log.emit(f"ğŸ—‘ï¸ å·²åˆ é™¤: {os.path.basename(src_path)}")
11717                      
11718              except queue.Empty:
11719                  continue
11720              except Exception as e:
11721                  self.log.emit(f"å½’æ¡£å¤±è´¥: {e}")
11722  
11723      def _disk_ok(self, path: str) -> Tuple[float, float, float]:
11724          """æ£€æŸ¥ç£ç›˜ç©ºé—´"""
11725          def check():
11726              try:
11727                  parent = os.path.dirname(path) or path
11728                  usage = shutil.disk_usage(parent)
11729                  total_gb = usage.total / (1024 ** 3)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 237 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
11730                  free_gb = usage.free / (1024 ** 3)
11731                  free_percent = (usage.free / usage.total) * 100 if usage.total > 0 else 0
11732                  return free_percent, total_gb, free_gb
11733              except Exception:
11734                  return 0.0, 0.0, 0.0
11735          
11736          result = self._safe_path_operation(check, timeout=2.0, default=(0.0, 0.0, 0.0))
11737          return result if result is not None else (0.0, 0.0, 0.0)
11738  
11739      def _get_image_files(self) -> List[str]:
11740          """æ‰«æå›¾ç‰‡æ–‡ä»¶"""
11741          def scan():
11742              if not os.path.exists(self.source):
11743                  return []
11744              files = []
11745              for root, _, names in os.walk(self.source):
11746                  if not self._running:
11747                      break
11748                  for n in names:
11749                      ext = os.path.splitext(n)[1].lower()
11750                      if ext in self.filters:
11751                          files.append(os.path.join(root, n))
11752              return files
11753          
11754          result = self._safe_path_operation(scan, timeout=5.0, default=[])
11755          return result if result is not None else []
11756  
11757      def _run(self) -> None:
11758          """ä¸»è¿è¡Œå¾ªç¯"""
11759          self.log.emit("ğŸš€ å¼€å§‹å›¾ç‰‡ä¸Šä¼ æœåŠ¡ï¼ˆä¸Šä¼ ä¸å½’æ¡£å·²åˆ†ç¦»ï¼‰")
11760          self.start_time = time.time()
11761          
11762          # å¯åŠ¨å½’æ¡£çº¿ç¨‹
11763          self._archive_thread = threading.Thread(target=self._archive_worker, daemon=True)
11764          self._archive_thread.start()
11765          self.log.emit("ğŸ“¦ å½’æ¡£çº¿ç¨‹å·²å¯åŠ¨")
11766          
11767          # é‡ç½®ç»Ÿè®¡
11768          self.uploaded = 0
11769          self.failed = 0
11770          self.skipped = 0
11771          self.retry_queue.clear()
11772          
11773          try:
11774              while self._running:
11775                  # æš‚åœå¤„ç†
11776                  pause_log_counter = 0
11777                  while self._paused and self._running:
11778                      time.sleep(0.2)
11779                      pause_log_counter += 1

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 238 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
11780                      if pause_log_counter >= 50:
11781                          pause_log_counter = 0
11782                          self.log.emit("â¸ï¸ ä¸Šä¼ å·²æš‚åœï¼Œç­‰å¾…æ¢å¤...")
11783                  
11784                  if not self._running:
11785                      break
11786  
11787                  # ç½‘ç»œæ£€æŸ¥
11788                  try:
11789                      network_status = self._check_network_connection()
11790                  except Exception as e:
11791                      self.log.emit(f"âš ï¸ ç½‘ç»œæ£€æµ‹å¼‚å¸¸: {str(e)[:50]}")
11792                      network_status = 'disconnected'
11793                  
11794                  if network_status == 'disconnected' and self._paused:
11795                      self.log.emit("ğŸ”Œ ç­‰å¾…ç½‘ç»œæ¢å¤ä¸­...")
11796                      time.sleep(1)
11797                      continue
11798  
11799                  # ç£ç›˜ç©ºé—´æ£€æŸ¥
11800                  tf_ok, _, _ = self._disk_ok(self.target)
11801                  bf_ok, _, _ = self._disk_ok(self.backup)
11802                  
11803                  if tf_ok < self.disk_threshold_percent or bf_ok < self.disk_threshold_percent:
11804                      now = time.time()
11805                      if now - self._last_space_warn > 10:
11806                          self._last_space_warn = now
11807                          self.log.emit(
11808                              f"âš  ç£ç›˜ç©ºé—´ä¸è¶³ï¼ç›®æ ‡:{tf_ok:.0f}%ï¼Œ"
11809                              f"å¤‡ä»½:{bf_ok:.0f}%ï¼ˆé˜ˆå€¼:{self.disk_threshold_percent}%ï¼‰"
11810                          )
11811                          self.disk_warning.emit(tf_ok, bf_ok, self.disk_threshold_percent)
11812                      time.sleep(2)
11813                      continue
11814  
11815                  # å¤„ç†é‡è¯•é˜Ÿåˆ—
11816                  self._process_retry_queue()
11817  
11818                  # æ‰«ææ–‡ä»¶
11819                  images = self._get_image_files()
11820                  self.total_files = len(images)
11821                  self.current = 0
11822                  self.progress.emit(self.current, self.total_files, "")
11823  
11824                  # å¤„ç†æ¯ä¸ªæ–‡ä»¶
11825                  for path in images:
11826                      if not self._running:
11827                          break
11828                      
11829                      while self._paused and self._running:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 239 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
11830                          time.sleep(0.2)
11831                      
11832                      if not self._running:
11833                          break
11834                      
11835                      # æ£€æŸ¥ç½‘ç»œ
11836                      network_status = self._check_network_connection()
11837                      if network_status == 'disconnected':
11838                          self.log.emit("âš ï¸ ç½‘ç»œå·²æ–­å¼€ï¼Œåœæ­¢ä¸Šä¼ æ–°æ–‡ä»¶")
11839                          time.sleep(1)
11840                          continue
11841  
11842                      rel = os.path.relpath(path, self.source)
11843                      tgt = os.path.join(self.target, rel)
11844                      bkp = os.path.join(self.backup, rel)
11845                      
11846                      # åˆ›å»ºç›®æ ‡ç›®å½•
11847                      try:
11848                          self._safe_path_operation(
11849                              lambda: os.makedirs(os.path.dirname(tgt), exist_ok=True),
11850                              timeout=3.0
11851                          )
11852                      except Exception as e:
11853                          self.log.emit(f"âŒ æ— æ³•åˆ›å»ºç›®æ ‡ç›®å½•: {e}")
11854                          self.failed += 1
11855                          self.stats.emit(self.uploaded, self.failed, self.skipped, self.rate)
11856                          continue
11857  
11858                      fname = os.path.basename(path)
11859                      self.current_file_name = fname
11860                      
11861                      self.log.emit(f"ğŸ“¤ å¼€å§‹ä¸Šä¼ : {fname}")
11862                      self.progress.emit(self.current, self.total_files, fname)
11863                      start_t = time.time()
11864                      
11865                      try:
11866                          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
11867                          tgt_exists = self._safe_path_operation(
11868                              os.path.exists, tgt, timeout=2.0, default=False
11869                          )
11870                          
11871                          if tgt_exists and not self.enable_deduplication:
11872                              self.log.emit(f"â­ æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡: {fname}")
11873                              self.skipped += 1
11874                              self.stats.emit(self.uploaded, self.failed, self.skipped, self.rate)
11875                              self.file_progress.emit(fname, 100)
11876                          else:
11877                              # è·å–æ–‡ä»¶å¤§å°
11878                              try:
11879                                  self.current_file_size = os.path.getsize(path)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 240 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
11880                              except Exception:
11881                                  self.current_file_size = 0
11882                              
11883                              self.file_progress.emit(fname, 0)
11884                              
11885                              # å»é‡é€»è¾‘ï¼ˆç®€åŒ–ç‰ˆï¼Œå®Œæ•´é€»è¾‘è§ pyqt_app.pyï¼‰
11886                              should_upload = True
11887                              final_target = tgt
11888                              
11889                              # æ‰§è¡Œä¸Šä¼ 
11890                              if should_upload:
11891                                  def create_dir():
11892                                      os.makedirs(os.path.dirname(final_target), exist_ok=True)
11893                                  
11894                                  dir_created = self._safe_path_operation(
11895                                      create_dir, timeout=3.0, default=False
11896                                  )
11897                                  
11898                                  if dir_created is False:
11899                                      raise Exception("åˆ›å»ºç›®æ ‡ç›®å½•è¶…æ—¶ï¼Œç½‘ç»œå¯èƒ½å·²æ–­å¼€")
11900                                  
11901                                  upload_success = self._upload_file_by_protocol(path, final_target)
11902                                  
11903                                  if not upload_success:
11904                                      raise Exception("æ–‡ä»¶ä¸Šä¼ å¤±è´¥")
11905                                  
11906                                  self.uploaded += 1
11907                                  
11908                                  # è®¡ç®—é€Ÿç‡
11909                                  try:
11910                                      size_mb = os.path.getsize(final_target) / (1024*1024)
11911                                      dur = max(time.time()-start_t, 1e-6)
11912                                      rate = size_mb / dur
11913                                      self.rate = f"{rate:.2f} MB/s"
11914                                  except Exception:
11915                                      pass
11916                                  
11917                                  self.stats.emit(self.uploaded, self.failed, self.skipped, self.rate)
11918                                  self.file_progress.emit(fname, 100)
11919                                  self.log.emit(f"âœ“ ä¸Šä¼ æˆåŠŸ: {os.path.basename(final_target)}")
11920                                  self.archive_queue.put((path, bkp))
11921                              else:
11922                                  self.file_progress.emit(fname, 100)
11923                                  
11924                      except Exception as e:
11925                          self.failed += 1
11926                          self.stats.emit(self.uploaded, self.failed, self.skipped, self.rate)
11927                          self.log.emit(f"âœ— ä¸Šä¼ å¤±è´¥ {fname}: {e}")
11928                          self.upload_error.emit(fname, str(e))
11929                          self._handle_upload_failure(path)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›¾ç‰‡å¼‚æ­¥ä¸Šä¼ å·¥å…·è½¯ä»¶_V3.1.0 æºä»£ç                                 ç¬¬ 241 é¡µ / å…± 241 é¡µ
----------------------------------------------------------------------
11930  
11931                      self.current += 1
11932                      self.progress.emit(self.current, self.total_files, fname)
11933  
11934                  # é—´éš”æ§åˆ¶
11935                  if self.mode == 'periodic':
11936                      for _ in range(max(1, self.interval*5)):
11937                          if not self._running or self._paused:
11938                              break
11939                          time.sleep(0.2)
11940                  else:
11941                      time.sleep(1)
11942                      
11943          finally:
11944              self.log.emit("ğŸ›‘ ä¸Šä¼ æœåŠ¡å·²åœæ­¢")
11945              self.finished.emit()
       

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
