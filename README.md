# 图片异步上传工具 v3.0.0

## 软件简介

本软件专门为汽车生产线环境设计，用于异步上传大容量图片文件到共享文件夹或远程FTP服务器，有效避免网络阻塞导致的其他软件卡死问题。

**🎉 v3.0.0 重大更新**: 完成模块化架构重构，代码更清晰、可维护性更强！

## v3.0.0 更新亮点

### 🏗️ 模块化架构重构

从单文件架构（5234行）重构为清晰的模块化结构：

```
src/
├── main.py                 # 程序入口 (110行)
├── config.py               # 配置管理 (160行)
├── core/                   # 核心功能
│   ├── utils.py           # 工具函数 (70行)
│   └── permissions.py     # 权限管理 (150行)
├── protocols/              # 协议模块
│   └── ftp.py             # FTP协议 (1026行)
├── ui/                     # 用户界面
│   ├── widgets.py         # 自定义控件 (730行)
│   └── main_window.py     # 主窗口 (4017行)
└── workers/                # 后台工作
    └── upload_worker.py   # 上传Worker (1070行)
```

### ✨ 改进内容

- **代码可维护性提升**: 8个独立模块，职责清晰
- **更好的可测试性**: 每个模块可独立测试
- **类型安全**: 完整的类型注解，Pylance零错误
- **向后兼容**: 旧版 `pyqt_app.py` 入口仍可使用

## 主要功能

### 核心功能
1. **多协议上传** 🆕: SMB（网络共享）+ FTP服务器 + FTP客户端 + 混合模式
2. **异步上传**: 采用多线程异步处理，避免阻塞主界面和其他程序
3. **文件管理**: 上传完成后自动将源文件移动到备份文件夹
4. **连接检测**: 自动检测共享文件夹和FTP服务器的连通性
5. **日志记录**: 详细记录每个文件的上传状态和时间
6. **灵活监控**: 支持定时上传和实时监控两种模式
7. **配置保存**: 自动保存用户设置，下次启动自动加载

### v2.1 新增功能 🎉
8. **FTP服务器模式**: 本机作为FTP服务器，其他设备可连接上传
   - 支持被动模式（NAT/防火墙穿透）
   - 可选TLS/SSL加密（FTPS）
   - 连接数限制（最大256，单IP可配置）
   - 一键测试配置

9. **FTP客户端模式**: 连接到远程FTP服务器上传文件
   - 超时和重试配置
   - 被动/主动模式切换
   - TLS/SSL支持
   - 连接测试功能

10. **混合模式**: 同时运行FTP服务器和客户端
    - 本机既接收又发送文件
    - 独立配置，互不干扰

11. **性能卓越**: 
    - 启动时间: **1毫秒**（目标≤3秒）
    - FTP上传速度: **203 MB/s**（目标≥2 MB/s）
    - 并发支持: **5个客户端**同时上传
    - 内存占用: **28 MB**（目标≤300 MB）
    - CPU占用: **接近0%**（目标≤15%）

## 快速开始

### 打包版（推荐）

详见 [打包说明文档](docs/历史版本/打包说明_v1.8.md)

1. 下载 `.exe` 可执行文件（无需安装 Python 环境）
2. 双击运行 `图片异步上传工具_v2.1.exe`
3. 选择上传模式（SMB/FTP服务器/FTP客户端/混合）
4. 配置对应参数
5. 测试连接，确认配置正确
6. 点击"启动上传"即可开始监控和上传

### 从源代码运行

**环境要求**: Python 3.8+, PyQt5

1. 安装依赖：
   ```powershell
   pip install -r requirements.txt
   ```

2. 运行程序：
   ```powershell
   python pyqt_app.py
   ```

3. 或使用快捷脚本：
   ```powershell
   scripts\启动程序_pyqt.bat
   ```

## 配置参数说明

### SMB模式（网络共享）
- **源文件夹**: 待上传文件存放目录
- **目标文件夹**: 共享文件夹路径（如 `\\192.168.1.100\share\upload`）
- **备份文件夹**: 上传成功后的文件移动路径
- **监控间隔**: 检测新文件的时间间隔（秒）

### FTP服务器模式 🆕
- **服务器IP**: 本机IP地址（自动检测）
- **端口**: FTP端口（默认21）
- **用户名/密码**: 客户端连接凭证
- **上传目录**: 接收文件的存储位置
- **被动模式端口范围**: NAT穿透端口（如50000-50100）
- **TLS/SSL**: 可选加密传输
- **连接限制**: 最大并发连接数（总计+单IP）

### FTP客户端模式 🆕
- **FTP服务器**: 远程服务器地址
- **端口**: 服务器端口（默认21）
- **用户名/密码**: 登录凭证
- **源文件夹**: 待上传文件目录
- **目标路径**: 服务器存储路径
- **备份文件夹**: 上传成功后移动路径
- **超时/重试**: 网络异常处理
- **被动模式**: NAT环境建议开启
- **TLS/SSL**: 加密连接支持

### 混合模式 🆕
同时配置FTP服务器和客户端参数，实现双向传输。

## 性能指标 ⚡

基于开发任务书要求，v2.1经过严格的性能基准测试：

| 指标 | 目标值 | 实际值 | 超额完成 |
|------|--------|--------|----------|
| 启动时间 | ≤ 3秒 | 0.001秒 | 3000倍 ⭐⭐⭐⭐⭐ |
| FTP上传速度 | ≥ 2 MB/s | 203 MB/s | 101倍 ⭐⭐⭐⭐⭐ |
| 并发客户端 | ≥ 5个 | 5/5成功 | 100% ⭐⭐⭐⭐⭐ |
| 内存占用 | ≤ 300 MB | 28 MB | 节省90% ⭐⭐⭐⭐⭐ |
| CPU占用 | ≤ 15% | 0.0% | 节省100% ⭐⭐⭐⭐⭐ |

**测试结论**: v2.1性能达到卓越级别，所有指标远超预期！

详细测试报告请查看：[v2.1性能测试报告](docs/v2.1_性能测试报告.md)

## 实际应用场景性能预估

基于性能测试结果，不同网络环境下的预期传输速度：

- **千兆以太网（1000 Mbps）**: 约 **110-120 MB/s** 
  - 瓶颈：网络带宽
  - 适用：局域网高速传输

- **百兆以太网（100 Mbps）**: 约 **11-12 MB/s**
  - 瓶颈：网络带宽
  - 适用：标准办公网络

- **公网FTP（10 Mbps）**: 约 **1.2 MB/s**
  - 瓶颈：网络带宽 + 协议开销
  - 适用：互联网远程传输

**结论**: 软件性能远超网络瓶颈，实际使用速度由网络环境决定。

## 使用步骤

### 1. 设置文件夹路径
- **源文件夹**: 存放待上传图片的本地文件夹
- **目标文件夹**: 网络共享文件夹或目标存储位置  
- **备份文件夹**: 上传成功后源文件的备份位置

### 2. 配置上传参数
- **监控模式**: 
  - 定时上传：按设定间隔检查并上传文件
  - 实时监控：持续监控源文件夹变化
- **间隔时间**: 定时上传模式下的检查间隔(10-3600秒)

### 3. 测试连接
点击"测试连接"按钮验证目标文件夹是否可以正常访问

### 4. 开始上传
点击"开始上传"按钮启动上传服务

### 5. 监控状态
右侧“状态”面板可查看运行状态与进度（进度条为无限循环动画，配合文字显示 X/Y），下方“日志”面板实时输出详细信息；左右/上下分隔条均可拖拽调整尺寸

## 支持的图片格式与目录

- JPG/JPEG, PNG, BMP, TIFF, GIF, RAW（大小写不敏感）
- **v1.3新增**：用户可通过UI复选框自由选择要上传的文件类型
- 保留源目录层级（如 日期/OK 与 日期/NG）到目标与备份目录中

## 安全与权限（v1.5）

- **三级权限管理**：未登录 → 普通用户 → 管理员
- **默认启动状态**：软件启动时处于"未登录"状态，所有功能禁用，需通过"切换权限"按钮登录
- **普通用户权限**：
  - ✅ 可修改源/目标/备份文件夹路径
  - ✅ 可选择要上传的文件类型（JPG/PNG/BMP等）
  - ✅ 可操作上传（开始/暂停/停止）
  - ✅ 可测试网络连接
  - ✅ 可查看状态和日志
  - ❌ 无法修改监控模式、间隔时间、磁盘阈值、重试次数等高级设置
  - ❌ 无法设置开机自启动和自动运行
  - ❌ 无法保存配置和修改密码
- **管理员权限**：
  - ✅ 拥有所有权限
  - ✅ 可修改所有设置（路径、监控模式、阈值等）
  - ✅ 可设置开机自启动和自动运行
  - ✅ 可保存配置
  - ✅ 可修改管理员和普通用户的密码
- **密码安全**：SHA-256加密存储，无法逆向解密

### 使用说明
1. **首次启动**：软件处于"未登录"状态，所有按钮灰色不可用
2. **登录操作**：点击"切换权限"按钮
3. **选择角色**：
   - 普通用户：输入密码 `123`（适合生产线操作员）
   - 管理员：输入密码 `Tops123`（适合系统管理员）
4. **权限切换**：登录后可随时切换权限，无需重启软件
5. ⚠️ **首次使用后请管理员立即修改默认密码**

## 界面特色（v1.4）

- **清新浅蓝色主题**：采用护眼的浅蓝色背景设计，长时间使用更舒适
- **完全响应式布局**：窗口缩放时所有区域自动调整，左右/上下分隔条可拖拽
- **分栏设计**：左侧为设置和控制区，右侧上方是状态监控，下方是日志输出
- **最小尺寸保护**：窗口最小 800x550，防止控件重叠影响使用

## 智能特性（v1.3）

- **失败自动重试**：可配置重试次数（0-10次），重试间隔递增（10秒→30秒→60秒），超限后记录到 `failed_files.log`
- **暂停/恢复**：支持暂停上传并保留进度，恢复时从断点继续，不同于停止（清空状态）
- **网络自动恢复**：检测到网络断线后自动重试最多3次，失败后弹窗提醒并暂停，保留手动测试功能
- **实时监控**：磁盘空间、归档队列深度、待重试文件数量实时显示
- **文件类型过滤**：灵活选择要上传的文件类型，无需处理不需要的格式
- **文件过滤**：灵活选择要上传的文件类型，无需处理不需要的格式

## 安全特性

1. **文件完整性检验**: 通过文件大小对比确保上传完整
2. **错误处理**: 完善的异常处理机制，避免程序崩溃
3. **日志记录**: 详细的操作日志便于问题排查
4. **配置备份**: 自动保存配置防止数据丢失

## 性能优化

1. **异步处理**: 不阻塞界面响应
2. **智能检测**: 避免重复上传已存在文件
3. **网络友好**: 单线程顺序上传，避免网络拥堵

## 故障排除

### 常见问题

**Q: 提示"目标文件夹不存在"**
A: 检查网络连接和共享文件夹路径是否正确

**Q: 文件上传失败**  
A: 查看日志信息，检查磁盘空间和文件权限

**Q: 软件无响应**
A: 检查是否有大量文件在队列中，可以停止后重新启动

**Q: 上传速度慢**
A: 适当调整上传间隔时间，或检查网络带宽

**Q: 忘记密码怎么办**
A: 删除 `config.json` 中的 `users` 字段，或删除整个 `config.json` 文件，重启软件后恢复默认密码（Tops123 / 123）

**Q: 软件启动后所有按钮都是灰色的**
A: 这是正常的，软件默认处于"未登录"状态。点击"切换权限"按钮，选择"普通用户"或"管理员"并输入密码即可

**Q: 如何切换到管理员权限**
A: 点击"切换权限"按钮，选择"管理员"，输入密码 `Tops123` 即可

**Q: FTP服务器无法启动，提示端口被占用** 🆕  
A: 检查是否有其他FTP服务占用21端口，可更换端口号（如2121）或使用任务管理器关闭冲突进程

**Q: FTP客户端连接超时** 🆕  
A: 
- 检查服务器地址和端口是否正确
- 确认防火墙是否允许FTP连接
- NAT环境建议开启被动模式
- 尝试增加超时时间（默认10秒）

**Q: 混合模式下，FTP服务器和客户端如何同时工作** 🆕  
A: 混合模式自动管理两个独立进程，互不干扰。服务器接收其他设备上传的文件，客户端将本地文件上传到远程服务器

**Q: 性能测试显示上传速度很快，但实际使用慢** 🆕  
A: 性能测试在本地回环（127.0.0.1）进行，实际速度取决于网络环境：
- 千兆局域网: 约110-120 MB/s
- 百兆局域网: 约11-12 MB/s
- 公网: 取决于带宽（通常1-10 MB/s）

详见：[v2.1性能测试报告](docs/v2.1_性能测试报告.md)

**Q: 普通用户可以修改路径吗**
A: 可以！普通用户可以修改源/目标/备份文件夹路径和选择文件类型，但无法修改高级设置（监控模式、间隔等）

**Q: 普通用户无法保存配置怎么办**
A: 普通用户确实无法保存配置，这是为了防止误操作。如需保存，请切换到管理员权限

**Q: 开机自启动无法设置**
A: 只有管理员才能设置开机自启动，且需要Windows系统权限

**Q: 日志写入会不会影响性能**
A: 不会，日志采用独立线程异步写入，不会阻塞主界面

## 技术文档

- **开发任务书**: [文件上传软件开发任务书.md](docs/开发文档/文件上传软件开发任务书.md)
- **使用说明书**: [软件使用说明书_v2.0.md](docs/软件使用说明书_v2.0.md)
- **快速参考**: [v2.0_快速参考.md](docs/开发文档/v2.0_快速参考.md)
- **性能测试报告**: [v2.1_性能测试报告.md](docs/v2.1_性能测试报告.md) 🆕
- **版本说明**: [版本说明.md](docs/开发文档/版本说明.md)
- **更新日志**: [更新日志_v2.0.md](docs/历史版本/更新日志_v2.0.md)

## 技术规格

### 基础信息
- **开发语言**: Python 3.8+
- **GUI框架**: PyQt5
- **支持系统**: Windows（已适配打包版）
- **文件大小**: 支持任意大小文件

### 性能规格（v2.1实测） 🆕
- **启动时间**: < 0.01秒
- **内存占用**: 28 MB（空闲）
- **CPU占用**: < 1%（上传中）
- **FTP上传速度**: 
  - 千兆网: 110-120 MB/s
  - 百兆网: 11-12 MB/s
  - 公网: 取决于带宽
- **并发能力**: 支持5+客户端同时连接

### 协议支持（v2.1） 🆕
- **SMB协议**: Windows网络共享（\\\server\share）
- **FTP协议**: 
  - 服务器模式（被动/主动，可选TLS/SSL）
  - 客户端模式（被动/主动，可选TLS/SSL）
  - 混合模式（同时运行服务器和客户端）

## 运行与打包

### 运行源码（开发调试）

**一键启动（推荐）**
- Windows: 双击 `启动程序_pyqt.bat`
  - 脚本会自动检测并安装 PySide6 依赖
  - 如果 PySide6 安装失败，会自动尝试 PyQt5 作为后备

**手动运行**
1. 安装依赖：`pip install -r requirements.txt`
2. 运行程序：`python pyqt_app.py`

> 💡 VS Code 提示：请确保"Python: Select Interpreter"选择的是已安装 PySide6 的解释器

### 一键打包（生成免安装 .exe）

双击运行 `打包程序.bat`，脚本将自动：
1. 检查 Python 与 pip 环境
2. 安装/校验 PyInstaller
3. 打包 PySide6 版本程序
4. 在 `dist/` 目录下生成 `图片异步上传工具_PySide6_v1.0.exe`

首次运行 exe 时将自动在可执行文件目录创建：
- `logs/` 日志目录
- `config.json`（如不存在则生成默认配置）

## 日志文件

日志文件保存在 `logs/` 目录下，按日期命名：
- 格式: `upload_YYYYMMDD.log`
- 内容: 时间戳、操作类型、文件名、结果状态

## 配置文件

配置文件保存为 `config.json`，包含所有用户设置：
```json
{
  "source_folder": "源文件夹路径",
  "target_folder": "目标文件夹路径", 
  "backup_folder": "备份文件夹路径",
  "upload_interval": 30,
  "monitor_mode": "periodic",
  "disk_threshold_percent": 10,
  "retry_count": 3,
  "filter_jpg": true,
  "filter_png": true,
  "filter_bmp": true,
  "filter_tiff": true,
  "filter_gif": true,
  "filter_raw": true,
  "auto_start_windows": false,
  "auto_run_on_startup": false,
  "users": {
    "admin": "加密后的管理员密码",
    "user": "加密后的普通用户密码"
  }
}
```

⚠️ **安全提示**：
- 密码使用SHA-256加密存储，无法逆向解密
- 如忘记密码，可删除 `config.json` 中的 `users` 字段，重启软件后恢复默认密码
- 建议定期修改密码，并妥善保管

## 磁盘空间阈值

- 在"上传设置"里可设置"磁盘告警阈值(%)"（5-50%）
- 当目标或备份磁盘可用空间百分比低于该阈值时，程序会在日志中报警并暂停上传，直到空间恢复
- v1.2 起改为百分比监控，更灵活适配不同容量磁盘

## 性能优化（v1.2）

- **进度可视化**：进度条显示百分比和当前/总文件数，直观了解上传进度
- **上传/归档分离**：采用独立线程处理归档（移动到备份），避免归档IO阻塞上传，提升吞吐量
- **运行期保护**：上传时禁用"测试连接"按钮，防止误操作

## 联系支持

如遇到问题或需要技术支持，请查看日志文件并记录具体的错误信息。