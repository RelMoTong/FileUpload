# 图片异步上传工具 v2.0 - FTP 功能设计任务书

## 📋 项目信息

- **项目名称**：图片异步上传工具 v2.0
- **功能模块**：FTP/FTPS 多协议上传
- **设计日期**：2025-11-10
- **预计完成**：2025-11-30
- **设计者**：开发团队
- **版本**：v2.0-alpha

---

## 🎯 设计目标

### 核心目标
1. 支持 FTP/FTPS 协议上传图片
2. 同时支持 FTP 服务器和客户端模式
3. 保持现有 SMB/网络文件夹上传功能
4. 多线程独立处理不同协议
5. 提供友好的协议切换界面

### 性能目标
- FTP 上传速度：≥ 2 MB/s（千兆网络）
- 并发连接数：支持 5 个 FTP 客户端同时上传
- FTP 服务器并发：支持 256 个连接
- 内存占用：≤ 300 MB
- 启动时间：≤ 3 秒

### 兼容性目标
- 与 v1.9 配置文件完全兼容
- 支持 v1.9 → v2.0 无缝升级
- Windows 10/11 系统
- Python 3.8+

---

## 📐 系统架构设计

### 1. 模块划分

```
v2.0 架构
├── 核心模块（Core）
│   ├── pyqt_app.py          # 主程序（现有）
│   ├── ftp_protocol.py      # FTP 协议模块（新增）✗
│   └── protocol_manager.py  # 协议管理器（新增）✗
│
├── UI 模块（UI）
│   ├── ftp_ui_component.py  # FTP 界面组件（新增）✗
│   └── protocol_selector.py # 协议选择器（新增）✗
│
├── 上传模块（Uploader）
│   ├── smb_uploader.py      # SMB 上传器（重构）✗
│   ├── ftp_uploader.py      # FTP 上传器（新增）✗
│   └── base_uploader.py     # 上传器基类（新增）✗
│
└── 配置模块（Config）
    ├── config.json          # 配置文件（扩展）✗
    └── config_manager.py    # 配置管理器（新增）✗
```

### 2. 线程架构设计

```
线程架构（v2.0）
├── 主 UI 线程（Qt GUI 线程）
├── Worker Qt 线程
├── SMB 上传主线程（现有）
├── FTP 服务器线程（新增）✗
├── FTP 客户端上传线程 1-5（新增）✗
├── 网络监控线程（现有）
├── 归档线程（现有）
├── 自动删除线程（现有）
├── 文件操作线程池（3 workers）
├── 网络检测线程池（1 worker）
└── 日志线程池（1 worker）
```

### 3. 协议抽象设计

```python
# 协议抽象基类
class BaseProtocolUploader(ABC):
    @abstractmethod
    def connect(self) -> bool:
        """连接到目标"""
        pass
    
    @abstractmethod
    def disconnect(self) -> bool:
        """断开连接"""
        pass
    
    @abstractmethod
    def upload_file(self, local_path, remote_path) -> bool:
        """上传单个文件"""
        pass
    
    @abstractmethod
    def test_connection(self) -> bool:
        """测试连接"""
        pass
    
    @abstractmethod
    def get_status(self) -> dict:
        """获取状态"""
        pass
```

---

## 🔧 功能详细设计

### 阶段 1：FTP 核心库开发（11.10 - 11.15）

#### 1.1 FTP 服务器模块 ✗

**文件**：`ftp_protocol.py` - `FTPServerManager` 类

**功能清单**：
- [ ] ✗ 基础 FTP 服务器启动/停止
- [ ] ✗ 用户认证（用户名/密码）
- [ ] ✗ 共享目录配置
- [ ] ✗ 被动模式支持
- [ ] ✗ 端口范围配置（60000-65535）
- [ ] ✗ FTPS (TLS/SSL) 支持
- [ ] ✗ 连接数限制（最大 256，单 IP 最大 5）
- [ ] ✗ 状态监控（当前连接数、传输速度）
- [ ] ✗ 日志记录（连接/断开/上传）
- [ ] ✗ 异常处理和自动重启

**技术选型**：
- 库：`pyftpdlib`
- 线程：独立 daemon 线程
- 日志：集成到现有日志系统

**关键参数**：
```python
server_config = {
    'host': '0.0.0.0',          # 监听所有网卡
    'port': 21,                  # 默认 FTP 端口
    'username': 'upload_user',   # FTP 用户名
    'password': 'upload_pass',   # FTP 密码
    'shared_folder': 'D:/FTP_Share',  # 共享目录
    'enable_tls': False,         # 是否启用 FTPS
    'cert_file': 'cert.pem',     # TLS 证书
    'key_file': 'key.pem',       # TLS 密钥
    'passive_ports': (60000, 65535),  # 被动端口范围
    'max_cons': 256,             # 最大连接数
    'max_cons_per_ip': 5,        # 单 IP 最大连接数
}
```

**测试用例**：
- [ ] ✗ 启动服务器，使用 FileZilla 连接
- [ ] ✗ 上传文件到共享目录
- [ ] ✗ 测试被动模式
- [ ] ✗ 测试 FTPS 加密连接
- [ ] ✗ 测试连接数限制
- [ ] ✗ 测试异常处理（强制断开）

---

#### 1.2 FTP 客户端模块 ✗

**文件**：`ftp_protocol.py` - `FTPClientUploader` 类

**功能清单**：
- [ ] ✗ 连接到 FTP 服务器
- [ ] ✗ 用户认证
- [ ] ✗ 上传单个文件
- [ ] ✗ 上传整个文件夹（保持目录结构）
- [ ] ✗ 上传多个源文件夹到同一服务器
- [ ] ✗ 被动/主动模式切换
- [ ] ✗ FTPS 支持
- [ ] ✗ 断点续传（可选）
- [ ] ✗ 进度回调（用于 UI 更新）
- [ ] ✗ 连接测试
- [ ] ✗ 重试机制（失败自动重试 3 次）
- [ ] ✗ 超时处理（30 秒超时）

**技术选型**：
- 库：Python 标准库 `ftplib`
- 线程：每个客户端独立线程
- 编码：UTF-8

**关键参数**：
```python
client_config = {
    'name': 'FTP客户端1',        # 客户端名称（UI 显示）
    'host': 'ftp.example.com',  # FTP 服务器地址
    'port': 21,                  # FTP 端口
    'username': 'upload_user',   # 用户名
    'password': 'upload_pass',   # 密码
    'remote_path': '/upload/photos',  # 远程目标路径
    'enable_tls': False,         # 是否启用 FTPS
    'passive_mode': True,        # 被动模式
    'timeout': 30,               # 超时时间（秒）
    'retry_count': 3,            # 重试次数
    'local_folders': [           # 本地源文件夹列表
        'D:/Photos/Line1',
        'D:/Photos/Line2',
    ]
}
```

**测试用例**：
- [ ] ✗ 连接到公网 FTP 服务器
- [ ] ✗ 上传单个文件
- [ ] ✗ 上传文件夹（保持目录结构）
- [ ] ✗ 上传多个文件夹
- [ ] ✗ 测试 FTPS 连接
- [ ] ✗ 测试被动模式
- [ ] ✗ 测试断网重连
- [ ] ✗ 测试超时处理

---

#### 1.3 协议管理器 ✗

**文件**：`ftp_protocol.py` - `FTPProtocolManager` 类

**功能清单**：
- [ ] ✗ 统一管理 FTP 服务器和客户端
- [ ] ✗ 支持同时运行服务器 + 多个客户端
- [ ] ✗ 模式切换（server / client / both / none）
- [ ] ✗ 添加/删除客户端
- [ ] ✗ 获取整体状态
- [ ] ✗ 全局错误处理

**工作模式**：
```
模式 1：仅 FTP 服务器
  - 启动 FTP 服务器，等待其他设备连接上传

模式 2：仅 FTP 客户端
  - 连接到远程 FTP 服务器，上传文件

模式 3：服务器 + 客户端（同时）
  - 启动本地 FTP 服务器
  - 同时作为客户端连接其他 FTP 服务器

模式 4：无（使用 SMB）
  - 禁用 FTP，使用原有的 SMB/网络文件夹上传
```

**测试用例**：
- [ ] ✗ 仅启动服务器
- [ ] ✗ 仅启动客户端
- [ ] ✗ 同时启动服务器和客户端
- [ ] ✗ 动态添加/删除客户端
- [ ] ✗ 状态查询

---

### 阶段 2：UI 界面设计（11.16 - 11.20）

#### 2.1 协议选择器 ✗

**文件**：`protocol_selector.py` 或集成到 `pyqt_app.py`

**界面元素**：
```
┌─────────────────────────────────────┐
│ 上传协议设置                         │
├─────────────────────────────────────┤
│ 上传模式: [▼ SMB/网络文件夹  ]      │
│           [  FTP 服务器       ]      │
│           [  FTP 客户端       ]      │
│           [  服务器+客户端    ]      │
└─────────────────────────────────────┘
```

**功能清单**：
- [ ] ✗ 下拉框切换上传模式
- [ ] ✗ 切换时自动显示/隐藏对应配置区域
- [ ] ✗ 保存用户选择到配置文件
- [ ] ✗ 加载时恢复上次的选择

**交互逻辑**：
```
选择 "SMB/网络文件夹" → 显示 SMB 配置区，隐藏 FTP 配置区
选择 "FTP 服务器"     → 显示 FTP 服务器配置区
选择 "FTP 客户端"     → 显示 FTP 客户端配置区
选择 "服务器+客户端"  → 同时显示两个配置区
```

---

#### 2.2 FTP 服务器配置界面 ✗

**文件**：`ftp_ui_component.py` - `FTPServerConfigWidget` 类

**界面布局**：
```
┌─ FTP 服务器设置 ──────────────────────┐
│ ☑ 启用 FTP 服务器                      │
│                                         │
│ 监听地址: [0.0.0.0              ]      │
│ 端口:     [21    ] (1-65535)           │
│                                         │
│ 用户名:   [upload_user          ]      │
│ 密码:     [********             ]      │
│                                         │
│ 共享目录: [D:\FTP_Share         ]      │
│           [浏览...]                     │
│                                         │
│ ☑ 启用被动模式                         │
│   端口范围: [60000] - [65535]          │
│                                         │
│ ☐ 启用 TLS/SSL (FTPS)                  │
│   证书文件: [cert.pem] [浏览...]       │
│   密钥文件: [key.pem ] [浏览...]       │
│                                         │
│ 最大连接数:     [256 ]                 │
│ 单 IP 最大连接: [5   ]                 │
│                                         │
│ 服务器状态: ⚫ 未启动                  │
│ 当前连接数: 0                          │
│                                         │
│ [启动服务器] [停止服务器] [测试连接]   │
└─────────────────────────────────────────┘
```

**功能清单**：
- [ ] ✗ 所有配置项的输入控件
- [ ] ✗ 启用/禁用服务器复选框
- [ ] ✗ 共享目录浏览按钮
- [ ] ✗ TLS 证书/密钥选择
- [ ] ✗ 启动/停止服务器按钮
- [ ] ✗ 实时状态显示（运行/停止）
- [ ] ✗ 当前连接数显示
- [ ] ✗ 测试连接功能（使用 FTP 客户端连接自己）
- [ ] ✗ 配置验证（端口范围、目录存在性）
- [ ] ✗ 权限检查（管理员权限）

**验证规则**：
- 端口：1-65535
- 被动端口范围：60000-65535，起始 < 结束
- 共享目录：必须存在且可写
- 用户名/密码：非空
- TLS 证书/密钥：文件必须存在

---

#### 2.3 FTP 客户端配置界面 ✗

**文件**：`ftp_ui_component.py` - `FTPClientConfigWidget` 类

**界面布局**：
```
┌─ FTP 客户端设置 ──────────────────────┐
│ ☑ 启用 FTP 客户端                      │
│                                         │
│ 客户端列表:                            │
│ ┌────────────────────────────────────┐ │
│ │ 📡 FTP客户端1  [✓ 已连接]          │ │
│ │ 📡 FTP客户端2  [✗ 未连接]          │ │
│ │                                     │ │
│ └────────────────────────────────────┘ │
│ [添加客户端] [编辑] [删除]             │
│                                         │
│ ┌─ 当前客户端配置（FTP客户端1）──────┐ │
│ │ 服务器地址: [ftp.example.com    ] │ │
│ │ 端口:       [21    ]               │ │
│ │                                     │ │
│ │ 用户名:     [upload_user        ] │ │
│ │ 密码:       [********           ] │ │
│ │                                     │ │
│ │ 远程路径:   [/upload/photos     ] │ │
│ │                                     │ │
│ │ ☑ 使用被动模式                     │ │
│ │ ☐ 启用 TLS/SSL (FTPS)              │ │
│ │                                     │ │
│ │ 超时时间:   [30    ] 秒            │ │
│ │ 重试次数:   [3     ] 次            │ │
│ │                                     │ │
│ │ 本地源文件夹:                       │ │
│ │ ┌──────────────────────────────┐  │ │
│ │ │ D:\Photos\Line1              │  │ │
│ │ │ D:\Photos\Line2              │  │ │
│ │ └──────────────────────────────┘  │ │
│ │ [添加文件夹] [删除]               │ │
│ │                                     │ │
│ │ [测试连接] [保存配置]              │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

**功能清单**：
- [ ] ✗ 客户端列表显示（名称、状态）
- [ ] ✗ 添加新客户端（弹出配置对话框）
- [ ] ✗ 编辑客户端配置
- [ ] ✗ 删除客户端
- [ ] ✗ 客户端配置表单
- [ ] ✗ 多个源文件夹管理（列表 + 添加/删除）
- [ ] ✗ 测试连接功能
- [ ] ✗ 连接状态指示器（绿色✓ / 红色✗）
- [ ] ✗ 配置保存/加载

**验证规则**：
- 服务器地址：非空，格式验证（域名或 IP）
- 端口：1-65535
- 用户名/密码：非空
- 远程路径：非空，以 / 开头
- 超时时间：10-300 秒
- 重试次数：0-10 次
- 源文件夹：至少一个，且必须存在

---

#### 2.4 状态监控界面 ✗

**位置**：主界面右侧"运行状态"卡片

**新增状态显示**：
```
┌─ 运行状态 ────────────────────────────┐
│ 上传模式: FTP 客户端                   │
│ 状态: 🟢 运行中                        │
│                                         │
│ 网络状态: 🟢 正常                      │
│                                         │
│ FTP 服务器:                            │
│   状态: 🟢 运行中                      │
│   连接数: 3 / 256                      │
│   地址: 192.168.1.100:21               │
│                                         │
│ FTP 客户端:                            │
│   客户端1: 🟢 已连接 (上传中)          │
│   客户端2: 🟡 空闲                     │
│                                         │
│ 上传统计:                              │
│   当前文件: image_001.jpg              │
│   进度: 45% (2.3 MB/s)                 │
│   成功: 120 | 失败: 2 | 跳过: 5        │
│                                         │
│ 磁盘空间:                              │
│   本地磁盘: 45.2 GB (23%)              │
│   FTP 服务器: 100.5 GB (52%)           │
└─────────────────────────────────────────┘
```

**功能清单**：
- [ ] ✗ 显示当前上传模式（SMB / FTP 服务器 / FTP 客户端 / 混合）
- [ ] ✗ FTP 服务器状态（运行/停止、连接数、地址）
- [ ] ✗ FTP 客户端状态（每个客户端的连接状态）
- [ ] ✗ 实时上传速度（MB/s）
- [ ] ✗ 当前上传文件名和进度
- [ ] ✗ FTP 服务器磁盘空间（如果是本地）

---

### 阶段 3：主程序集成（11.21 - 11.25）

#### 3.1 重构现有上传模块 ✗

**目标**：将现有的 SMB 上传逻辑抽象为独立的上传器

**任务清单**：
- [ ] ✗ 创建 `base_uploader.py` - 上传器抽象基类
- [ ] ✗ 创建 `smb_uploader.py` - SMB 上传器（从 `pyqt_app.py` 提取）
- [ ] ✗ 创建 `ftp_uploader.py` - FTP 上传器（包装 FTP 客户端）
- [ ] ✗ 修改 `UploadWorker` 使用上传器抽象
- [ ] ✗ 保持 v1.9 功能完全不变（向后兼容）

**上传器接口**：
```python
class BaseUploader(ABC):
    @abstractmethod
    def initialize(self) -> bool:
        """初始化上传器"""
        pass
    
    @abstractmethod
    def upload_file(self, src: Path, progress_callback) -> bool:
        """上传单个文件"""
        pass
    
    @abstractmethod
    def cleanup(self):
        """清理资源"""
        pass
```

---

#### 3.2 配置文件扩展 ✗

**文件**：`config.json`

**新增配置字段**：
```json
{
  // v1.9 现有配置...
  
  // v2.0 新增 - FTP 配置
  "upload_protocol": "smb",  // 上传协议: "smb", "ftp_server", "ftp_client", "both"
  
  // FTP 服务器配置
  "ftp_server": {
    "enabled": false,
    "host": "0.0.0.0",
    "port": 21,
    "username": "upload_user",
    "password": "upload_pass",
    "shared_folder": "D:/FTP_Share",
    "enable_tls": false,
    "cert_file": "",
    "key_file": "",
    "passive_ports": [60000, 65535],
    "max_cons": 256,
    "max_cons_per_ip": 5
  },
  
  // FTP 客户端配置（支持多个）
  "ftp_clients": [
    {
      "name": "FTP客户端1",
      "enabled": true,
      "host": "ftp.example.com",
      "port": 21,
      "username": "upload_user",
      "password": "upload_pass",
      "remote_path": "/upload/photos",
      "enable_tls": false,
      "passive_mode": true,
      "timeout": 30,
      "retry_count": 3,
      "local_folders": [
        "D:/Photos/Line1",
        "D:/Photos/Line2"
      ]
    }
  ]
}
```

**功能清单**：
- [ ] ✗ 扩展配置数据结构
- [ ] ✗ 配置加载兼容性（v1.9 → v2.0）
- [ ] ✗ 配置保存（包含新字段）
- [ ] ✗ 配置验证（字段完整性、类型检查）
- [ ] ✗ 密码加密存储（可选）

---

#### 3.3 多线程上传管理 ✗

**目标**：同时运行 SMB、FTP 服务器、多个 FTP 客户端

**线程管理策略**：
```python
# 线程管理器
class MultiProtocolUploadManager:
    def __init__(self):
        self.smb_thread = None        # SMB 上传线程
        self.ftp_server_thread = None # FTP 服务器线程
        self.ftp_client_threads = {}  # FTP 客户端线程字典
    
    def start_smb(self):
        """启动 SMB 上传"""
        pass
    
    def start_ftp_server(self):
        """启动 FTP 服务器"""
        pass
    
    def start_ftp_client(self, name, config):
        """启动 FTP 客户端"""
        pass
    
    def stop_all(self):
        """停止所有线程"""
        pass
```

**功能清单**：
- [ ] ✗ 创建线程管理器类
- [ ] ✗ 实现 SMB 线程启动/停止
- [ ] ✗ 实现 FTP 服务器线程启动/停止
- [ ] ✗ 实现 FTP 客户端线程启动/停止（支持多个）
- [ ] ✗ 线程状态监控
- [ ] ✗ 线程间通信（Qt 信号）
- [ ] ✗ 优雅退出（等待所有线程完成）

**线程安全**：
- [ ] ✗ 使用线程锁保护共享资源
- [ ] ✗ 使用 Qt 信号槽通信（线程安全）
- [ ] ✗ 避免死锁（超时机制）

---

#### 3.4 错误处理和重试 ✗

**错误类型**：
```
1. 连接错误
   - FTP 服务器无法启动（端口被占用）
   - FTP 客户端无法连接（网络不可达）
   - 认证失败（用户名/密码错误）

2. 上传错误
   - 文件不存在
   - 权限不足
   - 磁盘空间不足
   - 网络中断

3. 超时错误
   - 连接超时
   - 上传超时
```

**处理策略**：
```python
class ErrorHandler:
    def handle_ftp_server_error(self, error):
        """处理 FTP 服务器错误"""
        if "端口被占用":
            return "FTP 服务器端口 21 已被占用，请关闭其他 FTP 服务或更换端口"
        elif "权限不足":
            return "需要管理员权限启动 FTP 服务器（端口 < 1024）"
        # ...
    
    def handle_ftp_client_error(self, error):
        """处理 FTP 客户端错误"""
        if "连接超时":
            return "连接 FTP 服务器超时，请检查网络和服务器地址"
        elif "认证失败":
            return "用户名或密码错误"
        # ...
```

**重试机制**：
- [ ] ✗ 连接失败：重试 3 次，间隔递增（5s, 10s, 20s）
- [ ] ✗ 上传失败：重试配置的次数（默认 3 次）
- [ ] ✗ 超时：自动重连，继续上传
- [ ] ✗ 记录重试日志
- [ ] ✗ 达到最大重试次数后放弃，记录到失败列表

**功能清单**：
- [ ] ✗ 创建统一错误处理器
- [ ] ✗ 每种错误的处理策略
- [ ] ✗ 用户友好的错误提示
- [ ] ✗ 错误日志记录
- [ ] ✗ 重试机制实现
- [ ] ✗ 重试计数器和状态

---

### 阶段 4：测试与优化（11.26 - 11.30）

#### 4.1 单元测试 ✗

**测试文件**：`tests/test_ftp_protocol.py`

**测试用例**：
- [ ] ✗ 测试 FTP 服务器启动/停止
- [ ] ✗ 测试 FTP 客户端连接/断开
- [ ] ✗ 测试文件上传（单文件）
- [ ] ✗ 测试文件夹上传（保持结构）
- [ ] ✗ 测试被动模式
- [ ] ✗ 测试 FTPS 加密
- [ ] ✗ 测试连接数限制
- [ ] ✗ 测试异常处理
- [ ] ✗ 测试重试机制
- [ ] ✗ 测试超时处理

---

#### 4.2 集成测试 ✗

**测试场景**：
- [ ] ✗ 场景 1：纯 SMB 模式（v1.9 兼容性）
- [ ] ✗ 场景 2：纯 FTP 服务器模式
- [ ] ✗ 场景 3：纯 FTP 客户端模式（单客户端）
- [ ] ✗ 场景 4：纯 FTP 客户端模式（多客户端）
- [ ] ✗ 场景 5：FTP 服务器 + 客户端混合模式
- [ ] ✗ 场景 6：SMB + FTP 客户端混合模式
- [ ] ✗ 场景 7：配置升级（v1.9 → v2.0）
- [ ] ✗ 场景 8：网络断开恢复
- [ ] ✗ 场景 9：长时间运行稳定性（24 小时）

---

#### 4.3 性能测试 ✗

**测试指标**：
- [ ] ✗ FTP 上传速度（单文件、多文件）
- [ ] ✗ 并发上传能力（5 个客户端同时上传）
- [ ] ✗ FTP 服务器并发连接数（模拟 100 个客户端）
- [ ] ✗ 内存占用（空闲、上传中）
- [ ] ✗ CPU 占用（空闲、上传中）
- [ ] ✗ 启动时间

**性能基准**：
```
FTP 上传速度:    ≥ 2 MB/s（千兆网络）
并发客户端:      5 个同时上传
FTP 服务器并发:  256 个连接
内存占用:        ≤ 300 MB
CPU 占用:        ≤ 15%（上传中）
启动时间:        ≤ 3 秒
```

---

#### 4.4 用户体验优化 ✗

**优化项**：
- [ ] ✗ 连接测试反馈（成功/失败提示）
- [ ] ✗ 上传进度实时更新
- [ ] ✗ 友好的错误提示
- [ ] ✗ 配置验证和提示
- [ ] ✗ 协议切换流畅度
- [ ] ✗ 界面响应速度
- [ ] ✗ 日志可读性

---

### 阶段 5：文档与发布（11.30）

#### 5.1 开发文档 ✗

**文档列表**：
- [ ] ✗ FTP 功能设计文档（本文档）
- [ ] ✗ FTP API 接口文档
- [ ] ✗ 配置文件说明（v2.0）
- [ ] ✗ 线程架构图（v2.0）
- [ ] ✗ 错误码对照表
- [ ] ✗ 性能测试报告

---

#### 5.2 用户文档 ✗

**文档列表**：
- [ ] ✗ v2.0 使用手册
- [ ] ✗ FTP 功能快速入门
- [ ] ✗ 常见问题 FAQ
- [ ] ✗ 故障排查指南
- [ ] ✗ 配置示例（典型场景）

**典型场景示例**：
```
场景 1：工厂内网上传（SMB）
场景 2：搭建 FTP 服务器接收上传
场景 3：上传到远程 FTP 服务器
场景 4：跨地域多点上传（多 FTP 客户端）
场景 5：本地接收 + 远程备份（服务器 + 客户端）
```

---

#### 5.3 版本发布 ✗

**发布清单**：
- [ ] ✗ 更新版本号：v1.9 → v2.0
- [ ] ✗ 更新 [`requirements.txt`](requirements.txt )（添加 `pyftpdlib`）
- [ ] ✗ 更新 [`打包程序.bat`](打包程序.bat )（添加 FTP 库打包）
- [ ] ✗ 生成安装包（完整包）
- [ ] ✗ 生成增量升级包（v1.9 → v2.0）
- [ ] ✗ 更新 [`README.md`](README.md )
- [ ] ✗ 更新版本说明文档
- [ ] ✗ 发布说明（Release Notes）

**发布包内容**：
```
图片异步上传工具_v2.0.zip
├── 图片异步上传工具_v2.0.exe
├── _internal\
│   ├── ... (所有依赖库)
│   ├── pyftpdlib\ (新增)
│   └── ...
├── config.json (v2.0 配置模板)
├── version.txt (2.0)
├── assets\
├── logs\
└── docs\
    ├── 使用手册_v2.0.pdf
    ├── 快速入门_FTP.pdf
    └── 更新日志_v2.0.md
```

---

## 📊 进度跟踪

### 总体进度

```
总任务数: 150+
已完成:   1   ✓ (环境测试)
进行中:   0   
待开始:   149 ✗
完成率:   1%
```

### 环境准备 ✓

- [x] ✓ 安装 pyftpdlib 库
- [x] ✓ 测试 FTP 服务器启动
- [x] ✓ 测试 FTP 客户端连接
- [x] ✓ 测试文件上传
- [x] ✓ 测试文件夹上传（保持目录结构）
- [x] ✓ 验证 pyftpdlib 功能正常

**环境测试结果**: 🎉 全部通过！

### 各阶段进度

| 阶段 | 任务数 | 已完成 | 进行中 | 待开始 | 完成率 |
|------|--------|--------|--------|--------|--------|
| 阶段 1：FTP 核心库 | 40 | 0 ✗ | 0 | 40 ✗ | 0% |
| 阶段 2：UI 界面 | 35 | 0 ✗ | 0 | 35 ✗ | 0% |
| 阶段 3：主程序集成 | 30 | 0 ✗ | 0 | 30 ✗ | 0% |
| 阶段 4：测试优化 | 25 | 0 ✗ | 0 | 25 ✗ | 0% |
| 阶段 5：文档发布 | 20 | 0 ✗ | 0 | 20 ✗ | 0% |

---

## 🎯 里程碑

- [ ] ✗ **2025-11-15**：FTP 核心库开发完成
- [ ] ✗ **2025-11-20**：UI 界面开发完成
- [ ] ✗ **2025-11-25**：主程序集成完成
- [ ] ✗ **2025-11-28**：测试完成
- [ ] ✗ **2025-11-30**：v2.0 正式发布

---

## ⚠️ 风险与挑战

### 技术风险

| 风险 | 等级 | 影响 | 应对措施 | 状态 |
|------|------|------|----------|------|
| FTP 服务器端口冲突 | 中 | 无法启动服务器 | 支持自定义端口，检测端口占用 | ✗ |
| 防火墙阻止 FTP 连接 | 高 | 无法连接 | 提供防火墙配置指南 | ✗ |
| FTPS 证书配置复杂 | 中 | 用户配置困难 | 提供证书生成工具和详细文档 | ✗ |
| 多线程死锁 | 低 | 程序卡死 | 超时机制、线程锁设计评审 | ✗ |
| FTP 性能不达标 | 中 | 上传速度慢 | 性能测试和优化 | ✗ |

### 兼容性风险

| 风险 | 等级 | 影响 | 应对措施 | 状态 |
|------|------|------|----------|------|
| v1.9 → v2.0 配置不兼容 | 高 | 用户配置丢失 | 配置自动升级机制 | ✗ |
| pyftpdlib 库依赖冲突 | 低 | 打包失败 | 版本锁定，测试兼容性 | ✗ |
| Windows 防病毒误报 | 中 | 用户无法运行 | 代码签名证书 | ✗ |

---

## 📝 开发规范

### 代码规范
- [ ] ✗ 遵循 PEP 8 编码规范
- [ ] ✗ 所有函数添加类型注解
- [ ] ✗ 所有类和函数添加文档字符串
- [ ] ✗ 关键代码添加注释
- [ ] ✗ 统一使用 UTF-8 编码

### 命名规范
- [ ] ✗ 类名：大驼峰（FTPServerManager）
- [ ] ✗ 函数名：小写下划线（upload_file）
- [ ] ✗ 变量名：小写下划线（ftp_client）
- [ ] ✗ 常量名：大写下划线（MAX_CONNECTIONS）

### Git 规范
- [ ] ✗ 提交信息格式：`[模块] 描述`
- [ ] ✗ 每个功能独立分支
- [ ] ✗ 代码审查后合并
- [ ] ✗ 打 Tag 标记版本

---

## 🔄 变更记录

| 日期 | 版本 | 变更内容 | 修改人 |
|------|------|----------|--------|
| 2025-11-10 | v1.0 | 创建初始设计任务书 | 开发团队 |
| 2025-11-10 | v1.1 | 完成环境测试，所有测试通过 ✓ | 开发团队 |

---

## ✅ 审批签字

| 角色 | 姓名 | 签字 | 日期 |
|------|------|------|------|
| 设计者 | | | |
| 审核者 | | | |
| 批准者 | | | |

---

**文档状态**: 📝 草稿  
**下次更新**: 完成阶段 1 后更新进度  
**联系方式**: 开发团队

---

> **注意**：
> - ✗ 表示待完成任务
> - ✓ 表示已完成任务
> - 🔄 表示进行中任务
> - 本文档会随开发进度持续更新
