# 模块化重构说明

## v2.3.1 模块化架构

本次重构将单文件应用（pyqt_app.py, 5234行）重构为模块化架构，提高代码可维护性。

### 新目录结构

```
src/
├── __init__.py           # 包初始化
├── main.py               # 新的程序入口（模块化版本）
├── config.py             # 配置管理模块 ✅
├── core/                 # 核心功能模块
│   ├── __init__.py
│   ├── utils.py          # 工具函数 ✅
│   └── permissions.py    # 权限管理 ✅
├── ui/                   # 用户界面模块
│   ├── __init__.py
│   ├── widgets.py        # 自定义控件（待迁移）
│   └── main_window.py    # 主窗口（待迁移）
├── workers/              # 后台工作线程
│   ├── __init__.py
│   └── upload_worker.py  # 上传线程（待迁移）
└── protocols/            # 协议模块
    ├── __init__.py
    └── ftp_protocol.py   # FTP 协议（已存在）
```

### 已完成的模块

#### 1. src/core/utils.py
提供通用工具函数：
- `get_app_dir()`: 获取应用程序数据目录
- `get_resource_path()`: 获取资源文件路径
- `get_app_version()`: 获取版本号
- `get_app_title()`: 获取应用标题

#### 2. src/core/permissions.py  
权限管理模块：
- `PermissionManager`: 权限管理器类
  - 支持三种角色：访客(guest)、普通用户(user)、管理员(admin)
  - 提供登录/登出功能
  - 基于角色的权限检查
  - 密码验证（支持明文和哈希）

#### 3. src/config.py
配置管理模块：
- `ConfigManager`: 配置管理器类
  - 配置文件加载/保存
  - 默认配置生成
  - 配置项访问

#### 4. src/main.py
新的程序入口：
- 模块化设计，职责分离
- 单例检查和唤醒功能
- 使用新的核心模块
- 保持与 pyqt_app.py 的兼容性

### 使用方法

#### 方法1：使用新的模块化入口（推荐）
```bash
python src/main.py
```

#### 方法2：使用原始入口（向后兼容）
```bash
python pyqt_app.py
```

### 重构策略

采用**渐进式重构**策略：

**第一阶段（已完成）**：
- ✅ 创建模块化目录结构
- ✅ 提取核心工具函数
- ✅ 提取权限管理逻辑
- ✅ 提取配置管理逻辑
- ✅ 创建新的程序入口

**第二阶段（待完成）**：
- ⏳ 提取自定义 UI 控件（Toast, ChipWidget, CollapsibleBox）
- ⏳ 提取上传工作线程（UploadWorker）
- ⏳ 提取主窗口类（MainWindow）

**第三阶段（待完成）**：
- ⏳ 完全迁移到新架构
- ⏳ 移除或重命名 pyqt_app.py 为兼容层

### 技术优势

1. **职责分离**：每个模块只负责一个功能领域
2. **易于测试**：独立模块便于单元测试
3. **代码复用**：核心功能可在其他项目中复用
4. **易于维护**：清晰的结构便于定位和修改
5. **向后兼容**：保留原有入口，不影响现有用户

### 打包配置

需要更新 `打包程序.bat` 以包含新模块：

```batch
--hidden-import=src.core.utils
--hidden-import=src.core.permissions
--hidden-import=src.config
```

### 开发建议

新功能开发时，建议：
1. 先在对应的模块中实现功能
2. 在 src/main.py 中集成
3. 保持 pyqt_app.py 同步（可选）

### 注意事项

- 目前 src/main.py 仍依赖 pyqt_app.py 中的 MainWindow
- 完全迁移需要逐步将 MainWindow 重构到 src/ui/main_window.py
- 建议先使用新入口测试，确保无问题后再进行完全迁移
