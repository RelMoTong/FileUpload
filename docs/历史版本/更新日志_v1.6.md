# 更新日志 v1.6

**更新日期**: 2025年10月22日

---

## 🎯 本次更新内容

### 1. 开机自启动权限优化

**改动：**
- ❌ 之前：仅管理员可以设置开机自启动
- ✅ 现在：**用户和管理员均可设置**

**原因：**
- 降低权限门槛，提高易用性
- 用户权限足以操作 `HKEY_CURRENT_USER` 注册表项

**影响：**
- UI 标签从"高级选项（需管理员权限）"改为"高级选项"
- 权限检查从 `if self.current_role != 'admin'` 改为 `if self.current_role not in ['user', 'admin']`

---

### 2. 磁盘空间实时监控

**新增功能：**
在运行状态卡片添加两个新的状态芯片：
- **目标磁盘**：显示目标文件夹所在磁盘剩余空间百分比
- **归档磁盘**：显示备份文件夹所在磁盘剩余空间百分比

**功能特性：**
- ⏱ **实时更新**：每秒更新一次（跟随定时器 tick）
- 🎨 **智能配色**：根据剩余空间动态变化
  - 🔴 **红色警告**：剩余 < 10%
  - 🟡 **黄色提示**：剩余 10-20%
  - 🔵 **蓝色/绿色正常**：剩余 ≥ 20%
- 📊 **精确显示**：显示一位小数，如 `45.3%`
- 🔄 **自动检测**：路径无效时显示 `--`

**布局变化：**
```
状态芯片从 6 个扩展到 8 个：
┌─────────┬─────────┬─────────┐
│ 已上传  │ 失败    │ 跳过    │
├─────────┼─────────┼─────────┤
│ 速率    │归档队列 │运行时间 │
├─────────┼─────────┼─────────┤
│目标磁盘 │归档磁盘 │         │ ← 新增
└─────────┴─────────┴─────────┘
```

**实现原理：**
```python
def _update_disk_space(self):
    # 获取磁盘使用情况
    usage = shutil.disk_usage(path)
    free_percent = (usage.free / usage.total) * 100
    
    # 动态改变颜色
    if free_percent < 10:
        # 红色背景 #FFEBEE
    elif free_percent < 20:
        # 黄色背景 #FFF9C3
    else:
        # 正常颜色（蓝/绿）
```

**使用场景：**
- 实时监控磁盘空间，避免上传/归档失败
- 提前预警磁盘不足，及时清理空间
- 替代旧版本的磁盘阈值检查（更直观）

---

## 📊 统计数据

- **代码行数**: 1470+ 行（新增约 40 行）
- **新增方法**: `_update_disk_space()`
- **新增芯片**: 2 个（目标磁盘、归档磁盘）
- **修改方法**: `_tick()`, `_toggle_autostart()`, `_update_ui_permissions()`

---

## 🧪 测试清单

- [x] 用户权限可以设置开机自启动
- [x] 访客权限无法设置开机自启动
- [x] 磁盘空间每秒更新
- [x] 磁盘空间显示正确（一位小数）
- [x] 空间不足时颜色变红
- [x] 路径无效时显示 `--`
- [x] 程序启动正常，无错误

---

## 🔄 升级指南

如果您从旧版本升级：

1. **无需额外操作**，直接运行新版本即可
2. **配置文件兼容**，无需修改 `config.json`
3. **用户现在可以设置开机自启动**，无需管理员权限
4. **磁盘空间会自动显示**，无需手动配置

---

## 📝 注意事项

1. **磁盘空间监控**：
   - 需要文件夹路径有效才能显示
   - 每秒更新一次，不会影响性能
   - 颜色警告阈值：10% 和 20%

2. **开机自启动**：
   - 用户权限足以操作 `HKEY_CURRENT_USER` 注册表
   - 不需要管理员权限（UAC 提升）
   - 如果遇到权限问题，请检查系统策略

---

## 🐛 已知问题

- 无已知问题

---

## 🚀 下一步计划

- [ ] 添加磁盘空间历史趋势图
- [ ] 添加磁盘空间不足时的自动清理功能
- [ ] 优化磁盘空间检测性能（缓存机制）
- [ ] 添加更多统计信息（上传速度趋势、成功率等）

---

## 🙏 反馈与建议

如有问题或建议，请联系开发者。

---

**版本**: v1.6  
**日期**: 2025-10-22  
**状态**: ✅ 稳定版
