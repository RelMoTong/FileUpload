# v2.0 更新日志 (2025-11-13)

## 🚀 重大更新：多协议支持 + UI优化

### ✨ 核心新功能

#### 1. **多协议上传支持** 📡
完全重构上传架构，支持4种协议模式：

##### 🌐 SMB（网络共享）- 保持向后兼容
- 传统 Windows 网络共享协议
- 与 v1.9 完全兼容
- 适用于局域网文件传输

##### 🖥️ FTP 服务器模式 - 全新功能
**本机作为 FTP 服务器，其他设备可连接上传文件**

**基础配置**：
- 监听地址：0.0.0.0（所有网卡）或 127.0.0.1（仅本机）
- 端口：自定义（默认2121，避免权限问题）
- 用户名/密码：自定义认证
- 共享目录：指定 FTP 根目录

**高级选项**：
- ✅ **被动模式**：适用于 NAT/防火墙环境（推荐开启）
  - 可配置被动端口范围（默认 60000-65535）
- ✅ **TLS/SSL (FTPS)**：加密连接，保护数据安全
- ✅ **连接数限制**：
  - 最大连接数：1-1000（默认256）
  - 单IP限制：1-100（默认5个）
- ✅ **一键测试**：测试配置按钮，验证服务器启动

**适用场景**：
- 移动设备上传文件到本机
- 多台设备同时上传
- 需要远程访问的场景

##### 💻 FTP 客户端模式 - 全新功能
**本机作为 FTP 客户端，连接到远程 FTP 服务器上传文件**

**基础配置**：
- 服务器地址：域名或IP
- 端口：自定义（标准端口21）
- 用户名/密码：远程服务器认证
- 远程路径：上传目标目录

**高级选项**：
- ✅ **超时配置**：10-300秒（默认30秒）
- ✅ **重试机制**：0-10次（默认3次）
- ✅ **被动模式**：NAT/防火墙穿透（推荐开启）
- ✅ **TLS/SSL (FTPS)**：连接加密服务器
- ✅ **连接测试**：一键验证服务器连通性

**适用场景**：
- 上传到远程FTP服务器
- 云端文件存储
- 跨网段传输

##### 🔄 混合模式 - 全新功能
**同时运行 FTP 服务器和客户端**

**特性**：
- 本机既是服务器又是客户端
- 可同时接收和发送文件
- 服务器和客户端独立配置
- 互不干扰，并行运行

**适用场景**：
- 文件中转站
- 双向同步
- 复杂网络环境

#### 2. **FTP 核心库** 📚
**完整的 FTP 协议实现**（位于 `src/ftp_protocol.py`）

##### FTP 服务器管理器
```python
class FTPServerManager:
    - start()          # 启动服务器
    - stop()           # 停止服务器
    - is_running()     # 检查状态
    - get_status()     # 获取详细状态
```

特性：
- ✅ 基于 `pyftpdlib` 实现
- ✅ 多线程并发处理
- ✅ 完整的认证系统
- ✅ 被动模式支持
- ✅ TLS/SSL 加密（可选）
- ✅ 连接数限制
- ✅ 详细的日志记录

##### FTP 客户端管理器
```python
class FTPClientManager:
    - connect()        # 连接服务器
    - disconnect()     # 断开连接
    - upload_file()    # 上传单文件
    - upload_folder()  # 上传文件夹（保持结构）
    - test_connection() # 测试连接
```

特性：
- ✅ 基于 Python `ftplib` 实现
- ✅ 自动重连机制
- ✅ 超时保护
- ✅ 被动模式支持
- ✅ TLS/SSL 支持（FTPS）
- ✅ 目录结构保持
- ✅ 完整的错误处理

#### 3. **UI大幅优化** 🎨

##### 可折叠卡片式布局 - 革命性改进
**问题**：高分辨率屏幕下仍需滚动，界面拥挤

**解决方案**：创建 `CollapsibleBox` 可折叠组件

**折叠功能**：
- 🖥️ FTP 服务器配置（默认折叠）
  - 点击展开显示所有配置项
  - 包含基础+高级选项
  
- 💻 FTP 客户端配置（默认折叠）
  - 超时、重试、TLS等配置
  - 按需展开，节省空间
  
- 📋 文件类型限制（默认折叠）
  - 6种图片格式复选框
  - 不常修改时保持折叠
  
- ⚡ 高级选项（默认折叠）- 5大功能整合
  - 🚀 开机自启动
  - ▶️ 启动时自动运行
  - 🔍 文件去重（哈希算法、策略）
  - 🌐 网络监控（检测间隔、自动暂停/恢复）
  - 🗑️ 自动删除（已移除，整合到高级选项）

**视觉效果**：
- ➡️ 折叠状态：显示右箭头
- ⬇️ 展开状态：显示下箭头
- 点击标题切换展开/折叠
- 平滑过渡动画

##### 空间优化对比

| 项目 | v1.9 | v2.0 | 节省 |
|------|------|------|------|
| 窗口尺寸 | 1400x950 | 1350x880 | -70px 高度 |
| 最小尺寸 | 1200x800 | 1200x750 | -50px 高度 |
| 内容宽度 | 1300px | 1250px | -50px |
| 卡片内边距 | 18px | 14px | -22% |
| 卡片间距 | 15px | 12px | -20% |
| 日志最小高度 | 400px | 300px | -100px |
| 主布局边距 | 15px | 12px | -20% |

**结果**：
- ✅ **2560x1600 分辨率下无需滚动**
- ✅ 界面更紧凑整洁
- ✅ 保持所有功能完整可访问
- ✅ 视觉清爽，避免信息过载

##### 布局细节优化
- 状态芯片从 3列 改为 **4列布局**（充分利用宽屏）
- 按钮高度优化：
  - 主按钮（开始上传）：45px
  - 次要按钮（暂停/停止）：40px
  - 功能按钮（保存/更多）：38px
  - 浏览按钮：32px
- 路径输入框高度：32px
- 标签最小宽度：90px（对齐更整齐）

##### Tooltip（工具提示）完善
为所有主要配置项添加悬停提示：

**FTP 服务器**：
- "0.0.0.0 表示监听所有网卡，127.0.0.1 仅本机可访问"
- "默认FTP端口为21，建议使用2121避免权限问题"
- "被动模式适用于NAT/防火墙环境，建议启用"

**FTP 客户端**：
- "FTP服务器地址，可以是域名或IP地址"
- "连接和传输超时时间，网络慢时可适当增加"
- "连接失败时的重试次数，0表示不重试"

**基础设置**：
- 间隔时间、磁盘阈值、重试次数等

##### 协议切换智能提示
- 选择协议后自动显示说明文字
- SMB：📁 通过 Windows 网络共享上传
- FTP服务器：🖥️ 本机作为 FTP 服务器
- FTP客户端：📤 连接到远程 FTP 服务器
- 混合模式：🔄 同时运行服务器和客户端

#### 4. **状态监控增强** 📊

##### 新增状态芯片
- 📡 **上传协议**：显示当前使用的协议（SMB/FTP服务器/FTP客户端/混合）
- 🖥️ **FTP服务器**：显示服务器状态（未启动/运行中/已停止）
- 💻 **FTP客户端**：显示客户端状态（未连接/已连接/传输中）

##### 协议状态实时更新
```python
def _update_protocol_status():
    # SMB模式：禁用FTP状态
    # FTP服务器模式：显示服务器状态
    # FTP客户端模式：显示客户端连接状态
    # 混合模式：同时显示两者
```

### 🔧 技术改进

#### 配置系统扩展
新增配置字段（完全向后兼容v1.9）：

```json
{
  "protocol": "smb",  // 新增：上传协议
  
  // FTP服务器配置
  "ftp_server": {
    "host": "0.0.0.0",
    "port": 2121,
    "user": "upload_user",
    "password": "upload_pass",
    "share_directory": "",
    "enable_passive": true,
    "passive_ports_start": 60000,
    "passive_ports_end": 65535,
    "enable_tls": false,
    "max_connections": 256,
    "max_connections_per_ip": 5
  },
  
  // FTP客户端配置
  "ftp_client": {
    "host": "",
    "port": 21,
    "user": "",
    "password": "",
    "remote_path": "/upload",
    "timeout": 30,
    "retry_count": 3,
    "passive_mode": true,
    "enable_tls": false
  }
}
```

#### 协议路由架构
```python
class ProtocolRouter:
    def upload_file(file_path, protocol, config):
        if protocol == 'smb':
            return _upload_via_smb(file_path, config)
        elif protocol == 'ftp_server':
            # 服务器模式：文件已在共享目录，无需上传
            return True
        elif protocol == 'ftp_client':
            return _upload_via_ftp_client(file_path, config)
        elif protocol == 'both':
            # 混合模式：同时处理两种协议
            return _upload_via_both(file_path, config)
```

#### 错误处理增强
- ✅ FTP连接超时保护（默认30秒）
- ✅ FTP认证失败友好提示
- ✅ 服务器端口冲突检测
- ✅ 网络断开自动重连（客户端）
- ✅ 详细的异常类型日志

### 🐛 Bug 修复

#### 1. 协议切换可见性错误 ✅
**问题**：切换协议时报错 `AttributeError: 'MainWindow' object has no attribute 'ftp_server_group'`

**原因**：改用可折叠组件后，旧的 GroupBox 变量已删除

**修复**：
```python
# 旧代码
self.ftp_server_group.setVisible(True)

# 新代码
self.ftp_server_collapsible.setVisible(True)
```

#### 2. DeprecationWarning 警告 ✅
**问题**：`'exec_' will be removed in the future. Use 'exec' instead.`

**修复**：
```python
# 优先使用新API，兼容PyQt5/PySide6
try:
    sys.exit(app.exec())  # PySide6/PyQt6
except AttributeError:
    sys.exit(app.exec_())  # PyQt5
```

#### 3. 去重功能方法名错误 ✅
**问题**：`_toggle_dedup` 方法不存在

**修复**：统一使用 `_on_dedup_toggled`

### 📊 性能指标（对比 v1.9）

| 指标 | v1.9 | v2.0 | 变化 |
|------|------|------|------|
| 协议支持 | 仅SMB | SMB+FTP服务器+FTP客户端+混合 | ⬆️ +3种 |
| 窗口高度 | 950px | 880px | ⬇️ -70px |
| 界面滚动需求 | 偶尔需要 | 完全无需 | ⬆️ 100% |
| 可折叠组件 | 0 | 4个 | 🆕 |
| 配置项Tooltip | 部分 | 全部 | ⬆️ 100% |
| 协议切换 | 无 | 实时 | 🆕 |
| FTP测试功能 | 无 | 服务器+客户端 | 🆕 |

### 🧪 测试覆盖

#### 单元测试
位置：`tests/test_ftp_protocol_comprehensive.py`

测试用例：
- ✅ FTP服务器启动/停止
- ✅ 端口冲突检测
- ✅ 无效配置处理
- ✅ FTP客户端连接/认证
- ✅ 单文件上传
- ✅ 文件夹上传（保持结构）
- ✅ 服务器+客户端集成

#### 集成测试
位置：`tests/test_integration_scenarios.py`

测试场景（**5/5 全部通过** ✅）：
- ✅ 场景1：SMB模式 - v1.9兼容性
- ✅ 场景2：FTP服务器模式 - 本机服务器
- ✅ 场景3：FTP客户端模式 - 远程上传
- ✅ 场景4：混合模式 - 双协议并行
- ✅ 场景5：配置升级 - v1.9→v2.0兼容性

### 📚 文档更新

#### 新增文档
- `docs/历史版本/更新日志_v2.0.md`（本文档）
- `docs/v2.0_快速使用指南.md` - v2.0快速入门
- `tests/test_ftp_protocol_comprehensive.py` - 测试代码
- `tests/test_integration_scenarios.py` - 集成测试

#### 更新文档
- `README.md` - 添加v2.0新功能说明
- `docs/软件使用说明书_v2.0.md` - 完整使用手册
- `docs/开发文档/版本说明.md` - 版本历史

### 🚀 升级指南

#### 从 v1.9 升级到 v2.0

##### 1. 自动兼容
- ✅ 旧配置文件自动升级
- ✅ 默认使用SMB协议（保持原有行为）
- ✅ 所有v1.9功能完全保留
- ✅ 无需手动修改配置

##### 2. 新功能启用（可选）

**启用FTP服务器模式**：
1. 打开软件
2. 在"上传协议"下拉框选择"FTP 服务器模式"
3. 展开"🖥️ FTP 服务器配置"
4. 配置监听地址、端口、用户名、密码、共享目录
5. 点击"🧪 测试配置"验证
6. 点击"💾 保存配置"

**启用FTP客户端模式**：
1. 选择"FTP 客户端模式"
2. 展开"💻 FTP 客户端配置"
3. 配置服务器地址、端口、用户名、密码、远程路径
4. 点击"🔌 测试连接"验证
5. 保存配置

##### 3. UI适配
- 界面默认折叠高级配置
- 首次使用时可逐个展开了解新功能
- 熟悉后保持折叠，节省空间

### 🌟 适用场景扩展

#### v1.9（仅SMB）
- ✅ 局域网内 Windows 共享
- ❌ 跨网段传输
- ❌ 移动设备上传
- ❌ 云端存储

#### v2.0（多协议）
- ✅ 局域网 Windows 共享（SMB）
- ✅ 本机作为FTP服务器，接收设备上传
- ✅ 上传到远程FTP服务器/云端
- ✅ 复杂网络环境（混合模式）
- ✅ NAT/防火墙穿透（被动模式）
- ✅ 加密传输（TLS/SSL）

### 🔮 已知限制

#### FTP功能限制
1. **TLS/SSL 证书**：需要手动配置证书文件（暂不支持自动生成）
2. **SFTP 协议**：暂不支持（计划v2.1添加）
3. **断点续传**：FTP上传暂不支持断点续传
4. **多线程上传**：FTP客户端仍为单线程顺序上传

#### UI限制
- 可折叠组件状态不持久化（重启后恢复折叠）
- 超宽屏（>2560px）可能有额外空白

### 🔮 未来计划（v2.1）

- [ ] SFTP 协议支持
- [ ] FTP断点续传
- [ ] TLS/SSL 证书自动生成
- [ ] FTP多线程并发上传
- [ ] 可折叠状态持久化
- [ ] FTP服务器Web管理界面
- [ ] 移动端FTP客户端App
- [ ] 数据传输加密（端到端）

---

## 版本对比总结

| 功能 | v1.9 | v2.0 |
|------|------|------|
| 上传协议 | SMB | SMB + FTP服务器 + FTP客户端 + 混合 |
| FTP支持 | ❌ | ✅ 完整实现 |
| 被动模式 | ❌ | ✅ 服务器+客户端 |
| TLS/SSL | ❌ | ✅ 可选加密 |
| 连接测试 | 仅网络ping | 协议级别测试 |
| UI布局 | 固定展开 | 可折叠卡片 |
| 界面滚动 | 需要 | 无需 |
| 窗口尺寸 | 1400x950 | 1350x880 |
| 配置Tooltip | 部分 | 全部 |
| 单元测试 | 基础 | 综合+集成 |
| 文档完整度 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |

---

**开发日期**: 2025年11月13日  
**版本**: v2.0  
**状态**: 稳定版  
**支持**: Python 3.8+, PySide6 6.0+, pyftpdlib 1.5+, Windows 10/11  
**向后兼容**: v1.0-v1.9 完全兼容
