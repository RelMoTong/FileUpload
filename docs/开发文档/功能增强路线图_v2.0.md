# 图片异步上传工具 - 功能增强路线图

📅 **创建日期**: 2025年10月22日  
📦 **当前版本**: v1.8.1  
🎯 **目标版本**: v2.0

---

## 📊 功能清单与优先级

### ✅ 已实现功能（v1.8.1）
- [x] 基础上传功能
- [x] 文件类型过滤
- [x] 磁盘空间监控
- [x] 失败重试机制
- [x] 日志文件记录
- [x] 权限系统（访客/用户/管理员）
- [x] 开机自启动
- [x] 三列布局UI

---

## 🎯 v1.9 功能增强（建议2周内完成）

### 1. 当前文件进度显示 ⭐⭐⭐
**优先级**: 高  
**工作量**: 1-2小时  
**技术点**: UI更新、进度计算

**实现内容**:
```python
# 在运行状态卡片中添加：
- 当前上传文件名（带省略号）
- 当前文件进度条（0-100%）
- 单文件上传速度（KB/s）
```

**UI设计**:
```
运行状态
├─ 状态：🟢 运行中
├─ 已上传：15 / 失败：0 / 跳过：3
├─ 速度：2.5 MB/s
├─ 当前文件：IMG_20231015_143052.jpg
├─ 文件进度：[████████░░] 75%
├─ 剩余文件：12 个
├─ 预计完成：00:05:30
└─ 运行时间：00:10:25
```

---

### 2. 智能去重（文件哈希） ⭐⭐⭐
**优先级**: 高  
**工作量**: 3-4小时  
**技术点**: MD5/SHA256计算、文件对比

**实现内容**:
```python
# 在上传设置中添加去重选项：
class DuplicateStrategy:
    SKIP = "skip"           # 跳过重复文件
    RENAME = "rename"       # 重命名（添加序号）
    OVERWRITE = "overwrite" # 覆盖现有文件
    ASK = "ask"             # 每次询问（默认）

# 新增配置项：
- 启用智能去重（复选框）
- 哈希算法选择：MD5 / SHA256
- 去重策略：跳过/重命名/覆盖/询问
- 显示哈希进度（大文件）
```

**工作流程**:
```
1. 上传前计算源文件哈希
2. 检查目标文件夹是否存在同哈希文件
3. 根据策略处理：
   - 跳过：直接归档
   - 重命名：添加 (1)、(2) 等后缀
   - 覆盖：删除旧文件，上传新文件
   - 询问：弹窗让用户选择
```

**性能优化**:
- 大文件（>100MB）显示哈希计算进度
- 缓存已计算的哈希值（避免重复计算）
- 使用增量哈希（边读边算）

---

### 3. 网络状态监控 ⭐⭐
**优先级**: 中高  
**工作量**: 2-3小时  
**技术点**: 网络检测、自动暂停/恢复

**实现内容**:
```python
# 在运行状态卡片中添加：
- 网络状态指示器：🟢 正常 / 🟡 不稳定 / 🔴 断开
- 最后检测时间
- 自动重连开关

# 在上传设置中添加：
- 网络检测间隔（5-60秒，默认10秒）
- 网络断开自动暂停（复选框，默认启用）
- 网络恢复自动继续（复选框，默认启用）
```

**检测机制**:
```python
def check_network():
    """多层次网络检测"""
    # 1. 基础检测：访问目标文件夹
    try:
        os.listdir(target_folder)
        return NetworkStatus.GOOD
    except:
        pass
    
    # 2. 中级检测：Ping 目标主机（如果是网络路径）
    if is_network_path(target_folder):
        if ping_host(extract_host(target_folder)):
            return NetworkStatus.UNSTABLE
    
    # 3. 高级检测：检查本地网络连接
    if check_local_network():
        return NetworkStatus.LOCAL_ONLY
    
    return NetworkStatus.DISCONNECTED
```

**自动处理**:
- 检测到断开 → 自动暂停 → 记录日志 → 显示通知
- 检测到恢复 → 等待5秒稳定 → 自动继续 → 记录日志

---

## 🚀 v2.0 重大更新（建议1个月内完成）

### 4. 上传历史数据库 ⭐⭐⭐
**优先级**: 高  
**工作量**: 1-2天  
**技术点**: SQLite数据库、表格视图

**数据库设计**:
```sql
CREATE TABLE upload_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    file_name TEXT NOT NULL,
    file_path TEXT NOT NULL,
    file_size INTEGER,
    file_hash TEXT,
    upload_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    status TEXT,  -- success, failed, skipped
    target_path TEXT,
    backup_path TEXT,
    retry_count INTEGER DEFAULT 0,
    error_message TEXT,
    upload_duration REAL  -- 上传耗时（秒）
);

-- 索引
CREATE INDEX idx_upload_time ON upload_history(upload_time);
CREATE INDEX idx_status ON upload_history(status);
CREATE INDEX idx_file_hash ON upload_history(file_hash);
```

**UI设计**:
新增"历史记录"标签页，包含：
- 表格视图（文件名、大小、时间、状态）
- 搜索框（文件名搜索）
- 筛选器（日期范围、状态）
- 导出按钮（Excel/CSV）
- 重新上传按钮（仅失败文件）
- 清空历史按钮

---

### 5. 上传速度图表 ⭐⭐
**优先级**: 中  
**工作量**: 1天  
**技术点**: pyqtgraph实时图表

**实现内容**:
```python
# 新增依赖：pyqtgraph
# 在运行状态卡片中添加实时速度曲线图

import pyqtgraph as pg

# 图表配置：
- X轴：时间（最近60秒）
- Y轴：速度（MB/s）
- 自动缩放
- 显示平均速度线
- 显示峰值标记
```

---

### 6. 系统托盘（后台运行） ⭐
**优先级**: 低  
**工作量**: 4-6小时  
**技术点**: QSystemTrayIcon、最小化到托盘

**实现内容**:
```python
# 系统托盘功能：
- 最小化到托盘（不退出）
- 托盘图标显示运行状态（不同颜色）
- 右键菜单：
  ├─ 显示主窗口
  ├─ 开始上传
  ├─ 暂停上传
  ├─ 停止上传
  ├─ 统计信息
  └─ 退出程序

# 通知功能：
- 上传完成通知
- 错误警告通知
- 磁盘空间不足通知
```

**命令行参数**:
```bash
# 启动时最小化到托盘
图片异步上传工具_v2.0.exe --minimized

# 启动时自动开始上传
图片异步上传工具_v2.0.exe --auto-start

# 无界面后台模式
图片异步上传工具_v2.0.exe --headless
```

---

## 📅 开发时间表

### 第1周（v1.9 Alpha）
- [x] Day 1-2: 当前文件进度显示
- [x] Day 3-4: 智能去重（哈希）
- [x] Day 5-7: 网络状态监控

### 第2周（v1.9 Beta）
- [ ] Day 1-3: 上传历史数据库
- [ ] Day 4-5: 历史记录UI
- [ ] Day 6-7: 测试和优化

### 第3-4周（v2.0）
- [ ] Week 3: 上传速度图表
- [ ] Week 3-4: 系统托盘和后台运行
- [ ] Week 4: 全面测试、文档更新、打包发布

---

## 🔧 技术要点

### 新增依赖
```txt
# 当前依赖
PySide6>=6.10.0

# v1.9 新增
# (无新增依赖)

# v2.0 新增
pyqtgraph>=0.13.0  # 实时图表
```

### 配置文件变更（v1.9）
```json
{
  // 现有配置...
  
  // v1.9 新增
  "duplicate_detection_enabled": false,
  "duplicate_hash_algorithm": "md5",
  "duplicate_strategy": "ask",
  "network_check_interval": 10,
  "network_auto_pause": true,
  "network_auto_resume": true
}
```

### 数据库文件（v2.0）
```
程序目录/
├── config.json
├── upload_history.db  # 新增：SQLite数据库
└── logs/
```

---

## 🎯 成功指标

### v1.9
- [x] 用户可以看到当前上传文件的实时进度
- [x] 智能去重可以防止重复上传相同内容的文件
- [x] 网络断开时自动暂停，恢复时自动继续

### v2.0
- [ ] 历史记录可以查询和导出
- [ ] 实时速度图表清晰可见
- [ ] 可以最小化到托盘运行，不影响其他工作

---

## 💡 建议

### 分阶段实现
1. **先实现v1.9**（重要且相对简单的功能）
2. **收集用户反馈**
3. **再实现v2.0**（复杂但不紧急的功能）

### 用户调研
建议在实现前：
- 询问实际用户最需要哪些功能
- 了解用户的使用场景和痛点
- 优先实现高频使用的功能

### 性能考虑
- 哈希计算：使用多线程，不阻塞UI
- 数据库查询：添加索引，分页加载
- 图表绘制：限制数据点数量，避免卡顿

---

## 📝 下一步行动

**立即开始实现**（今天）:
1. ✅ 创建此路线图文档
2. ⏳ 实现"当前文件进度显示"
3. ⏳ 实现"智能去重（文件哈希）"

**本周完成**:
- 完成v1.9 的3个核心功能
- 更新用户文档
- 打包测试版本

**需要确认**:
1. 是否同意这个开发计划？
2. 是否有其他更高优先级的功能？
3. 是否需要调整时间表？

---

**准备好开始了吗？让我知道是否开始实现第一个功能！** 🚀
