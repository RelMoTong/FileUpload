# 图片异步上传工具 - 项目结构说明（v3.1.1）
**最后更新**：2025-12-11  
**当前版本**：v3.1.1（单实例、依赖检查、磁盘清理异步化与国际化完善）

## 目录结构（精简后）
```
E:\Python\文件上传
├─ assets/                  # 资源：logo、mockup、脚本
│  ├─ logo.ico/.png
│  ├─ checkmark_black.svg / checkmark_gray.svg
│  ├─ save_logo.py
│  ├─ README.txt
│  └─ mockups/
│     └─ ui_v1_5.png
├─ backup/                  # 历史备份
│  └─ pyqt_app_v3.1.0_before_simplify.py
├─ dist/                    # 打包产物（当前：ImageUploadTool_v3.1.0、ImageUploadTool_v3.1.1/）
│  └─ ImageUploadTool_v3.1.1/ ...       # 可执行与 _internal 依赖
├─ docs/                    # 文档
│  ├─ README.md
│  └─ CHANGELOG.md
├─ logs/                    # 运行日志 upload_*.txt
├─ scripts/                 # 辅助脚本
│  ├─ 打包程序.bat
│  ├─ 启动程序_pyqt.bat
│  └─ fix_indent.py
├─ src/                     # 源码
│  ├─ __init__.py
│  ├─ config.py             # 配置管理
│  ├─ main.py               # 入口（依赖检查、单实例、启动主窗）
│  ├─ core/                 # 核心工具
│  │  ├─ __init__.py
│  │  ├─ utils.py           # 版本/路径工具
│  │  ├─ i18n.py            # 国际化字典与切换
│  │  ├─ resume_manager.py  # 断点/续传管理
│  │  └─ permissions.py     # 权限/访问检查
│  ├─ protocols/            # 协议实现
│  │  ├─ __init__.py
│  │  └─ ftp.py             # FTP 实现
│  ├─ ui/                   # UI 模块
│  │  ├─ __init__.py
│  │  ├─ widgets.py         # 自定义控件、磁盘清理对话框
│  │  └─ main_window.py     # 主窗口（上传逻辑等）
│  └─ workers/              # 后台线程
│     ├─ __init__.py
│     └─ upload_worker.py   # 上传线程
├─ tests/                   # 测试用例
│  ├─ test_uploader.py
│  ├─ test_performance.py
│  ├─ test_integration_v2.py
│  ├─ test_integration_scenarios.py
│  ├─ test_ftp_protocol_comprehensive.py
│  ├─ test_ftp_basic.py
│  └─ test_config_manager.py
├─ tools/                   # 开发辅助工具
│  ├─ ui_mockup_v1_5.py
│  ├─ test_helper.py
│  ├─ prepare_test_data.py
│  └─ make_icon.py
├─ ImageUploadTool_v3.1.1.spec  # PyInstaller 打包配置
├─ pyqt_app.py              # 兼容层入口（调用 src.main）
├─ qt_types.py              # Qt 类型补充
├─ pyrightconfig.json       # Pyright 类型检查配置
├─ README.md
├─ requirements.txt
├─ config.json              # 运行时配置
└─ version.txt
```

## 快速上手
- 开发运行：`python -m src.main`（或 `python pyqt_app.py`）
- 打包发布：`pyinstaller ImageUploadTool_v3.1.1.spec --clean`
- 可执行文件：`dist/ImageUploadTool_v3.1.1/ImageUploadTool_v3.1.1.exe`

## 核心代码说明
- `src/main.py`
  - 依赖检查：PySide6/PyQt5 必需，pyftpdlib 可选；缺必需时阻止启动。
  - 单实例：QLocalSocket + QSharedMemory；已有实例则发送唤醒消息并退出。
  - 启动：延迟导入 Qt（避免缺依赖时报错），创建 QApplication 与 MainWindow。
- `src/core/utils.py`
  - 版本单一来源：返回 `src.__version__`；同时处理打包/开发环境的路径。
- `src/core/i18n.py`
  - 翻译字典 `TRANSLATIONS`（zh_CN/en_US），含单位 `unit_day/second`、布尔词 `word_yes/no`。
  - `t`/`tr`：按当前语言返回文本，支持字符串格式化；`set_language` 支持监听器回调。
- `src/ui/widgets.py`（重点：磁盘清理对话框）
  - Signal 兼容：优先 `QtCore.Signal`，退化为 `pyqtSignal` 兼容 PyQt。
  - DiskCleanupDialog：
    - UI：文件夹选择、文件格式选择、自动清理配置、结果显示、操作按钮，全部使用 i18n。
    - 异步扫描：ScanWorker（QThread）用 `os.walk` 过滤扩展名，通过信号输出日志/结果。
    - 异步删除：DeleteWorker（QThread），可选 send2trash 软删除，信号更新进度与失败记录。
    - 自动清理设置：阈值、保留天数、检查间隔写回父窗口配置。
    - 窗口：滚动区域承载内容，`setFixedHeight` 控制高度，避免铺满全屏。
- `src/ui/main_window.py`
  - 主界面上传逻辑、菜单（包含磁盘清理弹窗入口）、协议切换、日志输出。
- `ImageUploadTool_v3.1.1.spec`
  - 导入 `src.__version__` 生成产物名；datas 包含 assets/version/config；hiddenimports 列出 Qt 与项目模块，避免漏打包。

## 关键流程示例（磁盘清理）
1) 打开对话框：MainWindow 调 `DiskCleanupDialog(self).exec()`。
2) 选择目录/格式：UI 中的复选框、输入框决定扫描目标与后缀。
3) 扫描：启动 ScanWorker 线程，追加日志，完成后排序文件、启用删除按钮。
4) 删除：确认弹窗 → DeleteWorker 线程；可选回收站；实时进度；完成弹窗与日志。

## Python 学习提示（结合本项目）
- 动态导入与回退：`try/except ImportError` 兼容 PySide6/PyQt5、send2trash。
- 信号槽：兼容 `QtCore.Signal`/`pyqtSignal`，线程中仅用信号更新 UI，避免直接操作控件。
- 国际化：集中翻译键，界面文本不硬编码；`tr(key, **kwargs)` 可格式化插值。
- 单实例：结合本地 socket 与共享内存，示例了进程级互斥的简单实现。
- PyInstaller：spec 读取 `__version__` 统一产物命名，datas/hiddenimports 显式声明，避免漏文件。

## 清理与维护
- 文档：仅保留 `docs/README.md`、`docs/CHANGELOG.md`；其余已合并删除。
- 产物：保留最新 `dist/ImageUploadTool_v<version>/`；旧 `dist-*` 可移出仓库。
- 临时：`build/`、`__pycache__`、旧 zip/软著材料已清理；后续可保持此策略。

## 版本摘要
- 见 `docs/CHANGELOG.md`（v3.1.1：磁盘清理异步化、回收站可选、i18n 完整；版本号单一来源）。

---

# 代码结构与注释（详细版）
> 按模块梳理主要文件的职责、关键函数/类的作用、调用关系和注意点，便于学习与维护。

## 入口与启动流程
- **pyqt_app.py**  
  - 兼容入口：把项目根目录加入 `sys.path`，导入 `src.main` 并执行 `main()`，保留旧引用以兼容历史脚本。
  - 导出常用组件（MainWindow、UploadWorker、DiskCleanupDialog 等），旧代码可直接引用。
  - 版本信息 `APP_VERSION` 使用 `get_app_version()`（单一来源）。
- **src/main.py**  
  - `check_dependencies()`：检测 PySide6/PyQt5（必需）与 pyftpdlib（可选），缺必需则阻断启动。
  - `show_dependency_warning()`：控制台提示缺少的必需/可选依赖。
  - `check_single_instance()`：QLocalSocket 连接本地 server；若已有实例，发送唤醒消息后退出；否则继续启动。
  - `main()`：先做依赖检查，再延迟导入 Qt，创建 QApplication，单实例检查，创建并显示 MainWindow。

## 核心工具
- **src/core/utils.py**  
  - 版本单一来源：导入 `src.__version__`，`get_app_version()` 直接返回该值。
  - 路径工具：`get_app_dir()` 区分开发/打包，`get_resource_path()` 打包后用 `_MEIPASS`。
- **src/core/i18n.py**  
  - `TRANSLATIONS`：中英文翻译表（含单位/布尔词等通用键）。
  - `I18n.t()` / `t()` / `tr()`：按当前语言返回文本，`tr(key, **kwargs)` 支持格式化。
  - 语言管理：`set_language` 切换后回调监听器；`add_listener`/`remove_listener` 管理监听。

## UI 组件
- **src/ui/widgets.py**
  - Signal 兼容：优先 `QtCore.Signal`，无则回退 `pyqtSignal`，适配 PySide/PyQt。
  - `CollapsibleBox`：可折叠容器，重写 `setEnabled` 时收起，避免禁用状态误导。
  - **DiskCleanupDialog**（重点）  
    - UI 分区：目标选择、格式选择、自动清理配置、结果显示、操作按钮；文案用 `tr(key)` 国际化。
    - 异步扫描：`ScanWorker`（QThread）执行 `os.walk` 过滤后缀；信号输出日志与结果；完成后排序并启用删除。
    - 异步删除：`DeleteWorker`（QThread），支持 send2trash 软删除（缺库则降级）；信号更新进度与失败日志。
    - 自动清理：阈值、保留天数、检查间隔写回父窗口配置并保存；弹窗提示保存结果。
    - 窗口布局：内容放入 `QScrollArea`，`setFixedHeight` 控制高度，避免铺满屏幕。

## 主界面
- **src/ui/main_window.py**（概览）  
  - 菜单/动作包含“磁盘清理”入口（`DiskCleanupDialog(self).exec()`）。
  - 管理上传逻辑、协议切换（SMB/FTP）、日志输出、Toast 等。
  - 国际化：文案通过 `t()` 获取，语言切换响应 i18n 监听。

## 后台线程
- **src/workers/**  
  - 上传相关线程/任务（如 UploadWorker），与 UI 解耦，通过信号反馈进度/结果。
  - 注意：线程中不要直接操作 UI 控件，使用信号-槽更新。

## 打包
- **ImageUploadTool_v3.1.1.spec**  
  - 读取 `src.__version__` 生成产物名。
  - datas：`assets/`、`version.txt`、`config.json`。
  - hiddenimports：显式列出 Qt 模块与项目子模块，避免缺失。
  - 打包命令：`pyinstaller ImageUploadTool_v3.1.1.spec --clean`，输出至 `dist/ImageUploadTool_v<version>/`。

## 关键流程示例：磁盘清理
1. MainWindow 菜单触发 `_show_disk_cleanup()` → `DiskCleanupDialog(self).exec()`
2. 选择文件夹/格式 → 点击“扫描”  
   - ScanWorker 线程遍历目录，过滤扩展名，信号实时输出日志与计数。
3. 扫描完成 → 显示文件数、总大小、最大文件，启用“执行清理”  
4. 删除确认 → DeleteWorker 线程执行删除/回收站，信号更新进度与失败项  
5. 结束弹窗提示成功/失败数量与释放空间

## Python 学习提示
- 动态导入与回退：`try/except ImportError` 兼容不同库，缺失时优雅降级（如 send2trash）。
- 信号槽线程安全：线程只发信号，不直接改 UI；主线程槽函数更新控件。
- 国际化实践：文案集中 i18n 字典，界面用 `tr(key)` 获取，便于增量翻译与切换。
- 单实例示例：本地 socket + 共享内存的轻量互斥。
- 打包细节：spec 显式声明 datas/hiddenimports，动态版本读取保持产物命名一致。
