# v2.2.0 æ¸è¿›å¼é‡æ„æŒ‡å—

**æ—¥æœŸ**: 2025-11-17  
**ç›®æ ‡**: æå‡ä»£ç è´¨é‡ã€é™ä½ç»´æŠ¤æˆæœ¬ã€å¢å¼ºç”¨æˆ·ä½“éªŒ

## ğŸ“‹ é‡æ„ä¼˜å…ˆçº§

### ğŸ”¥ é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³å¯åšï¼Œé£é™©ä½ï¼‰

#### 1. æƒé™ç®¡ç†é›†ä¸­åŒ– âœ…
**çŠ¶æ€**: å·²åˆ›å»ºPermissionManager  
**ä¸‹ä¸€æ­¥**: åœ¨pyqt_app.pyä¸­é›†æˆ

```python
# åœ¨MainWindow.__init__ä¸­
from core.permission_manager import PermissionManager
self.perm_manager = PermissionManager()

# æ›¿æ¢æ‰€æœ‰æƒé™åˆ¤æ–­
# æ—§ä»£ç ï¼š
if self.current_role in ('user', 'admin') and not self.is_running:
    
# æ–°ä»£ç ï¼š
if self.perm_manager.can_edit_config():
```

**å½±å“èŒƒå›´**: çº¦30å¤„æƒé™åˆ¤æ–­  
**å·¥ä½œé‡**: 2-3å°æ—¶  
**é£é™©**: ä½

---

#### 2. é…ç½®ç®¡ç†ç‹¬ç«‹åŒ– âœ…
**çŠ¶æ€**: å·²åˆ›å»ºConfigManager  
**ä¸‹ä¸€æ­¥**: é›†æˆåˆ°MainWindow

```python
# åœ¨MainWindow.__init__ä¸­
from core.config_manager import ConfigManager
self.config_manager = ConfigManager(self.app_dir)

# åŠ è½½é…ç½®
config = self.config_manager.load()

# ä¿å­˜é…ç½®
self.config_manager.save(config)
```

**ä¼˜åŠ¿**:
- è‡ªåŠ¨ç‰ˆæœ¬å‡çº§
- é…ç½®éªŒè¯
- é»˜è®¤å€¼ç®¡ç†

**å·¥ä½œé‡**: 3-4å°æ—¶  
**é£é™©**: ä½

---

#### 3. å•å®ä¾‹æœºåˆ¶ âœ…
**çŠ¶æ€**: å·²åˆ›å»ºSingleInstanceManager  
**ä¸‹ä¸€æ­¥**: åœ¨main()å‡½æ•°ä¸­é›†æˆ

```python
# åœ¨pyqt_app.pyçš„main()å‡½æ•°å¼€å¤´
from core.single_instance import SingleInstanceManager

app = QtWidgets.QApplication(sys.argv)
instance_manager = SingleInstanceManager()

if instance_manager.is_already_running():
    # æ¿€æ´»å·²å­˜åœ¨çš„çª—å£
    instance_manager.activate_existing_instance()
    QtWidgets.QMessageBox.information(
        None, 
        'ç¨‹åºå·²è¿è¡Œ',
        'æ£€æµ‹åˆ°ç¨‹åºå·²åœ¨è¿è¡Œï¼Œå°†æ¿€æ´»å·²æœ‰çª—å£ã€‚'
    )
    sys.exit(0)
```

**å·¥ä½œé‡**: 1å°æ—¶  
**é£é™©**: æä½

---

#### 4. ä¸Šä¼ ä¸­ç¦æ­¢ä¿å­˜é…ç½® ğŸ†•
**å½“å‰é—®é¢˜**: ä¸Šä¼ ä¸­ä»å¯ä¿å­˜é…ç½®  
**ä¿®å¤æ–¹æ¡ˆ**:

```python
def _save_config(self):
    # v2.2.0 æƒé™æ£€æŸ¥ï¼šè¿è¡Œä¸­ä¸å…è®¸ä¿å­˜é…ç½®
    if self.is_running:
        self._append_log("âŒ ä¸Šä¼ è¿è¡Œä¸­ä¸å…è®¸ä¿å­˜é…ç½®")
        self._toast('è¯·å…ˆåœæ­¢ä¸Šä¼ å†ä¿å­˜é…ç½®', 'warning')
        return
```

**å·¥ä½œé‡**: 15åˆ†é’Ÿ  
**é£é™©**: æä½

---

#### 5. æ‰˜ç›˜é€šçŸ¥å¼€å…³ ğŸ†•
**æ–°å¢é…ç½®é¡¹**:
- `enable_notifications`: æ˜¯å¦å¯ç”¨é€šçŸ¥
- `notification_level`: all/important/errors

```python
# åœ¨_show_notification()ä¸­
def _show_notification(self, title: str, message: str, level='info'):
    if not self.enable_notifications:
        return
    
    if self.notification_level == 'errors' and level != 'error':
        return
    
    if self.notification_level == 'important' and level == 'info':
        return
    
    # æ˜¾ç¤ºé€šçŸ¥...
```

**å·¥ä½œé‡**: 1-2å°æ—¶  
**é£é™©**: ä½

---

### âš¡ ä¸­ä¼˜å…ˆçº§ï¼ˆéœ€è¦é‡æ„ï¼Œé£é™©ä¸­ç­‰ï¼‰

#### 6. æ—¥å¿—æ–‡ä»¶è½®è½¬ ğŸ†•
**æ–¹æ¡ˆ**: ä½¿ç”¨Python loggingæ¨¡å—çš„RotatingFileHandler

```python
import logging
from logging.handlers import RotatingFileHandler

# è®¾ç½®æ—¥å¿—è½®è½¬
log_file = self.app_dir / 'logs' / 'upload.log'
handler = RotatingFileHandler(
    log_file,
    maxBytes=10*1024*1024,  # 10MB
    backupCount=5,
    encoding='utf-8'
)
formatter = logging.Formatter('[%(asctime)s] %(message)s')
handler.setFormatter(formatter)

self.logger = logging.getLogger('UploadTool')
self.logger.addHandler(handler)
```

**å·¥ä½œé‡**: 3-4å°æ—¶  
**é£é™©**: ä¸­ï¼ˆéœ€è¦æµ‹è¯•æ—¥å¿—è¾“å‡ºï¼‰

---

#### 7. å¤±è´¥æ–‡ä»¶æ¸…å• ğŸ†•
**æ–°å¢æ•°æ®ç»“æ„**:

```python
# åœ¨Workerä¸­
self.success_files = []  # æˆåŠŸæ–‡ä»¶åˆ—è¡¨
self.failed_files = []   # å¤±è´¥æ–‡ä»¶åˆ—è¡¨
self.skipped_files = []  # è·³è¿‡æ–‡ä»¶åˆ—è¡¨

# å¤±è´¥æ–‡ä»¶è¯¦ç»†ä¿¡æ¯
self.failed_details = {}  # {file_path: error_message}
```

**UIæ”¹è¿›**:
- æ·»åŠ "æŸ¥çœ‹å¤±è´¥æ–‡ä»¶"æŒ‰é’®
- æ·»åŠ "ä»…é‡è¯•å¤±è´¥æ–‡ä»¶"åŠŸèƒ½
- å¯¼å‡ºå¤±è´¥æ–‡ä»¶åˆ—è¡¨åˆ°CSV

**å·¥ä½œé‡**: 6-8å°æ—¶  
**é£é™©**: ä¸­

---

#### 8. é”™è¯¯åˆ†ç±»æç¤º ğŸ†•
**å®ç°æ–¹æ¡ˆ**:

```python
class UploadError(Exception):
    """ä¸Šä¼ é”™è¯¯åŸºç±»"""
    def __init__(self, message: str, error_type: str):
        self.message = message
        self.error_type = error_type  # ftp_auth, network, permission, disk_full

def _handle_upload_error(self, e: Exception, file_path: str):
    if isinstance(e, UploadError):
        if e.error_type == 'ftp_auth':
            self._append_log("âŒ æ— æ³•è¿æ¥åˆ°FTPæœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥è´¦å·å¯†ç /ç½‘ç»œ")
        elif e.error_type == 'permission':
            self._append_log("âŒ ç›®æ ‡å…±äº«ç›®å½•æ— å†™å…¥æƒé™")
        elif e.error_type == 'disk_full':
            self._append_log("âŒ ç£ç›˜ç©ºé—´ä¸è¶³")
```

**å·¥ä½œé‡**: 4-5å°æ—¶  
**é£é™©**: ä¸­

---

#### 9. FTPé‡è¿ç­–ç•¥ ğŸ†•
**å®ç°æ–¹æ¡ˆ**:

```python
# åœ¨Workerä¸­
self.consecutive_failures = 0
self.max_consecutive_failures = 3

def _upload_file_with_retry(self, file_path):
    try:
        result = self._upload_file(file_path)
        self.consecutive_failures = 0  # é‡ç½®å¤±è´¥è®¡æ•°
        return result
    except Exception as e:
        self.consecutive_failures += 1
        
        if self.consecutive_failures >= self.max_consecutive_failures:
            self._append_log(f"âš ï¸ è¿ç»­å¤±è´¥{self.max_consecutive_failures}æ¬¡ï¼Œå°è¯•é‡å»ºè¿æ¥...")
            self._reconnect_ftp()
            self.consecutive_failures = 0
        
        raise
```

**å·¥ä½œé‡**: 3-4å°æ—¶  
**é£é™©**: ä¸­

---

### ğŸ”„ ä½ä¼˜å…ˆçº§ï¼ˆå¤§è§„æ¨¡é‡æ„ï¼Œé£é™©é«˜ï¼‰

#### 10. ä¸šåŠ¡é€»è¾‘ä¸UIè§£è€¦
**ç›®æ ‡**: åˆ›å»ºç‹¬ç«‹çš„æœåŠ¡ç±»

éœ€è¦åˆ›å»ºï¼š
- UploadManagerï¼ˆä¸Šä¼ é˜Ÿåˆ—ç®¡ç†ï¼‰
- ProtocolClientï¼ˆåè®®å°è£…ï¼‰
- CleanupManagerï¼ˆç£ç›˜æ¸…ç†ï¼‰
- DedupServiceï¼ˆå»é‡æœåŠ¡ï¼‰

**å·¥ä½œé‡**: 40-60å°æ—¶  
**é£é™©**: é«˜ï¼ˆéœ€è¦å…¨é¢æµ‹è¯•ï¼‰

**å»ºè®®**: åœ¨v2.3.0ç‰ˆæœ¬ä¸­å®æ–½

---

## ğŸ› ï¸ å®æ–½å»ºè®®

### ç¬¬ä¸€å‘¨ï¼ˆå¿«é€Ÿè§æ•ˆï¼‰
1. âœ… æƒé™ç®¡ç†é›†ä¸­åŒ–
2. âœ… é…ç½®ç®¡ç†ç‹¬ç«‹åŒ–
3. âœ… å•å®ä¾‹æœºåˆ¶
4. âœ… ä¸Šä¼ ä¸­ç¦æ­¢ä¿å­˜é…ç½®
5. âœ… æ‰˜ç›˜é€šçŸ¥å¼€å…³

### ç¬¬äºŒå‘¨ï¼ˆç¨³å®šæ€§æå‡ï¼‰
6. æ—¥å¿—æ–‡ä»¶è½®è½¬
7. å¤±è´¥æ–‡ä»¶æ¸…å•
8. é”™è¯¯åˆ†ç±»æç¤º
9. FTPé‡è¿ç­–ç•¥

### v2.3.0ï¼ˆæ¶æ„é‡æ„ï¼‰
10. å®Œæ•´çš„ä¸šåŠ¡é€»è¾‘ä¸UIè§£è€¦

---

## ğŸ“Š é£é™©è¯„ä¼°

| æ”¹è¿›é¡¹ | é£é™©ç­‰çº§ | å›æ»šéš¾åº¦ | å»ºè®® |
|-------|---------|---------|------|
| æƒé™ç®¡ç† | ä½ | å®¹æ˜“ | ç«‹å³å®æ–½ |
| é…ç½®ç®¡ç† | ä½ | å®¹æ˜“ | ç«‹å³å®æ–½ |
| å•å®ä¾‹ | æä½ | å®¹æ˜“ | ç«‹å³å®æ–½ |
| ç¦æ­¢é…ç½®ä¿å­˜ | æä½ | å®¹æ˜“ | ç«‹å³å®æ–½ |
| é€šçŸ¥å¼€å…³ | ä½ | å®¹æ˜“ | æœ¬å‘¨å®Œæˆ |
| æ—¥å¿—è½®è½¬ | ä¸­ | ä¸­ç­‰ | å……åˆ†æµ‹è¯• |
| å¤±è´¥æ¸…å• | ä¸­ | ä¸­ç­‰ | å……åˆ†æµ‹è¯• |
| é”™è¯¯åˆ†ç±» | ä¸­ | ä¸­ç­‰ | å……åˆ†æµ‹è¯• |
| FTPé‡è¿ | ä¸­ | å›°éš¾ | å……åˆ†æµ‹è¯• |
| æ¶æ„é‡æ„ | é«˜ | å›°éš¾ | ä¸‹ç‰ˆæœ¬ |

---

## ğŸ’¡ å…·ä½“å®æ–½æ­¥éª¤

### Step 1: é›†æˆPermissionManager

```python
# 1. å¯¼å…¥
from core.permission_manager import PermissionManager

# 2. åˆå§‹åŒ–
def __init__(self):
    # ...
    self.perm_manager = PermissionManager()

# 3. æ›´æ–°æƒé™çŠ¶æ€
def _on_login(self):
    self.perm_manager.set_role(self.current_role)
    self._update_ui_permissions()

def _on_start(self):
    self.perm_manager.set_running(True)
    self._update_ui_permissions()

# 4. ä½¿ç”¨æƒé™åˆ¤æ–­
def _update_ui_permissions(self):
    # è·¯å¾„ç¼–è¾‘
    can_edit = self.perm_manager.can_edit_paths()
    self.src_edit.setReadOnly(not can_edit)
    self.tgt_edit.setReadOnly(not can_edit)
    
    # åè®®é€‰æ‹©
    self.combo_protocol.setEnabled(self.perm_manager.can_change_protocol())
    
    # ä¿å­˜æŒ‰é’®
    self.btn_save.setEnabled(self.perm_manager.can_save_config())
    
    # ä¸Šä¼ æ§åˆ¶
    self.btn_start.setEnabled(self.perm_manager.can_start_upload())
    self.btn_pause.setEnabled(self.perm_manager.can_pause_upload())
    self.btn_stop.setEnabled(self.perm_manager.can_stop_upload())
```

### Step 2: é›†æˆConfigManager

```python
# 1. å¯¼å…¥
from core.config_manager import ConfigManager

# 2. åˆå§‹åŒ–
def __init__(self):
    # ...
    self.config_manager = ConfigManager(self.app_dir)

# 3. åŠ è½½é…ç½®
def _load_config(self):
    config = self.config_manager.load()
    
    # åº”ç”¨é…ç½®åˆ°UI
    self.src_edit.setText(config.get('source_folder', ''))
    self.tgt_edit.setText(config.get('target_folder', ''))
    # ...

# 4. ä¿å­˜é…ç½®
def _save_config(self):
    if not self.perm_manager.can_save_config():
        self._toast('æ— æƒé™ä¿å­˜é…ç½®', 'warning')
        return
    
    config = {
        'source_folder': self.src_edit.text(),
        'target_folder': self.tgt_edit.text(),
        # ...
    }
    
    if self.config_manager.save(config):
        self._toast('é…ç½®å·²ä¿å­˜', 'success')
    else:
        self._toast('é…ç½®ä¿å­˜å¤±è´¥', 'danger')
```

### Step 3: é›†æˆSingleInstanceManager

```python
# åœ¨main()å‡½æ•°ä¸­
def main():
    app = QtWidgets.QApplication(sys.argv)
    
    # å•å®ä¾‹æ£€æŸ¥
    from core.single_instance import SingleInstanceManager
    instance_mgr = SingleInstanceManager("ImageUploadTool_v2.2.0")
    
    if instance_mgr.is_already_running():
        instance_mgr.activate_existing_instance()
        QtWidgets.QMessageBox.information(
            None,
            'ç¨‹åºå·²è¿è¡Œ',
            'æ£€æµ‹åˆ°ç¨‹åºå·²åœ¨è¿è¡Œä¸­ï¼\n\nå°†æ¿€æ´»å·²æœ‰çª—å£ï¼Œå½“å‰çª—å£å³å°†å…³é—­ã€‚',
            QtWidgets.QMessageBox.StandardButton.Ok
        )
        return 0
    
    # æ­£å¸¸å¯åŠ¨
    w = MainWindow()
    w.show()
    return app.exec()
```

---

## ğŸ¯ æœ¬æ¬¡é‡æ„ç›®æ ‡ï¼ˆç«‹å³å¯åšï¼‰

å»ºè®®å…ˆå®æ–½å‰5é¡¹ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰ï¼Œå·¥ä½œé‡çº¦**8-10å°æ—¶**ï¼š

1. âœ… æƒé™ç®¡ç†é›†ä¸­åŒ–ï¼ˆ2-3hï¼‰
2. âœ… é…ç½®ç®¡ç†ç‹¬ç«‹åŒ–ï¼ˆ3-4hï¼‰  
3. âœ… å•å®ä¾‹æœºåˆ¶ï¼ˆ1hï¼‰
4. âœ… ä¸Šä¼ ä¸­ç¦æ­¢ä¿å­˜ï¼ˆ15minï¼‰
5. âœ… æ‰˜ç›˜é€šçŸ¥å¼€å…³ï¼ˆ1-2hï¼‰

**é¢„æœŸæ”¶ç›Š**:
- ä»£ç å¯è¯»æ€§æå‡30%
- æƒé™bugå‡å°‘90%
- ç”¨æˆ·ä½“éªŒæå‡
- ä¸ºåç»­é‡æ„æ‰“ä¸‹åŸºç¡€

---

æ˜¯å¦éœ€è¦æˆ‘å¸®ä½ å®æ–½è¿™äº›æ”¹è¿›ï¼Ÿæˆ‘å¯ä»¥ï¼š
1. é€ä¸ªå®æ–½é«˜ä¼˜å…ˆçº§æ”¹è¿›
2. æä¾›è¯¦ç»†çš„æµ‹è¯•ç”¨ä¾‹
3. ç”ŸæˆGitæäº¤è¯´æ˜
