# 图片异步上传工具 v2.1.1 更新说明

📅 **发布日期**: 2025-11-17  
🏷️ **版本号**: v2.1.1  
📦 **基于版本**: v2.1

---

## 🎯 核心功能

### ✨ 可选备份功能

**功能描述**:  
用户现在可以自由选择是否启用备份功能。禁用备份后，上传成功的文件将直接删除，无需手动清理备份文件夹。

**使用场景**:
- ✅ **启用备份** (默认): 适合需要保留源文件的用户，上传成功后文件移动到备份文件夹
- ⛔ **禁用备份**: 适合不需要保留源文件的用户，上传成功后直接删除源文件，节省磁盘空间

**界面改进**:
1. 新增 "✓ 启用备份功能" 复选框（文件夹设置区域）
2. 添加功能说明提示文本
3. 禁用备份时，备份文件夹路径输入框和浏览按钮自动变灰

---

## 📋 详细改进

### 1. 配置管理
- 新增 `enable_backup` 配置项（默认: `true`）
- 配置文件自动保存和加载备份启用状态
- 切换备份开关时自动刷新UI控件状态

### 2. 权限控制优化
- 备份浏览按钮启用条件: **登录用户** + **未运行** + **备份已启用**
- 备份路径输入框只读条件: **未登录** 或 **运行中** 或 **备份未启用**
- 备份启用复选框: 仅登录用户可修改

### 3. 路径验证优化
- 禁用备份时跳过备份文件夹路径验证
- 禁用备份时跳过备份路径相同性检查
- 简化启动流程，减少不必要的校验

### 4. 归档逻辑优化
- **启用备份**: 上传成功后移动文件到备份文件夹（保留原逻辑）
- **禁用备份**: 上传成功后直接删除源文件（新增逻辑）
- 日志输出区分两种模式: "📦 已归档" vs "🗑️ 已删除"

### 5. 日志信息优化
启动上传时根据备份状态显示不同信息:
```
启用备份:
  备份文件夹: E:\Backup

禁用备份:
  备份功能: 已禁用（上传成功后将删除源文件）
```

---

## 🔧 技术实现

### 核心代码修改

#### 1. 初始化变量
```python
self.enable_backup = True  # v2.1.1 新增：是否启用备份
```

#### 2. UI组件
```python
self.cb_enable_backup = QtWidgets.QCheckBox("✓ 启用备份功能")
self.cb_enable_backup.toggled.connect(self._on_backup_toggled)
```

#### 3. 归档逻辑
```python
if self.enable_backup and self.backup:
    # 启用备份：移动到备份文件夹
    shutil.move(src_path, bkp_path)
else:
    # 未启用备份：直接删除源文件
    os.remove(src_path)
```

---

## 📊 版本对比

| 功能 | v2.1 | v2.1.1 |
|------|------|--------|
| 备份功能 | 强制启用 | 可选启用/禁用 |
| 备份路径验证 | 始终验证 | 禁用时跳过 |
| 上传后处理 | 移动到备份 | 移动或删除（可选） |
| UI控制 | 固定 | 动态变灰 |
| 磁盘空间占用 | 较高 | 较低（禁用备份时） |

---

## 🎨 用户体验提升

1. **灵活性** ⬆️: 用户可根据需求选择是否保留备份
2. **易用性** ⬆️: 清晰的提示文本和动态UI反馈
3. **安全性** ➡️: 默认启用备份，保护用户数据
4. **性能** ➡️: 禁用备份时减少磁盘写入操作

---

## ⚠️ 注意事项

1. **默认行为**: 升级后备份功能默认启用，保持与旧版本一致
2. **数据安全**: 禁用备份前请确保目标文件夹已正确上传
3. **配置兼容**: 旧配置文件自动兼容，未设置时默认启用备份
4. **权限要求**: 禁用备份时仍需确保对源文件夹有删除权限

---

## 🚀 升级建议

### 从 v2.1 升级
- ✅ 配置文件完全兼容，无需修改
- ✅ 备份功能默认启用，行为不变
- ✅ 可选择性禁用备份以节省空间

### 使用建议
- 🔰 **新手用户**: 保持默认启用备份，安全第一
- 💾 **磁盘紧张**: 禁用备份，定期检查上传结果
- 🏢 **企业用户**: 根据存储策略自定义配置

---

## 📝 更新日志

- feat: 新增可选备份功能
- feat: 添加备份启用复选框和说明文本
- fix: 优化权限控制逻辑支持备份状态
- fix: 优化路径验证跳过禁用备份检查
- fix: 优化归档逻辑支持删除模式
- style: 完善UI控制实现动态变灰效果
- docs: 更新版本号到v2.1.1

---

## 🔗 相关链接

- **GitHub仓库**: https://github.com/RelMoTong/FileUpload
- **问题反馈**: https://github.com/RelMoTong/FileUpload/issues
- **功能建议**: 欢迎提交Issue或Pull Request

---

**开发团队**: RelMoTong  
**技术支持**: GitHub Issues
