# 更新日志 v1.7

**更新日期**: 2025年10月22日

---

## 🎯 本次更新内容

### 1. 📂 浏览文件夹时默认打开当前路径

**改进：**
- 文件夹选择对话框现在会自动打开当前已配置的路径
- 如果当前路径不存在或为空，则打开默认位置

**实现：**
```python
def _choose_source(self):
    current = self.src_edit.text()
    start_dir = current if current and os.path.exists(current) else ""
    d = QtWidgets.QFileDialog.getExistingDirectory(self, "选择源文件夹", start_dir)
```

**用户体验：**
- ✅ 无需每次从根目录开始浏览
- ✅ 修改路径更加便捷
- ✅ 减少操作步骤

---

### 2. 🔍 开始上传前路径验证

**新增功能：**
- 开始上传前自动验证所有文件夹路径是否存在
- 路径不存在时弹窗显示详细错误信息
- 验证失败阻止上传启动

**验证项目：**
- ✅ 源文件夹路径是否为空
- ✅ 源文件夹是否存在
- ✅ 目标文件夹路径是否为空
- ✅ 目标文件夹是否存在
- ✅ 备份文件夹路径是否为空
- ✅ 备份文件夹是否存在

**错误提示：**
```
❌ 路径验证失败，无法开始上传！

详细信息：
• 源文件夹不存在: D:/不存在的路径
• 目标文件夹路径为空
```

---

### 3. 📝 详细的操作日志

**日志增强：**
为每一步操作添加了详细的日志记录，包括：

**文件夹选择：**
```
📂 正在选择源文件夹...
✓ 已选择源文件夹: D:/source
⚠ 配置已修改，请点击"保存配置"按钮确认
```

**配置加载：**
```
📖 正在加载配置文件...
✓ 配置文件加载成功
✓ 已加载配置: 源=D:/source
✓ 已加载配置: 目标=Y:/target
✓ 已加载配置: 备份=D:/backup
```

**路径验证：**
```
🔍 正在验证文件夹路径...
✓ 源文件夹路径有效: D:/source
✓ 目标文件夹路径有效: Y:/target
✓ 备份文件夹路径有效: D:/backup
✓ 所有路径验证通过
```

**上传启动：**
```
==================================================
🚀 准备开始上传任务...
✓ 配置验证通过，开始启动上传任务...
📋 上传配置:
  源文件夹: D:/source
  目标文件夹: Y:/target
  备份文件夹: D:/backup
  间隔时间: 30秒
  重试次数: 3次
  文件类型: .jpg, .png, .bmp
✓ 上传任务已启动
```

**停止上传：**
```
🛑 正在停止上传任务...
✓ 上传任务已停止
==================================================
```

**权限更新：**
```
🔐 更新权限: 当前角色=admin, 运行状态=已停止
```

---

### 4. 🔒 未登录状态禁止修改路径

**权限控制：**
- **访客状态**：所有路径输入框设为只读，浏览按钮禁用
- **用户/管理员**：可以修改路径
- **运行中**：无论什么角色，路径都不可修改

**实现：**
```python
def _update_ui_permissions(self):
    is_guest = self.current_role == 'guest'
    is_user_or_admin = self.current_role in ['user', 'admin']
    
    # 未登录或运行中时设为只读
    self.src_edit.setReadOnly(is_guest or self.is_running)
    self.tgt_edit.setReadOnly(is_guest or self.is_running)
    self.bak_edit.setReadOnly(is_guest or self.is_running)
    
    # 未登录或运行中时禁用浏览按钮
    btn.setEnabled(is_user_or_admin and not self.is_running)
```

**状态组合：**
| 角色 | 运行状态 | 路径可编辑 | 浏览按钮 |
|------|---------|-----------|---------|
| 访客 | 停止 | ❌ 只读 | ❌ 禁用 |
| 访客 | 运行 | ❌ 只读 | ❌ 禁用 |
| 用户 | 停止 | ✅ 可编辑 | ✅ 启用 |
| 用户 | 运行 | ❌ 只读 | ❌ 禁用 |
| 管理员 | 停止 | ✅ 可编辑 | ✅ 启用 |
| 管理员 | 运行 | ❌ 只读 | ❌ 禁用 |

---

### 5. ⚙️ 配置修改确认机制

**新增功能：**
- 路径修改后显示"配置已修改"提示
- 开始上传前检测配置是否已保存
- 未保存时弹出确认对话框

**确认对话框选项：**
1. **选择"是"**：保存配置并使用新路径上传
2. **选择"否"**：放弃修改，恢复已保存的配置并上传
3. **选择"取消"**：取消开始上传

**工作流程：**
```
修改路径
    ↓
⚠ 配置已修改，请点击"保存配置"按钮确认
    ↓
点击"开始上传"
    ↓
检测到配置未保存
    ↓
弹出确认对话框
    ↓
┌─────────┬──────────┬────────┐
│ 是(保存) │ 否(回退) │ 取消   │
└─────────┴──────────┴────────┘
    ↓           ↓          ↓
  保存配置    恢复配置    取消上传
    ↓           ↓
  使用新路径  使用旧路径
    ↓           ↓
      开始上传
```

**实现：**
```python
def _mark_config_modified(self):
    """标记配置已修改"""
    self.config_modified = True
    self._append_log('⚠ 配置已修改，请点击"保存配置"按钮确认')

# 在 _on_start() 中检查
if self.config_modified:
    # 弹出确认对话框
    if result == Yes:
        self._save_config()  # 保存新配置
    elif result == No:
        # 恢复旧配置
        self.src_edit.setText(self.saved_config.get('source_folder', ''))
        # ...
```

---

### 6. 🚫 上传过程中禁止修改路径

**保护机制：**
- 上传开始时自动锁定所有路径输入框（只读）
- 上传开始时自动禁用所有浏览按钮
- 上传停止时自动恢复编辑权限（根据登录状态）

**实现时机：**
- **开始上传** (`_on_start()`)：锁定路径编辑
- **停止上传** (`_on_stop()`)：恢复路径编辑

**代码：**
```python
# 开始时锁定
self.src_edit.setReadOnly(True)
self.tgt_edit.setReadOnly(True)
self.bak_edit.setReadOnly(True)
for btn in browse_buttons:
    btn.setEnabled(False)

# 停止时恢复
is_user_or_admin = self.current_role in ['user', 'admin']
self.src_edit.setReadOnly(not is_user_or_admin)
self.tgt_edit.setReadOnly(not is_user_or_admin)
self.bak_edit.setReadOnly(not is_user_or_admin)
for btn in browse_buttons:
    btn.setEnabled(is_user_or_admin)
```

**安全性：**
- ✅ 防止上传过程中误修改路径
- ✅ 避免路径改变导致上传混乱
- ✅ 确保上传任务的路径一致性

---

### 7. ⏱ 磁盘空间检查频率可配置

**新增设置：**
- 在"上传设置"卡片添加"磁盘检查间隔(秒)"配置项
- 可设置范围：1-60 秒
- 默认值：5 秒

**实现原理：**
```python
# 定时器每0.5秒触发一次
self._timer.setInterval(500)

# 计数器累计，达到间隔时检查
def _tick(self):
    self.disk_check_counter += 1
    # 5秒间隔 = 10次tick (5 * 2)
    if self.disk_check_counter >= self.disk_check_interval * 2:
        self.disk_check_counter = 0
        self._update_disk_space()
```

**配置保存：**
- 配置项保存到 `config.json` 的 `disk_check_interval` 字段
- 启动时自动加载上次设置的间隔
- 修改后立即生效，无需重启

**优势：**
- ✅ 减少不必要的磁盘 I/O
- ✅ 降低系统资源占用
- ✅ 用户可根据实际需求调整
- ✅ 快速网络环境可设置更短间隔
- ✅ 慢速网络环境可设置更长间隔

---

## 📊 功能对比

### 路径管理改进

| 功能 | v1.6 | v1.7 |
|------|------|------|
| 浏览默认路径 | ❌ 每次从根目录开始 | ✅ 打开当前路径 |
| 路径验证 | ⚠️ 仅检查是否为空 | ✅ 检查路径是否存在 |
| 验证失败提示 | ⚠️ Toast提示 | ✅ 弹窗详细说明 |
| 配置修改提示 | ❌ 无 | ✅ 日志警告 |
| 配置保存确认 | ❌ 直接使用修改 | ✅ 弹窗确认或回退 |
| 运行中锁定 | ❌ 无 | ✅ 禁止修改路径 |

### 日志详细程度

| 操作类型 | v1.6 | v1.7 |
|---------|------|------|
| 文件夹选择 | ❌ 无日志 | ✅ 开始/成功/取消 |
| 配置加载 | ❌ 无日志 | ✅ 加载步骤+路径详情 |
| 配置保存 | ⚠️ 仅成功/失败 | ✅ 开始+成功/失败+清除标记 |
| 路径验证 | ❌ 无日志 | ✅ 逐个验证+结果汇总 |
| 上传启动 | ⚠️ 简单提示 | ✅ 完整配置清单 |
| 上传停止 | ⚠️ 简单提示 | ✅ 停止步骤+分隔线 |
| 权限变更 | ❌ 无日志 | ✅ 角色+运行状态 |

### 权限控制细化

| 状态组合 | v1.6 | v1.7 |
|---------|------|------|
| 访客-停止 | ⚠️ 禁用浏览按钮 | ✅ 浏览按钮+输入框只读 |
| 访客-运行 | ⚠️ 禁用浏览按钮 | ✅ 浏览按钮+输入框只读 |
| 用户-停止 | ✅ 可编辑 | ✅ 可编辑 |
| 用户-运行 | ⚠️ 可编辑(危险) | ✅ 禁止编辑(安全) |
| 管理员-停止 | ✅ 可编辑 | ✅ 可编辑 |
| 管理员-运行 | ⚠️ 可编辑(危险) | ✅ 禁止编辑(安全) |

---

## 🔧 技术实现

### 新增状态变量

```python
self.config_modified = False      # 配置是否被修改
self.saved_config = {}            # 保存的配置（用于回退）
self.disk_check_interval = 5      # 磁盘检查间隔（秒）
self.disk_check_counter = 0       # 磁盘检查计数器
```

### 新增方法

```python
def _mark_config_modified(self):
    """标记配置已修改"""

def _validate_paths(self) -> tuple:
    """验证文件夹路径是否存在
    返回: (是否全部有效, 错误消息列表)
    """
```

### 修改的方法

```python
def _choose_source/target/backup(self):
    # 添加默认路径、日志、配置修改标记

def _save_config(self):
    # 添加磁盘检查间隔保存
    # 添加配置修改标记清除
    # 添加详细日志

def _load_config(self):
    # 添加磁盘检查间隔加载
    # 保存已加载配置到 saved_config
    # 添加详细日志

def _on_start(self):
    # 添加路径验证
    # 添加配置修改检查和确认对话框
    # 添加路径锁定
    # 添加详细配置日志

def _on_stop(self):
    # 添加路径解锁（根据权限）
    # 添加详细日志

def _update_ui_permissions(self):
    # 添加运行状态的路径只读控制
    # 添加日志

def _tick(self):
    # 改为可配置间隔的磁盘空间检查
```

---

## 🧪 测试清单

- [x] 浏览文件夹打开当前路径
- [x] 路径不存在时验证失败
- [x] 路径验证失败弹窗显示
- [x] 配置修改后显示警告日志
- [x] 未保存配置时弹出确认对话框
- [x] 选择"是"保存配置并上传
- [x] 选择"否"回退配置并上传
- [x] 选择"取消"取消上传
- [x] 未登录时路径只读
- [x] 运行中路径只读（所有角色）
- [x] 停止后恢复编辑权限
- [x] 磁盘检查间隔可配置（1-60秒）
- [x] 磁盘检查间隔保存到配置文件
- [x] 所有操作都有日志记录

---

## 📝 配置文件变更

### 新增字段

```json
{
  "disk_check_interval": 5
}
```

### 完整示例

```json
{
  "source_folder": "D:/source",
  "target_folder": "Y:/target",
  "backup_folder": "D:/backup",
  "upload_interval": 30,
  "monitor_mode": "periodic",
  "disk_threshold_percent": 10,
  "retry_count": 3,
  "disk_check_interval": 5,
  "filter_jpg": true,
  "filter_png": true,
  "filter_bmp": true,
  "filter_tiff": true,
  "filter_gif": true,
  "filter_raw": true,
  "auto_start_windows": false,
  "auto_run_on_startup": false,
  "users": {
    "admin": "SHA256哈希",
    "user": "SHA256哈希"
  }
}
```

---

## 🔄 升级指南

### 从 v1.6 升级到 v1.7

1. **无需额外操作**，直接运行新版本
2. **配置文件自动兼容**，新增字段自动使用默认值
3. **磁盘检查间隔默认5秒**，可在设置中调整

### 注意事项

1. **路径修改后记得保存**
   - 修改路径后会显示提示：`⚠ 配置已修改，请点击"保存配置"按钮确认`
   - 点击"保存配置"按钮确认修改
   - 或在开始上传时选择保存

2. **路径验证更严格**
   - 路径必须真实存在才能开始上传
   - 路径不存在时会弹窗显示详细错误
   - 建议先创建文件夹再配置路径

3. **运行中无法修改路径**
   - 上传运行时路径自动锁定
   - 停止上传后才能修改
   - 提高了系统的稳定性和安全性

4. **磁盘检查频率**
   - 默认5秒检查一次
   - 快速网络可设置更短（1-3秒）
   - 慢速网络可设置更长（10-30秒）
   - 修改后立即生效

---

## 🐛 已知问题

- 无已知问题

---

## 🚀 下一步计划

- [ ] 添加批量路径验证工具
- [ ] 添加路径历史记录功能
- [ ] 添加路径快速切换功能
- [ ] 优化配置回退逻辑
- [ ] 添加配置导入/导出功能

---

## 📊 统计数据

- **代码行数**: 1690+ 行（新增约 210 行）
- **新增方法**: 2 个（`_mark_config_modified`, `_validate_paths`）
- **修改方法**: 9 个
- **新增配置项**: 1 个（`disk_check_interval`）
- **新增状态变量**: 4 个

---

**版本**: v1.7  
**日期**: 2025-10-22  
**状态**: ✅ 稳定版
