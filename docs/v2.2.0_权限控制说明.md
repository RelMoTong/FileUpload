# v2.2.0 权限控制说明

**更新日期**: 2025-11-17

## 🔐 权限模型

### 角色类型

| 角色 | 标识 | 密码 | 权限级别 |
|------|------|------|---------|
| 访客 | 🔒 未登录 | - | 最低 |
| 用户 | 👤 用户 | 123 | 中等 |
| 管理员 | 👑 管理员 | Tops123 | 最高 |

## 📋 权限对照表

### 未登录状态（访客）

**可以操作**:
- ✅ 开始上传
- ✅ 暂停上传
- ✅ 停止上传
- ✅ 查看日志
- ✅ 查看统计信息
- ✅ 查看托盘菜单
- ✅ 最小化到托盘

**不可操作**:
- ❌ 修改源文件夹路径
- ❌ 修改目标文件夹路径
- ❌ 修改备份文件夹路径
- ❌ 修改上传间隔
- ❌ 修改磁盘阈值
- ❌ 修改重试次数
- ❌ 修改文件类型过滤
- ❌ 修改去重设置
- ❌ 修改网络监控设置
- ❌ 修改自动删除设置
- ❌ 修改FTP协议设置
- ❌ 保存配置
- ❌ 开机自启设置
- ❌ 自动运行设置
- ❌ 修改密码
- ❌ 磁盘清理

### 已登录状态（用户/管理员）

**用户权限**:
- ✅ 所有访客权限
- ✅ 修改所有配置项
- ✅ 保存配置
- ✅ 开机自启设置
- ✅ 自动运行设置

**管理员额外权限**:
- ✅ 所有用户权限
- ✅ 修改密码
- ✅ 磁盘清理
- ✅ 系统高级设置

## 🛡️ 安全机制

### 1. 配置保护
```
未登录时：
- 配置项只读（ReadOnly）
- 保存按钮禁用
- 浏览按钮禁用
```

### 2. 上传启动保护
```
未登录用户开始上传时：
- 检测到配置修改 → 自动恢复已保存配置
- 不弹出保存询问对话框
- 使用已保存的路径启动上传
- 记录日志："未登录用户无权保存配置，自动恢复已保存的配置"
```

### 3. 配置保存保护
```python
def _save_config(self):
    # v2.2.0 权限检查：仅登录用户可保存配置
    if self.current_role == 'guest':
        self._append_log("❌ 未登录用户无权保存配置")
        self._toast('请先登录后再保存配置', 'warning')
        return
```

## 🔄 权限切换流程

### 登录流程
```
1. 点击"🔐 登录"按钮
2. 选择角色（用户/管理员）
3. 输入密码
4. 密码验证（SHA256哈希）
5. 更新UI权限状态
6. 显示角色标签
7. 记录日志
```

### 登出流程
```
1. 点击"🚪 退出"按钮
2. 角色重置为访客
3. 更新UI权限状态
4. 锁定所有配置项
5. 保持上传功能可用
6. 记录日志
```

## 🧪 测试场景

### 场景1: 未登录用户尝试保存配置
```
操作：
1. 未登录状态
2. 尝试点击"保存配置"按钮

预期：
- 按钮禁用状态（无法点击）
- 如果绕过UI调用_save_config()
  → 显示警告："请先登录后再保存配置"
  → 配置不会被保存
```

### 场景2: 未登录用户修改配置后开始上传
```
操作：
1. 未登录状态
2. 修改源文件夹路径（无法修改，只读）
3. 点击"开始上传"

预期：
- 无法修改路径（输入框只读）
- 即使通过代码修改了路径
  → 检测到配置修改
  → 自动恢复已保存的配置
  → 使用已保存路径开始上传
  → 不弹出保存询问对话框
```

### 场景3: 登录后修改配置
```
操作：
1. 登录为用户
2. 修改源文件夹路径
3. 点击"开始上传"

预期：
- 可以修改路径
- 弹出配置保存询问对话框
  → 选择"是"：保存配置并使用新路径
  → 选择"否"：恢复已保存配置
  → 选择"取消"：取消上传
```

### 场景4: 未登录用户上传功能
```
操作：
1. 未登录状态
2. 点击"开始上传"
3. 点击"暂停上传"
4. 点击"恢复上传"
5. 点击"停止上传"

预期：
- 所有操作正常执行
- 使用已保存的配置
- 显示系统通知
- 托盘菜单可用
```

## 📝 UI状态矩阵

### 配置区域

| 控件 | 访客 | 用户 | 管理员 | 运行中 |
|------|------|------|--------|--------|
| 源文件夹输入框 | 只读 | 可编辑 | 可编辑 | 只读 |
| 源文件夹浏览 | 禁用 | 启用 | 启用 | 禁用 |
| 目标文件夹输入框 | 只读 | 可编辑 | 可编辑 | 只读 |
| 目标文件夹浏览 | 禁用 | 启用 | 启用 | 禁用 |
| 备份文件夹输入框 | 只读 | 可编辑 | 可编辑 | 只读 |
| 备份文件夹浏览 | 禁用 | 启用 | 启用 | 禁用 |
| 备份启用复选框 | 禁用 | 启用 | 启用 | 禁用 |

### 设置区域

| 控件 | 访客 | 用户 | 管理员 | 运行中 |
|------|------|------|--------|--------|
| 上传间隔 | 禁用 | 启用 | 启用 | 启用 |
| 磁盘阈值 | 禁用 | 启用 | 启用 | 启用 |
| 重试次数 | 禁用 | 启用 | 启用 | 启用 |
| 文件类型复选框 | 禁用 | 启用 | 启用 | 启用 |
| 去重设置 | 禁用 | 启用 | 启用 | 启用 |
| 网络监控设置 | 禁用 | 启用 | 启用 | 启用 |
| 保存配置按钮 | 禁用 | 启用 | 启用 | 启用 |

### 控制区域

| 控件 | 访客 | 用户 | 管理员 | 运行中 |
|------|------|------|--------|--------|
| 开始上传 | 启用 | 启用 | 启用 | 禁用 |
| 暂停上传 | 禁用 | 禁用 | 禁用 | 启用 |
| 停止上传 | 禁用 | 禁用 | 禁用 | 启用 |
| 登录按钮 | 启用 | 禁用 | 禁用 | 启用 |
| 退出按钮 | 禁用 | 启用 | 启用 | 启用 |

## 🔧 实现细节

### 权限更新触发点
```python
# 1. 程序启动
def __init__(self):
    self._update_ui_permissions()

# 2. 登录成功
def _show_login():
    self._update_ui_permissions()

# 3. 退出登录
def _on_logout():
    self._update_ui_permissions()

# 4. 上传状态变化
def _on_start():
    self._update_ui_permissions()

def _restore_ui_after_stop():
    self._update_ui_permissions()
```

### 权限判断逻辑
```python
is_guest = self.current_role == 'guest'
is_user_or_admin = self.current_role in ['user', 'admin']
is_admin = self.current_role == 'admin'
```

## 🐛 已知限制

1. **路径显示**
   - 未登录用户可以看到已保存的路径
   - 但无法修改（只读保护）

2. **配置可见性**
   - 未登录用户可以看到所有配置项
   - 但无法修改（禁用保护）

3. **日志访问**
   - 所有角色都可以查看日志
   - 未登录用户也可以看到敏感操作日志

## 💡 最佳实践

### 管理员建议
1. 定期修改密码
2. 不要将密码告知普通用户
3. 定期检查配置是否被篡改
4. 监控日志中的权限操作记录

### 用户建议
1. 登录后才修改配置
2. 修改配置后记得保存
3. 不要将密码告知访客

### 访客建议
1. 只使用上传控制功能
2. 不要尝试修改配置
3. 如需修改配置，联系管理员

---

**版本**: v2.2.0  
**更新日期**: 2025-11-17
