# v2.2.0 协议模式保存与权限控制

**更新日期**: 2025-11-17

## 🎯 新增功能

### 1. 协议模式持久化
保存并恢复用户上次使用的上传协议模式。

### 2. 协议选择权限控制
未登录用户和上传运行中禁止修改协议类型。

## 📋 功能详情

### 功能1: 协议模式持久化

**需求**: 保留当前用户使用的模式，当软件打开时默认加载上一次的上传协议

**实现**:

#### 配置文件新增字段
```json
{
  "upload_protocol": "smb",
  "current_protocol": "ftp_client"
}
```

**字段说明**:
- `upload_protocol`: 协议选择下拉框的值 (smb/ftp_server/ftp_client/both)
- `current_protocol`: 实际使用的协议模式 (smb/ftp_server/ftp_client/both)

**工作流程**:
```
1. 用户选择协议 → combo_protocol更改
2. 触发_on_protocol_changed事件
3. 更新current_protocol变量
4. 保存配置时 → 保存current_protocol到配置文件
5. 下次启动 → 从配置文件加载current_protocol
6. 恢复上次的协议模式
```

**代码实现**:

```python
# 保存配置（_save_config方法）
cfg = {
    # ... 其他配置 ...
    'upload_protocol': self.upload_protocol,
    # v2.2.0 新增：保存当前使用的协议模式
    'current_protocol': self.current_protocol,
    # ... 其他配置 ...
}

# 加载配置（_load_config方法）
# v2.2.0 新增：加载上次使用的协议模式
saved_protocol = cfg.get('current_protocol', protocol)
self.current_protocol = saved_protocol
self._append_log(f"✓ 已加载上次协议模式: {saved_protocol}")
# 更新协议状态显示
self._update_protocol_status()
```

### 功能2: 协议选择权限控制

**需求**: 
1. 当用户未登录时不能修改协议类型
2. 开始上传后不能再修改协议类型以及路径等配置

**实现**:

#### 权限控制逻辑
```python
# _update_ui_permissions方法中
# v2.2.0 新增：协议选择框权限控制
# 未登录或运行中时禁用协议选择
if hasattr(self, 'combo_protocol'):
    self.combo_protocol.setEnabled(is_user_or_admin and not self.is_running)
```

**状态矩阵**:

| 用户状态 | 上传状态 | 协议选择 | 路径编辑 | 配置保存 |
|---------|---------|---------|---------|---------|
| 未登录 | 停止 | ❌ 禁用 | ❌ 只读 | ❌ 禁用 |
| 未登录 | 运行 | ❌ 禁用 | ❌ 只读 | ❌ 禁用 |
| 已登录 | 停止 | ✅ 启用 | ✅ 可编辑 | ✅ 启用 |
| 已登录 | 运行 | ❌ 禁用 | ❌ 只读 | ✅ 启用 |

## 🧪 测试场景

### 场景1: 协议模式保存与恢复

**测试步骤**:
```
1. 登录为用户
2. 选择协议模式为"FTP客户端模式"
3. 保存配置
4. 关闭程序
5. 重新打开程序
6. 检查协议选择框是否为"FTP客户端模式"
7. 检查日志是否显示"✓ 已加载上次协议模式: ftp_client"
```

**预期结果**:
```
✅ 协议选择框显示"FTP客户端模式"
✅ current_protocol变量为"ftp_client"
✅ 日志显示加载成功
✅ 协议状态显示正确
```

### 场景2: 未登录用户禁止修改协议

**测试步骤**:
```
1. 未登录状态（访客模式）
2. 尝试点击协议选择下拉框
```

**预期结果**:
```
✅ 协议选择框处于禁用状态（灰色）
✅ 无法点击下拉框
✅ 无法更改协议模式
✅ 显示当前保存的协议（只读）
```

### 场景3: 上传运行中禁止修改协议

**测试步骤**:
```
1. 登录为用户
2. 协议选择框可用（启用状态）
3. 点击"开始上传"按钮
4. 上传任务开始运行
5. 尝试修改协议选择
```

**预期结果**:
```
✅ 上传开始后协议选择框立即禁用
✅ 无法在运行中切换协议
✅ 源/目标/备份路径也变为只读
✅ 其他配置项可能可编辑但保存后不影响运行中的任务
```

### 场景4: 停止上传后恢复协议选择

**测试步骤**:
```
1. 登录为用户
2. 开始上传（协议选择禁用）
3. 点击"停止上传"按钮
4. 上传任务停止
5. 检查协议选择框状态
```

**预期结果**:
```
✅ 停止后协议选择框立即启用
✅ 可以重新选择协议模式
✅ 路径编辑框恢复为可编辑状态
✅ 可以修改配置并保存
```

### 场景5: 登录状态切换

**测试步骤**:
```
1. 未登录状态（协议选择禁用）
2. 登录为用户
3. 检查协议选择框状态
4. 点击"退出登录"
5. 再次检查协议选择框状态
```

**预期结果**:
```
✅ 未登录时协议选择禁用
✅ 登录后协议选择启用
✅ 退出登录后协议选择再次禁用
✅ UI权限状态正确更新
```

## 📝 配置文件示例

### 示例1: SMB协议
```json
{
  "source_folder": "E:\\Images",
  "target_folder": "\\\\192.168.1.100\\upload",
  "backup_folder": "E:\\Backup",
  "upload_protocol": "smb",
  "current_protocol": "smb",
  "ftp_server": { ... },
  "ftp_client": { ... }
}
```

### 示例2: FTP服务器模式
```json
{
  "source_folder": "E:\\Images",
  "target_folder": "E:\\FTPShared",
  "backup_folder": "E:\\Backup",
  "upload_protocol": "ftp_server",
  "current_protocol": "ftp_server",
  "ftp_server": {
    "host": "0.0.0.0",
    "port": 2121,
    "username": "upload_user",
    "password": "upload_pass",
    "shared_folder": "E:\\FTPShared"
  }
}
```

### 示例3: FTP客户端模式
```json
{
  "source_folder": "E:\\Images",
  "target_folder": "\\\\192.168.1.100\\upload",
  "backup_folder": "E:\\Backup",
  "upload_protocol": "ftp_client",
  "current_protocol": "ftp_client",
  "ftp_client": {
    "host": "192.168.1.200",
    "port": 21,
    "username": "ftpuser",
    "password": "ftppass",
    "remote_path": "/upload"
  }
}
```

### 示例4: 混合模式
```json
{
  "source_folder": "E:\\Images",
  "target_folder": "E:\\FTPShared",
  "backup_folder": "E:\\Backup",
  "upload_protocol": "both",
  "current_protocol": "both",
  "ftp_server": { ... },
  "ftp_client": { ... }
}
```

## 🔄 升级说明

### 从v2.1.x升级到v2.2.0

**配置文件兼容性**:
- ✅ 自动兼容旧配置文件
- ✅ 缺少`current_protocol`时使用`upload_protocol`作为默认值
- ✅ 无需手动修改配置文件

**升级流程**:
```
1. 备份当前配置文件 config.json（可选）
2. 关闭v2.1.x版本程序
3. 运行v2.2.0版本程序
4. 程序自动加载旧配置
5. 首次保存配置时自动添加current_protocol字段
```

## 🐛 已知问题

### 问题1: 配置文件格式
**现象**: 旧版本配置文件没有`current_protocol`字段

**影响**: 首次启动时使用`upload_protocol`作为默认协议

**解决**: 
```python
saved_protocol = cfg.get('current_protocol', protocol)
```

### 问题2: 权限更新时机
**现象**: 需要在多个地方调用`_update_ui_permissions()`

**当前触发点**:
- 程序启动
- 登录/退出
- 开始上传
- 停止上传

**优化**: 已集中管理，无需额外处理

## 💡 使用建议

### 管理员建议
1. 首次部署时设置好默认协议模式
2. 告知用户如何选择合适的协议
3. 定期检查配置文件是否正确

### 用户建议
1. 登录后再选择协议模式
2. 选择协议后记得保存配置
3. 上传运行中不要尝试修改配置
4. 如需切换协议，先停止上传

### 开发建议
1. 新增协议模式时同步更新protocol_map
2. 确保所有UI权限更新调用一致
3. 配置文件字段保持向后兼容

## 📊 权限控制完整矩阵

### 配置区域

| 控件 | 访客 | 用户(停止) | 用户(运行) | 管理员(停止) | 管理员(运行) |
|------|------|-----------|-----------|-------------|-------------|
| 协议选择 | ❌ | ✅ | ❌ | ✅ | ❌ |
| 源文件夹 | ❌ | ✅ | ❌ | ✅ | ❌ |
| 目标文件夹 | ❌ | ✅ | ❌ | ✅ | ❌ |
| 备份文件夹 | ❌ | ✅ | ❌ | ✅ | ❌ |
| FTP配置 | ❌ | ✅ | ✅ | ✅ | ✅ |
| 保存配置 | ❌ | ✅ | ✅ | ✅ | ✅ |

### 控制区域

| 控件 | 访客 | 用户(停止) | 用户(运行) | 管理员(停止) | 管理员(运行) |
|------|------|-----------|-----------|-------------|-------------|
| 开始上传 | ✅ | ✅ | ❌ | ✅ | ❌ |
| 暂停上传 | ❌ | ❌ | ✅ | ❌ | ✅ |
| 停止上传 | ❌ | ❌ | ✅ | ❌ | ✅ |

---

**版本**: v2.2.0  
**更新日期**: 2025-11-17  
**功能状态**: ✅ 已实现并测试
