# 更新说明 - 权限优化和 Logo 添加

**更新日期**: 2025年10月22日

---

## 🎯 本次更新内容

### 1. 📂 未登录状态权限细化

**需求：**
- 未登录时禁用目标文件夹和备份文件夹的浏览按钮
- 未登录时禁止修改磁盘检查间隔
- 源文件夹所有人可用（包括未登录状态）

**实现：**

#### 文件夹浏览按钮权限
| 文件夹 | 未登录 | 已登录（运行中） | 已登录（停止） |
|--------|--------|-----------------|---------------|
| **源文件夹** | ✅ 可用 | ❌ 禁用 | ✅ 可用 |
| **目标文件夹** | ❌ 禁用 | ❌ 禁用 | ✅ 可用 |
| **备份文件夹** | ❌ 禁用 | ❌ 禁用 | ✅ 可用 |

#### 文件夹路径输入框权限
| 文件夹 | 未登录 | 已登录（运行中） | 已登录（停止） |
|--------|--------|-----------------|---------------|
| **源文件夹** | ✅ 可编辑 | ❌ 只读 | ✅ 可编辑 |
| **目标文件夹** | ❌ 只读 | ❌ 只读 | ✅ 可编辑 |
| **备份文件夹** | ❌ 只读 | ❌ 只读 | ✅ 可编辑 |

#### 设置项权限
| 设置项 | 未登录 | 已登录 |
|--------|--------|--------|
| 间隔时间(秒) | ❌ 禁用 | ✅ 可用 |
| 磁盘阈值(%) | ❌ 禁用 | ✅ 可用 |
| 失败重试次数 | ❌ 禁用 | ✅ 可用 |
| **磁盘检查间隔(秒)** | ❌ 禁用 | ✅ 可用 |
| 文件类型限制 | ❌ 禁用 | ✅ 可用 |
| 开机自启动 | ❌ 禁用 | ✅ 可用 |
| 启动时自动运行 | ❌ 禁用 | ✅ 可用 |

**代码实现：**
```python
def _update_ui_permissions(self):
    is_guest = self.current_role == 'guest'
    is_user_or_admin = self.current_role in ['user', 'admin']
    
    # 源文件夹浏览按钮：所有人可用（除非运行中）
    self.btn_choose_src.setEnabled(not self.is_running)
    
    # 目标和备份文件夹浏览按钮：登录用户且未运行中可用
    self.btn_choose_tgt.setEnabled(is_user_or_admin and not self.is_running)
    self.btn_choose_bak.setEnabled(is_user_or_admin and not self.is_running)
    
    # 输入框权限
    self.src_edit.setReadOnly(self.is_running)  # 源文件夹：运行中只读
    self.tgt_edit.setReadOnly(is_guest or self.is_running)  # 目标：未登录或运行中只读
    self.bak_edit.setReadOnly(is_guest or self.is_running)  # 备份：未登录或运行中只读
    
    # 磁盘检查间隔：未登录时禁用
    self.spin_disk_check.setEnabled(is_user_or_admin)
```

**优势：**
- ✅ 降低误操作风险（未登录用户只能选择源文件夹）
- ✅ 保护敏感配置（目标和备份路径需要登录才能修改）
- ✅ 灵活的权限控制（不同场景不同权限）

---

### 2. 🎮 未登录状态可正常使用上传功能

**需求：**
- 未登录时可以正常使用开始上传、暂停上传以及停止上传功能
- 不需要登录就能执行上传任务

**实现：**

#### 上传控制按钮权限（新版）
| 按钮 | 未登录（停止） | 未登录（运行） | 已登录（停止） | 已登录（运行） |
|------|---------------|---------------|---------------|---------------|
| **开始上传** | ✅ 可用 | ❌ 禁用 | ✅ 可用 | ❌ 禁用 |
| **暂停上传** | ❌ 禁用 | ✅ 可用 | ❌ 禁用 | ✅ 可用 |
| **停止上传** | ❌ 禁用 | ✅ 可用 | ❌ 禁用 | ✅ 可用 |

#### 对比旧版权限
**旧版（v1.7）**：
- 开始按钮：仅用户/管理员且未运行时启用
- 暂停按钮：仅用户/管理员且正在运行时启用
- 停止按钮：仅用户/管理员且正在运行时启用

**新版（v1.8）**：
- 开始按钮：所有人，未运行时启用
- 暂停按钮：所有人，正在运行时启用
- 停止按钮：所有人，正在运行时启用

**代码实现：**
```python
# 上传控制按钮：所有人都可以使用（包括未登录状态）
# 开始按钮：未运行时启用
self.btn_start.setEnabled(not self.is_running)
# 暂停按钮：正在运行时启用
self.btn_pause.setEnabled(self.is_running)
# 停止按钮：正在运行时启用
self.btn_stop.setEnabled(self.is_running)
```

**使用场景：**
1. **快速测试**：用户无需登录即可快速测试上传功能
2. **临时任务**：访客用户可以执行简单的上传任务
3. **降低门槛**：不需要记住密码即可使用核心功能
4. **安全平衡**：配置受保护，但功能开放

**优势：**
- ✅ 提升用户体验（无需登录即可使用核心功能）
- ✅ 降低使用门槛（快速上手）
- ✅ 保持安全性（配置修改仍需登录）

---

### 3. 🎨 添加 Logo 到软件左上角

**需求：**
- 将刚才上传的图像添加到软件的左上角当 Logo

**实现：**

#### Logo 显示位置
```
┌────────────────────────────────────────────┐
│ [Logo] 图片异步上传工具  v2 (PyQt)  🔒未登录 │
├────────────────────────────────────────────┤
│                                            │
│  [左侧：文件夹设置 + 上传设置]  [右侧：控制] │
│                                            │
└────────────────────────────────────────────┘
```

#### 技术实现
```python
def _build_ui(self):
    # header
    header = QtWidgets.QHBoxLayout()
    
    # Logo
    logo_path = self.app_dir / "assets" / "logo.png"
    if logo_path.exists():
        logo_label = QtWidgets.QLabel()
        pixmap = QtGui.QPixmap(str(logo_path))
        # 设置 Logo 大小（高度40px，宽度按比例）
        scaled_pixmap = pixmap.scaledToHeight(40)
        logo_label.setPixmap(scaled_pixmap)
        logo_label.setStyleSheet("background: transparent;")
        header.addWidget(logo_label)
        header.addSpacing(12)  # Logo 和标题之间的间距
    
    title = QtWidgets.QLabel("图片异步上传工具")
    # ...
```

#### Logo 文件位置
- 路径：`e:\Python\文件上传\assets\logo.png`
- 大小：高度 40px，宽度自适应
- 格式：PNG（支持透明背景）

**特性：**
- ✅ 自动缩放（高度固定40px）
- ✅ 保持宽高比
- ✅ 透明背景支持
- ✅ 文件不存在时自动跳过（不报错）

**优势：**
- ✅ 提升品牌识别度
- ✅ 增强视觉效果
- ✅ 更专业的界面外观

---

## 📊 权限系统完整对比表

### 完整权限矩阵

| 控件/功能 | 未登录（停止） | 未登录（运行） | 已登录（停止） | 已登录（运行） |
|-----------|---------------|---------------|---------------|---------------|
| **文件夹设置** | | | | |
| 源文件夹-浏览 | ✅ | ❌ | ✅ | ❌ |
| 源文件夹-编辑 | ✅ | ❌ | ✅ | ❌ |
| 目标文件夹-浏览 | ❌ | ❌ | ✅ | ❌ |
| 目标文件夹-编辑 | ❌ | ❌ | ✅ | ❌ |
| 备份文件夹-浏览 | ❌ | ❌ | ✅ | ❌ |
| 备份文件夹-编辑 | ❌ | ❌ | ✅ | ❌ |
| **上传设置** | | | | |
| 间隔时间 | ❌ | ❌ | ✅ | ✅ |
| 磁盘阈值 | ❌ | ❌ | ✅ | ✅ |
| 失败重试次数 | ❌ | ❌ | ✅ | ✅ |
| 磁盘检查间隔 ⭐ | ❌ | ❌ | ✅ | ✅ |
| 文件类型限制 | ❌ | ❌ | ✅ | ✅ |
| 开机自启动 | ❌ | ❌ | ✅ | ✅ |
| 启动时自动运行 | ❌ | ❌ | ✅ | ✅ |
| 保存配置 | ❌ | ❌ | ✅ | ✅ |
| **操作控制** ⭐ | | | | |
| 开始上传 ⭐ | ✅ | ❌ | ✅ | ❌ |
| 暂停上传 ⭐ | ❌ | ✅ | ❌ | ✅ |
| 停止上传 ⭐ | ❌ | ✅ | ❌ | ✅ |

**图例：**
- ✅ = 可用/可编辑
- ❌ = 禁用/只读
- ⭐ = 本次更新修改的项

---

## 🔧 技术变更

### 修改的方法

#### 1. `_update_ui_permissions()`
- 添加浏览按钮引用检查
- 修改目标和备份文件夹浏览按钮权限逻辑
- 添加磁盘检查间隔的权限控制
- 移除上传控制按钮的角色限制

#### 2. `_path_row()`
- 返回值从 `edit` 改为 `(edit, btn)`
- 同时返回输入框和浏览按钮的引用

#### 3. `_folder_card()`
- 接收按钮引用并保存到实例变量：
  - `self.btn_choose_src`
  - `self.btn_choose_tgt`
  - `self.btn_choose_bak`

#### 4. `_build_ui()`
- 在标题栏添加 Logo 显示
- Logo 路径：`self.app_dir / "assets" / "logo.png"`
- Logo 高度：40px（宽度自适应）

### 新增实例变量

```python
self.btn_choose_src  # 源文件夹浏览按钮
self.btn_choose_tgt  # 目标文件夹浏览按钮
self.btn_choose_bak  # 备份文件夹浏览按钮
```

---

## 🧪 测试清单

- [x] 未登录时源文件夹浏览按钮可用
- [x] 未登录时目标文件夹浏览按钮禁用
- [x] 未登录时备份文件夹浏览按钮禁用
- [x] 未登录时磁盘检查间隔禁用
- [x] 未登录时可以点击"开始上传"按钮
- [x] 未登录时上传运行中可以点击"暂停上传"
- [x] 未登录时上传运行中可以点击"停止上传"
- [x] 登录后所有权限恢复正常
- [x] Logo 正确显示在左上角
- [x] Logo 不存在时程序正常运行（不报错）
- [x] 运行中所有路径浏览按钮禁用
- [x] 停止后权限恢复到对应角色状态

---

## 📝 使用指南

### 未登录状态

1. **可以做什么：**
   - ✅ 选择源文件夹（浏览/手动输入）
   - ✅ 查看目标和备份文件夹路径（只读）
   - ✅ 查看所有配置（只读）
   - ✅ 开始上传任务
   - ✅ 暂停/恢复上传
   - ✅ 停止上传
   - ✅ 查看日志和状态

2. **不可以做什么：**
   - ❌ 修改目标文件夹
   - ❌ 修改备份文件夹
   - ❌ 修改任何上传设置
   - ❌ 修改磁盘检查间隔
   - ❌ 修改文件类型限制
   - ❌ 保存配置
   - ❌ 设置开机自启动

### 登录后（用户/管理员）

1. **完全控制：**
   - ✅ 修改所有文件夹路径
   - ✅ 修改所有上传设置
   - ✅ 修改磁盘检查间隔
   - ✅ 修改文件类型限制
   - ✅ 保存配置
   - ✅ 设置开机自启动
   - ✅ 执行所有上传操作

### 典型使用场景

#### 场景1：快速测试上传（无需登录）
```
1. 启动程序（未登录状态）
2. 点击"浏览"选择源文件夹
3. 查看目标和备份路径（只读，使用默认配置）
4. 点击"开始上传"
5. 观察上传进度和日志
```

#### 场景2：修改配置并上传（需要登录）
```
1. 启动程序
2. 点击右上角"权限登录"
3. 选择角色并输入密码
4. 修改目标文件夹、备份文件夹
5. 调整上传间隔、磁盘检查间隔等
6. 点击"保存配置"
7. 点击"开始上传"
```

---

## 🐛 已知问题

- 无已知问题

---

## 🚀 下一步计划

- [ ] 添加 Logo 自定义功能（允许用户上传自己的 Logo）
- [ ] 添加更多权限角色（如"只读用户"）
- [ ] 添加权限日志记录功能
- [ ] 优化未登录状态的提示信息

---

## 📊 统计数据

- **修改方法**: 4 个
- **新增实例变量**: 3 个（按钮引用）
- **新增文件**: 1 个（logo.png）
- **权限控制优化**: 7 项（浏览按钮 + 磁盘检查间隔 + 上传控制按钮）

---

**版本**: v1.8  
**日期**: 2025-10-22  
**状态**: ✅ 稳定版
