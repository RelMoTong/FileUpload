
# 版本更新日志

> 注意：从 v1.5 起，本仓库仅维护 PySide6/PyQt (Qt) 版本的 GUI。旧的 Tkinter/其他启动脚本已归档，打包和启动说明已更新为仅使用 `启动程序_pyqt.bat` 和 `打包程序.bat`。

---

## v1.9 (2025-11-07) - 智能管理与性能革命

### 🎉 重大更新

#### 1. 智能去重功能 ✨
- **基于文件哈希的去重检测**：支持 MD5 和 SHA256 两种算法
- **四种去重策略**：
  - **跳过**：发现重复直接跳过，不上传
  - **重命名**：自动添加序号后缀，保留所有文件
  - **覆盖**：删除旧文件，上传新文件
  - **询问**：弹窗让用户选择（支持"应用于后续"批量处理）
- **智能对话框**：
  - 明显的选中高亮（浅蓝背景+蓝色边框）
  - 更大的单选圆点（18px）
  - 小图标提示每个选项的含义
  - 支持键盘导航（Tab/方向键/Enter）
- **节省资源**：避免重复上传相同内容的文件，节省空间和时间

#### 2. 网络监控系统 🌐
- **独立监控线程**：实时检测网络状态，不影响上传任务
- **三种网络状态**：
  - 🟢 **正常**：网络连接稳定
  - 🟡 **不稳定**：目标不可达，但备份可达
  - 🔴 **已断开**：网络完全断开
- **自动化处理**：
  - ⏸️ 断网时自动暂停上传，避免文件损坏
  - ▶️ 网络恢复后自动继续上传
- **智能检测**：
  - 映射盘/UNC 路径优先使用 ping 主机（300ms 超时）
  - 断网/不稳定时每秒检测一次
  - 正常时使用配置的检测间隔（默认10秒）
- **实时反馈**：状态实时显示在运行状态卡片中

#### 3. 自动删除功能 🗑️
- **智能磁盘空间管理**：自动清理过期文件，释放存储空间
- **灵活配置**：
  - **监控文件夹**：指定要清理的文件夹（建议是备份文件夹）
  - **空间阈值**：50-95%（默认80%，达到阈值时触发删除）
  - **保留天数**：1-365天（默认10天，只保留最近N天的文件）
  - **检查间隔**：60-3600秒（默认300秒=5分钟）
- **安全机制**：
  - 只删除图片文件（根据扩展名过滤）
  - 按文件修改时间判断
  - 自动删除空文件夹
  - 详细的删除日志
  - 删除前后的磁盘使用率对比
- **工作示例**（保留10天）：
  ```
  今天：2025-11-07
  截止日期：2025-10-28
  
  保留：2025-10-28 至 2025-11-07 的文件
  删除：2025-10-28 之前的所有文件
  ```
- ⚠️ **警告**：被删除的文件无法恢复，请谨慎设置保留天数！

### 🚀 性能优化

#### 线程架构革命
完全非阻塞的 7 线程/线程池设计：

1. **主 UI 线程**（Qt GUI 线程）
   - 职责：接收信号，更新界面
   - 特点：永不阻塞，即使网络卡顿也能正常响应

2. **Worker Qt 线程**
   - 职责：作为 Worker 对象的宿主线程
   - 特点：轻量级，主要工作由内部原生线程完成

3. **上传主线程**（原生 Python 线程，daemon）
   - 职责：文件扫描、上传逻辑、重试队列处理
   - 特点：所有文件操作通过线程池封装，带超时保护

4. **网络监控线程**（原生 Python 线程，daemon）
   - 职责：独立监控 target/backup 可达性
   - 特点：1秒节奏自适应，发射网络状态信号

5. **归档线程**（原生 Python 线程，daemon）
   - 职责：独立处理文件归档，消费归档队列
   - 特点：使用 `shutil.move`，不阻塞上传

6. **自动删除线程**（原生 Python 线程，daemon）
   - 职责：后台监控磁盘空间，执行自动清理
   - 特点：定期检查，达到阈值时自动删除过期文件

7. **文件操作线程池**（ThreadPoolExecutor，3 workers，前缀 FileOp）
   - 职责：通用文件系统操作（exists, makedirs, copy2, 扫描等）
   - 特点：所有操作带超时，超时返回默认值

8. **网络检测线程池**（ThreadPoolExecutor，1 worker，前缀 NetChk）
   - 职责：网络路径"存在性"检查
   - 特点：短超时（0.3-1.5秒），不与文件操作抢资源

9. **日志线程池**（ThreadPoolExecutor，1 worker，前缀 LogWriter）
   - 职责：UI 线程之外异步写入日志文件、更新磁盘空间
   - 特点：避免 UI 卡顿

#### 超时保护机制 ⏱️
所有可能阻塞的操作都有明确的超时上限：

| 操作 | 超时时间 | 超时后行为 |
|------|---------|-----------|
| `os.path.exists` | 2秒 | 返回 False |
| `os.makedirs` | 3秒 | 抛出异常 |
| `shutil.copy2`（小文件） | 10秒 | 抛出异常 |
| 目录扫描 | 5秒 | 返回空列表 |
| 磁盘空间查询 | 2秒 | 返回 0 |
| 网络 ping | 0.3秒 | 返回不可达 |
| 网络 exists | 0.7-1.5秒 | 返回 False |

#### 信号机制优化 🔄
- 所有 Worker → UI 信号使用 `QueuedConnection`
- 信号进入事件队列，异步处理
- 即使 Worker 阻塞，UI 也能正常响应
- 定期发送统计心跳，确保 UI 持续刷新

### 🎨 界面改进

#### 运行状态增强 📊
- **网络状态芯片**：实时显示网络状态（🟢/🟡/🔴）
- **磁盘空间显示**：
  - 目标磁盘：可用空间百分比和GB
  - 备份磁盘：可用空间百分比和GB
  - 网络路径不可达时显示"--"
- **当前文件信息**：显示正在处理的文件名
- **文件进度条**：显示单个文件的上传进度（带百分比）
  - 0%：显示"准备上传…"
  - 1-99%：显示"上传中… X%"
  - 100%：显示"✓ 完成"
- **日志时间戳**：所有日志添加时间戳 `[HH:MM:SS]`

#### 路径验证 🔍
开始上传前自动验证路径：
- ✅ 检查路径是否存在
- ✅ 检查三个路径是否相同（防止循环/覆盖）
- ❌ 验证失败时弹窗提示详细错误
- ⚠️ 配置修改未保存时提示用户选择

### 🐛 Bug 修复

#### 断网处理（重大修复）✅
- ✅ **修复断网时软件卡死的问题**
  - 原因：`os.path.exists` 在网络路径上长时间挂起
  - 方案：改用 ping 主机 + 独立线程池 + 短超时
- ✅ **修复断网时日志不更新的问题**
  - 原因：Worker 线程被阻塞，无法发送日志信号
  - 方案：独立网络监控线程，1秒节奏发送心跳
- ✅ **修复断网时网络状态卡片不变化的问题**
  - 原因：状态信号未及时发出
  - 方案：监控线程独立探测，状态变化立即发信号
- ✅ **修复断网时运行时间/磁盘芯片卡住的问题**
  - 原因：磁盘查询阻塞主线程
  - 方案：网络路径跳过磁盘查询，显示"--"
- ✅ **修复停止上传后"开始"按钮不恢复的问题**
  - 原因：Stop 等待线程退出，主线程被阻塞
  - 方案：立即恢复 UI，后台异步清理线程

#### 重试机制修复 ✅
- ✅ **修复失败重试次数显示错误**
  - 原因：重试时重复调用失败处理函数
  - 方案：重试队列独立处理，不重复计数
- ✅ **实现正确的重试队列**
  - 按配置的次数重试（默认3次）
  - 重试间隔递增：10秒 → 30秒 → 60秒
- ✅ **重试时输出完整的日志**
  - 显示"🔄 重试文件 (第X次)"
  - 显示重试成功/失败的统计

#### UI 响应修复 ✅
- ✅ **修复窗口最大化/缩小时卡死**
  - 原因：信号槽同步执行，阻塞主线程
  - 方案：所有信号使用 QueuedConnection
- ✅ **添加滚动条**
  - 适应不同屏幕尺寸
  - 窗口最小尺寸：900x600
- ✅ **修复大文件上传时 UI 冻结**
  - 原因：文件复制阻塞主线程
  - 方案：使用线程池 + 超时 + 进度回调

### 📚 文档更新

#### 新增文档 📝
- **线程与调用时序图**（Mermaid 图）
  - 展示所有线程的启动顺序
  - 标注信号流和阻塞点
  - 说明超时机制
  - 位置：`docs/开发文档/线程与调用时序图.md`

#### 更新文档 📖
- 更新 `README.md`（添加 v1.9 新功能说明）
- 更新 `版本说明.md`（本文档）
- 更新开发文档（线程架构、超时机制）

### 🔧 技术改进

#### 配置持久化
新增配置字段：
```json
{
  "enable_deduplication": false,
  "hash_algorithm": "md5",
  "duplicate_strategy": "ask",
  "network_check_interval": 10,
  "network_auto_pause": true,
  "network_auto_resume": true,
  "enable_auto_delete": false,
  "auto_delete_folder": "",
  "auto_delete_threshold": 80,
  "auto_delete_keep_days": 10,
  "auto_delete_check_interval": 300
}
```

#### 日志系统增强
- 📅 每天一个日志文件（`upload_YYYY-MM-DD.txt`）
- ⏰ 所有日志带时间戳 `[HH:MM:SS]`
- 🔄 自动切换到新日期的日志文件
- 💾 异步写入，不阻塞主线程
- 📊 记录所有关键操作（上传、重试、删除、网络状态变化）

#### 资源管理
- 📦 支持打包后的资源访问（Logo、配置等）
- 📁 自动创建必要的目录（logs、config）
- 🔧 打包后配置文件保存在 exe 所在目录
- 🗑️ 自动清理临时文件和空文件夹

### 📋 使用建议

#### 智能去重配置
| 场景 | 推荐策略 | 说明 |
|------|---------|------|
| 首次使用 | **询问** | 了解重复情况，手动决策 |
| 完全去重 | **跳过** | 不上传重复文件，节省空间 |
| 保留所有 | **重命名** | 自动添加序号，保留所有版本 |
| 更新文件 | **覆盖** | 用新文件替换旧文件 |

#### 网络监控配置
- **检测间隔**：建议 10秒（断网时自动加快到1秒）
- **断网自动暂停**：建议开启
- **恢复自动继续**：建议开启

#### 自动删除配置
- **监控文件夹**：⚠️ 建议监控备份文件夹，**不要监控源文件夹或目标文件夹**
- **空间阈值**：建议 80%（根据磁盘大小调整）
- **保留天数**：
  - 重要数据：建议 30-90 天
  - 临时数据：建议 7-14 天
  - 测试数据：建议 3-7 天
- **检查间隔**：建议 300秒（5分钟）

### 🧪 兼容性
- ✅ 与 v1.0-v1.8 完全向后兼容
- ✅ 旧配置文件自动升级，新字段使用默认值
- ✅ 用户密码继续使用 SHA256 加密存储

### 📊 性能指标（对比 v1.8）

| 指标 | v1.8 | v1.9 | 提升 |
|------|------|------|------|
| 断网响应时间 | 5-30秒 | 1秒 | ⬆️ 5-30x |
| UI 卡顿频率 | 偶尔 | 从不 | ⬆️ 100% |
| 窗口最大化/缩小 | 可能卡死 | 秒响应 | ⬆️ ∞ |
| 网络状态更新 | 30秒 | 1秒 | ⬆️ 30x |
| 磁盘空间查询 | 可能卡顿 | 异步/跳过 | ⬆️ 显著 |
| 日志写入延迟 | 可能阻塞 | 异步 | ⬆️ 显著 |
| 重复文件处理 | 无 | 智能去重 | 🆕 |
| 磁盘空间管理 | 手动 | 自动删除 | 🆕 |

---

## v1.8 (2025-10-15) - 界面重构

### 🎨 界面改进
- **三段式布局**：左侧设置 + 右侧状态/日志
- **实时进度显示**：总进度 + 文件进度
- **磁盘空间监控**：实时显示目标和备份磁盘可用空间
- **失败重试队列**：自动重试失败文件
- **独立归档线程**：归档不影响上传

### 🐛 Bug 修复
- 修复文件路径中文编码问题
- 修复大文件上传时的内存溢出

---

## v1.7 (2025-09-20) - 权限系统

### 🔐 权限管理
- **三级权限系统**：游客/用户/管理员
- **密码保护**：SHA256 加密存储
- **配置保存和加载**

---

## v1.6 (2025-08-10) - 自动化增强

### 🚀 自动化功能
- 开机自启动支持
- 文件类型过滤
- 上传统计

---

## v1.5 (2025-10-21) - 权限管理与自动化增强

### 🔐 新增功能
- **三级权限系统**：未登录 → 普通用户 → 管理员
  - **未登录**（默认启动状态）：所有功能禁用，需通过"切换权限"登录
  - **普通用户**：可修改路径和文件类型，可操作上传，无法修改高级设置
  - **管理员**：拥有所有权限，包括修改所有设置和密码
  - 默认密码：管理员 `Tops123`，普通用户 `123`
- **切换权限功能**：新增"切换权限"按钮，用户可随时输入密码在三种状态间切换
- **异步日志系统**：日志写入由独立线程处理，避免文件I/O阻塞主界面导致卡死
- **开机自启动**：管理员可设置软件开机自动启动（写入Windows注册表）
- **软件自动运行**：可设置软件启动时自动开始上传，无需手动点击"开始上传"
- **密码管理**：管理员可修改管理员和普通用户的密码，密码使用SHA-256加密存储

### ✨ 优化改进
- **安全启动模式**：软件启动时处于"未登录"状态，防止未授权访问
- **动态权限切换**：通过"切换权限"按钮可随时切换身份，无需重启软件
- **日志异步写入**：日志写入队列化，由独立线程处理，即使磁盘慢也不影响界面响应
- **优化切换权限UI**：调整对话框尺寸为380x260，确保按钮完全显示

### 🔧 权限控制详情

**未登录状态（默认）：**
- ❌ 所有路径输入框禁用
- ❌ 所有设置控件禁用
- ❌ 所有文件类型过滤禁用
- ❌ 开始/暂停/停止上传按钮禁用
- ❌ 保存配置、测试连接、浏览、打开按钮禁用
- ✅ 仅"切换权限"按钮可用

**普通用户权限：**
- ✅ 可修改源/目标/备份文件夹路径
- ✅ 可选择文件类型过滤（JPG/PNG/BMP/TIFF/GIF/RAW）
- ✅ 可开始/暂停/停止上传
- ✅ 可测试网络连接
- ✅ 可查看运行状态和日志
- ✅ 可清空日志
- ❌ 无法修改监控模式、间隔时间、磁盘阈值、重试次数
- ❌ 无法设置开机自启动和自动运行
- ❌ 无法保存配置
- ❌ 看不到"修改密码"按钮

**管理员权限（完全控制）：**
- ✅ 拥有普通用户的所有权限
- ✅ 可修改所有高级设置（监控模式、间隔、阈值、重试等）
- ✅ 可设置开机自启动和自动运行
- ✅ 可保存配置
- ✅ 可修改管理员和普通用户的密码
- ✅ 显示"修改密码"按钮

### ⚙️ 配置文件扩展
新增配置字段：
```json
{
  "auto_start_windows": false,
  "auto_run_on_startup": false,
  "users": {
    "admin": "SHA256加密密码",
    "user": "SHA256加密密码"
  }
}
```

### 🧪 兼容性
- 与 v1.0-v1.4 完全向后兼容
- 首次运行时自动创建默认用户密码

---

## v1.4 (2025-10-21) - UI视觉优化

### 🎨 界面改进
- **浅蓝色主题**：采用清新的浅蓝色背景色调（#E3F2FD），提升视觉舒适度，减少长时间使用的眼部疲劳
- **完全自适应布局**：优化所有容器的网格权重配置，窗口缩小时各区域自动调整尺寸，无内容截断
- **最小窗口尺寸**：设置最小尺寸为 800x550，防止窗口过小导致控件重叠
- **配色优化**：标题使用深蓝色（#0D47A1），文本使用深灰色（#37474F），确保良好对比度和可读性
- **日志区域优化**：日志文本框采用浅灰背景配合 Consolas 字体，提升代码日志可读性

### 🔧 技术改进
- 所有 Frame/LabelFrame 正确配置 rowconfigure/columnconfigure 权重
- 所有控件使用合适的 sticky 参数（nsew/we/ew）确保布局响应式
- 左侧面板底部自动扩展填充空白区域
- 右侧状态和日志区域垂直自适应分配空间

### 🧪 兼容性
- 与 v1.0/v1.1/v1.2/v1.3 完全向后兼容，无功能变更

---

## v1.3 (2025-10-21) - 智能重试与用户体验增强

### ✨ 新增功能
- **实时磁盘空间显示**：状态栏实时显示目标盘和备份盘的可用空间（GB和百分比），低于阈值时变红色警告，每10秒自动更新
- **归档队列深度显示**：显示归档队列中待处理文件数量，帮助监控归档线程工作状态
- **失败文件智能重试**：自动重试失败文件，可配置重试次数（0-10次），重试间隔递增（10秒→30秒→60秒），超过重试次数后记录到 `failed_files.log`，UI显示待重试数量
- **暂停/恢复功能**：新增"暂停上传"按钮，暂停后保留进度和队列，恢复时从断点继续，与"停止"区分（停止会清空状态）
- **网络连接自动检测**：每30秒自动检测目标文件夹连接，断线后自动重试（最多3次），3次失败后弹窗提醒并暂停，停止自动重试，保留手动测试连接功能
- **文件类型过滤**：用户可通过复选框自由选择要上传的文件类型（JPG/PNG/BMP/TIFF/GIF/RAW），配置可保存

### ⚙️ 配置示例变更
```json
{
  "source_folder": "...",
  "target_folder": "...",
  "backup_folder": "...",
  "upload_interval": 30,
  "monitor_mode": "periodic",
  "disk_threshold_percent": 10,
  "retry_count": 3,
  "filter_jpg": true,
  "filter_png": true,
  "filter_bmp": true,
  "filter_tiff": true,
  "filter_gif": true,
  "filter_raw": true
}
```

### 🎨 UI改进
- 全新布局：引入左右分栏（可拖拽调整），左侧为“路径与设置 + 控制”，右侧为“状态 + 日志”；右侧再垂直分栏分隔状态与日志
- 进度条恢复为“无限循环”模式，配合文字显示“处理中: X/Y 个文件”
- 状态栏新增磁盘空间显示区域（彩色标签）
- 失败统计芯片显示待重试数量：`失败: 2 (待重试: 1)`
- 状态胶囊新增"已暂停"状态（黄色）
- 控制按钮区重新布局：开始/暂停/停止/测试/保存/清空
- 进度标签增加归档队列深度显示

### 🧪 兼容性
- 与 v1.0/v1.1/v1.2 向后兼容；新配置字段有默认值

## v1.2 (2025-10-21) - 进度与性能优化

### ✨ 新增/改进
- **进度条百分比显示**：从无限循环改为百分比模式，实时显示当前上传进度（已处理/总文件数）
- **磁盘监控改为百分比**：阈值从固定GB改为可用空间百分比（5-50%），更灵活适配不同磁盘大小；日志显示可用百分比和GB
- **上传与归档分离**：引入独立归档线程和队列，上传完成后异步移动到备份，避免归档IO阻塞上传流程，提升吞吐量
- **运行时禁用测试按钮**：上传服务运行期间禁用"测试连接"，防止误操作干扰上传进程
- **配置兼容性升级**：disk_threshold_gb 迁移为 disk_threshold_percent；自动兼容旧配置

### ⚙️ 配置示例变更
```json
{
  "source_folder": "...",
  "target_folder": "...",
  "backup_folder": "...",
  "upload_interval": 30,
  "monitor_mode": "periodic",
  "disk_threshold_percent": 10
}
```

### 🧪 兼容性
- 与 v1.0/v1.1 向后兼容；旧配置中的 disk_threshold_gb 会自动转换为 disk_threshold_percent

## v1.1 (2025-10-21) - 目录层级与磁盘阈值

### ✨ 新增/改进
- 保留目录层级：上传与备份均按源目录相对路径保留层级（例如 日期/OK 与 日期/NG）
- 支持 RAW：在原有 JPG/JPEG、PNG、BMP、TIFF、GIF 基础上，新增 .raw（大小写不敏感）
- 磁盘空间阈值：新增“磁盘告警阈值(GB)”设置；当目标或备份磁盘可用空间低于阈值时，自动暂停上传并在日志告警，空间恢复后自动继续
- 配置持久化扩展：config.json 新增字段 `disk_threshold_gb`

### ⚙️ 配置示例变更
```json
{
	"source_folder": "...",
	"target_folder": "...",
	"backup_folder": "...",
	"upload_interval": 30,
	"monitor_mode": "periodic",
	"disk_threshold_gb": 5
}
```

### 🧪 兼容性
- 与 v1.0 向后兼容；若旧配置无 `disk_threshold_gb` 字段，将自动采用默认值 5

## v1.0 (2025-10-21) - 初始版本

### ✨ 新功能
- ✅ 图片异步上传功能
- ✅ 文件自动备份管理
- ✅ 实时日志记录系统
- ✅ 网络连接检测功能
- ✅ 配置自动保存/加载
- ✅ 定时上传模式
- ✅ 实时监控模式
- ✅ 文件完整性校验
- ✅ 重复文件智能检测
- ✅ 友好的GUI界面

### 🎨 界面特性
- 干净简洁的界面设计
- 文件夹路径浏览选择
- 实时状态显示
- 动态进度条
- 日志实时更新
- 运行时间统计

### 🔧 技术特性
- 多线程异步处理
- 纯Python标准库实现
- 跨平台支持（Windows/Linux/macOS）
- 无需额外依赖包
- 低资源占用
- 网络友好设计

### 📝 支持功能
- 支持的图片格式: JPG, JPEG, PNG, BMP, TIFF, GIF
- 支持任意大小文件
- 支持网络共享文件夹
- 支持UNC路径
- 支持映射网络驱动器
- 自定义上传间隔（10-3600秒）

### 🛡️ 安全特性
- 文件大小校验
- 异常错误处理
- 日志详细记录
- 自动重试机制
- 配置备份保护

### 📦 发布内容
- main.py - 主程序文件
- config.json - 配置文件模板
- requirements.txt - 依赖说明
- README.md - 项目说明
- 使用指南.md - 详细使用说明
- 快速参考.txt - 快速参考卡片
- 启动程序.bat - Windows批处理启动脚本
- 启动程序.ps1 - PowerShell启动脚本
- test_uploader.py - 测试程序
- logs/ - 日志目录

### 🎯 适用场景
- 汽车生产线图片上传
- 工业现场数据采集
- 监控视频截图上传
- 质检图片传输
- 任何需要异步文件传输的场景

### 🔄 工作流程
1. 监控源文件夹中的图片文件
2. 将图片复制到目标共享文件夹
3. 验证文件完整性
4. 将源文件移动到备份文件夹
5. 记录操作日志

### 📊 性能指标
- 单文件上传: <5秒（50MB图片，取决于网络）
- CPU占用: <5%
- 内存占用: <50MB
- 支持文件大小: 无限制
- 并发模式: 单线程顺序处理

### 🌟 核心优势
1. **避免网络阻塞**: 异步处理，不影响其他应用
2. **数据安全**: 完整性校验 + 自动备份
3. **操作简单**: 图形界面，点击操作
4. **灵活配置**: 多种模式和参数可调
5. **详细日志**: 便于追溯和问题排查
6. **稳定可靠**: 完善的错误处理机制

### 📋 已知限制
- 仅支持单线程上传（避免网络拥堵）
- 需要目标文件夹有写入权限
- Windows防火墙可能需要配置

### 🔮 未来计划
- [ ] 支持多线程并发上传
- [ ] 添加MD5文件校验
- [ ] 支持断点续传
- [ ] 添加上传速度限制
- [ ] 支持更多文件格式
- [ ] 添加邮件通知功能
- [ ] 支持FTP/SFTP协议
- [ ] 添加数据统计报表
- [ ] 支持定时任务计划
- [ ] 添加远程管理功能

---

## 更新说明

### 如何更新
1. 备份当前的 config.json 配置文件
2. 替换 main.py 文件
3. 重新启动程序

### 配置文件兼容性
v1.0 的配置文件格式为基础版本，后续版本将保持向后兼容

---

## 反馈与建议

如有问题或建议，请通过以下方式反馈：
- 查看日志文件获取错误信息
- 记录问题复现步骤
- 提供系统环境信息

---

**开发日期**: 2025年10月21日  
**版本**: v1.9  
**状态**: 稳定版  
**支持**: Python 3.8+, PySide6 6.0+, Windows 10/11